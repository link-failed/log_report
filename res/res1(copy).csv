code,execution_time,level,msg,pid,thread_name,ts,materialized,node_finished_at,node_name,node_path,node_started_at,node_status,resource_type,rows_affected,failures,message
A001,,info,Running with dbt=1.1.1,109348,MainThread,2022-07-18T00:09:27.144993Z
A002,,debug,"running dbt with arguments {'log_format': 'json', 'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/home/ceci/.dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'which': 'run', 'rpc_method': 'run', 'indirect_selection': 'eager'}",109348,MainThread,2022-07-18T00:09:27.146056Z
A003,,debug,Tracking: tracking,109348,MainThread,2022-07-18T00:09:27.146311Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3f8ab0a130>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3f8ab0a1f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3f8ab0a220>]}",109348,MainThread,2022-07-18T00:09:27.152972Z
I040,,debug,"Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.",109348,MainThread,2022-07-18T00:09:27.278384Z
I017,,debug,"Partial parsing enabled, no changes found, skipping parsing",109348,MainThread,2022-07-18T00:09:27.278684Z
Z046,,warn,"[[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 2 unused configuration paths:
- models.mimic.diagnosis
- models.mimic.example
",109348,MainThread,2022-07-18T00:09:27.280887Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7c4c3ecd-5c14-4600-9281-0e21ba30ba00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3f8ab1ef40>]}",109348,MainThread,2022-07-18T00:09:27.288454Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7c4c3ecd-5c14-4600-9281-0e21ba30ba00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3f8ab41400>]}",109348,MainThread,2022-07-18T00:09:27.310808Z
W006,,info,"Found 107 models, 0 tests, 0 snapshots, 0 analyses, 167 macros, 0 operations, 0 seed files, 0 sources, 0 exposures, 0 metrics",109348,MainThread,2022-07-18T00:09:27.311383Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7c4c3ecd-5c14-4600-9281-0e21ba30ba00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3f8ab41a60>]}",109348,MainThread,2022-07-18T00:09:27.312110Z
E005,,debug,"Acquiring new postgres connection ""master""",109348,MainThread,2022-07-18T00:09:27.320217Z
E005,,debug,"Acquiring new postgres connection ""list_postgres""",109348,ThreadPoolExecutor-0_0,2022-07-18T00:09:27.325365Z
E015,,debug,"Using postgres connection ""list_postgres""",109348,ThreadPoolExecutor-0_0,2022-07-18T00:09:27.338238Z
E016,,debug,"On list_postgres: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""connection_name"": ""list_postgres""} */

    select distinct nspname from pg_namespace
  ",109348,ThreadPoolExecutor-0_0,2022-07-18T00:09:27.338573Z
E037,,debug,"Opening a new connection, currently in state init",109348,ThreadPoolExecutor-0_0,2022-07-18T00:09:27.338833Z
E017,,debug,SQL status: SELECT 8 in 0.01 seconds,109348,ThreadPoolExecutor-0_0,2022-07-18T00:09:27.347662Z
E010,,debug,On list_postgres: Close,109348,ThreadPoolExecutor-0_0,2022-07-18T00:09:27.353357Z
E005,,debug,"Acquiring new postgres connection ""list_postgres_public""",109348,ThreadPoolExecutor-1_0,2022-07-18T00:09:27.360462Z
E015,,debug,"Using postgres connection ""list_postgres_public""",109348,ThreadPoolExecutor-1_0,2022-07-18T00:09:27.366613Z
E016,,debug,On list_postgres_public: BEGIN,109348,ThreadPoolExecutor-1_0,2022-07-18T00:09:27.367084Z
E037,,debug,"Opening a new connection, currently in state closed",109348,ThreadPoolExecutor-1_0,2022-07-18T00:09:27.367636Z
E017,,debug,SQL status: BEGIN in 0.0 seconds,109348,ThreadPoolExecutor-1_0,2022-07-18T00:09:27.372458Z
E015,,debug,"Using postgres connection ""list_postgres_public""",109348,ThreadPoolExecutor-1_0,2022-07-18T00:09:27.372740Z
E016,,debug,"On list_postgres_public: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""connection_name"": ""list_postgres_public""} */
select
      'postgres' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'postgres' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
  ",109348,ThreadPoolExecutor-1_0,2022-07-18T00:09:27.372873Z
E017,,debug,SQL status: SELECT 339 in 0.0 seconds,109348,ThreadPoolExecutor-1_0,2022-07-18T00:09:27.375858Z
E012,,debug,On list_postgres_public: ROLLBACK,109348,ThreadPoolExecutor-1_0,2022-07-18T00:09:27.385420Z
E010,,debug,On list_postgres_public: Close,109348,ThreadPoolExecutor-1_0,2022-07-18T00:09:27.386155Z
E015,,debug,"Using postgres connection ""master""",109348,MainThread,2022-07-18T00:09:27.397041Z
E016,,debug,On master: BEGIN,109348,MainThread,2022-07-18T00:09:27.397315Z
E037,,debug,"Opening a new connection, currently in state init",109348,MainThread,2022-07-18T00:09:27.397436Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,MainThread,2022-07-18T00:09:27.403629Z
E015,,debug,"Using postgres connection ""master""",109348,MainThread,2022-07-18T00:09:27.404022Z
E016,,debug,"On master: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""connection_name"": ""master""} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;",109348,MainThread,2022-07-18T00:09:27.404333Z
E017,,debug,SQL status: SELECT 0 in 0.01 seconds,109348,MainThread,2022-07-18T00:09:27.412095Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7c4c3ecd-5c14-4600-9281-0e21ba30ba00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3f8c9ae970>]}",109348,MainThread,2022-07-18T00:09:27.416917Z
E012,,debug,On master: ROLLBACK,109348,MainThread,2022-07-18T00:09:27.417387Z
E015,,debug,"Using postgres connection ""master""",109348,MainThread,2022-07-18T00:09:27.418074Z
E016,,debug,On master: BEGIN,109348,MainThread,2022-07-18T00:09:27.418399Z
E017,,debug,SQL status: BEGIN in 0.0 seconds,109348,MainThread,2022-07-18T00:09:27.419256Z
E018,,debug,On master: COMMIT,109348,MainThread,2022-07-18T00:09:27.419570Z
E015,,debug,"Using postgres connection ""master""",109348,MainThread,2022-07-18T00:09:27.419838Z
E016,,debug,On master: COMMIT,109348,MainThread,2022-07-18T00:09:27.420069Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,MainThread,2022-07-18T00:09:27.420560Z
E010,,debug,On master: Close,109348,MainThread,2022-07-18T00:09:27.420904Z
Q026,,info,Concurrency: 1 threads (target='dev'),109348,MainThread,2022-07-18T00:09:27.421693Z
Q023,,debug,Began running node model.mimic.abx_prescriptions_list,109348,Thread-1,2022-07-18T00:09:27.426805Z,table,null,abx_prescriptions_list,treatment/abx_prescriptions_list.sql,2022-07-18T00:09:27.426725,started,model,,,
Q033,,info,1 of 107 START table model public.abx_prescriptions_list ....................... [RUN],109348,Thread-1,2022-07-18T00:09:27.427270Z,table,null,abx_prescriptions_list,treatment/abx_prescriptions_list.sql,2022-07-18T00:09:27.426725,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.abx_prescriptions_list""",109348,Thread-1,2022-07-18T00:09:27.428395Z
Q030,,debug,Began compiling node model.mimic.abx_prescriptions_list,109348,Thread-1,2022-07-18T00:09:27.428821Z,table,null,abx_prescriptions_list,treatment/abx_prescriptions_list.sql,2022-07-18T00:09:27.426725,compiling,model,,,
Q027,,debug,Compiling model.mimic.abx_prescriptions_list,109348,Thread-1,2022-07-18T00:09:27.429245Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.abx_prescriptions_list""",109348,Thread-1,2022-07-18T00:09:27.433675Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:09:27.435674Z
Q031,,debug,Began executing node model.mimic.abx_prescriptions_list,109348,Thread-1,2022-07-18T00:09:27.436172Z,table,null,abx_prescriptions_list,treatment/abx_prescriptions_list.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.abx_prescriptions_list""",109348,Thread-1,2022-07-18T00:09:27.475703Z
E015,,debug,"Using postgres connection ""model.mimic.abx_prescriptions_list""",109348,Thread-1,2022-07-18T00:09:27.476220Z
E016,,debug,On model.mimic.abx_prescriptions_list: BEGIN,109348,Thread-1,2022-07-18T00:09:27.476476Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:09:27.476604Z
E017,,debug,SQL status: BEGIN in 0.0 seconds,109348,Thread-1,2022-07-18T00:09:27.481509Z
E015,,debug,"Using postgres connection ""model.mimic.abx_prescriptions_list""",109348,Thread-1,2022-07-18T00:09:27.481965Z
E016,,debug,"On model.mimic.abx_prescriptions_list: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.abx_prescriptions_list""} */


  create  table ""postgres"".""public"".""abx_prescriptions_list__dbt_tmp""
  as (
     
with t1 as
(
  select
    drug, drug_name_generic
    , route
    , case
      when lower(drug) like '%adoxa%' then 1
      when lower(drug) like '%ala-tet%' then 1
      when lower(drug) like '%alodox%' then 1
      when lower(drug) like '%amikacin%' then 1
      when lower(drug) like '%amikin%' then 1
      when lower(drug) like '%amoxicillin%' then 1
      when lower(drug) like '%amoxicillin%clavulanate%' then 1
      when lower(drug) like '%clavulanate%' then 1
      when lower(drug) like '%ampicillin%' then 1
      when lower(drug) like '%augmentin%' then 1
      when lower(drug) like '%avelox%' then 1
      when lower(drug) like '%avidoxy%' then 1
      when lower(drug) like '%azactam%' then 1
      when lower(drug) like '%azithromycin%' then 1
      when lower(drug) like '%aztreonam%' then 1
      when lower(drug) like '%axetil%' then 1
      when lower(drug) like '%bactocill%' then 1
      when lower(drug) like '%bactrim%' then 1
      when lower(drug) like '%bethkis%' then 1
      when lower(drug) like '%biaxin%' then 1
      when lower(drug) like '%bicillin l-a%' then 1
      when lower(drug) like '%cayston%' then 1
      when lower(drug) like '%cefazolin%' then 1
      when lower(drug) like '%cedax%' then 1
      when lower(drug) like '%cefoxitin%' then 1
      when lower(drug) like '%ceftazidime%' then 1
      when lower(drug) like '%cefaclor%' then 1
      when lower(drug) like '%cefadroxil%' then 1
      when lower(drug) like '%cefdinir%' then 1
      when lower(drug) like '%cefditoren%' then 1
      when lower(drug) like '%cefepime%' then 1
      when lower(drug) like '%cefotetan%' then 1
      when lower(drug) like '%cefotaxime%' then 1
      when lower(drug) like '%cefpodoxime%' then 1
      when lower(drug) like '%cefprozil%' then 1
      when lower(drug) like '%ceftibuten%' then 1
      when lower(drug) like '%ceftin%' then 1
      when lower(drug) like '%cefuroxime %' then 1
      when lower(drug) like '%cefuroxime%' then 1
      when lower(drug) like '%cephalexin%' then 1
      when lower(drug) like '%chloramphenicol%' then 1
      when lower(drug) like '%cipro%' then 1
      when lower(drug) like '%ciprofloxacin%' then 1
      when lower(drug) like '%claforan%' then 1
      when lower(drug) like '%clarithromycin%' then 1
      when lower(drug) like '%cleocin%' then 1
      when lower(drug) like '%clindamycin%' then 1
      when lower(drug) like '%cubicin%' then 1
      when lower(drug) like '%dicloxacillin%' then 1
      when lower(drug) like '%doryx%' then 1
      when lower(drug) like '%doxycycline%' then 1
      when lower(drug) like '%duricef%' then 1
      when lower(drug) like '%dynacin%' then 1
      when lower(drug) like '%ery-tab%' then 1
      when lower(drug) like '%eryped%' then 1
      when lower(drug) like '%eryc%' then 1
      when lower(drug) like '%erythrocin%' then 1
      when lower(drug) like '%erythromycin%' then 1
      when lower(drug) like '%factive%' then 1
      when lower(drug) like '%flagyl%' then 1
      when lower(drug) like '%fortaz%' then 1
      when lower(drug) like '%furadantin%' then 1
      when lower(drug) like '%garamycin%' then 1
      when lower(drug) like '%gentamicin%' then 1
      when lower(drug) like '%kanamycin%' then 1
      when lower(drug) like '%keflex%' then 1
      when lower(drug) like '%ketek%' then 1
      when lower(drug) like '%levaquin%' then 1
      when lower(drug) like '%levofloxacin%' then 1
      when lower(drug) like '%lincocin%' then 1
      when lower(drug) like '%macrobid%' then 1
      when lower(drug) like '%macrodantin%' then 1
      when lower(drug) like '%maxipime%' then 1
      when lower(drug) like '%mefoxin%' then 1
      when lower(drug) like '%metronidazole%' then 1
      when lower(drug) like '%minocin%' then 1
      when lower(drug) like '%minocycline%' then 1
      when lower(drug) like '%monodox%' then 1
      when lower(drug) like '%monurol%' then 1
      when lower(drug) like '%morgidox%' then 1
      when lower(drug) like '%moxatag%' then 1
      when lower(drug) like '%moxifloxacin%' then 1
      when lower(drug) like '%myrac%' then 1
      when lower(drug) like '%nafcillin sodium%' then 1
      when lower(drug) like '%nicazel doxy 30%' then 1
      when lower(drug) like '%nitrofurantoin%' then 1
      when lower(drug) like '%noroxin%' then 1
      when lower(drug) like '%ocudox%' then 1
      when lower(drug) like '%ofloxacin%' then 1
      when lower(drug) like '%omnicef%' then 1
      when lower(drug) like '%oracea%' then 1
      when lower(drug) like '%oraxyl%' then 1
      when lower(drug) like '%oxacillin%' then 1
      when lower(drug) like '%pc pen vk%' then 1
      when lower(drug) like '%pce dispertab%' then 1
      when lower(drug) like '%panixine%' then 1
      when lower(drug) like '%pediazole%' then 1
      when lower(drug) like '%penicillin%' then 1
      when lower(drug) like '%periostat%' then 1
      when lower(drug) like '%pfizerpen%' then 1
      when lower(drug) like '%piperacillin%' then 1
      when lower(drug) like '%tazobactam%' then 1
      when lower(drug) like '%primsol%' then 1
      when lower(drug) like '%proquin%' then 1
      when lower(drug) like '%raniclor%' then 1
      when lower(drug) like '%rifadin%' then 1
      when lower(drug) like '%rifampin%' then 1
      when lower(drug) like '%rocephin%' then 1
      when lower(drug) like '%smz-tmp%' then 1
      when lower(drug) like '%septra%' then 1
      when lower(drug) like '%septra ds%' then 1
      when lower(drug) like '%septra%' then 1
      when lower(drug) like '%solodyn%' then 1
      when lower(drug) like '%spectracef%' then 1
      when lower(drug) like '%streptomycin sulfate%' then 1
      when lower(drug) like '%sulfadiazine%' then 1
      when lower(drug) like '%sulfamethoxazole%' then 1
      when lower(drug) like '%trimethoprim%' then 1
      when lower(drug) like '%sulfatrim%' then 1
      when lower(drug) like '%sulfisoxazole%' then 1
      when lower(drug) like '%suprax%' then 1
      when lower(drug) like '%synercid%' then 1
      when lower(drug) like '%tazicef%' then 1
      when lower(drug) like '%tetracycline%' then 1
      when lower(drug) like '%timentin%' then 1
      when lower(drug) like '%tobi%' then 1
      when lower(drug) like '%tobramycin%' then 1
      when lower(drug) like '%trimethoprim%' then 1
      when lower(drug) like '%unasyn%' then 1
      when lower(drug) like '%vancocin%' then 1
      when lower(drug) like '%vancomycin%' then 1
      when lower(drug) like '%vantin%' then 1
      when lower(drug) like '%vibativ%' then 1
      when lower(drug) like '%vibra-tabs%' then 1
      when lower(drug) like '%vibramycin%' then 1
      when lower(drug) like '%zinacef%' then 1
      when lower(drug) like '%zithromax%' then 1
      when lower(drug) like '%zmax%' then 1
      when lower(drug) like '%zosyn%' then 1
      when lower(drug) like '%zyvox%' then 1
    else 0
    end as antibiotic
  from prescriptions
  where drug_type in ('MAIN','ADDITIVE')
  -- we exclude routes via the eye, ears, or topically
  and route not in ('OU','OS','OD','AU','AS','AD', 'TP')
  and lower(route) not like '%ear%'
  and lower(route) not like '%eye%'
  -- we exclude certain types of antibiotics: topical creams, gels, desens, etc
  and lower(drug) not like '%cream%'
  and lower(drug) not like '%desensitization%'
  and lower(drug) not like '%ophth oint%'
  and lower(drug) not like '%gel%'
  -- other routes not sure about...
  -- for sure keep: ('IV','PO','PO/NG','ORAL', 'IV DRIP', 'IV BOLUS')
  -- ? VT, PB, PR, PL, NS, NG, NEB, NAS, LOCK, J TUBE, IVT
  -- ? IT, IRR, IP, IO, INHALATION, IN, IM
  -- ? IJ, IH, G TUBE, DIALYS
  -- ?? enemas??
)
select
  drug --, drug_name_generic
  , count(*) as numobs
from t1
where antibiotic = 1
group by drug --, drug_name_generic
order by numobs desc
  );",109348,Thread-1,2022-07-18T00:09:27.482126Z
E017,,debug,SQL status: SELECT 156 in 33.15 seconds,109348,Thread-1,2022-07-18T00:10:00.631843Z
E015,,debug,"Using postgres connection ""model.mimic.abx_prescriptions_list""",109348,Thread-1,2022-07-18T00:10:00.644490Z
E016,,debug,"On model.mimic.abx_prescriptions_list: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.abx_prescriptions_list""} */
alter table ""postgres"".""public"".""abx_prescriptions_list"" rename to ""abx_prescriptions_list__dbt_backup""",109348,Thread-1,2022-07-18T00:10:00.644736Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:00.645727Z
E015,,debug,"Using postgres connection ""model.mimic.abx_prescriptions_list""",109348,Thread-1,2022-07-18T00:10:00.649199Z
E016,,debug,"On model.mimic.abx_prescriptions_list: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.abx_prescriptions_list""} */
alter table ""postgres"".""public"".""abx_prescriptions_list__dbt_tmp"" rename to ""abx_prescriptions_list""",109348,Thread-1,2022-07-18T00:10:00.649439Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:00.650297Z
E018,,debug,On model.mimic.abx_prescriptions_list: COMMIT,109348,Thread-1,2022-07-18T00:10:00.660864Z
E015,,debug,"Using postgres connection ""model.mimic.abx_prescriptions_list""",109348,Thread-1,2022-07-18T00:10:00.661141Z
E016,,debug,On model.mimic.abx_prescriptions_list: COMMIT,109348,Thread-1,2022-07-18T00:10:00.661313Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:00.662595Z
E015,,debug,"Using postgres connection ""model.mimic.abx_prescriptions_list""",109348,Thread-1,2022-07-18T00:10:00.667004Z
E016,,debug,"On model.mimic.abx_prescriptions_list: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.abx_prescriptions_list""} */
drop table if exists ""postgres"".""public"".""abx_prescriptions_list__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:00.667255Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:00.669460Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:00.672832Z
E010,,debug,On model.mimic.abx_prescriptions_list: Close,109348,Thread-1,2022-07-18T00:10:00.673102Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7c4c3ecd-5c14-4600-9281-0e21ba30ba00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3f8a0530a0>]}",109348,Thread-1,2022-07-18T00:10:00.673949Z
Q012,33,info,1 of 107 OK created table model public.abx_prescriptions_list .................. [[32mSELECT 156[0m in 33.25s],109348,Thread-1,2022-07-18T00:10:00.674542Z,table,null,abx_prescriptions_list,treatment/abx_prescriptions_list.sql,2022-07-18T00:09:27.426725,compiling,model,,,
Q024,33.245901107788086,debug,Finished running node model.mimic.abx_prescriptions_list,109348,Thread-1,2022-07-18T00:10:00.675273Z,table,2022-07-18T00:10:00.675082,abx_prescriptions_list,treatment/abx_prescriptions_list.sql,2022-07-18T00:09:27.426725,success,model,,,
Q023,,debug,Began running node model.mimic.adenosine_durations,109348,Thread-1,2022-07-18T00:10:00.675928Z,table,null,adenosine_durations,durations/adenosine_durations.sql,2022-07-18T00:10:00.675826,started,model,,,
Q033,,info,2 of 107 START table model public.adenosine_durations .......................... [RUN],109348,Thread-1,2022-07-18T00:10:00.676698Z,table,null,adenosine_durations,durations/adenosine_durations.sql,2022-07-18T00:10:00.675826,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.adenosine_durations""",109348,Thread-1,2022-07-18T00:10:00.678108Z
Q030,,debug,Began compiling node model.mimic.adenosine_durations,109348,Thread-1,2022-07-18T00:10:00.678625Z,table,null,adenosine_durations,durations/adenosine_durations.sql,2022-07-18T00:10:00.675826,compiling,model,,,
Q027,,debug,Compiling model.mimic.adenosine_durations,109348,Thread-1,2022-07-18T00:10:00.679077Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.adenosine_durations""",109348,Thread-1,2022-07-18T00:10:00.680574Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:00.681133Z
Q031,,debug,Began executing node model.mimic.adenosine_durations,109348,Thread-1,2022-07-18T00:10:00.681426Z,table,null,adenosine_durations,durations/adenosine_durations.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.adenosine_durations""",109348,Thread-1,2022-07-18T00:10:00.690853Z
E015,,debug,"Using postgres connection ""model.mimic.adenosine_durations""",109348,Thread-1,2022-07-18T00:10:00.691825Z
E016,,debug,On model.mimic.adenosine_durations: BEGIN,109348,Thread-1,2022-07-18T00:10:00.692090Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:00.692327Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:00.700015Z
E015,,debug,"Using postgres connection ""model.mimic.adenosine_durations""",109348,Thread-1,2022-07-18T00:10:00.700673Z
E016,,debug,"On model.mimic.adenosine_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.adenosine_durations""} */


  create  table ""postgres"".""public"".""adenosine_durations__dbt_tmp""
  as (
    -- This query extracts durations of adenosine administration
-- Consecutive administrations are numbered 1, 2, ...
-- Total time on the drug can be calculated from this table by grouping using ICUSTAY_ID

-- *** COULD NOT FIND ADENOSINE IN THE INPUTEVENTS_MV TABLE ***
-- This drug is rarely used - it could just be that it was never used in MetaVision.
-- If using this code, ensure the durations make sense for carevue patients first

with vasocv1 as
(
  select
    icustay_id, charttime
    -- case statement determining whether the ITEMID is an instance of vasopressor usage
    , max(case when itemid = 4649 then 1 else 0 end) as vaso -- adenosine

    -- the 'stopped' column indicates if a vasopressor has been disconnected
    , 0 as vaso_stopped
    , max(case when itemid = 4649 and valuenum is not null then 1 else 0 end) as vaso_null
    , max(case when itemid = 4649 then valuenum else null end) as vaso_rate
    , max(case when itemid = 4649 then valuenum else null end) as vaso_amount

  FROM chartevents
  where itemid = 4649 -- adenosine
  -- exclude rows marked as error
  AND (error IS NULL OR error = 0)
  group by icustay_id, charttime
)
, vasocv2 as
(
  select v.*
    , sum(vaso_null) over (partition by icustay_id order by charttime) as vaso_partition
  from
    vasocv1 v
)
, vasocv3 as
(
  select v.*
    , first_value(vaso_rate) over (partition by icustay_id, vaso_partition order by charttime) as vaso_prevrate_ifnull
  from
    vasocv2 v
)
, vasocv4 as
(
select
    icustay_id
    , charttime
    -- , (CHARTTIME - (LAG(CHARTTIME, 1) OVER (partition by icustay_id, vaso order by charttime))) AS delta

    , vaso
    , vaso_rate
    , vaso_amount
    , vaso_stopped
    , vaso_prevrate_ifnull

    -- We define start time here
    , case
        when vaso = 0 then null

        -- if this is the first instance of the vasoactive drug
        when vaso_rate > 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso, vaso_null
          order by charttime
          )
          is null
          then 1

        -- you often get a string of 0s
        -- we decide not to set these as 1, just because it makes vasonum sequential
        when vaso_rate = 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 0
          then 0

        -- sometimes you get a string of NULL, associated with 0 volumes
        -- same reason as before, we decide not to set these as 1
        -- vaso_prevrate_ifnull is equal to the previous value *iff* the current value is null
        when vaso_prevrate_ifnull = 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 0
          then 0

        -- If the last recorded rate was 0, newvaso = 1
        when LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          ) = 0
          then 1

        -- If the last recorded vaso was D/C'd, newvaso = 1
        when
          LAG(vaso_stopped,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 1 then 1

        -- ** not sure if the below is needed
        --when (CHARTTIME - (LAG(CHARTTIME, 1) OVER (partition by icustay_id, vaso order by charttime))) > (interval '4 hours') then 1
      else null
      end as vaso_start

FROM
  vasocv3
)
-- propagate start/stop flags forward in time
, vasocv5 as
(
  select v.*
    , SUM(vaso_start) OVER (partition by icustay_id, vaso order by charttime) as vaso_first
FROM
  vasocv4 v
)
, vasocv6 as
(
  select v.*
    -- We define end time here
    , case
        when vaso = 0
          then null

        -- If the recorded vaso was D/C'd, this is an end time
        when vaso_stopped = 1
          then vaso_first

        -- If the rate is zero, this is the end time
        when vaso_rate = 0
          then vaso_first

        -- the last row in the table is always a potential end time
        -- this captures patients who die/are discharged while on vasopressors
        -- in principle, this could add an extra end time for the vasopressor
        -- however, since we later group on vaso_start, any extra end times are ignored
        when LEAD(CHARTTIME,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          ) is null
          then vaso_first

        else null
        end as vaso_stop
    from vasocv5 v
)

-- -- if you want to look at the results of the table before grouping:
-- select
--   icustay_id, charttime, vaso, vaso_rate, vaso_amount
--     , case when vaso_stopped = 1 then 'Y' else '' end as stopped
--     , vaso_start
--     , vaso_first
--     , vaso_stop
-- from vasocv6 order by charttime


, vasocv as
(
-- below groups together vasopressor administrations into groups
select
  icustay_id
  -- the first non-null rate is considered the starttime
  , min(case when vaso_rate is not null then charttime else null end) as starttime
  -- the *first* time the first/last flags agree is the stop time for this duration
  , min(case when vaso_first = vaso_stop then charttime else null end) as endtime
from vasocv6
where
  vaso_first is not null -- bogus data
and
  vaso_first != 0 -- sometimes *only* a rate of 0 appears, i.e. the drug is never actually delivered
and
  icustay_id is not null -- there are data for ""floating"" admissions, we don't worry about these
group by icustay_id, vaso_first
having -- ensure start time is not the same as end time
 min(charttime) != min(case when vaso_first = vaso_stop then charttime else null end)
and
  max(vaso_rate) > 0 -- if the rate was always 0 or null, we consider it not a real drug delivery
)

-- now we extract the associated data for metavision patients
, vasomv as
(
  select
    icustay_id, linkorderid
    , min(starttime) as starttime, max(endtime) as endtime
  FROM inputevents_mv
  where itemid = 221282 -- adenosine
  and statusdescription != 'Rewritten' -- only valid orders
  group by icustay_id, linkorderid
)

select
  icustay_id
  -- generate a sequential integer for convenience
  , ROW_NUMBER() over (partition by icustay_id order by starttime) as vasonum
  , starttime, endtime
  , DATETIME_DIFF(endtime, starttime, 'HOUR') AS duration_hours
  -- add durations
from
  vasocv

UNION ALL

select
  icustay_id
  , ROW_NUMBER() over (partition by icustay_id order by starttime) as vasonum
  , starttime, endtime
  , DATETIME_DIFF(endtime, starttime, 'HOUR') AS duration_hours
  -- add durations
from
  vasomv

order by icustay_id, vasonum
  );",109348,Thread-1,2022-07-18T00:10:00.701221Z
E017,,debug,SQL status: SELECT 160 in 0.02 seconds,109348,Thread-1,2022-07-18T00:10:00.722669Z
E015,,debug,"Using postgres connection ""model.mimic.adenosine_durations""",109348,Thread-1,2022-07-18T00:10:00.729107Z
E016,,debug,"On model.mimic.adenosine_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.adenosine_durations""} */
alter table ""postgres"".""public"".""adenosine_durations"" rename to ""adenosine_durations__dbt_backup""",109348,Thread-1,2022-07-18T00:10:00.729497Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:00.730860Z
E015,,debug,"Using postgres connection ""model.mimic.adenosine_durations""",109348,Thread-1,2022-07-18T00:10:00.737100Z
E016,,debug,"On model.mimic.adenosine_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.adenosine_durations""} */
alter table ""postgres"".""public"".""adenosine_durations__dbt_tmp"" rename to ""adenosine_durations""",109348,Thread-1,2022-07-18T00:10:00.737808Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:00.738761Z
E018,,debug,On model.mimic.adenosine_durations: COMMIT,109348,Thread-1,2022-07-18T00:10:00.745558Z
E015,,debug,"Using postgres connection ""model.mimic.adenosine_durations""",109348,Thread-1,2022-07-18T00:10:00.746110Z
E016,,debug,On model.mimic.adenosine_durations: COMMIT,109348,Thread-1,2022-07-18T00:10:00.746363Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:00.747902Z
E015,,debug,"Using postgres connection ""model.mimic.adenosine_durations""",109348,Thread-1,2022-07-18T00:10:00.751216Z
E016,,debug,"On model.mimic.adenosine_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.adenosine_durations""} */
drop table if exists ""postgres"".""public"".""adenosine_durations__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:00.751701Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:00.754919Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:00.760203Z
E010,,debug,On model.mimic.adenosine_durations: Close,109348,Thread-1,2022-07-18T00:10:00.760535Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7c4c3ecd-5c14-4600-9281-0e21ba30ba00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3f8a0530a0>]}",109348,Thread-1,2022-07-18T00:10:00.761245Z
Q012,0,info,2 of 107 OK created table model public.adenosine_durations ..................... [[32mSELECT 160[0m in 0.08s],109348,Thread-1,2022-07-18T00:10:00.761679Z,table,null,adenosine_durations,durations/adenosine_durations.sql,2022-07-18T00:10:00.675826,compiling,model,,,
Q024,0.0835719108581543,debug,Finished running node model.mimic.adenosine_durations,109348,Thread-1,2022-07-18T00:10:00.762182Z,table,2022-07-18T00:10:00.762044,adenosine_durations,durations/adenosine_durations.sql,2022-07-18T00:10:00.675826,success,model,,,
Q023,,debug,Began running node model.mimic.age_histogram,109348,Thread-1,2022-07-18T00:10:00.762502Z,table,null,age_histogram,cookbook/age_histogram.sql,2022-07-18T00:10:00.762476,started,model,,,
Q033,,info,3 of 107 START table model public.age_histogram ................................ [RUN],109348,Thread-1,2022-07-18T00:10:00.763295Z,table,null,age_histogram,cookbook/age_histogram.sql,2022-07-18T00:10:00.762476,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.age_histogram""",109348,Thread-1,2022-07-18T00:10:00.764083Z
Q030,,debug,Began compiling node model.mimic.age_histogram,109348,Thread-1,2022-07-18T00:10:00.764265Z,table,null,age_histogram,cookbook/age_histogram.sql,2022-07-18T00:10:00.762476,compiling,model,,,
Q027,,debug,Compiling model.mimic.age_histogram,109348,Thread-1,2022-07-18T00:10:00.764435Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.age_histogram""",109348,Thread-1,2022-07-18T00:10:00.766308Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:00.766919Z
Q031,,debug,Began executing node model.mimic.age_histogram,109348,Thread-1,2022-07-18T00:10:00.767104Z,table,null,age_histogram,cookbook/age_histogram.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.age_histogram""",109348,Thread-1,2022-07-18T00:10:00.780074Z
E015,,debug,"Using postgres connection ""model.mimic.age_histogram""",109348,Thread-1,2022-07-18T00:10:00.781129Z
E016,,debug,On model.mimic.age_histogram: BEGIN,109348,Thread-1,2022-07-18T00:10:00.781415Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:00.781754Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:00.788403Z
E015,,debug,"Using postgres connection ""model.mimic.age_histogram""",109348,Thread-1,2022-07-18T00:10:00.788829Z
E016,,debug,"On model.mimic.age_histogram: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.age_histogram""} */


  create  table ""postgres"".""public"".""age_histogram__dbt_tmp""
  as (
    -- ------------------------------------------------------------------
-- Title: Count the number of hospital admissions in equally sized bins of age
-- Notes: this query does not specify a schema. To run it on your local
-- MIMIC schema, run the following command:
--  SET SEARCH_PATH TO mimiciii
-- Where ""mimiciii"" is the name of your schema, and may be different.
-- ------------------------------------------------------------------

WITH agetbl AS
(
    SELECT DATETIME_DIFF(ad.admittime, p.dob, 'YEAR') AS age
      FROM admissions ad
      INNER JOIN patients p
      ON ad.subject_id = p.subject_id
)
, agebin AS
(
      SELECT age, width_bucket(age, 15, 100, 85) AS bucket
      FROM agetbl
)
SELECT bucket+15 as age, count(*)
FROM agebin
GROUP BY bucket
ORDER BY bucket
  );",109348,Thread-1,2022-07-18T00:10:00.789156Z
E017,,debug,SQL status: SELECT 77 in 0.19 seconds,109348,Thread-1,2022-07-18T00:10:00.975588Z
E015,,debug,"Using postgres connection ""model.mimic.age_histogram""",109348,Thread-1,2022-07-18T00:10:00.980415Z
E016,,debug,"On model.mimic.age_histogram: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.age_histogram""} */
alter table ""postgres"".""public"".""age_histogram"" rename to ""age_histogram__dbt_backup""",109348,Thread-1,2022-07-18T00:10:00.980689Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:00.981458Z
E015,,debug,"Using postgres connection ""model.mimic.age_histogram""",109348,Thread-1,2022-07-18T00:10:00.985437Z
E016,,debug,"On model.mimic.age_histogram: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.age_histogram""} */
alter table ""postgres"".""public"".""age_histogram__dbt_tmp"" rename to ""age_histogram""",109348,Thread-1,2022-07-18T00:10:00.985862Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:00.986648Z
E018,,debug,On model.mimic.age_histogram: COMMIT,109348,Thread-1,2022-07-18T00:10:00.991546Z
E015,,debug,"Using postgres connection ""model.mimic.age_histogram""",109348,Thread-1,2022-07-18T00:10:00.992121Z
E016,,debug,On model.mimic.age_histogram: COMMIT,109348,Thread-1,2022-07-18T00:10:00.992407Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:00.993672Z
E015,,debug,"Using postgres connection ""model.mimic.age_histogram""",109348,Thread-1,2022-07-18T00:10:00.995391Z
E016,,debug,"On model.mimic.age_histogram: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.age_histogram""} */
drop table if exists ""postgres"".""public"".""age_histogram__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:00.995615Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:00.997475Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:01.001302Z
E010,,debug,On model.mimic.age_histogram: Close,109348,Thread-1,2022-07-18T00:10:01.001734Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7c4c3ecd-5c14-4600-9281-0e21ba30ba00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3f887a5430>]}",109348,Thread-1,2022-07-18T00:10:01.002931Z
Q012,0,info,3 of 107 OK created table model public.age_histogram ........................... [[32mSELECT 77[0m in 0.24s],109348,Thread-1,2022-07-18T00:10:01.003653Z,table,null,age_histogram,cookbook/age_histogram.sql,2022-07-18T00:10:00.762476,compiling,model,,,
Q024,0.23903250694274902,debug,Finished running node model.mimic.age_histogram,109348,Thread-1,2022-07-18T00:10:01.004260Z,table,2022-07-18T00:10:01.004108,age_histogram,cookbook/age_histogram.sql,2022-07-18T00:10:00.762476,success,model,,,
Q023,,debug,Began running node model.mimic.angus,109348,Thread-1,2022-07-18T00:10:01.004536Z,table,null,angus,sepsis/angus.sql,2022-07-18T00:10:01.004509,started,model,,,
Q033,,info,4 of 107 START table model public.angus ........................................ [RUN],109348,Thread-1,2022-07-18T00:10:01.005198Z,table,null,angus,sepsis/angus.sql,2022-07-18T00:10:01.004509,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.angus""",109348,Thread-1,2022-07-18T00:10:01.006269Z
Q030,,debug,Began compiling node model.mimic.angus,109348,Thread-1,2022-07-18T00:10:01.007342Z,table,null,angus,sepsis/angus.sql,2022-07-18T00:10:01.004509,compiling,model,,,
Q027,,debug,Compiling model.mimic.angus,109348,Thread-1,2022-07-18T00:10:01.007665Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.angus""",109348,Thread-1,2022-07-18T00:10:01.011098Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:01.011798Z
Q031,,debug,Began executing node model.mimic.angus,109348,Thread-1,2022-07-18T00:10:01.012151Z,table,null,angus,sepsis/angus.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.angus""",109348,Thread-1,2022-07-18T00:10:01.022229Z
E015,,debug,"Using postgres connection ""model.mimic.angus""",109348,Thread-1,2022-07-18T00:10:01.023482Z
E016,,debug,On model.mimic.angus: BEGIN,109348,Thread-1,2022-07-18T00:10:01.024110Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:01.024394Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:01.030376Z
E015,,debug,"Using postgres connection ""model.mimic.angus""",109348,Thread-1,2022-07-18T00:10:01.030652Z
E016,,debug,"On model.mimic.angus: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.angus""} */


  create  table ""postgres"".""public"".""angus__dbt_tmp""
  as (
    -- ICD-9 codes for Angus criteria of sepsis

-- Angus et al, 2001. Epidemiology of severe sepsis in the United States
-- http://www.ncbi.nlm.nih.gov/pubmed/11445675

-- Case selection and definitions
-- To identify cases with severe sepsis, we selected all acute care
-- hospitalizations with ICD-9-CM codes for both:
-- (a) a bacterial or fungal infectious process AND
-- (b) a diagnosis of acute organ dysfunction (Appendix 2).

-- ICD-9 codes for infection - as sourced from Appendix 1 of above paper
 

WITH infection_group AS
(
	SELECT subject_id, hadm_id,
	CASE
		WHEN SUBSTR(icd9_code,1,3) IN ('001','002','003','004','005','008',
			   '009','010','011','012','013','014','015','016','017','018',
			   '020','021','022','023','024','025','026','027','030','031',
			   '032','033','034','035','036','037','038','039','040','041',
			   '090','091','092','093','094','095','096','097','098','100',
			   '101','102','103','104','110','111','112','114','115','116',
			   '117','118','320','322','324','325','420','421','451','461',
			   '462','463','464','465','481','482','485','486','494','510',
			   '513','540','541','542','566','567','590','597','601','614',
			   '615','616','681','682','683','686','730') THEN 1
		WHEN SUBSTR(icd9_code,1,4) IN ('5695','5720','5721','5750','5990','7110',
				'7907','9966','9985','9993') THEN 1
		WHEN SUBSTR(icd9_code,1,5) IN ('49121','56201','56203','56211','56213',
				'56983') THEN 1
		ELSE 0 END AS infection
	from diagnoses_icd
),
-- ICD-9 codes for organ dysfunction - as sourced from Appendix 2 of above paper
organ_diag_group as
(
	SELECT subject_id, hadm_id,
		CASE
		-- Acute Organ Dysfunction Diagnosis Codes
		WHEN SUBSTR(icd9_code,1,3) IN ('458','293','570','584') THEN 1
		WHEN SUBSTR(icd9_code,1,4) IN ('7855','3483','3481',
				'2874','2875','2869','2866','5734')  THEN 1
		ELSE 0 END AS organ_dysfunction,
		-- Explicit diagnosis of severe sepsis or septic shock
		CASE
		WHEN SUBSTR(icd9_code,1,5) IN ('99592','78552')  THEN 1
		ELSE 0 END AS explicit_sepsis
	from diagnoses_icd
),
-- Mechanical ventilation
organ_proc_group as
(
	SELECT subject_id, hadm_id,
		CASE
		WHEN icd9_code IN ('9670', '9671', '9672') THEN 1
		ELSE 0 END AS mech_vent
	FROM procedures_icd
),
-- Aggregate above views together
aggregate as
(
	SELECT subject_id, hadm_id,
		CASE
			WHEN hadm_id in
					(SELECT DISTINCT hadm_id
					FROM infection_group
					WHERE infection = 1)
				THEN 1
			ELSE 0 END AS infection,
		CASE
			WHEN hadm_id in
					(SELECT DISTINCT hadm_id
					FROM organ_diag_group
					WHERE explicit_sepsis = 1)
				THEN 1
			ELSE 0 END AS explicit_sepsis,
		CASE
			WHEN hadm_id in
					(SELECT DISTINCT hadm_id
					FROM organ_diag_group
					WHERE organ_dysfunction = 1)
				THEN 1
			ELSE 0 END AS organ_dysfunction,
		CASE
		WHEN hadm_id in
				(SELECT DISTINCT hadm_id
				FROM organ_proc_group
				WHERE mech_vent = 1)
			THEN 1
		ELSE 0 END AS mech_vent
	FROM admissions
)
-- Output component flags (explicit sepsis, organ dysfunction) and final flag (angus)
SELECT subject_id, hadm_id, infection,
   explicit_sepsis, organ_dysfunction, mech_vent,
CASE
	WHEN explicit_sepsis = 1 THEN 1
	WHEN infection = 1 AND organ_dysfunction = 1 THEN 1
	WHEN infection = 1 AND mech_vent = 1 THEN 1
	ELSE 0 END
AS angus
FROM aggregate
  );",109348,Thread-1,2022-07-18T00:10:01.030852Z
E017,,debug,SQL status: SELECT 58976 in 2.28 seconds,109348,Thread-1,2022-07-18T00:10:03.315641Z
E015,,debug,"Using postgres connection ""model.mimic.angus""",109348,Thread-1,2022-07-18T00:10:03.323537Z
E016,,debug,"On model.mimic.angus: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.angus""} */
alter table ""postgres"".""public"".""angus"" rename to ""angus__dbt_backup""",109348,Thread-1,2022-07-18T00:10:03.323998Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:03.325398Z
E015,,debug,"Using postgres connection ""model.mimic.angus""",109348,Thread-1,2022-07-18T00:10:03.329025Z
E016,,debug,"On model.mimic.angus: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.angus""} */
alter table ""postgres"".""public"".""angus__dbt_tmp"" rename to ""angus""",109348,Thread-1,2022-07-18T00:10:03.329231Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:03.330017Z
E018,,debug,On model.mimic.angus: COMMIT,109348,Thread-1,2022-07-18T00:10:03.333142Z
E015,,debug,"Using postgres connection ""model.mimic.angus""",109348,Thread-1,2022-07-18T00:10:03.333349Z
E016,,debug,On model.mimic.angus: COMMIT,109348,Thread-1,2022-07-18T00:10:03.333469Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:03.338168Z
E015,,debug,"Using postgres connection ""model.mimic.angus""",109348,Thread-1,2022-07-18T00:10:03.340439Z
E016,,debug,"On model.mimic.angus: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.angus""} */
drop table if exists ""postgres"".""public"".""angus__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:03.340661Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:03.342675Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:03.346068Z
E010,,debug,On model.mimic.angus: Close,109348,Thread-1,2022-07-18T00:10:03.346347Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7c4c3ecd-5c14-4600-9281-0e21ba30ba00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3f887b8a30>]}",109348,Thread-1,2022-07-18T00:10:03.347106Z
Q012,2,info,4 of 107 OK created table model public.angus ................................... [[32mSELECT 58976[0m in 2.34s],109348,Thread-1,2022-07-18T00:10:03.347623Z,table,null,angus,sepsis/angus.sql,2022-07-18T00:10:01.004509,compiling,model,,,
Q024,2.3411998748779297,debug,Finished running node model.mimic.angus,109348,Thread-1,2022-07-18T00:10:03.348283Z,table,2022-07-18T00:10:03.348102,angus,sepsis/angus.sql,2022-07-18T00:10:01.004509,success,model,,,
Q023,,debug,Began running node model.mimic.arterial_line_durations,109348,Thread-1,2022-07-18T00:10:03.348766Z,table,null,arterial_line_durations,durations/arterial_line_durations.sql,2022-07-18T00:10:03.348698,started,model,,,
Q033,,info,5 of 107 START table model public.arterial_line_durations ...................... [RUN],109348,Thread-1,2022-07-18T00:10:03.349397Z,table,null,arterial_line_durations,durations/arterial_line_durations.sql,2022-07-18T00:10:03.348698,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.arterial_line_durations""",109348,Thread-1,2022-07-18T00:10:03.350355Z
Q030,,debug,Began compiling node model.mimic.arterial_line_durations,109348,Thread-1,2022-07-18T00:10:03.350700Z,table,null,arterial_line_durations,durations/arterial_line_durations.sql,2022-07-18T00:10:03.348698,compiling,model,,,
Q027,,debug,Compiling model.mimic.arterial_line_durations,109348,Thread-1,2022-07-18T00:10:03.351239Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.arterial_line_durations""",109348,Thread-1,2022-07-18T00:10:03.352907Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:03.353507Z
Q031,,debug,Began executing node model.mimic.arterial_line_durations,109348,Thread-1,2022-07-18T00:10:03.354015Z,table,null,arterial_line_durations,durations/arterial_line_durations.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.arterial_line_durations""",109348,Thread-1,2022-07-18T00:10:03.362654Z
E015,,debug,"Using postgres connection ""model.mimic.arterial_line_durations""",109348,Thread-1,2022-07-18T00:10:03.364647Z
E016,,debug,On model.mimic.arterial_line_durations: BEGIN,109348,Thread-1,2022-07-18T00:10:03.365079Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:03.365536Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:03.372611Z
E015,,debug,"Using postgres connection ""model.mimic.arterial_line_durations""",109348,Thread-1,2022-07-18T00:10:03.372874Z
E016,,debug,"On model.mimic.arterial_line_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.arterial_line_durations""} */


  create  table ""postgres"".""public"".""arterial_line_durations__dbt_tmp""
  as (
    with mv as
(
  select
    pe.icustay_id
  , pe.starttime, pe.endtime
  , case
      when itemid in (225752, 224272)
        then 1
      when pe.locationcategory = 'Invasive Arterial'
        then 1
      when itemid = 225789 and pe.locationcategory IS NULL
        then 1
      else 0
    end as arterial_line
  FROM procedureevents_mv pe
  where pe.itemid in
  (
      224263 -- Multi Lumen | None | 12 | Processes
    -- , 224264 -- PICC Line | None | 12 | Processes
    , 224267 -- Cordis/Introducer | None | 12 | Processes
    , 224268 -- Trauma line | None | 12 | Processes
    , 225199 -- Triple Introducer | None | 12 | Processes
    -- , 225202 -- Indwelling Port (PortaCath) | None | 12 | Processes
    -- , 225203 -- Pheresis Catheter | None | 12 | Processes
    -- , 225315 -- Tunneled (Hickman) Line | None | 12 | Processes
    , 225752 -- Arterial Line | None | 12 | Processes
    , 225789 -- Sheath
    , 224272 -- IABP Line
    -- , 227719 -- AVA Line | None | 12 | Processes
    -- , 228286 -- Intraosseous Device | None | 12 | Processes
  )
)
, cv_grp as
(
  -- group type+site
  select ce.icustay_id, ce.charttime
    , max(case when itemid =  229  then value else null end) as INV1_Type
    , max(case when itemid =  8392 then value else null end) as INV1_Site
    , max(case when itemid =  235  then value else null end) as INV2_Type
    , max(case when itemid =  8393 then value else null end) as INV2_Site
    , max(case when itemid =  241  then value else null end) as INV3_Type
    , max(case when itemid =  8394 then value else null end) as INV3_Site
    , max(case when itemid =  247  then value else null end) as INV4_Type
    , max(case when itemid =  8395 then value else null end) as INV4_Site
    , max(case when itemid =  253  then value else null end) as INV5_Type
    , max(case when itemid =  8396 then value else null end) as INV5_Site
    , max(case when itemid =  259  then value else null end) as INV6_Type
    , max(case when itemid =  8397 then value else null end) as INV6_Site
    , max(case when itemid =  265  then value else null end) as INV7_Type
    , max(case when itemid =  8398 then value else null end) as INV7_Site
    , max(case when itemid =  271  then value else null end) as INV8_Type
    , max(case when itemid =  8399 then value else null end) as INV8_Site
  FROM chartevents ce
  where ce.itemid in
  (
      229 -- INV Line#1 [Type]
    , 235 -- INV Line#2 [Type]
    , 241 -- INV Line#3 [Type]
    , 247 -- INV Line#4 [Type]
    , 253 -- INV Line#5 [Type]
    , 259 -- INV Line#6 [Type]
    , 265 -- INV Line#7 [Type]
    , 271 -- INV Line#8 [Type]
    , 8392 -- INV Line#1 [Site]
    , 8393 -- INV Line#2 [Site]
    , 8394 -- INV Line#3 [Site]
    , 8395 -- INV Line#4 [Site]
    , 8396 -- INV Line#5 [Site]
    , 8397 -- INV Line#6 [Site]
    , 8398 -- INV Line#7 [Site]
    , 8399 -- INV Line#8 [Site]
  )
  and ce.value is not null
  group by ce.icustay_id, ce.charttime
)
-- types of invasive lines in carevue
--       value       | count
-- ------------------+--------
--  A-Line           | 460627
--  Multi-lumen      | 345858
--  PICC line        |  92285
--  PA line          |  65702
--  Dialysis Line    |  57579
--  Introducer       |  36027
--  CCO PA Line      |  24831
--                   |  22369
--  Trauma Line      |  15530
--  Portacath        |  12927
--  Ventriculostomy  |  10295
--  Pre-Sep Catheter |   9678
--  IABP             |   8819
--  Other/Remarks    |   8725
--  Midline          |   5067
--  Venous Access    |   4278
--  Hickman          |   3783
--  PacerIntroducer  |   2663
--  TripleIntroducer |   2262
--  RIC              |   1625
--  PermaCath        |   1066
--  Camino Bolt      |    913
--  Lumbar Drain     |    361
-- (23 rows)
, cv as
(
  select distinct icustay_id, charttime
  from cv_grp
  where (inv1_type in ('A-Line', 'IABP'))
     OR (inv2_type in ('A-Line', 'IABP'))
     OR (inv3_type in ('A-Line', 'IABP'))
     OR (inv4_type in ('A-Line', 'IABP'))
     OR (inv5_type in ('A-Line', 'IABP'))
     OR (inv6_type in ('A-Line', 'IABP'))
     OR (inv7_type in ('A-Line', 'IABP'))
     OR (inv8_type in ('A-Line', 'IABP'))
)
-- transform carevue data into durations
, cv0 as
(
  select
    icustay_id
    -- this carries over the previous charttime
    , LAG(CHARTTIME, 1) OVER (partition by icustay_id order by charttime) as charttime_lag
    , charttime
  from cv
)
, cv1 as
(
  select
    icustay_id
    , charttime
    , charttime_lag
    -- if the current observation indicates a line is present
    -- calculate the time since the last charted line
    , charttime - charttime_lag as arterial_line_duration
    -- now we determine if the current line is ""new""
    -- new == no documentation for 16 hours
    , case
        when DATETIME_DIFF(charttime, charttime_lag, 'HOUR') > 16
          then 1
      else 0
      end as arterial_line_new
  FROM cv0
)
, cv2 as
(
  select cv1.*
  -- create a cumulative sum of the instances of new events
  -- this results in a monotonic integer assigned to each new instance of a line
  , SUM( arterial_line_new )
    OVER ( partition by icustay_id order by charttime )
    as arterial_line_rownum
  from cv1
)
-- create the durations for each line
, cv_dur as
(
  select icustay_id
    , arterial_line_rownum
    , min(charttime) as starttime
    , max(charttime) as endtime
    , DATETIME_DIFF(max(charttime), min(charttime), 'HOUR') AS duration_hours
  from cv2
  group by icustay_id, arterial_line_rownum
  having min(charttime) != max(charttime)
)
select icustay_id
  -- , arterial_line_rownum
  , starttime, endtime, duration_hours
from cv_dur
UNION ALL
--TODO: collapse metavision durations if they overlap
select icustay_id
  -- , ROW_NUMBER() over (PARTITION BY icustay_id ORDER BY starttime) as arterial_line_rownum
  , starttime, endtime
  , DATETIME_DIFF(endtime, starttime, 'HOUR') AS duration_hours
from mv
where arterial_line = 1
order by icustay_id, starttime
  );",109348,Thread-1,2022-07-18T00:10:03.373014Z
E017,,debug,SQL status: SELECT 13059 in 0.08 seconds,109348,Thread-1,2022-07-18T00:10:03.455469Z
E015,,debug,"Using postgres connection ""model.mimic.arterial_line_durations""",109348,Thread-1,2022-07-18T00:10:03.461176Z
E016,,debug,"On model.mimic.arterial_line_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.arterial_line_durations""} */
alter table ""postgres"".""public"".""arterial_line_durations"" rename to ""arterial_line_durations__dbt_backup""",109348,Thread-1,2022-07-18T00:10:03.461447Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:03.462295Z
E015,,debug,"Using postgres connection ""model.mimic.arterial_line_durations""",109348,Thread-1,2022-07-18T00:10:03.466280Z
E016,,debug,"On model.mimic.arterial_line_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.arterial_line_durations""} */
alter table ""postgres"".""public"".""arterial_line_durations__dbt_tmp"" rename to ""arterial_line_durations""",109348,Thread-1,2022-07-18T00:10:03.466526Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:03.467252Z
E018,,debug,On model.mimic.arterial_line_durations: COMMIT,109348,Thread-1,2022-07-18T00:10:03.471113Z
E015,,debug,"Using postgres connection ""model.mimic.arterial_line_durations""",109348,Thread-1,2022-07-18T00:10:03.471836Z
E016,,debug,On model.mimic.arterial_line_durations: COMMIT,109348,Thread-1,2022-07-18T00:10:03.472148Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:03.475866Z
E015,,debug,"Using postgres connection ""model.mimic.arterial_line_durations""",109348,Thread-1,2022-07-18T00:10:03.477543Z
E016,,debug,"On model.mimic.arterial_line_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.arterial_line_durations""} */
drop table if exists ""postgres"".""public"".""arterial_line_durations__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:03.477937Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:03.479948Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:03.483083Z
E010,,debug,On model.mimic.arterial_line_durations: Close,109348,Thread-1,2022-07-18T00:10:03.483380Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7c4c3ecd-5c14-4600-9281-0e21ba30ba00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3f8a037ac0>]}",109348,Thread-1,2022-07-18T00:10:03.484135Z
Q012,0,info,5 of 107 OK created table model public.arterial_line_durations ................. [[32mSELECT 13059[0m in 0.13s],109348,Thread-1,2022-07-18T00:10:03.484559Z,table,null,arterial_line_durations,durations/arterial_line_durations.sql,2022-07-18T00:10:03.348698,compiling,model,,,
Q024,0.13404202461242676,debug,Finished running node model.mimic.arterial_line_durations,109348,Thread-1,2022-07-18T00:10:03.485022Z,table,2022-07-18T00:10:03.484811,arterial_line_durations,durations/arterial_line_durations.sql,2022-07-18T00:10:03.348698,success,model,,,
Q023,,debug,Began running node model.mimic.auroc,109348,Thread-1,2022-07-18T00:10:03.485390Z,table,null,auroc,functions/auroc.sql,2022-07-18T00:10:03.485369,started,model,,,
Q033,,info,6 of 107 START table model public.auroc ........................................ [RUN],109348,Thread-1,2022-07-18T00:10:03.486034Z,table,null,auroc,functions/auroc.sql,2022-07-18T00:10:03.485369,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.auroc""",109348,Thread-1,2022-07-18T00:10:03.486929Z
Q030,,debug,Began compiling node model.mimic.auroc,109348,Thread-1,2022-07-18T00:10:03.487421Z,table,null,auroc,functions/auroc.sql,2022-07-18T00:10:03.485369,compiling,model,,,
Q027,,debug,Compiling model.mimic.auroc,109348,Thread-1,2022-07-18T00:10:03.488172Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.auroc""",109348,Thread-1,2022-07-18T00:10:03.490613Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:03.491067Z
Q031,,debug,Began executing node model.mimic.auroc,109348,Thread-1,2022-07-18T00:10:03.491361Z,table,null,auroc,functions/auroc.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.auroc""",109348,Thread-1,2022-07-18T00:10:03.498278Z
E015,,debug,"Using postgres connection ""model.mimic.auroc""",109348,Thread-1,2022-07-18T00:10:03.498927Z
E016,,debug,On model.mimic.auroc: BEGIN,109348,Thread-1,2022-07-18T00:10:03.499181Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:03.499417Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:03.508447Z
E015,,debug,"Using postgres connection ""model.mimic.auroc""",109348,Thread-1,2022-07-18T00:10:03.508775Z
E016,,debug,"On model.mimic.auroc: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.auroc""} */


  create  table ""postgres"".""public"".""auroc__dbt_tmp""
  as (
    -- Calculate the AUROC of age for predicting in-hospital mortality
-- You can easily calculate the AUROC of any model you'd like by:
--  Replacing ""PRED"" with your predictor
--  Replacing ""TAR"" with the target (*must* be a binary target)

with datatable as (
select
  -- name the predictor ""PRED""
  cast(adm.admittime as date) - cast(pat.dob as date) as PRED -- age is our predictor
  -- name the target variable ""TAR""
  , case when adm.deathtime is not null then 1 else 0 end as TAR -- in-hospital mortality
FROM admissions adm
inner join patients pat
  on adm.subject_id = pat.subject_id
)
, datacs as (
select
  TAR
  -- calculate the cumulative sum of negative targets, then multiply by positive targets
  -- this has the effect of returning 0 for negative targets, and the # of negative targets below each positive target
  , TAR * SUM(1-TAR) OVER (ORDER BY PRED ASC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS AUROC
from datatable
)
select
  -- Calculate the AUROC as:
  --    SUM( number of negative targets below each positive target )
  -- /  number of possible negative/positive target pairs
  round(sum(AUROC) / (sum(TAR)*sum(1-TAR)),4) as AUROC
from datacs
  );",109348,Thread-1,2022-07-18T00:10:03.509082Z
E017,,debug,SQL status: SELECT 1 in 0.07 seconds,109348,Thread-1,2022-07-18T00:10:03.583474Z
E015,,debug,"Using postgres connection ""model.mimic.auroc""",109348,Thread-1,2022-07-18T00:10:03.591752Z
E016,,debug,"On model.mimic.auroc: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.auroc""} */
alter table ""postgres"".""public"".""auroc"" rename to ""auroc__dbt_backup""",109348,Thread-1,2022-07-18T00:10:03.592283Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:03.593330Z
E015,,debug,"Using postgres connection ""model.mimic.auroc""",109348,Thread-1,2022-07-18T00:10:03.597302Z
E016,,debug,"On model.mimic.auroc: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.auroc""} */
alter table ""postgres"".""public"".""auroc__dbt_tmp"" rename to ""auroc""",109348,Thread-1,2022-07-18T00:10:03.597525Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:03.598505Z
E018,,debug,On model.mimic.auroc: COMMIT,109348,Thread-1,2022-07-18T00:10:03.602276Z
E015,,debug,"Using postgres connection ""model.mimic.auroc""",109348,Thread-1,2022-07-18T00:10:03.602516Z
E016,,debug,On model.mimic.auroc: COMMIT,109348,Thread-1,2022-07-18T00:10:03.602728Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:03.605446Z
E015,,debug,"Using postgres connection ""model.mimic.auroc""",109348,Thread-1,2022-07-18T00:10:03.608661Z
E016,,debug,"On model.mimic.auroc: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.auroc""} */
drop table if exists ""postgres"".""public"".""auroc__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:03.609097Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:03.611732Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:03.615246Z
E010,,debug,On model.mimic.auroc: Close,109348,Thread-1,2022-07-18T00:10:03.615609Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7c4c3ecd-5c14-4600-9281-0e21ba30ba00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3f887da2e0>]}",109348,Thread-1,2022-07-18T00:10:03.616330Z
Q012,0,info,6 of 107 OK created table model public.auroc ................................... [[32mSELECT 1[0m in 0.13s],109348,Thread-1,2022-07-18T00:10:03.616644Z,table,null,auroc,functions/auroc.sql,2022-07-18T00:10:03.485369,compiling,model,,,
Q024,0.12967252731323242,debug,Finished running node model.mimic.auroc,109348,Thread-1,2022-07-18T00:10:03.617124Z,table,2022-07-18T00:10:03.616891,auroc,functions/auroc.sql,2022-07-18T00:10:03.485369,success,model,,,
Q023,,debug,Began running node model.mimic.basic_patient_info,109348,Thread-1,2022-07-18T00:10:03.617539Z,table,null,basic_patient_info,cookbook/basic_patient_info.sql,2022-07-18T00:10:03.617514,started,model,,,
Q033,,info,7 of 107 START table model public.basic_patient_info ........................... [RUN],109348,Thread-1,2022-07-18T00:10:03.618301Z,table,null,basic_patient_info,cookbook/basic_patient_info.sql,2022-07-18T00:10:03.617514,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.basic_patient_info""",109348,Thread-1,2022-07-18T00:10:03.619272Z
Q030,,debug,Began compiling node model.mimic.basic_patient_info,109348,Thread-1,2022-07-18T00:10:03.619650Z,table,null,basic_patient_info,cookbook/basic_patient_info.sql,2022-07-18T00:10:03.617514,compiling,model,,,
Q027,,debug,Compiling model.mimic.basic_patient_info,109348,Thread-1,2022-07-18T00:10:03.619895Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.basic_patient_info""",109348,Thread-1,2022-07-18T00:10:03.622589Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:03.623772Z
Q031,,debug,Began executing node model.mimic.basic_patient_info,109348,Thread-1,2022-07-18T00:10:03.624426Z,table,null,basic_patient_info,cookbook/basic_patient_info.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.basic_patient_info""",109348,Thread-1,2022-07-18T00:10:03.633369Z
E015,,debug,"Using postgres connection ""model.mimic.basic_patient_info""",109348,Thread-1,2022-07-18T00:10:03.633998Z
E016,,debug,On model.mimic.basic_patient_info: BEGIN,109348,Thread-1,2022-07-18T00:10:03.634323Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:03.634569Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:03.642114Z
E015,,debug,"Using postgres connection ""model.mimic.basic_patient_info""",109348,Thread-1,2022-07-18T00:10:03.642419Z
E016,,debug,"On model.mimic.basic_patient_info: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.basic_patient_info""} */


  create  table ""postgres"".""public"".""basic_patient_info__dbt_tmp""
  as (
    -- ------------------------------------------------------------------
-- Title: Retrieves basic patient information from the patients table
-- Notes: this query does not specify a schema. To run it on your local
-- MIMIC schema, run the following command:
--  SET SEARCH_PATH TO mimiciii
-- Where ""mimiciii"" is the name of your schema, and may be different.
-- ------------------------------------------------------------------


SELECT subject_id, gender, dob
FROM patients
  );",109348,Thread-1,2022-07-18T00:10:03.642641Z
E017,,debug,SQL status: SELECT 46520 in 0.02 seconds,109348,Thread-1,2022-07-18T00:10:03.663343Z
E015,,debug,"Using postgres connection ""model.mimic.basic_patient_info""",109348,Thread-1,2022-07-18T00:10:03.668851Z
E016,,debug,"On model.mimic.basic_patient_info: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.basic_patient_info""} */
alter table ""postgres"".""public"".""basic_patient_info"" rename to ""basic_patient_info__dbt_backup""",109348,Thread-1,2022-07-18T00:10:03.669078Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:03.670082Z
E015,,debug,"Using postgres connection ""model.mimic.basic_patient_info""",109348,Thread-1,2022-07-18T00:10:03.678693Z
E016,,debug,"On model.mimic.basic_patient_info: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.basic_patient_info""} */
alter table ""postgres"".""public"".""basic_patient_info__dbt_tmp"" rename to ""basic_patient_info""",109348,Thread-1,2022-07-18T00:10:03.678957Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:03.679665Z
E018,,debug,On model.mimic.basic_patient_info: COMMIT,109348,Thread-1,2022-07-18T00:10:03.685511Z
E015,,debug,"Using postgres connection ""model.mimic.basic_patient_info""",109348,Thread-1,2022-07-18T00:10:03.686154Z
E016,,debug,On model.mimic.basic_patient_info: COMMIT,109348,Thread-1,2022-07-18T00:10:03.686370Z
E017,,debug,SQL status: COMMIT in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:03.695484Z
E015,,debug,"Using postgres connection ""model.mimic.basic_patient_info""",109348,Thread-1,2022-07-18T00:10:03.701337Z
E016,,debug,"On model.mimic.basic_patient_info: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.basic_patient_info""} */
drop table if exists ""postgres"".""public"".""basic_patient_info__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:03.701723Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:03.703649Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:03.708316Z
E010,,debug,On model.mimic.basic_patient_info: Close,109348,Thread-1,2022-07-18T00:10:03.708592Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7c4c3ecd-5c14-4600-9281-0e21ba30ba00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3f8a037d00>]}",109348,Thread-1,2022-07-18T00:10:03.709188Z
Q012,0,info,7 of 107 OK created table model public.basic_patient_info ...................... [[32mSELECT 46520[0m in 0.09s],109348,Thread-1,2022-07-18T00:10:03.709708Z,table,null,basic_patient_info,cookbook/basic_patient_info.sql,2022-07-18T00:10:03.617514,compiling,model,,,
Q024,0.09033370018005371,debug,Finished running node model.mimic.basic_patient_info,109348,Thread-1,2022-07-18T00:10:03.710681Z,table,2022-07-18T00:10:03.710498,basic_patient_info,cookbook/basic_patient_info.sql,2022-07-18T00:10:03.617514,success,model,,,
Q023,,debug,Began running node model.mimic.blood_gas_first_day,109348,Thread-1,2022-07-18T00:10:03.710978Z,table,null,blood_gas_first_day,firstday/blood_gas_first_day.sql,2022-07-18T00:10:03.710952,started,model,,,
Q033,,info,8 of 107 START table model public.blood_gas_first_day .......................... [RUN],109348,Thread-1,2022-07-18T00:10:03.711252Z,table,null,blood_gas_first_day,firstday/blood_gas_first_day.sql,2022-07-18T00:10:03.710952,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.blood_gas_first_day""",109348,Thread-1,2022-07-18T00:10:03.711932Z
Q030,,debug,Began compiling node model.mimic.blood_gas_first_day,109348,Thread-1,2022-07-18T00:10:03.712083Z,table,null,blood_gas_first_day,firstday/blood_gas_first_day.sql,2022-07-18T00:10:03.710952,compiling,model,,,
Q027,,debug,Compiling model.mimic.blood_gas_first_day,109348,Thread-1,2022-07-18T00:10:03.712218Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.blood_gas_first_day""",109348,Thread-1,2022-07-18T00:10:03.713208Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:03.713545Z
Q031,,debug,Began executing node model.mimic.blood_gas_first_day,109348,Thread-1,2022-07-18T00:10:03.714227Z,table,null,blood_gas_first_day,firstday/blood_gas_first_day.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.blood_gas_first_day""",109348,Thread-1,2022-07-18T00:10:03.723913Z
E015,,debug,"Using postgres connection ""model.mimic.blood_gas_first_day""",109348,Thread-1,2022-07-18T00:10:03.725253Z
E016,,debug,On model.mimic.blood_gas_first_day: BEGIN,109348,Thread-1,2022-07-18T00:10:03.725469Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:03.725860Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:03.732077Z
E015,,debug,"Using postgres connection ""model.mimic.blood_gas_first_day""",109348,Thread-1,2022-07-18T00:10:03.732348Z
E016,,debug,"On model.mimic.blood_gas_first_day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.blood_gas_first_day""} */


  create  table ""postgres"".""public"".""blood_gas_first_day__dbt_tmp""
  as (
    -- The aim of this query is to pivot entries related to blood gases and
-- chemistry values which were found in LABEVENTS

-- things to check:
--  when a mixed venous/arterial blood sample are taken at the same time, is the store time different?

with pvt as
( -- begin query that extracts the data
  select ie.subject_id, ie.hadm_id, ie.icustay_id
  -- here we assign labels to ITEMIDs
  -- this also fuses together multiple ITEMIDs containing the same data
      , case
        when itemid = 50800 then 'SPECIMEN'
        when itemid = 50801 then 'AADO2'
        when itemid = 50802 then 'BASEEXCESS'
        when itemid = 50803 then 'BICARBONATE'
        when itemid = 50804 then 'TOTALCO2'
        when itemid = 50805 then 'CARBOXYHEMOGLOBIN'
        when itemid = 50806 then 'CHLORIDE'
        when itemid = 50808 then 'CALCIUM'
        when itemid = 50809 then 'GLUCOSE'
        when itemid = 50810 then 'HEMATOCRIT'
        when itemid = 50811 then 'HEMOGLOBIN'
        when itemid = 50812 then 'INTUBATED'
        when itemid = 50813 then 'LACTATE'
        when itemid = 50814 then 'METHEMOGLOBIN'
        when itemid = 50815 then 'O2FLOW'
        when itemid = 50816 then 'FIO2'
        when itemid = 50817 then 'SO2' -- OXYGENSATURATION
        when itemid = 50818 then 'PCO2'
        when itemid = 50819 then 'PEEP'
        when itemid = 50820 then 'PH'
        when itemid = 50821 then 'PO2'
        when itemid = 50822 then 'POTASSIUM'
        when itemid = 50823 then 'REQUIREDO2'
        when itemid = 50824 then 'SODIUM'
        when itemid = 50825 then 'TEMPERATURE'
        when itemid = 50826 then 'TIDALVOLUME'
        when itemid = 50827 then 'VENTILATIONRATE'
        when itemid = 50828 then 'VENTILATOR'
        else null
        end as label
        , charttime
        , value
        -- add in some sanity checks on the values
        , case
          when valuenum <= 0 and itemid != 50802 then null -- allow negative baseexcess
          when itemid = 50810 and valuenum > 100 then null -- hematocrit
          -- ensure FiO2 is a valid number between 21-100
          -- mistakes are rare (<100 obs out of ~100,000)
          -- there are 862 obs of valuenum == 20 - some people round down!
          -- rather than risk imputing garbage data for FiO2, we simply NULL invalid values
          when itemid = 50816 and valuenum < 20 then null
          when itemid = 50816 and valuenum > 100 then null
          when itemid = 50817 and valuenum > 100 then null -- O2 sat
          when itemid = 50815 and valuenum >  70 then null -- O2 flow
          when itemid = 50821 and valuenum > 800 then null -- PO2
           -- conservative upper limit
        else valuenum
        end as valuenum

    FROM icustays ie
    left join labevents le
      on le.subject_id = ie.subject_id and le.hadm_id = ie.hadm_id
      and le.charttime between (DATETIME_SUB(ie.intime, INTERVAL '6' HOUR)) and (DATETIME_ADD(ie.intime, INTERVAL '1' DAY))
      and le.ITEMID in
      -- blood gases
      (
        50800, 50801, 50802, 50803, 50804, 50805, 50806, 50807, 50808, 50809
        , 50810, 50811, 50812, 50813, 50814, 50815, 50816, 50817, 50818, 50819
        , 50820, 50821, 50822, 50823, 50824, 50825, 50826, 50827, 50828
        , 51545
      )
)
select pvt.SUBJECT_ID, pvt.HADM_ID, pvt.ICUSTAY_ID, pvt.CHARTTIME
, max(case when label = 'SPECIMEN' then value else null end) as specimen
, max(case when label = 'AADO2' then valuenum else null end) as aado2
, max(case when label = 'BASEEXCESS' then valuenum else null end) as baseexcess
, max(case when label = 'BICARBONATE' then valuenum else null end) as bicarbonate
, max(case when label = 'TOTALCO2' then valuenum else null end) as totalco2
, max(case when label = 'CARBOXYHEMOGLOBIN' then valuenum else null end) as carboxyhemoglobin
, max(case when label = 'CHLORIDE' then valuenum else null end) as chloride
, max(case when label = 'CALCIUM' then valuenum else null end) as calcium
, max(case when label = 'GLUCOSE' then valuenum else null end) as glucose
, max(case when label = 'HEMATOCRIT' then valuenum else null end) as hematocrit
, max(case when label = 'HEMOGLOBIN' then valuenum else null end) as hemoglobin
, max(case when label = 'INTUBATED' then valuenum else null end) as intubated
, max(case when label = 'LACTATE' then valuenum else null end) as lactate
, max(case when label = 'METHEMOGLOBIN' then valuenum else null end) as methemoglobin
, max(case when label = 'O2FLOW' then valuenum else null end) as o2flow
, max(case when label = 'FIO2' then valuenum else null end) as fio2
, max(case when label = 'SO2' then valuenum else null end) as so2 -- OXYGENSATURATION
, max(case when label = 'PCO2' then valuenum else null end) as pco2
, max(case when label = 'PEEP' then valuenum else null end) as peep
, max(case when label = 'PH' then valuenum else null end) as ph
, max(case when label = 'PO2' then valuenum else null end) as po2
, max(case when label = 'POTASSIUM' then valuenum else null end) as potassium
, max(case when label = 'REQUIREDO2' then valuenum else null end) as requiredo2
, max(case when label = 'SODIUM' then valuenum else null end) as sodium
, max(case when label = 'TEMPERATURE' then valuenum else null end) as temperature
, max(case when label = 'TIDALVOLUME' then valuenum else null end) as tidalvolume
, max(case when label = 'VENTILATIONRATE' then valuenum else null end) as ventilationrate
, max(case when label = 'VENTILATOR' then valuenum else null end) as ventilator
from pvt
group by pvt.subject_id, pvt.hadm_id, pvt.icustay_id, pvt.CHARTTIME
order by pvt.subject_id, pvt.hadm_id, pvt.icustay_id, pvt.CHARTTIME
  );",109348,Thread-1,2022-07-18T00:10:03.732719Z
E017,,debug,SQL status: SELECT 61532 in 0.15 seconds,109348,Thread-1,2022-07-18T00:10:03.882882Z
E015,,debug,"Using postgres connection ""model.mimic.blood_gas_first_day""",109348,Thread-1,2022-07-18T00:10:03.888508Z
E016,,debug,"On model.mimic.blood_gas_first_day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.blood_gas_first_day""} */
alter table ""postgres"".""public"".""blood_gas_first_day"" rename to ""blood_gas_first_day__dbt_backup""",109348,Thread-1,2022-07-18T00:10:03.888759Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:03.889476Z
E015,,debug,"Using postgres connection ""model.mimic.blood_gas_first_day""",109348,Thread-1,2022-07-18T00:10:03.893334Z
E016,,debug,"On model.mimic.blood_gas_first_day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.blood_gas_first_day""} */
alter table ""postgres"".""public"".""blood_gas_first_day__dbt_tmp"" rename to ""blood_gas_first_day""",109348,Thread-1,2022-07-18T00:10:03.893689Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:03.894454Z
E018,,debug,On model.mimic.blood_gas_first_day: COMMIT,109348,Thread-1,2022-07-18T00:10:03.897557Z
E015,,debug,"Using postgres connection ""model.mimic.blood_gas_first_day""",109348,Thread-1,2022-07-18T00:10:03.898239Z
E016,,debug,On model.mimic.blood_gas_first_day: COMMIT,109348,Thread-1,2022-07-18T00:10:03.898518Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:03.903652Z
E015,,debug,"Using postgres connection ""model.mimic.blood_gas_first_day""",109348,Thread-1,2022-07-18T00:10:03.905840Z
E016,,debug,"On model.mimic.blood_gas_first_day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.blood_gas_first_day""} */
drop table if exists ""postgres"".""public"".""blood_gas_first_day__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:03.906119Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:03.908558Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:03.911497Z
E010,,debug,On model.mimic.blood_gas_first_day: Close,109348,Thread-1,2022-07-18T00:10:03.911861Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7c4c3ecd-5c14-4600-9281-0e21ba30ba00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3f887ecc10>]}",109348,Thread-1,2022-07-18T00:10:03.912663Z
Q012,0,info,8 of 107 OK created table model public.blood_gas_first_day ..................... [[32mSELECT 61532[0m in 0.20s],109348,Thread-1,2022-07-18T00:10:03.913309Z,table,null,blood_gas_first_day,firstday/blood_gas_first_day.sql,2022-07-18T00:10:03.710952,compiling,model,,,
Q024,0.20087718963623047,debug,Finished running node model.mimic.blood_gas_first_day,109348,Thread-1,2022-07-18T00:10:03.914236Z,table,2022-07-18T00:10:03.914023,blood_gas_first_day,firstday/blood_gas_first_day.sql,2022-07-18T00:10:03.710952,success,model,,,
Q023,,debug,Began running node model.mimic.bun,109348,Thread-1,2022-07-18T00:10:03.914912Z,table,null,bun,cookbook/bun.sql,2022-07-18T00:10:03.914839,started,model,,,
Q033,,info,9 of 107 START table model public.bun .......................................... [RUN],109348,Thread-1,2022-07-18T00:10:03.915829Z,table,null,bun,cookbook/bun.sql,2022-07-18T00:10:03.914839,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.bun""",109348,Thread-1,2022-07-18T00:10:03.917134Z
Q030,,debug,Began compiling node model.mimic.bun,109348,Thread-1,2022-07-18T00:10:03.917394Z,table,null,bun,cookbook/bun.sql,2022-07-18T00:10:03.914839,compiling,model,,,
Q027,,debug,Compiling model.mimic.bun,109348,Thread-1,2022-07-18T00:10:03.917555Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.bun""",109348,Thread-1,2022-07-18T00:10:03.918802Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:03.919264Z
Q031,,debug,Began executing node model.mimic.bun,109348,Thread-1,2022-07-18T00:10:03.919538Z,table,null,bun,cookbook/bun.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.bun""",109348,Thread-1,2022-07-18T00:10:03.928986Z
E015,,debug,"Using postgres connection ""model.mimic.bun""",109348,Thread-1,2022-07-18T00:10:03.929432Z
E016,,debug,On model.mimic.bun: BEGIN,109348,Thread-1,2022-07-18T00:10:03.929555Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:03.929905Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:03.936492Z
E015,,debug,"Using postgres connection ""model.mimic.bun""",109348,Thread-1,2022-07-18T00:10:03.936964Z
E016,,debug,"On model.mimic.bun: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.bun""} */


  create  table ""postgres"".""public"".""bun__dbt_tmp""
  as (
    -- --------------------------------------------------------
-- Title: Create a distribution of BUN values for adult hospital admissions
-- Notes: this query does not specify a schema. To run it on your local
-- MIMIC schema, run the following command:
--  SET SEARCH_PATH TO mimiciii
-- Where ""mimiciii"" is the name of your schema, and may be different.
-- --------------------------------------------------------

WITH agetbl AS
(
    SELECT ad.subject_id
    FROM admissions ad
    INNER JOIN patients p
    ON ad.subject_id = p.subject_id
    WHERE
     -- filter to only adults
    DATETIME_DIFF(ad.admittime, p.dob, 'YEAR') > 15
    -- group by subject_id to ensure there is only 1 subject_id per row
    group by ad.subject_id
)
, bun as
(
  SELECT width_bucket(valuenum, 0, 280, 280) AS bucket
  FROM labevents le
  INNER JOIN agetbl
  ON le.subject_id = agetbl.subject_id
  WHERE itemid IN (51006)
)
SELECT bucket as blood_urea_nitrogen, count(*)
FROM bun
GROUP BY bucket
ORDER BY bucket
  );",109348,Thread-1,2022-07-18T00:10:03.937154Z
E017,,debug,SQL status: SELECT 0 in 0.15 seconds,109348,Thread-1,2022-07-18T00:10:04.089857Z
E015,,debug,"Using postgres connection ""model.mimic.bun""",109348,Thread-1,2022-07-18T00:10:04.096158Z
E016,,debug,"On model.mimic.bun: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.bun""} */
alter table ""postgres"".""public"".""bun"" rename to ""bun__dbt_backup""",109348,Thread-1,2022-07-18T00:10:04.096399Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:04.097393Z
E015,,debug,"Using postgres connection ""model.mimic.bun""",109348,Thread-1,2022-07-18T00:10:04.100864Z
E016,,debug,"On model.mimic.bun: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.bun""} */
alter table ""postgres"".""public"".""bun__dbt_tmp"" rename to ""bun""",109348,Thread-1,2022-07-18T00:10:04.101079Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:04.101889Z
E018,,debug,On model.mimic.bun: COMMIT,109348,Thread-1,2022-07-18T00:10:04.107410Z
E015,,debug,"Using postgres connection ""model.mimic.bun""",109348,Thread-1,2022-07-18T00:10:04.107820Z
E016,,debug,On model.mimic.bun: COMMIT,109348,Thread-1,2022-07-18T00:10:04.108045Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:04.109117Z
E015,,debug,"Using postgres connection ""model.mimic.bun""",109348,Thread-1,2022-07-18T00:10:04.111129Z
E016,,debug,"On model.mimic.bun: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.bun""} */
drop table if exists ""postgres"".""public"".""bun__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:04.111354Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:04.113219Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:04.115921Z
E010,,debug,On model.mimic.bun: Close,109348,Thread-1,2022-07-18T00:10:04.116175Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7c4c3ecd-5c14-4600-9281-0e21ba30ba00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3f8a03d040>]}",109348,Thread-1,2022-07-18T00:10:04.116978Z
Q012,0,info,9 of 107 OK created table model public.bun ..................................... [[32mSELECT 0[0m in 0.20s],109348,Thread-1,2022-07-18T00:10:04.117371Z,table,null,bun,cookbook/bun.sql,2022-07-18T00:10:03.914839,compiling,model,,,
Q024,0.20012593269348145,debug,Finished running node model.mimic.bun,109348,Thread-1,2022-07-18T00:10:04.117938Z,table,2022-07-18T00:10:04.117766,bun,cookbook/bun.sql,2022-07-18T00:10:03.914839,success,model,,,
Q023,,debug,Began running node model.mimic.central_line_durations,109348,Thread-1,2022-07-18T00:10:04.118452Z,table,null,central_line_durations,durations/central_line_durations.sql,2022-07-18T00:10:04.118355,started,model,,,
Q033,,info,10 of 107 START table model public.central_line_durations ...................... [RUN],109348,Thread-1,2022-07-18T00:10:04.119229Z,table,null,central_line_durations,durations/central_line_durations.sql,2022-07-18T00:10:04.118355,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.central_line_durations""",109348,Thread-1,2022-07-18T00:10:04.120078Z
Q030,,debug,Began compiling node model.mimic.central_line_durations,109348,Thread-1,2022-07-18T00:10:04.120555Z,table,null,central_line_durations,durations/central_line_durations.sql,2022-07-18T00:10:04.118355,compiling,model,,,
Q027,,debug,Compiling model.mimic.central_line_durations,109348,Thread-1,2022-07-18T00:10:04.121076Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.central_line_durations""",109348,Thread-1,2022-07-18T00:10:04.122412Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:04.122994Z
Q031,,debug,Began executing node model.mimic.central_line_durations,109348,Thread-1,2022-07-18T00:10:04.123263Z,table,null,central_line_durations,durations/central_line_durations.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.central_line_durations""",109348,Thread-1,2022-07-18T00:10:04.135630Z
E015,,debug,"Using postgres connection ""model.mimic.central_line_durations""",109348,Thread-1,2022-07-18T00:10:04.136103Z
E016,,debug,On model.mimic.central_line_durations: BEGIN,109348,Thread-1,2022-07-18T00:10:04.136232Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:04.136344Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:04.143399Z
E015,,debug,"Using postgres connection ""model.mimic.central_line_durations""",109348,Thread-1,2022-07-18T00:10:04.143692Z
E016,,debug,"On model.mimic.central_line_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.central_line_durations""} */


  create  table ""postgres"".""public"".""central_line_durations__dbt_tmp""
  as (
    with mv as
(
  select
    pe.icustay_id
  , pe.starttime, pe.endtime
    , case
        when (locationcategory <> 'Invasive Arterial' or locationcategory is null)
          then 1
        else 0
      end as central_line
  FROM procedureevents_mv pe
  where pe.itemid in
  (
      224263 -- Multi Lumen | None | 12 | Processes
    , 224264 -- PICC Line | None | 12 | Processes
    , 224267 -- Cordis/Introducer | None | 12 | Processes
    , 224268 -- Trauma line | None | 12 | Processes
    , 225199 -- Triple Introducer | None | 12 | Processes
    , 225202 -- Indwelling Port (PortaCath) | None | 12 | Processes
    , 225203 -- Pheresis Catheter | None | 12 | Processes
    , 225315 -- Tunneled (Hickman) Line | None | 12 | Processes
    , 225752 -- Arterial Line | None | 12 | Processes
    , 227719 -- AVA Line | None | 12 | Processes
    -- , 228286 -- Intraosseous Device | None | 12 | Processes
    , 224270 -- Dialysis Catheter
  )
)
, cv_grp as
(
  -- group type+site
  select ce.icustay_id, ce.charttime
    , max(case when itemid =  229  then value else null end) as INV1_Type
    , max(case when itemid =  8392 then value else null end) as INV1_Site
    , max(case when itemid =  235  then value else null end) as INV2_Type
    , max(case when itemid =  8393 then value else null end) as INV2_Site
    , max(case when itemid =  241  then value else null end) as INV3_Type
    , max(case when itemid =  8394 then value else null end) as INV3_Site
    , max(case when itemid =  247  then value else null end) as INV4_Type
    , max(case when itemid =  8395 then value else null end) as INV4_Site
    , max(case when itemid =  253  then value else null end) as INV5_Type
    , max(case when itemid =  8396 then value else null end) as INV5_Site
    , max(case when itemid =  259  then value else null end) as INV6_Type
    , max(case when itemid =  8397 then value else null end) as INV6_Site
    , max(case when itemid =  265  then value else null end) as INV7_Type
    , max(case when itemid =  8398 then value else null end) as INV7_Site
    , max(case when itemid =  271  then value else null end) as INV8_Type
    , max(case when itemid =  8399 then value else null end) as INV8_Site
  FROM chartevents ce
  where ce.itemid in
  (
      229 -- INV Line#1 [Type]
    , 235 -- INV Line#2 [Type]
    , 241 -- INV Line#3 [Type]
    , 247 -- INV Line#4 [Type]
    , 253 -- INV Line#5 [Type]
    , 259 -- INV Line#6 [Type]
    , 265 -- INV Line#7 [Type]
    , 271 -- INV Line#8 [Type]
    , 8392 -- INV Line#1 [Site]
    , 8393 -- INV Line#2 [Site]
    , 8394 -- INV Line#3 [Site]
    , 8395 -- INV Line#4 [Site]
    , 8396 -- INV Line#5 [Site]
    , 8397 -- INV Line#6 [Site]
    , 8398 -- INV Line#7 [Site]
    , 8399 -- INV Line#8 [Site]
  )
  and ce.value is not null
  group by ce.icustay_id, ce.charttime
)
-- types of invasive lines in carevue
--       value       | count
-- ------------------+--------
--  A-Line           | 460627
--  Multi-lumen      | 345858
--  PICC line        |  92285
--  PA line          |  65702
--  Dialysis Line    |  57579
--  Introducer       |  36027
--  CCO PA Line      |  24831
--                   |  22369
--  Trauma Line      |  15530
--  Portacath        |  12927
--  Ventriculostomy  |  10295
--  Pre-Sep Catheter |   9678
--  IABP             |   8819
--  Other/Remarks    |   8725
--  Midline          |   5067
--  Venous Access    |   4278
--  Hickman          |   3783
--  PacerIntroducer  |   2663
--  TripleIntroducer |   2262
--  RIC              |   1625
--  PermaCath        |   1066
--  Camino Bolt      |    913
--  Lumbar Drain     |    361
-- (23 rows)
, cv as
(
  select distinct icustay_id, charttime
  from cv_grp
  where (inv1_type in ('Multi-lumen', 'PICC line', 'Dialysis Line', 'Introducer','Trauma Line', 'Portacath', 'Venous Access', 'Hickman', 'PacerIntroducer', 'TripleIntroducer'))
     OR (inv2_type in ('Multi-lumen', 'PICC line', 'Dialysis Line', 'Introducer','Trauma Line', 'Portacath', 'Venous Access', 'Hickman', 'PacerIntroducer', 'TripleIntroducer'))
     OR (inv3_type in ('Multi-lumen', 'PICC line', 'Dialysis Line', 'Introducer','Trauma Line', 'Portacath', 'Venous Access', 'Hickman', 'PacerIntroducer', 'TripleIntroducer'))
     OR (inv4_type in ('Multi-lumen', 'PICC line', 'Dialysis Line', 'Introducer','Trauma Line', 'Portacath', 'Venous Access', 'Hickman', 'PacerIntroducer', 'TripleIntroducer'))
     OR (inv5_type in ('Multi-lumen', 'PICC line', 'Dialysis Line', 'Introducer','Trauma Line', 'Portacath', 'Venous Access', 'Hickman', 'PacerIntroducer', 'TripleIntroducer'))
     OR (inv6_type in ('Multi-lumen', 'PICC line', 'Dialysis Line', 'Introducer','Trauma Line', 'Portacath', 'Venous Access', 'Hickman', 'PacerIntroducer', 'TripleIntroducer'))
     OR (inv7_type in ('Multi-lumen', 'PICC line', 'Dialysis Line', 'Introducer','Trauma Line', 'Portacath', 'Venous Access', 'Hickman', 'PacerIntroducer', 'TripleIntroducer'))
     OR (inv8_type in ('Multi-lumen', 'PICC line', 'Dialysis Line', 'Introducer','Trauma Line', 'Portacath', 'Venous Access', 'Hickman', 'PacerIntroducer', 'TripleIntroducer'))
)
-- transform carevue data into durations
, cv0 as
(
  select
    icustay_id
    -- this carries over the previous charttime
    , LAG(CHARTTIME, 1) OVER (partition by icustay_id order by charttime) as charttime_lag
    , charttime
  from cv
)
, cv1 as
(
  select
    icustay_id
    , charttime
    , charttime_lag
    -- if the current observation indicates a line is present
    -- calculate the time since the last charted line
    , charttime - charttime_lag as central_line_duration
    -- now we determine if the current line is ""new""
    -- new == no documentation for 16 hours
    , case
        when DATETIME_DIFF(charttime, charttime_lag, 'HOUR') > 16
          then 1
      else 0
      end as central_line_new
  FROM cv0
)
, cv2 as
(
  select cv1.*
  -- create a cumulative sum of the instances of new events
  -- this results in a monotonic integer assigned to each new instance of a line
  , SUM( central_line_new )
    OVER ( partition by icustay_id order by charttime )
    as central_line_rownum
  from cv1
)
-- create the durations for each line
, cv_dur as
(
  select icustay_id
    , central_line_rownum
    , min(charttime) as starttime
    , max(charttime) as endtime
    , DATETIME_DIFF(max(charttime), min(charttime), 'HOUR') AS duration_hours
  from cv2
  group by icustay_id, central_line_rownum
  having min(charttime) != max(charttime)
)
select icustay_id
  -- , central_line_rownum
  , starttime, endtime, duration_hours
from cv_dur
UNION ALL
--TODO: collapse metavision durations if they overlap
select icustay_id
  -- , ROW_NUMBER() over (PARTITION BY icustay_id ORDER BY starttime) as central_line_rownum
  , starttime, endtime
  , DATETIME_DIFF(endtime, starttime, 'HOUR') AS duration_hours
from mv
where central_line = 1
order by icustay_id, starttime
  );",109348,Thread-1,2022-07-18T00:10:04.143826Z
E017,,debug,SQL status: SELECT 21211 in 0.09 seconds,109348,Thread-1,2022-07-18T00:10:04.230339Z
E015,,debug,"Using postgres connection ""model.mimic.central_line_durations""",109348,Thread-1,2022-07-18T00:10:04.236318Z
E016,,debug,"On model.mimic.central_line_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.central_line_durations""} */
alter table ""postgres"".""public"".""central_line_durations"" rename to ""central_line_durations__dbt_backup""",109348,Thread-1,2022-07-18T00:10:04.236715Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:04.238291Z
E015,,debug,"Using postgres connection ""model.mimic.central_line_durations""",109348,Thread-1,2022-07-18T00:10:04.244430Z
E016,,debug,"On model.mimic.central_line_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.central_line_durations""} */
alter table ""postgres"".""public"".""central_line_durations__dbt_tmp"" rename to ""central_line_durations""",109348,Thread-1,2022-07-18T00:10:04.244786Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:04.245677Z
E018,,debug,On model.mimic.central_line_durations: COMMIT,109348,Thread-1,2022-07-18T00:10:04.251736Z
E015,,debug,"Using postgres connection ""model.mimic.central_line_durations""",109348,Thread-1,2022-07-18T00:10:04.252057Z
E016,,debug,On model.mimic.central_line_durations: COMMIT,109348,Thread-1,2022-07-18T00:10:04.252358Z
E017,,debug,SQL status: COMMIT in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:04.258056Z
E015,,debug,"Using postgres connection ""model.mimic.central_line_durations""",109348,Thread-1,2022-07-18T00:10:04.262170Z
E016,,debug,"On model.mimic.central_line_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.central_line_durations""} */
drop table if exists ""postgres"".""public"".""central_line_durations__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:04.262507Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:04.264574Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:04.268586Z
E010,,debug,On model.mimic.central_line_durations: Close,109348,Thread-1,2022-07-18T00:10:04.268898Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7c4c3ecd-5c14-4600-9281-0e21ba30ba00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3f8a037d30>]}",109348,Thread-1,2022-07-18T00:10:04.269799Z
Q012,0,info,10 of 107 OK created table model public.central_line_durations ................. [[32mSELECT 21211[0m in 0.15s],109348,Thread-1,2022-07-18T00:10:04.271131Z,table,null,central_line_durations,durations/central_line_durations.sql,2022-07-18T00:10:04.118355,compiling,model,,,
Q024,0.1498706340789795,debug,Finished running node model.mimic.central_line_durations,109348,Thread-1,2022-07-18T00:10:04.272704Z,table,2022-07-18T00:10:04.272319,central_line_durations,durations/central_line_durations.sql,2022-07-18T00:10:04.118355,success,model,,,
Q023,,debug,Began running node model.mimic.code_status,109348,Thread-1,2022-07-18T00:10:04.273464Z,table,null,code_status,code_status.sql,2022-07-18T00:10:04.273436,started,model,,,
Q033,,info,11 of 107 START table model public.code_status ................................. [RUN],109348,Thread-1,2022-07-18T00:10:04.274479Z,table,null,code_status,code_status.sql,2022-07-18T00:10:04.273436,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.code_status""",109348,Thread-1,2022-07-18T00:10:04.275512Z
Q030,,debug,Began compiling node model.mimic.code_status,109348,Thread-1,2022-07-18T00:10:04.275876Z,table,null,code_status,code_status.sql,2022-07-18T00:10:04.273436,compiling,model,,,
Q027,,debug,Compiling model.mimic.code_status,109348,Thread-1,2022-07-18T00:10:04.276197Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.code_status""",109348,Thread-1,2022-07-18T00:10:04.279165Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:04.279874Z
Q031,,debug,Began executing node model.mimic.code_status,109348,Thread-1,2022-07-18T00:10:04.280258Z,table,null,code_status,code_status.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.code_status""",109348,Thread-1,2022-07-18T00:10:04.291903Z
E015,,debug,"Using postgres connection ""model.mimic.code_status""",109348,Thread-1,2022-07-18T00:10:04.292676Z
E016,,debug,On model.mimic.code_status: BEGIN,109348,Thread-1,2022-07-18T00:10:04.292993Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:04.293232Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:04.298992Z
E015,,debug,"Using postgres connection ""model.mimic.code_status""",109348,Thread-1,2022-07-18T00:10:04.299339Z
E016,,debug,"On model.mimic.code_status: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.code_status""} */


  create  table ""postgres"".""public"".""code_status__dbt_tmp""
  as (
    -- This query extracts:
--    i) a patient's first code status
--    ii) a patient's last code status
--    iii) the time of the first entry of DNR or CMO



with t1 as
(
  select icustay_id, charttime, value
  -- use row number to identify first and last code status
  , ROW_NUMBER() over (PARTITION BY icustay_id order by charttime) as rnfirst
  , ROW_NUMBER() over (PARTITION BY icustay_id order by charttime desc) as rnlast

  -- coalesce the values
  , case
      when value in ('Full Code','Full code') then 1
    else 0 end as fullcode
  , case
      when value in ('Comfort Measures','Comfort measures only') then 1
    else 0 end as cmo
  , case
      when value = 'CPR Not Indicate' then 1
    else 0 end as dncpr -- only in CareVue, i.e. only possible for ~60-70% of patients
  , case
      when value in ('Do Not Intubate','DNI (do not intubate)','DNR / DNI') then 1
    else 0 end as dni
  , case
      when value in ('Do Not Resuscita','DNR (do not resuscitate)','DNR / DNI') then 1
    else 0 end as dnr
  FROM chartevents
  where itemid in (128, 223758)
  and value is not null
  and value != 'Other/Remarks'
  -- exclude rows marked as error
  AND (error IS NULL OR error = 0)
)
select ie.subject_id, ie.hadm_id, ie.icustay_id
  -- first recorded code status
  , max(case when rnfirst = 1 then t1.fullcode else null end) as fullcode_first
  , max(case when rnfirst = 1 then t1.cmo else null end) as cmo_first
  , max(case when rnfirst = 1 then t1.dnr else null end) as dnr_first
  , max(case when rnfirst = 1 then t1.dni else null end) as dni_first
  , max(case when rnfirst = 1 then t1.dncpr else null end) as dncpr_first

  -- last recorded code status
  , max(case when  rnlast = 1 then t1.fullcode else null end) as fullcode_last
  , max(case when  rnlast = 1 then t1.cmo else null end) as cmo_last
  , max(case when  rnlast = 1 then t1.dnr else null end) as dnr_last
  , max(case when  rnlast = 1 then t1.dni else null end) as dni_last
  , max(case when  rnlast = 1 then t1.dncpr else null end) as DNCPR_last

  -- were they *at any time* given a certain code status
  , max(t1.fullcode) as fullcode
  , max(t1.cmo) as cmo
  , max(t1.dnr) as dnr
  , max(t1.dni) as dni
  , max(t1.dncpr) as dncpr

  -- time until their first DNR
  , min(case when t1.dnr = 1 then t1.charttime else null end)
        as dnr_first_charttime
  , min(case when t1.dni = 1 then t1.charttime else null end)
        as dni_first_charttime
  , min(case when t1.dncpr = 1 then t1.charttime else null end)
        as dncpr_first_charttime

  -- first code status of CMO
  , min(case when t1.cmo = 1 then t1.charttime else null end)
        as timecmo_chart

FROM icustays ie
left join t1
  on ie.icustay_id = t1.icustay_id
group by ie.subject_id, ie.hadm_id, ie.icustay_id, ie.intime
  );",109348,Thread-1,2022-07-18T00:10:04.299578Z
E017,,debug,SQL status: SELECT 61532 in 0.1 seconds,109348,Thread-1,2022-07-18T00:10:04.403219Z
E015,,debug,"Using postgres connection ""model.mimic.code_status""",109348,Thread-1,2022-07-18T00:10:04.409848Z
E016,,debug,"On model.mimic.code_status: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.code_status""} */
alter table ""postgres"".""public"".""code_status"" rename to ""code_status__dbt_backup""",109348,Thread-1,2022-07-18T00:10:04.410197Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:04.411064Z
E015,,debug,"Using postgres connection ""model.mimic.code_status""",109348,Thread-1,2022-07-18T00:10:04.414963Z
E016,,debug,"On model.mimic.code_status: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.code_status""} */
alter table ""postgres"".""public"".""code_status__dbt_tmp"" rename to ""code_status""",109348,Thread-1,2022-07-18T00:10:04.415200Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:04.416026Z
E018,,debug,On model.mimic.code_status: COMMIT,109348,Thread-1,2022-07-18T00:10:04.419390Z
E015,,debug,"Using postgres connection ""model.mimic.code_status""",109348,Thread-1,2022-07-18T00:10:04.419713Z
E016,,debug,On model.mimic.code_status: COMMIT,109348,Thread-1,2022-07-18T00:10:04.420299Z
E017,,debug,SQL status: COMMIT in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:04.428008Z
E015,,debug,"Using postgres connection ""model.mimic.code_status""",109348,Thread-1,2022-07-18T00:10:04.430440Z
E016,,debug,"On model.mimic.code_status: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.code_status""} */
drop table if exists ""postgres"".""public"".""code_status__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:04.430692Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:04.432704Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:04.435402Z
E010,,debug,On model.mimic.code_status: Close,109348,Thread-1,2022-07-18T00:10:04.435653Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7c4c3ecd-5c14-4600-9281-0e21ba30ba00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3f8c8bc040>]}",109348,Thread-1,2022-07-18T00:10:04.436306Z
Q012,0,info,11 of 107 OK created table model public.code_status ............................ [[32mSELECT 61532[0m in 0.16s],109348,Thread-1,2022-07-18T00:10:04.436983Z,table,null,code_status,code_status.sql,2022-07-18T00:10:04.273436,compiling,model,,,
Q024,0.16092824935913086,debug,Finished running node model.mimic.code_status,109348,Thread-1,2022-07-18T00:10:04.437485Z,table,2022-07-18T00:10:04.437366,code_status,code_status.sql,2022-07-18T00:10:04.273436,success,model,,,
Q023,,debug,Began running node model.mimic.colloid_bolus,109348,Thread-1,2022-07-18T00:10:04.438094Z,table,null,colloid_bolus,fluid_balance/colloid_bolus.sql,2022-07-18T00:10:04.437969,started,model,,,
Q033,,info,12 of 107 START table model public.colloid_bolus ............................... [RUN],109348,Thread-1,2022-07-18T00:10:04.438867Z,table,null,colloid_bolus,fluid_balance/colloid_bolus.sql,2022-07-18T00:10:04.437969,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.colloid_bolus""",109348,Thread-1,2022-07-18T00:10:04.439848Z
Q030,,debug,Began compiling node model.mimic.colloid_bolus,109348,Thread-1,2022-07-18T00:10:04.440105Z,table,null,colloid_bolus,fluid_balance/colloid_bolus.sql,2022-07-18T00:10:04.437969,compiling,model,,,
Q027,,debug,Compiling model.mimic.colloid_bolus,109348,Thread-1,2022-07-18T00:10:04.440431Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.colloid_bolus""",109348,Thread-1,2022-07-18T00:10:04.441871Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:04.442576Z
Q031,,debug,Began executing node model.mimic.colloid_bolus,109348,Thread-1,2022-07-18T00:10:04.442866Z,table,null,colloid_bolus,fluid_balance/colloid_bolus.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.colloid_bolus""",109348,Thread-1,2022-07-18T00:10:04.450385Z
E015,,debug,"Using postgres connection ""model.mimic.colloid_bolus""",109348,Thread-1,2022-07-18T00:10:04.451116Z
E016,,debug,On model.mimic.colloid_bolus: BEGIN,109348,Thread-1,2022-07-18T00:10:04.451372Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:04.451628Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:04.457104Z
E015,,debug,"Using postgres connection ""model.mimic.colloid_bolus""",109348,Thread-1,2022-07-18T00:10:04.457510Z
E016,,debug,"On model.mimic.colloid_bolus: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.colloid_bolus""} */


  create  table ""postgres"".""public"".""colloid_bolus__dbt_tmp""
  as (
    -- received colloid before admission
-- 226365  --  OR Colloid Intake
-- 226376  --  PACU Colloid Intake

with t1 as
(
  select
    mv.icustay_id
  , mv.starttime as charttime
  -- standardize the units to millilitres
  -- also metavision has floating point precision.. but we only care down to the mL
  , round(case
      when mv.amountuom = 'L'
        then mv.amount * 1000.0
      when mv.amountuom = 'ml'
        then mv.amount
    else null end) as amount
  from inputevents_mv mv
  where mv.itemid in
  (
    220864, --	Albumin 5%	7466 132 7466
    220862, --	Albumin 25%	9851 174 9851
    225174, --	Hetastarch (Hespan) 6%	82 1 82
    225795, --	Dextran 40	38 3 38
    225796  --  Dextran 70
    -- below ITEMIDs not in use
   -- 220861 | Albumin (Human) 20%
   -- 220863 | Albumin (Human) 4%
  )
  and mv.statusdescription != 'Rewritten'
  and
  -- in MetaVision, these ITEMIDs never appear with a null rate
  -- so it is sufficient to check the rate is > 100
    (
      (mv.rateuom = 'mL/hour' and mv.rate > 100)
      OR (mv.rateuom = 'mL/min' and mv.rate > (100/60.0))
      OR (mv.rateuom = 'mL/kg/hour' and (mv.rate*mv.patientweight) > 100)
    )
)
, t2 as
(
  select
    cv.icustay_id
  , cv.charttime
  -- carevue always has units in millilitres (or null)
  , round(cv.amount) as amount
  from inputevents_cv cv
  where cv.itemid in
  (
   30008 --	Albumin 5%
  ,30009 --	Albumin 25%
  ,42832 --	albumin 12.5%
  ,40548 --	ALBUMIN
  ,45403 --	albumin
  ,44203 --	Albumin 12.5%
  ,30181 -- Serum Albumin 5%
  ,46564 -- Albumin
  ,43237 -- 25% Albumin
  ,43353 -- Albumin (human) 25%

  ,30012 --	Hespan
  ,46313 --	6% Hespan

  ,30011 -- Dextran 40
  ,30016 -- Dextrose 10%
  ,42975 --	DEXTRAN DRIP
  ,42944 --	dextran
  ,46336 --	10% Dextran 40/D5W
  ,46729 --	Dextran
  ,40033 --	DEXTRAN
  ,45410 --	10% Dextran 40
  ,42731 -- Dextran40 10%
  )
  and cv.amount > 100
  and cv.amount < 2000
)
-- some colloids are charted in chartevents
, t3 as
(
  select
    ce.icustay_id
  , ce.charttime
  -- carevue always has units in millilitres (or null)
  , round(ce.valuenum) as amount
  from chartevents ce
  where ce.itemid in
  (
      2510 --	DEXTRAN LML 10%
    , 3087 --	DEXTRAN 40  10%
    , 6937 --	Dextran
    , 3087 -- DEXTRAN 40  10%
    , 3088 --	DEXTRAN 40%
  )
  and ce.valuenum is not null
  and ce.valuenum > 100
  and ce.valuenum < 2000
)
select
    icustay_id
  , charttime
  , sum(amount) as colloid_bolus
from t1
-- just because the rate was high enough, does *not* mean the final amount was
where amount > 100
group by t1.icustay_id, t1.charttime
UNION ALL
select
    icustay_id
  , charttime
  , sum(amount) as colloid_bolus
from t2
group by t2.icustay_id, t2.charttime
UNION ALL 
select
    icustay_id
  , charttime
  , sum(amount) as colloid_bolus
from t3
group by t3.icustay_id, t3.charttime
order by icustay_id, charttime
  );",109348,Thread-1,2022-07-18T00:10:04.457977Z
E017,,debug,SQL status: SELECT 12209 in 0.83 seconds,109348,Thread-1,2022-07-18T00:10:05.292120Z
E015,,debug,"Using postgres connection ""model.mimic.colloid_bolus""",109348,Thread-1,2022-07-18T00:10:05.297216Z
E016,,debug,"On model.mimic.colloid_bolus: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.colloid_bolus""} */
alter table ""postgres"".""public"".""colloid_bolus"" rename to ""colloid_bolus__dbt_backup""",109348,Thread-1,2022-07-18T00:10:05.297452Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:05.298402Z
E015,,debug,"Using postgres connection ""model.mimic.colloid_bolus""",109348,Thread-1,2022-07-18T00:10:05.302205Z
E016,,debug,"On model.mimic.colloid_bolus: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.colloid_bolus""} */
alter table ""postgres"".""public"".""colloid_bolus__dbt_tmp"" rename to ""colloid_bolus""",109348,Thread-1,2022-07-18T00:10:05.302739Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:05.304680Z
E018,,debug,On model.mimic.colloid_bolus: COMMIT,109348,Thread-1,2022-07-18T00:10:05.309144Z
E015,,debug,"Using postgres connection ""model.mimic.colloid_bolus""",109348,Thread-1,2022-07-18T00:10:05.309393Z
E016,,debug,On model.mimic.colloid_bolus: COMMIT,109348,Thread-1,2022-07-18T00:10:05.309756Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:05.312303Z
E015,,debug,"Using postgres connection ""model.mimic.colloid_bolus""",109348,Thread-1,2022-07-18T00:10:05.314586Z
E016,,debug,"On model.mimic.colloid_bolus: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.colloid_bolus""} */
drop table if exists ""postgres"".""public"".""colloid_bolus__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:05.314834Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:05.316591Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:05.321402Z
E010,,debug,On model.mimic.colloid_bolus: Close,109348,Thread-1,2022-07-18T00:10:05.322315Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7c4c3ecd-5c14-4600-9281-0e21ba30ba00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3f8a03d3d0>]}",109348,Thread-1,2022-07-18T00:10:05.323485Z
Q012,0,info,12 of 107 OK created table model public.colloid_bolus .......................... [[32mSELECT 12209[0m in 0.88s],109348,Thread-1,2022-07-18T00:10:05.324357Z,table,null,colloid_bolus,fluid_balance/colloid_bolus.sql,2022-07-18T00:10:04.437969,compiling,model,,,
Q024,0.8839113712310791,debug,Finished running node model.mimic.colloid_bolus,109348,Thread-1,2022-07-18T00:10:05.325107Z,table,2022-07-18T00:10:05.324930,colloid_bolus,fluid_balance/colloid_bolus.sql,2022-07-18T00:10:04.437969,success,model,,,
Q023,,debug,Began running node model.mimic.crrt_durations,109348,Thread-1,2022-07-18T00:10:05.325755Z,table,null,crrt_durations,durations/crrt_durations.sql,2022-07-18T00:10:05.325530,started,model,,,
Q033,,info,13 of 107 START table model public.crrt_durations .............................. [RUN],109348,Thread-1,2022-07-18T00:10:05.326497Z,table,null,crrt_durations,durations/crrt_durations.sql,2022-07-18T00:10:05.325530,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.crrt_durations""",109348,Thread-1,2022-07-18T00:10:05.327334Z
Q030,,debug,Began compiling node model.mimic.crrt_durations,109348,Thread-1,2022-07-18T00:10:05.327860Z,table,null,crrt_durations,durations/crrt_durations.sql,2022-07-18T00:10:05.325530,compiling,model,,,
Q027,,debug,Compiling model.mimic.crrt_durations,109348,Thread-1,2022-07-18T00:10:05.328212Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.crrt_durations""",109348,Thread-1,2022-07-18T00:10:05.329851Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:05.330581Z
Q031,,debug,Began executing node model.mimic.crrt_durations,109348,Thread-1,2022-07-18T00:10:05.330978Z,table,null,crrt_durations,durations/crrt_durations.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.crrt_durations""",109348,Thread-1,2022-07-18T00:10:05.343182Z
E015,,debug,"Using postgres connection ""model.mimic.crrt_durations""",109348,Thread-1,2022-07-18T00:10:05.344179Z
E016,,debug,On model.mimic.crrt_durations: BEGIN,109348,Thread-1,2022-07-18T00:10:05.344432Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:05.344732Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:05.352490Z
E015,,debug,"Using postgres connection ""model.mimic.crrt_durations""",109348,Thread-1,2022-07-18T00:10:05.353150Z
E016,,debug,"On model.mimic.crrt_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.crrt_durations""} */


  create  table ""postgres"".""public"".""crrt_durations__dbt_tmp""
  as (
    with crrt_settings as
(
  select ce.icustay_id, ce.charttime
  , max(
      case
        when ce.itemid in
        (
          224149, -- Access Pressure
          224144, -- Blood Flow (ml/min)
          228004, -- Citrate (ACD-A)
          225183, -- Current Goal
          225977, -- Dialysate Fluid
          224154, -- Dialysate Rate
          224151, -- Effluent Pressure
          224150, -- Filter Pressure
          225958, -- Heparin Concentration (units/mL)
          224145, -- Heparin Dose (per hour)
          224191, -- Hourly Patient Fluid Removal
          228005, -- PBP (Prefilter) Replacement Rate
          228006, -- Post Filter Replacement Rate
          225976, -- Replacement Fluid
          224153, -- Replacement Rate
          224152, -- Return Pressure
          226457  -- Ultrafiltrate Output
        ) then 1
      when ce.itemid in
        (
        29,  -- Access mmHg
        173, -- Effluent Press mmHg
        192, -- Filter Pressure mmHg
        624, -- Return Pressure mmHg
        79, -- Blood Flow ml/min
        142, -- Current Goal
        146, -- Dialysate Flow ml/hr
        611, -- Replace Rate ml/hr
        5683 -- Hourly PFR
        ) then 1
      when ce.itemid = 665 and value in ('Active','Clot Increasing','Clots Present','No Clot Present')
         then 1
      when ce.itemid = 147 and value = 'Yes'
         then 1
      else 0 end)
      as RRT
  -- Below indicates that a new instance of CRRT has started
  , max(
    case
      -- System Integrity
      when ce.itemid = 224146 and value in ('New Filter','Reinitiated')
        then 1
      when ce.itemid = 665 and value in ('Initiated')
        then 1
    else 0
   end ) as RRT_start
  -- Below indicates that the current instance of CRRT has ended
  , max(
    case
      -- System Integrity
      when ce.itemid = 224146 and value in ('Discontinued','Recirculating')
        then 1
      -- the only value like DC is ""DC'D"", use like to avoid apostrophe
      when ce.itemid = 665 and (value = 'Clotted' OR value LIKE 'DC%')
        then 1
      -- Reason for CRRT filter change
      when ce.itemid = 225956
        then 1
    else 0
   end ) as RRT_end
  FROM chartevents ce
  where ce.itemid in
  (
    -- MetaVision ITEMIDs
    -- Below require special handling
    224146, -- System Integrity
    225956,  -- Reason for CRRT Filter Change
    -- Below are settings which indicate CRRT is started/continuing
    224149, -- Access Pressure
    224144, -- Blood Flow (ml/min)
    228004, -- Citrate (ACD-A)
    225183, -- Current Goal
    225977, -- Dialysate Fluid
    224154, -- Dialysate Rate
    224151, -- Effluent Pressure
    224150, -- Filter Pressure
    225958, -- Heparin Concentration (units/mL)
    224145, -- Heparin Dose (per hour)
    224191, -- Hourly Patient Fluid Removal
    228005, -- PBP (Prefilter) Replacement Rate
    228006, -- Post Filter Replacement Rate
    225976, -- Replacement Fluid
    224153, -- Replacement Rate
    224152, -- Return Pressure
    226457, -- Ultrafiltrate Output
    -- CareVue ITEMIDs
    -- Below require special handling
    665,  -- System integrity
    147, -- Dialysate Infusing
    612, -- Replace.Fluid Infuse
    -- Below are settings which indicate CRRT is started/continuing
    29,  -- Access mmHg
    173, -- Effluent Press mmHg
    192, -- Filter Pressure mmHg
    624, -- Return Pressure mmHg
    142, -- Current Goal
    79, -- Blood Flow ml/min
    146, -- Dialysate Flow ml/hr
    611, -- Replace Rate ml/hr
    5683 -- Hourly PFR
  )
  and ce.value is not null
  and coalesce(ce.valuenum,1) != 0 -- non-zero rates/values
  group by icustay_id, charttime
)
-- create various lagged variables for future query
, vd_lag AS
(
  select
    icustay_id
    -- this carries over the previous charttime
    , LAG(CHARTTIME, 1) OVER W AS charttime_prev_row
    , charttime
    , RRT
    , RRT_start
    , RRT_end
    , LAG(RRT_end, 1) OVER W AS rrt_ended_prev_row
  FROM crrt_settings
  WINDOW w AS 
  (
    partition by icustay_id, case when RRT=1 or RRT_end=1 then 1 else 0 end
    order by charttime
  )
)
, vd1 as
(
  select
      icustay_id
      , charttime
      , RRT
      , RRT_start
      , RRT_end

      -- now we determine if the current event is a new instantiation
      , case
          when RRT_start = 1
            then 1
        -- if there is an end flag, we mark any subsequent event as new
          when RRT_end = 1
            -- note the end is *not* a new event, the *subsequent* row is
            -- so here we output 0
            then 0
          when rrt_ended_prev_row = 1
            then 1
            -- if there is less than 2 hours between CRRT settings, we do not treat this as a new CRRT event
          when DATETIME_DIFF(charttime, charttime_prev_row, 'HOUR') <= 2
            then 0
        else 1
      end as NewCRRT
  -- use the temp table with only settings FROM chartevents
  FROM vd_lag
)
, vd2 as
(
  select vd1.*
  -- create a cumulative sum of the instances of new CRRT
  -- this results in a monotonically increasing integer assigned to each CRRT
  , case when RRT_start = 1 or RRT=1 or RRT_end = 1 then
      SUM( NewCRRT )
      OVER ( partition by icustay_id order by charttime )
    else null end
    as num
  --- now we convert CHARTTIME of CRRT settings into durations
  from vd1
  -- now we can isolate to just rows with settings
  -- (before we had rows with start/end flags)
  -- this removes any null values for NewCRRT
  where
    RRT_start = 1 or RRT = 1 or RRT_end = 1
)
-- create the durations for each CRRT instance
, fin as
(
select icustay_id
  , num
  , min(charttime) as starttime
  , max(charttime) as endtime
 	, DATETIME_DIFF(max(charttime), min(charttime), 'HOUR') AS duration_hours
  -- add durations
from vd2
group by icustay_id, num
having min(charttime) != max(charttime)
)
select icustay_id
  , ROW_NUMBER() over (partition by icustay_id order by starttime) as num
  , starttime, endtime, duration_hours
from fin
order by icustay_id, num
  );",109348,Thread-1,2022-07-18T00:10:05.353343Z
E017,,debug,SQL status: SELECT 0 in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:05.365147Z
E015,,debug,"Using postgres connection ""model.mimic.crrt_durations""",109348,Thread-1,2022-07-18T00:10:05.370424Z
E016,,debug,"On model.mimic.crrt_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.crrt_durations""} */
alter table ""postgres"".""public"".""crrt_durations"" rename to ""crrt_durations__dbt_backup""",109348,Thread-1,2022-07-18T00:10:05.371098Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:05.372699Z
E015,,debug,"Using postgres connection ""model.mimic.crrt_durations""",109348,Thread-1,2022-07-18T00:10:05.379868Z
E016,,debug,"On model.mimic.crrt_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.crrt_durations""} */
alter table ""postgres"".""public"".""crrt_durations__dbt_tmp"" rename to ""crrt_durations""",109348,Thread-1,2022-07-18T00:10:05.380564Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:05.381173Z
E018,,debug,On model.mimic.crrt_durations: COMMIT,109348,Thread-1,2022-07-18T00:10:05.385639Z
E015,,debug,"Using postgres connection ""model.mimic.crrt_durations""",109348,Thread-1,2022-07-18T00:10:05.386456Z
E016,,debug,On model.mimic.crrt_durations: COMMIT,109348,Thread-1,2022-07-18T00:10:05.387124Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:05.389101Z
E015,,debug,"Using postgres connection ""model.mimic.crrt_durations""",109348,Thread-1,2022-07-18T00:10:05.391575Z
E016,,debug,"On model.mimic.crrt_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.crrt_durations""} */
drop table if exists ""postgres"".""public"".""crrt_durations__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:05.391794Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:05.394012Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:05.397335Z
E010,,debug,On model.mimic.crrt_durations: Close,109348,Thread-1,2022-07-18T00:10:05.397588Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7c4c3ecd-5c14-4600-9281-0e21ba30ba00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3f8c993400>]}",109348,Thread-1,2022-07-18T00:10:05.398423Z
Q012,0,info,13 of 107 OK created table model public.crrt_durations ......................... [[32mSELECT 0[0m in 0.07s],109348,Thread-1,2022-07-18T00:10:05.398908Z,table,null,crrt_durations,durations/crrt_durations.sql,2022-07-18T00:10:05.325530,compiling,model,,,
Q024,0.07129478454589844,debug,Finished running node model.mimic.crrt_durations,109348,Thread-1,2022-07-18T00:10:05.399510Z,table,2022-07-18T00:10:05.399359,crrt_durations,durations/crrt_durations.sql,2022-07-18T00:10:05.325530,success,model,,,
Q023,,debug,Began running node model.mimic.crystalloid_bolus,109348,Thread-1,2022-07-18T00:10:05.400042Z,table,null,crystalloid_bolus,fluid_balance/crystalloid_bolus.sql,2022-07-18T00:10:05.399944,started,model,,,
Q033,,info,14 of 107 START table model public.crystalloid_bolus ........................... [RUN],109348,Thread-1,2022-07-18T00:10:05.400740Z,table,null,crystalloid_bolus,fluid_balance/crystalloid_bolus.sql,2022-07-18T00:10:05.399944,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.crystalloid_bolus""",109348,Thread-1,2022-07-18T00:10:05.401374Z
Q030,,debug,Began compiling node model.mimic.crystalloid_bolus,109348,Thread-1,2022-07-18T00:10:05.401728Z,table,null,crystalloid_bolus,fluid_balance/crystalloid_bolus.sql,2022-07-18T00:10:05.399944,compiling,model,,,
Q027,,debug,Compiling model.mimic.crystalloid_bolus,109348,Thread-1,2022-07-18T00:10:05.402190Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.crystalloid_bolus""",109348,Thread-1,2022-07-18T00:10:05.404971Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:05.406205Z
Q031,,debug,Began executing node model.mimic.crystalloid_bolus,109348,Thread-1,2022-07-18T00:10:05.406571Z,table,null,crystalloid_bolus,fluid_balance/crystalloid_bolus.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.crystalloid_bolus""",109348,Thread-1,2022-07-18T00:10:05.415523Z
E015,,debug,"Using postgres connection ""model.mimic.crystalloid_bolus""",109348,Thread-1,2022-07-18T00:10:05.416201Z
E016,,debug,On model.mimic.crystalloid_bolus: BEGIN,109348,Thread-1,2022-07-18T00:10:05.416571Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:05.416866Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:05.423816Z
E015,,debug,"Using postgres connection ""model.mimic.crystalloid_bolus""",109348,Thread-1,2022-07-18T00:10:05.424118Z
E016,,debug,"On model.mimic.crystalloid_bolus: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.crystalloid_bolus""} */


  create  table ""postgres"".""public"".""crystalloid_bolus__dbt_tmp""
  as (
    with t1 as
(
  select
    mv.icustay_id
  , mv.starttime as charttime
  -- standardize the units to millilitres
  -- also metavision has floating point precision.. but we only care down to the mL
  , round(case
      when mv.amountuom = 'L'
        then mv.amount * 1000.0
      when mv.amountuom = 'ml'
        then mv.amount
    else null end) as amount
  from inputevents_mv mv
  where mv.itemid in
  (
    -- 225943 Solution
    225158, -- NaCl 0.9%
    225828, -- LR
    225944, -- Sterile Water
    225797, -- Free Water
	  225159, -- NaCl 0.45%
	  -- 225161, -- NaCl 3% (Hypertonic Saline)
	  225823, -- D5 1/2NS
	  225825, -- D5NS
	  225827, -- D5LR
	  225941, -- D5 1/4NS
	  226089 -- Piggyback
  )
  and mv.statusdescription != 'Rewritten'
  and
  -- in MetaVision, these ITEMIDs appear with a null rate IFF endtime=starttime + 1 minute
  -- so it is sufficient to:
  --    (1) check the rate is > 240 if it exists or
  --    (2) ensure the rate is null and amount > 240 ml
    (
      (mv.rate is not null and mv.rateuom = 'mL/hour' and mv.rate > 248)
      OR (mv.rate is not null and mv.rateuom = 'mL/min' and mv.rate > (248/60.0))
      OR (mv.rate is null and mv.amountuom = 'L' and mv.amount > 0.248)
      OR (mv.rate is null and mv.amountuom = 'ml' and mv.amount > 248)
    )
)
, t2 as
(
  select
    cv.icustay_id
  , cv.charttime
  -- carevue always has units in millilitres
  , round(cv.amount) as amount
  from inputevents_cv cv
  where cv.itemid in
  (
    30015 -- ""D5/.45NS"" -- mixed colloids and crystalloids
  , 30018 --	.9% Normal Saline
  , 30020 -- .45% Normal Saline
  , 30021 --	Lactated Ringers
  , 30058 --	Free Water Bolus
  , 30060 -- D5NS
  , 30061 -- D5RL
  , 30063 --	IV Piggyback
  , 30065 --	Sterile Water
  -- , 30143 -- 3% Normal Saline
  , 30159 -- D5 Ringers Lact.
  , 30160 -- D5 Normal Saline
  , 30169 --	Sterile H20_GU
  , 30190 -- NS .9%
  , 40850 --	ns bolus
  , 41491 --	fluid bolus
  , 42639 --	bolus
  , 42187 --	free h20
  , 43819 --	1:1 NS Repletion.
  , 41430 --	free water boluses
  , 40712 --	free H20
  , 44160 --	BOLUS
  , 42383 --	cc for cc replace
  , 42297 --	Fluid bolus
  , 42453 --	Fluid Bolus
  , 40872 --	free water
  , 41915 --	FREE WATER
  , 41490 --	NS bolus
  , 46501 --	H2O Bolus
  , 45045 --	WaterBolus
  , 41984 --	FREE H20
  , 41371 --	ns fluid bolus
  , 41582 --	free h20 bolus
  , 41322 --	rl bolus
  , 40778 --	Free H2O
  , 41896 --	ivf boluses
  , 41428 --	ns .9% bolus
  , 43936 --	FREE WATER BOLUSES
  , 44200 --	FLUID BOLUS
  , 41619 --	frfee water boluses
  , 40424 --	free H2O
  , 41457 --	Free H20 intake
  , 41581 --	Water bolus
  , 42844 --	NS fluid bolus
  , 42429 --	Free water
  , 41356 --	IV Bolus
  , 40532 --	FREE H2O
  , 42548 --	NS Bolus
  , 44184 --	LR Bolus
  , 44521 --	LR bolus
  , 44741 --	NS FLUID BOLUS
  , 44126 --	fl bolus
  , 44110 --	RL BOLUS
  , 44633 --	ns boluses
  , 44983 --	Bolus NS
  , 44815 --	LR BOLUS
  , 43986 --	iv bolus
  , 45079 --	500 cc ns bolus
  , 46781 --	lr bolus
  , 45155 --	ns cc/cc replacement
  , 43909 --	H20 BOlus
  , 41467 --	NS IV bolus
  , 44367 --	LR
  , 41743 --	water bolus
  , 40423 --	Bolus
  , 44263 --	fluid bolus ns
  , 42749 --	fluid bolus NS
  , 45480 --	500cc ns bolus
  , 44491 --	.9NS bolus
  , 41695 --	NS fluid boluses
  , 46169 --	free water bolus.
  , 41580 --	free h2o bolus
  , 41392 --	ns b
  , 45989 --	NS Fluid Bolus
  , 45137 --	NS cc/cc
  , 45154 --	Free H20 bolus
  , 44053 --	normal saline bolus
  , 41416 --	free h2o boluses
  , 44761 --	Free H20
  , 41237 --	ns fluid boluses
  , 44426 --	bolus ns
  , 43975 --	FREE H20 BOLUSES
  , 44894 --	N/s 500 ml bolus
  , 41380 --	nsbolus
  , 42671 --	free h2o
  )
  and cv.amount > 248
  and cv.amount <= 2000
  and cv.amountuom = 'ml'
)
select
    icustay_id
  , charttime
  , sum(amount) as crystalloid_bolus
from t1
-- just because the rate was high enough, does *not* mean the final amount was
where amount > 248
group by t1.icustay_id, t1.charttime
UNION
select
    icustay_id
  , charttime
  , sum(amount) as crystalloid_bolus
from t2
group by t2.icustay_id, t2.charttime
order by icustay_id, charttime
  );",109348,Thread-1,2022-07-18T00:10:05.424277Z
E017,,debug,SQL status: SELECT 155976 in 4.2 seconds,109348,Thread-1,2022-07-18T00:10:09.627051Z
E015,,debug,"Using postgres connection ""model.mimic.crystalloid_bolus""",109348,Thread-1,2022-07-18T00:10:09.634178Z
E016,,debug,"On model.mimic.crystalloid_bolus: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.crystalloid_bolus""} */
alter table ""postgres"".""public"".""crystalloid_bolus"" rename to ""crystalloid_bolus__dbt_backup""",109348,Thread-1,2022-07-18T00:10:09.634492Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:09.635886Z
E015,,debug,"Using postgres connection ""model.mimic.crystalloid_bolus""",109348,Thread-1,2022-07-18T00:10:09.640454Z
E016,,debug,"On model.mimic.crystalloid_bolus: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.crystalloid_bolus""} */
alter table ""postgres"".""public"".""crystalloid_bolus__dbt_tmp"" rename to ""crystalloid_bolus""",109348,Thread-1,2022-07-18T00:10:09.640683Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:09.641410Z
E018,,debug,On model.mimic.crystalloid_bolus: COMMIT,109348,Thread-1,2022-07-18T00:10:09.644326Z
E015,,debug,"Using postgres connection ""model.mimic.crystalloid_bolus""",109348,Thread-1,2022-07-18T00:10:09.644532Z
E016,,debug,On model.mimic.crystalloid_bolus: COMMIT,109348,Thread-1,2022-07-18T00:10:09.644786Z
E017,,debug,SQL status: COMMIT in 0.02 seconds,109348,Thread-1,2022-07-18T00:10:09.660078Z
E015,,debug,"Using postgres connection ""model.mimic.crystalloid_bolus""",109348,Thread-1,2022-07-18T00:10:09.662959Z
E016,,debug,"On model.mimic.crystalloid_bolus: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.crystalloid_bolus""} */
drop table if exists ""postgres"".""public"".""crystalloid_bolus__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:09.663202Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:09.667352Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:09.670307Z
E010,,debug,On model.mimic.crystalloid_bolus: Close,109348,Thread-1,2022-07-18T00:10:09.670571Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7c4c3ecd-5c14-4600-9281-0e21ba30ba00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3f887ba4c0>]}",109348,Thread-1,2022-07-18T00:10:09.671356Z
Q012,4,info,14 of 107 OK created table model public.crystalloid_bolus ...................... [[32mSELECT 155976[0m in 4.27s],109348,Thread-1,2022-07-18T00:10:09.671871Z,table,null,crystalloid_bolus,fluid_balance/crystalloid_bolus.sql,2022-07-18T00:10:05.399944,compiling,model,,,
Q024,4.270107984542847,debug,Finished running node model.mimic.crystalloid_bolus,109348,Thread-1,2022-07-18T00:10:09.672490Z,table,2022-07-18T00:10:09.672336,crystalloid_bolus,fluid_balance/crystalloid_bolus.sql,2022-07-18T00:10:05.399944,success,model,,,
Q023,,debug,Began running node model.mimic.dobutamine_dose,109348,Thread-1,2022-07-18T00:10:09.672951Z,table,null,dobutamine_dose,durations/dobutamine_dose.sql,2022-07-18T00:10:09.672888,started,model,,,
Q033,,info,15 of 107 START table model public.dobutamine_dose ............................. [RUN],109348,Thread-1,2022-07-18T00:10:09.673779Z,table,null,dobutamine_dose,durations/dobutamine_dose.sql,2022-07-18T00:10:09.672888,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.dobutamine_dose""",109348,Thread-1,2022-07-18T00:10:09.674594Z
Q030,,debug,Began compiling node model.mimic.dobutamine_dose,109348,Thread-1,2022-07-18T00:10:09.675227Z,table,null,dobutamine_dose,durations/dobutamine_dose.sql,2022-07-18T00:10:09.672888,compiling,model,,,
Q027,,debug,Compiling model.mimic.dobutamine_dose,109348,Thread-1,2022-07-18T00:10:09.675637Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.dobutamine_dose""",109348,Thread-1,2022-07-18T00:10:09.677312Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:09.678416Z
Q031,,debug,Began executing node model.mimic.dobutamine_dose,109348,Thread-1,2022-07-18T00:10:09.678789Z,table,null,dobutamine_dose,durations/dobutamine_dose.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.dobutamine_dose""",109348,Thread-1,2022-07-18T00:10:09.694695Z
E015,,debug,"Using postgres connection ""model.mimic.dobutamine_dose""",109348,Thread-1,2022-07-18T00:10:09.695663Z
E016,,debug,On model.mimic.dobutamine_dose: BEGIN,109348,Thread-1,2022-07-18T00:10:09.695993Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:09.696267Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:09.707723Z
E015,,debug,"Using postgres connection ""model.mimic.dobutamine_dose""",109348,Thread-1,2022-07-18T00:10:09.708217Z
E016,,debug,"On model.mimic.dobutamine_dose: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.dobutamine_dose""} */


  create  table ""postgres"".""public"".""dobutamine_dose__dbt_tmp""
  as (
    -- This query extracts dose+durations of dopamine administration

-- Get drug administration data from CareVue first
with vasocv1 as
(
    select
    icustay_id, charttime
    -- case statement determining whether the ITEMID is an instance of vasopressor usage
    , max(case when itemid in (30042,30306) then 1 else 0 end) as vaso -- dobutamine

    -- the 'stopped' column indicates if a vasopressor has been disconnected
    , max(case when itemid in (30042,30306) and (stopped = 'Stopped' OR stopped like 'D/C%') then 1
          else 0 end) as vaso_stopped

    , max(case when itemid in (30042,30306) and rate is not null then 1 else 0 end) as vaso_null
    , max(case when itemid in (30042,30306) then rate else null end) as vaso_rate
    , max(case when itemid in (30042,30306) then amount else null end) as vaso_amount

  FROM inputevents_cv
  where itemid in (30042,30306) -- dobutamine
  group by icustay_id, charttime
)
, vasocv2 as
(
  select v.*
    , sum(vaso_null) over (partition by icustay_id order by charttime) as vaso_partition
  from
    vasocv1 v
)
, vasocv3 as
(
  select v.*
    , first_value(vaso_rate) over (partition by icustay_id, vaso_partition order by charttime) as vaso_prevrate_ifnull
  from
    vasocv2 v
)
, vasocv4 as
(
select
    icustay_id
    , charttime
    -- , (CHARTTIME - (LAG(CHARTTIME, 1) OVER (partition by icustay_id, vaso order by charttime))) AS delta

    , vaso
    , vaso_rate
    , vaso_amount
    , vaso_stopped
    , vaso_prevrate_ifnull

    -- We define start time here
    , case
        when vaso = 0 then null

        -- if this is the first instance of the vasoactive drug
        when vaso_rate > 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso, vaso_null
          order by charttime
          )
          is null
          then 1

        -- you often get a string of 0s
        -- we decide not to set these as 1, just because it makes vasonum sequential
        when vaso_rate = 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 0
          then 0

        -- sometimes you get a string of NULL, associated with 0 volumes
        -- same reason as before, we decide not to set these as 1
        -- vaso_prevrate_ifnull is equal to the previous value *iff* the current value is null
        when vaso_prevrate_ifnull = 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 0
          then 0

        -- If the last recorded rate was 0, newvaso = 1
        when LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          ) = 0
          then 1

        -- If the last recorded vaso was D/C'd, newvaso = 1
        when
          LAG(vaso_stopped,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 1 then 1

        -- ** not sure if the below is needed
        --when (CHARTTIME - (LAG(CHARTTIME, 1) OVER (partition by icustay_id, vaso order by charttime))) > (interval '4 hours') then 1
      else null
      end as vaso_start

FROM
  vasocv3
)
-- propagate start/stop flags forward in time
, vasocv5 as
(
  select v.*
    , SUM(vaso_start) OVER (partition by icustay_id, vaso order by charttime) as vaso_first
FROM
  vasocv4 v
)
, vasocv6 as
(
  select v.*
    -- We define end time here
    , case
        when vaso = 0
          then null

        -- If the recorded vaso was D/C'd, this is an end time
        when vaso_stopped = 1
          then vaso_first

        -- If the rate is zero, this is the end time
        when vaso_rate = 0
          then vaso_first

        -- the last row in the table is always a potential end time
        -- this captures patients who die/are discharged while on vasopressors
        -- in principle, this could add an extra end time for the vasopressor
        -- however, since we later group on vaso_start, any extra end times are ignored
        when LEAD(CHARTTIME,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          ) is null
          then vaso_first

        else null
        end as vaso_stop
    from vasocv5 v
)

-- -- if you want to look at the results of the table before grouping:
-- select
--   icustay_id, charttime, vaso, vaso_rate, vaso_amount
--     , vaso_stopped
--     , vaso_start
--     , vaso_first
--     , vaso_stop
-- from vasocv6 order by icustay_id, charttime

, vasocv7 as
(
select
  icustay_id
  , charttime as starttime
  , lead(charttime) OVER (partition by icustay_id, vaso_first order by charttime) as endtime
  , vaso, vaso_rate, vaso_amount, vaso_stop, vaso_start, vaso_first
from vasocv6
where
  vaso_first is not null -- bogus data
and
  vaso_first != 0 -- sometimes *only* a rate of 0 appears, i.e. the drug is never actually delivered
and
  icustay_id is not null -- there are data for ""floating"" admissions, we don't worry about these
)
-- table of start/stop times for event
, vasocv8 as
(
  select
    icustay_id
    , starttime, endtime
    , vaso, vaso_rate, vaso_amount, vaso_stop, vaso_start, vaso_first
  from vasocv7
  where endtime is not null
  and vaso_rate > 0
  and starttime != endtime
)
-- collapse these start/stop times down if the rate doesn't change
, vasocv9 as
(
  select
    icustay_id
    , starttime, endtime
    , case
        when LAG(endtime) OVER (partition by icustay_id order by starttime, endtime) = starttime
        AND  LAG(vaso_rate) OVER (partition by icustay_id order by starttime, endtime) = vaso_rate
        THEN 0
      else 1
    end as vaso_groups
    , vaso, vaso_rate, vaso_amount, vaso_stop, vaso_start, vaso_first
  from vasocv8
  where endtime is not null
  and vaso_rate > 0
  and starttime != endtime
)
, vasocv10 as
(
  select
    icustay_id
    , starttime, endtime
    , vaso_groups
    , SUM(vaso_groups) OVER (partition by icustay_id order by starttime, endtime) as vaso_groups_sum
    , vaso, vaso_rate, vaso_amount, vaso_stop, vaso_start, vaso_first
  from vasocv9
)
, vasocv as
(
  select icustay_id
  , min(starttime) as starttime
  , max(endtime) as endtime
  , vaso_groups_sum
  , vaso_rate
  , sum(vaso_amount) as vaso_amount
  from vasocv10
  group by icustay_id, vaso_groups_sum, vaso_rate
)
-- now we extract the associated data for metavision patients
, vasomv as
(
  select
    icustay_id, linkorderid
    , rate as vaso_rate
    , amount as vaso_amount
    , starttime
    , endtime
  from inputevents_mv
  where itemid = 221653 -- dobutamine
  and statusdescription != 'Rewritten' -- only valid orders
)
-- now assign this data to every hour of the patient's stay
-- vaso_amount for carevue is not accurate
SELECT icustay_id
  , starttime, endtime
  , vaso_rate, vaso_amount
from vasocv
UNION ALL
SELECT icustay_id
  , starttime, endtime
  , vaso_rate, vaso_amount
from vasomv
order by icustay_id, starttime
  );",109348,Thread-1,2022-07-18T00:10:09.708459Z
E017,,debug,SQL status: SELECT 6548 in 5.13 seconds,109348,Thread-1,2022-07-18T00:10:14.841529Z
E015,,debug,"Using postgres connection ""model.mimic.dobutamine_dose""",109348,Thread-1,2022-07-18T00:10:14.848853Z
E016,,debug,"On model.mimic.dobutamine_dose: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.dobutamine_dose""} */
alter table ""postgres"".""public"".""dobutamine_dose"" rename to ""dobutamine_dose__dbt_backup""",109348,Thread-1,2022-07-18T00:10:14.849312Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:14.851098Z
E015,,debug,"Using postgres connection ""model.mimic.dobutamine_dose""",109348,Thread-1,2022-07-18T00:10:14.855104Z
E016,,debug,"On model.mimic.dobutamine_dose: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.dobutamine_dose""} */
alter table ""postgres"".""public"".""dobutamine_dose__dbt_tmp"" rename to ""dobutamine_dose""",109348,Thread-1,2022-07-18T00:10:14.855341Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:14.856075Z
E018,,debug,On model.mimic.dobutamine_dose: COMMIT,109348,Thread-1,2022-07-18T00:10:14.859339Z
E015,,debug,"Using postgres connection ""model.mimic.dobutamine_dose""",109348,Thread-1,2022-07-18T00:10:14.859581Z
E016,,debug,On model.mimic.dobutamine_dose: COMMIT,109348,Thread-1,2022-07-18T00:10:14.859797Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:14.861502Z
E015,,debug,"Using postgres connection ""model.mimic.dobutamine_dose""",109348,Thread-1,2022-07-18T00:10:14.863419Z
E016,,debug,"On model.mimic.dobutamine_dose: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.dobutamine_dose""} */
drop table if exists ""postgres"".""public"".""dobutamine_dose__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:14.863632Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:14.866262Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:14.869272Z
E010,,debug,On model.mimic.dobutamine_dose: Close,109348,Thread-1,2022-07-18T00:10:14.869510Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7c4c3ecd-5c14-4600-9281-0e21ba30ba00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3f8a03d790>]}",109348,Thread-1,2022-07-18T00:10:14.870365Z
Q012,5,info,15 of 107 OK created table model public.dobutamine_dose ........................ [[32mSELECT 6548[0m in 5.20s],109348,Thread-1,2022-07-18T00:10:14.870857Z,table,null,dobutamine_dose,durations/dobutamine_dose.sql,2022-07-18T00:10:09.672888,compiling,model,,,
Q024,5.195987224578857,debug,Finished running node model.mimic.dobutamine_dose,109348,Thread-1,2022-07-18T00:10:14.871477Z,table,2022-07-18T00:10:14.871309,dobutamine_dose,durations/dobutamine_dose.sql,2022-07-18T00:10:09.672888,success,model,,,
Q023,,debug,Began running node model.mimic.dobutamine_durations,109348,Thread-1,2022-07-18T00:10:14.872057Z,table,null,dobutamine_durations,durations/dobutamine_durations.sql,2022-07-18T00:10:14.871982,started,model,,,
Q033,,info,16 of 107 START table model public.dobutamine_durations ........................ [RUN],109348,Thread-1,2022-07-18T00:10:14.872891Z,table,null,dobutamine_durations,durations/dobutamine_durations.sql,2022-07-18T00:10:14.871982,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.dobutamine_durations""",109348,Thread-1,2022-07-18T00:10:14.873761Z
Q030,,debug,Began compiling node model.mimic.dobutamine_durations,109348,Thread-1,2022-07-18T00:10:14.874445Z,table,null,dobutamine_durations,durations/dobutamine_durations.sql,2022-07-18T00:10:14.871982,compiling,model,,,
Q027,,debug,Compiling model.mimic.dobutamine_durations,109348,Thread-1,2022-07-18T00:10:14.874832Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.dobutamine_durations""",109348,Thread-1,2022-07-18T00:10:14.876623Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:14.877545Z
Q031,,debug,Began executing node model.mimic.dobutamine_durations,109348,Thread-1,2022-07-18T00:10:14.878254Z,table,null,dobutamine_durations,durations/dobutamine_durations.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.dobutamine_durations""",109348,Thread-1,2022-07-18T00:10:14.895250Z
E015,,debug,"Using postgres connection ""model.mimic.dobutamine_durations""",109348,Thread-1,2022-07-18T00:10:14.896331Z
E016,,debug,On model.mimic.dobutamine_durations: BEGIN,109348,Thread-1,2022-07-18T00:10:14.896703Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:14.897038Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:14.905210Z
E015,,debug,"Using postgres connection ""model.mimic.dobutamine_durations""",109348,Thread-1,2022-07-18T00:10:14.906343Z
E016,,debug,"On model.mimic.dobutamine_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.dobutamine_durations""} */


  create  table ""postgres"".""public"".""dobutamine_durations__dbt_tmp""
  as (
    -- This query extracts durations of dobutamine administration
-- Consecutive administrations are numbered 1, 2, ...
-- Total time on the drug can be calculated from this table by grouping using ICUSTAY_ID
-- Get drug administration data from CareVue first
with vasocv1 as (
  select
    icustay_id,
    charttime -- case statement determining whether the ITEMID is an instance of vasopressor usage
,
    max(
      case
        when itemid in (30042, 30306) then 1
        else 0
      end
    ) as vaso -- dobutamine
    -- the 'stopped' column indicates if a vasopressor has been disconnected
,
    max(
      case
        when itemid in (30042, 30306)
        and (
          stopped = 'Stopped'
          OR stopped like 'D/C%'
        ) then 1
        else 0
      end
    ) as vaso_stopped,
    max(
      case
        when itemid in (30042, 30306)
        and rate is not null then 1
        else 0
      end
    ) as vaso_null,
    max(
      case
        when itemid in (30042, 30306) then rate
        else null
      end
    ) as vaso_rate,
    max(
      case
        when itemid in (30042, 30306) then amount
        else null
      end
    ) as vaso_amount
  FROM
    inputevents_cv
  where
    itemid in (30042, 30306) -- dobutamine
  group by
    icustay_id,
    charttime
),
vasocv2 as (
  select
    v.*,
    sum(vaso_null) over (
      partition by icustay_id
      order by
        charttime
    ) as vaso_partition
  from
    vasocv1 v
),
vasocv3 as (
  select
    v.*,
    first_value(vaso_rate) over (
      partition by icustay_id,
      vaso_partition
      order by
        charttime
    ) as vaso_prevrate_ifnull
  from
    vasocv2 v
),
vasocv4 as (
  select
    icustay_id,
    charttime -- , (CHARTTIME - (LAG(CHARTTIME, 1) OVER (partition by icustay_id, vaso order by charttime))) AS delta
,
    vaso,
    vaso_rate,
    vaso_amount,
    vaso_stopped,
    vaso_prevrate_ifnull -- We define start time here
,
    case
      when vaso = 0 then null -- if this is the first instance of the vasoactive drug
      when vaso_rate > 0
      and LAG(vaso_prevrate_ifnull, 1) OVER (
        partition by icustay_id,
        vaso,
        vaso_null
        order by
          charttime
      ) is null then 1 -- you often get a string of 0s
      -- we decide not to set these as 1, just because it makes vasonum sequential
      when vaso_rate = 0
      and LAG(vaso_prevrate_ifnull, 1) OVER (
        partition by icustay_id,
        vaso
        order by
          charttime
      ) = 0 then 0 -- sometimes you get a string of NULL, associated with 0 volumes
      -- same reason as before, we decide not to set these as 1
      -- vaso_prevrate_ifnull is equal to the previous value *iff* the current value is null
      when vaso_prevrate_ifnull = 0
      and LAG(vaso_prevrate_ifnull, 1) OVER (
        partition by icustay_id,
        vaso
        order by
          charttime
      ) = 0 then 0 -- If the last recorded rate was 0, newvaso = 1
      when LAG(vaso_prevrate_ifnull, 1) OVER (
        partition by icustay_id,
        vaso
        order by
          charttime
      ) = 0 then 1 -- If the last recorded vaso was D/C'd, newvaso = 1
      when LAG(vaso_stopped, 1) OVER (
        partition by icustay_id,
        vaso
        order by
          charttime
      ) = 1 then 1 -- ** not sure if the below is needed
      --when (CHARTTIME - (LAG(CHARTTIME, 1) OVER (partition by icustay_id, vaso order by charttime))) > (interval '4 hours') then 1
      else null
    end as vaso_start
  FROM
    vasocv3
) -- propagate start/stop flags forward in time
,
vasocv5 as (
  select
    v.*,
    SUM(vaso_start) OVER (
      partition by icustay_id,
      vaso
      order by
        charttime
    ) as vaso_first
  FROM
    vasocv4 v
),
vasocv6 as (
  select
    v.* -- We define end time here
,
    case
      when vaso = 0 then null -- If the recorded vaso was D/C'd, this is an end time
      when vaso_stopped = 1 then vaso_first -- If the rate is zero, this is the end time
      when vaso_rate = 0 then vaso_first -- the last row in the table is always a potential end time
      -- this captures patients who die/are discharged while on vasopressors
      -- in principle, this could add an extra end time for the vasopressor
      -- however, since we later group on vaso_start, any extra end times are ignored
      when LEAD(CHARTTIME, 1) OVER (
        partition by icustay_id,
        vaso
        order by
          charttime
      ) is null then vaso_first
      else null
    end as vaso_stop
  from
    vasocv5 v
) -- -- if you want to look at the results of the table before grouping:
-- select
--   icustay_id, charttime, vaso, vaso_rate, vaso_amount
--     , case when vaso_stopped = 1 then 'Y' else '' end as stopped
--     , vaso_start
--     , vaso_first
--     , vaso_stop
-- from vasocv6 order by charttime
,
vasocv as (
  -- below groups together vasopressor administrations into groups
  select
    icustay_id -- the first non-null rate is considered the starttime
,
    min(
      case
        when vaso_rate is not null then charttime
        else null
      end
    ) as starttime -- the *first* time the first/last flags agree is the stop time for this duration
,
    min(
      case
        when vaso_first = vaso_stop then charttime
        else null
      end
    ) as endtime
  from
    vasocv6
  where
    vaso_first is not null -- bogus data
    and vaso_first != 0 -- sometimes *only* a rate of 0 appears, i.e. the drug is never actually delivered
    and icustay_id is not null -- there are data for ""floating"" admissions, we don't worry about these
  group by
    icustay_id,
    vaso_first
  having
    -- ensure start time is not the same as end time
    min(charttime) != min(
      case
        when vaso_first = vaso_stop then charttime
        else null
      end
    )
    and max(vaso_rate) > 0 -- if the rate was always 0 or null, we consider it not a real drug delivery
) -- now we extract the associated data for metavision patients
,
vasomv as (
  select
    icustay_id,
    linkorderid,
    min(starttime) as starttime,
    max(endtime) as endtime
  FROM
    inputevents_mv
  where
    itemid = 221653 -- dobutamine
    and statusdescription != 'Rewritten' -- only valid orders
  group by
    icustay_id,
    linkorderid
)
select
  icustay_id -- generate a sequential integer for convenience
,
  ROW_NUMBER() over (
    partition by icustay_id
    order by
      starttime
  ) as vasonum,
  starttime,
  endtime,
  DATETIME_DIFF(endtime, starttime, 'HOUR') AS duration_hours -- add durations
from
  vasocv
UNION
ALL
select
  icustay_id,
  ROW_NUMBER() over (
    partition by icustay_id
    order by
      starttime
  ) as vasonum,
  starttime,
  endtime,
  DATETIME_DIFF(endtime, starttime, 'HOUR') AS duration_hours -- add durations
from
  vasomv
order by
  icustay_id,
  vasonum
  );",109348,Thread-1,2022-07-18T00:10:14.906990Z
E017,,debug,SQL status: SELECT 1792 in 0.41 seconds,109348,Thread-1,2022-07-18T00:10:15.322337Z
E015,,debug,"Using postgres connection ""model.mimic.dobutamine_durations""",109348,Thread-1,2022-07-18T00:10:15.328814Z
E016,,debug,"On model.mimic.dobutamine_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.dobutamine_durations""} */
alter table ""postgres"".""public"".""dobutamine_durations"" rename to ""dobutamine_durations__dbt_backup""",109348,Thread-1,2022-07-18T00:10:15.329272Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:15.330554Z
E015,,debug,"Using postgres connection ""model.mimic.dobutamine_durations""",109348,Thread-1,2022-07-18T00:10:15.336056Z
E016,,debug,"On model.mimic.dobutamine_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.dobutamine_durations""} */
alter table ""postgres"".""public"".""dobutamine_durations__dbt_tmp"" rename to ""dobutamine_durations""",109348,Thread-1,2022-07-18T00:10:15.336278Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:15.337036Z
E018,,debug,On model.mimic.dobutamine_durations: COMMIT,109348,Thread-1,2022-07-18T00:10:15.340261Z
E015,,debug,"Using postgres connection ""model.mimic.dobutamine_durations""",109348,Thread-1,2022-07-18T00:10:15.340494Z
E016,,debug,On model.mimic.dobutamine_durations: COMMIT,109348,Thread-1,2022-07-18T00:10:15.340722Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:15.341851Z
E015,,debug,"Using postgres connection ""model.mimic.dobutamine_durations""",109348,Thread-1,2022-07-18T00:10:15.343952Z
E016,,debug,"On model.mimic.dobutamine_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.dobutamine_durations""} */
drop table if exists ""postgres"".""public"".""dobutamine_durations__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:15.344189Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:15.347032Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:15.350370Z
E010,,debug,On model.mimic.dobutamine_durations: Close,109348,Thread-1,2022-07-18T00:10:15.350635Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7c4c3ecd-5c14-4600-9281-0e21ba30ba00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3f88743370>]}",109348,Thread-1,2022-07-18T00:10:15.351421Z
Q012,0,info,16 of 107 OK created table model public.dobutamine_durations ................... [[32mSELECT 1792[0m in 0.48s],109348,Thread-1,2022-07-18T00:10:15.351940Z,table,null,dobutamine_durations,durations/dobutamine_durations.sql,2022-07-18T00:10:14.871982,compiling,model,,,
Q024,0.47795581817626953,debug,Finished running node model.mimic.dobutamine_durations,109348,Thread-1,2022-07-18T00:10:15.352630Z,table,2022-07-18T00:10:15.352396,dobutamine_durations,durations/dobutamine_durations.sql,2022-07-18T00:10:14.871982,success,model,,,
Q023,,debug,Began running node model.mimic.dopamine_dose,109348,Thread-1,2022-07-18T00:10:15.353173Z,table,null,dopamine_dose,durations/dopamine_dose.sql,2022-07-18T00:10:15.353085,started,model,,,
Q033,,info,17 of 107 START table model public.dopamine_dose ............................... [RUN],109348,Thread-1,2022-07-18T00:10:15.353971Z,table,null,dopamine_dose,durations/dopamine_dose.sql,2022-07-18T00:10:15.353085,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.dopamine_dose""",109348,Thread-1,2022-07-18T00:10:15.354924Z
Q030,,debug,Began compiling node model.mimic.dopamine_dose,109348,Thread-1,2022-07-18T00:10:15.355446Z,table,null,dopamine_dose,durations/dopamine_dose.sql,2022-07-18T00:10:15.353085,compiling,model,,,
Q027,,debug,Compiling model.mimic.dopamine_dose,109348,Thread-1,2022-07-18T00:10:15.355773Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.dopamine_dose""",109348,Thread-1,2022-07-18T00:10:15.357359Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:15.358502Z
Q031,,debug,Began executing node model.mimic.dopamine_dose,109348,Thread-1,2022-07-18T00:10:15.358809Z,table,null,dopamine_dose,durations/dopamine_dose.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.dopamine_dose""",109348,Thread-1,2022-07-18T00:10:15.369097Z
E015,,debug,"Using postgres connection ""model.mimic.dopamine_dose""",109348,Thread-1,2022-07-18T00:10:15.370533Z
E016,,debug,On model.mimic.dopamine_dose: BEGIN,109348,Thread-1,2022-07-18T00:10:15.370935Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:15.371323Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:15.376378Z
E015,,debug,"Using postgres connection ""model.mimic.dopamine_dose""",109348,Thread-1,2022-07-18T00:10:15.376637Z
E016,,debug,"On model.mimic.dopamine_dose: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.dopamine_dose""} */


  create  table ""postgres"".""public"".""dopamine_dose__dbt_tmp""
  as (
    -- This query extracts dose+durations of dopamine administration

-- Get drug administration data from CareVue first
with vasocv1 as
(
  select
    icustay_id, charttime
    -- case statement determining whether the ITEMID is an instance of vasopressor usage
    , max(case when itemid in (30043,30307) then 1 else 0 end) as vaso -- dopamine

    -- the 'stopped' column indicates if a vasopressor has been disconnected
    , max(case when itemid in (30043,30307) and (stopped = 'Stopped' OR stopped like 'D/C%') then 1
          else 0 end) as vaso_stopped

    , max(case when itemid in (30043,30307) and rate is not null then 1 else 0 end) as vaso_null
    , max(case when itemid in (30043,30307) then rate else null end) as vaso_rate
    , max(case when itemid in (30043,30307) then amount else null end) as vaso_amount

  FROM inputevents_cv
  where itemid in
  (
        30043,30307 -- dopamine
  )
  group by icustay_id, charttime
)
, vasocv2 as
(
  select v.*
    , sum(vaso_null) over (partition by icustay_id order by charttime) as vaso_partition
  from
    vasocv1 v
)
, vasocv3 as
(
  select v.*
    , first_value(vaso_rate) over (partition by icustay_id, vaso_partition order by charttime) as vaso_prevrate_ifnull
  from
    vasocv2 v
)
, vasocv4 as
(
select
    icustay_id
    , charttime
    -- , (CHARTTIME - (LAG(CHARTTIME, 1) OVER (partition by icustay_id, vaso order by charttime))) AS delta

    , vaso
    , vaso_rate
    , vaso_amount
    , vaso_stopped
    , vaso_prevrate_ifnull

    -- We define start time here
    , case
        when vaso = 0 then null

        -- if this is the first instance of the vasoactive drug
        when vaso_rate > 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso, vaso_null
          order by charttime
          )
          is null
          then 1

        -- you often get a string of 0s
        -- we decide not to set these as 1, just because it makes vasonum sequential
        when vaso_rate = 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 0
          then 0

        -- sometimes you get a string of NULL, associated with 0 volumes
        -- same reason as before, we decide not to set these as 1
        -- vaso_prevrate_ifnull is equal to the previous value *iff* the current value is null
        when vaso_prevrate_ifnull = 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 0
          then 0

        -- If the last recorded rate was 0, newvaso = 1
        when LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          ) = 0
          then 1

        -- If the last recorded vaso was D/C'd, newvaso = 1
        when
          LAG(vaso_stopped,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 1 then 1

        -- ** not sure if the below is needed
        --when (CHARTTIME - (LAG(CHARTTIME, 1) OVER (partition by icustay_id, vaso order by charttime))) > (interval '4 hours') then 1
      else null
      end as vaso_start

FROM
  vasocv3
)
-- propagate start/stop flags forward in time
, vasocv5 as
(
  select v.*
    , SUM(vaso_start) OVER (partition by icustay_id, vaso order by charttime) as vaso_first
FROM
  vasocv4 v
)
, vasocv6 as
(
  select v.*
    -- We define end time here
    , case
        when vaso = 0
          then null

        -- If the recorded vaso was D/C'd, this is an end time
        when vaso_stopped = 1
          then vaso_first

        -- If the rate is zero, this is the end time
        when vaso_rate = 0
          then vaso_first

        -- the last row in the table is always a potential end time
        -- this captures patients who die/are discharged while on vasopressors
        -- in principle, this could add an extra end time for the vasopressor
        -- however, since we later group on vaso_start, any extra end times are ignored
        when LEAD(CHARTTIME,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          ) is null
          then vaso_first

        else null
        end as vaso_stop
    from vasocv5 v
)

-- -- if you want to look at the results of the table before grouping:
-- select
--   icustay_id, charttime, vaso, vaso_rate, vaso_amount
--     , vaso_stopped
--     , vaso_start
--     , vaso_first
--     , vaso_stop
-- from vasocv6 order by icustay_id, charttime

, vasocv7 as
(
select
  icustay_id
  , charttime as starttime
  , lead(charttime) OVER (partition by icustay_id, vaso_first order by charttime) as endtime
  , vaso, vaso_rate, vaso_amount, vaso_stop, vaso_start, vaso_first
from vasocv6
where
  vaso_first is not null -- bogus data
and
  vaso_first != 0 -- sometimes *only* a rate of 0 appears, i.e. the drug is never actually delivered
and
  icustay_id is not null -- there are data for ""floating"" admissions, we don't worry about these
)
-- table of start/stop times for event
, vasocv8 as
(
  select
    icustay_id
    , starttime, endtime
    , vaso, vaso_rate, vaso_amount, vaso_stop, vaso_start, vaso_first
  from vasocv7
  where endtime is not null
  and vaso_rate > 0
  and starttime != endtime
)
-- collapse these start/stop times down if the rate doesn't change
, vasocv9 as
(
  select
    icustay_id
    , starttime, endtime
    , case
        when LAG(endtime) OVER (partition by icustay_id order by starttime, endtime) = starttime
        AND  LAG(vaso_rate) OVER (partition by icustay_id order by starttime, endtime) = vaso_rate
        THEN 0
      else 1
    end as vaso_groups
    , vaso, vaso_rate, vaso_amount, vaso_stop, vaso_start, vaso_first
  from vasocv8
  where endtime is not null
  and vaso_rate > 0
  and starttime != endtime
)
, vasocv10 as
(
  select
    icustay_id
    , starttime, endtime
    , vaso_groups
    , SUM(vaso_groups) OVER (partition by icustay_id order by starttime, endtime) as vaso_groups_sum
    , vaso, vaso_rate, vaso_amount, vaso_stop, vaso_start, vaso_first
  from vasocv9
)
, vasocv as
(
  select icustay_id
  , min(starttime) as starttime
  , max(endtime) as endtime
  , vaso_groups_sum
  , vaso_rate
  , sum(vaso_amount) as vaso_amount
  from vasocv10
  group by icustay_id, vaso_groups_sum, vaso_rate
)
-- now we extract the associated data for metavision patients
, vasomv as
(
  select
    icustay_id, linkorderid
    , rate as vaso_rate
    , amount as vaso_amount
    , starttime
    , endtime
  from inputevents_mv
  where itemid = 221662 -- dopamine
  and statusdescription != 'Rewritten' -- only valid orders
)
-- now assign this data to every hour of the patient's stay
-- vaso_amount for carevue is not accurate
SELECT icustay_id
  , starttime, endtime
  , vaso_rate, vaso_amount
from vasocv
UNION ALL
SELECT icustay_id
  , starttime, endtime
  , vaso_rate, vaso_amount
from vasomv
order by icustay_id, starttime
  );",109348,Thread-1,2022-07-18T00:10:15.376860Z
E017,,debug,SQL status: SELECT 38953 in 3.98 seconds,109348,Thread-1,2022-07-18T00:10:19.355609Z
E015,,debug,"Using postgres connection ""model.mimic.dopamine_dose""",109348,Thread-1,2022-07-18T00:10:19.362596Z
E016,,debug,"On model.mimic.dopamine_dose: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.dopamine_dose""} */
alter table ""postgres"".""public"".""dopamine_dose"" rename to ""dopamine_dose__dbt_backup""",109348,Thread-1,2022-07-18T00:10:19.362840Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:19.363671Z
E015,,debug,"Using postgres connection ""model.mimic.dopamine_dose""",109348,Thread-1,2022-07-18T00:10:19.367700Z
E016,,debug,"On model.mimic.dopamine_dose: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.dopamine_dose""} */
alter table ""postgres"".""public"".""dopamine_dose__dbt_tmp"" rename to ""dopamine_dose""",109348,Thread-1,2022-07-18T00:10:19.367921Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:19.368704Z
E018,,debug,On model.mimic.dopamine_dose: COMMIT,109348,Thread-1,2022-07-18T00:10:19.371708Z
E015,,debug,"Using postgres connection ""model.mimic.dopamine_dose""",109348,Thread-1,2022-07-18T00:10:19.371931Z
E016,,debug,On model.mimic.dopamine_dose: COMMIT,109348,Thread-1,2022-07-18T00:10:19.372198Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:19.377175Z
E015,,debug,"Using postgres connection ""model.mimic.dopamine_dose""",109348,Thread-1,2022-07-18T00:10:19.379725Z
E016,,debug,"On model.mimic.dopamine_dose: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.dopamine_dose""} */
drop table if exists ""postgres"".""public"".""dopamine_dose__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:19.379953Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:19.381849Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:19.384435Z
E010,,debug,On model.mimic.dopamine_dose: Close,109348,Thread-1,2022-07-18T00:10:19.384675Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7c4c3ecd-5c14-4600-9281-0e21ba30ba00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3f88756820>]}",109348,Thread-1,2022-07-18T00:10:19.385447Z
Q012,4,info,17 of 107 OK created table model public.dopamine_dose .......................... [[32mSELECT 38953[0m in 4.03s],109348,Thread-1,2022-07-18T00:10:19.386029Z,table,null,dopamine_dose,durations/dopamine_dose.sql,2022-07-18T00:10:15.353085,compiling,model,,,
Q024,4.0308837890625,debug,Finished running node model.mimic.dopamine_dose,109348,Thread-1,2022-07-18T00:10:19.386651Z,table,2022-07-18T00:10:19.386483,dopamine_dose,durations/dopamine_dose.sql,2022-07-18T00:10:15.353085,success,model,,,
Q023,,debug,Began running node model.mimic.dopamine_durations,109348,Thread-1,2022-07-18T00:10:19.387189Z,table,null,dopamine_durations,durations/dopamine_durations.sql,2022-07-18T00:10:19.387099,started,model,,,
Q033,,info,18 of 107 START table model public.dopamine_durations .......................... [RUN],109348,Thread-1,2022-07-18T00:10:19.387971Z,table,null,dopamine_durations,durations/dopamine_durations.sql,2022-07-18T00:10:19.387099,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.dopamine_durations""",109348,Thread-1,2022-07-18T00:10:19.388789Z
Q030,,debug,Began compiling node model.mimic.dopamine_durations,109348,Thread-1,2022-07-18T00:10:19.389120Z,table,null,dopamine_durations,durations/dopamine_durations.sql,2022-07-18T00:10:19.387099,compiling,model,,,
Q027,,debug,Compiling model.mimic.dopamine_durations,109348,Thread-1,2022-07-18T00:10:19.389511Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.dopamine_durations""",109348,Thread-1,2022-07-18T00:10:19.391831Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:19.392578Z
Q031,,debug,Began executing node model.mimic.dopamine_durations,109348,Thread-1,2022-07-18T00:10:19.392944Z,table,null,dopamine_durations,durations/dopamine_durations.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.dopamine_durations""",109348,Thread-1,2022-07-18T00:10:19.403584Z
E015,,debug,"Using postgres connection ""model.mimic.dopamine_durations""",109348,Thread-1,2022-07-18T00:10:19.404970Z
E016,,debug,On model.mimic.dopamine_durations: BEGIN,109348,Thread-1,2022-07-18T00:10:19.405343Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:19.406137Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:19.412978Z
E015,,debug,"Using postgres connection ""model.mimic.dopamine_durations""",109348,Thread-1,2022-07-18T00:10:19.413460Z
E016,,debug,"On model.mimic.dopamine_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.dopamine_durations""} */


  create  table ""postgres"".""public"".""dopamine_durations__dbt_tmp""
  as (
    -- This query extracts durations of dopamine administration
-- Consecutive administrations are numbered 1, 2, ...
-- Total time on the drug can be calculated from this table by grouping using ICUSTAY_ID

-- Get drug administration data from CareVue first
with vasocv1 as
(
  select
    icustay_id, charttime
    -- case statement determining whether the ITEMID is an instance of vasopressor usage
    , max(case when itemid in (30043,30307) then 1 else 0 end) as vaso -- dopamine

    -- the 'stopped' column indicates if a vasopressor has been disconnected
    , max(case when itemid in (30043,30307) and (stopped = 'Stopped' OR stopped like 'D/C%') then 1
          else 0 end) as vaso_stopped

    , max(case when itemid in (30043,30307) and rate is not null then 1 else 0 end) as vaso_null
    , max(case when itemid in (30043,30307) then rate else null end) as vaso_rate
    , max(case when itemid in (30043,30307) then amount else null end) as vaso_amount

  FROM inputevents_cv
  where itemid in
  (
        30043,30307 -- dopamine
  )
  group by icustay_id, charttime
)
, vasocv2 as
(
  select v.*
    , sum(vaso_null) over (partition by icustay_id order by charttime) as vaso_partition
  from
    vasocv1 v
)
, vasocv3 as
(
  select v.*
    , first_value(vaso_rate) over (partition by icustay_id, vaso_partition order by charttime) as vaso_prevrate_ifnull
  from
    vasocv2 v
)
, vasocv4 as
(
select
    icustay_id
    , charttime
    -- , (CHARTTIME - (LAG(CHARTTIME, 1) OVER (partition by icustay_id, vaso order by charttime))) AS delta

    , vaso
    , vaso_rate
    , vaso_amount
    , vaso_stopped
    , vaso_prevrate_ifnull

    -- We define start time here
    , case
        when vaso = 0 then null

        -- if this is the first instance of the vasoactive drug
        when vaso_rate > 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso, vaso_null
          order by charttime
          )
          is null
          then 1

        -- you often get a string of 0s
        -- we decide not to set these as 1, just because it makes vasonum sequential
        when vaso_rate = 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 0
          then 0

        -- sometimes you get a string of NULL, associated with 0 volumes
        -- same reason as before, we decide not to set these as 1
        -- vaso_prevrate_ifnull is equal to the previous value *iff* the current value is null
        when vaso_prevrate_ifnull = 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 0
          then 0

        -- If the last recorded rate was 0, newvaso = 1
        when LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          ) = 0
          then 1

        -- If the last recorded vaso was D/C'd, newvaso = 1
        when
          LAG(vaso_stopped,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 1 then 1

        -- ** not sure if the below is needed
        --when (CHARTTIME - (LAG(CHARTTIME, 1) OVER (partition by icustay_id, vaso order by charttime))) > (interval '4 hours') then 1
      else null
      end as vaso_start

FROM
  vasocv3
)
-- propagate start/stop flags forward in time
, vasocv5 as
(
  select v.*
    , SUM(vaso_start) OVER (partition by icustay_id, vaso order by charttime) as vaso_first
FROM
  vasocv4 v
)
, vasocv6 as
(
  select v.*
    -- We define end time here
    , case
        when vaso = 0
          then null

        -- If the recorded vaso was D/C'd, this is an end time
        when vaso_stopped = 1
          then vaso_first

        -- If the rate is zero, this is the end time
        when vaso_rate = 0
          then vaso_first

        -- the last row in the table is always a potential end time
        -- this captures patients who die/are discharged while on vasopressors
        -- in principle, this could add an extra end time for the vasopressor
        -- however, since we later group on vaso_start, any extra end times are ignored
        when LEAD(CHARTTIME,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          ) is null
          then vaso_first

        else null
        end as vaso_stop
    from vasocv5 v
)

-- -- if you want to look at the results of the table before grouping:
-- select
--   icustay_id, charttime, vaso, vaso_rate, vaso_amount
--     , case when vaso_stopped = 1 then 'Y' else '' end as stopped
--     , vaso_start
--     , vaso_first
--     , vaso_stop
-- from vasocv6 order by charttime


, vasocv as
(
-- below groups together vasopressor administrations into groups
select
  icustay_id
  -- the first non-null rate is considered the starttime
  , min(case when vaso_rate is not null then charttime else null end) as starttime
  -- the *first* time the first/last flags agree is the stop time for this duration
  , min(case when vaso_first = vaso_stop then charttime else null end) as endtime
from vasocv6
where
  vaso_first is not null -- bogus data
and
  vaso_first != 0 -- sometimes *only* a rate of 0 appears, i.e. the drug is never actually delivered
and
  icustay_id is not null -- there are data for ""floating"" admissions, we don't worry about these
group by icustay_id, vaso_first
having -- ensure start time is not the same as end time
 min(charttime) != min(case when vaso_first = vaso_stop then charttime else null end)
and
  max(vaso_rate) > 0 -- if the rate was always 0 or null, we consider it not a real drug delivery
)

-- now we extract the associated data for metavision patients
, vasomv as
(
  select
    icustay_id, linkorderid
    , min(starttime) as starttime, max(endtime) as endtime
  FROM inputevents_mv
  where itemid = 221662 -- dopamine
  and statusdescription != 'Rewritten' -- only valid orders
  group by icustay_id, linkorderid
)

select
  icustay_id
  -- generate a sequential integer for convenience
  , ROW_NUMBER() over (partition by icustay_id order by starttime) as vasonum
  , starttime, endtime
  , DATETIME_DIFF(endtime, starttime, 'HOUR') AS duration_hours
  -- add durations
from
  vasocv

UNION ALL

select
  icustay_id
  , ROW_NUMBER() over (partition by icustay_id order by starttime) as vasonum
  , starttime, endtime
  , DATETIME_DIFF(endtime, starttime, 'HOUR') AS duration_hours
  -- add durations
from
  vasomv

order by icustay_id, vasonum
  );",109348,Thread-1,2022-07-18T00:10:19.413939Z
E017,,debug,SQL status: SELECT 6524 in 2.16 seconds,109348,Thread-1,2022-07-18T00:10:21.569913Z
E015,,debug,"Using postgres connection ""model.mimic.dopamine_durations""",109348,Thread-1,2022-07-18T00:10:21.576354Z
E016,,debug,"On model.mimic.dopamine_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.dopamine_durations""} */
alter table ""postgres"".""public"".""dopamine_durations"" rename to ""dopamine_durations__dbt_backup""",109348,Thread-1,2022-07-18T00:10:21.576661Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:21.579029Z
E015,,debug,"Using postgres connection ""model.mimic.dopamine_durations""",109348,Thread-1,2022-07-18T00:10:21.585078Z
E016,,debug,"On model.mimic.dopamine_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.dopamine_durations""} */
alter table ""postgres"".""public"".""dopamine_durations__dbt_tmp"" rename to ""dopamine_durations""",109348,Thread-1,2022-07-18T00:10:21.585315Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:21.586068Z
E018,,debug,On model.mimic.dopamine_durations: COMMIT,109348,Thread-1,2022-07-18T00:10:21.588904Z
E015,,debug,"Using postgres connection ""model.mimic.dopamine_durations""",109348,Thread-1,2022-07-18T00:10:21.589110Z
E016,,debug,On model.mimic.dopamine_durations: COMMIT,109348,Thread-1,2022-07-18T00:10:21.589229Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:21.591973Z
E015,,debug,"Using postgres connection ""model.mimic.dopamine_durations""",109348,Thread-1,2022-07-18T00:10:21.594845Z
E016,,debug,"On model.mimic.dopamine_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.dopamine_durations""} */
drop table if exists ""postgres"".""public"".""dopamine_durations__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:21.595092Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:21.597697Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:21.600765Z
E010,,debug,On model.mimic.dopamine_durations: Close,109348,Thread-1,2022-07-18T00:10:21.601016Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7c4c3ecd-5c14-4600-9281-0e21ba30ba00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3f8a03dc70>]}",109348,Thread-1,2022-07-18T00:10:21.601812Z
Q012,2,info,18 of 107 OK created table model public.dopamine_durations ..................... [[32mSELECT 6524[0m in 2.21s],109348,Thread-1,2022-07-18T00:10:21.602318Z,table,null,dopamine_durations,durations/dopamine_durations.sql,2022-07-18T00:10:19.387099,compiling,model,,,
Q024,2.213226795196533,debug,Finished running node model.mimic.dopamine_durations,109348,Thread-1,2022-07-18T00:10:21.602940Z,table,2022-07-18T00:10:21.602772,dopamine_durations,durations/dopamine_durations.sql,2022-07-18T00:10:19.387099,success,model,,,
Q023,,debug,Began running node model.mimic.echo_data,109348,Thread-1,2022-07-18T00:10:21.603443Z,table,null,echo_data,echo_data.sql,2022-07-18T00:10:21.603357,started,model,,,
Q033,,info,19 of 107 START table model public.echo_data ................................... [RUN],109348,Thread-1,2022-07-18T00:10:21.604219Z,table,null,echo_data,echo_data.sql,2022-07-18T00:10:21.603357,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.echo_data""",109348,Thread-1,2022-07-18T00:10:21.605002Z
Q030,,debug,Began compiling node model.mimic.echo_data,109348,Thread-1,2022-07-18T00:10:21.605241Z,table,null,echo_data,echo_data.sql,2022-07-18T00:10:21.603357,compiling,model,,,
Q027,,debug,Compiling model.mimic.echo_data,109348,Thread-1,2022-07-18T00:10:21.605772Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.echo_data""",109348,Thread-1,2022-07-18T00:10:21.611074Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:21.611925Z
Q031,,debug,Began executing node model.mimic.echo_data,109348,Thread-1,2022-07-18T00:10:21.612255Z,table,null,echo_data,echo_data.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.echo_data""",109348,Thread-1,2022-07-18T00:10:21.622871Z
E015,,debug,"Using postgres connection ""model.mimic.echo_data""",109348,Thread-1,2022-07-18T00:10:21.623580Z
E016,,debug,On model.mimic.echo_data: BEGIN,109348,Thread-1,2022-07-18T00:10:21.624041Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:21.624384Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:21.631049Z
E015,,debug,"Using postgres connection ""model.mimic.echo_data""",109348,Thread-1,2022-07-18T00:10:21.631444Z
E016,,debug,"On model.mimic.echo_data: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.echo_data""} */


  create  table ""postgres"".""public"".""echo_data__dbt_tmp""
  as (
    -- This code extracts structured data from echocardiographies
-- You can join it to the text notes using ROW_ID
-- Just note that ROW_ID will differ across versions of MIMIC-III.


select ROW_ID
  , subject_id, hadm_id
  , chartdate
  -- charttime is always null for echoes..
  -- however, the time is available in the echo text, e.g.:
  -- , substring(ne.text, 'Date/Time: [\[\]0-9*-]+ at ([0-9:]+)') as TIMESTAMP
  -- we can therefore impute it and re-create charttime
  , PARSE_DATETIME
  (
      '%Y-%m-%d%H:%M:%S',
      FORMAT_DATE('%Y-%m-%d', chartdate)
      || REGEXP_EXTRACT(ne.text, 'Date/Time: .+? at ([0-9]+:[0-9]{2})')
      || ':00'
   ) AS charttime

  -- explanation of below substring:
  --  'Indication: ' - matched verbatim
  --  (.*?) - match any character
  --  \n - the end of the line
  -- substring only returns the item in ()s
  -- note: the '?' makes it non-greedy. if you exclude it, it matches until it reaches the *last* \n

  , REGEXP_EXTRACT(ne.text, 'Indication: (.*?)\n') as Indication

  -- sometimes numeric values contain de-id text, e.g. [** Numeric Identifier **]
  -- this removes that text
  , cast(REGEXP_EXTRACT(ne.text, 'Height: \\x28in\\x29 ([0-9]+)') as numeric) as Height
  , cast(REGEXP_EXTRACT(ne.text, 'Weight \\x28lb\\x29: ([0-9]+)\n') as numeric) as Weight
  , cast(REGEXP_EXTRACT(ne.text, 'BSA \\x28m2\\x29: ([0-9]+) m2\n') as numeric) as BSA -- ends in 'm2'
  , REGEXP_EXTRACT(ne.text, 'BP \\x28mm Hg\\x29: (.+)\n') as BP -- Sys/Dias
  , cast(REGEXP_EXTRACT(ne.text, 'BP \\x28mm Hg\\x29: ([0-9]+)/[0-9]+?\n') as numeric) as BPSys -- first part of fraction
  , cast(REGEXP_EXTRACT(ne.text, 'BP \\x28mm Hg\\x29: [0-9]+/([0-9]+?)\n') as numeric) as BPDias -- second part of fraction
  , cast(REGEXP_EXTRACT(ne.text, 'HR \\x28bpm\\x29: ([0-9]+?)\n') as numeric) as HR

  , REGEXP_EXTRACT(ne.text, 'Status: (.*?)\n') as Status
  , REGEXP_EXTRACT(ne.text, 'Test: (.*?)\n') as Test
  , REGEXP_EXTRACT(ne.text, 'Doppler: (.*?)\n') as Doppler
  , REGEXP_EXTRACT(ne.text, 'Contrast: (.*?)\n') as Contrast
  , REGEXP_EXTRACT(ne.text, 'Technical Quality: (.*?)\n') as TechnicalQuality
FROM noteevents ne
where category = 'Echo'
  );",109348,Thread-1,2022-07-18T00:10:21.631819Z
E017,,debug,SQL status: SELECT 0 in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:21.638043Z
E015,,debug,"Using postgres connection ""model.mimic.echo_data""",109348,Thread-1,2022-07-18T00:10:21.643841Z
E016,,debug,"On model.mimic.echo_data: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.echo_data""} */
alter table ""postgres"".""public"".""echo_data"" rename to ""echo_data__dbt_backup""",109348,Thread-1,2022-07-18T00:10:21.644386Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:21.646898Z
E015,,debug,"Using postgres connection ""model.mimic.echo_data""",109348,Thread-1,2022-07-18T00:10:21.651348Z
E016,,debug,"On model.mimic.echo_data: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.echo_data""} */
alter table ""postgres"".""public"".""echo_data__dbt_tmp"" rename to ""echo_data""",109348,Thread-1,2022-07-18T00:10:21.651577Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:21.652366Z
E018,,debug,On model.mimic.echo_data: COMMIT,109348,Thread-1,2022-07-18T00:10:21.655752Z
E015,,debug,"Using postgres connection ""model.mimic.echo_data""",109348,Thread-1,2022-07-18T00:10:21.656218Z
E016,,debug,On model.mimic.echo_data: COMMIT,109348,Thread-1,2022-07-18T00:10:21.656742Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:21.659153Z
E015,,debug,"Using postgres connection ""model.mimic.echo_data""",109348,Thread-1,2022-07-18T00:10:21.662696Z
E016,,debug,"On model.mimic.echo_data: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.echo_data""} */
drop table if exists ""postgres"".""public"".""echo_data__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:21.663090Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:21.665771Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:21.668298Z
E010,,debug,On model.mimic.echo_data: Close,109348,Thread-1,2022-07-18T00:10:21.668526Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7c4c3ecd-5c14-4600-9281-0e21ba30ba00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3f8a03dd00>]}",109348,Thread-1,2022-07-18T00:10:21.669222Z
Q012,0,info,19 of 107 OK created table model public.echo_data .............................. [[32mSELECT 0[0m in 0.06s],109348,Thread-1,2022-07-18T00:10:21.669788Z,table,null,echo_data,echo_data.sql,2022-07-18T00:10:21.603357,compiling,model,,,
Q024,0.06439614295959473,debug,Finished running node model.mimic.echo_data,109348,Thread-1,2022-07-18T00:10:21.670435Z,table,2022-07-18T00:10:21.670255,echo_data,echo_data.sql,2022-07-18T00:10:21.603357,success,model,,,
Q023,,debug,Began running node model.mimic.elixhauser_ahrq_v37,109348,Thread-1,2022-07-18T00:10:21.670920Z,table,null,elixhauser_ahrq_v37,comorbidity/elixhauser_ahrq_v37.sql,2022-07-18T00:10:21.670827,started,model,,,
Q033,,info,20 of 107 START table model public.elixhauser_ahrq_v37 ......................... [RUN],109348,Thread-1,2022-07-18T00:10:21.671716Z,table,null,elixhauser_ahrq_v37,comorbidity/elixhauser_ahrq_v37.sql,2022-07-18T00:10:21.670827,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.elixhauser_ahrq_v37""",109348,Thread-1,2022-07-18T00:10:21.673479Z
Q030,,debug,Began compiling node model.mimic.elixhauser_ahrq_v37,109348,Thread-1,2022-07-18T00:10:21.674337Z,table,null,elixhauser_ahrq_v37,comorbidity/elixhauser_ahrq_v37.sql,2022-07-18T00:10:21.670827,compiling,model,,,
Q027,,debug,Compiling model.mimic.elixhauser_ahrq_v37,109348,Thread-1,2022-07-18T00:10:21.675313Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.elixhauser_ahrq_v37""",109348,Thread-1,2022-07-18T00:10:21.681414Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:21.682545Z
Q031,,debug,Began executing node model.mimic.elixhauser_ahrq_v37,109348,Thread-1,2022-07-18T00:10:21.682905Z,table,null,elixhauser_ahrq_v37,comorbidity/elixhauser_ahrq_v37.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.elixhauser_ahrq_v37""",109348,Thread-1,2022-07-18T00:10:21.694300Z
E015,,debug,"Using postgres connection ""model.mimic.elixhauser_ahrq_v37""",109348,Thread-1,2022-07-18T00:10:21.695300Z
E016,,debug,On model.mimic.elixhauser_ahrq_v37: BEGIN,109348,Thread-1,2022-07-18T00:10:21.695559Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:21.695768Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:21.703220Z
E015,,debug,"Using postgres connection ""model.mimic.elixhauser_ahrq_v37""",109348,Thread-1,2022-07-18T00:10:21.703596Z
E016,,debug,"On model.mimic.elixhauser_ahrq_v37: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.elixhauser_ahrq_v37""} */


  create  table ""postgres"".""public"".""elixhauser_ahrq_v37__dbt_tmp""
  as (
    -- This code uses the latest version of Elixhauser provided by AHRQ
 

with eliflg as (
    select
        hadm_id,
        seq_num,
        icd9_code -- note that these codes will seem incomplete at first
        -- for example, CHF is missing a lot of codes referenced in the literature (402.11, 402.91, etc)
        -- these codes are captured by hypertension flags instead
        -- later there are some complicated rules which confirm/reject those codes as chf
,
        CASE
            when icd9_code = '39891' then 1
            when icd9_code between '4280'
            and '4289' then 1
        end as chf
        /* Congestive heart failure */
        -- cardiac arrhythmias is removed in up to date versions
,
        case
            when icd9_code = '42610' then 1
            when icd9_code = '42611' then 1
            when icd9_code = '42613' then 1
            when icd9_code between '4262'
            and '42653' then 1
            when icd9_code between '4266'
            and '42689' then 1
            when icd9_code = '4270' then 1
            when icd9_code = '4272' then 1
            when icd9_code = '42731' then 1
            when icd9_code = '42760' then 1
            when icd9_code = '4279' then 1
            when icd9_code = '7850' then 1
            when icd9_code between 'V450'
            and 'V4509' then 1
            when icd9_code between 'V533'
            and 'V5339' then 1
        end as arythm
        /* Cardiac arrhythmias */
,
        CASE
            when icd9_code between '09320'
            and '09324' then 1
            when icd9_code between '3940'
            and '3971' then 1
            when icd9_code = '3979' then 1
            when icd9_code between '4240'
            and '42499' then 1
            when icd9_code between '7463'
            and '7466' then 1
            when icd9_code = 'V422' then 1
            when icd9_code = 'V433' then 1
        end as valve
        /* Valvular disease */
,
        CASE
            when icd9_code between '41511'
            and '41519' then 1
            when icd9_code between '4160'
            and '4169' then 1
            when icd9_code = '4179' then 1
        end as pulmcirc
        /* Pulmonary circulation disorder */
,
        CASE
            when icd9_code between '4400'
            and '4409' then 1
            when icd9_code between '44100'
            and '4419' then 1
            when icd9_code between '4420'
            and '4429' then 1
            when icd9_code between '4431'
            and '4439' then 1
            when icd9_code between '44421'
            and '44422' then 1
            when icd9_code = '4471' then 1
            when icd9_code = '449' then 1
            when icd9_code = '5571' then 1
            when icd9_code = '5579' then 1
            when icd9_code = 'V434' then 1
        end as perivasc
        /* Peripheral vascular disorder */
,
        CASE
            when icd9_code = '4011' then 1
            when icd9_code = '4019' then 1
            when icd9_code between '64200'
            and '64204' then 1
        end as htn
        /* Hypertension, uncomplicated */
,
        CASE
            when icd9_code = '4010' then 1
            when icd9_code = '4372' then 1
        end as htncx
        /* Hypertension, complicated */
        /******************************************************************/
        /* The following are special, temporary formats used in the       */
        /* creation of the hypertension complicated comorbidity when      */
        /* overlapping with congestive heart failure or renal failure     */
        /* occurs. These temporary formats are referenced in the program  */
        /* called comoanaly2009.txt.                                      */
        /******************************************************************/
,
        CASE
            when icd9_code between '64220'
            and '64224' then 1
        end as htnpreg
        /* Pre-existing hypertension complicating pregnancy */
,
        CASE
            when icd9_code = '40200' then 1
            when icd9_code = '40210' then 1
            when icd9_code = '40290' then 1
            when icd9_code = '40509' then 1
            when icd9_code = '40519' then 1
            when icd9_code = '40599' then 1
        end as htnwochf
        /* Hypertensive heart disease without heart failure */
,
        CASE
            when icd9_code = '40201' then 1
            when icd9_code = '40211' then 1
            when icd9_code = '40291' then 1
        end as htnwchf
        /* Hypertensive heart disease with heart failure */
,
        CASE
            when icd9_code = '40300' then 1
            when icd9_code = '40310' then 1
            when icd9_code = '40390' then 1
            when icd9_code = '40501' then 1
            when icd9_code = '40511' then 1
            when icd9_code = '40591' then 1
            when icd9_code between '64210'
            and '64214' then 1
        end as hrenworf
        /* Hypertensive renal disease without renal failure */
,
        CASE
            when icd9_code = '40301' then 1
            when icd9_code = '40311' then 1
            when icd9_code = '40391' then 1
        end as hrenwrf
        /* Hypertensive renal disease with renal failure */
,
        CASE
            when icd9_code = '40400' then 1
            when icd9_code = '40410' then 1
            when icd9_code = '40490' then 1
        end as hhrwohrf
        /* Hypertensive heart and renal disease without heart or renal failure */
,
        CASE
            when icd9_code = '40401' then 1
            when icd9_code = '40411' then 1
            when icd9_code = '40491' then 1
        end as hhrwchf
        /* Hypertensive heart and renal disease with heart failure */
,
        CASE
            when icd9_code = '40402' then 1
            when icd9_code = '40412' then 1
            when icd9_code = '40492' then 1
        end as hhrwrf
        /* Hypertensive heart and renal disease with renal failure */
,
        CASE
            when icd9_code = '40403' then 1
            when icd9_code = '40413' then 1
            when icd9_code = '40493' then 1
        end as hhrwhrf
        /* Hypertensive heart and renal disease with heart and renal failure */
,
        CASE
            when icd9_code between '64270'
            and '64274' then 1
            when icd9_code between '64290'
            and '64294' then 1
        end as ohtnpreg
        /* Other hypertension in pregnancy */
        /******************** End Temporary Formats ***********************/
,
        CASE
            when icd9_code between '3420'
            and '3449' then 1
            when icd9_code between '43820'
            and '43853' then 1
            when icd9_code = '78072' then 1
        end as para
        /* Paralysis */
,
        CASE
            when icd9_code between '3300'
            and '3319' then 1
            when icd9_code = '3320' then 1
            when icd9_code = '3334' then 1
            when icd9_code = '3335' then 1
            when icd9_code = '3337' then 1
            when icd9_code in ('33371', '33372', '33379', '33385', '33394') then 1
            when icd9_code between '3340'
            and '3359' then 1
            when icd9_code = '3380' then 1
            when icd9_code = '340' then 1
            when icd9_code between '3411'
            and '3419' then 1
            when icd9_code between '34500'
            and '34511' then 1
            when icd9_code between '3452'
            and '3453' then 1
            when icd9_code between '34540'
            and '34591' then 1
            when icd9_code between '34700'
            and '34701' then 1
            when icd9_code between '34710'
            and '34711' then 1
            when icd9_code = '3483' then 1 -- discontinued icd-9
            when icd9_code between '64940'
            and '64944' then 1
            when icd9_code = '7687' then 1
            when icd9_code between '76870'
            and '76873' then 1
            when icd9_code = '7803' then 1
            when icd9_code = '78031' then 1
            when icd9_code = '78032' then 1
            when icd9_code = '78033' then 1
            when icd9_code = '78039' then 1
            when icd9_code = '78097' then 1
            when icd9_code = '7843' then 1
        end as neuro
        /* Other neurological */
,
        CASE
            when icd9_code between '490'
            and '4928' then 1
            when icd9_code between '49300'
            and '49392' then 1
            when icd9_code between '494'
            and '4941' then 1
            when icd9_code between '4950'
            and '505' then 1
            when icd9_code = '5064' then 1
        end as chrnlung
        /* Chronic pulmonary disease */
,
        CASE
            when icd9_code between '25000'
            and '25033' then 1
            when icd9_code between '64800'
            and '64804' then 1
            when icd9_code between '24900'
            and '24931' then 1
        end as dm
        /* Diabetes w/o chronic complications*/
,
        CASE
            when icd9_code between '25040'
            and '25093' then 1
            when icd9_code = '7751' then 1
            when icd9_code between '24940'
            and '24991' then 1
        end as dmcx
        /* Diabetes w/ chronic complications */
,
        CASE
            when icd9_code between '243'
            and '2442' then 1
            when icd9_code = '2448' then 1
            when icd9_code = '2449' then 1
        end as hypothy
        /* Hypothyroidism */
,
        CASE
            when icd9_code = '585' then 1 -- discontinued code
            when icd9_code = '5853' then 1
            when icd9_code = '5854' then 1
            when icd9_code = '5855' then 1
            when icd9_code = '5856' then 1
            when icd9_code = '5859' then 1
            when icd9_code = '586' then 1
            when icd9_code = 'V420' then 1
            when icd9_code = 'V451' then 1
            when icd9_code between 'V560'
            and 'V5632' then 1
            when icd9_code = 'V568' then 1
            when icd9_code between 'V4511'
            and 'V4512' then 1
        end as renlfail
        /* Renal failure */
,
        CASE
            when icd9_code = '07022' then 1
            when icd9_code = '07023' then 1
            when icd9_code = '07032' then 1
            when icd9_code = '07033' then 1
            when icd9_code = '07044' then 1
            when icd9_code = '07054' then 1
            when icd9_code = '4560' then 1
            when icd9_code = '4561' then 1
            when icd9_code = '45620' then 1
            when icd9_code = '45621' then 1
            when icd9_code = '5710' then 1
            when icd9_code = '5712' then 1
            when icd9_code = '5713' then 1
            when icd9_code between '57140'
            and '57149' then 1
            when icd9_code = '5715' then 1
            when icd9_code = '5716' then 1
            when icd9_code = '5718' then 1
            when icd9_code = '5719' then 1
            when icd9_code = '5723' then 1
            when icd9_code = '5728' then 1
            when icd9_code = '5735' then 1
            when icd9_code = 'V427' then 1
        end as liver
        /* Liver disease */
,
        CASE
            when icd9_code = '53141' then 1
            when icd9_code = '53151' then 1
            when icd9_code = '53161' then 1
            when icd9_code = '53170' then 1
            when icd9_code = '53171' then 1
            when icd9_code = '53191' then 1
            when icd9_code = '53241' then 1
            when icd9_code = '53251' then 1
            when icd9_code = '53261' then 1
            when icd9_code = '53270' then 1
            when icd9_code = '53271' then 1
            when icd9_code = '53291' then 1
            when icd9_code = '53341' then 1
            when icd9_code = '53351' then 1
            when icd9_code = '53361' then 1
            when icd9_code = '53370' then 1
            when icd9_code = '53371' then 1
            when icd9_code = '53391' then 1
            when icd9_code = '53441' then 1
            when icd9_code = '53451' then 1
            when icd9_code = '53461' then 1
            when icd9_code = '53470' then 1
            when icd9_code = '53471' then 1
            when icd9_code = '53491' then 1
        end as ulcer
        /* Chronic Peptic ulcer disease (includes bleeding only if obstruction is also present) */
,
        CASE
            when icd9_code between '042'
            and '0449' then 1
        end as aids
        /* HIV and AIDS */
,
        CASE
            when icd9_code between '20000'
            and '20238' then 1
            when icd9_code between '20250'
            and '20301' then 1
            when icd9_code = '2386' then 1
            when icd9_code = '2733' then 1
            when icd9_code between '20302'
            and '20382' then 1
        end as lymph
        /* Lymphoma */
,
        CASE
            when icd9_code between '1960'
            and '1991' then 1
            when icd9_code between '20970'
            and '20975' then 1
            when icd9_code = '20979' then 1
            when icd9_code = '78951' then 1
        end as mets
        /* Metastatic cancer */
,
        CASE
            when icd9_code between '1400'
            and '1729' then 1
            when icd9_code between '1740'
            and '1759' then 1
            when icd9_code between '179'
            and '1958' then 1
            when icd9_code between '20900'
            and '20924' then 1
            when icd9_code between '20925'
            and '2093' then 1
            when icd9_code between '20930'
            and '20936' then 1
            when icd9_code between '25801'
            and '25803' then 1
        end as tumor
        /* Solid tumor without metastasis */
,
        CASE
            when icd9_code = '7010' then 1
            when icd9_code between '7100'
            and '7109' then 1
            when icd9_code between '7140'
            and '7149' then 1
            when icd9_code between '7200'
            and '7209' then 1
            when icd9_code = '725' then 1
        end as arth
        /* Rheumatoid arthritis/collagen vascular diseases */
,
        CASE
            when icd9_code between '2860'
            and '2869' then 1
            when icd9_code = '2871' then 1
            when icd9_code between '2873'
            and '2875' then 1
            when icd9_code between '64930'
            and '64934' then 1
            when icd9_code = '28984' then 1
        end as coag
        /* Coagulation deficiency */
,
        CASE
            when icd9_code = '2780' then 1
            when icd9_code = '27800' then 1
            when icd9_code = '27801' then 1
            when icd9_code = '27803' then 1
            when icd9_code between '64910'
            and '64914' then 1
            when icd9_code between 'V8530'
            and 'V8539' then 1
            when icd9_code = 'V854' then 1 -- hierarchy used for AHRQ v3.6 and earlier
            when icd9_code between 'V8541'
            and 'V8545' then 1
            when icd9_code = 'V8554' then 1
            when icd9_code = '79391' then 1
        end as obese
        /* Obesity      */
,
        CASE
            when icd9_code between '260'
            and '2639' then 1
            when icd9_code between '78321'
            and '78322' then 1
        end as wghtloss
        /* Weight loss */
,
        CASE
            when icd9_code between '2760'
            and '2769' then 1
        end as lytes
        /* Fluid and electrolyte disorders - note:
         this comorbidity should be dropped when
         used with the AHRQ Patient Safety Indicators*/
,
        CASE
            when icd9_code = '2800' then 1
            when icd9_code between '64820'
            and '64824' then 1
        end as bldloss
        /* Blood loss anemia */
,
        CASE
            when icd9_code between '2801'
            and '2819' then 1
            when icd9_code between '28521'
            and '28529' then 1
            when icd9_code = '2859' then 1
        end as anemdef
        /* Deficiency anemias */
,
        CASE
            when icd9_code between '2910'
            and '2913' then 1
            when icd9_code = '2915' then 1
            when icd9_code = '2918' then 1
            when icd9_code = '29181' then 1
            when icd9_code = '29182' then 1
            when icd9_code = '29189' then 1
            when icd9_code = '2919' then 1
            when icd9_code between '30300'
            and '30393' then 1
            when icd9_code between '30500'
            and '30503' then 1
        end as alcohol
        /* Alcohol abuse */
,
        CASE
            when icd9_code = '2920' then 1
            when icd9_code between '29282'
            and '29289' then 1
            when icd9_code = '2929' then 1
            when icd9_code between '30400'
            and '30493' then 1
            when icd9_code between '30520'
            and '30593' then 1
            when icd9_code between '64830'
            and '64834' then 1
        end as drug
        /* Drug abuse */
,
        CASE
            when icd9_code between '29500'
            and '2989' then 1
            when icd9_code = '29910' then 1
            when icd9_code = '29911' then 1
        end as psych
        /* Psychoses */
,
        CASE
            when icd9_code = '3004' then 1
            when icd9_code = '30112' then 1
            when icd9_code = '3090' then 1
            when icd9_code = '3091' then 1
            when icd9_code = '311' then 1
        end as depress
        /* Depression */
    from
        diagnoses_icd icd
    WHERE
        seq_num = 1
) -- collapse the icd9_code specific flags into hadm_id specific flags
-- this groups comorbidities together for a single patient admission
,
eligrp as (
    select
        hadm_id,
        max(chf) as chf,
        max(arythm) as arythm,
        max(valve) as valve,
        max(pulmcirc) as pulmcirc,
        max(perivasc) as perivasc,
        max(htn) as htn,
        max(htncx) as htncx,
        max(htnpreg) as htnpreg,
        max(htnwochf) as htnwochf,
        max(htnwchf) as htnwchf,
        max(hrenworf) as hrenworf,
        max(hrenwrf) as hrenwrf,
        max(hhrwohrf) as hhrwohrf,
        max(hhrwchf) as hhrwchf,
        max(hhrwrf) as hhrwrf,
        max(hhrwhrf) as hhrwhrf,
        max(ohtnpreg) as ohtnpreg,
        max(para) as para,
        max(neuro) as neuro,
        max(chrnlung) as chrnlung,
        max(dm) as dm,
        max(dmcx) as dmcx,
        max(hypothy) as hypothy,
        max(renlfail) as renlfail,
        max(liver) as liver,
        max(ulcer) as ulcer,
        max(aids) as aids,
        max(lymph) as lymph,
        max(mets) as mets,
        max(tumor) as tumor,
        max(arth) as arth,
        max(coag) as coag,
        max(obese) as obese,
        max(wghtloss) as wghtloss,
        max(lytes) as lytes,
        max(bldloss) as bldloss,
        max(anemdef) as anemdef,
        max(alcohol) as alcohol,
        max(drug) as drug,
        max(psych) as psych,
        max(depress) as depress
    from
        eliflg
    group by
        hadm_id
) -- DRG FILTER --
,
msdrg as (
    select
        hadm_id
        /**** V29 MS-DRG Formats ****/
        /* Cardiac */
,
        case
            when d.drg_code between 001
            and 002 then 1
            when d.drg_code between 215
            and 238 then 1
            when d.drg_code between 242
            and 252 then 1
            when d.drg_code between 253
            and 254 then 1
            when d.drg_code between 258
            and 262 then 1
            when d.drg_code between 265
            and 267 then 1
            when d.drg_code between 280
            and 293 then 1
            when d.drg_code between 296
            and 298 then 1
            when d.drg_code between 302
            and 303 then 1
            when d.drg_code between 306
            and 313 then 1
            else 0
        end as carddrg
        /* Peripheral vascular */
,
        case
            when d.drg_code between 299
            and 301 then 1
            else 0
        end as peridrg
        /* Renal */
,
        case
            when d.drg_code = 652 then 1
            when d.drg_code between 656
            and 661 then 1
            when d.drg_code between 673
            and 675 then 1
            when d.drg_code between 682
            and 700 then 1
            else 0
        end as renaldrg
        /* Nervous system */
,
        case
            when d.drg_code between 020
            and 042 then 1
            when d.drg_code between 052
            and 103 then 1
            else 0
        end as nervdrg
        /* Cerebrovascular */
,
        case
            when d.drg_code between 020
            and 022 then 1
            when d.drg_code between 034
            and 039 then 1
            when d.drg_code between 064
            and 072 then 1
            else 0
        end as ceredrg
        /* COPD asthma */
,
        case
            when d.drg_code between 190
            and 192 then 1
            when d.drg_code between 202
            and 203 then 1
            else 0
        end as pulmdrg
        /* Diabetes */
,
        case
            when d.drg_code between 637
            and 639 then 1
            else 0
        end as DIABDRG
        /* Thyroid endocrine */
,
        case
            when d.drg_code between 625
            and 627 then 1
            when d.drg_code between 643
            and 645 then 1
            else 0
        end as hypodrg
        /* Kidney transp, renal fail/dialysis */
,
        case
            when d.drg_code = 652 then 1
            when d.drg_code between 682
            and 685 then 1
            else 0
        end as renfdrg
        /* Liver */
,
        case
            when d.drg_code between 420
            and 425 then 1
            when d.drg_code between 432
            and 434 then 1
            when d.drg_code between 441
            and 446 then 1
            else 0
        end as liverdrg
        /* GI hemorrhage or ulcer */
,
        case
            when d.drg_code between 377
            and 384 then 1
            else 0
        end as ulcedrg
        /* Human immunodeficiency virus */
,
        case
            when d.drg_code between 969
            and 970 then 1
            when d.drg_code between 974
            and 977 then 1
            else 0
        end as hivdrg
        /* Leukemia/lymphoma */
,
        case
            when d.drg_code between 820
            and 830 then 1
            when d.drg_code between 834
            and 849 then 1
            else 0
        end as leukdrg
        /* Cancer, lymphoma */
,
        case
            when d.drg_code = 054 then 1
            when d.drg_code = 055 then 1
            when d.drg_code between 146
            and 148 then 1
            when d.drg_code between 180
            and 182 then 1
            when d.drg_code between 374
            and 376 then 1
            when d.drg_code between 435
            and 437 then 1
            when d.drg_code between 542
            and 544 then 1
            when d.drg_code between 582
            and 585 then 1
            when d.drg_code between 597
            and 599 then 1
            when d.drg_code between 656
            and 658 then 1
            when d.drg_code between 686
            and 688 then 1
            when d.drg_code between 715
            and 716 then 1
            when d.drg_code between 722
            and 724 then 1
            when d.drg_code between 736
            and 741 then 1
            when d.drg_code between 754
            and 756 then 1
            when d.drg_code between 826
            and 830 then 1
            when d.drg_code between 843
            and 849 then 1
            else 0
        end as cancdrg
        /* Connective tissue */
,
        case
            when d.drg_code between 545
            and 547 then 1
            else 0
        end as arthdrg
        /* Nutrition/metabolic */
,
        case
            when d.drg_code between 640
            and 641 then 1
            else 0
        end as nutrdrg
        /* Anemia */
,
        case
            when d.drg_code between 808
            and 812 then 1
            else 0
        end as anemdrg
        /* Alcohol drug */
,
        case
            when d.drg_code between 894
            and 897 then 1
            else 0
        end as alcdrg
        /*Coagulation disorders*/
,
        case
            when d.drg_code = 813 then 1
            else 0
        end as coagdrg
        /*Hypertensive Complicated  */
,
        case
            when d.drg_code = 077 then 1
            when d.drg_code = 078 then 1
            when d.drg_code = 304 then 1
            else 0
        end as htncxdrg
        /*Hypertensive Uncomplicated  */
,
        case
            when d.drg_code = 079 then 1
            when d.drg_code = 305 then 1
            else 0
        end as htndrg
        /* Psychoses */
,
        case
            when d.drg_code = 885 then 1
            else 0
        end as psydrg
        /* Obesity */
,
        case
            when d.drg_code between 619
            and 621 then 1
            else 0
        end as obesedrg
        /* Depressive Neuroses */
,
        case
            when d.drg_code = 881 then 1
            else 0
        end as deprsdrg
    from
        (
            select
                hadm_id,
                drg_type,
                cast(drg_code as numeric) as drg_code
            from
                drgcodes
            where
                drg_type = 'MS'
        ) d
),
hcfadrg as (
    select
        hadm_id
        /** V24 DRG Formats  **/
        /* Cardiac */
,
        case
            when d.drg_code between 103
            and 112 then 1
            when d.drg_code between 115
            and 118 then 1
            when d.drg_code between 121
            and 127 then 1
            when d.drg_code = 129 then 1
            when d.drg_code = 132 then 1
            when d.drg_code = 133 then 1
            when d.drg_code between 135
            and 143 then 1
            when d.drg_code between 514
            and 518 then 1
            when d.drg_code between 525
            and 527 then 1
            when d.drg_code between 535
            and 536 then 1
            when d.drg_code between 547
            and 550 then 1
            when d.drg_code between 551
            and 558 then 1
            else 0
        end as carddrg
        /* Peripheral vascular */
,
        case
            when d.drg_code = 130 then 1
            when d.drg_code = 131 then 1
            else 0
        end as peridrg
        /* Renal */
,
        case
            when d.drg_code between 302
            and 305 then 1
            when d.drg_code between 315
            and 333 then 1
            else 0
        end as renaldrg
        /* Nervous system */
,
        case
            when d.drg_code between 1
            and 35 then 1
            when d.drg_code = 524 then 1
            when d.drg_code between 528
            and 534 then 1
            when d.drg_code = 543 then 1
            when d.drg_code between 559
            and 564 then 1
            when d.drg_code = 577 then 1
            else 0
        end as nervdrg
        /* Cerebrovascular */
,
        case
            when d.drg_code = 5 then 1
            when d.drg_code between 14
            and 17 then 1
            when d.drg_code = 524 then 1
            when d.drg_code = 528 then 1
            when d.drg_code between 533
            and 534 then 1
            when d.drg_code = 577 then 1
            else 0
        end as ceredrg
        /* COPD asthma */
,
        case
            when d.drg_code = 88 then 1
            when d.drg_code between 96
            and 98 then 1
            else 0
        end as pulmdrg
        /* Diabetes */
,
        case
            when d.drg_code = 294 then 1
            when d.drg_code = 295 then 1
            else 0
        end as diabdrg
        /* Thyroid endocrine */
,
        case
            when d.drg_code = 290 then 1
            when d.drg_code = 300 then 1
            when d.drg_code = 301 then 1
            else 0
        end as hypodrg
        /* Kidney transp, renal fail/dialysis */
,
        case
            when d.drg_code = 302 then 1
            when d.drg_code = 316 then 1
            when d.drg_code = 317 then 1
            else 0
        end as renfdrg
        /* Liver */
,
        case
            when d.drg_code between 199
            and 202 then 1
            when d.drg_code between 205
            and 208 then 1
            else 0
        end as liverdrg
        /* GI hemorrhage or ulcer */
,
        case
            when d.drg_code between 174
            and 178 then 1
            else 0
        end as ulcedrg
        /* Human immunodeficiency virus */
,
        case
            when d.drg_code = 488 then 1
            when d.drg_code = 489 then 1
            when d.drg_code = 490 then 1
            else 0
        end as hivdrg
        /* Leukemia/lymphoma */
,
        case
            when d.drg_code between 400
            and 414 then 1
            when d.drg_code = 473 then 1
            when d.drg_code = 492 then 1
            when d.drg_code between 539
            and 540 then 1
            else 0
        end as leukdrg
        /* Cancer, lymphoma */
,
        case
            when d.drg_code = 10 then 1
            when d.drg_code = 11 then 1
            when d.drg_code = 64 then 1
            when d.drg_code = 82 then 1
            when d.drg_code = 172 then 1
            when d.drg_code = 173 then 1
            when d.drg_code = 199 then 1
            when d.drg_code = 203 then 1
            when d.drg_code = 239 then 1
            when d.drg_code between 257
            and 260 then 1
            when d.drg_code = 274 then 1
            when d.drg_code = 275 then 1
            when d.drg_code = 303 then 1
            when d.drg_code = 318 then 1
            when d.drg_code = 319 then 1
            when d.drg_code = 338 then 1
            when d.drg_code = 344 then 1
            when d.drg_code = 346 then 1
            when d.drg_code = 347 then 1
            when d.drg_code = 354 then 1
            when d.drg_code = 355 then 1
            when d.drg_code = 357 then 1
            when d.drg_code = 363 then 1
            when d.drg_code = 366 then 1
            when d.drg_code = 367 then 1
            when d.drg_code between 406
            and 414 then 1
            else 0
        end as cancdrg
        /* Connective tissue */
,
        case
            when d.drg_code = 240 then 1
            when d.drg_code = 241 then 1
            else 0
        end as arthdrg
        /* Nutrition/metabolic */
,
        case
            when d.drg_code between 296
            and 298 then 1
            else 0
        end as nutrdrg
        /* Anemia */
,
        case
            when d.drg_code = 395 then 1
            when d.drg_code = 396 then 1
            when d.drg_code = 574 then 1
            else 0
        end as anemdrg
        /* Alcohol drug */
,
        case
            when d.drg_code between 433
            and 437 then 1
            when d.drg_code between 521
            and 523 then 1
            else 0
        end as alcdrg
        /* Coagulation disorders */
,
        case
            when d.drg_code = 397 then 1
            else 0
        end as coagdrg
        /* Hypertensive Complicated */
,
        case
            when d.drg_code = 22 then 1
            when d.drg_code = 134 then 1
            else 0
        end as htncxdrg
        /* Hypertensive Uncomplicated */
,
        case
            when d.drg_code = 134 then 1
            else 0
        end as htndrg
        /* Psychoses */
,
        case
            when d.drg_code = 430 then 1
            else 0
        end as psydrg
        /* Obesity */
,
        case
            when d.drg_code = 288 then 1
            else 0
        end as obesedrg
        /* Depressive Neuroses */
,
        case
            when d.drg_code = 426 then 1
            else 0
        end as deprsdrg
    from
        (
            select
                hadm_id,
                drg_type,
                cast(drg_code as numeric) as drg_code
            from
                drgcodes
            where
                drg_type = 'HCFA'
        ) d
) -- merge DRG groups together
,
drggrp as (
    select
        hadm_id,
        max(carddrg) as carddrg,
        max(peridrg) as peridrg,
        max(renaldrg) as renaldrg,
        max(nervdrg) as nervdrg,
        max(ceredrg) as ceredrg,
        max(pulmdrg) as pulmdrg,
        max(diabdrg) as diabdrg,
        max(hypodrg) as hypodrg,
        max(renfdrg) as renfdrg,
        max(liverdrg) as liverdrg,
        max(ulcedrg) as ulcedrg,
        max(hivdrg) as hivdrg,
        max(leukdrg) as leukdrg,
        max(cancdrg) as cancdrg,
        max(arthdrg) as arthdrg,
        max(nutrdrg) as nutrdrg,
        max(anemdrg) as anemdrg,
        max(alcdrg) as alcdrg,
        max(coagdrg) as coagdrg,
        max(htncxdrg) as htncxdrg,
        max(htndrg) as htndrg,
        max(psydrg) as psydrg,
        max(obesedrg) as obesedrg,
        max(deprsdrg) as deprsdrg
    from
        (
            select
                d1.*
            from
                msdrg d1
            UNION
            DISTINCT
            select
                d1.*
            from
                hcfadrg d1
        ) d
    group by
        d.hadm_id
) -- now merge these flags together to define elixhauser
-- most are straightforward.. but hypertension flags are a bit more complicated
select
    adm.subject_id,
    adm.hadm_id,
    case
        when carddrg = 1 then 0 -- DRG filter
        when chf = 1 then 1
        when htnwchf = 1 then 1
        when hhrwchf = 1 then 1
        when hhrwhrf = 1 then 1
        else 0
    end as congestive_heart_failure,
    case
        when carddrg = 1 then 0 -- DRG filter
        when arythm = 1 then 1
        else 0
    end as cardiac_arrhythmias,
    case
        when carddrg = 1 then 0
        when valve = 1 then 1
        else 0
    end as valvular_disease,
    case
        when carddrg = 1
        or pulmdrg = 1 then 0
        when pulmcirc = 1 then 1
        else 0
    end as pulmonary_circulation,
    case
        when peridrg = 1 then 0
        when perivasc = 1 then 1
        else 0
    end as peripheral_vascular -- we combine 'htn' and 'htncx' into 'HYPERTENSION'
    -- note 'htn' (hypertension) is only 1 if 'htncx' (complicated hypertension) is 0
    -- also if htncxdrg = 1, then htndrg = 1
    -- In the original Sas code, it appears that:
    --  HTN can be 1
    --  HTNCX is set to 0 by DRGs
    --  but HTN_C is still 1, because HTN is 1
    -- so we have to do this complex addition.
,
    case
        when (
            -- first hypertension
            case
                when htndrg = 0 then 0
                when htn = 1 then 1
                else 0
            end
        ) + (
            -- next complicated hypertension
            case
                when htncx = 1
                and htncxdrg = 1 then 0
                when htnpreg = 1
                and htncxdrg = 1 then 0
                when htnwochf = 1
                and (
                    htncxdrg = 1
                    OR carddrg = 1
                ) then 0
                when htnwchf = 1
                and htncxdrg = 1 then 0
                when htnwchf = 1
                and carddrg = 1 then 0
                when hrenworf = 1
                and (
                    htncxdrg = 1
                    or renaldrg = 1
                ) then 0
                when hrenwrf = 1
                and htncxdrg = 1 then 0
                when hrenwrf = 1
                and renaldrg = 1 then 0
                when hhrwohrf = 1
                and (
                    htncxdrg = 1
                    or carddrg = 1
                    or renaldrg = 1
                ) then 0
                when hhrwchf = 1
                and (
                    htncxdrg = 1
                    or carddrg = 1
                    or renaldrg = 1
                ) then 0
                when hhrwrf = 1
                and (
                    htncxdrg = 1
                    or carddrg = 1
                    or renaldrg = 1
                ) then 0
                when hhrwhrf = 1
                and (
                    htncxdrg = 1
                    or carddrg = 1
                    or renaldrg = 1
                ) then 0
                when ohtnpreg = 1
                and (
                    htncxdrg = 1
                    or carddrg = 1
                    or renaldrg = 1
                ) then 0
                when htncx = 1 then 1
                when htnpreg = 1 then 1
                when htnwochf = 1 then 1
                when htnwchf = 1 then 1
                when hrenworf = 1 then 1
                when hrenwrf = 1 then 1
                when hhrwohrf = 1 then 1
                when hhrwchf = 1 then 1
                when hhrwrf = 1 then 1
                when hhrwhrf = 1 then 1
                when ohtnpreg = 1 then 1
                else 0
            end
        ) > 0 then 1
        else 0
    end as hypertension,
    case
        when ceredrg = 1 then 0
        when para = 1 then 1
        else 0
    end as paralysis,
    case
        when nervdrg = 1 then 0
        when neuro = 1 then 1
        else 0
    end as other_neurological,
    case
        when pulmdrg = 1 then 0
        when chrnlung = 1 then 1
        else 0
    end as chronic_pulmonary,
    case
        -- only the more severe comorbidity (complicated diabetes) is kept
        when diabdrg = 1 then 0
        when dmcx = 1 then 0
        when dm = 1 then 1
        else 0
    end as diabetes_uncomplicated,
    case
        when diabdrg = 1 then 0
        when dmcx = 1 then 1
        else 0
    end as diabetes_complicated,
    case
        when hypodrg = 1 then 0
        when hypothy = 1 then 1
        else 0
    end as hypothyroidism,
    case
        when renaldrg = 1 then 0
        when renlfail = 1 then 1
        when hrenwrf = 1 then 1
        when hhrwrf = 1 then 1
        when hhrwhrf = 1 then 1
        else 0
    end as renal_failure,
    case
        when liverdrg = 1 then 0
        when liver = 1 then 1
        else 0
    end as liver_disease,
    case
        when ulcedrg = 1 then 0
        when ulcer = 1 then 1
        else 0
    end as peptic_ulcer,
    case
        when hivdrg = 1 then 0
        when aids = 1 then 1
        else 0
    end as aids,
    case
        when leukdrg = 1 then 0
        when lymph = 1 then 1
        else 0
    end as lymphoma,
    case
        when cancdrg = 1 then 0
        when mets = 1 then 1
        else 0
    end as metastatic_cancer,
    case
        when cancdrg = 1 then 0 -- only the more severe comorbidity (metastatic cancer) is kept
        when mets = 1 then 0
        when tumor = 1 then 1
        else 0
    end as solid_tumor,
    case
        when arthdrg = 1 then 0
        when arth = 1 then 1
        else 0
    end as rheumatoid_arthritis,
    case
        when coagdrg = 1 then 0
        when coag = 1 then 1
        else 0
    end as coagulopathy,
    case
        when nutrdrg = 1
        OR obesedrg = 1 then 0
        when obese = 1 then 1
        else 0
    end as obesity,
    case
        when nutrdrg = 1 then 0
        when wghtloss = 1 then 1
        else 0
    end as weight_loss,
    case
        when nutrdrg = 1 then 0
        when lytes = 1 then 1
        else 0
    end as fluid_electrolyte,
    case
        when anemdrg = 1 then 0
        when bldloss = 1 then 1
        else 0
    end as blood_loss_anemia,
    case
        when anemdrg = 1 then 0
        when anemdef = 1 then 1
        else 0
    end as deficiency_anemias,
    case
        when alcdrg = 1 then 0
        when alcohol = 1 then 1
        else 0
    end as alcohol_abuse,
    case
        when alcdrg = 1 then 0
        when drug = 1 then 1
        else 0
    end as drug_abuse,
    case
        when psydrg = 1 then 0
        when psych = 1 then 1
        else 0
    end as psychoses,
    case
        when deprsdrg = 1 then 0
        when depress = 1 then 1
        else 0
    end as depression
FROM
    admissions adm
    left join eligrp eli on adm.hadm_id = eli.hadm_id
    left join drggrp d on adm.hadm_id = d.hadm_id
order by
    adm.hadm_id
  );",109348,Thread-1,2022-07-18T00:10:21.703900Z
E017,,debug,SQL status: SELECT 58976 in 1.73 seconds,109348,Thread-1,2022-07-18T00:10:23.429645Z
E015,,debug,"Using postgres connection ""model.mimic.elixhauser_ahrq_v37""",109348,Thread-1,2022-07-18T00:10:23.435271Z
E016,,debug,"On model.mimic.elixhauser_ahrq_v37: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.elixhauser_ahrq_v37""} */
alter table ""postgres"".""public"".""elixhauser_ahrq_v37"" rename to ""elixhauser_ahrq_v37__dbt_backup""",109348,Thread-1,2022-07-18T00:10:23.435507Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:23.436690Z
E015,,debug,"Using postgres connection ""model.mimic.elixhauser_ahrq_v37""",109348,Thread-1,2022-07-18T00:10:23.440432Z
E016,,debug,"On model.mimic.elixhauser_ahrq_v37: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.elixhauser_ahrq_v37""} */
alter table ""postgres"".""public"".""elixhauser_ahrq_v37__dbt_tmp"" rename to ""elixhauser_ahrq_v37""",109348,Thread-1,2022-07-18T00:10:23.440650Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:23.441389Z
E018,,debug,On model.mimic.elixhauser_ahrq_v37: COMMIT,109348,Thread-1,2022-07-18T00:10:23.444262Z
E015,,debug,"Using postgres connection ""model.mimic.elixhauser_ahrq_v37""",109348,Thread-1,2022-07-18T00:10:23.444479Z
E016,,debug,On model.mimic.elixhauser_ahrq_v37: COMMIT,109348,Thread-1,2022-07-18T00:10:23.444748Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:23.447672Z
E015,,debug,"Using postgres connection ""model.mimic.elixhauser_ahrq_v37""",109348,Thread-1,2022-07-18T00:10:23.450752Z
E016,,debug,"On model.mimic.elixhauser_ahrq_v37: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.elixhauser_ahrq_v37""} */
drop table if exists ""postgres"".""public"".""elixhauser_ahrq_v37__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:23.450993Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:23.454301Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:23.457032Z
E010,,debug,On model.mimic.elixhauser_ahrq_v37: Close,109348,Thread-1,2022-07-18T00:10:23.457272Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7c4c3ecd-5c14-4600-9281-0e21ba30ba00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3f8ab5d700>]}",109348,Thread-1,2022-07-18T00:10:23.458180Z
Q012,1,info,20 of 107 OK created table model public.elixhauser_ahrq_v37 .................... [[32mSELECT 58976[0m in 1.79s],109348,Thread-1,2022-07-18T00:10:23.458682Z,table,null,elixhauser_ahrq_v37,comorbidity/elixhauser_ahrq_v37.sql,2022-07-18T00:10:21.670827,compiling,model,,,
Q024,1.7851479053497314,debug,Finished running node model.mimic.elixhauser_ahrq_v37,109348,Thread-1,2022-07-18T00:10:23.459314Z,table,2022-07-18T00:10:23.459146,elixhauser_ahrq_v37,comorbidity/elixhauser_ahrq_v37.sql,2022-07-18T00:10:21.670827,success,model,,,
Q023,,debug,Began running node model.mimic.elixhauser_ahrq_v37_no_drg,109348,Thread-1,2022-07-18T00:10:23.460056Z,table,null,elixhauser_ahrq_v37_no_drg,comorbidity/elixhauser_ahrq_v37_no_drg.sql,2022-07-18T00:10:23.459906,started,model,,,
Q033,,info,21 of 107 START table model public.elixhauser_ahrq_v37_no_drg .................. [RUN],109348,Thread-1,2022-07-18T00:10:23.460857Z,table,null,elixhauser_ahrq_v37_no_drg,comorbidity/elixhauser_ahrq_v37_no_drg.sql,2022-07-18T00:10:23.459906,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.elixhauser_ahrq_v37_no_drg""",109348,Thread-1,2022-07-18T00:10:23.462312Z
Q030,,debug,Began compiling node model.mimic.elixhauser_ahrq_v37_no_drg,109348,Thread-1,2022-07-18T00:10:23.462691Z,table,null,elixhauser_ahrq_v37_no_drg,comorbidity/elixhauser_ahrq_v37_no_drg.sql,2022-07-18T00:10:23.459906,compiling,model,,,
Q027,,debug,Compiling model.mimic.elixhauser_ahrq_v37_no_drg,109348,Thread-1,2022-07-18T00:10:23.462989Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.elixhauser_ahrq_v37_no_drg""",109348,Thread-1,2022-07-18T00:10:23.467209Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:23.468212Z
Q031,,debug,Began executing node model.mimic.elixhauser_ahrq_v37_no_drg,109348,Thread-1,2022-07-18T00:10:23.468597Z,table,null,elixhauser_ahrq_v37_no_drg,comorbidity/elixhauser_ahrq_v37_no_drg.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.elixhauser_ahrq_v37_no_drg""",109348,Thread-1,2022-07-18T00:10:23.480309Z
E015,,debug,"Using postgres connection ""model.mimic.elixhauser_ahrq_v37_no_drg""",109348,Thread-1,2022-07-18T00:10:23.481076Z
E016,,debug,On model.mimic.elixhauser_ahrq_v37_no_drg: BEGIN,109348,Thread-1,2022-07-18T00:10:23.481312Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:23.481425Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:23.487765Z
E015,,debug,"Using postgres connection ""model.mimic.elixhauser_ahrq_v37_no_drg""",109348,Thread-1,2022-07-18T00:10:23.488604Z
E016,,debug,"On model.mimic.elixhauser_ahrq_v37_no_drg: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.elixhauser_ahrq_v37_no_drg""} */


  create  table ""postgres"".""public"".""elixhauser_ahrq_v37_no_drg__dbt_tmp""
  as (
    -- This code uses the latest version of Elixhauser provided by AHRQ
-- However, it does *not* filter based on diagnosis related groups (DRGs)
-- As such, ""comorbidities"" identified are more likely to be associated with the primary reason for their hospital stay

-- The code:
--  removes ""primary"" ICD9_CODE (seq_num != 1)
--  uses AHRQ published rules to define comorbidities
 

with
eliflg as
(
select hadm_id, seq_num, icd9_code
-- note that these codes will seem incomplete at first
-- for example, CHF is missing a lot of codes referenced in the literature (402.11, 402.91, etc)
-- these codes are captured by hypertension flags instead
-- later there are some complicated rules which confirm/reject those codes as chf
, CASE
  when icd9_code = '39891' then 1
  when icd9_code between '4280' and '4289' then 1
		end as chf       /* Congestive heart failure */

-- cardiac arrhythmias is removed in up to date versions
, case
    when icd9_code = '42610' then 1
    when icd9_code = '42611' then 1
    when icd9_code = '42613' then 1
    when icd9_code between '4262' and '42653' then 1
    when icd9_code between '4266' and '42689' then 1
    when icd9_code = '4270' then 1
    when icd9_code = '4272' then 1
    when icd9_code = '42731' then 1
    when icd9_code = '42760' then 1
    when icd9_code = '4279' then 1
    when icd9_code = '7850' then 1
    when icd9_code between 'V450' and 'V4509' then 1
    when icd9_code between 'V533' and 'V5339' then 1
  end as arythm /* Cardiac arrhythmias */

, CASE
  when icd9_code between '09320' and '09324' then 1
  when icd9_code between '3940' and '3971' then 1
  when icd9_code = '3979' then 1
  when icd9_code between '4240' and '42499' then 1
  when icd9_code between '7463' and '7466' then 1
  when icd9_code = 'V422' then 1
  when icd9_code = 'V433' then 1
		end as valve     /* Valvular disease */

, CASE
  when icd9_code between '41511' and '41519' then 1
  when icd9_code between '4160' and '4169' then 1
  when icd9_code = '4179' then 1
		end as pulmcirc  /* Pulmonary circulation disorder */

, CASE
  when icd9_code between '4400' and '4409' then 1
  when icd9_code between '44100' and '4419' then 1
  when icd9_code between '4420' and '4429' then 1
  when icd9_code between '4431' and '4439' then 1
  when icd9_code between '44421' and '44422' then 1
  when icd9_code = '4471' then 1
  when icd9_code = '449' then 1
  when icd9_code = '5571' then 1
  when icd9_code = '5579' then 1
  when icd9_code = 'V434' then 1
		end as perivasc  /* Peripheral vascular disorder */

, CASE
  when icd9_code = '4011' then 1
  when icd9_code = '4019' then 1
  when icd9_code between '64200' and '64204' then 1
		end as htn       /* Hypertension, uncomplicated */

, CASE
  when icd9_code = '4010' then 1
  when icd9_code = '4372' then 1
		end as htncx     /* Hypertension, complicated */


      /******************************************************************/
      /* The following are special, temporary formats used in the       */
      /* creation of the hypertension complicated comorbidity when      */
      /* overlapping with congestive heart failure or renal failure     */
      /* occurs. These temporary formats are referenced in the program  */
      /* called comoanaly2009.txt.                                      */
      /******************************************************************/
, CASE
  when icd9_code between '64220' and '64224' then 1
		end as htnpreg   /* Pre-existing hypertension complicating pregnancy */

, CASE
  when icd9_code = '40200' then 1
  when icd9_code = '40210' then 1
  when icd9_code = '40290' then 1
  when icd9_code = '40509' then 1
  when icd9_code = '40519' then 1
  when icd9_code = '40599'         then 1
		end as htnwochf  /* Hypertensive heart disease without heart failure */

, CASE
  when icd9_code = '40201' then 1
  when icd9_code = '40211' then 1
  when icd9_code = '40291'         then 1
		end as htnwchf   /* Hypertensive heart disease with heart failure */

, CASE
  when icd9_code = '40300' then 1
  when icd9_code = '40310' then 1
  when icd9_code = '40390' then 1
  when icd9_code = '40501' then 1
  when icd9_code = '40511' then 1
  when icd9_code = '40591' then 1
  when icd9_code between '64210' and '64214' then 1
		end as hrenworf  /* Hypertensive renal disease without renal failure */

, CASE
  when icd9_code = '40301' then 1
  when icd9_code = '40311' then 1
  when icd9_code = '40391'         then 1
		end as hrenwrf   /* Hypertensive renal disease with renal failure */

, CASE
  when icd9_code = '40400' then 1
  when icd9_code = '40410' then 1
  when icd9_code = '40490'         then 1
		end as hhrwohrf  /* Hypertensive heart and renal disease without heart or renal failure */

, CASE
  when icd9_code = '40401' then 1
  when icd9_code = '40411' then 1
  when icd9_code = '40491'         then 1
		end as hhrwchf   /* Hypertensive heart and renal disease with heart failure */

, CASE
  when icd9_code = '40402' then 1
  when icd9_code = '40412' then 1
  when icd9_code = '40492'         then 1
		end as hhrwrf    /* Hypertensive heart and renal disease with renal failure */

, CASE
  when icd9_code = '40403' then 1
  when icd9_code = '40413' then 1
  when icd9_code = '40493'         then 1
		end as hhrwhrf   /* Hypertensive heart and renal disease with heart and renal failure */

, CASE
  when icd9_code between '64270' and '64274' then 1
  when icd9_code between '64290' and '64294' then 1
		end as ohtnpreg  /* Other hypertension in pregnancy */

      /******************** End Temporary Formats ***********************/

, CASE
  when icd9_code between '3420' and '3449' then 1
  when icd9_code between '43820' and '43853' then 1
  when icd9_code = '78072'         then 1
		end as para      /* Paralysis */

, CASE
  when icd9_code between '3300' and '3319' then 1
  when icd9_code = '3320' then 1
  when icd9_code = '3334' then 1
  when icd9_code = '3335' then 1
  when icd9_code = '3337' then 1
  when icd9_code in ('33371','33372','33379','33385','33394') then 1
  when icd9_code between '3340' and '3359' then 1
  when icd9_code = '3380' then 1
  when icd9_code = '340' then 1
  when icd9_code between '3411' and '3419' then 1
  when icd9_code between '34500' and '34511' then 1
  when icd9_code between '3452' and '3453' then 1
  when icd9_code between '34540' and '34591' then 1
  when icd9_code between '34700' and '34701' then 1
  when icd9_code between '34710' and '34711' then 1
  when icd9_code = '3483' then 1 -- discontinued icd-9
  when icd9_code between '64940' and '64944' then 1
  when icd9_code = '7687' then 1
  when icd9_code between '76870' and '76873' then 1
  when icd9_code = '7803' then 1
  when icd9_code = '78031' then 1
  when icd9_code = '78032' then 1
  when icd9_code = '78033' then 1
  when icd9_code = '78039' then 1
  when icd9_code = '78097' then 1
  when icd9_code = '7843'         then 1
		end as neuro     /* Other neurological */

, CASE
  when icd9_code between '490' and '4928' then 1
  when icd9_code between '49300' and '49392' then 1
  when icd9_code between '494' and '4941' then 1
  when icd9_code between '4950' and '505' then 1
  when icd9_code = '5064'         then 1
		end as chrnlung  /* Chronic pulmonary disease */

, CASE
  when icd9_code between '25000' and '25033' then 1
  when icd9_code between '64800' and '64804' then 1
  when icd9_code between '24900' and '24931' then 1
		end as dm        /* Diabetes w/o chronic complications*/

, CASE
  when icd9_code between '25040' and '25093' then 1
  when icd9_code = '7751' then 1
  when icd9_code between '24940' and '24991' then 1
		end as dmcx      /* Diabetes w/ chronic complications */

, CASE
  when icd9_code between '243' and '2442' then 1
  when icd9_code = '2448' then 1
  when icd9_code = '2449'         then 1
		end as hypothy   /* Hypothyroidism */

, CASE
  when icd9_code = '585' then 1 -- discontinued code
  when icd9_code = '5853' then 1
  when icd9_code = '5854' then 1
  when icd9_code = '5855' then 1
  when icd9_code = '5856' then 1
  when icd9_code = '5859' then 1
  when icd9_code = '586' then 1
  when icd9_code = 'V420' then 1
  when icd9_code = 'V451' then 1
  when icd9_code between 'V560' and 'V5632' then 1
  when icd9_code = 'V568' then 1
  when icd9_code between 'V4511' and 'V4512' then 1
		end as renlfail  /* Renal failure */

, CASE
  when icd9_code = '07022' then 1
  when icd9_code = '07023' then 1
  when icd9_code = '07032' then 1
  when icd9_code = '07033' then 1
  when icd9_code = '07044' then 1
  when icd9_code = '07054' then 1
  when icd9_code = '4560' then 1
  when icd9_code = '4561' then 1
  when icd9_code = '45620' then 1
  when icd9_code = '45621' then 1
  when icd9_code = '5710' then 1
  when icd9_code = '5712' then 1
  when icd9_code = '5713' then 1
  when icd9_code between '57140' and '57149' then 1
  when icd9_code = '5715' then 1
  when icd9_code = '5716' then 1
  when icd9_code = '5718' then 1
  when icd9_code = '5719' then 1
  when icd9_code = '5723' then 1
  when icd9_code = '5728' then 1
  when icd9_code = '5735' then 1
  when icd9_code = 'V427'         then 1
		end as liver     /* Liver disease */

, CASE
  when icd9_code = '53141' then 1
  when icd9_code = '53151' then 1
  when icd9_code = '53161' then 1
  when icd9_code = '53170' then 1
  when icd9_code = '53171' then 1
  when icd9_code = '53191' then 1
  when icd9_code = '53241' then 1
  when icd9_code = '53251' then 1
  when icd9_code = '53261' then 1
  when icd9_code = '53270' then 1
  when icd9_code = '53271' then 1
  when icd9_code = '53291' then 1
  when icd9_code = '53341' then 1
  when icd9_code = '53351' then 1
  when icd9_code = '53361' then 1
  when icd9_code = '53370' then 1
  when icd9_code = '53371' then 1
  when icd9_code = '53391' then 1
  when icd9_code = '53441' then 1
  when icd9_code = '53451' then 1
  when icd9_code = '53461' then 1
  when icd9_code = '53470' then 1
  when icd9_code = '53471' then 1
  when icd9_code = '53491'         then 1
		end as ulcer     /* Chronic Peptic ulcer disease (includes bleeding only if obstruction is also present) */

, CASE
  when icd9_code between '042' and '0449' then 1
		end as aids      /* HIV and AIDS */

, CASE
  when icd9_code between '20000' and '20238' then 1
  when icd9_code between '20250' and '20301' then 1
  when icd9_code = '2386' then 1
  when icd9_code = '2733' then 1
  when icd9_code between '20302' and '20382' then 1
		end as lymph     /* Lymphoma */

, CASE
  when icd9_code between '1960' and '1991' then 1
  when icd9_code between '20970' and '20975' then 1
  when icd9_code = '20979' then 1
  when icd9_code = '78951'         then 1
		end as mets      /* Metastatic cancer */

, CASE
  when icd9_code between '1400' and '1729' then 1
  when icd9_code between '1740' and '1759' then 1
  when icd9_code between '179' and '1958' then 1
  when icd9_code between '20900' and '20924' then 1
  when icd9_code between '20925' and '2093' then 1
  when icd9_code between '20930' and '20936' then 1
  when icd9_code between '25801' and '25803' then 1
		end as tumor     /* Solid tumor without metastasis */

, CASE
  when icd9_code = '7010' then 1
  when icd9_code between '7100' and '7109' then 1
  when icd9_code between '7140' and '7149' then 1
  when icd9_code between '7200' and '7209' then 1
  when icd9_code = '725' then 1
		end as arth              /* Rheumatoid arthritis/collagen vascular diseases */

, CASE
  when icd9_code between '2860' and '2869' then 1
  when icd9_code = '2871' then 1
  when icd9_code between '2873' and '2875' then 1
  when icd9_code between '64930' and '64934' then 1
  when icd9_code = '28984'         then 1
		end as coag      /* Coagulation deficiency */

, CASE
  when icd9_code = '2780' then 1
  when icd9_code = '27800' then 1
  when icd9_code = '27801' then 1
  when icd9_code = '27803' then 1
  when icd9_code between '64910' and '64914' then 1
  when icd9_code between 'V8530' and 'V8539' then 1
  when icd9_code = 'V854' then 1 -- hierarchy used for AHRQ v3.6 and earlier
  when icd9_code between 'V8541' and 'V8545' then 1
  when icd9_code = 'V8554' then 1
  when icd9_code = '79391'         then 1
		end as obese     /* Obesity      */

, CASE
  when icd9_code between '260' and '2639' then 1
  when icd9_code between '78321' and '78322' then 1
		end as wghtloss  /* Weight loss */

, CASE
  when icd9_code between '2760' and '2769' then 1
		end as lytes     /* Fluid and electrolyte disorders - note:
                                      this comorbidity should be dropped when
                                      used with the AHRQ Patient Safety Indicators*/
, CASE
  when icd9_code = '2800' then 1
  when icd9_code between '64820' and '64824' then 1
		end as bldloss   /* Blood loss anemia */

, CASE
  when icd9_code between '2801' and '2819' then 1
  when icd9_code between '28521' and '28529' then 1
  when icd9_code = '2859'         then 1
		end as anemdef  /* Deficiency anemias */

, CASE
  when icd9_code between '2910' and '2913' then 1
  when icd9_code = '2915' then 1
  when icd9_code = '2918' then 1
  when icd9_code = '29181' then 1
  when icd9_code = '29182' then 1
  when icd9_code = '29189' then 1
  when icd9_code = '2919' then 1
  when icd9_code between '30300' and '30393' then 1
  when icd9_code between '30500' and '30503' then 1
		end as alcohol   /* Alcohol abuse */

, CASE
  when icd9_code = '2920' then 1
  when icd9_code between '29282' and '29289' then 1
  when icd9_code = '2929' then 1
  when icd9_code between '30400' and '30493' then 1
  when icd9_code between '30520' and '30593' then 1
  when icd9_code between '64830' and '64834' then 1
		end as drug      /* Drug abuse */

, CASE
  when icd9_code between '29500' and '2989' then 1
  when icd9_code = '29910' then 1
  when icd9_code = '29911'         then 1
		end as psych    /* Psychoses */

, CASE
  when icd9_code = '3004' then 1
  when icd9_code = '30112' then 1
  when icd9_code = '3090' then 1
  when icd9_code = '3091' then 1
  when icd9_code = '311'         then 1
		end as depress  /* Depression */
from diagnoses_icd icd
WHERE seq_num = 1
)
-- collapse the icd9_code specific flags into hadm_id specific flags
-- this groups comorbidities together for a single patient admission
, eligrp as
(
  select hadm_id
  , max(chf) as chf
  , max(arythm) as arythm
  , max(valve) as valve
  , max(pulmcirc) as pulmcirc
  , max(perivasc) as perivasc
  , max(htn) as htn
  , max(htncx) as htncx
  , max(htnpreg) as htnpreg
  , max(htnwochf) as htnwochf
  , max(htnwchf) as htnwchf
  , max(hrenworf) as hrenworf
  , max(hrenwrf) as hrenwrf
  , max(hhrwohrf) as hhrwohrf
  , max(hhrwchf) as hhrwchf
  , max(hhrwrf) as hhrwrf
  , max(hhrwhrf) as hhrwhrf
  , max(ohtnpreg) as ohtnpreg
  , max(para) as para
  , max(neuro) as neuro
  , max(chrnlung) as chrnlung
  , max(dm) as dm
  , max(dmcx) as dmcx
  , max(hypothy) as hypothy
  , max(renlfail) as renlfail
  , max(liver) as liver
  , max(ulcer) as ulcer
  , max(aids) as aids
  , max(lymph) as lymph
  , max(mets) as mets
  , max(tumor) as tumor
  , max(arth) as arth
  , max(coag) as coag
  , max(obese) as obese
  , max(wghtloss) as wghtloss
  , max(lytes) as lytes
  , max(bldloss) as bldloss
  , max(anemdef) as anemdef
  , max(alcohol) as alcohol
  , max(drug) as drug
  , max(psych) as psych
  , max(depress) as depress
from eliflg
group by hadm_id
)
-- now merge these flags together to define elixhauser
-- most are straightforward.. but hypertension flags are a bit more complicated
select adm.subject_id, adm.hadm_id
, case
    when chf     = 1 then 1
    when htnwchf = 1 then 1
    when hhrwchf = 1 then 1
    when hhrwhrf = 1 then 1
  else 0 end as congestive_heart_failure
, case
    when arythm = 1 then 1
  else 0 end as cardiac_arrhythmias
, case when    valve = 1 then 1 else 0 end as valvular_disease
, case when pulmcirc = 1 then 1 else 0 end as pulmonary_circulation
, case when perivasc = 1 then 1 else 0 end as peripheral_vascular

-- we combine ""htn"" and ""htncx"" into ""HYPERTENSION""
-- note ""htn"" (hypertension) is only 1 if ""htncx"" (complicated hypertension) is 0
-- this matters if you filter on DRG but for this query we can just merge them immediately
, case
    when htn = 1 then 1
    when htncx = 1 then 1
    when htnpreg = 1 then 1
    when htnwochf = 1 then 1
    when htnwchf = 1 then 1
    when hrenworf = 1 then 1
    when hrenwrf = 1 then 1
    when hhrwohrf = 1 then 1
    when hhrwchf = 1 then 1
    when hhrwrf = 1 then 1
    when hhrwhrf = 1 then 1
    when ohtnpreg = 1 then 1
  else 0 end as hypertension

, case when para      = 1 then 1 else 0 end as paralysis
, case when neuro     = 1 then 1 else 0 end as other_neurological
, case when chrnlung  = 1 then 1 else 0 end as chronic_pulmonary
, case
    -- only the more severe comorbidity (complicated diabetes) is kept
    when dmcx = 1 then 0
    when dm = 1 then 1
  else 0 end as diabetes_uncomplicated
, case when dmcx    = 1 then 1 else 0 end as diabetes_complicated
, case when hypothy = 1 then 1 else 0 end as hypothyroidism
, case
    when renlfail = 1 then 1
    when hrenwrf  = 1 then 1
    when hhrwrf   = 1 then 1
    when hhrwhrf  = 1 then 1
  else 0 end as renal_failure

, case when liver = 1 then 1 else 0 end as liver_disease
, case when ulcer = 1 then 1 else 0 end as peptic_ulcer
, case when aids = 1 then 1 else 0 end as aids
, case when lymph = 1 then 1 else 0 end as lymphoma
, case when mets = 1 then 1 else 0 end as metastatic_cancer
, case
    -- only the more severe comorbidity (metastatic cancer) is kept
    when mets = 1 then 0
    when tumor = 1 then 1
  else 0 end as solid_tumor
, case when arth = 1 then 1 else 0 end as rheumatoid_arthritis
, case when coag = 1 then 1 else 0 end as coagulopathy
, case when obese = 1 then 1 else 0 end as obesity
, case when wghtloss = 1 then 1 else 0 end as weight_loss
, case when lytes = 1 then 1 else 0 end as fluid_electrolyte
, case when bldloss = 1 then 1 else 0 end as blood_loss_anemia
, case when anemdef = 1 then 1 else 0 end as deficiency_anemias
, case when alcohol = 1 then 1 else 0 end as alcohol_abuse
, case when drug = 1 then 1 else 0 end as drug_abuse
, case when psych = 1 then 1 else 0 end as psychoses
, case when depress = 1 then 1 else 0 end as depression

FROM admissions adm
left join eligrp eli
  on adm.hadm_id = eli.hadm_id
order by adm.hadm_id
  );",109348,Thread-1,2022-07-18T00:10:23.489132Z
E017,,debug,SQL status: SELECT 58976 in 0.5 seconds,109348,Thread-1,2022-07-18T00:10:23.991863Z
E015,,debug,"Using postgres connection ""model.mimic.elixhauser_ahrq_v37_no_drg""",109348,Thread-1,2022-07-18T00:10:23.998744Z
E016,,debug,"On model.mimic.elixhauser_ahrq_v37_no_drg: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.elixhauser_ahrq_v37_no_drg""} */
alter table ""postgres"".""public"".""elixhauser_ahrq_v37_no_drg"" rename to ""elixhauser_ahrq_v37_no_drg__dbt_backup""",109348,Thread-1,2022-07-18T00:10:23.999167Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:24.000779Z
E015,,debug,"Using postgres connection ""model.mimic.elixhauser_ahrq_v37_no_drg""",109348,Thread-1,2022-07-18T00:10:24.004973Z
E016,,debug,"On model.mimic.elixhauser_ahrq_v37_no_drg: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.elixhauser_ahrq_v37_no_drg""} */
alter table ""postgres"".""public"".""elixhauser_ahrq_v37_no_drg__dbt_tmp"" rename to ""elixhauser_ahrq_v37_no_drg""",109348,Thread-1,2022-07-18T00:10:24.005198Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:24.005969Z
E018,,debug,On model.mimic.elixhauser_ahrq_v37_no_drg: COMMIT,109348,Thread-1,2022-07-18T00:10:24.009153Z
E015,,debug,"Using postgres connection ""model.mimic.elixhauser_ahrq_v37_no_drg""",109348,Thread-1,2022-07-18T00:10:24.009359Z
E016,,debug,On model.mimic.elixhauser_ahrq_v37_no_drg: COMMIT,109348,Thread-1,2022-07-18T00:10:24.009480Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:24.011100Z
E015,,debug,"Using postgres connection ""model.mimic.elixhauser_ahrq_v37_no_drg""",109348,Thread-1,2022-07-18T00:10:24.012678Z
E016,,debug,"On model.mimic.elixhauser_ahrq_v37_no_drg: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.elixhauser_ahrq_v37_no_drg""} */
drop table if exists ""postgres"".""public"".""elixhauser_ahrq_v37_no_drg__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:24.012890Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:24.015746Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:24.019044Z
E010,,debug,On model.mimic.elixhauser_ahrq_v37_no_drg: Close,109348,Thread-1,2022-07-18T00:10:24.019299Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7c4c3ecd-5c14-4600-9281-0e21ba30ba00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3f8a03f040>]}",109348,Thread-1,2022-07-18T00:10:24.020145Z
Q012,0,info,21 of 107 OK created table model public.elixhauser_ahrq_v37_no_drg ............. [[32mSELECT 58976[0m in 0.56s],109348,Thread-1,2022-07-18T00:10:24.020666Z,table,null,elixhauser_ahrq_v37_no_drg,comorbidity/elixhauser_ahrq_v37_no_drg.sql,2022-07-18T00:10:23.459906,compiling,model,,,
Q024,0.5582778453826904,debug,Finished running node model.mimic.elixhauser_ahrq_v37_no_drg,109348,Thread-1,2022-07-18T00:10:24.021301Z,table,2022-07-18T00:10:24.021055,elixhauser_ahrq_v37_no_drg,comorbidity/elixhauser_ahrq_v37_no_drg.sql,2022-07-18T00:10:23.459906,success,model,,,
Q023,,debug,Began running node model.mimic.elixhauser_quan,109348,Thread-1,2022-07-18T00:10:24.021971Z,table,null,elixhauser_quan,comorbidity/elixhauser_quan.sql,2022-07-18T00:10:24.021876,started,model,,,
Q033,,info,22 of 107 START table model public.elixhauser_quan ............................. [RUN],109348,Thread-1,2022-07-18T00:10:24.022885Z,table,null,elixhauser_quan,comorbidity/elixhauser_quan.sql,2022-07-18T00:10:24.021876,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.elixhauser_quan""",109348,Thread-1,2022-07-18T00:10:24.024004Z
Q030,,debug,Began compiling node model.mimic.elixhauser_quan,109348,Thread-1,2022-07-18T00:10:24.024514Z,table,null,elixhauser_quan,comorbidity/elixhauser_quan.sql,2022-07-18T00:10:24.021876,compiling,model,,,
Q027,,debug,Compiling model.mimic.elixhauser_quan,109348,Thread-1,2022-07-18T00:10:24.024856Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.elixhauser_quan""",109348,Thread-1,2022-07-18T00:10:24.033007Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:24.034153Z
Q031,,debug,Began executing node model.mimic.elixhauser_quan,109348,Thread-1,2022-07-18T00:10:24.034747Z,table,null,elixhauser_quan,comorbidity/elixhauser_quan.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.elixhauser_quan""",109348,Thread-1,2022-07-18T00:10:24.044312Z
E015,,debug,"Using postgres connection ""model.mimic.elixhauser_quan""",109348,Thread-1,2022-07-18T00:10:24.045030Z
E016,,debug,On model.mimic.elixhauser_quan: BEGIN,109348,Thread-1,2022-07-18T00:10:24.045859Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:24.046446Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:24.052544Z
E015,,debug,"Using postgres connection ""model.mimic.elixhauser_quan""",109348,Thread-1,2022-07-18T00:10:24.052832Z
E016,,debug,"On model.mimic.elixhauser_quan: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.elixhauser_quan""} */


  create  table ""postgres"".""public"".""elixhauser_quan__dbt_tmp""
  as (
    -- This code calculates the Elixhauser comorbidities as defined in Quan et. al 2009:
-- Quan, Hude, et al. ""Coding algorithms for defining comorbidities in
-- ICD-9-CM and ICD-10 administrative data."" Medical care (2005): 1130-1139.
--  https://www.ncbi.nlm.nih.gov/pubmed/16224307
-- Quan defined an ""Enhanced ICD-9"" coding scheme for deriving Elixhauser
-- comorbidities from ICD-9 billing codes. This script implements that calculation.
-- The logic of the code is roughly that, if the comorbidity lists a length 3
-- ICD-9 code (e.g. 585), then we only require a match on the first 3 characters.
-- This code derives each comorbidity as follows:
--  1) ICD9_CODE is directly compared to 5 character codes
--  2) The first 4 characters of ICD9_CODE are compared to 4 character codes
--  3) The first 3 characters of ICD9_CODE are compared to 3 character codes

 

with eliflg as (
    select
        hadm_id,
        seq_num,
        icd9_code,
        CASE
            when icd9_code in (
                '39891',
                '40201',
                '40211',
                '40291',
                '40401',
                '40403',
                '40411',
                '40413',
                '40491',
                '40493'
            ) then 1
            when SUBSTR(icd9_code, 1, 4) in ('4254', '4255', '4257', '4258', '4259') then 1
            when SUBSTR(icd9_code, 1, 3) in ('428') then 1
            else 0
        end as chf
        /* Congestive heart failure */
,
        CASE
            when icd9_code in ('42613', '42610', '42612', '99601', '99604') then 1
            when SUBSTR(icd9_code, 1, 4) in (
                '4260',
                '4267',
                '4269',
                '4270',
                '4271',
                '4272',
                '4273',
                '4274',
                '4276',
                '4278',
                '4279',
                '7850',
                'V450',
                'V533'
            ) then 1
            else 0
        end as arrhy,
        CASE
            when SUBSTR(icd9_code, 1, 4) in ('0932', '7463', '7464', '7465', '7466', 'V422', 'V433') then 1
            when SUBSTR(icd9_code, 1, 3) in ('394', '395', '396', '397', '424') then 1
            else 0
        end as valve
        /* Valvular disease */
,
        CASE
            when SUBSTR(icd9_code, 1, 4) in ('4150', '4151', '4170', '4178', '4179') then 1
            when SUBSTR(icd9_code, 1, 3) in ('416') then 1
            else 0
        end as pulmcirc
        /* Pulmonary circulation disorder */
,
        CASE
            when SUBSTR(icd9_code, 1, 4) in (
                '0930',
                '4373',
                '4431',
                '4432',
                '4438',
                '4439',
                '4471',
                '5571',
                '5579',
                'V434'
            ) then 1
            when SUBSTR(icd9_code, 1, 3) in ('440', '441') then 1
            else 0
        end as perivasc
        /* Peripheral vascular disorder */
,
        CASE
            when SUBSTR(icd9_code, 1, 3) in ('401') then 1
            else 0
        end as htn
        /* Hypertension, uncomplicated */
,
        CASE
            when SUBSTR(icd9_code, 1, 3) in ('402', '403', '404', '405') then 1
            else 0
        end as htncx
        /* Hypertension, complicated */
,
        CASE
            when SUBSTR(icd9_code, 1, 4) in (
                '3341',
                '3440',
                '3441',
                '3442',
                '3443',
                '3444',
                '3445',
                '3446',
                '3449'
            ) then 1
            when SUBSTR(icd9_code, 1, 3) in ('342', '343') then 1
            else 0
        end as para
        /* Paralysis */
,
        CASE
            when icd9_code in ('33392') then 1
            when SUBSTR(icd9_code, 1, 4) in (
                '3319',
                '3320',
                '3321',
                '3334',
                '3335',
                '3362',
                '3481',
                '3483',
                '7803',
                '7843'
            ) then 1
            when SUBSTR(icd9_code, 1, 3) in ('334', '335', '340', '341', '345') then 1
            else 0
        end as neuro
        /* Other neurological */
,
        CASE
            when SUBSTR(icd9_code, 1, 4) in ('4168', '4169', '5064', '5081', '5088') then 1
            when SUBSTR(icd9_code, 1, 3) in (
                '490',
                '491',
                '492',
                '493',
                '494',
                '495',
                '496',
                '500',
                '501',
                '502',
                '503',
                '504',
                '505'
            ) then 1
            else 0
        end as chrnlung
        /* Chronic pulmonary disease */
,
        CASE
            when SUBSTR(icd9_code, 1, 4) in ('2500', '2501', '2502', '2503') then 1
            else 0
        end as dm
        /* Diabetes w/o chronic complications*/
,
        CASE
            when SUBSTR(icd9_code, 1, 4) in ('2504', '2505', '2506', '2507', '2508', '2509') then 1
            else 0
        end as dmcx
        /* Diabetes w/ chronic complications */
,
        CASE
            when SUBSTR(icd9_code, 1, 4) in ('2409', '2461', '2468') then 1
            when SUBSTR(icd9_code, 1, 3) in ('243', '244') then 1
            else 0
        end as hypothy
        /* Hypothyroidism */
,
        CASE
            when icd9_code in (
                '40301',
                '40311',
                '40391',
                '40402',
                '40403',
                '40412',
                '40413',
                '40492',
                '40493'
            ) then 1
            when SUBSTR(icd9_code, 1, 4) in ('5880', 'V420', 'V451') then 1
            when SUBSTR(icd9_code, 1, 3) in ('585', '586', 'V56') then 1
            else 0
        end as renlfail
        /* Renal failure */
,
        CASE
            when icd9_code in ('07022', '07023', '07032', '07033', '07044', '07054') then 1
            when SUBSTR(icd9_code, 1, 4) in (
                '0706',
                '0709',
                '4560',
                '4561',
                '4562',
                '5722',
                '5723',
                '5724',
                '5728',
                '5733',
                '5734',
                '5738',
                '5739',
                'V427'
            ) then 1
            when SUBSTR(icd9_code, 1, 3) in ('570', '571') then 1
            else 0
        end as liver
        /* Liver disease */
,
        CASE
            when SUBSTR(icd9_code, 1, 4) in (
                '5317',
                '5319',
                '5327',
                '5329',
                '5337',
                '5339',
                '5347',
                '5349'
            ) then 1
            else 0
        end as ulcer
        /* Chronic Peptic ulcer disease (includes bleeding only if obstruction is also present) */
,
        CASE
            when SUBSTR(icd9_code, 1, 3) in ('042', '043', '044') then 1
            else 0
        end as aids
        /* HIV and AIDS */
,
        CASE
            when SUBSTR(icd9_code, 1, 4) in ('2030', '2386') then 1
            when SUBSTR(icd9_code, 1, 3) in ('200', '201', '202') then 1
            else 0
        end as lymph
        /* Lymphoma */
,
        CASE
            when SUBSTR(icd9_code, 1, 3) in ('196', '197', '198', '199') then 1
            else 0
        end as mets
        /* Metastatic cancer */
,
        CASE
            when SUBSTR(icd9_code, 1, 3) in (
                '140',
                '141',
                '142',
                '143',
                '144',
                '145',
                '146',
                '147',
                '148',
                '149',
                '150',
                '151',
                '152',
                '153',
                '154',
                '155',
                '156',
                '157',
                '158',
                '159',
                '160',
                '161',
                '162',
                '163',
                '164',
                '165',
                '166',
                '167',
                '168',
                '169',
                '170',
                '171',
                '172',
                '174',
                '175',
                '176',
                '177',
                '178',
                '179',
                '180',
                '181',
                '182',
                '183',
                '184',
                '185',
                '186',
                '187',
                '188',
                '189',
                '190',
                '191',
                '192',
                '193',
                '194',
                '195'
            ) then 1
            else 0
        end as tumor
        /* Solid tumor without metastasis */
,
        CASE
            when icd9_code in ('72889', '72930') then 1
            when SUBSTR(icd9_code, 1, 4) in (
                '7010',
                '7100',
                '7101',
                '7102',
                '7103',
                '7104',
                '7108',
                '7109',
                '7112',
                '7193',
                '7285'
            ) then 1
            when SUBSTR(icd9_code, 1, 3) in ('446', '714', '720', '725') then 1
            else 0
        end as arth
        /* Rheumatoid arthritis/collagen vascular diseases */
,
        CASE
            when SUBSTR(icd9_code, 1, 4) in ('2871', '2873', '2874', '2875') then 1
            when SUBSTR(icd9_code, 1, 3) in ('286') then 1
            else 0
        end as coag
        /* Coagulation deficiency */
,
        CASE
            when SUBSTR(icd9_code, 1, 4) in ('2780') then 1
            else 0
        end as obese
        /* Obesity      */
,
        CASE
            when SUBSTR(icd9_code, 1, 4) in ('7832', '7994') then 1
            when SUBSTR(icd9_code, 1, 3) in ('260', '261', '262', '263') then 1
            else 0
        end as wghtloss
        /* Weight loss */
,
        CASE
            when SUBSTR(icd9_code, 1, 4) in ('2536') then 1
            when SUBSTR(icd9_code, 1, 3) in ('276') then 1
            else 0
        end as lytes
        /* Fluid and electrolyte disorders */
,
        CASE
            when SUBSTR(icd9_code, 1, 4) in ('2800') then 1
            else 0
        end as bldloss
        /* Blood loss anemia */
,
        CASE
            when SUBSTR(icd9_code, 1, 4) in ('2801', '2808', '2809') then 1
            when SUBSTR(icd9_code, 1, 3) in ('281') then 1
            else 0
        end as anemdef
        /* Deficiency anemias */
,
        CASE
            when SUBSTR(icd9_code, 1, 4) in (
                '2652',
                '2911',
                '2912',
                '2913',
                '2915',
                '2918',
                '2919',
                '3030',
                '3039',
                '3050',
                '3575',
                '4255',
                '5353',
                '5710',
                '5711',
                '5712',
                '5713',
                'V113'
            ) then 1
            when SUBSTR(icd9_code, 1, 3) in ('980') then 1
            else 0
        end as alcohol
        /* Alcohol abuse */
,
        CASE
            when icd9_code in ('V6542') then 1
            when SUBSTR(icd9_code, 1, 4) in (
                '3052',
                '3053',
                '3054',
                '3055',
                '3056',
                '3057',
                '3058',
                '3059'
            ) then 1
            when SUBSTR(icd9_code, 1, 3) in ('292', '304') then 1
            else 0
        end as drug
        /* Drug abuse */
,
        CASE
            when icd9_code in ('29604', '29614', '29644', '29654') then 1
            when SUBSTR(icd9_code, 1, 4) in ('2938') then 1
            when SUBSTR(icd9_code, 1, 3) in ('295', '297', '298') then 1
            else 0
        end as psych
        /* Psychoses */
,
        CASE
            when SUBSTR(icd9_code, 1, 4) in ('2962', '2963', '2965', '3004') then 1
            when SUBSTR(icd9_code, 1, 3) in ('309', '311') then 1
            else 0
        end as depress
        /* Depression */
    from
        diagnoses_icd icd
    where
        seq_num != 1 -- we do not include the primary icd-9 code
) -- collapse the icd9_code specific flags into hadm_id specific flags
-- this groups comorbidities together for a single patient admission
,
eligrp as (
    select
        hadm_id,
        max(chf) as chf,
        max(arrhy) as arrhy,
        max(valve) as valve,
        max(pulmcirc) as pulmcirc,
        max(perivasc) as perivasc,
        max(htn) as htn,
        max(htncx) as htncx,
        max(para) as para,
        max(neuro) as neuro,
        max(chrnlung) as chrnlung,
        max(dm) as dm,
        max(dmcx) as dmcx,
        max(hypothy) as hypothy,
        max(renlfail) as renlfail,
        max(liver) as liver,
        max(ulcer) as ulcer,
        max(aids) as aids,
        max(lymph) as lymph,
        max(mets) as mets,
        max(tumor) as tumor,
        max(arth) as arth,
        max(coag) as coag,
        max(obese) as obese,
        max(wghtloss) as wghtloss,
        max(lytes) as lytes,
        max(bldloss) as bldloss,
        max(anemdef) as anemdef,
        max(alcohol) as alcohol,
        max(drug) as drug,
        max(psych) as psych,
        max(depress) as depress
    from
        eliflg
    group by
        hadm_id
) -- now merge these flags together to define elixhauser
-- most are straightforward.. but hypertension flags are a bit more complicated
select
    adm.hadm_id,
    chf as congestive_heart_failure,
    arrhy as cardiac_arrhythmias,
    valve as valvular_disease,
    pulmcirc as pulmonary_circulation,
    perivasc as peripheral_vascular -- we combine ""htn"" and ""htncx"" into ""HYPERTENSION""
,
    case
        when htn = 1 then 1
        when htncx = 1 then 1
        else 0
    end as hypertension,
    para as paralysis,
    neuro as other_neurological,
    chrnlung as chronic_pulmonary -- only the more severe comorbidity (complicated diabetes) is kept
,
    case
        when dmcx = 1 then 0
        when dm = 1 then 1
        else 0
    end as diabetes_uncomplicated,
    dmcx as diabetes_complicated,
    hypothy as hypothyroidism,
    renlfail as renal_failure,
    liver as liver_disease,
    ulcer as peptic_ulcer,
    aids as aids,
    lymph as lymphoma,
    mets as metastatic_cancer -- only the more severe comorbidity (metastatic cancer) is kept
,
    case
        when mets = 1 then 0
        when tumor = 1 then 1
        else 0
    end as solid_tumor,
    arth as rheumatoid_arthritis,
    coag as coagulopathy,
    obese as obesity,
    wghtloss as weight_loss,
    lytes as fluid_electrolyte,
    bldloss as blood_loss_anemia,
    anemdef as deficiency_anemias,
    alcohol as alcohol_abuse,
    drug as drug_abuse,
    psych as psychoses,
    depress as depression
FROM
    admissions adm
    left join eligrp eli on adm.hadm_id = eli.hadm_id
order by
    adm.hadm_id
  );",109348,Thread-1,2022-07-18T00:10:24.053041Z
E017,,debug,SQL status: SELECT 58976 in 1.89 seconds,109348,Thread-1,2022-07-18T00:10:25.942605Z
E015,,debug,"Using postgres connection ""model.mimic.elixhauser_quan""",109348,Thread-1,2022-07-18T00:10:25.949100Z
E016,,debug,"On model.mimic.elixhauser_quan: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.elixhauser_quan""} */
alter table ""postgres"".""public"".""elixhauser_quan"" rename to ""elixhauser_quan__dbt_backup""",109348,Thread-1,2022-07-18T00:10:25.949553Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:25.951074Z
E015,,debug,"Using postgres connection ""model.mimic.elixhauser_quan""",109348,Thread-1,2022-07-18T00:10:25.954708Z
E016,,debug,"On model.mimic.elixhauser_quan: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.elixhauser_quan""} */
alter table ""postgres"".""public"".""elixhauser_quan__dbt_tmp"" rename to ""elixhauser_quan""",109348,Thread-1,2022-07-18T00:10:25.954943Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:25.955655Z
E018,,debug,On model.mimic.elixhauser_quan: COMMIT,109348,Thread-1,2022-07-18T00:10:25.959064Z
E015,,debug,"Using postgres connection ""model.mimic.elixhauser_quan""",109348,Thread-1,2022-07-18T00:10:25.959295Z
E016,,debug,On model.mimic.elixhauser_quan: COMMIT,109348,Thread-1,2022-07-18T00:10:25.959537Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:25.961696Z
E015,,debug,"Using postgres connection ""model.mimic.elixhauser_quan""",109348,Thread-1,2022-07-18T00:10:25.963731Z
E016,,debug,"On model.mimic.elixhauser_quan: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.elixhauser_quan""} */
drop table if exists ""postgres"".""public"".""elixhauser_quan__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:25.963944Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:25.966150Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:25.969476Z
E010,,debug,On model.mimic.elixhauser_quan: Close,109348,Thread-1,2022-07-18T00:10:25.969873Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7c4c3ecd-5c14-4600-9281-0e21ba30ba00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3f8a03df70>]}",109348,Thread-1,2022-07-18T00:10:25.970725Z
Q012,1,info,22 of 107 OK created table model public.elixhauser_quan ........................ [[32mSELECT 58976[0m in 1.95s],109348,Thread-1,2022-07-18T00:10:25.971221Z,table,null,elixhauser_quan,comorbidity/elixhauser_quan.sql,2022-07-18T00:10:24.021876,compiling,model,,,
Q024,1.9472219944000244,debug,Finished running node model.mimic.elixhauser_quan,109348,Thread-1,2022-07-18T00:10:25.971972Z,table,2022-07-18T00:10:25.971790,elixhauser_quan,comorbidity/elixhauser_quan.sql,2022-07-18T00:10:24.021876,success,model,,,
Q023,,debug,Began running node model.mimic.epinephrine_durations,109348,Thread-1,2022-07-18T00:10:25.972600Z,table,null,epinephrine_durations,durations/epinephrine_durations.sql,2022-07-18T00:10:25.972490,started,model,,,
Q033,,info,23 of 107 START table model public.epinephrine_durations ....................... [RUN],109348,Thread-1,2022-07-18T00:10:25.973270Z,table,null,epinephrine_durations,durations/epinephrine_durations.sql,2022-07-18T00:10:25.972490,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.epinephrine_durations""",109348,Thread-1,2022-07-18T00:10:25.975659Z
Q030,,debug,Began compiling node model.mimic.epinephrine_durations,109348,Thread-1,2022-07-18T00:10:25.975956Z,table,null,epinephrine_durations,durations/epinephrine_durations.sql,2022-07-18T00:10:25.972490,compiling,model,,,
Q027,,debug,Compiling model.mimic.epinephrine_durations,109348,Thread-1,2022-07-18T00:10:25.976240Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.epinephrine_durations""",109348,Thread-1,2022-07-18T00:10:25.977307Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:25.977898Z
Q031,,debug,Began executing node model.mimic.epinephrine_durations,109348,Thread-1,2022-07-18T00:10:25.978256Z,table,null,epinephrine_durations,durations/epinephrine_durations.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.epinephrine_durations""",109348,Thread-1,2022-07-18T00:10:25.987932Z
E015,,debug,"Using postgres connection ""model.mimic.epinephrine_durations""",109348,Thread-1,2022-07-18T00:10:25.989153Z
E016,,debug,On model.mimic.epinephrine_durations: BEGIN,109348,Thread-1,2022-07-18T00:10:25.989545Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:25.989960Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:25.996926Z
E015,,debug,"Using postgres connection ""model.mimic.epinephrine_durations""",109348,Thread-1,2022-07-18T00:10:25.997197Z
E016,,debug,"On model.mimic.epinephrine_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.epinephrine_durations""} */


  create  table ""postgres"".""public"".""epinephrine_durations__dbt_tmp""
  as (
    -- This query extracts durations of epinephrine administration
-- Consecutive administrations are numbered 1, 2, ...
-- Total time on the drug can be calculated from this table by grouping using ICUSTAY_ID

-- Get drug administration data from CareVue first
with vasocv1 as
(
  select
    icustay_id, charttime
    -- case statement determining whether the ITEMID is an instance of vasopressor usage
    , max(case when itemid in (30044,30119,30309) then 1 else 0 end) as vaso -- epinephrine

    -- the 'stopped' column indicates if a vasopressor has been disconnected
    , max(case when itemid in (30044,30119,30309) and (stopped = 'Stopped' OR stopped like 'D/C%') then 1
          else 0 end) as vaso_stopped

    , max(case when itemid in (30044,30119,30309) and rate is not null then 1 else 0 end) as vaso_null
    , max(case when itemid in (30044,30119,30309) then rate else null end) as vaso_rate
    , max(case when itemid in (30044,30119,30309) then amount else null end) as vaso_amount

  FROM inputevents_cv
  where itemid in
  (
        30044,30119,30309 -- epinephrine
  )
  group by icustay_id, charttime
)
, vasocv2 as
(
  select v.*
    , sum(vaso_null) over (partition by icustay_id order by charttime) as vaso_partition
  from
    vasocv1 v
)
, vasocv3 as
(
  select v.*
    , first_value(vaso_rate) over (partition by icustay_id, vaso_partition order by charttime) as vaso_prevrate_ifnull
  from
    vasocv2 v
)
, vasocv4 as
(
select
    icustay_id
    , charttime
    -- , (CHARTTIME - (LAG(CHARTTIME, 1) OVER (partition by icustay_id, vaso order by charttime))) AS delta

    , vaso
    , vaso_rate
    , vaso_amount
    , vaso_stopped
    , vaso_prevrate_ifnull

    -- We define start time here
    , case
        when vaso = 0 then null

        -- if this is the first instance of the vasoactive drug
        when vaso_rate > 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso, vaso_null
          order by charttime
          )
          is null
          then 1

        -- you often get a string of 0s
        -- we decide not to set these as 1, just because it makes vasonum sequential
        when vaso_rate = 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 0
          then 0

        -- sometimes you get a string of NULL, associated with 0 volumes
        -- same reason as before, we decide not to set these as 1
        -- vaso_prevrate_ifnull is equal to the previous value *iff* the current value is null
        when vaso_prevrate_ifnull = 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 0
          then 0

        -- If the last recorded rate was 0, newvaso = 1
        when LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          ) = 0
          then 1

        -- If the last recorded vaso was D/C'd, newvaso = 1
        when
          LAG(vaso_stopped,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 1 then 1

        -- ** not sure if the below is needed
        --when (CHARTTIME - (LAG(CHARTTIME, 1) OVER (partition by icustay_id, vaso order by charttime))) > (interval '4 hours') then 1
      else null
      end as vaso_start

FROM
  vasocv3
)
-- propagate start/stop flags forward in time
, vasocv5 as
(
  select v.*
    , SUM(vaso_start) OVER (partition by icustay_id, vaso order by charttime) as vaso_first
FROM
  vasocv4 v
)
, vasocv6 as
(
  select v.*
    -- We define end time here
    , case
        when vaso = 0
          then null

        -- If the recorded vaso was D/C'd, this is an end time
        when vaso_stopped = 1
          then vaso_first

        -- If the rate is zero, this is the end time
        when vaso_rate = 0
          then vaso_first

        -- the last row in the table is always a potential end time
        -- this captures patients who die/are discharged while on vasopressors
        -- in principle, this could add an extra end time for the vasopressor
        -- however, since we later group on vaso_start, any extra end times are ignored
        when LEAD(CHARTTIME,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          ) is null
          then vaso_first

        else null
        end as vaso_stop
    from vasocv5 v
)

-- -- if you want to look at the results of the table before grouping:
-- select
--   icustay_id, charttime, vaso, vaso_rate, vaso_amount
--     , case when vaso_stopped = 1 then 'Y' else '' end as stopped
--     , vaso_start
--     , vaso_first
--     , vaso_stop
-- from vasocv6 order by charttime


, vasocv as
(
-- below groups together vasopressor administrations into groups
select
  icustay_id
  -- the first non-null rate is considered the starttime
  , min(case when vaso_rate is not null then charttime else null end) as starttime
  -- the *first* time the first/last flags agree is the stop time for this duration
  , min(case when vaso_first = vaso_stop then charttime else null end) as endtime
from vasocv6
where
  vaso_first is not null -- bogus data
and
  vaso_first != 0 -- sometimes *only* a rate of 0 appears, i.e. the drug is never actually delivered
and
  icustay_id is not null -- there are data for ""floating"" admissions, we don't worry about these
group by icustay_id, vaso_first
having -- ensure start time is not the same as end time
 min(charttime) != min(case when vaso_first = vaso_stop then charttime else null end)
and
  max(vaso_rate) > 0 -- if the rate was always 0 or null, we consider it not a real drug delivery
)

-- now we extract the associated data for metavision patients
, vasomv as
(
  select
    icustay_id, linkorderid
    , min(starttime) as starttime, max(endtime) as endtime
  FROM inputevents_mv
  where itemid = 221289 -- epinephrine
  and statusdescription != 'Rewritten' -- only valid orders
  group by icustay_id, linkorderid
)

select
  icustay_id
  -- generate a sequential integer for convenience
  , ROW_NUMBER() over (partition by icustay_id order by starttime) as vasonum
  , starttime, endtime
  , DATETIME_DIFF(endtime, starttime, 'HOUR') AS duration_hours
  -- add durations
from
  vasocv

UNION ALL

select
  icustay_id
  , ROW_NUMBER() over (partition by icustay_id order by starttime) as vasonum
  , starttime, endtime
  , DATETIME_DIFF(endtime, starttime, 'HOUR') AS duration_hours
  -- add durations
from
  vasomv

order by icustay_id, vasonum
  );",109348,Thread-1,2022-07-18T00:10:25.997318Z
E017,,debug,SQL status: SELECT 3126 in 1.7 seconds,109348,Thread-1,2022-07-18T00:10:27.697352Z
E015,,debug,"Using postgres connection ""model.mimic.epinephrine_durations""",109348,Thread-1,2022-07-18T00:10:27.705408Z
E016,,debug,"On model.mimic.epinephrine_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.epinephrine_durations""} */
alter table ""postgres"".""public"".""epinephrine_durations"" rename to ""epinephrine_durations__dbt_backup""",109348,Thread-1,2022-07-18T00:10:27.705971Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:27.707405Z
E015,,debug,"Using postgres connection ""model.mimic.epinephrine_durations""",109348,Thread-1,2022-07-18T00:10:27.711937Z
E016,,debug,"On model.mimic.epinephrine_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.epinephrine_durations""} */
alter table ""postgres"".""public"".""epinephrine_durations__dbt_tmp"" rename to ""epinephrine_durations""",109348,Thread-1,2022-07-18T00:10:27.712183Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:27.712832Z
E018,,debug,On model.mimic.epinephrine_durations: COMMIT,109348,Thread-1,2022-07-18T00:10:27.715797Z
E015,,debug,"Using postgres connection ""model.mimic.epinephrine_durations""",109348,Thread-1,2022-07-18T00:10:27.716018Z
E016,,debug,On model.mimic.epinephrine_durations: COMMIT,109348,Thread-1,2022-07-18T00:10:27.716151Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:27.717703Z
E015,,debug,"Using postgres connection ""model.mimic.epinephrine_durations""",109348,Thread-1,2022-07-18T00:10:27.719997Z
E016,,debug,"On model.mimic.epinephrine_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.epinephrine_durations""} */
drop table if exists ""postgres"".""public"".""epinephrine_durations__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:27.720224Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:27.722391Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:27.725441Z
E010,,debug,On model.mimic.epinephrine_durations: Close,109348,Thread-1,2022-07-18T00:10:27.725899Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7c4c3ecd-5c14-4600-9281-0e21ba30ba00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3f8a03f280>]}",109348,Thread-1,2022-07-18T00:10:27.726692Z
Q012,1,info,23 of 107 OK created table model public.epinephrine_durations .................. [[32mSELECT 3126[0m in 1.75s],109348,Thread-1,2022-07-18T00:10:27.727208Z,table,null,epinephrine_durations,durations/epinephrine_durations.sql,2022-07-18T00:10:25.972490,compiling,model,,,
Q024,1.7524044513702393,debug,Finished running node model.mimic.epinephrine_durations,109348,Thread-1,2022-07-18T00:10:27.727938Z,table,2022-07-18T00:10:27.727684,epinephrine_durations,durations/epinephrine_durations.sql,2022-07-18T00:10:25.972490,success,model,,,
Q023,,debug,Began running node model.mimic.explicit,109348,Thread-1,2022-07-18T00:10:27.728522Z,table,null,explicit,sepsis/explicit.sql,2022-07-18T00:10:27.728408,started,model,,,
Q033,,info,24 of 107 START table model public.explicit .................................... [RUN],109348,Thread-1,2022-07-18T00:10:27.729133Z,table,null,explicit,sepsis/explicit.sql,2022-07-18T00:10:27.728408,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.explicit""",109348,Thread-1,2022-07-18T00:10:27.729983Z
Q030,,debug,Began compiling node model.mimic.explicit,109348,Thread-1,2022-07-18T00:10:27.730364Z,table,null,explicit,sepsis/explicit.sql,2022-07-18T00:10:27.728408,compiling,model,,,
Q027,,debug,Compiling model.mimic.explicit,109348,Thread-1,2022-07-18T00:10:27.730845Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.explicit""",109348,Thread-1,2022-07-18T00:10:27.733138Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:27.734100Z
Q031,,debug,Began executing node model.mimic.explicit,109348,Thread-1,2022-07-18T00:10:27.734581Z,table,null,explicit,sepsis/explicit.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.explicit""",109348,Thread-1,2022-07-18T00:10:27.744950Z
E015,,debug,"Using postgres connection ""model.mimic.explicit""",109348,Thread-1,2022-07-18T00:10:27.745972Z
E016,,debug,On model.mimic.explicit: BEGIN,109348,Thread-1,2022-07-18T00:10:27.746310Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:27.746630Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:27.753559Z
E015,,debug,"Using postgres connection ""model.mimic.explicit""",109348,Thread-1,2022-07-18T00:10:27.754146Z
E016,,debug,"On model.mimic.explicit: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.explicit""} */


  create  table ""postgres"".""public"".""explicit__dbt_tmp""
  as (
    -- This code extracts explicit sepsis using ICD-9 diagnosis codes
-- That is, the two codes 995.92 (severe sepsis) or 785.52 (septic shock)
-- These codes are extremely specific to sepsis, but have very low sensitivity
-- From Iwashyna et al. (vs. chart reviews): 100% PPV, 9.3% sens, 100% specificity
 

WITH co_dx AS
(
	SELECT hadm_id
	-- sepsis codes
	, MAX(
    	CASE
    		WHEN icd9_code = '99592' THEN 1
      ELSE 0 END
    ) AS severe_sepsis
	, MAX(
    	CASE
    		WHEN icd9_code = '78552' THEN 1
      ELSE 0 END
    ) AS septic_shock
  from diagnoses_icd
  GROUP BY hadm_id
)
select
  adm.subject_id
  , adm.hadm_id
	, co_dx.severe_sepsis
  , co_dx.septic_shock
	, case when co_dx.severe_sepsis = 1 or co_dx.septic_shock = 1
			then 1
		else 0 end as sepsis
FROM admissions adm
left join co_dx
  on adm.hadm_id = co_dx.hadm_id
order by adm.subject_id, adm.hadm_id
  );",109348,Thread-1,2022-07-18T00:10:27.754410Z
E017,,debug,SQL status: SELECT 58976 in 0.23 seconds,109348,Thread-1,2022-07-18T00:10:27.982627Z
E015,,debug,"Using postgres connection ""model.mimic.explicit""",109348,Thread-1,2022-07-18T00:10:27.988200Z
E016,,debug,"On model.mimic.explicit: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.explicit""} */
alter table ""postgres"".""public"".""explicit"" rename to ""explicit__dbt_backup""",109348,Thread-1,2022-07-18T00:10:27.988421Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:27.989218Z
E015,,debug,"Using postgres connection ""model.mimic.explicit""",109348,Thread-1,2022-07-18T00:10:27.992896Z
E016,,debug,"On model.mimic.explicit: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.explicit""} */
alter table ""postgres"".""public"".""explicit__dbt_tmp"" rename to ""explicit""",109348,Thread-1,2022-07-18T00:10:27.993114Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:27.993911Z
E018,,debug,On model.mimic.explicit: COMMIT,109348,Thread-1,2022-07-18T00:10:27.996699Z
E015,,debug,"Using postgres connection ""model.mimic.explicit""",109348,Thread-1,2022-07-18T00:10:27.996904Z
E016,,debug,On model.mimic.explicit: COMMIT,109348,Thread-1,2022-07-18T00:10:27.997023Z
E017,,debug,SQL status: COMMIT in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:28.002431Z
E015,,debug,"Using postgres connection ""model.mimic.explicit""",109348,Thread-1,2022-07-18T00:10:28.006323Z
E016,,debug,"On model.mimic.explicit: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.explicit""} */
drop table if exists ""postgres"".""public"".""explicit__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:28.006597Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:28.008708Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:28.011880Z
E010,,debug,On model.mimic.explicit: Close,109348,Thread-1,2022-07-18T00:10:28.012136Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7c4c3ecd-5c14-4600-9281-0e21ba30ba00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3f886c9dc0>]}",109348,Thread-1,2022-07-18T00:10:28.012939Z
Q012,0,info,24 of 107 OK created table model public.explicit ............................... [[32mSELECT 58976[0m in 0.28s],109348,Thread-1,2022-07-18T00:10:28.013344Z,table,null,explicit,sepsis/explicit.sql,2022-07-18T00:10:27.728408,compiling,model,,,
Q024,0.28342151641845703,debug,Finished running node model.mimic.explicit,109348,Thread-1,2022-07-18T00:10:28.013951Z,table,2022-07-18T00:10:28.013777,explicit,sepsis/explicit.sql,2022-07-18T00:10:27.728408,success,model,,,
Q023,,debug,Began running node model.mimic.ffp_transfusion,109348,Thread-1,2022-07-18T00:10:28.014465Z,table,null,ffp_transfusion,fluid_balance/ffp_transfusion.sql,2022-07-18T00:10:28.014360,started,model,,,
Q033,,info,25 of 107 START table model public.ffp_transfusion ............................. [RUN],109348,Thread-1,2022-07-18T00:10:28.015213Z,table,null,ffp_transfusion,fluid_balance/ffp_transfusion.sql,2022-07-18T00:10:28.014360,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.ffp_transfusion""",109348,Thread-1,2022-07-18T00:10:28.016126Z
Q030,,debug,Began compiling node model.mimic.ffp_transfusion,109348,Thread-1,2022-07-18T00:10:28.016659Z,table,null,ffp_transfusion,fluid_balance/ffp_transfusion.sql,2022-07-18T00:10:28.014360,compiling,model,,,
Q027,,debug,Compiling model.mimic.ffp_transfusion,109348,Thread-1,2022-07-18T00:10:28.016953Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.ffp_transfusion""",109348,Thread-1,2022-07-18T00:10:28.018246Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:28.018927Z
Q031,,debug,Began executing node model.mimic.ffp_transfusion,109348,Thread-1,2022-07-18T00:10:28.019214Z,table,null,ffp_transfusion,fluid_balance/ffp_transfusion.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.ffp_transfusion""",109348,Thread-1,2022-07-18T00:10:28.030727Z
E015,,debug,"Using postgres connection ""model.mimic.ffp_transfusion""",109348,Thread-1,2022-07-18T00:10:28.031462Z
E016,,debug,On model.mimic.ffp_transfusion: BEGIN,109348,Thread-1,2022-07-18T00:10:28.031698Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:28.031812Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:28.039879Z
E015,,debug,"Using postgres connection ""model.mimic.ffp_transfusion""",109348,Thread-1,2022-07-18T00:10:28.040251Z
E016,,debug,"On model.mimic.ffp_transfusion: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.ffp_transfusion""} */


  create  table ""postgres"".""public"".""ffp_transfusion__dbt_tmp""
  as (
    -- Retrieves instances of fresh frozen plasma transfusions
WITH raw_ffp AS (
  SELECT
      CASE
        WHEN amount IS NOT NULL THEN amount
        WHEN stopped IS NOT NULL THEN 0
        -- impute 200 mL when unit is not documented
        -- this is an approximation which holds ~90% of the time
        ELSE 200
      END AS amount
    , amountuom
    , icustay_id
    , charttime
  FROM inputevents_cv
  WHERE itemid IN
  (
    30005,  -- Fresh Frozen Plasma
    30180   -- Fresh Froz Plasma
  )
  AND amount > 0
  AND icustay_id IS NOT NULL
  UNION ALL
  SELECT amount
    , amountuom
    , icustay_id
    , endtime AS charttime
  FROM inputevents_mv
  WHERE itemid in
  (
    220970   -- Fresh Frozen Plasma
  )
  AND amount > 0
  AND icustay_id IS NOT NULL
),
pre_icu_ffp as (
  SELECT
    sum(amount) as amount, icustay_id
  FROM inputevents_cv
  WHERE itemid IN (
    44172,  -- FFP GTT         
    44236,  -- E.R. FFP        
    46410,  -- angio FFP
    46418,  -- ER ffp
    46684,  -- ER FFP
    44819,  -- FFP ON FARR 2
    46530,  -- Floor FFP       
    44044,  -- FFP Drip
    46122,  -- ER in FFP
    45669,  -- ED FFP
    42323   -- er ffp
  )
  AND amount > 0
  AND icustay_id IS NOT NULL
  GROUP BY icustay_id
  UNION ALL
  SELECT
    sum(amount) as amount, icustay_id
  FROM inputevents_mv
  WHERE itemid IN (
    227072  -- PACU FFP Intake
  )
  AND amount > 0
  AND icustay_id IS NOT NULL
  GROUP BY icustay_id
),
cumulative AS (
  SELECT
    sum(amount) over (PARTITION BY icustay_id ORDER BY charttime DESC) AS amount
    , amountuom
    , icustay_id
    , charttime
    , DATETIME_DIFF(lag(charttime) over (PARTITION BY icustay_id ORDER BY charttime ASC), charttime, 'HOUR') AS delta
  FROM raw_ffp
)
-- We consider any transfusions started within 1 hr of the last one
-- to be part of the same event
SELECT
    cm.icustay_id
  , cm.charttime
  , ROUND(CAST(cm.amount AS numeric) - CASE
      WHEN ROW_NUMBER() OVER w = 1 THEN CAST(0 AS numeric)
      ELSE cast(lag(cm.amount) OVER w AS numeric)
    END, 2) AS amount
  , ROUND(CAST(cm.amount AS numeric) + CASE
      WHEN pre.amount IS NULL THEN CAST(0 AS numeric)
      ELSE CAST(pre.amount AS numeric)
    END, 2) AS totalamount
  , cm.amountuom
FROM cumulative AS cm
LEFT JOIN pre_icu_ffp AS pre
  USING (icustay_id)
WHERE delta IS NULL OR delta < -1
WINDOW w AS (PARTITION BY cm.icustay_id ORDER BY cm.charttime DESC)
ORDER BY icustay_id, charttime
  );",109348,Thread-1,2022-07-18T00:10:28.040604Z
E017,,debug,SQL status: SELECT 13583 in 0.26 seconds,109348,Thread-1,2022-07-18T00:10:28.297918Z
E015,,debug,"Using postgres connection ""model.mimic.ffp_transfusion""",109348,Thread-1,2022-07-18T00:10:28.304903Z
E016,,debug,"On model.mimic.ffp_transfusion: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.ffp_transfusion""} */
alter table ""postgres"".""public"".""ffp_transfusion"" rename to ""ffp_transfusion__dbt_backup""",109348,Thread-1,2022-07-18T00:10:28.305337Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:28.306940Z
E015,,debug,"Using postgres connection ""model.mimic.ffp_transfusion""",109348,Thread-1,2022-07-18T00:10:28.313482Z
E016,,debug,"On model.mimic.ffp_transfusion: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.ffp_transfusion""} */
alter table ""postgres"".""public"".""ffp_transfusion__dbt_tmp"" rename to ""ffp_transfusion""",109348,Thread-1,2022-07-18T00:10:28.313793Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:28.314538Z
E018,,debug,On model.mimic.ffp_transfusion: COMMIT,109348,Thread-1,2022-07-18T00:10:28.317495Z
E015,,debug,"Using postgres connection ""model.mimic.ffp_transfusion""",109348,Thread-1,2022-07-18T00:10:28.317764Z
E016,,debug,On model.mimic.ffp_transfusion: COMMIT,109348,Thread-1,2022-07-18T00:10:28.318010Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:28.320611Z
E015,,debug,"Using postgres connection ""model.mimic.ffp_transfusion""",109348,Thread-1,2022-07-18T00:10:28.322946Z
E016,,debug,"On model.mimic.ffp_transfusion: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.ffp_transfusion""} */
drop table if exists ""postgres"".""public"".""ffp_transfusion__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:28.323180Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:28.325761Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:28.328582Z
E010,,debug,On model.mimic.ffp_transfusion: Close,109348,Thread-1,2022-07-18T00:10:28.328823Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7c4c3ecd-5c14-4600-9281-0e21ba30ba00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3f8a03f580>]}",109348,Thread-1,2022-07-18T00:10:28.329701Z
Z039,,warn,"Error sending message, disabling tracking",109348,Thread-1,2022-07-18T00:10:28.332545Z
Q012,0,info,25 of 107 OK created table model public.ffp_transfusion ........................ [[32mSELECT 13583[0m in 0.31s],109348,Thread-1,2022-07-18T00:10:28.333182Z,table,null,ffp_transfusion,fluid_balance/ffp_transfusion.sql,2022-07-18T00:10:28.014360,compiling,model,,,
Q024,0.3138132095336914,debug,Finished running node model.mimic.ffp_transfusion,109348,Thread-1,2022-07-18T00:10:28.334145Z,table,2022-07-18T00:10:28.333906,ffp_transfusion,fluid_balance/ffp_transfusion.sql,2022-07-18T00:10:28.014360,success,model,,,
Q023,,debug,Began running node model.mimic.gcs,109348,Thread-1,2022-07-18T00:10:28.334745Z,table,null,gcs,cookbook/gcs.sql,2022-07-18T00:10:28.334592,started,model,,,
Q033,,info,26 of 107 START table model public.gcs ......................................... [RUN],109348,Thread-1,2022-07-18T00:10:28.335505Z,table,null,gcs,cookbook/gcs.sql,2022-07-18T00:10:28.334592,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.gcs""",109348,Thread-1,2022-07-18T00:10:28.336517Z
Q030,,debug,Began compiling node model.mimic.gcs,109348,Thread-1,2022-07-18T00:10:28.336742Z,table,null,gcs,cookbook/gcs.sql,2022-07-18T00:10:28.334592,compiling,model,,,
Q027,,debug,Compiling model.mimic.gcs,109348,Thread-1,2022-07-18T00:10:28.337051Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.gcs""",109348,Thread-1,2022-07-18T00:10:28.338794Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:28.339655Z
Q031,,debug,Began executing node model.mimic.gcs,109348,Thread-1,2022-07-18T00:10:28.339955Z,table,null,gcs,cookbook/gcs.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.gcs""",109348,Thread-1,2022-07-18T00:10:28.348597Z
E015,,debug,"Using postgres connection ""model.mimic.gcs""",109348,Thread-1,2022-07-18T00:10:28.349171Z
E016,,debug,On model.mimic.gcs: BEGIN,109348,Thread-1,2022-07-18T00:10:28.349375Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:28.349485Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:28.356466Z
E015,,debug,"Using postgres connection ""model.mimic.gcs""",109348,Thread-1,2022-07-18T00:10:28.356738Z
E016,,debug,"On model.mimic.gcs: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.gcs""} */


  create  table ""postgres"".""public"".""gcs__dbt_tmp""
  as (
    -- --------------------------------------------------------
-- Title: Find the glasgow coma *MOTOR* score for each adult patient
-- Notes: this query does not specify a schema. To run it on your local
-- MIMIC schema, run the following command:
--  SET SEARCH_PATH TO mimiciii
-- Where ""mimiciii"" is the name of your schema, and may be different.
-- --------------------------------------------------------

WITH agetbl AS
(
    SELECT ad.subject_id
    FROM admissions ad
    INNER JOIN patients p
    ON ad.subject_id = p.subject_id
    WHERE
     -- filter to only adults
    DATETIME_DIFF(ad.admittime, p.dob, 'YEAR') > 15
    -- group by subject_id to ensure there is only 1 subject_id per row
    group by ad.subject_id
)
, gcs as
(
    SELECT width_bucket(valuenum, 1, 30, 30) AS bucket
    FROM chartevents ce
    INNER JOIN agetbl
    ON ce.subject_id = agetbl.subject_id
    WHERE itemid IN
    (
        454 -- ""Motor Response""
      , 223900 -- ""GCS - Motor Response""
    )
)
SELECT bucket as GCS_Motor_Response, count(*)
FROM gcs
GROUP BY bucket
ORDER BY bucket
  );",109348,Thread-1,2022-07-18T00:10:28.357075Z
E017,,debug,SQL status: SELECT 0 in 0.17 seconds,109348,Thread-1,2022-07-18T00:10:28.525330Z
E015,,debug,"Using postgres connection ""model.mimic.gcs""",109348,Thread-1,2022-07-18T00:10:28.530484Z
E016,,debug,"On model.mimic.gcs: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.gcs""} */
alter table ""postgres"".""public"".""gcs"" rename to ""gcs__dbt_backup""",109348,Thread-1,2022-07-18T00:10:28.530803Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:28.531716Z
E015,,debug,"Using postgres connection ""model.mimic.gcs""",109348,Thread-1,2022-07-18T00:10:28.536948Z
E016,,debug,"On model.mimic.gcs: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.gcs""} */
alter table ""postgres"".""public"".""gcs__dbt_tmp"" rename to ""gcs""",109348,Thread-1,2022-07-18T00:10:28.537215Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:28.538012Z
E018,,debug,On model.mimic.gcs: COMMIT,109348,Thread-1,2022-07-18T00:10:28.541580Z
E015,,debug,"Using postgres connection ""model.mimic.gcs""",109348,Thread-1,2022-07-18T00:10:28.541982Z
E016,,debug,On model.mimic.gcs: COMMIT,109348,Thread-1,2022-07-18T00:10:28.542265Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:28.544688Z
E015,,debug,"Using postgres connection ""model.mimic.gcs""",109348,Thread-1,2022-07-18T00:10:28.546757Z
E016,,debug,"On model.mimic.gcs: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.gcs""} */
drop table if exists ""postgres"".""public"".""gcs__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:28.547015Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:28.549060Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:28.552969Z
E010,,debug,On model.mimic.gcs: Close,109348,Thread-1,2022-07-18T00:10:28.553232Z
Q012,0,info,26 of 107 OK created table model public.gcs .................................... [[32mSELECT 0[0m in 0.22s],109348,Thread-1,2022-07-18T00:10:28.554066Z,table,null,gcs,cookbook/gcs.sql,2022-07-18T00:10:28.334592,compiling,model,,,
Q024,0.2176516056060791,debug,Finished running node model.mimic.gcs,109348,Thread-1,2022-07-18T00:10:28.554763Z,table,2022-07-18T00:10:28.554577,gcs,cookbook/gcs.sql,2022-07-18T00:10:28.334592,success,model,,,
Q023,,debug,Began running node model.mimic.gcs_first_day,109348,Thread-1,2022-07-18T00:10:28.555260Z,table,null,gcs_first_day,firstday/gcs_first_day.sql,2022-07-18T00:10:28.555181,started,model,,,
Q033,,info,27 of 107 START table model public.gcs_first_day ............................... [RUN],109348,Thread-1,2022-07-18T00:10:28.556221Z,table,null,gcs_first_day,firstday/gcs_first_day.sql,2022-07-18T00:10:28.555181,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.gcs_first_day""",109348,Thread-1,2022-07-18T00:10:28.557264Z
Q030,,debug,Began compiling node model.mimic.gcs_first_day,109348,Thread-1,2022-07-18T00:10:28.557755Z,table,null,gcs_first_day,firstday/gcs_first_day.sql,2022-07-18T00:10:28.555181,compiling,model,,,
Q027,,debug,Compiling model.mimic.gcs_first_day,109348,Thread-1,2022-07-18T00:10:28.558115Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.gcs_first_day""",109348,Thread-1,2022-07-18T00:10:28.559944Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:28.560759Z
Q031,,debug,Began executing node model.mimic.gcs_first_day,109348,Thread-1,2022-07-18T00:10:28.561877Z,table,null,gcs_first_day,firstday/gcs_first_day.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.gcs_first_day""",109348,Thread-1,2022-07-18T00:10:28.576378Z
E015,,debug,"Using postgres connection ""model.mimic.gcs_first_day""",109348,Thread-1,2022-07-18T00:10:28.577411Z
E016,,debug,On model.mimic.gcs_first_day: BEGIN,109348,Thread-1,2022-07-18T00:10:28.577854Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:28.578257Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:28.585100Z
E015,,debug,"Using postgres connection ""model.mimic.gcs_first_day""",109348,Thread-1,2022-07-18T00:10:28.585984Z
E016,,debug,"On model.mimic.gcs_first_day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.gcs_first_day""} */


  create  table ""postgres"".""public"".""gcs_first_day__dbt_tmp""
  as (
    -- ITEMIDs used:

-- CAREVUE
--    723 as GCSVerbal
--    454 as GCSMotor
--    184 as GCSEyes

-- METAVISION
--    223900 GCS - Verbal Response
--    223901 GCS - Motor Response
--    220739 GCS - Eye Opening

-- The code combines the ITEMIDs into the carevue itemids, then pivots those
-- So 223900 is changed to 723, then the ITEMID 723 is pivoted to form GCSVerbal

-- Note:
--  The GCS for sedated patients is defaulted to 15 in this code.
--  This is in line with how the data is meant to be collected.
--  e.g., from the SAPS II publication:
--    For sedated patients, the Glasgow Coma Score before sedation was used.
--    This was ascertained either from interviewing the physician who ordered the sedation,
--    or by reviewing the patient's medical record.

with base as
(
  SELECT pvt.ICUSTAY_ID
  , pvt.charttime

  -- Easier names - note we coalesced Metavision and CareVue IDs below
  , max(case when pvt.itemid = 454 then pvt.valuenum else null end) as GCSMotor
  , max(case when pvt.itemid = 723 then pvt.valuenum else null end) as GCSVerbal
  , max(case when pvt.itemid = 184 then pvt.valuenum else null end) as GCSEyes

  -- If verbal was set to 0 in the below select, then this is an intubated patient
  , case
      when max(case when pvt.itemid = 723 then pvt.valuenum else null end) = 0
    then 1
    else 0
    end as EndoTrachFlag

  , ROW_NUMBER ()
          OVER (PARTITION BY pvt.ICUSTAY_ID ORDER BY pvt.charttime ASC) as rn

  FROM  (
  select l.ICUSTAY_ID
  -- merge the ITEMIDs so that the pivot applies to both metavision/carevue data
  , case
      when l.ITEMID in (723,223900) then 723
      when l.ITEMID in (454,223901) then 454
      when l.ITEMID in (184,220739) then 184
      else l.ITEMID end
    as ITEMID

  -- convert the data into a number, reserving a value of 0 for ET/Trach
  , case
      -- endotrach/vent is assigned a value of 0, later parsed specially
      when l.ITEMID = 723 and l.VALUE = '1.0 ET/Trach' then 0 -- carevue
      when l.ITEMID = 223900 and l.VALUE = 'No Response-ETT' then 0 -- metavision

      else VALUENUM
      end
    as VALUENUM
  , l.CHARTTIME
  FROM chartevents l

  -- get intime for charttime subselection
  inner join icustays b
    on l.icustay_id = b.icustay_id

  -- Isolate the desired GCS variables
  where l.ITEMID in
  (
    -- 198 -- GCS
    -- GCS components, CareVue
    184, 454, 723
    -- GCS components, Metavision
    , 223900, 223901, 220739
  )
  -- Only get data for the first 24 hours
  and l.charttime between b.intime and DATETIME_ADD(b.intime, INTERVAL '1' DAY)
  -- exclude rows marked as error
  AND (l.error IS NULL OR l.error = 0)
  ) pvt
  group by pvt.ICUSTAY_ID, pvt.charttime
)
, gcs as (
  select b.*
  , b2.GCSVerbal as GCSVerbalPrev
  , b2.GCSMotor as GCSMotorPrev
  , b2.GCSEyes as GCSEyesPrev
  -- Calculate GCS, factoring in special case when they are intubated and prev vals
  -- note that the coalesce are used to implement the following if:
  --  if current value exists, use it
  --  if previous value exists, use it
  --  otherwise, default to normal
  , case
      -- replace GCS during sedation with 15
      when b.GCSVerbal = 0
        then 15
      when b.GCSVerbal is null and b2.GCSVerbal = 0
        then 15
      -- if previously they were intub, but they aren't now, do not use previous GCS values
      when b2.GCSVerbal = 0
        then
            coalesce(b.GCSMotor,6)
          + coalesce(b.GCSVerbal,5)
          + coalesce(b.GCSEyes,4)
      -- otherwise, add up score normally, imputing previous value if none available at current time
      else
            coalesce(b.GCSMotor,coalesce(b2.GCSMotor,6))
          + coalesce(b.GCSVerbal,coalesce(b2.GCSVerbal,5))
          + coalesce(b.GCSEyes,coalesce(b2.GCSEyes,4))
      end as GCS

  from base b
  -- join to itself within 6 hours to get previous value
  left join base b2
    on b.ICUSTAY_ID = b2.ICUSTAY_ID and b.rn = b2.rn+1 and b2.charttime > DATETIME_SUB(b.charttime, INTERVAL '6' HOUR)
)
, gcs_final as (
  select gcs.*
  -- This sorts the data by GCS, so rn=1 is the the lowest GCS values to keep
  , ROW_NUMBER ()
          OVER (PARTITION BY gcs.ICUSTAY_ID
                ORDER BY gcs.GCS
               ) as IsMinGCS
  from gcs
)
select ie.subject_id, ie.hadm_id, ie.icustay_id
-- The minimum GCS is determined by the above row partition, we only join if IsMinGCS=1
, GCS as mingcs
, coalesce(GCSMotor,GCSMotorPrev) as gcsmotor
, coalesce(GCSVerbal,GCSVerbalPrev) as gcsverbal
, coalesce(GCSEyes,GCSEyesPrev) as gcseyes
, EndoTrachFlag as endotrachflag

-- subselect down to the cohort of eligible patients
FROM icustays ie
left join gcs_final gs
  on ie.icustay_id = gs.icustay_id and gs.IsMinGCS = 1
ORDER BY ie.icustay_id
  );",109348,Thread-1,2022-07-18T00:10:28.586584Z
E017,,debug,SQL status: SELECT 61532 in 0.11 seconds,109348,Thread-1,2022-07-18T00:10:28.693878Z
E015,,debug,"Using postgres connection ""model.mimic.gcs_first_day""",109348,Thread-1,2022-07-18T00:10:28.698661Z
E016,,debug,"On model.mimic.gcs_first_day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.gcs_first_day""} */
alter table ""postgres"".""public"".""gcs_first_day"" rename to ""gcs_first_day__dbt_backup""",109348,Thread-1,2022-07-18T00:10:28.698918Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:28.699897Z
E015,,debug,"Using postgres connection ""model.mimic.gcs_first_day""",109348,Thread-1,2022-07-18T00:10:28.708471Z
E016,,debug,"On model.mimic.gcs_first_day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.gcs_first_day""} */
alter table ""postgres"".""public"".""gcs_first_day__dbt_tmp"" rename to ""gcs_first_day""",109348,Thread-1,2022-07-18T00:10:28.708701Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:28.709552Z
E018,,debug,On model.mimic.gcs_first_day: COMMIT,109348,Thread-1,2022-07-18T00:10:28.712539Z
E015,,debug,"Using postgres connection ""model.mimic.gcs_first_day""",109348,Thread-1,2022-07-18T00:10:28.712741Z
E016,,debug,On model.mimic.gcs_first_day: COMMIT,109348,Thread-1,2022-07-18T00:10:28.713087Z
E017,,debug,SQL status: COMMIT in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:28.718746Z
E015,,debug,"Using postgres connection ""model.mimic.gcs_first_day""",109348,Thread-1,2022-07-18T00:10:28.720940Z
E016,,debug,"On model.mimic.gcs_first_day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.gcs_first_day""} */
drop table if exists ""postgres"".""public"".""gcs_first_day__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:28.721231Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:28.725752Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:28.728613Z
E010,,debug,On model.mimic.gcs_first_day: Close,109348,Thread-1,2022-07-18T00:10:28.728876Z
Q012,0,info,27 of 107 OK created table model public.gcs_first_day .......................... [[32mSELECT 61532[0m in 0.17s],109348,Thread-1,2022-07-18T00:10:28.730114Z,table,null,gcs_first_day,firstday/gcs_first_day.sql,2022-07-18T00:10:28.555181,compiling,model,,,
Q024,0.17302536964416504,debug,Finished running node model.mimic.gcs_first_day,109348,Thread-1,2022-07-18T00:10:28.731590Z,table,2022-07-18T00:10:28.731372,gcs_first_day,firstday/gcs_first_day.sql,2022-07-18T00:10:28.555181,success,model,,,
Q023,,debug,Began running node model.mimic.glucose,109348,Thread-1,2022-07-18T00:10:28.732198Z,table,null,glucose,cookbook/glucose.sql,2022-07-18T00:10:28.731990,started,model,,,
Q033,,info,28 of 107 START table model public.glucose ..................................... [RUN],109348,Thread-1,2022-07-18T00:10:28.732797Z,table,null,glucose,cookbook/glucose.sql,2022-07-18T00:10:28.731990,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.glucose""",109348,Thread-1,2022-07-18T00:10:28.733383Z
Q030,,debug,Began compiling node model.mimic.glucose,109348,Thread-1,2022-07-18T00:10:28.734008Z,table,null,glucose,cookbook/glucose.sql,2022-07-18T00:10:28.731990,compiling,model,,,
Q027,,debug,Compiling model.mimic.glucose,109348,Thread-1,2022-07-18T00:10:28.734568Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.glucose""",109348,Thread-1,2022-07-18T00:10:28.735940Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:28.736371Z
Q031,,debug,Began executing node model.mimic.glucose,109348,Thread-1,2022-07-18T00:10:28.736525Z,table,null,glucose,cookbook/glucose.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.glucose""",109348,Thread-1,2022-07-18T00:10:28.743849Z
E015,,debug,"Using postgres connection ""model.mimic.glucose""",109348,Thread-1,2022-07-18T00:10:28.744303Z
E016,,debug,On model.mimic.glucose: BEGIN,109348,Thread-1,2022-07-18T00:10:28.744539Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:28.744750Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:28.751468Z
E015,,debug,"Using postgres connection ""model.mimic.glucose""",109348,Thread-1,2022-07-18T00:10:28.751977Z
E016,,debug,"On model.mimic.glucose: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.glucose""} */


  create  table ""postgres"".""public"".""glucose__dbt_tmp""
  as (
    -- --------------------------------------------------------
-- Title: Retrieves a glucose histogram of adult patients
-- Notes: this query does not specify a schema. To run it on your local
-- MIMIC schema, run the following command:
--  SET SEARCH_PATH TO mimiciii
-- Where ""mimiciii"" is the name of your schema, and may be different.
-- --------------------------------------------------------

WITH agetbl AS
(
  SELECT ad.subject_id
  FROM admissions ad
  INNER JOIN patients p
  ON ad.subject_id = p.subject_id
  WHERE
  -- filter to only adults
  DATETIME_DIFF(ad.admittime, p.dob, 'YEAR') > 15
  -- group by subject_id to ensure there is only 1 subject_id per row
  group by ad.subject_id
)
, glc as
(
  SELECT width_bucket(valuenum, 0.5, 1000, 1000) AS bucket
  FROM labevents le
  INNER JOIN agetbl
  ON le.subject_id = agetbl.subject_id
  WHERE itemid IN (50809,50931)
  AND valuenum IS NOT NULL
)
SELECT bucket as glucose, count(*)
FROM glc
GROUP BY bucket
ORDER BY bucket
  );",109348,Thread-1,2022-07-18T00:10:28.752632Z
E017,,debug,SQL status: SELECT 0 in 0.16 seconds,109348,Thread-1,2022-07-18T00:10:28.914593Z
E015,,debug,"Using postgres connection ""model.mimic.glucose""",109348,Thread-1,2022-07-18T00:10:28.921385Z
E016,,debug,"On model.mimic.glucose: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.glucose""} */
alter table ""postgres"".""public"".""glucose"" rename to ""glucose__dbt_backup""",109348,Thread-1,2022-07-18T00:10:28.921709Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:28.922499Z
E015,,debug,"Using postgres connection ""model.mimic.glucose""",109348,Thread-1,2022-07-18T00:10:28.926183Z
E016,,debug,"On model.mimic.glucose: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.glucose""} */
alter table ""postgres"".""public"".""glucose__dbt_tmp"" rename to ""glucose""",109348,Thread-1,2022-07-18T00:10:28.926431Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:28.927160Z
E018,,debug,On model.mimic.glucose: COMMIT,109348,Thread-1,2022-07-18T00:10:28.930294Z
E015,,debug,"Using postgres connection ""model.mimic.glucose""",109348,Thread-1,2022-07-18T00:10:28.930539Z
E016,,debug,On model.mimic.glucose: COMMIT,109348,Thread-1,2022-07-18T00:10:28.930763Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:28.932214Z
E015,,debug,"Using postgres connection ""model.mimic.glucose""",109348,Thread-1,2022-07-18T00:10:28.935185Z
E016,,debug,"On model.mimic.glucose: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.glucose""} */
drop table if exists ""postgres"".""public"".""glucose__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:28.935424Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:28.937469Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:28.940862Z
E010,,debug,On model.mimic.glucose: Close,109348,Thread-1,2022-07-18T00:10:28.941215Z
Q012,0,info,28 of 107 OK created table model public.glucose ................................ [[32mSELECT 0[0m in 0.21s],109348,Thread-1,2022-07-18T00:10:28.942185Z,table,null,glucose,cookbook/glucose.sql,2022-07-18T00:10:28.731990,compiling,model,,,
Q024,0.2088944911956787,debug,Finished running node model.mimic.glucose,109348,Thread-1,2022-07-18T00:10:28.942837Z,table,2022-07-18T00:10:28.942665,glucose,cookbook/glucose.sql,2022-07-18T00:10:28.731990,success,model,,,
Q023,,debug,Began running node model.mimic.hco,109348,Thread-1,2022-07-18T00:10:28.943305Z,table,null,hco,cookbook/hco.sql,2022-07-18T00:10:28.943220,started,model,,,
Q033,,info,29 of 107 START table model public.hco ......................................... [RUN],109348,Thread-1,2022-07-18T00:10:28.943985Z,table,null,hco,cookbook/hco.sql,2022-07-18T00:10:28.943220,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.hco""",109348,Thread-1,2022-07-18T00:10:28.944675Z
Q030,,debug,Began compiling node model.mimic.hco,109348,Thread-1,2022-07-18T00:10:28.944947Z,table,null,hco,cookbook/hco.sql,2022-07-18T00:10:28.943220,compiling,model,,,
Q027,,debug,Compiling model.mimic.hco,109348,Thread-1,2022-07-18T00:10:28.945362Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.hco""",109348,Thread-1,2022-07-18T00:10:28.946764Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:28.947381Z
Q031,,debug,Began executing node model.mimic.hco,109348,Thread-1,2022-07-18T00:10:28.947635Z,table,null,hco,cookbook/hco.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.hco""",109348,Thread-1,2022-07-18T00:10:28.958939Z
E015,,debug,"Using postgres connection ""model.mimic.hco""",109348,Thread-1,2022-07-18T00:10:28.959893Z
E016,,debug,On model.mimic.hco: BEGIN,109348,Thread-1,2022-07-18T00:10:28.960393Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:28.961191Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:28.969002Z
E015,,debug,"Using postgres connection ""model.mimic.hco""",109348,Thread-1,2022-07-18T00:10:28.969507Z
E016,,debug,"On model.mimic.hco: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.hco""} */


  create  table ""postgres"".""public"".""hco__dbt_tmp""
  as (
    -- --------------------------------------------------------
-- Title: Create a histogram bicarbonate levels for all patients (adults and neonates)
-- Notes: this query does not specify a schema. To run it on your local
-- MIMIC schema, run the following command:
--  SET SEARCH_PATH TO mimiciii
-- Where ""mimiciii"" is the name of your schema, and may be different.
-- --------------------------------------------------------

WITH agetbl AS
(
  SELECT ad.subject_id
  FROM admissions ad
  INNER JOIN patients p
  ON ad.subject_id = p.subject_id
  WHERE
  -- filter to only adults
  DATETIME_DIFF(ad.admittime, p.dob, 'YEAR') > 15
  -- group by subject_id to ensure there is only 1 subject_id per row
  group by ad.subject_id
)
, hco as
(
  SELECT width_bucket(valuenum, 0, 231, 231) AS bucket
  FROM labevents le
  INNER JOIN agetbl
  ON le.subject_id = agetbl.subject_id
  WHERE itemid IN (50803, 50804, 50882)
  AND valuenum IS NOT NULL
)
SELECT bucket as bicarbonate, count(*)
FROM hco
GROUP BY bucket
ORDER BY bucket
  );",109348,Thread-1,2022-07-18T00:10:28.970063Z
E017,,debug,SQL status: SELECT 0 in 0.15 seconds,109348,Thread-1,2022-07-18T00:10:29.118418Z
E015,,debug,"Using postgres connection ""model.mimic.hco""",109348,Thread-1,2022-07-18T00:10:29.122934Z
E016,,debug,"On model.mimic.hco: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.hco""} */
alter table ""postgres"".""public"".""hco"" rename to ""hco__dbt_backup""",109348,Thread-1,2022-07-18T00:10:29.123181Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:29.123955Z
E015,,debug,"Using postgres connection ""model.mimic.hco""",109348,Thread-1,2022-07-18T00:10:29.127845Z
E016,,debug,"On model.mimic.hco: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.hco""} */
alter table ""postgres"".""public"".""hco__dbt_tmp"" rename to ""hco""",109348,Thread-1,2022-07-18T00:10:29.128089Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:29.128807Z
E018,,debug,On model.mimic.hco: COMMIT,109348,Thread-1,2022-07-18T00:10:29.131791Z
E015,,debug,"Using postgres connection ""model.mimic.hco""",109348,Thread-1,2022-07-18T00:10:29.132010Z
E016,,debug,On model.mimic.hco: COMMIT,109348,Thread-1,2022-07-18T00:10:29.132265Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:29.133806Z
E015,,debug,"Using postgres connection ""model.mimic.hco""",109348,Thread-1,2022-07-18T00:10:29.135699Z
E016,,debug,"On model.mimic.hco: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.hco""} */
drop table if exists ""postgres"".""public"".""hco__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:29.135909Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:29.138508Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:29.142043Z
E010,,debug,On model.mimic.hco: Close,109348,Thread-1,2022-07-18T00:10:29.142324Z
Q012,0,info,29 of 107 OK created table model public.hco .................................... [[32mSELECT 0[0m in 0.20s],109348,Thread-1,2022-07-18T00:10:29.143176Z,table,null,hco,cookbook/hco.sql,2022-07-18T00:10:28.943220,compiling,model,,,
Q024,0.19867968559265137,debug,Finished running node model.mimic.hco,109348,Thread-1,2022-07-18T00:10:29.143820Z,table,2022-07-18T00:10:29.143651,hco,cookbook/hco.sql,2022-07-18T00:10:28.943220,success,model,,,
Q023,,debug,Began running node model.mimic.heart_rate,109348,Thread-1,2022-07-18T00:10:29.144285Z,table,null,heart_rate,cookbook/heart_rate.sql,2022-07-18T00:10:29.144200,started,model,,,
Q033,,info,30 of 107 START table model public.heart_rate .................................. [RUN],109348,Thread-1,2022-07-18T00:10:29.145061Z,table,null,heart_rate,cookbook/heart_rate.sql,2022-07-18T00:10:29.144200,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.heart_rate""",109348,Thread-1,2022-07-18T00:10:29.145840Z
Q030,,debug,Began compiling node model.mimic.heart_rate,109348,Thread-1,2022-07-18T00:10:29.146391Z,table,null,heart_rate,cookbook/heart_rate.sql,2022-07-18T00:10:29.144200,compiling,model,,,
Q027,,debug,Compiling model.mimic.heart_rate,109348,Thread-1,2022-07-18T00:10:29.146808Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.heart_rate""",109348,Thread-1,2022-07-18T00:10:29.148312Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:29.148741Z
Q031,,debug,Began executing node model.mimic.heart_rate,109348,Thread-1,2022-07-18T00:10:29.149190Z,table,null,heart_rate,cookbook/heart_rate.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.heart_rate""",109348,Thread-1,2022-07-18T00:10:29.163132Z
E015,,debug,"Using postgres connection ""model.mimic.heart_rate""",109348,Thread-1,2022-07-18T00:10:29.163982Z
E016,,debug,On model.mimic.heart_rate: BEGIN,109348,Thread-1,2022-07-18T00:10:29.164261Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:29.164421Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:29.173298Z
E015,,debug,"Using postgres connection ""model.mimic.heart_rate""",109348,Thread-1,2022-07-18T00:10:29.173928Z
E016,,debug,"On model.mimic.heart_rate: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.heart_rate""} */


  create  table ""postgres"".""public"".""heart_rate__dbt_tmp""
  as (
    -- --------------------------------------------------------
-- Title: Create a histogram of heart rates for adult patients
-- Notes: this query does not specify a schema. To run it on your local
-- MIMIC schema, run the following command:
--  SET SEARCH_PATH TO mimiciii
-- Where ""mimiciii"" is the name of your schema, and may be different.
-- --------------------------------------------------------

WITH agetbl AS
(
  SELECT ad.subject_id
  FROM admissions ad
  INNER JOIN patients p
  ON ad.subject_id = p.subject_id
  WHERE
  -- filter to only adults
  DATETIME_DIFF(ad.admittime, p.dob, 'YEAR') > 15
  -- group by subject_id to ensure there is only 1 subject_id per row
  group by ad.subject_id
)
, hr as
(
  SELECT width_bucket(valuenum, 0, 300, 301) AS bucket
  FROM chartevents ce
  INNER JOIN agetbl
  ON ce.subject_id = agetbl.subject_id
  WHERE itemid in (211,220045)
)
SELECT bucket as heart_rate, count(*)
FROM hr
GROUP BY bucket
ORDER BY bucket
  );",109348,Thread-1,2022-07-18T00:10:29.174212Z
E017,,debug,SQL status: SELECT 75 in 0.17 seconds,109348,Thread-1,2022-07-18T00:10:29.342539Z
E015,,debug,"Using postgres connection ""model.mimic.heart_rate""",109348,Thread-1,2022-07-18T00:10:29.349227Z
E016,,debug,"On model.mimic.heart_rate: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.heart_rate""} */
alter table ""postgres"".""public"".""heart_rate"" rename to ""heart_rate__dbt_backup""",109348,Thread-1,2022-07-18T00:10:29.349726Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:29.351217Z
E015,,debug,"Using postgres connection ""model.mimic.heart_rate""",109348,Thread-1,2022-07-18T00:10:29.356740Z
E016,,debug,"On model.mimic.heart_rate: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.heart_rate""} */
alter table ""postgres"".""public"".""heart_rate__dbt_tmp"" rename to ""heart_rate""",109348,Thread-1,2022-07-18T00:10:29.356985Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:29.357845Z
E018,,debug,On model.mimic.heart_rate: COMMIT,109348,Thread-1,2022-07-18T00:10:29.360739Z
E015,,debug,"Using postgres connection ""model.mimic.heart_rate""",109348,Thread-1,2022-07-18T00:10:29.360962Z
E016,,debug,On model.mimic.heart_rate: COMMIT,109348,Thread-1,2022-07-18T00:10:29.361103Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:29.362833Z
E015,,debug,"Using postgres connection ""model.mimic.heart_rate""",109348,Thread-1,2022-07-18T00:10:29.407248Z
E016,,debug,"On model.mimic.heart_rate: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.heart_rate""} */
drop table if exists ""postgres"".""public"".""heart_rate__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:29.407519Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:29.409825Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:29.413220Z
E010,,debug,On model.mimic.heart_rate: Close,109348,Thread-1,2022-07-18T00:10:29.413473Z
Q012,0,info,30 of 107 OK created table model public.heart_rate ............................. [[32mSELECT 75[0m in 0.27s],109348,Thread-1,2022-07-18T00:10:29.414512Z,table,null,heart_rate,cookbook/heart_rate.sql,2022-07-18T00:10:29.144200,compiling,model,,,
Q024,0.2688751220703125,debug,Finished running node model.mimic.heart_rate,109348,Thread-1,2022-07-18T00:10:29.415300Z,table,2022-07-18T00:10:29.415048,heart_rate,cookbook/heart_rate.sql,2022-07-18T00:10:29.144200,success,model,,,
Q023,,debug,Began running node model.mimic.height,109348,Thread-1,2022-07-18T00:10:29.416048Z,table,null,height,cookbook/height.sql,2022-07-18T00:10:29.415860,started,model,,,
Q033,,info,31 of 107 START table model public.height ...................................... [RUN],109348,Thread-1,2022-07-18T00:10:29.416753Z,table,null,height,cookbook/height.sql,2022-07-18T00:10:29.415860,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.height""",109348,Thread-1,2022-07-18T00:10:29.417467Z
Q030,,debug,Began compiling node model.mimic.height,109348,Thread-1,2022-07-18T00:10:29.417974Z,table,null,height,cookbook/height.sql,2022-07-18T00:10:29.415860,compiling,model,,,
Q027,,debug,Compiling model.mimic.height,109348,Thread-1,2022-07-18T00:10:29.418342Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.height""",109348,Thread-1,2022-07-18T00:10:29.420232Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:29.420925Z
Q031,,debug,Began executing node model.mimic.height,109348,Thread-1,2022-07-18T00:10:29.421240Z,table,null,height,cookbook/height.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.height""",109348,Thread-1,2022-07-18T00:10:29.430494Z
E015,,debug,"Using postgres connection ""model.mimic.height""",109348,Thread-1,2022-07-18T00:10:29.431114Z
E016,,debug,On model.mimic.height: BEGIN,109348,Thread-1,2022-07-18T00:10:29.431354Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:29.431556Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:29.438852Z
E015,,debug,"Using postgres connection ""model.mimic.height""",109348,Thread-1,2022-07-18T00:10:29.439136Z
E016,,debug,"On model.mimic.height: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.height""} */


  create  table ""postgres"".""public"".""height__dbt_tmp""
  as (
    -- --------------------------------------------------------
-- Title: Create a histogram of heights for all patients
--  note: some height ITEMIDs were not included, which may implicitly exclude
--  some neonates from this calculation
-- Notes: this query does not specify a schema. To run it on your local
-- MIMIC schema, run the following command:
--  SET SEARCH_PATH TO mimiciii
-- Where ""mimiciii"" is the name of your schema, and may be different.
-- --------------------------------------------------------

WITH ht AS
(
  SELECT valuenum, width_bucket(valuenum, 1, 200, 200) AS bucket
  FROM chartevents
  WHERE itemid in (920,226730)
  AND valuenum IS NOT NULL
  AND valuenum > 0
  AND valuenum < 500
)
SELECT bucket as height, count(*)
FROM ht
GROUP BY bucket
ORDER BY bucket
  );",109348,Thread-1,2022-07-18T00:10:29.439359Z
E017,,debug,SQL status: SELECT 6 in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:29.444744Z
E015,,debug,"Using postgres connection ""model.mimic.height""",109348,Thread-1,2022-07-18T00:10:29.449505Z
E016,,debug,"On model.mimic.height: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.height""} */
alter table ""postgres"".""public"".""height"" rename to ""height__dbt_backup""",109348,Thread-1,2022-07-18T00:10:29.451699Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:29.453037Z
E015,,debug,"Using postgres connection ""model.mimic.height""",109348,Thread-1,2022-07-18T00:10:29.458463Z
E016,,debug,"On model.mimic.height: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.height""} */
alter table ""postgres"".""public"".""height__dbt_tmp"" rename to ""height""",109348,Thread-1,2022-07-18T00:10:29.458771Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:29.459513Z
E018,,debug,On model.mimic.height: COMMIT,109348,Thread-1,2022-07-18T00:10:29.463655Z
E015,,debug,"Using postgres connection ""model.mimic.height""",109348,Thread-1,2022-07-18T00:10:29.463944Z
E016,,debug,On model.mimic.height: COMMIT,109348,Thread-1,2022-07-18T00:10:29.464161Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:29.465174Z
E015,,debug,"Using postgres connection ""model.mimic.height""",109348,Thread-1,2022-07-18T00:10:29.468290Z
E016,,debug,"On model.mimic.height: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.height""} */
drop table if exists ""postgres"".""public"".""height__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:29.468681Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:29.471655Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:29.475477Z
E010,,debug,On model.mimic.height: Close,109348,Thread-1,2022-07-18T00:10:29.475738Z
Q012,0,info,31 of 107 OK created table model public.height ................................. [[32mSELECT 6[0m in 0.06s],109348,Thread-1,2022-07-18T00:10:29.476738Z,table,null,height,cookbook/height.sql,2022-07-18T00:10:29.415860,compiling,model,,,
Q024,0.05935478210449219,debug,Finished running node model.mimic.height,109348,Thread-1,2022-07-18T00:10:29.477322Z,table,2022-07-18T00:10:29.477192,height,cookbook/height.sql,2022-07-18T00:10:29.415860,success,model,,,
Q023,,debug,Began running node model.mimic.icd9agelimited,109348,Thread-1,2022-07-18T00:10:29.477800Z,table,null,icd9agelimited,cookbook/icd9agelimited.sql,2022-07-18T00:10:29.477672,started,model,,,
Q033,,info,32 of 107 START table model public.icd9agelimited .............................. [RUN],109348,Thread-1,2022-07-18T00:10:29.478608Z,table,null,icd9agelimited,cookbook/icd9agelimited.sql,2022-07-18T00:10:29.477672,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.icd9agelimited""",109348,Thread-1,2022-07-18T00:10:29.479493Z
Q030,,debug,Began compiling node model.mimic.icd9agelimited,109348,Thread-1,2022-07-18T00:10:29.479705Z,table,null,icd9agelimited,cookbook/icd9agelimited.sql,2022-07-18T00:10:29.477672,compiling,model,,,
Q027,,debug,Compiling model.mimic.icd9agelimited,109348,Thread-1,2022-07-18T00:10:29.479943Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.icd9agelimited""",109348,Thread-1,2022-07-18T00:10:29.481439Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:29.482076Z
Q031,,debug,Began executing node model.mimic.icd9agelimited,109348,Thread-1,2022-07-18T00:10:29.482444Z,table,null,icd9agelimited,cookbook/icd9agelimited.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.icd9agelimited""",109348,Thread-1,2022-07-18T00:10:29.493071Z
E015,,debug,"Using postgres connection ""model.mimic.icd9agelimited""",109348,Thread-1,2022-07-18T00:10:29.494350Z
E016,,debug,On model.mimic.icd9agelimited: BEGIN,109348,Thread-1,2022-07-18T00:10:29.494923Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:29.495277Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:29.503378Z
E015,,debug,"Using postgres connection ""model.mimic.icd9agelimited""",109348,Thread-1,2022-07-18T00:10:29.503775Z
E016,,debug,"On model.mimic.icd9agelimited: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.icd9agelimited""} */


  create  table ""postgres"".""public"".""icd9agelimited__dbt_tmp""
  as (
    -- ------------------------------------------------------------------
-- Title: Count the number of patients with a specific icd9 code above a certain age
-- MIMIC version: MIMIC-III v1.3
-- Notes: this query does not specify a schema. To run it on your local
-- MIMIC schema, run the following command:
-- SET SEARCH_PATH TO mimiciii
-- Where ""mimiciii"" is the name of your schema, and may be different.
-- Reference: tompollard, alistairewj, erinhong for code taken
-- from sodium.sql on the MIMIC III github repository
-- ------------------------------------------------------------------

WITH agetbl AS 
	(
	SELECT ad.subject_id 
	FROM admissions ad 
	INNER JOIN patients p 
	ON ad.subject_id = p.subject_id 
	WHERE 
	-- filter to only adults above 30
	DATETIME_DIFF(ad.admittime, p.dob, 'YEAR') > 30
	-- group by subject_id to ensure there is only 1 subject_id per row
	GROUP BY ad.subject_id
	) 
SELECT COUNT(DISTINCT dia.subject_id) 
AS ""Hypertension Age 30+"" 
from diagnoses_icd dia 
INNER JOIN agetbl 
ON dia.subject_id = agetbl.subject_id 
WHERE dia.icd9_code 
-- 401% relates to Hypertension
LIKE '401%'
  );",109348,Thread-1,2022-07-18T00:10:29.504063Z
E017,,debug,SQL status: SELECT 1 in 0.22 seconds,109348,Thread-1,2022-07-18T00:10:29.720465Z
E015,,debug,"Using postgres connection ""model.mimic.icd9agelimited""",109348,Thread-1,2022-07-18T00:10:29.724920Z
E016,,debug,"On model.mimic.icd9agelimited: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.icd9agelimited""} */
alter table ""postgres"".""public"".""icd9agelimited"" rename to ""icd9agelimited__dbt_backup""",109348,Thread-1,2022-07-18T00:10:29.725133Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:29.726035Z
E015,,debug,"Using postgres connection ""model.mimic.icd9agelimited""",109348,Thread-1,2022-07-18T00:10:29.729435Z
E016,,debug,"On model.mimic.icd9agelimited: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.icd9agelimited""} */
alter table ""postgres"".""public"".""icd9agelimited__dbt_tmp"" rename to ""icd9agelimited""",109348,Thread-1,2022-07-18T00:10:29.729971Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:29.730670Z
E018,,debug,On model.mimic.icd9agelimited: COMMIT,109348,Thread-1,2022-07-18T00:10:29.733925Z
E015,,debug,"Using postgres connection ""model.mimic.icd9agelimited""",109348,Thread-1,2022-07-18T00:10:29.734205Z
E016,,debug,On model.mimic.icd9agelimited: COMMIT,109348,Thread-1,2022-07-18T00:10:29.734418Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:29.735827Z
E015,,debug,"Using postgres connection ""model.mimic.icd9agelimited""",109348,Thread-1,2022-07-18T00:10:29.737536Z
E016,,debug,"On model.mimic.icd9agelimited: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.icd9agelimited""} */
drop table if exists ""postgres"".""public"".""icd9agelimited__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:29.737888Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:29.739859Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:29.743479Z
E010,,debug,On model.mimic.icd9agelimited: Close,109348,Thread-1,2022-07-18T00:10:29.743732Z
Q012,0,info,32 of 107 OK created table model public.icd9agelimited ......................... [[32mSELECT 1[0m in 0.27s],109348,Thread-1,2022-07-18T00:10:29.744645Z,table,null,icd9agelimited,cookbook/icd9agelimited.sql,2022-07-18T00:10:29.477672,compiling,model,,,
Q024,0.26523423194885254,debug,Finished running node model.mimic.icd9agelimited,109348,Thread-1,2022-07-18T00:10:29.745133Z,table,2022-07-18T00:10:29.745031,icd9agelimited,cookbook/icd9agelimited.sql,2022-07-18T00:10:29.477672,success,model,,,
Q023,,debug,Began running node model.mimic.icd9count,109348,Thread-1,2022-07-18T00:10:29.745576Z,table,null,icd9count,cookbook/icd9count.sql,2022-07-18T00:10:29.745496,started,model,,,
Q033,,info,33 of 107 START table model public.icd9count ................................... [RUN],109348,Thread-1,2022-07-18T00:10:29.746476Z,table,null,icd9count,cookbook/icd9count.sql,2022-07-18T00:10:29.745496,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.icd9count""",109348,Thread-1,2022-07-18T00:10:29.747356Z
Q030,,debug,Began compiling node model.mimic.icd9count,109348,Thread-1,2022-07-18T00:10:29.748003Z,table,null,icd9count,cookbook/icd9count.sql,2022-07-18T00:10:29.745496,compiling,model,,,
Q027,,debug,Compiling model.mimic.icd9count,109348,Thread-1,2022-07-18T00:10:29.748407Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.icd9count""",109348,Thread-1,2022-07-18T00:10:29.750259Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:29.751105Z
Q031,,debug,Began executing node model.mimic.icd9count,109348,Thread-1,2022-07-18T00:10:29.751475Z,table,null,icd9count,cookbook/icd9count.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.icd9count""",109348,Thread-1,2022-07-18T00:10:29.764735Z
E015,,debug,"Using postgres connection ""model.mimic.icd9count""",109348,Thread-1,2022-07-18T00:10:29.766407Z
E016,,debug,On model.mimic.icd9count: BEGIN,109348,Thread-1,2022-07-18T00:10:29.766811Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:29.767312Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:29.774478Z
E015,,debug,"Using postgres connection ""model.mimic.icd9count""",109348,Thread-1,2022-07-18T00:10:29.774964Z
E016,,debug,"On model.mimic.icd9count: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.icd9count""} */


  create  table ""postgres"".""public"".""icd9count__dbt_tmp""
  as (
    -- ------------------------------------------------------------------
-- Title: Count the number of patients with a specific icd9 code
-- MIMIC version: MIMIC-III v1.3
-- Notes: this query does not specify a schema. To run it on your local
-- MIMIC schema, run the following command:
-- SET SEARCH_PATH TO mimiciii
-- Where ""mimiciii"" is the name of your schema, and may be different.
-- Acknowledgement: Credit goes to Kris Kindle
-- ------------------------------------------------------------------

SELECT COUNT(DISTINCT subject_id) 
AS ""Hypertension"" 
from diagnoses_icd 
WHERE icd9_code 
-- 401% will search for all icd9 codes relating to hypertension
LIKE '401%'
  );",109348,Thread-1,2022-07-18T00:10:29.775467Z
E017,,debug,SQL status: SELECT 1 in 0.03 seconds,109348,Thread-1,2022-07-18T00:10:29.802111Z
E015,,debug,"Using postgres connection ""model.mimic.icd9count""",109348,Thread-1,2022-07-18T00:10:29.807164Z
E016,,debug,"On model.mimic.icd9count: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.icd9count""} */
alter table ""postgres"".""public"".""icd9count"" rename to ""icd9count__dbt_backup""",109348,Thread-1,2022-07-18T00:10:29.807407Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:29.808251Z
E015,,debug,"Using postgres connection ""model.mimic.icd9count""",109348,Thread-1,2022-07-18T00:10:29.813333Z
E016,,debug,"On model.mimic.icd9count: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.icd9count""} */
alter table ""postgres"".""public"".""icd9count__dbt_tmp"" rename to ""icd9count""",109348,Thread-1,2022-07-18T00:10:29.813729Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:29.814579Z
E018,,debug,On model.mimic.icd9count: COMMIT,109348,Thread-1,2022-07-18T00:10:29.820022Z
E015,,debug,"Using postgres connection ""model.mimic.icd9count""",109348,Thread-1,2022-07-18T00:10:29.820275Z
E016,,debug,On model.mimic.icd9count: COMMIT,109348,Thread-1,2022-07-18T00:10:29.820405Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:29.821401Z
E015,,debug,"Using postgres connection ""model.mimic.icd9count""",109348,Thread-1,2022-07-18T00:10:29.823490Z
E016,,debug,"On model.mimic.icd9count: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.icd9count""} */
drop table if exists ""postgres"".""public"".""icd9count__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:29.823856Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:29.825793Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:29.828356Z
E010,,debug,On model.mimic.icd9count: Close,109348,Thread-1,2022-07-18T00:10:29.828606Z
Q012,0,info,33 of 107 OK created table model public.icd9count .............................. [[32mSELECT 1[0m in 0.08s],109348,Thread-1,2022-07-18T00:10:29.829146Z,table,null,icd9count,cookbook/icd9count.sql,2022-07-18T00:10:29.745496,compiling,model,,,
Q024,0.0819847583770752,debug,Finished running node model.mimic.icd9count,109348,Thread-1,2022-07-18T00:10:29.829493Z,table,2022-07-18T00:10:29.829403,icd9count,cookbook/icd9count.sql,2022-07-18T00:10:29.745496,success,model,,,
Q023,,debug,Began running node model.mimic.icd9vagehistogram,109348,Thread-1,2022-07-18T00:10:29.830018Z,table,null,icd9vagehistogram,cookbook/icd9vagehistogram.sql,2022-07-18T00:10:29.829941,started,model,,,
Q033,,info,34 of 107 START table model public.icd9vagehistogram ........................... [RUN],109348,Thread-1,2022-07-18T00:10:29.830741Z,table,null,icd9vagehistogram,cookbook/icd9vagehistogram.sql,2022-07-18T00:10:29.829941,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.icd9vagehistogram""",109348,Thread-1,2022-07-18T00:10:29.831524Z
Q030,,debug,Began compiling node model.mimic.icd9vagehistogram,109348,Thread-1,2022-07-18T00:10:29.831863Z,table,null,icd9vagehistogram,cookbook/icd9vagehistogram.sql,2022-07-18T00:10:29.829941,compiling,model,,,
Q027,,debug,Compiling model.mimic.icd9vagehistogram,109348,Thread-1,2022-07-18T00:10:29.832182Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.icd9vagehistogram""",109348,Thread-1,2022-07-18T00:10:29.834329Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:29.834859Z
Q031,,debug,Began executing node model.mimic.icd9vagehistogram,109348,Thread-1,2022-07-18T00:10:29.835119Z,table,null,icd9vagehistogram,cookbook/icd9vagehistogram.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.icd9vagehistogram""",109348,Thread-1,2022-07-18T00:10:29.844078Z
E015,,debug,"Using postgres connection ""model.mimic.icd9vagehistogram""",109348,Thread-1,2022-07-18T00:10:29.844580Z
E016,,debug,On model.mimic.icd9vagehistogram: BEGIN,109348,Thread-1,2022-07-18T00:10:29.844708Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:29.844816Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:29.851293Z
E015,,debug,"Using postgres connection ""model.mimic.icd9vagehistogram""",109348,Thread-1,2022-07-18T00:10:29.851744Z
E016,,debug,"On model.mimic.icd9vagehistogram: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.icd9vagehistogram""} */


  create  table ""postgres"".""public"".""icd9vagehistogram__dbt_tmp""
  as (
    -- ------------------------------------------------------------------
-- Title: Count the number of patients with a specific icd9 code and shows the output as a histogram with groups of age
-- MIMIC version: MIMIC-III v1.3
-- Notes: this query does not specify a schema. To run it on your local
-- MIMIC schema, run the following command:
-- SET SEARCH_PATH TO mimiciii
-- Where ""mimiciii"" is the name of your schema, and may be different.
-- Acknowledgements: Made with help from Kris Kindle
-- Reference: tompollard, alistairewj for code taken
-- from age_hist.sql on the MIMIC III github repository
-- ------------------------------------------------------------------

WITH diatbl AS
	(
	SELECT DISTINCT ON (dia.subject_id) dia.subject_id, ad.admittime
	from diagnoses_icd dia
	INNER JOIN admissions ad
	ON dia.subject_id = ad.subject_id
	WHERE dia.icd9_code
	-- 401% relates to hypertension
	LIKE '401%'
	),
agetbl AS
	(
	SELECT dt.subject_id, DATETIME_DIFF(dt.admittime, p.dob, 'YEAR') AS age
	FROM diatbl dt
	INNER JOIN patients p
	ON dt.subject_id = p.subject_id
	)
SELECT
        COUNT(*) AS TOTAL,
        COUNT(CASE WHEN age >= 0 AND age < 16 THEN  '0 - 15' END) AS ""0-15"",
        COUNT(CASE WHEN age >= 16 AND age < 21 THEN '16 - 20' END) AS ""16-20"",
        COUNT(CASE WHEN age >= 21 AND age < 26 THEN '21 - 25' END) AS ""21-25"",
        COUNT(CASE WHEN age >= 26 AND age < 31 THEN '26 - 30' END) AS ""26-30"",
        COUNT(CASE WHEN age >= 31 AND age < 36 THEN '31 - 35' END) AS ""31-35"",
        COUNT(CASE WHEN age >= 36 AND age < 41 THEN '36 - 40' END) AS ""36-40"",
        COUNT(CASE WHEN age >= 41 AND age < 46 THEN '41 - 45' END) AS ""41-45"",
        COUNT(CASE WHEN age >= 46 AND age < 51 THEN '46 - 50' END) AS ""46-50"",
        COUNT(CASE WHEN age >= 51 AND age < 56 THEN '51 - 55' END) AS ""51-55"",
        COUNT(CASE WHEN age >= 56 AND age < 61 THEN '56 - 60' END) AS ""56-60"",
        COUNT(CASE WHEN age >= 61 AND age < 66 THEN '61 - 65' END) AS ""61-65"",
        COUNT(CASE WHEN age >= 66 AND age < 71 THEN '66 - 70' END) AS ""66-70"",
        COUNT(CASE WHEN age >= 71 AND age < 76 THEN '71 - 75' END) AS ""71-75"",
        COUNT(CASE WHEN age >= 76 AND age < 81 THEN '76 - 80' END) AS ""76-80"",
        COUNT(CASE WHEN age >= 81 AND age < 86 THEN '81 - 85' END) AS ""81-85"",
        COUNT(CASE WHEN age >= 86 AND age < 91 THEN '86 - 90' END) AS ""86-91"",
        COUNT(CASE WHEN age >= 91 THEN 'Over 91' END) AS "">91""
FROM agetbl
  );",109348,Thread-1,2022-07-18T00:10:29.851902Z
E017,,debug,SQL status: SELECT 1 in 0.15 seconds,109348,Thread-1,2022-07-18T00:10:30.006644Z
E015,,debug,"Using postgres connection ""model.mimic.icd9vagehistogram""",109348,Thread-1,2022-07-18T00:10:30.011195Z
E016,,debug,"On model.mimic.icd9vagehistogram: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.icd9vagehistogram""} */
alter table ""postgres"".""public"".""icd9vagehistogram"" rename to ""icd9vagehistogram__dbt_backup""",109348,Thread-1,2022-07-18T00:10:30.011428Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:30.012205Z
E015,,debug,"Using postgres connection ""model.mimic.icd9vagehistogram""",109348,Thread-1,2022-07-18T00:10:30.017374Z
E016,,debug,"On model.mimic.icd9vagehistogram: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.icd9vagehistogram""} */
alter table ""postgres"".""public"".""icd9vagehistogram__dbt_tmp"" rename to ""icd9vagehistogram""",109348,Thread-1,2022-07-18T00:10:30.018253Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:30.019118Z
E018,,debug,On model.mimic.icd9vagehistogram: COMMIT,109348,Thread-1,2022-07-18T00:10:30.022399Z
E015,,debug,"Using postgres connection ""model.mimic.icd9vagehistogram""",109348,Thread-1,2022-07-18T00:10:30.022643Z
E016,,debug,On model.mimic.icd9vagehistogram: COMMIT,109348,Thread-1,2022-07-18T00:10:30.022858Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:30.023976Z
E015,,debug,"Using postgres connection ""model.mimic.icd9vagehistogram""",109348,Thread-1,2022-07-18T00:10:30.026199Z
E016,,debug,"On model.mimic.icd9vagehistogram: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.icd9vagehistogram""} */
drop table if exists ""postgres"".""public"".""icd9vagehistogram__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:30.026464Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:30.028623Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:30.032358Z
E010,,debug,On model.mimic.icd9vagehistogram: Close,109348,Thread-1,2022-07-18T00:10:30.032965Z
Q012,0,info,34 of 107 OK created table model public.icd9vagehistogram ...................... [[32mSELECT 1[0m in 0.20s],109348,Thread-1,2022-07-18T00:10:30.034796Z,table,null,icd9vagehistogram,cookbook/icd9vagehistogram.sql,2022-07-18T00:10:29.829941,compiling,model,,,
Q024,0.20295071601867676,debug,Finished running node model.mimic.icd9vagehistogram,109348,Thread-1,2022-07-18T00:10:30.035871Z,table,2022-07-18T00:10:30.035478,icd9vagehistogram,cookbook/icd9vagehistogram.sql,2022-07-18T00:10:29.829941,success,model,,,
Q023,,debug,Began running node model.mimic.icd9vicd9agelimited,109348,Thread-1,2022-07-18T00:10:30.036604Z,table,null,icd9vicd9agelimited,cookbook/icd9vicd9agelimited.sql,2022-07-18T00:10:30.036408,started,model,,,
Q033,,info,35 of 107 START table model public.icd9vicd9agelimited ......................... [RUN],109348,Thread-1,2022-07-18T00:10:30.037237Z,table,null,icd9vicd9agelimited,cookbook/icd9vicd9agelimited.sql,2022-07-18T00:10:30.036408,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.icd9vicd9agelimited""",109348,Thread-1,2022-07-18T00:10:30.038523Z
Q030,,debug,Began compiling node model.mimic.icd9vicd9agelimited,109348,Thread-1,2022-07-18T00:10:30.038886Z,table,null,icd9vicd9agelimited,cookbook/icd9vicd9agelimited.sql,2022-07-18T00:10:30.036408,compiling,model,,,
Q027,,debug,Compiling model.mimic.icd9vicd9agelimited,109348,Thread-1,2022-07-18T00:10:30.039224Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.icd9vicd9agelimited""",109348,Thread-1,2022-07-18T00:10:30.040682Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:30.041378Z
Q031,,debug,Began executing node model.mimic.icd9vicd9agelimited,109348,Thread-1,2022-07-18T00:10:30.041794Z,table,null,icd9vicd9agelimited,cookbook/icd9vicd9agelimited.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.icd9vicd9agelimited""",109348,Thread-1,2022-07-18T00:10:30.048998Z
E015,,debug,"Using postgres connection ""model.mimic.icd9vicd9agelimited""",109348,Thread-1,2022-07-18T00:10:30.050445Z
E016,,debug,On model.mimic.icd9vicd9agelimited: BEGIN,109348,Thread-1,2022-07-18T00:10:30.051457Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:30.052036Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:30.057546Z
E015,,debug,"Using postgres connection ""model.mimic.icd9vicd9agelimited""",109348,Thread-1,2022-07-18T00:10:30.058023Z
E016,,debug,"On model.mimic.icd9vicd9agelimited: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.icd9vicd9agelimited""} */


  create  table ""postgres"".""public"".""icd9vicd9agelimited__dbt_tmp""
  as (
    -- ------------------------------------------------------------------
-- Title: Count the number of patients with two specific icd9 codes above a certain age
-- MIMIC version: MIMIC-III v1.3
-- Notes: this query does not specify a schema. To run it on your local
-- MIMIC schema, run the following command:
-- SET SEARCH_PATH TO mimiciii
-- Where ""mimiciii"" is the name of your schema, and may be different.
-- Reference: tompollard, alistairewj, erinhong for code taken
-- from sodium.sql on the MIMIC III github repository
-- ------------------------------------------------------------------

WITH agetbl AS 
	(
	SELECT ad.subject_id 
	FROM admissions ad 
	INNER JOIN patients p 
	ON ad.subject_id = p.subject_id 
	WHERE 
	DATETIME_DIFF(ad.admittime, p.dob, 'YEAR') > 40 
	GROUP BY ad.subject_id
	) 
SELECT COUNT(DISTINCT dia.subject_id) 
AS ""Obesity vs Hypertension Age 40+"" 
from diagnoses_icd dia 
INNER JOIN agetbl 
ON dia.subject_id = agetbl.subject_id 
INNER JOIN diagnoses_icd dib 
ON dia.subject_id = dib.subject_id 
WHERE dia.icd9_code 
-- 278% relates to obesity
LIKE '278%' 
AND dib.icd9_code 
-- 401% relates to hypertension
LIKE '401%'
  );",109348,Thread-1,2022-07-18T00:10:30.058305Z
E017,,debug,SQL status: SELECT 1 in 0.33 seconds,109348,Thread-1,2022-07-18T00:10:30.387323Z
E015,,debug,"Using postgres connection ""model.mimic.icd9vicd9agelimited""",109348,Thread-1,2022-07-18T00:10:30.394896Z
E016,,debug,"On model.mimic.icd9vicd9agelimited: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.icd9vicd9agelimited""} */
alter table ""postgres"".""public"".""icd9vicd9agelimited"" rename to ""icd9vicd9agelimited__dbt_backup""",109348,Thread-1,2022-07-18T00:10:30.395361Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:30.396654Z
E015,,debug,"Using postgres connection ""model.mimic.icd9vicd9agelimited""",109348,Thread-1,2022-07-18T00:10:30.401886Z
E016,,debug,"On model.mimic.icd9vicd9agelimited: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.icd9vicd9agelimited""} */
alter table ""postgres"".""public"".""icd9vicd9agelimited__dbt_tmp"" rename to ""icd9vicd9agelimited""",109348,Thread-1,2022-07-18T00:10:30.402146Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:30.402863Z
E018,,debug,On model.mimic.icd9vicd9agelimited: COMMIT,109348,Thread-1,2022-07-18T00:10:30.406013Z
E015,,debug,"Using postgres connection ""model.mimic.icd9vicd9agelimited""",109348,Thread-1,2022-07-18T00:10:30.406262Z
E016,,debug,On model.mimic.icd9vicd9agelimited: COMMIT,109348,Thread-1,2022-07-18T00:10:30.406476Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:30.407588Z
E015,,debug,"Using postgres connection ""model.mimic.icd9vicd9agelimited""",109348,Thread-1,2022-07-18T00:10:30.409657Z
E016,,debug,"On model.mimic.icd9vicd9agelimited: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.icd9vicd9agelimited""} */
drop table if exists ""postgres"".""public"".""icd9vicd9agelimited__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:30.409980Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:30.411733Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:30.415568Z
E010,,debug,On model.mimic.icd9vicd9agelimited: Close,109348,Thread-1,2022-07-18T00:10:30.415899Z
Q012,0,info,35 of 107 OK created table model public.icd9vicd9agelimited .................... [[32mSELECT 1[0m in 0.38s],109348,Thread-1,2022-07-18T00:10:30.416808Z,table,null,icd9vicd9agelimited,cookbook/icd9vicd9agelimited.sql,2022-07-18T00:10:30.036408,compiling,model,,,
Q024,0.3785829544067383,debug,Finished running node model.mimic.icd9vicd9agelimited,109348,Thread-1,2022-07-18T00:10:30.417462Z,table,2022-07-18T00:10:30.417291,icd9vicd9agelimited,cookbook/icd9vicd9agelimited.sql,2022-07-18T00:10:30.036408,success,model,,,
Q023,,debug,Began running node model.mimic.icd9vicd9count,109348,Thread-1,2022-07-18T00:10:30.418044Z,table,null,icd9vicd9count,cookbook/icd9vicd9count.sql,2022-07-18T00:10:30.417915,started,model,,,
Q033,,info,36 of 107 START table model public.icd9vicd9count .............................. [RUN],109348,Thread-1,2022-07-18T00:10:30.418816Z,table,null,icd9vicd9count,cookbook/icd9vicd9count.sql,2022-07-18T00:10:30.417915,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.icd9vicd9count""",109348,Thread-1,2022-07-18T00:10:30.419627Z
Q030,,debug,Began compiling node model.mimic.icd9vicd9count,109348,Thread-1,2022-07-18T00:10:30.420139Z,table,null,icd9vicd9count,cookbook/icd9vicd9count.sql,2022-07-18T00:10:30.417915,compiling,model,,,
Q027,,debug,Compiling model.mimic.icd9vicd9count,109348,Thread-1,2022-07-18T00:10:30.420600Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.icd9vicd9count""",109348,Thread-1,2022-07-18T00:10:30.421981Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:30.422678Z
Q031,,debug,Began executing node model.mimic.icd9vicd9count,109348,Thread-1,2022-07-18T00:10:30.422992Z,table,null,icd9vicd9count,cookbook/icd9vicd9count.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.icd9vicd9count""",109348,Thread-1,2022-07-18T00:10:30.434610Z
E015,,debug,"Using postgres connection ""model.mimic.icd9vicd9count""",109348,Thread-1,2022-07-18T00:10:30.435550Z
E016,,debug,On model.mimic.icd9vicd9count: BEGIN,109348,Thread-1,2022-07-18T00:10:30.435996Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:30.436266Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:30.442962Z
E015,,debug,"Using postgres connection ""model.mimic.icd9vicd9count""",109348,Thread-1,2022-07-18T00:10:30.443347Z
E016,,debug,"On model.mimic.icd9vicd9count: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.icd9vicd9count""} */


  create  table ""postgres"".""public"".""icd9vicd9count__dbt_tmp""
  as (
    -- ------------------------------------------------------------------
-- Title: Count the number of patients with two specific icd9 codes
-- MIMIC version: MIMIC-III v1.3
-- Notes: this query does not specify a schema. To run it on your local
-- MIMIC schema, run the following command:
-- SET SEARCH_PATH TO mimiciii
-- Where ""mimiciii"" is the name of your schema, and may be different.
-- Acknowledgement: Credit goes to Kris Kindle
-- ------------------------------------------------------------------

SELECT COUNT(DISTINCT a.subject_id) 
AS ""Obesity and Dyslipidemia"" 
from diagnoses_icd a 
INNER JOIN diagnoses_icd b 
ON a.subject_id = b.subject_id 
WHERE a.icd9_code
-- 278% relates to obesity 
LIKE '278%' 
AND b.icd9_code 
-- 272 relates to Dyslipidemia
LIKE '272%'
  );",109348,Thread-1,2022-07-18T00:10:30.443650Z
E017,,debug,SQL status: SELECT 1 in 0.03 seconds,109348,Thread-1,2022-07-18T00:10:30.476846Z
E015,,debug,"Using postgres connection ""model.mimic.icd9vicd9count""",109348,Thread-1,2022-07-18T00:10:30.480832Z
E016,,debug,"On model.mimic.icd9vicd9count: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.icd9vicd9count""} */
alter table ""postgres"".""public"".""icd9vicd9count"" rename to ""icd9vicd9count__dbt_backup""",109348,Thread-1,2022-07-18T00:10:30.481047Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:30.481867Z
E015,,debug,"Using postgres connection ""model.mimic.icd9vicd9count""",109348,Thread-1,2022-07-18T00:10:30.489440Z
E016,,debug,"On model.mimic.icd9vicd9count: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.icd9vicd9count""} */
alter table ""postgres"".""public"".""icd9vicd9count__dbt_tmp"" rename to ""icd9vicd9count""",109348,Thread-1,2022-07-18T00:10:30.489833Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:30.490623Z
E018,,debug,On model.mimic.icd9vicd9count: COMMIT,109348,Thread-1,2022-07-18T00:10:30.494154Z
E015,,debug,"Using postgres connection ""model.mimic.icd9vicd9count""",109348,Thread-1,2022-07-18T00:10:30.494487Z
E016,,debug,On model.mimic.icd9vicd9count: COMMIT,109348,Thread-1,2022-07-18T00:10:30.494749Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:30.495897Z
E015,,debug,"Using postgres connection ""model.mimic.icd9vicd9count""",109348,Thread-1,2022-07-18T00:10:30.498061Z
E016,,debug,"On model.mimic.icd9vicd9count: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.icd9vicd9count""} */
drop table if exists ""postgres"".""public"".""icd9vicd9count__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:30.498461Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:30.502479Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:30.505483Z
E010,,debug,On model.mimic.icd9vicd9count: Close,109348,Thread-1,2022-07-18T00:10:30.505859Z
Q012,0,info,36 of 107 OK created table model public.icd9vicd9count ......................... [[32mSELECT 1[0m in 0.09s],109348,Thread-1,2022-07-18T00:10:30.506781Z,table,null,icd9vicd9count,cookbook/icd9vicd9count.sql,2022-07-18T00:10:30.417915,compiling,model,,,
Q024,0.08727622032165527,debug,Finished running node model.mimic.icd9vicd9count,109348,Thread-1,2022-07-18T00:10:30.507492Z,table,2022-07-18T00:10:30.507276,icd9vicd9count,cookbook/icd9vicd9count.sql,2022-07-18T00:10:30.417915,success,model,,,
Q023,,debug,Began running node model.mimic.icustay_days,109348,Thread-1,2022-07-18T00:10:30.508107Z,table,null,icustay_days,cookbook/icustay_days.sql,2022-07-18T00:10:30.508009,started,model,,,
Q033,,info,37 of 107 START table model public.icustay_days ................................ [RUN],109348,Thread-1,2022-07-18T00:10:30.508840Z,table,null,icustay_days,cookbook/icustay_days.sql,2022-07-18T00:10:30.508009,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.icustay_days""",109348,Thread-1,2022-07-18T00:10:30.509711Z
Q030,,debug,Began compiling node model.mimic.icustay_days,109348,Thread-1,2022-07-18T00:10:30.510000Z,table,null,icustay_days,cookbook/icustay_days.sql,2022-07-18T00:10:30.508009,compiling,model,,,
Q027,,debug,Compiling model.mimic.icustay_days,109348,Thread-1,2022-07-18T00:10:30.510312Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.icustay_days""",109348,Thread-1,2022-07-18T00:10:30.511496Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:30.512001Z
Q031,,debug,Began executing node model.mimic.icustay_days,109348,Thread-1,2022-07-18T00:10:30.512301Z,table,null,icustay_days,cookbook/icustay_days.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.icustay_days""",109348,Thread-1,2022-07-18T00:10:30.520172Z
E015,,debug,"Using postgres connection ""model.mimic.icustay_days""",109348,Thread-1,2022-07-18T00:10:30.521092Z
E016,,debug,On model.mimic.icustay_days: BEGIN,109348,Thread-1,2022-07-18T00:10:30.521571Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:30.522583Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:30.529117Z
E015,,debug,"Using postgres connection ""model.mimic.icustay_days""",109348,Thread-1,2022-07-18T00:10:30.529467Z
E016,,debug,"On model.mimic.icustay_days: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.icustay_days""} */


  create  table ""postgres"".""public"".""icustay_days__dbt_tmp""
  as (
    -- ----------------------------------------------------------
-- Create a table that counts each day spent in the ICU    --
-- and assign a timestamp to the start and end of each day --
-- ----------------------------------------------------------

-- ----------
-- Columns:
-- ----------
-- icustay_id
-- intime
-- outime
-- icudayseq_asc:  Counting days since arrival in the ICU
-- 				         0 = day of arrival in the ICU
--                 1 = day 1 after arrival
--                 2 = day 2 after arrival etc
-- icudayseq_desc: Counting down to the day of discharge from the ICU
--                 2 = day 2 before discharge etc
--                 1 = day 1 before discharge
-- 				         0 = day of discharge from the ICU
-- startday: if day of arrival then intime, else midnight at start of day
-- endday: if day of discharge then outtime, else midnight at end of day
-- ----------

DROP MATERIALIZED VIEW icustay_days;
CREATE VIEW icustay_days AS
WITH dayseq AS (
	SELECT icustay_id, intime, outtime,
       GENERATE_SERIES(0,CEIL(los)::INT-1,1) AS icudayseq_asc,
       GENERATE_SERIES(CEIL(los)::INT-1,0,-1) AS icudayseq_desc
	FROM icustays)
SELECT icustay_id, intime, outtime,
    icudayseq_asc, icudayseq_desc,
    CASE WHEN icudayseq_asc = 0 THEN intime
        ELSE DATETIME_ADD(date_trunc('day', intime), INTERVAL icudayseq_asc DAY)
        END AS startday,
    CASE WHEN icudayseq_desc = 0 THEN OUTTIME
        ELSE DATETIME_ADD(date_trunc('day', intime), INTERVAL icudayseq_asc+1 DAY)
				END AS endday
FROM dayseq
  );",109348,Thread-1,2022-07-18T00:10:30.529637Z
E001,,debug,"Postgres adapter: Postgres error: syntax error at or near ""DROP""
LINE 29: DROP MATERIALIZED VIEW icustay_days;
         ^
",109348,Thread-1,2022-07-18T00:10:30.530002Z
E012,,debug,On model.mimic.icustay_days: ROLLBACK,109348,Thread-1,2022-07-18T00:10:30.530181Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:30.530545Z
E010,,debug,On model.mimic.icustay_days: Close,109348,Thread-1,2022-07-18T00:10:30.530726Z
W002,,debug,"Database Error in model icustay_days (models/cookbook/icustay_days.sql)
  syntax error at or near ""DROP""
  LINE 29: DROP MATERIALIZED VIEW icustay_days;
           ^
  compiled SQL at target/run/mimic/models/cookbook/icustay_days.sql",109348,Thread-1,2022-07-18T00:10:30.531317Z
Q035,0,error,37 of 107 ERROR creating table model public.icustay_days ....................... [[31mERROR[0m in 0.02s],109348,Thread-1,2022-07-18T00:10:30.531708Z,table,null,icustay_days,cookbook/icustay_days.sql,2022-07-18T00:10:30.508009,compiling,model,,,
Q024,0.022283315658569336,debug,Finished running node model.mimic.icustay_days,109348,Thread-1,2022-07-18T00:10:30.532333Z,table,2022-07-18T00:10:30.532131,icustay_days,cookbook/icustay_days.sql,2022-07-18T00:10:30.508009,error,model,,,
Q023,,debug,Began running node model.mimic.icustay_detail,109348,Thread-1,2022-07-18T00:10:30.532710Z,table,null,icustay_detail,demographics/icustay_detail.sql,2022-07-18T00:10:30.532671,started,model,,,
Q033,,info,38 of 107 START table model public.icustay_detail .............................. [RUN],109348,Thread-1,2022-07-18T00:10:30.532962Z,table,null,icustay_detail,demographics/icustay_detail.sql,2022-07-18T00:10:30.532671,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.icustay_detail""",109348,Thread-1,2022-07-18T00:10:30.534243Z
Q030,,debug,Began compiling node model.mimic.icustay_detail,109348,Thread-1,2022-07-18T00:10:30.534421Z,table,null,icustay_detail,demographics/icustay_detail.sql,2022-07-18T00:10:30.532671,compiling,model,,,
Q027,,debug,Compiling model.mimic.icustay_detail,109348,Thread-1,2022-07-18T00:10:30.534600Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.icustay_detail""",109348,Thread-1,2022-07-18T00:10:30.536109Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:30.536512Z
Q031,,debug,Began executing node model.mimic.icustay_detail,109348,Thread-1,2022-07-18T00:10:30.536687Z,table,null,icustay_detail,demographics/icustay_detail.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.icustay_detail""",109348,Thread-1,2022-07-18T00:10:30.545185Z
E015,,debug,"Using postgres connection ""model.mimic.icustay_detail""",109348,Thread-1,2022-07-18T00:10:30.546089Z
E016,,debug,On model.mimic.icustay_detail: BEGIN,109348,Thread-1,2022-07-18T00:10:30.546401Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:30.546652Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:30.554153Z
E015,,debug,"Using postgres connection ""model.mimic.icustay_detail""",109348,Thread-1,2022-07-18T00:10:30.554523Z
E016,,debug,"On model.mimic.icustay_detail: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.icustay_detail""} */


  create  table ""postgres"".""public"".""icustay_detail__dbt_tmp""
  as (
    -- ------------------------------------------------------------------
-- Title: Detailed information on ICUSTAY_ID
-- Description: This query provides a useful set of information regarding patient
--              ICU stays. The information is combined from the admissions, patients, and
--              icustays tables. It includes age, length of stay, sequence, and expiry flags.
-- MIMIC version: MIMIC-III v1.3
-- ------------------------------------------------------------------

-- This query extracts useful demographic/administrative information for patient ICU stays

SELECT ie.subject_id, ie.hadm_id, ie.icustay_id

-- patient level factors
, pat.gender, pat.dod

-- hospital level factors
, adm.admittime, adm.dischtime
, DATETIME_DIFF(adm.dischtime, adm.admittime, 'DAY') as los_hospital
, DATETIME_DIFF(ie.intime, pat.dob, 'YEAR') as admission_age
, adm.ethnicity
, case when ethnicity in
  (
       'WHITE' --  40996
     , 'WHITE - RUSSIAN' --    164
     , 'WHITE - OTHER EUROPEAN' --     81
     , 'WHITE - BRAZILIAN' --     59
     , 'WHITE - EASTERN EUROPEAN' --     25
  ) then 'white'
  when ethnicity in
  (
      'BLACK/AFRICAN AMERICAN' --   5440
    , 'BLACK/CAPE VERDEAN' --    200
    , 'BLACK/HAITIAN' --    101
    , 'BLACK/AFRICAN' --     44
    , 'CARIBBEAN ISLAND' --      9
  ) then 'black'
  when ethnicity in
    (
      'HISPANIC OR LATINO' --   1696
    , 'HISPANIC/LATINO - PUERTO RICAN' --    232
    , 'HISPANIC/LATINO - DOMINICAN' --     78
    , 'HISPANIC/LATINO - GUATEMALAN' --     40
    , 'HISPANIC/LATINO - CUBAN' --     24
    , 'HISPANIC/LATINO - SALVADORAN' --     19
    , 'HISPANIC/LATINO - CENTRAL AMERICAN (OTHER)' --     13
    , 'HISPANIC/LATINO - MEXICAN' --     13
    , 'HISPANIC/LATINO - COLOMBIAN' --      9
    , 'HISPANIC/LATINO - HONDURAN' --      4
  ) then 'hispanic'
  when ethnicity in
  (
      'ASIAN' --   1509
    , 'ASIAN - CHINESE' --    277
    , 'ASIAN - ASIAN INDIAN' --     85
    , 'ASIAN - VIETNAMESE' --     53
    , 'ASIAN - FILIPINO' --     25
    , 'ASIAN - CAMBODIAN' --     17
    , 'ASIAN - OTHER' --     17
    , 'ASIAN - KOREAN' --     13
    , 'ASIAN - JAPANESE' --      7
    , 'ASIAN - THAI' --      4
  ) then 'asian'
  when ethnicity in
  (
       'AMERICAN INDIAN/ALASKA NATIVE' --     51
     , 'AMERICAN INDIAN/ALASKA NATIVE FEDERALLY RECOGNIZED TRIBE' --      3
  ) then 'native'
  when ethnicity in
  (
      'UNKNOWN/NOT SPECIFIED' --   4523
    , 'UNABLE TO OBTAIN' --    814
    , 'PATIENT DECLINED TO ANSWER' --    559
  ) then 'unknown'
  else 'other' end as ethnicity_grouped
  -- , 'OTHER' --   1512
  -- , 'MULTI RACE ETHNICITY' --    130
  -- , 'PORTUGUESE' --     61
  -- , 'MIDDLE EASTERN' --     43
  -- , 'NATIVE HAWAIIAN OR OTHER PACIFIC ISLANDER' --     18
  -- , 'SOUTH AMERICAN' --      8
, adm.hospital_expire_flag
, DENSE_RANK() OVER (PARTITION BY adm.subject_id ORDER BY adm.admittime) AS hospstay_seq
, CASE
    WHEN DENSE_RANK() OVER (PARTITION BY adm.subject_id ORDER BY adm.admittime) = 1 THEN True
    ELSE False END AS first_hosp_stay

-- icu level factors
, ie.intime, ie.outtime
, DATETIME_DIFF(ie.outtime, ie.intime, 'DAY') as los_icu
, DENSE_RANK() OVER (PARTITION BY ie.hadm_id ORDER BY ie.intime) AS icustay_seq

-- first ICU stay *for the current hospitalization*
, CASE
    WHEN DENSE_RANK() OVER (PARTITION BY ie.hadm_id ORDER BY ie.intime) = 1 THEN True
    ELSE False END AS first_icu_stay

FROM icustays ie
INNER JOIN admissions adm
    ON ie.hadm_id = adm.hadm_id
INNER JOIN patients pat
    ON ie.subject_id = pat.subject_id
WHERE adm.has_chartevents_data = 1
ORDER BY ie.subject_id, adm.admittime, ie.intime
  );",109348,Thread-1,2022-07-18T00:10:30.554685Z
E017,,debug,SQL status: SELECT 61051 in 0.56 seconds,109348,Thread-1,2022-07-18T00:10:31.111273Z
E015,,debug,"Using postgres connection ""model.mimic.icustay_detail""",109348,Thread-1,2022-07-18T00:10:31.116359Z
E016,,debug,"On model.mimic.icustay_detail: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.icustay_detail""} */
alter table ""postgres"".""public"".""icustay_detail"" rename to ""icustay_detail__dbt_backup""",109348,Thread-1,2022-07-18T00:10:31.116589Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:31.117894Z
E015,,debug,"Using postgres connection ""model.mimic.icustay_detail""",109348,Thread-1,2022-07-18T00:10:31.121269Z
E016,,debug,"On model.mimic.icustay_detail: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.icustay_detail""} */
alter table ""postgres"".""public"".""icustay_detail__dbt_tmp"" rename to ""icustay_detail""",109348,Thread-1,2022-07-18T00:10:31.121474Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:31.122352Z
E018,,debug,On model.mimic.icustay_detail: COMMIT,109348,Thread-1,2022-07-18T00:10:31.125842Z
E015,,debug,"Using postgres connection ""model.mimic.icustay_detail""",109348,Thread-1,2022-07-18T00:10:31.126090Z
E016,,debug,On model.mimic.icustay_detail: COMMIT,109348,Thread-1,2022-07-18T00:10:31.126300Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:31.130654Z
E015,,debug,"Using postgres connection ""model.mimic.icustay_detail""",109348,Thread-1,2022-07-18T00:10:31.132591Z
E016,,debug,"On model.mimic.icustay_detail: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.icustay_detail""} */
drop table if exists ""postgres"".""public"".""icustay_detail__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:31.132851Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:31.135611Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:31.140775Z
E010,,debug,On model.mimic.icustay_detail: Close,109348,Thread-1,2022-07-18T00:10:31.141064Z
Q012,0,info,38 of 107 OK created table model public.icustay_detail ......................... [[32mSELECT 61051[0m in 0.61s],109348,Thread-1,2022-07-18T00:10:31.141941Z,table,null,icustay_detail,demographics/icustay_detail.sql,2022-07-18T00:10:30.532671,compiling,model,,,
Q024,0.6077594757080078,debug,Finished running node model.mimic.icustay_detail,109348,Thread-1,2022-07-18T00:10:31.142776Z,table,2022-07-18T00:10:31.142577,icustay_detail,demographics/icustay_detail.sql,2022-07-18T00:10:30.532671,success,model,,,
Q023,,debug,Began running node model.mimic.icustay_times,109348,Thread-1,2022-07-18T00:10:31.143376Z,table,null,icustay_times,demographics/icustay_times.sql,2022-07-18T00:10:31.143271,started,model,,,
Q033,,info,39 of 107 START table model public.icustay_times ............................... [RUN],109348,Thread-1,2022-07-18T00:10:31.144231Z,table,null,icustay_times,demographics/icustay_times.sql,2022-07-18T00:10:31.143271,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.icustay_times""",109348,Thread-1,2022-07-18T00:10:31.145153Z
Q030,,debug,Began compiling node model.mimic.icustay_times,109348,Thread-1,2022-07-18T00:10:31.145375Z,table,null,icustay_times,demographics/icustay_times.sql,2022-07-18T00:10:31.143271,compiling,model,,,
Q027,,debug,Compiling model.mimic.icustay_times,109348,Thread-1,2022-07-18T00:10:31.145515Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.icustay_times""",109348,Thread-1,2022-07-18T00:10:31.147019Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:31.147575Z
Q031,,debug,Began executing node model.mimic.icustay_times,109348,Thread-1,2022-07-18T00:10:31.147919Z,table,null,icustay_times,demographics/icustay_times.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.icustay_times""",109348,Thread-1,2022-07-18T00:10:31.159002Z
E015,,debug,"Using postgres connection ""model.mimic.icustay_times""",109348,Thread-1,2022-07-18T00:10:31.159991Z
E016,,debug,On model.mimic.icustay_times: BEGIN,109348,Thread-1,2022-07-18T00:10:31.160439Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:31.160664Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:31.168333Z
E015,,debug,"Using postgres connection ""model.mimic.icustay_times""",109348,Thread-1,2022-07-18T00:10:31.168588Z
E016,,debug,"On model.mimic.icustay_times: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.icustay_times""} */


  create  table ""postgres"".""public"".""icustay_times__dbt_tmp""
  as (
    -- create a table which has fuzzy boundaries on hospital admission
-- involves first creating a lag/lead version of disch/admit time
with h as
(
  select
    subject_id, hadm_id, admittime, dischtime
    , lag (dischtime) over (partition by subject_id order by admittime) as dischtime_lag
    , lead (admittime) over (partition by subject_id order by admittime) as admittime_lead
  FROM admissions
)
, adm as
(
  select
    h.subject_id, h.hadm_id
    -- this rule is:
    --  if there are two hospitalizations within 24 hours, set the start/stop
    --  time as half way between the two admissions
    , case
        when h.dischtime_lag is not null
        and h.dischtime_lag > (DATETIME_SUB(h.admittime, INTERVAL '24 HOUR'))
          then DATETIME_SUB(h.admittime, (DATETIME_DIFF(h.admittime, h.dischtime_lag, 'SECOND')/2  || ' SECOND')::interval)
      else DATETIME_SUB(h.admittime, INTERVAL '12 HOUR')
      end as data_start
    , case
        when h.admittime_lead is not null
        and h.admittime_lead < (DATETIME_ADD(h.dischtime, INTERVAL '24 HOUR'))
          then DATETIME_ADD(h.dischtime, (DATETIME_DIFF(h.admittime_lead, h.dischtime, 'SECOND')/2 || ' SECOND')::interval)
      else (DATETIME_ADD(h.dischtime, INTERVAL '12 HOUR'))
      end as data_end
    from h
)
-- get first/last heart rate measurement during hospitalization for each ICUSTAY_ID
, t1 as
(
select ce.icustay_id
, min(charttime) as intime_hr
, max(charttime) as outtime_hr
FROM chartevents ce
-- very loose join to admissions to ensure charttime is near patient admission
inner join adm
  on ce.hadm_id = adm.hadm_id
  and ce.charttime >= adm.data_start
  and ce.charttime <  adm.data_end
-- only look at heart rate
where ce.itemid in (211,220045)
group by ce.icustay_id
)
-- add in subject_id/hadm_id
select
  ie.subject_id, ie.hadm_id, ie.icustay_id
  , t1.intime_hr
  , t1.outtime_hr
FROM icustays ie
left join t1
  on ie.icustay_id = t1.icustay_id
order by ie.subject_id, ie.hadm_id, ie.icustay_id
  );",109348,Thread-1,2022-07-18T00:10:31.168712Z
E017,,debug,SQL status: SELECT 61532 in 0.24 seconds,109348,Thread-1,2022-07-18T00:10:31.409544Z
E015,,debug,"Using postgres connection ""model.mimic.icustay_times""",109348,Thread-1,2022-07-18T00:10:31.417780Z
E016,,debug,"On model.mimic.icustay_times: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.icustay_times""} */
alter table ""postgres"".""public"".""icustay_times"" rename to ""icustay_times__dbt_backup""",109348,Thread-1,2022-07-18T00:10:31.418193Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:31.419136Z
E015,,debug,"Using postgres connection ""model.mimic.icustay_times""",109348,Thread-1,2022-07-18T00:10:31.422990Z
E016,,debug,"On model.mimic.icustay_times: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.icustay_times""} */
alter table ""postgres"".""public"".""icustay_times__dbt_tmp"" rename to ""icustay_times""",109348,Thread-1,2022-07-18T00:10:31.423223Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:31.424042Z
E018,,debug,On model.mimic.icustay_times: COMMIT,109348,Thread-1,2022-07-18T00:10:31.427274Z
E015,,debug,"Using postgres connection ""model.mimic.icustay_times""",109348,Thread-1,2022-07-18T00:10:31.427499Z
E016,,debug,On model.mimic.icustay_times: COMMIT,109348,Thread-1,2022-07-18T00:10:31.427735Z
E017,,debug,SQL status: COMMIT in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:31.433134Z
E015,,debug,"Using postgres connection ""model.mimic.icustay_times""",109348,Thread-1,2022-07-18T00:10:31.435749Z
E016,,debug,"On model.mimic.icustay_times: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.icustay_times""} */
drop table if exists ""postgres"".""public"".""icustay_times__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:31.435979Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:31.438364Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:31.441531Z
E010,,debug,On model.mimic.icustay_times: Close,109348,Thread-1,2022-07-18T00:10:31.441893Z
Q012,0,info,39 of 107 OK created table model public.icustay_times .......................... [[32mSELECT 61532[0m in 0.30s],109348,Thread-1,2022-07-18T00:10:31.443030Z,table,null,icustay_times,demographics/icustay_times.sql,2022-07-18T00:10:31.143271,compiling,model,,,
Q024,0.29794883728027344,debug,Finished running node model.mimic.icustay_times,109348,Thread-1,2022-07-18T00:10:31.443708Z,table,2022-07-18T00:10:31.443561,icustay_times,demographics/icustay_times.sql,2022-07-18T00:10:31.143271,success,model,,,
Q023,,debug,Began running node model.mimic.isuprel_durations,109348,Thread-1,2022-07-18T00:10:31.444181Z,table,null,isuprel_durations,durations/isuprel_durations.sql,2022-07-18T00:10:31.444078,started,model,,,
Q033,,info,40 of 107 START table model public.isuprel_durations ........................... [RUN],109348,Thread-1,2022-07-18T00:10:31.444938Z,table,null,isuprel_durations,durations/isuprel_durations.sql,2022-07-18T00:10:31.444078,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.isuprel_durations""",109348,Thread-1,2022-07-18T00:10:31.445982Z
Q030,,debug,Began compiling node model.mimic.isuprel_durations,109348,Thread-1,2022-07-18T00:10:31.446375Z,table,null,isuprel_durations,durations/isuprel_durations.sql,2022-07-18T00:10:31.444078,compiling,model,,,
Q027,,debug,Compiling model.mimic.isuprel_durations,109348,Thread-1,2022-07-18T00:10:31.446708Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.isuprel_durations""",109348,Thread-1,2022-07-18T00:10:31.448152Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:31.448727Z
Q031,,debug,Began executing node model.mimic.isuprel_durations,109348,Thread-1,2022-07-18T00:10:31.449049Z,table,null,isuprel_durations,durations/isuprel_durations.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.isuprel_durations""",109348,Thread-1,2022-07-18T00:10:31.464505Z
E015,,debug,"Using postgres connection ""model.mimic.isuprel_durations""",109348,Thread-1,2022-07-18T00:10:31.465528Z
E016,,debug,On model.mimic.isuprel_durations: BEGIN,109348,Thread-1,2022-07-18T00:10:31.466339Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:31.466609Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:31.472176Z
E015,,debug,"Using postgres connection ""model.mimic.isuprel_durations""",109348,Thread-1,2022-07-18T00:10:31.472739Z
E016,,debug,"On model.mimic.isuprel_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.isuprel_durations""} */


  create  table ""postgres"".""public"".""isuprel_durations__dbt_tmp""
  as (
    -- This query extracts durations of isuprel administration
-- Consecutive administrations are numbered 1, 2, ...
-- Total time on the drug can be calculated from this table by grouping using ICUSTAY_ID

-- Get drug administration data from CareVue first
with vasocv1 as
(
  select
    icustay_id, charttime
    -- case statement determining whether the ITEMID is an instance of vasopressor usage
    , max(case when itemid = 30046 then 1 else 0 end) as vaso -- Isuprel

    -- the 'stopped' column indicates if a vasopressor has been disconnected
    , max(case when itemid = 30046 and (stopped = 'Stopped' OR stopped like 'D/C%') then 1
          else 0 end) as vaso_stopped

    , max(case when itemid = 30046 and rate is not null then 1 else 0 end) as vaso_null
    , max(case when itemid = 30046 then rate else null end) as vaso_rate
    , max(case when itemid = 30046 then amount else null end) as vaso_amount

  FROM inputevents_cv
  where itemid = 30046 -- Isuprel
  group by icustay_id, charttime
)
, vasocv2 as
(
  select v.*
    , sum(vaso_null) over (partition by icustay_id order by charttime) as vaso_partition
  from
    vasocv1 v
)
, vasocv3 as
(
  select v.*
    , first_value(vaso_rate) over (partition by icustay_id, vaso_partition order by charttime) as vaso_prevrate_ifnull
  from
    vasocv2 v
)
, vasocv4 as
(
select
    icustay_id
    , charttime
    -- , (CHARTTIME - (LAG(CHARTTIME, 1) OVER (partition by icustay_id, vaso order by charttime))) AS delta

    , vaso
    , vaso_rate
    , vaso_amount
    , vaso_stopped
    , vaso_prevrate_ifnull

    -- We define start time here
    , case
        when vaso = 0 then null

        -- if this is the first instance of the vasoactive drug
        when vaso_rate > 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso, vaso_null
          order by charttime
          )
          is null
          then 1

        -- you often get a string of 0s
        -- we decide not to set these as 1, just because it makes vasonum sequential
        when vaso_rate = 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 0
          then 0

        -- sometimes you get a string of NULL, associated with 0 volumes
        -- same reason as before, we decide not to set these as 1
        -- vaso_prevrate_ifnull is equal to the previous value *iff* the current value is null
        when vaso_prevrate_ifnull = 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 0
          then 0

        -- If the last recorded rate was 0, newvaso = 1
        when LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          ) = 0
          then 1

        -- If the last recorded vaso was D/C'd, newvaso = 1
        when
          LAG(vaso_stopped,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 1 then 1

        -- ** not sure if the below is needed
        --when (CHARTTIME - (LAG(CHARTTIME, 1) OVER (partition by icustay_id, vaso order by charttime))) > (interval '4 hours') then 1
      else null
      end as vaso_start

FROM
  vasocv3
)
-- propagate start/stop flags forward in time
, vasocv5 as
(
  select v.*
    , SUM(vaso_start) OVER (partition by icustay_id, vaso order by charttime) as vaso_first
FROM
  vasocv4 v
)
, vasocv6 as
(
  select v.*
    -- We define end time here
    , case
        when vaso = 0
          then null

        -- If the recorded vaso was D/C'd, this is an end time
        when vaso_stopped = 1
          then vaso_first

        -- If the rate is zero, this is the end time
        when vaso_rate = 0
          then vaso_first

        -- the last row in the table is always a potential end time
        -- this captures patients who die/are discharged while on vasopressors
        -- in principle, this could add an extra end time for the vasopressor
        -- however, since we later group on vaso_start, any extra end times are ignored
        when LEAD(CHARTTIME,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          ) is null
          then vaso_first

        else null
        end as vaso_stop
    from vasocv5 v
)

-- -- if you want to look at the results of the table before grouping:
-- select
--   icustay_id, charttime, vaso, vaso_rate, vaso_amount
--     , case when vaso_stopped = 1 then 'Y' else '' end as stopped
--     , vaso_start
--     , vaso_first
--     , vaso_stop
-- from vasocv6 order by charttime


, vasocv as
(
-- below groups together vasopressor administrations into groups
select
  icustay_id
  -- the first non-null rate is considered the starttime
  , min(case when vaso_rate is not null then charttime else null end) as starttime
  -- the *first* time the first/last flags agree is the stop time for this duration
  , min(case when vaso_first = vaso_stop then charttime else null end) as endtime
from vasocv6
where
  vaso_first is not null -- bogus data
and
  vaso_first != 0 -- sometimes *only* a rate of 0 appears, i.e. the drug is never actually delivered
and
  icustay_id is not null -- there are data for ""floating"" admissions, we don't worry about these
group by icustay_id, vaso_first
having -- ensure start time is not the same as end time
 min(charttime) != min(case when vaso_first = vaso_stop then charttime else null end)
and
  max(vaso_rate) > 0 -- if the rate was always 0 or null, we consider it not a real drug delivery
)

-- now we extract the associated data for metavision patients
, vasomv as
(
  select
    icustay_id, linkorderid
    , min(starttime) as starttime, max(endtime) as endtime
  FROM inputevents_mv
  where itemid = 227692 -- Isuprel
  and statusdescription != 'Rewritten' -- only valid orders
  group by icustay_id, linkorderid
)

select
  icustay_id
  -- generate a sequential integer for convenience
  , ROW_NUMBER() over (partition by icustay_id order by starttime) as vasonum
  , starttime, endtime
  , DATETIME_DIFF(endtime, starttime, 'HOUR') AS duration_hours
  -- add durations
from
  vasocv

UNION ALL

select
  icustay_id
  , ROW_NUMBER() over (partition by icustay_id order by starttime) as vasonum
  , starttime, endtime
  , DATETIME_DIFF(endtime, starttime, 'HOUR') AS duration_hours
  -- add durations
from
  vasomv

order by icustay_id, vasonum
  );",109348,Thread-1,2022-07-18T00:10:31.472934Z
E017,,debug,SQL status: SELECT 26 in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:31.484881Z
E015,,debug,"Using postgres connection ""model.mimic.isuprel_durations""",109348,Thread-1,2022-07-18T00:10:31.490761Z
E016,,debug,"On model.mimic.isuprel_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.isuprel_durations""} */
alter table ""postgres"".""public"".""isuprel_durations"" rename to ""isuprel_durations__dbt_backup""",109348,Thread-1,2022-07-18T00:10:31.491011Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:31.492150Z
E015,,debug,"Using postgres connection ""model.mimic.isuprel_durations""",109348,Thread-1,2022-07-18T00:10:31.497536Z
E016,,debug,"On model.mimic.isuprel_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.isuprel_durations""} */
alter table ""postgres"".""public"".""isuprel_durations__dbt_tmp"" rename to ""isuprel_durations""",109348,Thread-1,2022-07-18T00:10:31.499428Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:31.500823Z
E018,,debug,On model.mimic.isuprel_durations: COMMIT,109348,Thread-1,2022-07-18T00:10:31.504872Z
E015,,debug,"Using postgres connection ""model.mimic.isuprel_durations""",109348,Thread-1,2022-07-18T00:10:31.505124Z
E016,,debug,On model.mimic.isuprel_durations: COMMIT,109348,Thread-1,2022-07-18T00:10:31.505383Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:31.506657Z
E015,,debug,"Using postgres connection ""model.mimic.isuprel_durations""",109348,Thread-1,2022-07-18T00:10:31.508726Z
E016,,debug,"On model.mimic.isuprel_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.isuprel_durations""} */
drop table if exists ""postgres"".""public"".""isuprel_durations__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:31.508953Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:31.511226Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:31.514157Z
E010,,debug,On model.mimic.isuprel_durations: Close,109348,Thread-1,2022-07-18T00:10:31.514978Z
Q012,0,info,40 of 107 OK created table model public.isuprel_durations ...................... [[32mSELECT 26[0m in 0.07s],109348,Thread-1,2022-07-18T00:10:31.517535Z,table,null,isuprel_durations,durations/isuprel_durations.sql,2022-07-18T00:10:31.444078,compiling,model,,,
Q024,0.07156109809875488,debug,Finished running node model.mimic.isuprel_durations,109348,Thread-1,2022-07-18T00:10:31.518839Z,table,2022-07-18T00:10:31.518664,isuprel_durations,durations/isuprel_durations.sql,2022-07-18T00:10:31.444078,success,model,,,
Q023,,debug,Began running node model.mimic.kdigo_creatinine,109348,Thread-1,2022-07-18T00:10:31.519358Z,table,null,kdigo_creatinine,organfailure/kdigo_creatinine.sql,2022-07-18T00:10:31.519270,started,model,,,
Q033,,info,41 of 107 START table model public.kdigo_creatinine ............................ [RUN],109348,Thread-1,2022-07-18T00:10:31.520069Z,table,null,kdigo_creatinine,organfailure/kdigo_creatinine.sql,2022-07-18T00:10:31.519270,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.kdigo_creatinine""",109348,Thread-1,2022-07-18T00:10:31.520778Z
Q030,,debug,Began compiling node model.mimic.kdigo_creatinine,109348,Thread-1,2022-07-18T00:10:31.521053Z,table,null,kdigo_creatinine,organfailure/kdigo_creatinine.sql,2022-07-18T00:10:31.519270,compiling,model,,,
Q027,,debug,Compiling model.mimic.kdigo_creatinine,109348,Thread-1,2022-07-18T00:10:31.521434Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.kdigo_creatinine""",109348,Thread-1,2022-07-18T00:10:31.522658Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:31.523304Z
Q031,,debug,Began executing node model.mimic.kdigo_creatinine,109348,Thread-1,2022-07-18T00:10:31.523733Z,table,null,kdigo_creatinine,organfailure/kdigo_creatinine.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.kdigo_creatinine""",109348,Thread-1,2022-07-18T00:10:31.532155Z
E015,,debug,"Using postgres connection ""model.mimic.kdigo_creatinine""",109348,Thread-1,2022-07-18T00:10:31.532797Z
E016,,debug,On model.mimic.kdigo_creatinine: BEGIN,109348,Thread-1,2022-07-18T00:10:31.533039Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:31.533231Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:31.539413Z
E015,,debug,"Using postgres connection ""model.mimic.kdigo_creatinine""",109348,Thread-1,2022-07-18T00:10:31.539867Z
E016,,debug,"On model.mimic.kdigo_creatinine: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.kdigo_creatinine""} */


  create  table ""postgres"".""public"".""kdigo_creatinine__dbt_tmp""
  as (
    -- Extract all creatinine values FROM labevents around patient's ICU stay
with cr as
(
select
    ie.icustay_id
  , ie.intime, ie.outtime
  , le.valuenum as creat
  , le.charttime
  FROM icustays ie
  left join labevents le
    on ie.subject_id = le.subject_id
    and le.ITEMID = 50912
    and le.VALUENUM is not null
    and DATETIME_DIFF(le.charttime, ie.intime, 'HOUR') <= (7*24-6)
    and le.CHARTTIME >= DATETIME_SUB(ie.intime, INTERVAL '6 HOUR')
    and le.CHARTTIME <= DATETIME_ADD(ie.intime, INTERVAL '7 DAY')
)
-- add in the lowest value in the previous 48 hours/7 days
SELECT
  cr.icustay_id
  , cr.charttime
  , cr.creat
  , MIN(cr48.creat) AS creat_low_past_48hr
  , MIN(cr7.creat) AS creat_low_past_7day
FROM cr
-- add in all creatinine values in the last 48 hours
LEFT JOIN cr cr48
  ON cr.icustay_id = cr48.icustay_id
  AND cr48.charttime <  cr.charttime
  AND DATETIME_DIFF(cr.charttime, cr48.charttime, 'HOUR') <= 48
-- add in all creatinine values in the last 7 days
LEFT JOIN cr cr7
  ON cr.icustay_id = cr7.icustay_id
  AND cr7.charttime <  cr.charttime
  AND DATETIME_DIFF(cr.charttime, cr7.charttime, 'DAY') <= 7
GROUP BY cr.icustay_id, cr.charttime, cr.creat
ORDER BY cr.icustay_id, cr.charttime, cr.creat
  );",109348,Thread-1,2022-07-18T00:10:31.540155Z
E017,,debug,SQL status: SELECT 61532 in 0.62 seconds,109348,Thread-1,2022-07-18T00:10:32.161243Z
E015,,debug,"Using postgres connection ""model.mimic.kdigo_creatinine""",109348,Thread-1,2022-07-18T00:10:32.168080Z
E016,,debug,"On model.mimic.kdigo_creatinine: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.kdigo_creatinine""} */
alter table ""postgres"".""public"".""kdigo_creatinine"" rename to ""kdigo_creatinine__dbt_backup""",109348,Thread-1,2022-07-18T00:10:32.168609Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:32.170862Z
E015,,debug,"Using postgres connection ""model.mimic.kdigo_creatinine""",109348,Thread-1,2022-07-18T00:10:32.174957Z
E016,,debug,"On model.mimic.kdigo_creatinine: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.kdigo_creatinine""} */
alter table ""postgres"".""public"".""kdigo_creatinine__dbt_tmp"" rename to ""kdigo_creatinine""",109348,Thread-1,2022-07-18T00:10:32.175208Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:32.175920Z
E018,,debug,On model.mimic.kdigo_creatinine: COMMIT,109348,Thread-1,2022-07-18T00:10:32.179208Z
E015,,debug,"Using postgres connection ""model.mimic.kdigo_creatinine""",109348,Thread-1,2022-07-18T00:10:32.179448Z
E016,,debug,On model.mimic.kdigo_creatinine: COMMIT,109348,Thread-1,2022-07-18T00:10:32.179678Z
E017,,debug,SQL status: COMMIT in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:32.187033Z
E015,,debug,"Using postgres connection ""model.mimic.kdigo_creatinine""",109348,Thread-1,2022-07-18T00:10:32.189206Z
E016,,debug,"On model.mimic.kdigo_creatinine: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.kdigo_creatinine""} */
drop table if exists ""postgres"".""public"".""kdigo_creatinine__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:32.189428Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:32.191455Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:32.194282Z
E010,,debug,On model.mimic.kdigo_creatinine: Close,109348,Thread-1,2022-07-18T00:10:32.194554Z
Q012,0,info,41 of 107 OK created table model public.kdigo_creatinine ....................... [[32mSELECT 61532[0m in 0.67s],109348,Thread-1,2022-07-18T00:10:32.195416Z,table,null,kdigo_creatinine,organfailure/kdigo_creatinine.sql,2022-07-18T00:10:31.519270,compiling,model,,,
Q024,0.6747243404388428,debug,Finished running node model.mimic.kdigo_creatinine,109348,Thread-1,2022-07-18T00:10:32.196054Z,table,2022-07-18T00:10:32.195901,kdigo_creatinine,organfailure/kdigo_creatinine.sql,2022-07-18T00:10:31.519270,success,model,,,
Q023,,debug,Began running node model.mimic.labs_first_day,109348,Thread-1,2022-07-18T00:10:32.196342Z,table,null,labs_first_day,firstday/labs_first_day.sql,2022-07-18T00:10:32.196320,started,model,,,
Q033,,info,42 of 107 START table model public.labs_first_day .............................. [RUN],109348,Thread-1,2022-07-18T00:10:32.196605Z,table,null,labs_first_day,firstday/labs_first_day.sql,2022-07-18T00:10:32.196320,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.labs_first_day""",109348,Thread-1,2022-07-18T00:10:32.197730Z
Q030,,debug,Began compiling node model.mimic.labs_first_day,109348,Thread-1,2022-07-18T00:10:32.198439Z,table,null,labs_first_day,firstday/labs_first_day.sql,2022-07-18T00:10:32.196320,compiling,model,,,
Q027,,debug,Compiling model.mimic.labs_first_day,109348,Thread-1,2022-07-18T00:10:32.199446Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.labs_first_day""",109348,Thread-1,2022-07-18T00:10:32.202447Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:32.203260Z
Q031,,debug,Began executing node model.mimic.labs_first_day,109348,Thread-1,2022-07-18T00:10:32.203640Z,table,null,labs_first_day,firstday/labs_first_day.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.labs_first_day""",109348,Thread-1,2022-07-18T00:10:32.211081Z
E015,,debug,"Using postgres connection ""model.mimic.labs_first_day""",109348,Thread-1,2022-07-18T00:10:32.211746Z
E016,,debug,On model.mimic.labs_first_day: BEGIN,109348,Thread-1,2022-07-18T00:10:32.212071Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:32.212365Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:32.221726Z
E015,,debug,"Using postgres connection ""model.mimic.labs_first_day""",109348,Thread-1,2022-07-18T00:10:32.222010Z
E016,,debug,"On model.mimic.labs_first_day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.labs_first_day""} */


  create  table ""postgres"".""public"".""labs_first_day__dbt_tmp""
  as (
    -- This query pivots lab values taken in the first 24 hours of a patient's stay

-- Have already confirmed that the unit of measurement is always the same: null or the correct unit

SELECT
  pvt.subject_id, pvt.hadm_id, pvt.icustay_id

  , min(CASE WHEN label = 'ANION GAP' THEN valuenum ELSE NULL END) AS aniongap_min
  , max(CASE WHEN label = 'ANION GAP' THEN valuenum ELSE NULL END) AS aniongap_max
  , min(CASE WHEN label = 'ALBUMIN' THEN valuenum ELSE NULL END) AS albumin_min
  , max(CASE WHEN label = 'ALBUMIN' THEN valuenum ELSE NULL END) AS albumin_max
  , min(CASE WHEN label = 'BANDS' THEN valuenum ELSE NULL END) AS bands_min
  , max(CASE WHEN label = 'BANDS' THEN valuenum ELSE NULL END) AS bands_max
  , min(CASE WHEN label = 'BICARBONATE' THEN valuenum ELSE NULL END) AS bicarbonate_min
  , max(CASE WHEN label = 'BICARBONATE' THEN valuenum ELSE NULL END) AS bicarbonate_max
  , min(CASE WHEN label = 'BILIRUBIN' THEN valuenum ELSE NULL END) AS bilirubin_min
  , max(CASE WHEN label = 'BILIRUBIN' THEN valuenum ELSE NULL END) AS bilirubin_max
  , min(CASE WHEN label = 'CREATININE' THEN valuenum ELSE NULL END) AS creatinine_min
  , max(CASE WHEN label = 'CREATININE' THEN valuenum ELSE NULL END) AS creatinine_max
  , min(CASE WHEN label = 'CHLORIDE' THEN valuenum ELSE NULL END) AS chloride_min
  , max(CASE WHEN label = 'CHLORIDE' THEN valuenum ELSE NULL END) AS chloride_max
  , min(CASE WHEN label = 'GLUCOSE' THEN valuenum ELSE NULL END) AS glucose_min
  , max(CASE WHEN label = 'GLUCOSE' THEN valuenum ELSE NULL END) AS glucose_max
  , min(CASE WHEN label = 'HEMATOCRIT' THEN valuenum ELSE NULL END) AS hematocrit_min
  , max(CASE WHEN label = 'HEMATOCRIT' THEN valuenum ELSE NULL END) AS hematocrit_max
  , min(CASE WHEN label = 'HEMOGLOBIN' THEN valuenum ELSE NULL END) AS hemoglobin_min
  , max(CASE WHEN label = 'HEMOGLOBIN' THEN valuenum ELSE NULL END) AS hemoglobin_max
  , min(CASE WHEN label = 'LACTATE' THEN valuenum ELSE NULL END) AS lactate_min
  , max(CASE WHEN label = 'LACTATE' THEN valuenum ELSE NULL END) AS lactate_max
  , min(CASE WHEN label = 'PLATELET' THEN valuenum ELSE NULL END) AS platelet_min
  , max(CASE WHEN label = 'PLATELET' THEN valuenum ELSE NULL END) AS platelet_max
  , min(CASE WHEN label = 'POTASSIUM' THEN valuenum ELSE NULL END) AS potassium_min
  , max(CASE WHEN label = 'POTASSIUM' THEN valuenum ELSE NULL END) AS potassium_max
  , min(CASE WHEN label = 'PTT' THEN valuenum ELSE NULL END) AS ptt_min
  , max(CASE WHEN label = 'PTT' THEN valuenum ELSE NULL END) AS ptt_max
  , min(CASE WHEN label = 'INR' THEN valuenum ELSE NULL END) AS inr_min
  , max(CASE WHEN label = 'INR' THEN valuenum ELSE NULL END) AS inr_max
  , min(CASE WHEN label = 'PT' THEN valuenum ELSE NULL END) AS pt_min
  , max(CASE WHEN label = 'PT' THEN valuenum ELSE NULL END) AS pt_max
  , min(CASE WHEN label = 'SODIUM' THEN valuenum ELSE NULL END) AS sodium_min
  , max(CASE WHEN label = 'SODIUM' THEN valuenum ELSE NULL END) AS sodium_max
  , min(CASE WHEN label = 'BUN' THEN valuenum ELSE NULL END) AS bun_min
  , max(CASE WHEN label = 'BUN' THEN valuenum ELSE NULL END) AS bun_max
  , min(CASE WHEN label = 'WBC' THEN valuenum ELSE NULL END) AS wbc_min
  , max(CASE WHEN label = 'WBC' THEN valuenum ELSE NULL END) AS wbc_max


FROM
( -- begin query that extracts the data
  SELECT ie.subject_id, ie.hadm_id, ie.icustay_id
  -- here we assign labels to ITEMIDs
  -- this also fuses together multiple ITEMIDs containing the same data
  , CASE
        WHEN itemid = 50868 THEN 'ANION GAP'
        WHEN itemid = 50862 THEN 'ALBUMIN'
        WHEN itemid = 51144 THEN 'BANDS'
        WHEN itemid = 50882 THEN 'BICARBONATE'
        WHEN itemid = 50885 THEN 'BILIRUBIN'
        WHEN itemid = 50912 THEN 'CREATININE'
        WHEN itemid = 50806 THEN 'CHLORIDE'
        WHEN itemid = 50902 THEN 'CHLORIDE'
        WHEN itemid = 50809 THEN 'GLUCOSE'
        WHEN itemid = 50931 THEN 'GLUCOSE'
        WHEN itemid = 50810 THEN 'HEMATOCRIT'
        WHEN itemid = 51221 THEN 'HEMATOCRIT'
        WHEN itemid = 50811 THEN 'HEMOGLOBIN'
        WHEN itemid = 51222 THEN 'HEMOGLOBIN'
        WHEN itemid = 50813 THEN 'LACTATE'
        WHEN itemid = 51265 THEN 'PLATELET'
        WHEN itemid = 50822 THEN 'POTASSIUM'
        WHEN itemid = 50971 THEN 'POTASSIUM'
        WHEN itemid = 51275 THEN 'PTT'
        WHEN itemid = 51237 THEN 'INR'
        WHEN itemid = 51274 THEN 'PT'
        WHEN itemid = 50824 THEN 'SODIUM'
        WHEN itemid = 50983 THEN 'SODIUM'
        WHEN itemid = 51006 THEN 'BUN'
        WHEN itemid = 51300 THEN 'WBC'
        WHEN itemid = 51301 THEN 'WBC'
      ELSE null
    END as label
  , -- add in some sanity checks on the values
  -- the where clause below requires all valuenum to be > 0, so these are only upper limit checks
    CASE
      WHEN itemid = 50862 and valuenum >    10 THEN null -- g/dL 'ALBUMIN'
      WHEN itemid = 50868 and valuenum > 10000 THEN null -- mEq/L 'ANION GAP'
      WHEN itemid = 51144 and valuenum <     0 THEN null -- immature band forms, %
      WHEN itemid = 51144 and valuenum >   100 THEN null -- immature band forms, %
      WHEN itemid = 50882 and valuenum > 10000 THEN null -- mEq/L 'BICARBONATE'
      WHEN itemid = 50885 and valuenum >   150 THEN null -- mg/dL 'BILIRUBIN'
      WHEN itemid = 50806 and valuenum > 10000 THEN null -- mEq/L 'CHLORIDE'
      WHEN itemid = 50902 and valuenum > 10000 THEN null -- mEq/L 'CHLORIDE'
      WHEN itemid = 50912 and valuenum >   150 THEN null -- mg/dL 'CREATININE'
      WHEN itemid = 50809 and valuenum > 10000 THEN null -- mg/dL 'GLUCOSE'
      WHEN itemid = 50931 and valuenum > 10000 THEN null -- mg/dL 'GLUCOSE'
      WHEN itemid = 50810 and valuenum >   100 THEN null -- % 'HEMATOCRIT'
      WHEN itemid = 51221 and valuenum >   100 THEN null -- % 'HEMATOCRIT'
      WHEN itemid = 50811 and valuenum >    50 THEN null -- g/dL 'HEMOGLOBIN'
      WHEN itemid = 51222 and valuenum >    50 THEN null -- g/dL 'HEMOGLOBIN'
      WHEN itemid = 50813 and valuenum >    50 THEN null -- mmol/L 'LACTATE'
      WHEN itemid = 51265 and valuenum > 10000 THEN null -- K/uL 'PLATELET'
      WHEN itemid = 50822 and valuenum >    30 THEN null -- mEq/L 'POTASSIUM'
      WHEN itemid = 50971 and valuenum >    30 THEN null -- mEq/L 'POTASSIUM'
      WHEN itemid = 51275 and valuenum >   150 THEN null -- sec 'PTT'
      WHEN itemid = 51237 and valuenum >    50 THEN null -- 'INR'
      WHEN itemid = 51274 and valuenum >   150 THEN null -- sec 'PT'
      WHEN itemid = 50824 and valuenum >   200 THEN null -- mEq/L == mmol/L 'SODIUM'
      WHEN itemid = 50983 and valuenum >   200 THEN null -- mEq/L == mmol/L 'SODIUM'
      WHEN itemid = 51006 and valuenum >   300 THEN null -- 'BUN'
      WHEN itemid = 51300 and valuenum >  1000 THEN null -- 'WBC'
      WHEN itemid = 51301 and valuenum >  1000 THEN null -- 'WBC'
    ELSE le.valuenum
    END as valuenum

  FROM icustays ie

  LEFT JOIN labevents le
    ON le.subject_id = ie.subject_id AND le.hadm_id = ie.hadm_id
    AND le.charttime BETWEEN (DATETIME_SUB(ie.intime, INTERVAL '6' HOUR)) AND (DATETIME_ADD(ie.intime, INTERVAL '1' DAY))
    AND le.ITEMID in
    (
      -- comment is: LABEL | CATEGORY | FLUID | NUMBER OF ROWS IN LABEVENTS
      50868, -- ANION GAP | CHEMISTRY | BLOOD | 769895
      50862, -- ALBUMIN | CHEMISTRY | BLOOD | 146697
      51144, -- BANDS - hematology
      50882, -- BICARBONATE | CHEMISTRY | BLOOD | 780733
      50885, -- BILIRUBIN, TOTAL | CHEMISTRY | BLOOD | 238277
      50912, -- CREATININE | CHEMISTRY | BLOOD | 797476
      50902, -- CHLORIDE | CHEMISTRY | BLOOD | 795568
      50806, -- CHLORIDE, WHOLE BLOOD | BLOOD GAS | BLOOD | 48187
      50931, -- GLUCOSE | CHEMISTRY | BLOOD | 748981
      50809, -- GLUCOSE | BLOOD GAS | BLOOD | 196734
      51221, -- HEMATOCRIT | HEMATOLOGY | BLOOD | 881846
      50810, -- HEMATOCRIT, CALCULATED | BLOOD GAS | BLOOD | 89715
      51222, -- HEMOGLOBIN | HEMATOLOGY | BLOOD | 752523
      50811, -- HEMOGLOBIN | BLOOD GAS | BLOOD | 89712
      50813, -- LACTATE | BLOOD GAS | BLOOD | 187124
      51265, -- PLATELET COUNT | HEMATOLOGY | BLOOD | 778444
      50971, -- POTASSIUM | CHEMISTRY | BLOOD | 845825
      50822, -- POTASSIUM, WHOLE BLOOD | BLOOD GAS | BLOOD | 192946
      51275, -- PTT | HEMATOLOGY | BLOOD | 474937
      51237, -- INR(PT) | HEMATOLOGY | BLOOD | 471183
      51274, -- PT | HEMATOLOGY | BLOOD | 469090
      50983, -- SODIUM | CHEMISTRY | BLOOD | 808489
      50824, -- SODIUM, WHOLE BLOOD | BLOOD GAS | BLOOD | 71503
      51006, -- UREA NITROGEN | CHEMISTRY | BLOOD | 791925
      51301, -- WHITE BLOOD CELLS | HEMATOLOGY | BLOOD | 753301
      51300  -- WBC COUNT | HEMATOLOGY | BLOOD | 2371
    )
    AND valuenum IS NOT null AND valuenum > 0 -- lab values cannot be 0 and cannot be negative
) pvt
GROUP BY pvt.subject_id, pvt.hadm_id, pvt.icustay_id
ORDER BY pvt.subject_id, pvt.hadm_id, pvt.icustay_id
  );",109348,Thread-1,2022-07-18T00:10:32.222278Z
E017,,debug,SQL status: SELECT 61532 in 1.25 seconds,109348,Thread-1,2022-07-18T00:10:33.473397Z
E015,,debug,"Using postgres connection ""model.mimic.labs_first_day""",109348,Thread-1,2022-07-18T00:10:33.477540Z
E016,,debug,"On model.mimic.labs_first_day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.labs_first_day""} */
alter table ""postgres"".""public"".""labs_first_day"" rename to ""labs_first_day__dbt_backup""",109348,Thread-1,2022-07-18T00:10:33.477997Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:33.479223Z
E015,,debug,"Using postgres connection ""model.mimic.labs_first_day""",109348,Thread-1,2022-07-18T00:10:33.487013Z
E016,,debug,"On model.mimic.labs_first_day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.labs_first_day""} */
alter table ""postgres"".""public"".""labs_first_day__dbt_tmp"" rename to ""labs_first_day""",109348,Thread-1,2022-07-18T00:10:33.487310Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:33.488022Z
E018,,debug,On model.mimic.labs_first_day: COMMIT,109348,Thread-1,2022-07-18T00:10:33.491195Z
E015,,debug,"Using postgres connection ""model.mimic.labs_first_day""",109348,Thread-1,2022-07-18T00:10:33.491422Z
E016,,debug,On model.mimic.labs_first_day: COMMIT,109348,Thread-1,2022-07-18T00:10:33.491543Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:33.492879Z
E015,,debug,"Using postgres connection ""model.mimic.labs_first_day""",109348,Thread-1,2022-07-18T00:10:33.495593Z
E016,,debug,"On model.mimic.labs_first_day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.labs_first_day""} */
drop table if exists ""postgres"".""public"".""labs_first_day__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:33.495918Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:33.501163Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:33.505011Z
E010,,debug,On model.mimic.labs_first_day: Close,109348,Thread-1,2022-07-18T00:10:33.505381Z
Q012,1,info,42 of 107 OK created table model public.labs_first_day ......................... [[32mSELECT 61532[0m in 1.31s],109348,Thread-1,2022-07-18T00:10:33.506371Z,table,null,labs_first_day,firstday/labs_first_day.sql,2022-07-18T00:10:32.196320,compiling,model,,,
Q024,1.3089039325714111,debug,Finished running node model.mimic.labs_first_day,109348,Thread-1,2022-07-18T00:10:33.507114Z,table,2022-07-18T00:10:33.506942,labs_first_day,firstday/labs_first_day.sql,2022-07-18T00:10:32.196320,success,model,,,
Q023,,debug,Began running node model.mimic.martin,109348,Thread-1,2022-07-18T00:10:33.507654Z,table,null,martin,sepsis/martin.sql,2022-07-18T00:10:33.507545,started,model,,,
Q033,,info,43 of 107 START table model public.martin ...................................... [RUN],109348,Thread-1,2022-07-18T00:10:33.508343Z,table,null,martin,sepsis/martin.sql,2022-07-18T00:10:33.507545,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.martin""",109348,Thread-1,2022-07-18T00:10:33.509259Z
Q030,,debug,Began compiling node model.mimic.martin,109348,Thread-1,2022-07-18T00:10:33.509461Z,table,null,martin,sepsis/martin.sql,2022-07-18T00:10:33.507545,compiling,model,,,
Q027,,debug,Compiling model.mimic.martin,109348,Thread-1,2022-07-18T00:10:33.509749Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.martin""",109348,Thread-1,2022-07-18T00:10:33.512522Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:33.514190Z
Q031,,debug,Began executing node model.mimic.martin,109348,Thread-1,2022-07-18T00:10:33.515200Z,table,null,martin,sepsis/martin.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.martin""",109348,Thread-1,2022-07-18T00:10:33.532529Z
E015,,debug,"Using postgres connection ""model.mimic.martin""",109348,Thread-1,2022-07-18T00:10:33.533377Z
E016,,debug,On model.mimic.martin: BEGIN,109348,Thread-1,2022-07-18T00:10:33.533760Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:33.534038Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:33.540124Z
E015,,debug,"Using postgres connection ""model.mimic.martin""",109348,Thread-1,2022-07-18T00:10:33.540391Z
E016,,debug,"On model.mimic.martin: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.martin""} */


  create  table ""postgres"".""public"".""martin__dbt_tmp""
  as (
    -- ICD-9 codes for sepsis as validated by Martin et al.

-- Greg S. Martin, David M. Mannino, Stephanie Eaton, and Marc Moss. The epidemiology of
-- sepsis in the united states from 1979 through 2000. N Engl J Med, 348(16):1546–1554, Apr
-- 2003. doi: 10.1056/NEJMoa022139. URL http://dx.doi.org/10.1056/NEJMoa022139.
 
WITH co_dx AS
(
	SELECT subject_id, hadm_id
  , MAX(
    	CASE
        -- septicemia
    		WHEN SUBSTR(icd9_code,1,3) = '038' THEN 1
        -- septicemic, bacteremia, disseminated fungal infection, disseminated candida infection
				-- NOTE: the paper specifies 020.0 ... but this is bubonic plague
				-- presumably, they meant 020.2, which is septicemic plague
        WHEN SUBSTR(icd9_code,1,4) in ('0202','7907','1179','1125') THEN 1
        -- disseminated fungal endocarditis
        WHEN SUBSTR(icd9_code,1,5) = '11281' THEN 1
      ELSE 0 END
    ) AS sepsis
    , MAX(
      CASE
        WHEN SUBSTR(icd9_code,1,4) in ('7991') THEN 1
        WHEN SUBSTR(icd9_code,1,5) in ('51881','51882','51885','78609') THEN 1
      ELSE 0 END
    ) AS respiratory
    , MAX(
      CASE
        WHEN SUBSTR(icd9_code,1,4) in ('4580','7855','4580','4588','4589','7963') THEN 1
        WHEN SUBSTR(icd9_code,1,5) in ('785.51','785.59') THEN 1
      ELSE 0 END
    ) AS cardiovascular
    , MAX(
      CASE
        WHEN SUBSTR(icd9_code,1,3) in ('584','580','585') THEN 1
      ELSE 0 END
    ) AS renal
    , MAX(
      CASE
        WHEN SUBSTR(icd9_code,1,3) in ('570') THEN 1
        WHEN SUBSTR(icd9_code,1,4) in ('5722','5733') THEN 1
      ELSE 0 END
    ) AS hepatic
    , MAX(
      CASE
        WHEN SUBSTR(icd9_code,1,4) in ('2862','2866','2869','2873','2874','2875') THEN 1
      ELSE 0 END
    ) AS hematologic
    , MAX(
      CASE
        WHEN SUBSTR(icd9_code,1,4) in ('2762') THEN 1
      ELSE 0 END
    ) AS metabolic
    , MAX(
      CASE
        WHEN SUBSTR(icd9_code,1,3) in ('293') THEN 1
        WHEN SUBSTR(icd9_code,1,4) in ('3481','3483') THEN 1
        WHEN SUBSTR(icd9_code,1,5) in ('78001','78009') THEN 1
      ELSE 0 END
    ) AS neurologic
  from diagnoses_icd
  GROUP BY subject_id, hadm_id
)
-- procedure codes:
-- ""96.7 - Ventilator management""
-- translated:
--    9670	Continuous invasive mechanical ventilation of unspecified duration
--    9671	Continuous invasive mechanical ventilation for less than 96 consecutive hours
--    9672	Continuous invasive mechanical ventilation for 96 consecutive hours or more
-- ""39.95 - Hemodialysis""
--    3995	Hemodialysis
-- ""89.14 - Electroencephalography""
--    8914	Electroencephalogram
, co_proc as
(
  SELECT subject_id, hadm_id
  , MAX(CASE WHEN icd9_code = '967' then 1 ELSE 0 END) as respiratory
  , MAX(CASE WHEN icd9_code = '3995' then 1 ELSE 0 END) as renal
  , MAX(CASE WHEN icd9_code = '8914' then 1 ELSE 0 END) as neurologic
  FROM procedures_icd
  GROUP BY subject_id, hadm_id
)
select adm.subject_id, adm.hadm_id
, co_dx.sepsis
, CASE
    WHEN co_dx.respiratory = 1 OR co_proc.respiratory = 1
      OR co_dx.cardiovascular = 1
      OR co_dx.renal = 1 OR co_proc.renal = 1
      OR co_dx.hepatic = 1
      OR co_dx.hematologic = 1
      OR co_dx.metabolic = 1
      OR co_dx.neurologic = 1 OR co_proc.neurologic = 1
    THEN 1
  ELSE 0 END as organ_failure
, case when co_dx.respiratory = 1 or co_proc.respiratory = 1 then 1 else 0 end as respiratory
, co_dx.cardiovascular
, case when co_dx.renal = 1 or co_proc.renal = 1 then 1 else 0 end as renal
, co_dx.hepatic
, co_dx.hematologic
, co_dx.metabolic
, case when co_dx.neurologic = 1 or co_proc.neurologic = 1 then 1 else 0 end as neurologic
FROM admissions adm
left join co_dx
  on adm.hadm_id = co_dx.hadm_id
left join co_proc
  on adm.hadm_id = co_proc.hadm_id
  );",109348,Thread-1,2022-07-18T00:10:33.540597Z
E017,,debug,SQL status: SELECT 58976 in 0.91 seconds,109348,Thread-1,2022-07-18T00:10:34.447027Z
E015,,debug,"Using postgres connection ""model.mimic.martin""",109348,Thread-1,2022-07-18T00:10:34.453973Z
E016,,debug,"On model.mimic.martin: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.martin""} */
alter table ""postgres"".""public"".""martin"" rename to ""martin__dbt_backup""",109348,Thread-1,2022-07-18T00:10:34.454240Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:34.454971Z
E015,,debug,"Using postgres connection ""model.mimic.martin""",109348,Thread-1,2022-07-18T00:10:34.458761Z
E016,,debug,"On model.mimic.martin: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.martin""} */
alter table ""postgres"".""public"".""martin__dbt_tmp"" rename to ""martin""",109348,Thread-1,2022-07-18T00:10:34.459014Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:34.459700Z
E018,,debug,On model.mimic.martin: COMMIT,109348,Thread-1,2022-07-18T00:10:34.464120Z
E015,,debug,"Using postgres connection ""model.mimic.martin""",109348,Thread-1,2022-07-18T00:10:34.464685Z
E016,,debug,On model.mimic.martin: COMMIT,109348,Thread-1,2022-07-18T00:10:34.465056Z
E017,,debug,SQL status: COMMIT in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:34.470635Z
E015,,debug,"Using postgres connection ""model.mimic.martin""",109348,Thread-1,2022-07-18T00:10:34.472879Z
E016,,debug,"On model.mimic.martin: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.martin""} */
drop table if exists ""postgres"".""public"".""martin__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:34.473109Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:34.475218Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:34.478155Z
E010,,debug,On model.mimic.martin: Close,109348,Thread-1,2022-07-18T00:10:34.478659Z
Q012,0,info,43 of 107 OK created table model public.martin ................................. [[32mSELECT 58976[0m in 0.97s],109348,Thread-1,2022-07-18T00:10:34.481195Z,table,null,martin,sepsis/martin.sql,2022-07-18T00:10:33.507545,compiling,model,,,
Q024,0.9715878963470459,debug,Finished running node model.mimic.martin,109348,Thread-1,2022-07-18T00:10:34.482785Z,table,2022-07-18T00:10:34.482467,martin,sepsis/martin.sql,2022-07-18T00:10:33.507545,success,model,,,
Q023,,debug,Began running node model.mimic.milrinone_durations,109348,Thread-1,2022-07-18T00:10:34.483692Z,table,null,milrinone_durations,durations/milrinone_durations.sql,2022-07-18T00:10:34.483628,started,model,,,
Q033,,info,44 of 107 START table model public.milrinone_durations ......................... [RUN],109348,Thread-1,2022-07-18T00:10:34.484429Z,table,null,milrinone_durations,durations/milrinone_durations.sql,2022-07-18T00:10:34.483628,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.milrinone_durations""",109348,Thread-1,2022-07-18T00:10:34.485766Z
Q030,,debug,Began compiling node model.mimic.milrinone_durations,109348,Thread-1,2022-07-18T00:10:34.486079Z,table,null,milrinone_durations,durations/milrinone_durations.sql,2022-07-18T00:10:34.483628,compiling,model,,,
Q027,,debug,Compiling model.mimic.milrinone_durations,109348,Thread-1,2022-07-18T00:10:34.486476Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.milrinone_durations""",109348,Thread-1,2022-07-18T00:10:34.487915Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:34.488371Z
Q031,,debug,Began executing node model.mimic.milrinone_durations,109348,Thread-1,2022-07-18T00:10:34.488517Z,table,null,milrinone_durations,durations/milrinone_durations.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.milrinone_durations""",109348,Thread-1,2022-07-18T00:10:34.495970Z
E015,,debug,"Using postgres connection ""model.mimic.milrinone_durations""",109348,Thread-1,2022-07-18T00:10:34.497105Z
E016,,debug,On model.mimic.milrinone_durations: BEGIN,109348,Thread-1,2022-07-18T00:10:34.497283Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:34.497433Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:34.504419Z
E015,,debug,"Using postgres connection ""model.mimic.milrinone_durations""",109348,Thread-1,2022-07-18T00:10:34.504719Z
E016,,debug,"On model.mimic.milrinone_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.milrinone_durations""} */


  create  table ""postgres"".""public"".""milrinone_durations__dbt_tmp""
  as (
    -- This query extracts durations of milrinone administration
-- Consecutive administrations are numbered 1, 2, ...
-- Total time on the drug can be calculated from this table by grouping using ICUSTAY_ID

-- Get drug administration data from CareVue first
with vasocv1 as
(
  select
    icustay_id, charttime
    -- case statement determining whether the ITEMID is an instance of vasopressor usage
    , max(case when itemid = 30125 then 1 else 0 end) as vaso -- milrinone

    -- the 'stopped' column indicates if a vasopressor has been disconnected
    , max(case when itemid = 30125 and (stopped = 'Stopped' OR stopped like 'D/C%') then 1
          else 0 end) as vaso_stopped

    , max(case when itemid = 30125 and rate is not null then 1 else 0 end) as vaso_null
    , max(case when itemid = 30125 then rate else null end) as vaso_rate
    , max(case when itemid = 30125 then amount else null end) as vaso_amount

  FROM inputevents_cv
  where itemid = 30125 -- milrinone
  group by icustay_id, charttime
)
, vasocv2 as
(
  select v.*
    , sum(vaso_null) over (partition by icustay_id order by charttime) as vaso_partition
  from
    vasocv1 v
)
, vasocv3 as
(
  select v.*
    , first_value(vaso_rate) over (partition by icustay_id, vaso_partition order by charttime) as vaso_prevrate_ifnull
  from
    vasocv2 v
)
, vasocv4 as
(
select
    icustay_id
    , charttime
    -- , (CHARTTIME - (LAG(CHARTTIME, 1) OVER (partition by icustay_id, vaso order by charttime))) AS delta

    , vaso
    , vaso_rate
    , vaso_amount
    , vaso_stopped
    , vaso_prevrate_ifnull

    -- We define start time here
    , case
        when vaso = 0 then null

        -- if this is the first instance of the vasoactive drug
        when vaso_rate > 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso, vaso_null
          order by charttime
          )
          is null
          then 1

        -- you often get a string of 0s
        -- we decide not to set these as 1, just because it makes vasonum sequential
        when vaso_rate = 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 0
          then 0

        -- sometimes you get a string of NULL, associated with 0 volumes
        -- same reason as before, we decide not to set these as 1
        -- vaso_prevrate_ifnull is equal to the previous value *iff* the current value is null
        when vaso_prevrate_ifnull = 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 0
          then 0

        -- If the last recorded rate was 0, newvaso = 1
        when LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          ) = 0
          then 1

        -- If the last recorded vaso was D/C'd, newvaso = 1
        when
          LAG(vaso_stopped,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 1 then 1

        -- ** not sure if the below is needed
        --when (CHARTTIME - (LAG(CHARTTIME, 1) OVER (partition by icustay_id, vaso order by charttime))) > (interval '4 hours') then 1
      else null
      end as vaso_start

FROM
  vasocv3
)
-- propagate start/stop flags forward in time
, vasocv5 as
(
  select v.*
    , SUM(vaso_start) OVER (partition by icustay_id, vaso order by charttime) as vaso_first
FROM
  vasocv4 v
)
, vasocv6 as
(
  select v.*
    -- We define end time here
    , case
        when vaso = 0
          then null

        -- If the recorded vaso was D/C'd, this is an end time
        when vaso_stopped = 1
          then vaso_first

        -- If the rate is zero, this is the end time
        when vaso_rate = 0
          then vaso_first

        -- the last row in the table is always a potential end time
        -- this captures patients who die/are discharged while on vasopressors
        -- in principle, this could add an extra end time for the vasopressor
        -- however, since we later group on vaso_start, any extra end times are ignored
        when LEAD(CHARTTIME,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          ) is null
          then vaso_first

        else null
        end as vaso_stop
    from vasocv5 v
)

-- -- if you want to look at the results of the table before grouping:
-- select
--   icustay_id, charttime, vaso, vaso_rate, vaso_amount
--     , case when vaso_stopped = 1 then 'Y' else '' end as stopped
--     , vaso_start
--     , vaso_first
--     , vaso_stop
-- from vasocv6 order by charttime


, vasocv as
(
-- below groups together vasopressor administrations into groups
select
  icustay_id
  -- the first non-null rate is considered the starttime
  , min(case when vaso_rate is not null then charttime else null end) as starttime
  -- the *first* time the first/last flags agree is the stop time for this duration
  , min(case when vaso_first = vaso_stop then charttime else null end) as endtime
from vasocv6
where
  vaso_first is not null -- bogus data
and
  vaso_first != 0 -- sometimes *only* a rate of 0 appears, i.e. the drug is never actually delivered
and
  icustay_id is not null -- there are data for ""floating"" admissions, we don't worry about these
group by icustay_id, vaso_first
having -- ensure start time is not the same as end time
 min(charttime) != min(case when vaso_first = vaso_stop then charttime else null end)
and
  max(vaso_rate) > 0 -- if the rate was always 0 or null, we consider it not a real drug delivery
)

-- now we extract the associated data for metavision patients
, vasomv as
(
  select
    icustay_id, linkorderid
    , min(starttime) as starttime, max(endtime) as endtime
  FROM inputevents_mv
  where itemid = 221986 -- milrinone
  and statusdescription != 'Rewritten' -- only valid orders
  group by icustay_id, linkorderid
)

select
  icustay_id
  -- generate a sequential integer for convenience
  , ROW_NUMBER() over (partition by icustay_id order by starttime) as vasonum
  , starttime, endtime
  , DATETIME_DIFF(endtime, starttime, 'HOUR') AS duration_hours
  -- add durations
from
  vasocv

UNION ALL

select
  icustay_id
  , ROW_NUMBER() over (partition by icustay_id order by starttime) as vasonum
  , starttime, endtime
  , DATETIME_DIFF(endtime, starttime, 'HOUR') AS duration_hours
  -- add durations
from
  vasomv

order by icustay_id, vasonum
  );",109348,Thread-1,2022-07-18T00:10:34.504868Z
E017,,debug,SQL status: SELECT 3600 in 1.26 seconds,109348,Thread-1,2022-07-18T00:10:35.760849Z
E015,,debug,"Using postgres connection ""model.mimic.milrinone_durations""",109348,Thread-1,2022-07-18T00:10:35.768235Z
E016,,debug,"On model.mimic.milrinone_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.milrinone_durations""} */
alter table ""postgres"".""public"".""milrinone_durations"" rename to ""milrinone_durations__dbt_backup""",109348,Thread-1,2022-07-18T00:10:35.768603Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:35.769937Z
E015,,debug,"Using postgres connection ""model.mimic.milrinone_durations""",109348,Thread-1,2022-07-18T00:10:35.774317Z
E016,,debug,"On model.mimic.milrinone_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.milrinone_durations""} */
alter table ""postgres"".""public"".""milrinone_durations__dbt_tmp"" rename to ""milrinone_durations""",109348,Thread-1,2022-07-18T00:10:35.774562Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:35.775360Z
E018,,debug,On model.mimic.milrinone_durations: COMMIT,109348,Thread-1,2022-07-18T00:10:35.780473Z
E015,,debug,"Using postgres connection ""model.mimic.milrinone_durations""",109348,Thread-1,2022-07-18T00:10:35.780855Z
E016,,debug,On model.mimic.milrinone_durations: COMMIT,109348,Thread-1,2022-07-18T00:10:35.781167Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:35.784153Z
E015,,debug,"Using postgres connection ""model.mimic.milrinone_durations""",109348,Thread-1,2022-07-18T00:10:35.786903Z
E016,,debug,"On model.mimic.milrinone_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.milrinone_durations""} */
drop table if exists ""postgres"".""public"".""milrinone_durations__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:35.787139Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:35.789190Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:35.792696Z
E010,,debug,On model.mimic.milrinone_durations: Close,109348,Thread-1,2022-07-18T00:10:35.792954Z
Q012,1,info,44 of 107 OK created table model public.milrinone_durations .................... [[32mSELECT 3600[0m in 1.31s],109348,Thread-1,2022-07-18T00:10:35.794133Z,table,null,milrinone_durations,durations/milrinone_durations.sql,2022-07-18T00:10:34.483628,compiling,model,,,
Q024,1.3085155487060547,debug,Finished running node model.mimic.milrinone_durations,109348,Thread-1,2022-07-18T00:10:35.795981Z,table,2022-07-18T00:10:35.795731,milrinone_durations,durations/milrinone_durations.sql,2022-07-18T00:10:34.483628,success,model,,,
Q023,,debug,Began running node model.mimic.min_surviving_bp,109348,Thread-1,2022-07-18T00:10:35.797141Z,table,null,min_surviving_bp,cookbook/min_surviving_bp.sql,2022-07-18T00:10:35.797046,started,model,,,
Q033,,info,45 of 107 START table model public.min_surviving_bp ............................ [RUN],109348,Thread-1,2022-07-18T00:10:35.798397Z,table,null,min_surviving_bp,cookbook/min_surviving_bp.sql,2022-07-18T00:10:35.797046,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.min_surviving_bp""",109348,Thread-1,2022-07-18T00:10:35.799512Z
Q030,,debug,Began compiling node model.mimic.min_surviving_bp,109348,Thread-1,2022-07-18T00:10:35.800086Z,table,null,min_surviving_bp,cookbook/min_surviving_bp.sql,2022-07-18T00:10:35.797046,compiling,model,,,
Q027,,debug,Compiling model.mimic.min_surviving_bp,109348,Thread-1,2022-07-18T00:10:35.800402Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.min_surviving_bp""",109348,Thread-1,2022-07-18T00:10:35.802141Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:35.802866Z
Q031,,debug,Began executing node model.mimic.min_surviving_bp,109348,Thread-1,2022-07-18T00:10:35.803146Z,table,null,min_surviving_bp,cookbook/min_surviving_bp.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.min_surviving_bp""",109348,Thread-1,2022-07-18T00:10:35.811892Z
E015,,debug,"Using postgres connection ""model.mimic.min_surviving_bp""",109348,Thread-1,2022-07-18T00:10:35.813273Z
E016,,debug,On model.mimic.min_surviving_bp: BEGIN,109348,Thread-1,2022-07-18T00:10:35.813976Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:35.814533Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:35.820868Z
E015,,debug,"Using postgres connection ""model.mimic.min_surviving_bp""",109348,Thread-1,2022-07-18T00:10:35.821130Z
E016,,debug,"On model.mimic.min_surviving_bp: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.min_surviving_bp""} */


  create  table ""postgres"".""public"".""min_surviving_bp__dbt_tmp""
  as (
    -- --------------------------------------------------------
-- Title: Retrieves the systolic blood pressure of hospital survivors
-- Notes: this query does not specify a schema. To run it on your local
-- MIMIC schema, run the following command:
--  SET SEARCH_PATH TO mimiciii
-- Where ""mimiciii"" is the name of your schema, and may be different.
-- --------------------------------------------------------

WITH agetbl AS
(
  SELECT ad.subject_id
  FROM admissions ad
  INNER JOIN patients p
  ON ad.subject_id = p.subject_id
  WHERE
  -- filter to only adults
  DATETIME_DIFF(ad.admittime, p.dob, 'YEAR') > 15
  -- group by subject_id to ensure there is only 1 subject_id per row
  group by ad.subject_id
)
, min_surviving_bp as
(
  SELECT p.subject_id, ce.icustay_id, min(valuenum) AS min_sbp
  FROM chartevents ce
  INNER JOIN agetbl
  ON ce.subject_id = agetbl.subject_id
  -- here we filter down to only survivors
  INNER JOIN patients p
  ON ce.subject_id = p.subject_id and p.expire_flag = 0
  WHERE itemid IN (6, 51, 455, 6701, 220179, 220050)
  GROUP BY p.subject_id, ce.icustay_id
)
, min_surviving_bp_counted as
(
  SELECT width_bucket(min_sbp, 0, 300, 300) AS bucket
  FROM min_surviving_bp
)
SELECT bucket as systolic_blood_pressure, count(*)
FROM min_surviving_bp_counted
GROUP BY bucket
ORDER BY bucket
  );",109348,Thread-1,2022-07-18T00:10:35.821280Z
E017,,debug,SQL status: SELECT 4 in 0.19 seconds,109348,Thread-1,2022-07-18T00:10:36.014487Z
E015,,debug,"Using postgres connection ""model.mimic.min_surviving_bp""",109348,Thread-1,2022-07-18T00:10:36.020775Z
E016,,debug,"On model.mimic.min_surviving_bp: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.min_surviving_bp""} */
alter table ""postgres"".""public"".""min_surviving_bp"" rename to ""min_surviving_bp__dbt_backup""",109348,Thread-1,2022-07-18T00:10:36.021046Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:36.021821Z
E015,,debug,"Using postgres connection ""model.mimic.min_surviving_bp""",109348,Thread-1,2022-07-18T00:10:36.026382Z
E016,,debug,"On model.mimic.min_surviving_bp: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.min_surviving_bp""} */
alter table ""postgres"".""public"".""min_surviving_bp__dbt_tmp"" rename to ""min_surviving_bp""",109348,Thread-1,2022-07-18T00:10:36.026950Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:36.029426Z
E018,,debug,On model.mimic.min_surviving_bp: COMMIT,109348,Thread-1,2022-07-18T00:10:36.034772Z
E015,,debug,"Using postgres connection ""model.mimic.min_surviving_bp""",109348,Thread-1,2022-07-18T00:10:36.035072Z
E016,,debug,On model.mimic.min_surviving_bp: COMMIT,109348,Thread-1,2022-07-18T00:10:36.035278Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:36.037213Z
E015,,debug,"Using postgres connection ""model.mimic.min_surviving_bp""",109348,Thread-1,2022-07-18T00:10:36.039346Z
E016,,debug,"On model.mimic.min_surviving_bp: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.min_surviving_bp""} */
drop table if exists ""postgres"".""public"".""min_surviving_bp__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:36.039575Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:36.041383Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:36.046259Z
E010,,debug,On model.mimic.min_surviving_bp: Close,109348,Thread-1,2022-07-18T00:10:36.046884Z
Q012,0,info,45 of 107 OK created table model public.min_surviving_bp ....................... [[32mSELECT 4[0m in 0.25s],109348,Thread-1,2022-07-18T00:10:36.048353Z,table,null,min_surviving_bp,cookbook/min_surviving_bp.sql,2022-07-18T00:10:35.797046,compiling,model,,,
Q024,0.24908065795898438,debug,Finished running node model.mimic.min_surviving_bp,109348,Thread-1,2022-07-18T00:10:36.048937Z,table,2022-07-18T00:10:36.048751,min_surviving_bp,cookbook/min_surviving_bp.sql,2022-07-18T00:10:35.797046,success,model,,,
Q023,,debug,Began running node model.mimic.mortality,109348,Thread-1,2022-07-18T00:10:36.049400Z,table,null,mortality,cookbook/mortality.sql,2022-07-18T00:10:36.049341,started,model,,,
Q033,,info,46 of 107 START table model public.mortality ................................... [RUN],109348,Thread-1,2022-07-18T00:10:36.050100Z,table,null,mortality,cookbook/mortality.sql,2022-07-18T00:10:36.049341,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.mortality""",109348,Thread-1,2022-07-18T00:10:36.051006Z
Q030,,debug,Began compiling node model.mimic.mortality,109348,Thread-1,2022-07-18T00:10:36.051259Z,table,null,mortality,cookbook/mortality.sql,2022-07-18T00:10:36.049341,compiling,model,,,
Q027,,debug,Compiling model.mimic.mortality,109348,Thread-1,2022-07-18T00:10:36.051625Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.mortality""",109348,Thread-1,2022-07-18T00:10:36.052772Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:36.053285Z
Q031,,debug,Began executing node model.mimic.mortality,109348,Thread-1,2022-07-18T00:10:36.053551Z,table,null,mortality,cookbook/mortality.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.mortality""",109348,Thread-1,2022-07-18T00:10:36.066741Z
E015,,debug,"Using postgres connection ""model.mimic.mortality""",109348,Thread-1,2022-07-18T00:10:36.067567Z
E016,,debug,On model.mimic.mortality: BEGIN,109348,Thread-1,2022-07-18T00:10:36.067882Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:36.068059Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:36.073371Z
E015,,debug,"Using postgres connection ""model.mimic.mortality""",109348,Thread-1,2022-07-18T00:10:36.073909Z
E016,,debug,"On model.mimic.mortality: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.mortality""} */


  create  table ""postgres"".""public"".""mortality__dbt_tmp""
  as (
    -- ------------------------------------------------------------------
-- Title: Calculate in-hospital, 30-day, and 1 year mortality (from hospital admission)
-- Notes: this query does not specify a schema. To run it on your local
-- MIMIC schema, run the following command:
--  SET SEARCH_PATH TO mimiciii
-- Where ""mimiciii"" is the name of your schema, and may be different.
-- Inclusion criteria: Adult (>15 year old) patients, *MOST RECENT* hospital admission
-- ------------------------------------------------------------------

WITH tmp as
(
    SELECT adm.hadm_id, admittime, dischtime, adm.deathtime, pat.dod
    FROM admissions adm
    INNER JOIN patients pat
    ON adm.subject_id = pat.subject_id
    -- filter out organ donor accounts
    WHERE lower(diagnosis) NOT LIKE '%organ donor%'
    -- at least 15 years old
    AND DATETIME_DIFF(admittime, dob, 'YEAR') > 15
    -- filter that removes hospital admissions with no corresponding ICU data
    AND HAS_CHARTEVENTS_DATA = 1
)
SELECT COUNT(hadm_id) AS NumPat -- total number of patients
, round( cast(COUNT(deathtime) AS NUMERIC)/COUNT(hadm_id)*100 , 4) AS HospMort -- % hospital mortality
, round( cast(SUM(CASE WHEN dod < DATETIME_ADD(admittime, INTERVAL '30' DAY) THEN 1 ELSE 0 END) AS NUMERIC)/COUNT(hadm_id)*100.0 , 4) AS HospMort30day -- % 30 day mortality
, round( cast(SUM(CASE WHEN dod < DATETIME_ADD(admittime, INTERVAL '1' YEAR) THEN 1 ELSE 0 END) AS NUMERIC)/COUNT(hadm_id)*100 , 4) AS HospMort1yr -- % 1 year mortality
FROM tmp
  );",109348,Thread-1,2022-07-18T00:10:36.074232Z
E017,,debug,SQL status: SELECT 1 in 0.24 seconds,109348,Thread-1,2022-07-18T00:10:36.314043Z
E015,,debug,"Using postgres connection ""model.mimic.mortality""",109348,Thread-1,2022-07-18T00:10:36.321876Z
E016,,debug,"On model.mimic.mortality: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.mortality""} */
alter table ""postgres"".""public"".""mortality"" rename to ""mortality__dbt_backup""",109348,Thread-1,2022-07-18T00:10:36.322338Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:36.323622Z
E015,,debug,"Using postgres connection ""model.mimic.mortality""",109348,Thread-1,2022-07-18T00:10:36.328959Z
E016,,debug,"On model.mimic.mortality: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.mortality""} */
alter table ""postgres"".""public"".""mortality__dbt_tmp"" rename to ""mortality""",109348,Thread-1,2022-07-18T00:10:36.329239Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:36.330017Z
E018,,debug,On model.mimic.mortality: COMMIT,109348,Thread-1,2022-07-18T00:10:36.333171Z
E015,,debug,"Using postgres connection ""model.mimic.mortality""",109348,Thread-1,2022-07-18T00:10:36.333393Z
E016,,debug,On model.mimic.mortality: COMMIT,109348,Thread-1,2022-07-18T00:10:36.333764Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:36.335005Z
E015,,debug,"Using postgres connection ""model.mimic.mortality""",109348,Thread-1,2022-07-18T00:10:36.337026Z
E016,,debug,"On model.mimic.mortality: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.mortality""} */
drop table if exists ""postgres"".""public"".""mortality__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:36.337253Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:36.339375Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:36.342333Z
E010,,debug,On model.mimic.mortality: Close,109348,Thread-1,2022-07-18T00:10:36.342595Z
Q012,0,info,46 of 107 OK created table model public.mortality .............................. [[32mSELECT 1[0m in 0.29s],109348,Thread-1,2022-07-18T00:10:36.343601Z,table,null,mortality,cookbook/mortality.sql,2022-07-18T00:10:36.049341,compiling,model,,,
Q024,0.29276275634765625,debug,Finished running node model.mimic.mortality,109348,Thread-1,2022-07-18T00:10:36.344293Z,table,2022-07-18T00:10:36.344105,mortality,cookbook/mortality.sql,2022-07-18T00:10:36.049341,success,model,,,
Q023,,debug,Began running node model.mimic.neuroblock_dose,109348,Thread-1,2022-07-18T00:10:36.344808Z,table,null,neuroblock_dose,durations/neuroblock_dose.sql,2022-07-18T00:10:36.344712,started,model,,,
Q033,,info,47 of 107 START table model public.neuroblock_dose ............................. [RUN],109348,Thread-1,2022-07-18T00:10:36.345649Z,table,null,neuroblock_dose,durations/neuroblock_dose.sql,2022-07-18T00:10:36.344712,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.neuroblock_dose""",109348,Thread-1,2022-07-18T00:10:36.346633Z
Q030,,debug,Began compiling node model.mimic.neuroblock_dose,109348,Thread-1,2022-07-18T00:10:36.347025Z,table,null,neuroblock_dose,durations/neuroblock_dose.sql,2022-07-18T00:10:36.344712,compiling,model,,,
Q027,,debug,Compiling model.mimic.neuroblock_dose,109348,Thread-1,2022-07-18T00:10:36.347413Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.neuroblock_dose""",109348,Thread-1,2022-07-18T00:10:36.348906Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:36.349375Z
Q031,,debug,Began executing node model.mimic.neuroblock_dose,109348,Thread-1,2022-07-18T00:10:36.349523Z,table,null,neuroblock_dose,durations/neuroblock_dose.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.neuroblock_dose""",109348,Thread-1,2022-07-18T00:10:36.360600Z
E015,,debug,"Using postgres connection ""model.mimic.neuroblock_dose""",109348,Thread-1,2022-07-18T00:10:36.361674Z
E016,,debug,On model.mimic.neuroblock_dose: BEGIN,109348,Thread-1,2022-07-18T00:10:36.362069Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:36.362384Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:36.368036Z
E015,,debug,"Using postgres connection ""model.mimic.neuroblock_dose""",109348,Thread-1,2022-07-18T00:10:36.368291Z
E016,,debug,"On model.mimic.neuroblock_dose: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.neuroblock_dose""} */


  create  table ""postgres"".""public"".""neuroblock_dose__dbt_tmp""
  as (
    -- This query extracts dose+durations of neuromuscular blocking agents
-- Note: we assume that injections will be filtered for carevue as they will have starttime = stopttime.

-- Get drug administration data from CareVue and MetaVision
-- metavision is simple and only requires one temporary table

with drugmv as
(
  select
      icustay_id, orderid
    , rate as drug_rate
    , amount as drug_amount
    , starttime
    , endtime
  from inputevents_mv
  where itemid in
  (
      222062 -- Vecuronium (664 rows, 154 infusion rows)
    , 221555 -- Cisatracurium (9334 rows, 8970 infusion rows)
  )
  and statusdescription != 'Rewritten' -- only valid orders
  and rate is not null -- only continuous infusions
)
, drugcv1 as
(
  select
    icustay_id, charttime
    -- where clause below ensures all rows are instance of the drug
    , 1 as drug

    -- the 'stopped' column indicates if a drug has been disconnected
    , max(case when stopped in ('Stopped','D/C''d') then 1 else 0 end) as drug_stopped

    -- we only include continuous infusions, therefore expect a rate
    , max(case
            -- for ""free form"" entries (itemid >= 40000) rate is not available
            when itemid >= 40000 and amount is not null then 1
            when itemid <  40000 and rate is not null then 1
          else 0 end) as drug_null
    , max(case
            -- for ""free form"" entries (itemid >= 40000) rate is not available
            when itemid >= 40000 then coalesce(rate, amount)
          else rate end) as drug_rate
    , max(amount) as drug_amount
  from inputevents_cv
  where itemid in
  (
      30114 -- Cisatracurium (63994 rows)
    , 30138	-- Vecuronium	 (5160 rows)
    , 30113 -- Atracurium  (1163 rows)
    -- Below rows are less frequent ad-hoc documentation, but worth including!
    , 42174	-- nimbex cc/hr (207 rows)
    , 42385	-- Cisatracurium gtt (156 rows)
    , 41916	-- NIMBEX	inputevents_cv (136 rows)
    , 42100	-- cistatracurium	(132 rows)
    , 42045	-- nimbex mcg/kg/min (78 rows)
    , 42246 -- CISATRICARIUM CC/HR (70 rows)
    , 42291	-- NIMBEX CC/HR (48 rows)
    , 42590	-- nimbex	inputevents_cv (38 rows)
    , 42284	-- CISATRACURIUM DRIP (9 rows)
    , 45096	-- Vecuronium drip (2 rows)
  )
  group by icustay_id, charttime
  UNION
  -- add data from chartevents
  select
    icustay_id, charttime
    -- where clause below ensures all rows are instance of the drug
    , 1 as drug

    -- the 'stopped' column indicates if a drug has been disconnected
    , max(case when stopped in ('Stopped','D/C''d') then 1 else 0 end) as drug_stopped
    , max(case when valuenum <= 10 then 0 else 1 end) as drug_null

    -- educated guess!
    , max(case when valuenum <= 10 then valuenum else null end) as drug_rate
    , max(case when valuenum  > 10 then valuenum else null end) as drug_amount
  from chartevents
  where itemid in
  (
      1856 -- Vecuronium mcg/min  (8 rows)
    , 2164 -- NIMBEX MG/KG/HR  (243 rows)
    , 2548 -- nimbex mg/kg/hr  (103 rows)
    , 2285 -- nimbex mcg/kg/min  (85 rows)
    , 2290 -- nimbex mcg/kg/m  (32 rows)
    , 2670 -- nimbex  (38 rows)
    , 2546 -- CISATRACURIUMMG/KG/H  (7 rows)
    , 1098 -- cisatracurium mg/kg  (36 rows)
    , 2390 -- cisatracurium mg/hr  (15 rows)
    , 2511 -- CISATRACURIUM GTT  (4 rows)
    , 1028 -- Cisatracurium  (208 rows)
    , 1858 -- cisatracurium  (351 rows)
  )
  group by icustay_id, charttime

)
, drugcv2 as
(
  select v.*
    , sum(drug_null) over (partition by icustay_id order by charttime) as drug_partition
  from
    drugcv1 v
)
, drugcv3 as
(
  select v.*
    , first_value(drug_rate) over (partition by icustay_id, drug_partition order by charttime) as drug_prevrate_ifnull
  from
    drugcv2 v
)
, drugcv4 as
(
select
    icustay_id
    , charttime
    -- , (CHARTTIME - (LAG(CHARTTIME, 1) OVER (partition by icustay_id, drug order by charttime))) AS delta

    , drug
    , drug_rate
    , drug_amount
    , drug_stopped
    , drug_prevrate_ifnull

    -- We define start time here
    , case
        when drug = 0 then null

        -- if this is the first instance of the drug
        when drug_rate > 0 and
          LAG(drug_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, drug, drug_null
          order by charttime
          )
          is null
          then 1

        -- you often get a string of 0s
        -- we decide not to set these as 1, just because it makes drugnum sequential
        when drug_rate = 0 and
          LAG(drug_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, drug
          order by charttime
          )
          = 0
          then 0

        -- sometimes you get a string of NULL, associated with 0 volumes
        -- same reason as before, we decide not to set these as 1
        -- drug_prevrate_ifnull is equal to the previous value *iff* the current value is null
        when drug_prevrate_ifnull = 0 and
          LAG(drug_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, drug
          order by charttime
          )
          = 0
          then 0

        -- If the last recorded rate was 0, newdrug = 1
        when LAG(drug_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, drug
          order by charttime
          ) = 0
          then 1

        -- If the last recorded drug was D/C'd, newdrug = 1
        when
          LAG(drug_stopped,1)
          OVER
          (
          partition by icustay_id, drug
          order by charttime
          )
          = 1 then 1

        when (CHARTTIME - (LAG(CHARTTIME, 1) OVER (partition by icustay_id, drug order by charttime))) > (interval '8 hours') then 1
      else null
      end as drug_start

FROM
  drugcv3
)
-- propagate start/stop flags forward in time
, drugcv5 as
(
  select v.*
    , SUM(drug_start) OVER (partition by icustay_id, drug order by charttime) as drug_first
FROM
  drugcv4 v
)
, drugcv6 as
(
  select v.*
    -- We define end time here
    , case
        when drug = 0
          then null

        -- If the recorded drug was D/C'd, this is an end time
        when drug_stopped = 1
          then drug_first

        -- If the rate is zero, this is the end time
        when drug_rate = 0
          then drug_first

        -- the last row in the table is always a potential end time
        -- this captures patients who die/are discharged while on drug
        -- in principle, this could add an extra end time for the drug
        -- however, since we later group on drug_start, any extra end times are ignored
        when LEAD(CHARTTIME,1)
          OVER
          (
          partition by icustay_id, drug
          order by charttime
          ) is null
          then drug_first

        else null
        end as drug_stop
    from drugcv5 v
)

-- -- if you want to look at the results of the table before grouping:
-- select
--   icustay_id, charttime, drug, drug_rate, drug_amount
--     , drug_stopped
--     , drug_start
--     , drug_first
--     , drug_stop
-- from drugcv6 order by icustay_id, charttime

, drugcv7 as
(
select
  icustay_id
  , charttime as starttime
  , lead(charttime) OVER (partition by icustay_id, drug_first order by charttime) as endtime
  , drug, drug_rate, drug_amount, drug_stop, drug_start, drug_first
from drugcv6
where
  drug_first is not null -- bogus data
and
  drug_first != 0 -- sometimes *only* a rate of 0 appears, i.e. the drug is never actually delivered
and
  icustay_id is not null -- there are data for ""floating"" admissions, we don't worry about these
)
-- table of start/stop times for event
, drugcv8 as
(
  select
    icustay_id
    , starttime, endtime
    , drug, drug_rate, drug_amount, drug_stop, drug_start, drug_first
  from drugcv7
  where endtime is not null
  and drug_rate > 0
  and starttime != endtime
)
-- collapse these start/stop times down if the rate doesn't change
, drugcv9 as
(
  select
    icustay_id
    , starttime, endtime
    , case
        when LAG(endtime) OVER (partition by icustay_id order by starttime, endtime) = starttime
        AND  LAG(drug_rate) OVER (partition by icustay_id order by starttime, endtime) = drug_rate
        THEN 0
      else 1
    end as drug_groups
    , drug, drug_rate, drug_amount, drug_stop, drug_start, drug_first
  from drugcv8
  where endtime is not null
  and drug_rate > 0
  and starttime != endtime
)
, drugcv10 as
(
  select
    icustay_id
    , starttime, endtime
    , drug_groups
    , SUM(drug_groups) OVER (partition by icustay_id order by starttime, endtime) as drug_groups_sum
    , drug, drug_rate, drug_amount, drug_stop, drug_start, drug_first
  from drugcv9
)
, drugcv as
(
  select icustay_id
  , min(starttime) as starttime
  , max(endtime) as endtime
  , drug_groups_sum
  , drug_rate
  , sum(drug_amount) as drug_amount
  from drugcv10
  group by icustay_id, drug_groups_sum, drug_rate
)
-- now assign this data to every hour of the patient's stay
-- drug_amount for carevue is not accurate
SELECT icustay_id
  , starttime, endtime
  , drug_rate, drug_amount
from drugcv
UNION
SELECT icustay_id
  , starttime, endtime
  , drug_rate, drug_amount
from drugmv
order by icustay_id, starttime
  );",109348,Thread-1,2022-07-18T00:10:36.368585Z
E017,,debug,SQL status: SELECT 9704 in 0.73 seconds,109348,Thread-1,2022-07-18T00:10:37.103610Z
E015,,debug,"Using postgres connection ""model.mimic.neuroblock_dose""",109348,Thread-1,2022-07-18T00:10:37.112427Z
E016,,debug,"On model.mimic.neuroblock_dose: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.neuroblock_dose""} */
alter table ""postgres"".""public"".""neuroblock_dose"" rename to ""neuroblock_dose__dbt_backup""",109348,Thread-1,2022-07-18T00:10:37.112830Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:37.114201Z
E015,,debug,"Using postgres connection ""model.mimic.neuroblock_dose""",109348,Thread-1,2022-07-18T00:10:37.119644Z
E016,,debug,"On model.mimic.neuroblock_dose: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.neuroblock_dose""} */
alter table ""postgres"".""public"".""neuroblock_dose__dbt_tmp"" rename to ""neuroblock_dose""",109348,Thread-1,2022-07-18T00:10:37.119894Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:37.120749Z
E018,,debug,On model.mimic.neuroblock_dose: COMMIT,109348,Thread-1,2022-07-18T00:10:37.123959Z
E015,,debug,"Using postgres connection ""model.mimic.neuroblock_dose""",109348,Thread-1,2022-07-18T00:10:37.124320Z
E016,,debug,On model.mimic.neuroblock_dose: COMMIT,109348,Thread-1,2022-07-18T00:10:37.124570Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:37.127126Z
E015,,debug,"Using postgres connection ""model.mimic.neuroblock_dose""",109348,Thread-1,2022-07-18T00:10:37.131851Z
E016,,debug,"On model.mimic.neuroblock_dose: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.neuroblock_dose""} */
drop table if exists ""postgres"".""public"".""neuroblock_dose__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:37.132121Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:37.134150Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:37.137136Z
E010,,debug,On model.mimic.neuroblock_dose: Close,109348,Thread-1,2022-07-18T00:10:37.137378Z
Q012,0,info,47 of 107 OK created table model public.neuroblock_dose ........................ [[32mSELECT 9704[0m in 0.79s],109348,Thread-1,2022-07-18T00:10:37.138346Z,table,null,neuroblock_dose,durations/neuroblock_dose.sql,2022-07-18T00:10:36.344712,compiling,model,,,
Q024,0.791872501373291,debug,Finished running node model.mimic.neuroblock_dose,109348,Thread-1,2022-07-18T00:10:37.139000Z,table,2022-07-18T00:10:37.138829,neuroblock_dose,durations/neuroblock_dose.sql,2022-07-18T00:10:36.344712,success,model,,,
Q023,,debug,Began running node model.mimic.norepinephrine_durations,109348,Thread-1,2022-07-18T00:10:37.139548Z,table,null,norepinephrine_durations,durations/norepinephrine_durations.sql,2022-07-18T00:10:37.139458,started,model,,,
Q033,,info,48 of 107 START table model public.norepinephrine_durations .................... [RUN],109348,Thread-1,2022-07-18T00:10:37.140295Z,table,null,norepinephrine_durations,durations/norepinephrine_durations.sql,2022-07-18T00:10:37.139458,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.norepinephrine_durations""",109348,Thread-1,2022-07-18T00:10:37.141155Z
Q030,,debug,Began compiling node model.mimic.norepinephrine_durations,109348,Thread-1,2022-07-18T00:10:37.141444Z,table,null,norepinephrine_durations,durations/norepinephrine_durations.sql,2022-07-18T00:10:37.139458,compiling,model,,,
Q027,,debug,Compiling model.mimic.norepinephrine_durations,109348,Thread-1,2022-07-18T00:10:37.141881Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.norepinephrine_durations""",109348,Thread-1,2022-07-18T00:10:37.144026Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:37.145475Z
Q031,,debug,Began executing node model.mimic.norepinephrine_durations,109348,Thread-1,2022-07-18T00:10:37.146261Z,table,null,norepinephrine_durations,durations/norepinephrine_durations.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.norepinephrine_durations""",109348,Thread-1,2022-07-18T00:10:37.156418Z
E015,,debug,"Using postgres connection ""model.mimic.norepinephrine_durations""",109348,Thread-1,2022-07-18T00:10:37.157276Z
E016,,debug,On model.mimic.norepinephrine_durations: BEGIN,109348,Thread-1,2022-07-18T00:10:37.157932Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:37.159020Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:37.167860Z
E015,,debug,"Using postgres connection ""model.mimic.norepinephrine_durations""",109348,Thread-1,2022-07-18T00:10:37.168137Z
E016,,debug,"On model.mimic.norepinephrine_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.norepinephrine_durations""} */


  create  table ""postgres"".""public"".""norepinephrine_durations__dbt_tmp""
  as (
    -- This query extracts durations of norepinephrine administration
-- Consecutive administrations are numbered 1, 2, ...
-- Total time on the drug can be calculated from this table by grouping using ICUSTAY_ID

-- Get drug administration data from CareVue first
with vasocv1 as
(
  select
    icustay_id, charttime
    -- case statement determining whether the ITEMID is an instance of vasopressor usage
    , max(case when itemid in (30047,30120) then 1 else 0 end) as vaso -- norepinephrine

    -- the 'stopped' column indicates if a vasopressor has been disconnected
    , max(case when itemid in (30047,30120) and (stopped = 'Stopped' OR stopped like 'D/C%') then 1
          else 0 end) as vaso_stopped

    , max(case when itemid in (30047,30120) and rate is not null then 1 else 0 end) as vaso_null
    , max(case when itemid in (30047,30120) then rate else null end) as vaso_rate
    , max(case when itemid in (30047,30120) then amount else null end) as vaso_amount

  FROM inputevents_cv
  where itemid in (30047,30120) -- norepinephrine
  group by icustay_id, charttime
)
, vasocv2 as
(
  select v.*
    , sum(vaso_null) over (partition by icustay_id order by charttime) as vaso_partition
  from
    vasocv1 v
)
, vasocv3 as
(
  select v.*
    , first_value(vaso_rate) over (partition by icustay_id, vaso_partition order by charttime) as vaso_prevrate_ifnull
  from
    vasocv2 v
)
, vasocv4 as
(
select
    icustay_id
    , charttime
    -- , (CHARTTIME - (LAG(CHARTTIME, 1) OVER (partition by icustay_id, vaso order by charttime))) AS delta

    , vaso
    , vaso_rate
    , vaso_amount
    , vaso_stopped
    , vaso_prevrate_ifnull

    -- We define start time here
    , case
        when vaso = 0 then null

        -- if this is the first instance of the vasoactive drug
        when vaso_rate > 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso, vaso_null
          order by charttime
          )
          is null
          then 1

        -- you often get a string of 0s
        -- we decide not to set these as 1, just because it makes vasonum sequential
        when vaso_rate = 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 0
          then 0

        -- sometimes you get a string of NULL, associated with 0 volumes
        -- same reason as before, we decide not to set these as 1
        -- vaso_prevrate_ifnull is equal to the previous value *iff* the current value is null
        when vaso_prevrate_ifnull = 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 0
          then 0

        -- If the last recorded rate was 0, newvaso = 1
        when LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          ) = 0
          then 1

        -- If the last recorded vaso was D/C'd, newvaso = 1
        when
          LAG(vaso_stopped,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 1 then 1

        -- ** not sure if the below is needed
        --when (CHARTTIME - (LAG(CHARTTIME, 1) OVER (partition by icustay_id, vaso order by charttime))) > (interval '4 hours') then 1
      else null
      end as vaso_start

FROM
  vasocv3
)
-- propagate start/stop flags forward in time
, vasocv5 as
(
  select v.*
    , SUM(vaso_start) OVER (partition by icustay_id, vaso order by charttime) as vaso_first
FROM
  vasocv4 v
)
, vasocv6 as
(
  select v.*
    -- We define end time here
    , case
        when vaso = 0
          then null

        -- If the recorded vaso was D/C'd, this is an end time
        when vaso_stopped = 1
          then vaso_first

        -- If the rate is zero, this is the end time
        when vaso_rate = 0
          then vaso_first

        -- the last row in the table is always a potential end time
        -- this captures patients who die/are discharged while on vasopressors
        -- in principle, this could add an extra end time for the vasopressor
        -- however, since we later group on vaso_start, any extra end times are ignored
        when LEAD(CHARTTIME,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          ) is null
          then vaso_first

        else null
        end as vaso_stop
    from vasocv5 v
)

-- -- if you want to look at the results of the carevue data before grouping:
-- select
--   icustay_id, charttime, vaso, vaso_rate, vaso_amount
--     , case when vaso_stopped = 1 then 'Y' else '' end as stopped
--     , vaso_start
--     , vaso_first
--     , vaso_stop
-- from vasocv6 order by charttime

, vasocv as
(
-- below groups together vasopressor administrations into groups
select
  icustay_id
  -- the first non-null rate is considered the starttime
  , min(case when vaso_rate is not null then charttime else null end) as starttime
  -- the *first* time the first/last flags agree is the stop time for this duration
  , min(case when vaso_first = vaso_stop then charttime else null end) as endtime
from vasocv6
where
  vaso_first is not null -- bogus data
and
  vaso_first != 0 -- sometimes *only* a rate of 0 appears, i.e. the drug is never actually delivered
and
  icustay_id is not null -- there are data for ""floating"" admissions, we don't worry about these
group by icustay_id, vaso_first
having -- ensure start time is not the same as end time
 min(charttime) != min(case when vaso_first = vaso_stop then charttime else null end)
and
  max(vaso_rate) > 0 -- if the rate was always 0 or null, we consider it not a real drug delivery
)

-- now we extract the associated data for metavision patients
, vasomv as
(
  select
    icustay_id, linkorderid
    , min(starttime) as starttime, max(endtime) as endtime
  FROM inputevents_mv
  where itemid = 221906 -- norepinephrine
  and statusdescription != 'Rewritten' -- only valid orders
  group by icustay_id, linkorderid
)

select
  icustay_id
  -- generate a sequential integer for convenience
  , ROW_NUMBER() over (partition by icustay_id order by starttime) as vasonum
  , starttime, endtime
  , DATETIME_DIFF(endtime, starttime, 'HOUR') AS duration_hours
  -- add durations
from
  vasocv

UNION ALL

select
  icustay_id
  , ROW_NUMBER() over (partition by icustay_id order by starttime) as vasonum
  , starttime, endtime
  , DATETIME_DIFF(endtime, starttime, 'HOUR') AS duration_hours
  -- add durations
from
  vasomv

order by icustay_id, vasonum
  );",109348,Thread-1,2022-07-18T00:10:37.168270Z
E017,,debug,SQL status: SELECT 23188 in 3.82 seconds,109348,Thread-1,2022-07-18T00:10:40.990042Z
E015,,debug,"Using postgres connection ""model.mimic.norepinephrine_durations""",109348,Thread-1,2022-07-18T00:10:40.996947Z
E016,,debug,"On model.mimic.norepinephrine_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.norepinephrine_durations""} */
alter table ""postgres"".""public"".""norepinephrine_durations"" rename to ""norepinephrine_durations__dbt_backup""",109348,Thread-1,2022-07-18T00:10:40.997424Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:40.998803Z
E015,,debug,"Using postgres connection ""model.mimic.norepinephrine_durations""",109348,Thread-1,2022-07-18T00:10:41.002786Z
E016,,debug,"On model.mimic.norepinephrine_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.norepinephrine_durations""} */
alter table ""postgres"".""public"".""norepinephrine_durations__dbt_tmp"" rename to ""norepinephrine_durations""",109348,Thread-1,2022-07-18T00:10:41.003050Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:41.003763Z
E018,,debug,On model.mimic.norepinephrine_durations: COMMIT,109348,Thread-1,2022-07-18T00:10:41.007002Z
E015,,debug,"Using postgres connection ""model.mimic.norepinephrine_durations""",109348,Thread-1,2022-07-18T00:10:41.007234Z
E016,,debug,On model.mimic.norepinephrine_durations: COMMIT,109348,Thread-1,2022-07-18T00:10:41.007455Z
E017,,debug,SQL status: COMMIT in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:41.013451Z
E015,,debug,"Using postgres connection ""model.mimic.norepinephrine_durations""",109348,Thread-1,2022-07-18T00:10:41.016540Z
E016,,debug,"On model.mimic.norepinephrine_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.norepinephrine_durations""} */
drop table if exists ""postgres"".""public"".""norepinephrine_durations__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:41.016884Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:41.019708Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:41.022760Z
E010,,debug,On model.mimic.norepinephrine_durations: Close,109348,Thread-1,2022-07-18T00:10:41.023073Z
Q012,3,info,48 of 107 OK created table model public.norepinephrine_durations ............... [[32mSELECT 23188[0m in 3.88s],109348,Thread-1,2022-07-18T00:10:41.023948Z,table,null,norepinephrine_durations,durations/norepinephrine_durations.sql,2022-07-18T00:10:37.139458,compiling,model,,,
Q024,3.882927417755127,debug,Finished running node model.mimic.norepinephrine_durations,109348,Thread-1,2022-07-18T00:10:41.024598Z,table,2022-07-18T00:10:41.024425,norepinephrine_durations,durations/norepinephrine_durations.sql,2022-07-18T00:10:37.139458,success,model,,,
Q023,,debug,Began running node model.mimic.number_of_patients,109348,Thread-1,2022-07-18T00:10:41.025257Z,table,null,number_of_patients,cookbook/number_of_patients.sql,2022-07-18T00:10:41.025102,started,model,,,
Q033,,info,49 of 107 START table model public.number_of_patients .......................... [RUN],109348,Thread-1,2022-07-18T00:10:41.025868Z,table,null,number_of_patients,cookbook/number_of_patients.sql,2022-07-18T00:10:41.025102,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.number_of_patients""",109348,Thread-1,2022-07-18T00:10:41.027216Z
Q030,,debug,Began compiling node model.mimic.number_of_patients,109348,Thread-1,2022-07-18T00:10:41.027570Z,table,null,number_of_patients,cookbook/number_of_patients.sql,2022-07-18T00:10:41.025102,compiling,model,,,
Q027,,debug,Compiling model.mimic.number_of_patients,109348,Thread-1,2022-07-18T00:10:41.028125Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.number_of_patients""",109348,Thread-1,2022-07-18T00:10:41.034162Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:41.034860Z
Q031,,debug,Began executing node model.mimic.number_of_patients,109348,Thread-1,2022-07-18T00:10:41.035142Z,table,null,number_of_patients,cookbook/number_of_patients.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.number_of_patients""",109348,Thread-1,2022-07-18T00:10:41.045086Z
E015,,debug,"Using postgres connection ""model.mimic.number_of_patients""",109348,Thread-1,2022-07-18T00:10:41.046000Z
E016,,debug,On model.mimic.number_of_patients: BEGIN,109348,Thread-1,2022-07-18T00:10:41.046403Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:41.046717Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:41.052352Z
E015,,debug,"Using postgres connection ""model.mimic.number_of_patients""",109348,Thread-1,2022-07-18T00:10:41.052772Z
E016,,debug,"On model.mimic.number_of_patients: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.number_of_patients""} */


  create  table ""postgres"".""public"".""number_of_patients__dbt_tmp""
  as (
    -- --------------------------------------------------------
-- Title: Counts the total number of patients
-- Notes: this query does not specify a schema. To run it on your local
-- MIMIC schema, run the following command:
--  SET SEARCH_PATH TO mimiciii
-- Where ""mimiciii"" is the name of your schema, and may be different.
-- --------------------------------------------------------

SELECT count(*)
FROM patients
  );",109348,Thread-1,2022-07-18T00:10:41.053025Z
E017,,debug,SQL status: SELECT 1 in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:41.059852Z
E015,,debug,"Using postgres connection ""model.mimic.number_of_patients""",109348,Thread-1,2022-07-18T00:10:41.066447Z
E016,,debug,"On model.mimic.number_of_patients: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.number_of_patients""} */
alter table ""postgres"".""public"".""number_of_patients"" rename to ""number_of_patients__dbt_backup""",109348,Thread-1,2022-07-18T00:10:41.066695Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:41.067441Z
E015,,debug,"Using postgres connection ""model.mimic.number_of_patients""",109348,Thread-1,2022-07-18T00:10:41.071444Z
E016,,debug,"On model.mimic.number_of_patients: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.number_of_patients""} */
alter table ""postgres"".""public"".""number_of_patients__dbt_tmp"" rename to ""number_of_patients""",109348,Thread-1,2022-07-18T00:10:41.071678Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:41.072481Z
E018,,debug,On model.mimic.number_of_patients: COMMIT,109348,Thread-1,2022-07-18T00:10:41.078855Z
E015,,debug,"Using postgres connection ""model.mimic.number_of_patients""",109348,Thread-1,2022-07-18T00:10:41.079105Z
E016,,debug,On model.mimic.number_of_patients: COMMIT,109348,Thread-1,2022-07-18T00:10:41.079432Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:41.081196Z
E015,,debug,"Using postgres connection ""model.mimic.number_of_patients""",109348,Thread-1,2022-07-18T00:10:41.084668Z
E016,,debug,"On model.mimic.number_of_patients: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.number_of_patients""} */
drop table if exists ""postgres"".""public"".""number_of_patients__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:41.085157Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:41.087622Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:41.093555Z
E010,,debug,On model.mimic.number_of_patients: Close,109348,Thread-1,2022-07-18T00:10:41.094215Z
Q012,0,info,49 of 107 OK created table model public.number_of_patients ..................... [[32mSELECT 1[0m in 0.07s],109348,Thread-1,2022-07-18T00:10:41.095620Z,table,null,number_of_patients,cookbook/number_of_patients.sql,2022-07-18T00:10:41.025102,compiling,model,,,
Q024,0.0686798095703125,debug,Finished running node model.mimic.number_of_patients,109348,Thread-1,2022-07-18T00:10:41.096215Z,table,2022-07-18T00:10:41.096073,number_of_patients,cookbook/number_of_patients.sql,2022-07-18T00:10:41.025102,success,model,,,
Q023,,debug,Began running node model.mimic.phenylephrine_dose,109348,Thread-1,2022-07-18T00:10:41.096510Z,table,null,phenylephrine_dose,durations/phenylephrine_dose.sql,2022-07-18T00:10:41.096483,started,model,,,
Q033,,info,50 of 107 START table model public.phenylephrine_dose .......................... [RUN],109348,Thread-1,2022-07-18T00:10:41.096899Z,table,null,phenylephrine_dose,durations/phenylephrine_dose.sql,2022-07-18T00:10:41.096483,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.phenylephrine_dose""",109348,Thread-1,2022-07-18T00:10:41.097518Z
Q030,,debug,Began compiling node model.mimic.phenylephrine_dose,109348,Thread-1,2022-07-18T00:10:41.098048Z,table,null,phenylephrine_dose,durations/phenylephrine_dose.sql,2022-07-18T00:10:41.096483,compiling,model,,,
Q027,,debug,Compiling model.mimic.phenylephrine_dose,109348,Thread-1,2022-07-18T00:10:41.098312Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.phenylephrine_dose""",109348,Thread-1,2022-07-18T00:10:41.100202Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:41.100646Z
Q031,,debug,Began executing node model.mimic.phenylephrine_dose,109348,Thread-1,2022-07-18T00:10:41.100783Z,table,null,phenylephrine_dose,durations/phenylephrine_dose.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.phenylephrine_dose""",109348,Thread-1,2022-07-18T00:10:41.112679Z
E015,,debug,"Using postgres connection ""model.mimic.phenylephrine_dose""",109348,Thread-1,2022-07-18T00:10:41.113404Z
E016,,debug,On model.mimic.phenylephrine_dose: BEGIN,109348,Thread-1,2022-07-18T00:10:41.113545Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:41.114003Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:41.119792Z
E015,,debug,"Using postgres connection ""model.mimic.phenylephrine_dose""",109348,Thread-1,2022-07-18T00:10:41.120534Z
E016,,debug,"On model.mimic.phenylephrine_dose: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.phenylephrine_dose""} */


  create  table ""postgres"".""public"".""phenylephrine_dose__dbt_tmp""
  as (
    -- This query extracts dose+durations of phenylephrine administration

-- Get drug administration data from CareVue first
with vasocv1 as
(
    select
    icustay_id, charttime
    -- case statement determining whether the ITEMID is an instance of vasopressor usage
    , max(case when itemid in (30127,30128) then 1 else 0 end) as vaso -- phenylephrine

    -- the 'stopped' column indicates if a vasopressor has been disconnected
    , max(case when itemid in (30127,30128) and (stopped = 'Stopped' OR stopped like 'D/C%') then 1
          else 0 end) as vaso_stopped

    , max(case when itemid in (30127,30128) and rate is not null then 1 else 0 end) as vaso_null
    , max(case when itemid in (30127,30128) then rate else null end) as vaso_rate
    , max(case when itemid in (30127,30128) then amount else null end) as vaso_amount

  FROM inputevents_cv
  where itemid in (30127,30128) -- phenylephrine
  group by icustay_id, charttime
)
, vasocv2 as
(
  select v.*
    , sum(vaso_null) over (partition by icustay_id order by charttime) as vaso_partition
  from
    vasocv1 v
)
, vasocv3 as
(
  select v.*
    , first_value(vaso_rate) over (partition by icustay_id, vaso_partition order by charttime) as vaso_prevrate_ifnull
  from
    vasocv2 v
)
, vasocv4 as
(
select
    icustay_id
    , charttime
    -- , (CHARTTIME - (LAG(CHARTTIME, 1) OVER (partition by icustay_id, vaso order by charttime))) AS delta

    , vaso
    , vaso_rate
    , vaso_amount
    , vaso_stopped
    , vaso_prevrate_ifnull

    -- We define start time here
    , case
        when vaso = 0 then null

        -- if this is the first instance of the vasoactive drug
        when vaso_rate > 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso, vaso_null
          order by charttime
          )
          is null
          then 1

        -- you often get a string of 0s
        -- we decide not to set these as 1, just because it makes vasonum sequential
        when vaso_rate = 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 0
          then 0

        -- sometimes you get a string of NULL, associated with 0 volumes
        -- same reason as before, we decide not to set these as 1
        -- vaso_prevrate_ifnull is equal to the previous value *iff* the current value is null
        when vaso_prevrate_ifnull = 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 0
          then 0

        -- If the last recorded rate was 0, newvaso = 1
        when LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          ) = 0
          then 1

        -- If the last recorded vaso was D/C'd, newvaso = 1
        when
          LAG(vaso_stopped,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 1 then 1

        -- ** not sure if the below is needed
        --when (CHARTTIME - (LAG(CHARTTIME, 1) OVER (partition by icustay_id, vaso order by charttime))) > (interval '4 hours') then 1
      else null
      end as vaso_start

FROM
  vasocv3
)
-- propagate start/stop flags forward in time
, vasocv5 as
(
  select v.*
    , SUM(vaso_start) OVER (partition by icustay_id, vaso order by charttime) as vaso_first
FROM
  vasocv4 v
)
, vasocv6 as
(
  select v.*
    -- We define end time here
    , case
        when vaso = 0
          then null

        -- If the recorded vaso was D/C'd, this is an end time
        when vaso_stopped = 1
          then vaso_first

        -- If the rate is zero, this is the end time
        when vaso_rate = 0
          then vaso_first

        -- the last row in the table is always a potential end time
        -- this captures patients who die/are discharged while on vasopressors
        -- in principle, this could add an extra end time for the vasopressor
        -- however, since we later group on vaso_start, any extra end times are ignored
        when LEAD(CHARTTIME,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          ) is null
          then vaso_first

        else null
        end as vaso_stop
    from vasocv5 v
)

-- -- if you want to look at the results of the table before grouping:
-- select
--   icustay_id, charttime, vaso, vaso_rate, vaso_amount
--     , vaso_stopped
--     , vaso_start
--     , vaso_first
--     , vaso_stop
-- from vasocv6 order by icustay_id, charttime

, vasocv7 as
(
select
  icustay_id
  , charttime as starttime
  , lead(charttime) OVER (partition by icustay_id, vaso_first order by charttime) as endtime
  , vaso, vaso_rate, vaso_amount, vaso_stop, vaso_start, vaso_first
from vasocv6
where
  vaso_first is not null -- bogus data
and
  vaso_first != 0 -- sometimes *only* a rate of 0 appears, i.e. the drug is never actually delivered
and
  icustay_id is not null -- there are data for ""floating"" admissions, we don't worry about these
)
-- table of start/stop times for event
, vasocv8 as
(
  select
    icustay_id
    , starttime, endtime
    , vaso, vaso_rate, vaso_amount, vaso_stop, vaso_start, vaso_first
  from vasocv7
  where endtime is not null
  and vaso_rate > 0
  and starttime != endtime
)
-- collapse these start/stop times down if the rate doesn't change
, vasocv9 as
(
  select
    icustay_id
    , starttime, endtime
    , case
        when LAG(endtime) OVER (partition by icustay_id order by starttime, endtime) = starttime
        AND  LAG(vaso_rate) OVER (partition by icustay_id order by starttime, endtime) = vaso_rate
        THEN 0
      else 1
    end as vaso_groups
    , vaso, vaso_rate, vaso_amount, vaso_stop, vaso_start, vaso_first
  from vasocv8
  where endtime is not null
  and vaso_rate > 0
  and starttime != endtime
)
, vasocv10 as
(
  select
    icustay_id
    , starttime, endtime
    , vaso_groups
    , SUM(vaso_groups) OVER (partition by icustay_id order by starttime, endtime) as vaso_groups_sum
    , vaso, vaso_rate, vaso_amount, vaso_stop, vaso_start, vaso_first
  from vasocv9
)
, vasocv as
(
  select icustay_id
  , min(starttime) as starttime
  , max(endtime) as endtime
  , vaso_groups_sum
  , vaso_rate
  , sum(vaso_amount) as vaso_amount
  from vasocv10
  group by icustay_id, vaso_groups_sum, vaso_rate
)
-- now we extract the associated data for metavision patients
, vasomv as
(
  select
    icustay_id, linkorderid
    , rate as vaso_rate
    , amount as vaso_amount
    , starttime
    , endtime
  from inputevents_mv
  where itemid = 221749 -- phenylephrine
  and statusdescription != 'Rewritten' -- only valid orders
)
-- now assign this data to every hour of the patient's stay
-- vaso_amount for carevue is not accurate
SELECT icustay_id
  , starttime, endtime
  , vaso_rate, vaso_amount
from vasocv
UNION ALL
SELECT icustay_id
  , starttime, endtime
  , vaso_rate, vaso_amount
from vasomv
order by icustay_id, starttime
  );",109348,Thread-1,2022-07-18T00:10:41.120807Z
E017,,debug,SQL status: SELECT 186281 in 3.37 seconds,109348,Thread-1,2022-07-18T00:10:44.494769Z
E015,,debug,"Using postgres connection ""model.mimic.phenylephrine_dose""",109348,Thread-1,2022-07-18T00:10:44.500792Z
E016,,debug,"On model.mimic.phenylephrine_dose: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.phenylephrine_dose""} */
alter table ""postgres"".""public"".""phenylephrine_dose"" rename to ""phenylephrine_dose__dbt_backup""",109348,Thread-1,2022-07-18T00:10:44.501044Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:44.502483Z
E015,,debug,"Using postgres connection ""model.mimic.phenylephrine_dose""",109348,Thread-1,2022-07-18T00:10:44.508341Z
E016,,debug,"On model.mimic.phenylephrine_dose: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.phenylephrine_dose""} */
alter table ""postgres"".""public"".""phenylephrine_dose__dbt_tmp"" rename to ""phenylephrine_dose""",109348,Thread-1,2022-07-18T00:10:44.508593Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:44.509399Z
E018,,debug,On model.mimic.phenylephrine_dose: COMMIT,109348,Thread-1,2022-07-18T00:10:44.512419Z
E015,,debug,"Using postgres connection ""model.mimic.phenylephrine_dose""",109348,Thread-1,2022-07-18T00:10:44.512639Z
E016,,debug,On model.mimic.phenylephrine_dose: COMMIT,109348,Thread-1,2022-07-18T00:10:44.512990Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:44.518056Z
E015,,debug,"Using postgres connection ""model.mimic.phenylephrine_dose""",109348,Thread-1,2022-07-18T00:10:44.521411Z
E016,,debug,"On model.mimic.phenylephrine_dose: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.phenylephrine_dose""} */
drop table if exists ""postgres"".""public"".""phenylephrine_dose__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:44.521702Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:44.524303Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:44.527299Z
E010,,debug,On model.mimic.phenylephrine_dose: Close,109348,Thread-1,2022-07-18T00:10:44.527556Z
Q012,3,info,50 of 107 OK created table model public.phenylephrine_dose ..................... [[32mSELECT 186281[0m in 3.43s],109348,Thread-1,2022-07-18T00:10:44.528517Z,table,null,phenylephrine_dose,durations/phenylephrine_dose.sql,2022-07-18T00:10:41.096483,compiling,model,,,
Q024,3.4311094284057617,debug,Finished running node model.mimic.phenylephrine_dose,109348,Thread-1,2022-07-18T00:10:44.528977Z,table,2022-07-18T00:10:44.528869,phenylephrine_dose,durations/phenylephrine_dose.sql,2022-07-18T00:10:41.096483,success,model,,,
Q023,,debug,Began running node model.mimic.phenylephrine_durations,109348,Thread-1,2022-07-18T00:10:44.529263Z,table,null,phenylephrine_durations,durations/phenylephrine_durations.sql,2022-07-18T00:10:44.529214,started,model,,,
Q033,,info,51 of 107 START table model public.phenylephrine_durations ..................... [RUN],109348,Thread-1,2022-07-18T00:10:44.529445Z,table,null,phenylephrine_durations,durations/phenylephrine_durations.sql,2022-07-18T00:10:44.529214,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.phenylephrine_durations""",109348,Thread-1,2022-07-18T00:10:44.530696Z
Q030,,debug,Began compiling node model.mimic.phenylephrine_durations,109348,Thread-1,2022-07-18T00:10:44.531035Z,table,null,phenylephrine_durations,durations/phenylephrine_durations.sql,2022-07-18T00:10:44.529214,compiling,model,,,
Q027,,debug,Compiling model.mimic.phenylephrine_durations,109348,Thread-1,2022-07-18T00:10:44.531601Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.phenylephrine_durations""",109348,Thread-1,2022-07-18T00:10:44.534078Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:44.535125Z
Q031,,debug,Began executing node model.mimic.phenylephrine_durations,109348,Thread-1,2022-07-18T00:10:44.535625Z,table,null,phenylephrine_durations,durations/phenylephrine_durations.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.phenylephrine_durations""",109348,Thread-1,2022-07-18T00:10:44.548959Z
E015,,debug,"Using postgres connection ""model.mimic.phenylephrine_durations""",109348,Thread-1,2022-07-18T00:10:44.549528Z
E016,,debug,On model.mimic.phenylephrine_durations: BEGIN,109348,Thread-1,2022-07-18T00:10:44.550120Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:44.550481Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:44.558413Z
E015,,debug,"Using postgres connection ""model.mimic.phenylephrine_durations""",109348,Thread-1,2022-07-18T00:10:44.559237Z
E016,,debug,"On model.mimic.phenylephrine_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.phenylephrine_durations""} */


  create  table ""postgres"".""public"".""phenylephrine_durations__dbt_tmp""
  as (
    -- This query extracts durations of phenylephrine administration
-- Consecutive administrations are numbered 1, 2, ...
-- Total time on the drug can be calculated from this table by grouping using ICUSTAY_ID

-- Get drug administration data from CareVue first
with vasocv1 as
(
  select
    icustay_id, charttime
    -- case statement determining whether the ITEMID is an instance of vasopressor usage
    , max(case when itemid in (30127,30128) then 1 else 0 end) as vaso -- phenylephrine

    -- the 'stopped' column indicates if a vasopressor has been disconnected
    , max(case when itemid in (30127,30128) and (stopped = 'Stopped' OR stopped like 'D/C%') then 1
          else 0 end) as vaso_stopped

    , max(case when itemid in (30127,30128) and rate is not null then 1 else 0 end) as vaso_null
    , max(case when itemid in (30127,30128) then rate else null end) as vaso_rate
    , max(case when itemid in (30127,30128) then amount else null end) as vaso_amount

  FROM inputevents_cv
  where itemid in
  (
        30127,30128 -- phenylephrine
  )
  group by icustay_id, charttime
)
, vasocv2 as
(
  select v.*
    , sum(vaso_null) over (partition by icustay_id order by charttime) as vaso_partition
  from
    vasocv1 v
)
, vasocv3 as
(
  select v.*
    , first_value(vaso_rate) over (partition by icustay_id, vaso_partition order by charttime) as vaso_prevrate_ifnull
  from
    vasocv2 v
)
, vasocv4 as
(
select
    icustay_id
    , charttime
    -- , (CHARTTIME - (LAG(CHARTTIME, 1) OVER (partition by icustay_id, vaso order by charttime))) AS delta

    , vaso
    , vaso_rate
    , vaso_amount
    , vaso_stopped
    , vaso_prevrate_ifnull

    -- We define start time here
    , case
        when vaso = 0 then null

        -- if this is the first instance of the vasoactive drug
        when vaso_rate > 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso, vaso_null
          order by charttime
          )
          is null
          then 1

        -- you often get a string of 0s
        -- we decide not to set these as 1, just because it makes vasonum sequential
        when vaso_rate = 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 0
          then 0

        -- sometimes you get a string of NULL, associated with 0 volumes
        -- same reason as before, we decide not to set these as 1
        -- vaso_prevrate_ifnull is equal to the previous value *iff* the current value is null
        when vaso_prevrate_ifnull = 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 0
          then 0

        -- If the last recorded rate was 0, newvaso = 1
        when LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          ) = 0
          then 1

        -- If the last recorded vaso was D/C'd, newvaso = 1
        when
          LAG(vaso_stopped,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 1 then 1

        -- ** not sure if the below is needed
        --when (CHARTTIME - (LAG(CHARTTIME, 1) OVER (partition by icustay_id, vaso order by charttime))) > (interval '4 hours') then 1
      else null
      end as vaso_start

FROM
  vasocv3
)
-- propagate start/stop flags forward in time
, vasocv5 as
(
  select v.*
    , SUM(vaso_start) OVER (partition by icustay_id, vaso order by charttime) as vaso_first
FROM
  vasocv4 v
)
, vasocv6 as
(
  select v.*
    -- We define end time here
    , case
        when vaso = 0
          then null

        -- If the recorded vaso was D/C'd, this is an end time
        when vaso_stopped = 1
          then vaso_first

        -- If the rate is zero, this is the end time
        when vaso_rate = 0
          then vaso_first

        -- the last row in the table is always a potential end time
        -- this captures patients who die/are discharged while on vasopressors
        -- in principle, this could add an extra end time for the vasopressor
        -- however, since we later group on vaso_start, any extra end times are ignored
        when LEAD(CHARTTIME,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          ) is null
          then vaso_first

        else null
        end as vaso_stop
    from vasocv5 v
)

-- -- if you want to look at the results of the table before grouping:
-- select
--   icustay_id, charttime, vaso, vaso_rate, vaso_amount
--     , case when vaso_stopped = 1 then 'Y' else '' end as stopped
--     , vaso_start
--     , vaso_first
--     , vaso_stop
-- from vasocv6 order by charttime


, vasocv as
(
-- below groups together vasopressor administrations into groups
select
  icustay_id
  -- the first non-null rate is considered the starttime
  , min(case when vaso_rate is not null then charttime else null end) as starttime
  -- the *first* time the first/last flags agree is the stop time for this duration
  , min(case when vaso_first = vaso_stop then charttime else null end) as endtime
from vasocv6
where
  vaso_first is not null -- bogus data
and
  vaso_first != 0 -- sometimes *only* a rate of 0 appears, i.e. the drug is never actually delivered
and
  icustay_id is not null -- there are data for ""floating"" admissions, we don't worry about these
group by icustay_id, vaso_first
having -- ensure start time is not the same as end time
 min(charttime) != min(case when vaso_first = vaso_stop then charttime else null end)
and
  max(vaso_rate) > 0 -- if the rate was always 0 or null, we consider it not a real drug delivery
)

-- now we extract the associated data for metavision patients
, vasomv as
(
  select
    icustay_id, linkorderid
    , min(starttime) as starttime, max(endtime) as endtime
  FROM inputevents_mv
  where itemid = 221749 -- phenylephrine
  and statusdescription != 'Rewritten' -- only valid orders
  group by icustay_id, linkorderid
)

select
  icustay_id
  -- generate a sequential integer for convenience
  , ROW_NUMBER() over (partition by icustay_id order by starttime) as vasonum
  , starttime, endtime
  , DATETIME_DIFF(endtime, starttime, 'HOUR') AS duration_hours
  -- add durations
from
  vasocv

UNION ALL

select
  icustay_id
  , ROW_NUMBER() over (partition by icustay_id order by starttime) as vasonum
  , starttime, endtime
  , DATETIME_DIFF(endtime, starttime, 'HOUR') AS duration_hours
  -- add durations
from
  vasomv

order by icustay_id, vasonum
  );",109348,Thread-1,2022-07-18T00:10:44.559435Z
E017,,debug,SQL status: SELECT 33141 in 3.77 seconds,109348,Thread-1,2022-07-18T00:10:48.328195Z
E015,,debug,"Using postgres connection ""model.mimic.phenylephrine_durations""",109348,Thread-1,2022-07-18T00:10:48.332109Z
E016,,debug,"On model.mimic.phenylephrine_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.phenylephrine_durations""} */
alter table ""postgres"".""public"".""phenylephrine_durations"" rename to ""phenylephrine_durations__dbt_backup""",109348,Thread-1,2022-07-18T00:10:48.332332Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:48.333171Z
E015,,debug,"Using postgres connection ""model.mimic.phenylephrine_durations""",109348,Thread-1,2022-07-18T00:10:48.337047Z
E016,,debug,"On model.mimic.phenylephrine_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.phenylephrine_durations""} */
alter table ""postgres"".""public"".""phenylephrine_durations__dbt_tmp"" rename to ""phenylephrine_durations""",109348,Thread-1,2022-07-18T00:10:48.337273Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:48.338101Z
E018,,debug,On model.mimic.phenylephrine_durations: COMMIT,109348,Thread-1,2022-07-18T00:10:48.340926Z
E015,,debug,"Using postgres connection ""model.mimic.phenylephrine_durations""",109348,Thread-1,2022-07-18T00:10:48.341135Z
E016,,debug,On model.mimic.phenylephrine_durations: COMMIT,109348,Thread-1,2022-07-18T00:10:48.341244Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:48.345807Z
E015,,debug,"Using postgres connection ""model.mimic.phenylephrine_durations""",109348,Thread-1,2022-07-18T00:10:48.347875Z
E016,,debug,"On model.mimic.phenylephrine_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.phenylephrine_durations""} */
drop table if exists ""postgres"".""public"".""phenylephrine_durations__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:48.348103Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:48.350547Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:48.353113Z
E010,,debug,On model.mimic.phenylephrine_durations: Close,109348,Thread-1,2022-07-18T00:10:48.353508Z
Q012,3,info,51 of 107 OK created table model public.phenylephrine_durations ................ [[32mSELECT 33141[0m in 3.82s],109348,Thread-1,2022-07-18T00:10:48.354590Z,table,null,phenylephrine_durations,durations/phenylephrine_durations.sql,2022-07-18T00:10:44.529214,compiling,model,,,
Q024,3.8240199089050293,debug,Finished running node model.mimic.phenylephrine_durations,109348,Thread-1,2022-07-18T00:10:48.355394Z,table,2022-07-18T00:10:48.355191,phenylephrine_durations,durations/phenylephrine_durations.sql,2022-07-18T00:10:44.529214,success,model,,,
Q023,,debug,Began running node model.mimic.pivoted_bg,109348,Thread-1,2022-07-18T00:10:48.356034Z,table,null,pivoted_bg,pivot/pivoted_bg.sql,2022-07-18T00:10:48.355932,started,model,,,
Q033,,info,52 of 107 START table model public.pivoted_bg .................................. [RUN],109348,Thread-1,2022-07-18T00:10:48.356868Z,table,null,pivoted_bg,pivot/pivoted_bg.sql,2022-07-18T00:10:48.355932,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.pivoted_bg""",109348,Thread-1,2022-07-18T00:10:48.357586Z
Q030,,debug,Began compiling node model.mimic.pivoted_bg,109348,Thread-1,2022-07-18T00:10:48.358137Z,table,null,pivoted_bg,pivot/pivoted_bg.sql,2022-07-18T00:10:48.355932,compiling,model,,,
Q027,,debug,Compiling model.mimic.pivoted_bg,109348,Thread-1,2022-07-18T00:10:48.358657Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.pivoted_bg""",109348,Thread-1,2022-07-18T00:10:48.362946Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:48.363803Z
Q031,,debug,Began executing node model.mimic.pivoted_bg,109348,Thread-1,2022-07-18T00:10:48.364117Z,table,null,pivoted_bg,pivot/pivoted_bg.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.pivoted_bg""",109348,Thread-1,2022-07-18T00:10:48.376686Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_bg""",109348,Thread-1,2022-07-18T00:10:48.377434Z
E016,,debug,On model.mimic.pivoted_bg: BEGIN,109348,Thread-1,2022-07-18T00:10:48.377772Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:48.378061Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:48.388330Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_bg""",109348,Thread-1,2022-07-18T00:10:48.389035Z
E016,,debug,"On model.mimic.pivoted_bg: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_bg""} */


  create  table ""postgres"".""public"".""pivoted_bg__dbt_tmp""
  as (
    -- The aim of this query is to pivot entries related to blood gases and
-- chemistry values which were found in LABEVENTS

-- create a table which has fuzzy boundaries on ICU admission
-- involves first creating a lag/lead version of intime/outtime
with i as
(
  select
    subject_id, icustay_id, intime, outtime
    , lag (outtime) over (partition by subject_id order by intime) as outtime_lag
    , lead (intime) over (partition by subject_id order by intime) as intime_lead
  FROM icustays
)
, iid_assign as
(
  select
    i.subject_id, i.icustay_id
    -- this rule is:
    --  if there are two hospitalizations within 24 hours, set the start/stop
    --  time as half way between the two admissions
    , case
        when i.outtime_lag is not null
        and i.outtime_lag > (DATETIME_SUB(i.intime, INTERVAL '24' HOUR))
          then DATETIME_SUB(i.intime, (cast(round((DATETIME_DIFF(i.intime, i.outtime_lag, 'hour')/2)) as integer) || 'HOUR')::INTERVAL)
      else DATETIME_SUB(i.intime, INTERVAL '12' HOUR)
      end as data_start
    , case
        when i.intime_lead is not null
        and i.intime_lead < (DATETIME_ADD(i.outtime, INTERVAL '24' HOUR))
          then DATETIME_ADD(i.outtime, (cast(round((DATETIME_DIFF(i.intime_lead, i.outtime, 'minute')/2)) as integer) || 'MINUTE')::INTERVAL)
      else (DATETIME_ADD(i.outtime, INTERVAL '12' HOUR))
      end as data_end
    from i
)
, pvt as
( -- begin query that extracts the data
  select le.hadm_id
  -- here we assign labels to ITEMIDs
  -- this also fuses together multiple ITEMIDs containing the same data
      , case
        when itemid = 50800 then 'SPECIMEN'
        when itemid = 50801 then 'AADO2'
        when itemid = 50802 then 'BASEEXCESS'
        when itemid = 50803 then 'BICARBONATE'
        when itemid = 50804 then 'TOTALCO2'
        when itemid = 50805 then 'CARBOXYHEMOGLOBIN'
        when itemid = 50806 then 'CHLORIDE'
        when itemid = 50808 then 'CALCIUM'
        when itemid = 50809 then 'GLUCOSE'
        when itemid = 50810 then 'HEMATOCRIT'
        when itemid = 50811 then 'HEMOGLOBIN'
        when itemid = 50812 then 'INTUBATED'
        when itemid = 50813 then 'LACTATE'
        when itemid = 50814 then 'METHEMOGLOBIN'
        when itemid = 50815 then 'O2FLOW'
        when itemid = 50816 then 'FIO2'
        when itemid = 50817 then 'SO2' -- OXYGENSATURATION
        when itemid = 50818 then 'PCO2'
        when itemid = 50819 then 'PEEP'
        when itemid = 50820 then 'PH'
        when itemid = 50821 then 'PO2'
        when itemid = 50822 then 'POTASSIUM'
        when itemid = 50823 then 'REQUIREDO2'
        when itemid = 50824 then 'SODIUM'
        when itemid = 50825 then 'TEMPERATURE'
        when itemid = 50826 then 'TIDALVOLUME'
        when itemid = 50827 then 'VENTILATIONRATE'
        when itemid = 50828 then 'VENTILATOR'
        else null
        end as label
        , charttime
        , value
        -- add in some sanity checks on the values
        , case
          when valuenum <= 0 then null
          when itemid = 50810 and valuenum > 100 then null -- hematocrit
          -- ensure FiO2 is a valid number between 21-100
          -- mistakes are rare (<100 obs out of ~100,000)
          -- there are 862 obs of valuenum == 20 - some people round down!
          -- rather than risk imputing garbage data for FiO2, we simply NULL invalid values
          when itemid = 50816 and valuenum < 20 then null
          when itemid = 50816 and valuenum > 100 then null
          when itemid = 50817 and valuenum > 100 then null -- O2 sat
          when itemid = 50815 and valuenum >  70 then null -- O2 flow
          when itemid = 50821 and valuenum > 800 then null -- PO2
           -- conservative upper limit
        else valuenum
        end as valuenum
    FROM labevents le
    where le.ITEMID in
    -- blood gases
    (
      50800, 50801, 50802, 50803, 50804, 50805, 50806, 50807, 50808, 50809
      , 50810, 50811, 50812, 50813, 50814, 50815, 50816, 50817, 50818, 50819
      , 50820, 50821, 50822, 50823, 50824, 50825, 50826, 50827, 50828
      , 51545
    )
)
, grp as
(
  select pvt.hadm_id, pvt.charttime
  , max(case when label = 'SPECIMEN' then value else null end) as specimen
  , avg(case when label = 'AADO2' then valuenum else null end) as aado2
  , avg(case when label = 'BASEEXCESS' then valuenum else null end) as baseexcess
  , avg(case when label = 'BICARBONATE' then valuenum else null end) as bicarbonate
  , avg(case when label = 'TOTALCO2' then valuenum else null end) as totalco2
  , avg(case when label = 'CARBOXYHEMOGLOBIN' then valuenum else null end) as carboxyhemoglobin
  , avg(case when label = 'CHLORIDE' then valuenum else null end) as chloride
  , avg(case when label = 'CALCIUM' then valuenum else null end) as calcium
  , avg(case when label = 'GLUCOSE' then valuenum else null end) as glucose
  , avg(case when label = 'HEMATOCRIT' then valuenum else null end) as hematocrit
  , avg(case when label = 'HEMOGLOBIN' then valuenum else null end) as hemoglobin
  , avg(case when label = 'INTUBATED' then valuenum else null end) as intubated
  , avg(case when label = 'LACTATE' then valuenum else null end) as lactate
  , avg(case when label = 'METHEMOGLOBIN' then valuenum else null end) as methemoglobin
  , avg(case when label = 'O2FLOW' then valuenum else null end) as o2flow
  , avg(case when label = 'FIO2' then valuenum else null end) as fio2
  , avg(case when label = 'SO2' then valuenum else null end) as so2 -- OXYGENSATURATION
  , avg(case when label = 'PCO2' then valuenum else null end) as pco2
  , avg(case when label = 'PEEP' then valuenum else null end) as peep
  , avg(case when label = 'PH' then valuenum else null end) as ph
  , avg(case when label = 'PO2' then valuenum else null end) as po2
  , avg(case when label = 'POTASSIUM' then valuenum else null end) as potassium
  , avg(case when label = 'REQUIREDO2' then valuenum else null end) as requiredo2
  , avg(case when label = 'SODIUM' then valuenum else null end) as sodium
  , avg(case when label = 'TEMPERATURE' then valuenum else null end) as temperature
  , avg(case when label = 'TIDALVOLUME' then valuenum else null end) as tidalvolume
  , max(case when label = 'VENTILATIONRATE' then valuenum else null end) as ventilationrate
  , max(case when label = 'VENTILATOR' then valuenum else null end) as ventilator
  from pvt
  group by pvt.hadm_id, pvt.charttime
  -- remove observations if there is more than one specimen listed
  -- we do not know whether these are arterial or mixed venous, etc...
  -- happily this is a small fraction of the total number of observations
  having sum(case when label = 'SPECIMEN' then 1 else 0 end)<2
)
select
  iid.icustay_id, grp.*
from grp
inner join admissions adm
  on grp.hadm_id = adm.hadm_id
left join iid_assign iid
  on adm.subject_id = iid.subject_id
  and grp.charttime >= iid.data_start
  and grp.charttime < iid.data_end
order by grp.hadm_id, grp.charttime
  );",109348,Thread-1,2022-07-18T00:10:48.389215Z
E017,,debug,SQL status: SELECT 0 in 0.08 seconds,109348,Thread-1,2022-07-18T00:10:48.472446Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_bg""",109348,Thread-1,2022-07-18T00:10:48.477558Z
E016,,debug,"On model.mimic.pivoted_bg: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_bg""} */
alter table ""postgres"".""public"".""pivoted_bg"" rename to ""pivoted_bg__dbt_backup""",109348,Thread-1,2022-07-18T00:10:48.478029Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:48.480108Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_bg""",109348,Thread-1,2022-07-18T00:10:48.486550Z
E016,,debug,"On model.mimic.pivoted_bg: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_bg""} */
alter table ""postgres"".""public"".""pivoted_bg__dbt_tmp"" rename to ""pivoted_bg""",109348,Thread-1,2022-07-18T00:10:48.487024Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:48.487940Z
E018,,debug,On model.mimic.pivoted_bg: COMMIT,109348,Thread-1,2022-07-18T00:10:48.491140Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_bg""",109348,Thread-1,2022-07-18T00:10:48.491361Z
E016,,debug,On model.mimic.pivoted_bg: COMMIT,109348,Thread-1,2022-07-18T00:10:48.491704Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:48.492922Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_bg""",109348,Thread-1,2022-07-18T00:10:48.495558Z
E016,,debug,"On model.mimic.pivoted_bg: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_bg""} */
drop table if exists ""postgres"".""public"".""pivoted_bg__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:48.495799Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:48.497986Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:48.501555Z
E010,,debug,On model.mimic.pivoted_bg: Close,109348,Thread-1,2022-07-18T00:10:48.502087Z
Q012,0,info,52 of 107 OK created table model public.pivoted_bg ............................. [[32mSELECT 0[0m in 0.15s],109348,Thread-1,2022-07-18T00:10:48.503680Z,table,null,pivoted_bg,pivot/pivoted_bg.sql,2022-07-18T00:10:48.355932,compiling,model,,,
Q024,0.14617419242858887,debug,Finished running node model.mimic.pivoted_bg,109348,Thread-1,2022-07-18T00:10:48.504321Z,table,2022-07-18T00:10:48.504057,pivoted_bg,pivot/pivoted_bg.sql,2022-07-18T00:10:48.355932,success,model,,,
Q023,,debug,Began running node model.mimic.pivoted_fio2,109348,Thread-1,2022-07-18T00:10:48.504981Z,table,null,pivoted_fio2,pivot/pivoted_fio2.sql,2022-07-18T00:10:48.504887,started,model,,,
Q033,,info,53 of 107 START table model public.pivoted_fio2 ................................ [RUN],109348,Thread-1,2022-07-18T00:10:48.505526Z,table,null,pivoted_fio2,pivot/pivoted_fio2.sql,2022-07-18T00:10:48.504887,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.pivoted_fio2""",109348,Thread-1,2022-07-18T00:10:48.506864Z
Q030,,debug,Began compiling node model.mimic.pivoted_fio2,109348,Thread-1,2022-07-18T00:10:48.507301Z,table,null,pivoted_fio2,pivot/pivoted_fio2.sql,2022-07-18T00:10:48.504887,compiling,model,,,
Q027,,debug,Compiling model.mimic.pivoted_fio2,109348,Thread-1,2022-07-18T00:10:48.507638Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.pivoted_fio2""",109348,Thread-1,2022-07-18T00:10:48.509399Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:48.510381Z
Q031,,debug,Began executing node model.mimic.pivoted_fio2,109348,Thread-1,2022-07-18T00:10:48.510705Z,table,null,pivoted_fio2,pivot/pivoted_fio2.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.pivoted_fio2""",109348,Thread-1,2022-07-18T00:10:48.520364Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_fio2""",109348,Thread-1,2022-07-18T00:10:48.520853Z
E016,,debug,On model.mimic.pivoted_fio2: BEGIN,109348,Thread-1,2022-07-18T00:10:48.520990Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:48.521101Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:48.529552Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_fio2""",109348,Thread-1,2022-07-18T00:10:48.530334Z
E016,,debug,"On model.mimic.pivoted_fio2: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_fio2""} */


  create  table ""postgres"".""public"".""pivoted_fio2__dbt_tmp""
  as (
    with pvt as
( -- begin query that extracts the data
  select le.hadm_id
  , le.charttime
  -- here we assign labels to ITEMIDs
  -- this also fuses together multiple ITEMIDs containing the same data
    -- add in some sanity checks on the values
    , ROUND(MAX((case
        when valuenum <= 0 then null
        -- ensure FiO2 is a valid number between 21-100
        -- mistakes are rare (<100 obs out of ~100,000)
        -- there are 862 obs of valuenum == 20 - some people round down!
        -- rather than risk imputing garbage data for FiO2, we simply NULL invalid values
        when itemid = 50816 and valuenum < 20 then null
        when itemid = 50816 and valuenum > 100 then null
    ELSE valuenum END))::numeric, 2) AS valuenum
    FROM labevents le
    where le.ITEMID = 50816
    GROUP BY le.hadm_id, le.charttime
)
, stg_fio2 as
(
  select hadm_id, charttime
    -- pre-process the FiO2s to ensure they are between 21-100%
    , ROUND((MAX(
        case
          when itemid = 223835
            then case
              when valuenum > 0 and valuenum <= 1
                then valuenum * 100
              -- improperly input data - looks like O2 flow in litres
              when valuenum > 1 and valuenum < 21
                then null
              when valuenum >= 21 and valuenum <= 100
                then valuenum
              else null end -- unphysiological
        when itemid in (3420, 3422)
        -- all these values are well formatted
            then valuenum
        when itemid = 190 and valuenum > 0.20 and valuenum < 1
        -- well formatted but not in %
            then valuenum * 100
      else null end
    ))::numeric, 2) as fio2_chartevents
  FROM chartevents
  where ITEMID in
  (
    3420 -- FiO2
  , 190 -- FiO2 set
  , 223835 -- Inspired O2 Fraction (FiO2)
  , 3422 -- FiO2 [measured]
  )
  and valuenum > 0 and valuenum < 100
  -- exclude rows marked as error
  AND (error IS NULL OR error != 1)
  group by hadm_id, charttime
)
select
  ie.icustay_id
  , COALESCE(pvt.charttime, fi.charttime) AS charttime
  , COALESCE(pvt.valuenum, fi.fio2_chartevents) AS fio2
from 
(
    -- one row per icustay_id/charttime
    SELECT hadm_id, charttime
    from pvt
    UNION DISTINCT
    SELECT hadm_id, charttime
    from stg_fio2
) base
INNER JOIN icustays ie
  on base.hadm_id = ie.hadm_id
  AND base.charttime >= DATETIME_SUB(ie.intime, INTERVAL '12' HOUR)
  AND base.charttime <= DATETIME_ADD(ie.outtime, INTERVAL '12' HOUR)
LEFT JOIN pvt
  ON base.hadm_id = pvt.hadm_id
  AND base.charttime = pvt.charttime
LEFT JOIN stg_fio2 fi
  ON base.hadm_id = fi.hadm_id
  AND base.charttime = fi.charttime
ORDER BY icustay_id, charttime
  );",109348,Thread-1,2022-07-18T00:10:48.530680Z
E017,,debug,SQL status: SELECT 28 in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:48.543402Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_fio2""",109348,Thread-1,2022-07-18T00:10:48.548020Z
E016,,debug,"On model.mimic.pivoted_fio2: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_fio2""} */
alter table ""postgres"".""public"".""pivoted_fio2"" rename to ""pivoted_fio2__dbt_backup""",109348,Thread-1,2022-07-18T00:10:48.548228Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:48.549081Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_fio2""",109348,Thread-1,2022-07-18T00:10:48.555888Z
E016,,debug,"On model.mimic.pivoted_fio2: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_fio2""} */
alter table ""postgres"".""public"".""pivoted_fio2__dbt_tmp"" rename to ""pivoted_fio2""",109348,Thread-1,2022-07-18T00:10:48.556206Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:48.557031Z
E018,,debug,On model.mimic.pivoted_fio2: COMMIT,109348,Thread-1,2022-07-18T00:10:48.563020Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_fio2""",109348,Thread-1,2022-07-18T00:10:48.563391Z
E016,,debug,On model.mimic.pivoted_fio2: COMMIT,109348,Thread-1,2022-07-18T00:10:48.563662Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:48.564794Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_fio2""",109348,Thread-1,2022-07-18T00:10:48.569014Z
E016,,debug,"On model.mimic.pivoted_fio2: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_fio2""} */
drop table if exists ""postgres"".""public"".""pivoted_fio2__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:48.569543Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:48.572696Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:48.575945Z
E010,,debug,On model.mimic.pivoted_fio2: Close,109348,Thread-1,2022-07-18T00:10:48.576239Z
Q012,0,info,53 of 107 OK created table model public.pivoted_fio2 ........................... [[32mSELECT 28[0m in 0.07s],109348,Thread-1,2022-07-18T00:10:48.576871Z,table,null,pivoted_fio2,pivot/pivoted_fio2.sql,2022-07-18T00:10:48.504887,compiling,model,,,
Q024,0.07025361061096191,debug,Finished running node model.mimic.pivoted_fio2,109348,Thread-1,2022-07-18T00:10:48.577222Z,table,2022-07-18T00:10:48.577131,pivoted_fio2,pivot/pivoted_fio2.sql,2022-07-18T00:10:48.504887,success,model,,,
Q023,,debug,Began running node model.mimic.pivoted_gcs,109348,Thread-1,2022-07-18T00:10:48.577433Z,table,null,pivoted_gcs,pivot/pivoted_gcs.sql,2022-07-18T00:10:48.577415,started,model,,,
Q033,,info,54 of 107 START table model public.pivoted_gcs ................................. [RUN],109348,Thread-1,2022-07-18T00:10:48.578337Z,table,null,pivoted_gcs,pivot/pivoted_gcs.sql,2022-07-18T00:10:48.577415,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.pivoted_gcs""",109348,Thread-1,2022-07-18T00:10:48.579077Z
Q030,,debug,Began compiling node model.mimic.pivoted_gcs,109348,Thread-1,2022-07-18T00:10:48.579415Z,table,null,pivoted_gcs,pivot/pivoted_gcs.sql,2022-07-18T00:10:48.577415,compiling,model,,,
Q027,,debug,Compiling model.mimic.pivoted_gcs,109348,Thread-1,2022-07-18T00:10:48.579691Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.pivoted_gcs""",109348,Thread-1,2022-07-18T00:10:48.581179Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:48.581762Z
Q031,,debug,Began executing node model.mimic.pivoted_gcs,109348,Thread-1,2022-07-18T00:10:48.582067Z,table,null,pivoted_gcs,pivot/pivoted_gcs.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.pivoted_gcs""",109348,Thread-1,2022-07-18T00:10:48.590970Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_gcs""",109348,Thread-1,2022-07-18T00:10:48.591411Z
E016,,debug,On model.mimic.pivoted_gcs: BEGIN,109348,Thread-1,2022-07-18T00:10:48.591749Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:48.591992Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:48.597132Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_gcs""",109348,Thread-1,2022-07-18T00:10:48.597385Z
E016,,debug,"On model.mimic.pivoted_gcs: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_gcs""} */


  create  table ""postgres"".""public"".""pivoted_gcs__dbt_tmp""
  as (
    -- This query extracts the Glasgow Coma Scale, a measure of neurological function.
-- The query has a few special rules:
--    (1) The verbal component can be set to 0 if the patient is ventilated.
--    This is corrected to 5 - the overall GCS is set to 15 in these cases.
--    (2) Often only one of three components is documented. The other components
--    are carried forward.

-- ITEMIDs used:

-- CAREVUE
--    723 as gcsverbal
--    454 as gcsmotor
--    184 as gcseyes

-- METAVISION
--    223900 GCS - Verbal Response
--    223901 GCS - Motor Response
--    220739 GCS - Eye Opening

-- The code combines the ITEMIDs into the carevue itemids, then pivots those
-- So 223900 is changed to 723, then the ITEMID 723 is pivoted to form gcsverbal

-- Note:
--  The GCS for sedated patients is defaulted to 15 in this code.
--  This is in line with how the data is meant to be collected.
--  e.g., from the SAPS II publication:
--    For sedated patients, the Glasgow Coma Score before sedation was used.
--    This was ascertained either from interviewing the physician who ordered the sedation,
--    or by reviewing the patient's medical record.

with base as
(
  select ce.icustay_id, ce.charttime
  -- pivot each value into its own column
  , max(case when ce.ITEMID in (454,223901) then ce.valuenum else null end) as gcsmotor
  , max(case
      when ce.ITEMID = 723 and ce.VALUE = '1.0 ET/Trach' then 0
      when ce.ITEMID = 223900 and ce.VALUE = 'No Response-ETT' then 0
      when ce.ITEMID in (723,223900) then ce.valuenum
      else null 
    end) as gcsverbal
  , max(case when ce.ITEMID in (184,220739) then ce.valuenum else null end) as gcseyes
  -- convert the data into a number, reserving a value of 0 for ET/Trach
  , max(case
      -- endotrach/vent is assigned a value of 0, later parsed specially
      when ce.ITEMID = 723 and ce.VALUE = '1.0 ET/Trach' then 1 -- carevue
      when ce.ITEMID = 223900 and ce.VALUE = 'No Response-ETT' then 1 -- metavision
    else 0 end)
    as endotrachflag
  , ROW_NUMBER ()
          OVER (PARTITION BY ce.icustay_id ORDER BY ce.charttime ASC) as rn
  FROM chartevents ce
  -- Isolate the desired GCS variables
  where ce.ITEMID in
  (
    -- 198 -- GCS
    -- GCS components, CareVue
    184, 454, 723
    -- GCS components, Metavision
    , 223900, 223901, 220739
  )
  -- exclude rows marked as error
  AND (ce.error IS NULL OR ce.error != 1)
  group by ce.icustay_id, ce.charttime
)
, gcs_stg0 as (
  select b.*
  , b2.gcsverbal as gcsverbalprev
  , b2.gcsmotor as gcsmotorprev
  , b2.gcseyes as gcseyesprev
  -- Calculate GCS, factoring in special case when they are intubated and prev vals
  -- note that the coalesce are used to implement the following if:
  --  if current value exists, use it
  --  if previous value exists, use it
  --  otherwise, default to normal
  , case
      -- replace GCS during sedation with 15
      when b.gcsverbal = 0
        then 15
      when b.gcsverbal is null and b2.gcsverbal = 0
        then 15
      -- if previously they were intub, but they aren't now, do not use previous GCS values
      when b2.gcsverbal = 0
        then
            coalesce(b.gcsmotor,6)
          + coalesce(b.gcsverbal,5)
          + coalesce(b.gcseyes,4)
      -- otherwise, add up score normally, imputing previous value if none available at current time
      else
            coalesce(b.gcsmotor,coalesce(b2.gcsmotor,6))
          + coalesce(b.gcsverbal,coalesce(b2.gcsverbal,5))
          + coalesce(b.gcseyes,coalesce(b2.gcseyes,4))
      end as gcs

  from base b
  -- join to itself within 6 hours to get previous value
  left join base b2
    on b.icustay_id = b2.icustay_id
    and b.rn = b2.rn+1
    and b2.charttime > DATETIME_SUB(b.charttime, INTERVAL '6' HOUR)
)
-- combine components with previous within 6 hours
-- filter down to cohort which is not excluded
-- truncate charttime to the hour
, gcs_stg1 as
(
  select gs.icustay_id, gs.charttime
  , gs.gcs
  , coalesce(gcsmotor,gcsmotorprev) as gcsmotor
  , coalesce(gcsverbal,gcsverbalprev) as gcsverbal
  , coalesce(gcseyes,gcseyesprev) as gcseyes
  , case when coalesce(gcsmotor,gcsmotorprev) is null then 0 else 1 end
  + case when coalesce(gcsverbal,gcsverbalprev) is null then 0 else 1 end
  + case when coalesce(gcseyes,gcseyesprev) is null then 0 else 1 end
    as components_measured
  , endotrachflag
  from gcs_stg0 gs
)
-- priority is:
--  (i) complete data, (ii) non-sedated GCS, (iii) lowest GCS, (iv) charttime
, gcs_priority as
(
  select icustay_id
    , charttime
    , gcs
    , gcsmotor
    , gcsverbal
    , gcseyes
    , endotrachflag
    , ROW_NUMBER() over
      (
        PARTITION BY icustay_id, charttime
        ORDER BY components_measured DESC, endotrachflag, gcs, charttime DESC
      ) as rn
  from gcs_stg1
)
select icustay_id
  , charttime
  , gcs
  , gcsmotor
  , gcsverbal
  , gcseyes
  , endotrachflag
from gcs_priority gs
where rn = 1
ORDER BY icustay_id, charttime
  );",109348,Thread-1,2022-07-18T00:10:48.597523Z
E017,,debug,SQL status: SELECT 0 in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:48.604265Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_gcs""",109348,Thread-1,2022-07-18T00:10:48.608592Z
E016,,debug,"On model.mimic.pivoted_gcs: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_gcs""} */
alter table ""postgres"".""public"".""pivoted_gcs"" rename to ""pivoted_gcs__dbt_backup""",109348,Thread-1,2022-07-18T00:10:48.608817Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:48.609526Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_gcs""",109348,Thread-1,2022-07-18T00:10:48.613121Z
E016,,debug,"On model.mimic.pivoted_gcs: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_gcs""} */
alter table ""postgres"".""public"".""pivoted_gcs__dbt_tmp"" rename to ""pivoted_gcs""",109348,Thread-1,2022-07-18T00:10:48.613354Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:48.614162Z
E018,,debug,On model.mimic.pivoted_gcs: COMMIT,109348,Thread-1,2022-07-18T00:10:48.617652Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_gcs""",109348,Thread-1,2022-07-18T00:10:48.617956Z
E016,,debug,On model.mimic.pivoted_gcs: COMMIT,109348,Thread-1,2022-07-18T00:10:48.618200Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:48.619349Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_gcs""",109348,Thread-1,2022-07-18T00:10:48.621734Z
E016,,debug,"On model.mimic.pivoted_gcs: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_gcs""} */
drop table if exists ""postgres"".""public"".""pivoted_gcs__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:48.622003Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:48.623865Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:48.626904Z
E010,,debug,On model.mimic.pivoted_gcs: Close,109348,Thread-1,2022-07-18T00:10:48.627347Z
Q012,0,info,54 of 107 OK created table model public.pivoted_gcs ............................ [[32mSELECT 0[0m in 0.05s],109348,Thread-1,2022-07-18T00:10:48.628188Z,table,null,pivoted_gcs,pivot/pivoted_gcs.sql,2022-07-18T00:10:48.577415,compiling,model,,,
Q024,0.04920172691345215,debug,Finished running node model.mimic.pivoted_gcs,109348,Thread-1,2022-07-18T00:10:48.628843Z,table,2022-07-18T00:10:48.628668,pivoted_gcs,pivot/pivoted_gcs.sql,2022-07-18T00:10:48.577415,success,model,,,
Q023,,debug,Began running node model.mimic.pivoted_height,109348,Thread-1,2022-07-18T00:10:48.629189Z,table,null,pivoted_height,pivot/pivoted_height.sql,2022-07-18T00:10:48.629167,started,model,,,
Q033,,info,55 of 107 START table model public.pivoted_height .............................. [RUN],109348,Thread-1,2022-07-18T00:10:48.629849Z,table,null,pivoted_height,pivot/pivoted_height.sql,2022-07-18T00:10:48.629167,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.pivoted_height""",109348,Thread-1,2022-07-18T00:10:48.630887Z
Q030,,debug,Began compiling node model.mimic.pivoted_height,109348,Thread-1,2022-07-18T00:10:48.631365Z,table,null,pivoted_height,pivot/pivoted_height.sql,2022-07-18T00:10:48.629167,compiling,model,,,
Q027,,debug,Compiling model.mimic.pivoted_height,109348,Thread-1,2022-07-18T00:10:48.631756Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.pivoted_height""",109348,Thread-1,2022-07-18T00:10:48.635724Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:48.636338Z
Q031,,debug,Began executing node model.mimic.pivoted_height,109348,Thread-1,2022-07-18T00:10:48.636608Z,table,null,pivoted_height,pivot/pivoted_height.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.pivoted_height""",109348,Thread-1,2022-07-18T00:10:48.647006Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_height""",109348,Thread-1,2022-07-18T00:10:48.647430Z
E016,,debug,On model.mimic.pivoted_height: BEGIN,109348,Thread-1,2022-07-18T00:10:48.647745Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:48.648317Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:48.656322Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_height""",109348,Thread-1,2022-07-18T00:10:48.656648Z
E016,,debug,"On model.mimic.pivoted_height: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_height""} */


  create  table ""postgres"".""public"".""pivoted_height__dbt_tmp""
  as (
    -- prep height
WITH ht_in AS
(
  SELECT 
    c.subject_id, c.icustay_id, c.charttime,
    -- Ensure that all heights are in centimeters
    ROUND((CASE
      WHEN c.itemid IN (920, 1394, 4187, 3486, 226707)
        THEN ROUND((c.valuenum * 2.54)::numeric, 2)
        -- ROUND(value::numeric, 2)
      ELSE c.valuenum
    END)::numeric, 2) AS height
    , c.valuenum as height_orig
  FROM chartevents c
  WHERE c.valuenum IS NOT NULL
  AND c.valuenum != 0
  -- exclude rows marked as error
  AND COALESCE(c.error, 0) = 0
  -- Height (measured in inches)
  AND c.itemid IN
  (
    -- CareVue
    920, 1394, 4187, 3486
    -- Metavision
    , 226707
  )
)
, ht_cm AS
(
  SELECT 
    c.subject_id, c.icustay_id, c.charttime,
    -- Ensure that all heights are in centimeters
    ROUND((CASE
      WHEN c.itemid IN (920, 1394, 4187, 3486, 226707)
        THEN c.valuenum * 2.54
      ELSE c.valuenum
    END)::numeric, 2) AS height
  FROM chartevents c
  WHERE c.valuenum IS NOT NULL
  AND c.valuenum != 0
  -- exclude rows marked as error
  AND COALESCE(c.error, 0) = 0
  -- Height cm
  AND c.itemid IN
  (
    -- CareVue
    3485, 4188
    -- MetaVision
    , 226730
  )
)
-- merge cm/height, only take 1 value per charted row
, ht_stg0 AS
(
  SELECT
  COALESCE(h1.subject_id, h1.subject_id) as subject_id
  , COALESCE(h1.charttime, h1.charttime) AS charttime
  , COALESCE(h1.height, h2.height) as height
  FROM ht_cm h1
  FULL OUTER JOIN ht_in h2
    ON h1.subject_id = h2.subject_id
    AND h1.charttime = h2.charttime
)
-- filter out bad heights
, ht_stg1 AS
(
  SELECT
    h.subject_id
    , charttime
    , CASE
        -- rule for neonates
        -- [charrtime don't have year coloum?]
        -- WHEN DATETIME_DIFF(charttime, pt.dob, `YEAR`) <= 1 AND height < 80 THEN height
        WHEN EXTRACT(YEAR FROM charttime-pt.dob) <= 1 AND height < 80 THEN height
        
        -- rule for adults
        -- WHEN DATETIME_DIFF(charttime, pt.dob, `YEAR`) > 1 AND height > 120 AND height < 230 THEN height
        WHEN EXTRACT(YEAR FROM charttime-pt.dob) > 1 AND height > 120 AND height < 230 THEN height
      ELSE NULL END as height
  FROM ht_stg0 h
  INNER JOIN patients pt
    ON h.subject_id = pt.subject_id
)
-- heights from echo-cardiography notes
, echo_note AS
(
  SELECT
    subject_id
    -- extract the time of the note from the text itself
    -- add this to the structured date in the chartdate column
    , PARSE_DATETIME('%b-%d-%Y%H:%M',
      CONCAT(
        FORMAT_DATE('%b-%d-%Y', chartdate),
        REGEXP_EXTRACT(ne.text, 'Date/Time: [\\[\\]0-9*-]+ at ([0-9:]+)')
       )
    ) AS charttime
    -- sometimes numeric values contain de-id numbers, e.g. [** Numeric Identifier **]
    -- this case is used to ignore that text
    , case
        when REGEXP_EXTRACT(ne.text, 'Height: \\(in\\) (.*?)\n') like '%*%'
            then null
        else cast(REGEXP_EXTRACT(ne.text, 'Height: \\(in\\) (.*?)\n') as numeric)
        end * 2.54 as height
  FROM noteevents ne
  WHERE ne.category = 'Echo'
)
-- use documented ideal body weights to back-calculate height
, ibw_note AS
(
    SELECT subject_id
    , ne.category
    , charttime
    , CAST(REGEXP_EXTRACT(text, 'Ideal body weight: ([0-9]+\\.?[0-9]*)') AS NUMERIC) as ibw
    FROM noteevents ne
    WHERE text like '%Ideal body weight:%'
    AND ne.category != 'Echo'
)
, ht_from_ibw AS
(
    -- IBW formulas
    -- inches
    -- F:  IBW = 45.5 kg + 2.3 kg * (height in inches - 60)
    -- M:  IBW = 50 kg + 2.3 kg * (height in inches - 60)
    
    -- cm
    -- F: 45.5 + (0.91 × [height in centimeters − 152.4])
    -- M: 50 + (0.91 × [height in centimeters − 152.4])
    
    SELECT ne.subject_id
    , charttime
    , CASE
        WHEN gender = 'F' THEN (ibw - 45.5)/0.91 + 152.4
        ELSE (ibw - 50)/0.91 + 152.4 END AS height
    FROM ibw_note ne
    INNER JOIN patients pt
      ON ne.subject_id = pt.subject_id
    WHERE ibw IS NOT NULL AND ibw != 0
)
, ht_nutrition AS
(
    -- nutrition notes usually only document height
    -- but the original note formatting has been lost, so we can't do a clever regex
    -- instead, we just look for the unit of measure (cm)
    SELECT subject_id
    , charttime
    , CAST(REGEXP_EXTRACT(ne.text, '([0-9]+) cm') AS NUMERIC) as height
    FROM noteevents ne
    WHERE category = 'Nutrition'
    AND lower(text) like '%height%'
)
SELECT subject_id, charttime, 'chartevents' as source, height
FROM ht_stg1
WHERE height IS NOT NULL AND height > 0
UNION ALL
SELECT subject_id, charttime, 'noteevents - echo' as source, height
FROM echo_note
WHERE height IS NOT NULL AND height > 0
UNION ALL
SELECT subject_id, charttime, 'noteevents - ibw' as source, height
FROM ht_from_ibw
WHERE height IS NOT NULL AND height > 0
UNION ALL
SELECT subject_id, charttime, 'noteevents - nutrition' as source
-- convert the heights
    , CASE 
        WHEN height < 80 THEN height*2.54
        ELSE height
    END AS height
FROM ht_nutrition
WHERE height IS NOT NULL AND height > 0
ORDER BY subject_id, charttime, source, height
  );",109348,Thread-1,2022-07-18T00:10:48.656872Z
E017,,debug,SQL status: SELECT 0 in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:48.669524Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_height""",109348,Thread-1,2022-07-18T00:10:48.675917Z
E016,,debug,"On model.mimic.pivoted_height: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_height""} */
alter table ""postgres"".""public"".""pivoted_height"" rename to ""pivoted_height__dbt_backup""",109348,Thread-1,2022-07-18T00:10:48.676171Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:48.676932Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_height""",109348,Thread-1,2022-07-18T00:10:48.680407Z
E016,,debug,"On model.mimic.pivoted_height: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_height""} */
alter table ""postgres"".""public"".""pivoted_height__dbt_tmp"" rename to ""pivoted_height""",109348,Thread-1,2022-07-18T00:10:48.680631Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:48.681414Z
E018,,debug,On model.mimic.pivoted_height: COMMIT,109348,Thread-1,2022-07-18T00:10:48.689323Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_height""",109348,Thread-1,2022-07-18T00:10:48.689667Z
E016,,debug,On model.mimic.pivoted_height: COMMIT,109348,Thread-1,2022-07-18T00:10:48.689981Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:48.691121Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_height""",109348,Thread-1,2022-07-18T00:10:48.692737Z
E016,,debug,"On model.mimic.pivoted_height: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_height""} */
drop table if exists ""postgres"".""public"".""pivoted_height__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:48.692939Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:48.695207Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:48.698301Z
E010,,debug,On model.mimic.pivoted_height: Close,109348,Thread-1,2022-07-18T00:10:48.698565Z
Q012,0,info,55 of 107 OK created table model public.pivoted_height ......................... [[32mSELECT 0[0m in 0.07s],109348,Thread-1,2022-07-18T00:10:48.699465Z,table,null,pivoted_height,pivot/pivoted_height.sql,2022-07-18T00:10:48.629167,compiling,model,,,
Q024,0.06873226165771484,debug,Finished running node model.mimic.pivoted_height,109348,Thread-1,2022-07-18T00:10:48.700667Z,table,2022-07-18T00:10:48.700198,pivoted_height,pivot/pivoted_height.sql,2022-07-18T00:10:48.629167,success,model,,,
Q023,,debug,Began running node model.mimic.pivoted_icp,109348,Thread-1,2022-07-18T00:10:48.702526Z,table,null,pivoted_icp,pivot/pivoted_icp.sql,2022-07-18T00:10:48.702271,started,model,,,
Q033,,info,56 of 107 START table model public.pivoted_icp ................................. [RUN],109348,Thread-1,2022-07-18T00:10:48.704042Z,table,null,pivoted_icp,pivot/pivoted_icp.sql,2022-07-18T00:10:48.702271,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.pivoted_icp""",109348,Thread-1,2022-07-18T00:10:48.705145Z
Q030,,debug,Began compiling node model.mimic.pivoted_icp,109348,Thread-1,2022-07-18T00:10:48.705337Z,table,null,pivoted_icp,pivot/pivoted_icp.sql,2022-07-18T00:10:48.702271,compiling,model,,,
Q027,,debug,Compiling model.mimic.pivoted_icp,109348,Thread-1,2022-07-18T00:10:48.705462Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.pivoted_icp""",109348,Thread-1,2022-07-18T00:10:48.707079Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:48.708573Z
Q031,,debug,Began executing node model.mimic.pivoted_icp,109348,Thread-1,2022-07-18T00:10:48.708996Z,table,null,pivoted_icp,pivot/pivoted_icp.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.pivoted_icp""",109348,Thread-1,2022-07-18T00:10:48.718230Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_icp""",109348,Thread-1,2022-07-18T00:10:48.719036Z
E016,,debug,On model.mimic.pivoted_icp: BEGIN,109348,Thread-1,2022-07-18T00:10:48.719722Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:48.719928Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:48.725106Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_icp""",109348,Thread-1,2022-07-18T00:10:48.725580Z
E016,,debug,"On model.mimic.pivoted_icp: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_icp""} */


  create  table ""postgres"".""public"".""pivoted_icp__dbt_tmp""
  as (
    with ce as
(
  select ce.icustay_id
    , ce.charttime
    -- TODO: handle high ICPs when monitoring two ICPs
    , case when valuenum > 0 and valuenum < 100 then valuenum else null end as icp
  FROM chartevents ce
  -- exclude rows marked as error
  where (ce.error IS NULL OR ce.error = 0)
  and ce.icustay_id IS NOT NULL
  and ce.itemid in
  (
   226 -- ICP -- 99159
  ,1374 -- ICP Right -- 100
  ,2045 -- icp left -- 70
  ,2635 -- VENT ICP -- 195
  ,2660 -- ICP Camino -- 40
  ,2733 -- RIGHT VENT ICP -- 203
  ,2745 -- ICP LEFT -- 232
  ,2870 -- ICP-ventriculostomuy -- 114
  ,2956 -- ventriculostomy icp -- 64
  ,2985 -- ICP ventricle -- 85
  ,5856 -- icp -- 7
  ,7116 -- Rt ICP -- 80
  ,8218 -- left icp -- 6
  ,8298 -- L ICP -- 47
  ,8299 -- R ICP -- 16
  ,8305 -- ICP  Right -- 49
  ,220765 -- Intra Cranial Pressure -- 92306
  ,227989 -- Intra Cranial Pressure #2 -- 1052
  )
)
select
    ce.icustay_id
  , ce.charttime
  , MAX(icp) as icp
from ce
group by ce.icustay_id, ce.charttime
order by ce.icustay_id, ce.charttime
  );",109348,Thread-1,2022-07-18T00:10:48.726349Z
E017,,debug,SQL status: SELECT 0 in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:48.732761Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_icp""",109348,Thread-1,2022-07-18T00:10:48.739675Z
E016,,debug,"On model.mimic.pivoted_icp: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_icp""} */
alter table ""postgres"".""public"".""pivoted_icp"" rename to ""pivoted_icp__dbt_backup""",109348,Thread-1,2022-07-18T00:10:48.740043Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:48.740872Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_icp""",109348,Thread-1,2022-07-18T00:10:48.745648Z
E016,,debug,"On model.mimic.pivoted_icp: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_icp""} */
alter table ""postgres"".""public"".""pivoted_icp__dbt_tmp"" rename to ""pivoted_icp""",109348,Thread-1,2022-07-18T00:10:48.745995Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:48.746819Z
E018,,debug,On model.mimic.pivoted_icp: COMMIT,109348,Thread-1,2022-07-18T00:10:48.751864Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_icp""",109348,Thread-1,2022-07-18T00:10:48.752311Z
E016,,debug,On model.mimic.pivoted_icp: COMMIT,109348,Thread-1,2022-07-18T00:10:48.752978Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:48.754817Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_icp""",109348,Thread-1,2022-07-18T00:10:48.757446Z
E016,,debug,"On model.mimic.pivoted_icp: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_icp""} */
drop table if exists ""postgres"".""public"".""pivoted_icp__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:48.758056Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:48.760433Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:48.764212Z
E010,,debug,On model.mimic.pivoted_icp: Close,109348,Thread-1,2022-07-18T00:10:48.764478Z
Q012,0,info,56 of 107 OK created table model public.pivoted_icp ............................ [[32mSELECT 0[0m in 0.06s],109348,Thread-1,2022-07-18T00:10:48.765495Z,table,null,pivoted_icp,pivot/pivoted_icp.sql,2022-07-18T00:10:48.702271,compiling,model,,,
Q024,0.06043672561645508,debug,Finished running node model.mimic.pivoted_icp,109348,Thread-1,2022-07-18T00:10:48.766427Z,table,2022-07-18T00:10:48.766251,pivoted_icp,pivot/pivoted_icp.sql,2022-07-18T00:10:48.702271,success,model,,,
Q023,,debug,Began running node model.mimic.pivoted_invasive_lines,109348,Thread-1,2022-07-18T00:10:48.767374Z,table,null,pivoted_invasive_lines,pivot/pivoted_invasive_lines.sql,2022-07-18T00:10:48.767231,started,model,,,
Q033,,info,57 of 107 START table model public.pivoted_invasive_lines ...................... [RUN],109348,Thread-1,2022-07-18T00:10:48.768924Z,table,null,pivoted_invasive_lines,pivot/pivoted_invasive_lines.sql,2022-07-18T00:10:48.767231,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.pivoted_invasive_lines""",109348,Thread-1,2022-07-18T00:10:48.770499Z
Q030,,debug,Began compiling node model.mimic.pivoted_invasive_lines,109348,Thread-1,2022-07-18T00:10:48.771051Z,table,null,pivoted_invasive_lines,pivot/pivoted_invasive_lines.sql,2022-07-18T00:10:48.767231,compiling,model,,,
Q027,,debug,Compiling model.mimic.pivoted_invasive_lines,109348,Thread-1,2022-07-18T00:10:48.771399Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.pivoted_invasive_lines""",109348,Thread-1,2022-07-18T00:10:48.773285Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:48.774411Z
Q031,,debug,Began executing node model.mimic.pivoted_invasive_lines,109348,Thread-1,2022-07-18T00:10:48.774801Z,table,null,pivoted_invasive_lines,pivot/pivoted_invasive_lines.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.pivoted_invasive_lines""",109348,Thread-1,2022-07-18T00:10:48.785327Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_invasive_lines""",109348,Thread-1,2022-07-18T00:10:48.787319Z
E016,,debug,On model.mimic.pivoted_invasive_lines: BEGIN,109348,Thread-1,2022-07-18T00:10:48.787728Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:48.787892Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:48.793394Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_invasive_lines""",109348,Thread-1,2022-07-18T00:10:48.793937Z
E016,,debug,"On model.mimic.pivoted_invasive_lines: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_invasive_lines""} */


  create  table ""postgres"".""public"".""pivoted_invasive_lines__dbt_tmp""
  as (
    WITH stg0 AS
(
    SELECT 
        icustay_id
        , charttime
        , storetime
        , itemid
        -- create partition which separates the lines
        , CASE
            WHEN itemid IN (229, 8392) THEN 1
            WHEN itemid IN (235, 8393) THEN 2
            WHEN itemid IN (241, 8394) THEN 3
            WHEN itemid IN (247, 8395) THEN 4
            WHEN itemid IN (253, 8396) THEN 5
            WHEN itemid IN (259, 8397) THEN 6
            WHEN itemid IN (265, 8398) THEN 7
            WHEN itemid IN (271, 8399) THEN 8
          ELSE NULL END AS line_number
        , CASE WHEN itemid < 8000 THEN value ELSE NULL END AS line_type
        , CASE WHEN itemid > 8000 THEN value ELSE NULL END AS line_site
        -- the stopped column is always present for invasive lines
        , CASE 
            --   WHEN ce.stopped = 'D/C\'d' THEN 1
              WHEN ce.stopped = 'D/C''d' THEN 1
              WHEN ce.stopped = 'NotStopd' THEN 0
          ELSE NULL END AS line_dc
    FROM chartevents ce
    WHERE ce.itemid IN 
    (
      229 -- INV Line#1 [Type]
    , 235 -- INV Line#2 [Type]
    , 241 -- INV Line#3 [Type]
    , 247 -- INV Line#4 [Type]
    , 253 -- INV Line#5 [Type]
    , 259 -- INV Line#6 [Type]
    , 265 -- INV Line#7 [Type]
    , 271 -- INV Line#8 [Type]
    , 8392 -- INV Line#1 [Site]
    , 8393 -- INV Line#2 [Site]
    , 8394 -- INV Line#3 [Site]
    , 8395 -- INV Line#4 [Site]
    , 8396 -- INV Line#5 [Site]
    , 8397 -- INV Line#6 [Site]
    , 8398 -- INV Line#7 [Site]
    , 8399 -- INV Line#8 [Site]
    )
    AND icustay_id IS NOT NULL
    AND COALESCE(ce.error, 0) = 0
)
, stg0_rn AS
(
    SELECT 
        icustay_id
        , charttime
        , line_number
        , line_type, line_site, line_dc
        -- only keep the last documented value
        , ROW_NUMBER() OVER (PARTITION BY icustay_id, charttime, itemid ORDER BY storetime DESC) as rn_last_stored
    FROM stg0
)
, stg1 AS
(
    SELECT 
        icustay_id
        , charttime
        , line_number
        -- collapse line type/site into a single row
        -- MAX() always collapses a single value, due to where rn_last_stored = 1
        , MAX(line_type) as line_type
        , MAX(line_site) as line_site
        -- any disconnection at this charttime turns off the line
        , MAX(line_dc) AS line_dc
    FROM stg0_rn
    WHERE rn_last_stored = 1
    GROUP BY icustay_id, charttime, line_number
)
, stg2 AS
(
    SELECT 
        icustay_id
        , charttime
        , line_number
        , line_type, line_site
        , line_dc
        -- carry forward the line type
        , CASE
            -- if the previous line was D/C'd then it's a new line
            WHEN LAG(line_dc) OVER (PARTITION BY icustay_id, line_number ORDER BY charttime) = 1 THEN 1
            -- if it's the same line as before, within 16 hours, continue the event
            WHEN LAG(line_type) OVER (PARTITION BY icustay_id, line_number ORDER BY charttime) = line_type
            AND DATETIME_DIFF(
                charttime,
                LAG(charttime) OVER (PARTITION BY icustay_id, line_number ORDER BY charttime),
                'HOUR'
                ) < 16 THEN 0
            -- otherwise, it's been more than 16 hours since the line was last documented
            -- (or it's the first documentation of this line)
            -- so we consider this a new event
            ELSE 1
        END AS rn_part
    FROM stg1
)
-- rn_part is 1 if it's a new event, and 0 if it's a continuation of the previous
-- so cumulatively summing it will result in a sequential integer which partitions
-- distinct line events. we can later group on this integer.
, stg3 AS
(
    SELECT
        icustay_id, charttime, line_number
        , line_type, line_site
        , line_dc
        , SUM(rn_part) OVER (PARTITION BY icustay_id, line_number ORDER BY charttime) as line_event
    FROM stg2
)
-- group by line_event to determine line start/stop times
, stg4 AS
(
    SELECT
        icustay_id, line_number
        , line_event
        , line_type, line_site
        , MIN(charttime) as starttime
        , MAX(charttime) as endtime
    FROM stg3
    -- filter out the D/C'd rows so they don't impact the starttime of future events
    WHERE line_dc = 0 
    GROUP BY icustay_id, line_number, line_event, line_type, line_site
)
-- metavision
, mv AS
(
    SELECT 
        icustay_id
        -- since metavision separates lines using itemid, we can use it as the line number
        , mv.itemid AS line_number
        , di.label AS line_type
        , mv.location AS line_site
        , starttime, endtime
    FROM procedureevents_mv mv
    INNER JOIN d_items di
      ON mv.itemid = di.itemid
    WHERE mv.itemid IN
    (
      227719 -- AVA Line
    , 225752 -- Arterial Line
    , 224269 -- CCO PAC
    , 224267 -- Cordis/Introducer
    , 224270 -- Dialysis Catheter
    , 224272 -- IABP line
    , 226124 -- ICP Catheter
    , 228169 -- Impella Line
    , 225202 -- Indwelling Port (PortaCath)
    , 228286 -- Intraosseous Device
    , 225204 -- Midline
    , 224263 -- Multi Lumen
    , 224560 -- PA Catheter
    , 224264 -- PICC Line
    , 225203 -- Pheresis Catheter
    , 224273 -- Presep Catheter
    , 225789 -- Sheath
    , 225761 -- Sheath Insertion
    , 228201 -- Tandem Heart Access Line
    , 228202 -- Tandem Heart Return Line
    , 224268 -- Trauma line
    , 225199 -- Triple Introducer
    , 225315 -- Tunneled (Hickman) Line
    , 225205 -- RIC
    )
    AND icustay_id IS NOT NULL
    AND statusdescription != 'Rewritten'
),
combined AS
(
    select 
        icustay_id
        , line_type, line_site
        , starttime
        , endtime
    FROM stg4
    UNION DISTINCT
    select 
        icustay_id
        , line_type, line_site
        , starttime
        , endtime
    FROM mv
)
-- as a final step, combine any similar terms together
-- this was comprehensive as of MIMIC-III v1.4
select 
    icustay_id
    , CASE
        WHEN line_type IN ('Arterial Line', 'A-Line') THEN 'Arterial'
        WHEN line_type IN ('CCO PA Line', 'CCO PAC') THEN 'Continuous Cardiac Output PA'
        WHEN line_type IN ('Dialysis Catheter', 'Dialysis Line') THEN 'Dialysis'
        WHEN line_type IN ('Hickman', 'Tunneled (Hickman) Line') THEN 'Hickman'
        WHEN line_type IN ('IABP', 'IABP line') THEN 'IABP'
        WHEN line_type IN ('Multi Lumen', 'Multi-lumen') THEN 'Multi Lumen'
        WHEN line_type IN ('PA Catheter', 'PA line') THEN 'PA'
        WHEN line_type IN ('PICC Line', 'PICC line') THEN 'PICC'
        WHEN line_type IN ('Pre-Sep Catheter', 'Presep Catheter') THEN 'Pre-Sep'
        WHEN line_type IN ('Trauma Line', 'Trauma line') THEN 'Trauma'
        WHEN line_type IN ('Triple Introducer', 'TripleIntroducer') THEN 'Triple Introducer'
        WHEN line_type IN ('Portacath', 'Indwelling Port (PortaCath)') THEN 'Portacath'
        -- AVA Line
        -- Camino Bolt
        -- Cordis/Introducer
        -- ICP Catheter
        -- Impella Line
        -- Intraosseous Device
        -- Introducer
        -- Lumbar Drain
        -- Midline
        -- Other/Remarks
        -- PacerIntroducer
        -- PermaCath
        -- Pheresis Catheter
        -- RIC
        -- Sheath
        -- Tandem Heart Access Line
        -- Tandem Heart Return Line
        -- Venous Access
        -- Ventriculostomy
    ELSE line_type END AS line_type
    , CASE
        WHEN line_site IN ('Left Antecub', 'Left Antecube') THEN 'Left Antecube'
        WHEN line_site IN ('Left Axilla', 'Left Axilla.') THEN 'Left Axilla'
        WHEN line_site IN ('Left Brachial', 'Left Brachial.') THEN 'Left Brachial'
        WHEN line_site IN ('Left Femoral', 'Left Femoral.') THEN 'Left Femoral'
        WHEN line_site IN ('Right Antecub', 'Right Antecube') THEN 'Right Antecube' 
        WHEN line_site IN ('Right Axilla', 'Right Axilla.') THEN 'Right Axilla' 
        WHEN line_site IN ('Right Brachial', 'Right Brachial.') THEN 'Right Brachial' 
        WHEN line_site IN ('Right Femoral', 'Right Femoral.') THEN 'Right Femoral' 
        -- 'Left Foot'
        -- 'Left IJ'
        -- 'Left Radial'
        -- 'Left Subclavian'
        -- 'Left Ulnar'
        -- 'Left Upper Arm'
        -- 'Right Foot'
        -- 'Right IJ'
        -- 'Right Radial'
        -- 'Right Side Head'
        -- 'Right Subclavian'
        -- 'Right Ulnar'
        -- 'Right Upper Arm'
        -- 'Transthoracic'
        -- 'Other/Remarks'
    ELSE line_site END AS line_site
    , starttime
    , endtime
FROM combined
ORDER BY icustay_id, starttime, line_type, line_site
  );",109348,Thread-1,2022-07-18T00:10:48.794226Z
E017,,debug,SQL status: SELECT 34483 in 0.13 seconds,109348,Thread-1,2022-07-18T00:10:48.922789Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_invasive_lines""",109348,Thread-1,2022-07-18T00:10:48.927972Z
E016,,debug,"On model.mimic.pivoted_invasive_lines: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_invasive_lines""} */
alter table ""postgres"".""public"".""pivoted_invasive_lines"" rename to ""pivoted_invasive_lines__dbt_backup""",109348,Thread-1,2022-07-18T00:10:48.928241Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:48.929167Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_invasive_lines""",109348,Thread-1,2022-07-18T00:10:48.933531Z
E016,,debug,"On model.mimic.pivoted_invasive_lines: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_invasive_lines""} */
alter table ""postgres"".""public"".""pivoted_invasive_lines__dbt_tmp"" rename to ""pivoted_invasive_lines""",109348,Thread-1,2022-07-18T00:10:48.933925Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:48.934670Z
E018,,debug,On model.mimic.pivoted_invasive_lines: COMMIT,109348,Thread-1,2022-07-18T00:10:48.938343Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_invasive_lines""",109348,Thread-1,2022-07-18T00:10:48.938608Z
E016,,debug,On model.mimic.pivoted_invasive_lines: COMMIT,109348,Thread-1,2022-07-18T00:10:48.938828Z
E017,,debug,SQL status: COMMIT in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:48.944397Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_invasive_lines""",109348,Thread-1,2022-07-18T00:10:48.946427Z
E016,,debug,"On model.mimic.pivoted_invasive_lines: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_invasive_lines""} */
drop table if exists ""postgres"".""public"".""pivoted_invasive_lines__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:48.946691Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:48.948815Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:48.953571Z
E010,,debug,On model.mimic.pivoted_invasive_lines: Close,109348,Thread-1,2022-07-18T00:10:48.954085Z
Q012,0,info,57 of 107 OK created table model public.pivoted_invasive_lines ................. [[32mSELECT 34483[0m in 0.18s],109348,Thread-1,2022-07-18T00:10:48.955257Z,table,null,pivoted_invasive_lines,pivot/pivoted_invasive_lines.sql,2022-07-18T00:10:48.767231,compiling,model,,,
Q024,0.18486285209655762,debug,Finished running node model.mimic.pivoted_invasive_lines,109348,Thread-1,2022-07-18T00:10:48.956417Z,table,2022-07-18T00:10:48.956144,pivoted_invasive_lines,pivot/pivoted_invasive_lines.sql,2022-07-18T00:10:48.767231,success,model,,,
Q023,,debug,Began running node model.mimic.pivoted_lab,109348,Thread-1,2022-07-18T00:10:48.957154Z,table,null,pivoted_lab,pivot/pivoted_lab.sql,2022-07-18T00:10:48.957072,started,model,,,
Q033,,info,58 of 107 START table model public.pivoted_lab ................................. [RUN],109348,Thread-1,2022-07-18T00:10:48.957938Z,table,null,pivoted_lab,pivot/pivoted_lab.sql,2022-07-18T00:10:48.957072,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.pivoted_lab""",109348,Thread-1,2022-07-18T00:10:48.959380Z
Q030,,debug,Began compiling node model.mimic.pivoted_lab,109348,Thread-1,2022-07-18T00:10:48.959653Z,table,null,pivoted_lab,pivot/pivoted_lab.sql,2022-07-18T00:10:48.957072,compiling,model,,,
Q027,,debug,Compiling model.mimic.pivoted_lab,109348,Thread-1,2022-07-18T00:10:48.960262Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.pivoted_lab""",109348,Thread-1,2022-07-18T00:10:48.961425Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:48.962296Z
Q031,,debug,Began executing node model.mimic.pivoted_lab,109348,Thread-1,2022-07-18T00:10:48.962666Z,table,null,pivoted_lab,pivot/pivoted_lab.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.pivoted_lab""",109348,Thread-1,2022-07-18T00:10:48.971855Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_lab""",109348,Thread-1,2022-07-18T00:10:48.972887Z
E016,,debug,On model.mimic.pivoted_lab: BEGIN,109348,Thread-1,2022-07-18T00:10:48.973225Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:48.973395Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:48.980992Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_lab""",109348,Thread-1,2022-07-18T00:10:48.981311Z
E016,,debug,"On model.mimic.pivoted_lab: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_lab""} */


  create  table ""postgres"".""public"".""pivoted_lab__dbt_tmp""
  as (
    -- create a table which has fuzzy boundaries on ICU admission (+- 12 hours from documented time)
-- this is used to assign icustay_id to lab data, which can be collected outside ICU
-- involves first creating a lag/lead version of intime/outtime
with i as
(
  select
    subject_id, icustay_id, intime, outtime
    , lag (outtime) over (partition by subject_id order by intime) as outtime_lag
    , lead (intime) over (partition by subject_id order by intime) as intime_lead
  from icustays
)
, iid_assign as
(
  select
    i.subject_id, i.icustay_id
    -- this rule is:
    --  if there are two ICU stays within 24 hours, set the start/stop
    --  time as half way between the two ICU stays
    , case
        when i.outtime_lag is not null
        and i.outtime_lag > (DATETIME_SUB(i.intime, INTERVAL '24' HOUR))
          then DATETIME_SUB(i.intime, (CAST(DATETIME_DIFF(i.intime, i.outtime_lag, 'SECOND')/2 AS integer) || 'SECOND')::INTERVAL)
      else DATETIME_SUB(i.intime, INTERVAL '12' HOUR)
      end as data_start
    , case
        when i.intime_lead is not null
        and i.intime_lead < (DATETIME_ADD(i.outtime, INTERVAL '24' HOUR))
          then DATETIME_ADD(i.outtime, (CAST(DATETIME_DIFF(i.intime_lead, i.outtime, 'SECOND')/2 AS integer) || 'SECOND')::INTERVAL)
      else (DATETIME_ADD(i.outtime, INTERVAL '12' HOUR))
      end as data_end
    from i
)
-- also create fuzzy boundaries on hospitalization
, h as
(
  select
    subject_id, hadm_id, admittime, dischtime
    , lag (dischtime) over (partition by subject_id order by admittime) as dischtime_lag
    , lead (admittime) over (partition by subject_id order by admittime) as admittime_lead
  from admissions
)
, adm as
(
  select
    h.subject_id, h.hadm_id
    -- this rule is:
    --  if there are two hospitalizations within 24 hours, set the start/stop
    --  time as half way between the two admissions
    , case
        when h.dischtime_lag is not null
        and h.dischtime_lag > (DATETIME_SUB(h.admittime, INTERVAL '24' HOUR))
          then DATETIME_SUB(h.admittime, (CAST(DATETIME_DIFF(h.admittime, h.dischtime_lag, 'SECOND')/2 AS integer) || 'SECOND')::INTERVAL)
      else DATETIME_SUB(h.admittime, INTERVAL '12' HOUR)
      end as data_start
    , case
        when h.admittime_lead is not null
        and h.admittime_lead < (DATETIME_ADD(h.dischtime, INTERVAL '24' HOUR))
          then DATETIME_ADD(h.dischtime, (CAST(DATETIME_DIFF(h.admittime_lead, h.dischtime, 'SECOND')/2 AS integer) || 'SECOND')::INTERVAL)
      else (DATETIME_ADD(h.dischtime, INTERVAL '12' HOUR))
      end as data_end
    from h
)
, le_avg as
(
SELECT
    pvt.subject_id, pvt.charttime
  , avg(CASE WHEN label = 'ANION GAP' THEN valuenum ELSE null END) as ANIONGAP
  , avg(CASE WHEN label = 'ALBUMIN' THEN valuenum ELSE null END) as ALBUMIN
  , avg(CASE WHEN label = 'BANDS' THEN valuenum ELSE null END) as BANDS
  , avg(CASE WHEN label = 'BICARBONATE' THEN valuenum ELSE null END) as BICARBONATE
  , avg(CASE WHEN label = 'BILIRUBIN' THEN valuenum ELSE null END) as BILIRUBIN
  , avg(CASE WHEN label = 'CREATININE' THEN valuenum ELSE null END) as CREATININE
  , avg(CASE WHEN label = 'CHLORIDE' THEN valuenum ELSE null END) as CHLORIDE
  , avg(CASE WHEN label = 'GLUCOSE' THEN valuenum ELSE null END) as GLUCOSE
  , avg(CASE WHEN label = 'HEMATOCRIT' THEN valuenum ELSE null END) as HEMATOCRIT
  , avg(CASE WHEN label = 'HEMOGLOBIN' THEN valuenum ELSE null END) as HEMOGLOBIN
  , avg(CASE WHEN label = 'LACTATE' THEN valuenum ELSE null END) as LACTATE
  , avg(CASE WHEN label = 'PLATELET' THEN valuenum ELSE null END) as PLATELET
  , avg(CASE WHEN label = 'POTASSIUM' THEN valuenum ELSE null END) as POTASSIUM
  , avg(CASE WHEN label = 'PTT' THEN valuenum ELSE null END) as PTT
  , avg(CASE WHEN label = 'INR' THEN valuenum ELSE null END) as INR
  , avg(CASE WHEN label = 'PT' THEN valuenum ELSE null END) as PT
  , avg(CASE WHEN label = 'SODIUM' THEN valuenum ELSE null end) as SODIUM
  , avg(CASE WHEN label = 'BUN' THEN valuenum ELSE null end) as BUN
  , avg(CASE WHEN label = 'WBC' THEN valuenum ELSE null end) as WBC
FROM
( -- begin query that extracts the data
  SELECT le.subject_id, le.hadm_id, le.charttime
  -- here we assign labels to ITEMIDs
  -- this also fuses together multiple ITEMIDs containing the same data
  , CASE
        WHEN itemid = 50868 THEN 'ANION GAP'
        WHEN itemid = 50862 THEN 'ALBUMIN'
        WHEN itemid = 51144 THEN 'BANDS'
        WHEN itemid = 50882 THEN 'BICARBONATE'
        WHEN itemid = 50885 THEN 'BILIRUBIN'
        WHEN itemid = 50912 THEN 'CREATININE'
        -- exclude blood gas
        -- WHEN itemid = 50806 THEN 'CHLORIDE'
        WHEN itemid = 50902 THEN 'CHLORIDE'
        -- exclude blood gas
        -- WHEN itemid = 50809 THEN 'GLUCOSE'
        WHEN itemid = 50931 THEN 'GLUCOSE'
        -- exclude blood gas
        --WHEN itemid = 50810 THEN 'HEMATOCRIT'
        WHEN itemid = 51221 THEN 'HEMATOCRIT'
        -- exclude blood gas
        --WHEN itemid = 50811 THEN 'HEMOGLOBIN'
        WHEN itemid = 51222 THEN 'HEMOGLOBIN'
        WHEN itemid = 50813 THEN 'LACTATE'
        WHEN itemid = 51265 THEN 'PLATELET'
        -- exclude blood gas
        -- WHEN itemid = 50822 THEN 'POTASSIUM'
        WHEN itemid = 50971 THEN 'POTASSIUM'
        WHEN itemid = 51275 THEN 'PTT'
        WHEN itemid = 51237 THEN 'INR'
        WHEN itemid = 51274 THEN 'PT'
        -- exclude blood gas
        -- WHEN itemid = 50824 THEN 'SODIUM'
        WHEN itemid = 50983 THEN 'SODIUM'
        WHEN itemid = 51006 THEN 'BUN'
        WHEN itemid = 51300 THEN 'WBC'
        WHEN itemid = 51301 THEN 'WBC'
      ELSE null
    END AS label
  , -- add in some sanity checks on the values
  -- the where clause below requires all valuenum to be > 0, so these are only upper limit checks
    CASE
      WHEN itemid = 50862 and valuenum >    10 THEN null -- g/dL 'ALBUMIN'
      WHEN itemid = 50868 and valuenum > 10000 THEN null -- mEq/L 'ANION GAP'
      WHEN itemid = 51144 and valuenum <     0 THEN null -- immature band forms, %
      WHEN itemid = 51144 and valuenum >   100 THEN null -- immature band forms, %
      WHEN itemid = 50882 and valuenum > 10000 THEN null -- mEq/L 'BICARBONATE'
      WHEN itemid = 50885 and valuenum >   150 THEN null -- mg/dL 'BILIRUBIN'
      WHEN itemid = 50806 and valuenum > 10000 THEN null -- mEq/L 'CHLORIDE'
      WHEN itemid = 50902 and valuenum > 10000 THEN null -- mEq/L 'CHLORIDE'
      WHEN itemid = 50912 and valuenum >   150 THEN null -- mg/dL 'CREATININE'
      WHEN itemid = 50809 and valuenum > 10000 THEN null -- mg/dL 'GLUCOSE'
      WHEN itemid = 50931 and valuenum > 10000 THEN null -- mg/dL 'GLUCOSE'
      WHEN itemid = 50810 and valuenum >   100 THEN null -- % 'HEMATOCRIT'
      WHEN itemid = 51221 and valuenum >   100 THEN null -- % 'HEMATOCRIT'
      WHEN itemid = 50811 and valuenum >    50 THEN null -- g/dL 'HEMOGLOBIN'
      WHEN itemid = 51222 and valuenum >    50 THEN null -- g/dL 'HEMOGLOBIN'
      WHEN itemid = 50813 and valuenum >    50 THEN null -- mmol/L 'LACTATE'
      WHEN itemid = 51265 and valuenum > 10000 THEN null -- K/uL 'PLATELET'
      WHEN itemid = 50822 and valuenum >    30 THEN null -- mEq/L 'POTASSIUM'
      WHEN itemid = 50971 and valuenum >    30 THEN null -- mEq/L 'POTASSIUM'
      WHEN itemid = 51275 and valuenum >   150 THEN null -- sec 'PTT'
      WHEN itemid = 51237 and valuenum >    50 THEN null -- 'INR'
      WHEN itemid = 51274 and valuenum >   150 THEN null -- sec 'PT'
      WHEN itemid = 50824 and valuenum >   200 THEN null -- mEq/L == mmol/L 'SODIUM'
      WHEN itemid = 50983 and valuenum >   200 THEN null -- mEq/L == mmol/L 'SODIUM'
      WHEN itemid = 51006 and valuenum >   300 THEN null -- 'BUN'
      WHEN itemid = 51300 and valuenum >  1000 THEN null -- 'WBC'
      WHEN itemid = 51301 and valuenum >  1000 THEN null -- 'WBC'
    ELSE valuenum
    END AS valuenum
  FROM labevents le
  WHERE le.ITEMID in
  (
    -- comment is: LABEL | CATEGORY | FLUID | NUMBER OF ROWS IN LABEVENTS
    50868, -- ANION GAP | CHEMISTRY | BLOOD | 769895
    50862, -- ALBUMIN | CHEMISTRY | BLOOD | 146697
    51144, -- BANDS - hematology
    50882, -- BICARBONATE | CHEMISTRY | BLOOD | 780733
    50885, -- BILIRUBIN, TOTAL | CHEMISTRY | BLOOD | 238277
    50912, -- CREATININE | CHEMISTRY | BLOOD | 797476
    50902, -- CHLORIDE | CHEMISTRY | BLOOD | 795568
    -- 50806, -- CHLORIDE, WHOLE BLOOD | BLOOD GAS | BLOOD | 48187
    50931, -- GLUCOSE | CHEMISTRY | BLOOD | 748981
    -- 50809, -- GLUCOSE | BLOOD GAS | BLOOD | 196734
    51221, -- HEMATOCRIT | HEMATOLOGY | BLOOD | 881846
    -- 50810, -- HEMATOCRIT, CALCULATED | BLOOD GAS | BLOOD | 89715
    51222, -- HEMOGLOBIN | HEMATOLOGY | BLOOD | 752523
    -- 50811, -- HEMOGLOBIN | BLOOD GAS | BLOOD | 89712
    50813, -- LACTATE | BLOOD GAS | BLOOD | 187124
    51265, -- PLATELET COUNT | HEMATOLOGY | BLOOD | 778444
    50971, -- POTASSIUM | CHEMISTRY | BLOOD | 845825
    -- 50822, -- POTASSIUM, WHOLE BLOOD | BLOOD GAS | BLOOD | 192946
    51275, -- PTT | HEMATOLOGY | BLOOD | 474937
    51237, -- INR(PT) | HEMATOLOGY | BLOOD | 471183
    51274, -- PT | HEMATOLOGY | BLOOD | 469090
    50983, -- SODIUM | CHEMISTRY | BLOOD | 808489
    -- 50824, -- SODIUM, WHOLE BLOOD | BLOOD GAS | BLOOD | 71503
    51006, -- UREA NITROGEN | CHEMISTRY | BLOOD | 791925
    51301, -- WHITE BLOOD CELLS | HEMATOLOGY | BLOOD | 753301
    51300  -- WBC COUNT | HEMATOLOGY | BLOOD | 2371
  )
  AND valuenum IS NOT NULL AND valuenum > 0 -- lab values cannot be 0 and cannot be negative
) pvt
GROUP BY pvt.subject_id, pvt.charttime
)
select
  iid.icustay_id, adm.hadm_id, le_avg.*
from le_avg
left join adm
  on le_avg.subject_id  = adm.subject_id
  and le_avg.charttime >= adm.data_start
  and le_avg.charttime  < adm.data_end
left join iid_assign iid
  on  le_avg.subject_id = iid.subject_id
  and le_avg.charttime >= iid.data_start
  and le_avg.charttime  < iid.data_end
order by le_avg.subject_id, le_avg.charttime
  );",109348,Thread-1,2022-07-18T00:10:48.981436Z
E017,,debug,SQL status: SELECT 0 in 0.1 seconds,109348,Thread-1,2022-07-18T00:10:49.077407Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_lab""",109348,Thread-1,2022-07-18T00:10:49.084585Z
E016,,debug,"On model.mimic.pivoted_lab: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_lab""} */
alter table ""postgres"".""public"".""pivoted_lab"" rename to ""pivoted_lab__dbt_backup""",109348,Thread-1,2022-07-18T00:10:49.085275Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:49.088320Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_lab""",109348,Thread-1,2022-07-18T00:10:49.092619Z
E016,,debug,"On model.mimic.pivoted_lab: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_lab""} */
alter table ""postgres"".""public"".""pivoted_lab__dbt_tmp"" rename to ""pivoted_lab""",109348,Thread-1,2022-07-18T00:10:49.092924Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:49.093703Z
E018,,debug,On model.mimic.pivoted_lab: COMMIT,109348,Thread-1,2022-07-18T00:10:49.096963Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_lab""",109348,Thread-1,2022-07-18T00:10:49.097207Z
E016,,debug,On model.mimic.pivoted_lab: COMMIT,109348,Thread-1,2022-07-18T00:10:49.097354Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:49.098492Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_lab""",109348,Thread-1,2022-07-18T00:10:49.101728Z
E016,,debug,"On model.mimic.pivoted_lab: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_lab""} */
drop table if exists ""postgres"".""public"".""pivoted_lab__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:49.102048Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:49.104229Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:49.107852Z
E010,,debug,On model.mimic.pivoted_lab: Close,109348,Thread-1,2022-07-18T00:10:49.108111Z
Q012,0,info,58 of 107 OK created table model public.pivoted_lab ............................ [[32mSELECT 0[0m in 0.15s],109348,Thread-1,2022-07-18T00:10:49.108665Z,table,null,pivoted_lab,pivot/pivoted_lab.sql,2022-07-18T00:10:48.957072,compiling,model,,,
Q024,0.14964509010314941,debug,Finished running node model.mimic.pivoted_lab,109348,Thread-1,2022-07-18T00:10:49.109019Z,table,2022-07-18T00:10:49.108926,pivoted_lab,pivot/pivoted_lab.sql,2022-07-18T00:10:48.957072,success,model,,,
Q023,,debug,Began running node model.mimic.pivoted_rrt,109348,Thread-1,2022-07-18T00:10:49.109361Z,table,null,pivoted_rrt,pivot/pivoted_rrt.sql,2022-07-18T00:10:49.109339,started,model,,,
Q033,,info,59 of 107 START table model public.pivoted_rrt ................................. [RUN],109348,Thread-1,2022-07-18T00:10:49.110305Z,table,null,pivoted_rrt,pivot/pivoted_rrt.sql,2022-07-18T00:10:49.109339,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.pivoted_rrt""",109348,Thread-1,2022-07-18T00:10:49.111083Z
Q030,,debug,Began compiling node model.mimic.pivoted_rrt,109348,Thread-1,2022-07-18T00:10:49.111320Z,table,null,pivoted_rrt,pivot/pivoted_rrt.sql,2022-07-18T00:10:49.109339,compiling,model,,,
Q027,,debug,Compiling model.mimic.pivoted_rrt,109348,Thread-1,2022-07-18T00:10:49.111634Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.pivoted_rrt""",109348,Thread-1,2022-07-18T00:10:49.113286Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:49.113922Z
Q031,,debug,Began executing node model.mimic.pivoted_rrt,109348,Thread-1,2022-07-18T00:10:49.114423Z,table,null,pivoted_rrt,pivot/pivoted_rrt.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.pivoted_rrt""",109348,Thread-1,2022-07-18T00:10:49.122524Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_rrt""",109348,Thread-1,2022-07-18T00:10:49.123196Z
E016,,debug,On model.mimic.pivoted_rrt: BEGIN,109348,Thread-1,2022-07-18T00:10:49.123466Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:49.123674Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:49.129044Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_rrt""",109348,Thread-1,2022-07-18T00:10:49.129350Z
E016,,debug,"On model.mimic.pivoted_rrt: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_rrt""} */


  create  table ""postgres"".""public"".""pivoted_rrt__dbt_tmp""
  as (
    -- Creates a table with icustay_id / time / dialysis type (if present)

with ce as
(
  select ce.icustay_id
    , ce.charttime
          -- when ce.itemid in (152,148,149,146,147,151,150) and value is not null then 1
          -- when ce.itemid in (229,235,241,247,253,259,265,271) and value = 'Dialysis Line' then 1
          -- when ce.itemid = 466 and value = 'Dialysis RN' then 1
          -- when ce.itemid = 927 and value = 'Dialysis Solutions' then 1
          -- when ce.itemid = 6250 and value = 'dialys' then 1
          -- when ce.
          -- when ce.itemid = 582 and value in ('CAVH Start','CAVH D/C','CVVHD Start','CVVHD D/C','Hemodialysis st','Hemodialysis end') then 1
    , CASE
        WHEN ce.itemid IN
        (
          146 -- ""Dialysate Flow ml/hr""
          , 147 -- ""Dialysate Infusing"";56605
          , 148 -- ""Dialysis Access Site"";60335
          , 149 -- ""Dialysis Access Type"";60030
          , 150 -- ""Dialysis Machine"";27472 (baxter or gambro)
          , 151 -- ""Dialysis Site Appear"";37345
          , 152 -- ""Dialysis Type"";61449
        ) THEN 1
        WHEN ce.itemid = 582 AND value IN 
        (
          'CAVH Start', 'CVVHD Start', 'Hemodialysis st',
          'CAVH D/C', 'CVVHD D/C', 'Hemodialysis end',
          'Peritoneal Dial'
        ) THEN 1
        WHEN ce.itemid IN (229, 235, 241, 247, 253, 259, 265, 271) AND value = 'Dialysis Line' 
          THEN 1
        -- WHEN ce.itemid = 917 AND value IN
        -- (
        --   '+ INITIATE DIALYSIS', 'BLEEDING FROM DIALYSIS CATHETER',
        --   -- 'FAILED DIALYSIS CATH.',
        --   'FEBRILE SYNDROME;DIALYSIS', 'HYPOTENSION WITH HEMODIALYSIS',
        --   'HYPOTENSION.GLOGGED DIALYSIS',
        --   'INFECTED DIALYSIS CATHETER'
        -- )
        -- metavision itemids

        -- checkboxes
        WHEN ce.itemid IN
        (
            226118 -- | Dialysis Catheter placed in outside facility      | Access Lines - Invasive | chartevents        | Checkbox
          , 227357 -- | Dialysis Catheter Dressing Occlusive              | Access Lines - Invasive | chartevents        | Checkbox
          , 225725 -- | Dialysis Catheter Tip Cultured                    | Access Lines - Invasive | chartevents        | Checkbox
        ) THEN 1
        -- numeric data
        WHEN ce.itemid IN
        (
            226499 -- | Hemodialysis Output                               | Dialysis
          , 224154 -- | Dialysate Rate                                    | Dialysis
          , 225810 -- | Dwell Time (Peritoneal Dialysis)                  | Dialysis
          , 225959 -- | Medication Added Amount  #1 (Peritoneal Dialysis) | Dialysis
          , 227639 -- | Medication Added Amount  #2 (Peritoneal Dialysis) | Dialysis
          , 225183 -- | Current Goal                     | Dialysis
          , 227438 -- | Volume not removed               | Dialysis
          , 224191 -- | Hourly Patient Fluid Removal     | Dialysis
          , 225806 -- | Volume In (PD)                   | Dialysis
          , 225807 -- | Volume Out (PD)                  | Dialysis
          , 228004 -- | Citrate (ACD-A)                  | Dialysis
          , 228005 -- | PBP (Prefilter) Replacement Rate | Dialysis
          , 228006 -- | Post Filter Replacement Rate     | Dialysis
          , 224144 -- | Blood Flow (ml/min)              | Dialysis
          , 224145 -- | Heparin Dose (per hour)          | Dialysis
          , 224149 -- | Access Pressure                  | Dialysis
          , 224150 -- | Filter Pressure                  | Dialysis
          , 224151 -- | Effluent Pressure                | Dialysis
          , 224152 -- | Return Pressure                  | Dialysis
          , 224153 -- | Replacement Rate                 | Dialysis
          , 224404 -- | ART Lumen Volume                 | Dialysis
          , 224406 -- | VEN Lumen Volume                 | Dialysis
          , 226457 -- | Ultrafiltrate Output             | Dialysis
        ) THEN 1

        -- text fields
        WHEN ce.itemid IN
        (
            224135 -- | Dialysis Access Site | Dialysis
          , 224139 -- | Dialysis Site Appearance | Dialysis
          , 224146 -- | System Integrity | Dialysis
          , 225323 -- | Dialysis Catheter Site Appear | Access Lines - Invasive
          , 225740 -- | Dialysis Catheter Discontinued | Access Lines - Invasive
          , 225776 -- | Dialysis Catheter Dressing Type | Access Lines - Invasive
          , 225951 -- | Peritoneal Dialysis Fluid Appearance | Dialysis
          , 225952 -- | Medication Added #1 (Peritoneal Dialysis) | Dialysis
          , 225953 -- | Solution (Peritoneal Dialysis) | Dialysis
          , 225954 -- | Dialysis Access Type | Dialysis
          , 225956 -- | Reason for CRRT Filter Change | Dialysis
          , 225958 -- | Heparin Concentration (units/mL) | Dialysis
          , 225961 -- | Medication Added Units #1 (Peritoneal Dialysis) | Dialysis
          , 225963 -- | Peritoneal Dialysis Catheter Type | Dialysis
          , 225965 -- | Peritoneal Dialysis Catheter Status | Dialysis
          , 225976 -- | Replacement Fluid | Dialysis
          , 225977 -- | Dialysate Fluid | Dialysis
          , 227124 -- | Dialysis Catheter Type | Access Lines - Invasive
          , 227290 -- | CRRT mode | Dialysis
          , 227638 -- | Medication Added #2 (Peritoneal Dialysis) | Dialysis
          , 227640 -- | Medication Added Units #2 (Peritoneal Dialysis) | Dialysis
          , 227753 -- | Dialysis Catheter Placement Confirmed by X-ray | Access Lines - Invasive
        ) THEN 1
      ELSE 0 END
      AS dialysis_present
    , CASE
        WHEN ce.itemid = 582 AND value IN 
        (
          'CAVH Start', 'CVVHD Start', 'Hemodialysis st',
          'Peritoneal Dial'
        ) THEN 1
        WHEN ce.itemid = 582 AND value IN 
        (
          'CAVH D/C', 'CVVHD D/C', 'Hemodialysis end'
        ) THEN 0
        WHEN ce.itemid = 147 AND value = 'Yes' THEN 1 -- ""Dialysate Infusing"";56605
        WHEN ce.itemid = 225965 -- Peritoneal Dialysis Catheter Status
          AND value = 'In use' THEN 1
        WHEN ce.itemid IN
        (
            146    -- Dialysate Flow ml/hr
          , 226499 -- | Hemodialysis Output              | Dialysis
          , 224154 -- | Dialysate Rate                   | Dialysis
          , 225183 -- | Current Goal                     | Dialysis
          , 227438 -- | Volume not removed               | Dialysis
          , 224191 -- | Hourly Patient Fluid Removal     | Dialysis
          , 225806 -- | Volume In (PD)                   | Dialysis
          , 225807 -- | Volume Out (PD)                  | Dialysis
          , 228004 -- | Citrate (ACD-A)                  | Dialysis
          , 228005 -- | PBP (Prefilter) Replacement Rate | Dialysis
          , 228006 -- | Post Filter Replacement Rate     | Dialysis
          , 224144 -- | Blood Flow (ml/min)              | Dialysis
          , 224145 -- | Heparin Dose (per hour)          | Dialysis
          , 224153 -- | Replacement Rate                 | Dialysis
          , 226457 -- | Ultrafiltrate Output             | Dialysis
        ) THEN 1
      ELSE 0 END
      AS dialysis_active
    , CASE
        -- dialysis mode
        WHEN ce.itemid in (152, 227290) THEN
          CASE
            WHEN value = 'CVVH' THEN 'CVVH'
            WHEN value = 'CVVHD' THEN 'CVVHD'
            WHEN value = 'CVVHDF' THEN 'CVVHDF'
            WHEN value = 'SCUF' THEN 'SCUF'
            WHEN value = 'Peritoneal' THEN 'Peritoneal'
          END
        -- itemids which imply a certain dialysis mode

        -- peritoneal dialysis
        WHEN ce.itemid IN 
        (
            225810 -- | Dwell Time (Peritoneal Dialysis) | Dialysis
          , 225806 -- | Volume In (PD)                   | Dialysis
          , 225807 -- | Volume Out (PD)                  | Dialysis
          , 225810 -- | Dwell Time (Peritoneal Dialysis)                  | Dialysis
          , 227639 -- | Medication Added Amount  #2 (Peritoneal Dialysis) | Dialysis
          , 225959 -- | Medication Added Amount  #1 (Peritoneal Dialysis) | Dialysis
          , 225951 -- | Peritoneal Dialysis Fluid Appearance | Dialysis
          , 225952 -- | Medication Added #1 (Peritoneal Dialysis) | Dialysis
          , 225961 -- | Medication Added Units #1 (Peritoneal Dialysis) | Dialysis
          , 225953 -- | Solution (Peritoneal Dialysis) | Dialysis
          , 225963 -- | Peritoneal Dialysis Catheter Type | Dialysis
          , 225965 -- | Peritoneal Dialysis Catheter Status | Dialysis
          , 227638 -- | Medication Added #2 (Peritoneal Dialysis) | Dialysis
          , 227640 -- | Medication Added Units #2 (Peritoneal Dialysis) | Dialysis
        )
          THEN 'Peritoneal'
        WHEN ce.itemid IN (226499)
          THEN 'IHD'
        WHEN ce.itemid = 582 THEN
          CASE
            WHEN value IN ('CAVH Start','CAVH D/C')
              THEN 'CAVH'
            WHEN value IN ('CVVHD Start','CVVHD D/C')
              THEN 'CVVHD'
            WHEN value IN ('Hemodialysis st', 'Hemodialysis end')
              -- null is ambiguous
              THEN NULL
          ELSE NULL
          END
      ELSE NULL END as dialysis_type
  from chartevents ce
  WHERE ce.itemid in
  (
     152 -- ""Dialysis Type"";61449
    ,146 -- ""Dialysate Flow ml/hr"";57445
    ,147 -- ""Dialysate Infusing"";56605
    ,148 -- ""Dialysis Access Site"";60335
    ,149 -- ""Dialysis Access Type"";60030
    ,150 -- ""Dialysis Machine"";27472 (baxter or gambro)
    ,151 -- ""Dialysis Site Appear"";37345
    ,582 -- Procedures
    -- below indicate existence of a dialysis line
    ,229 -- INV Line#1 [Type]
    ,235 -- INV Line#2 [Type]
    ,241 -- INV Line#3 [Type]
    ,247 -- INV Line#4 [Type]
    ,253 -- INV Line#5 [Type]
    ,259 -- INV Line#6 [Type]
    ,265 -- INV Line#7 [Type]
    ,271 -- INV Line#8 [Type]
    
    -- dialysis consults can't be 100% guaranteed to be active
    -- ,466 -- Nursing Consultation
    -- diagnosis has 6 or 7 dx related to dialysis, probably not worth including
    -- as the chart time isn't going to match the start time of dialysis
    -- , 917 -- Diagnosis/op
    -- ,7949 -- ""Calcium for CVVH"" - only has 2 null values
    
    -- === MetaVision itemids === --
  
    -- Checkboxes
    , 226118 -- | Dialysis Catheter placed in outside facility      | Access Lines - Invasive | chartevents        | Checkbox
    , 227357 -- | Dialysis Catheter Dressing Occlusive              | Access Lines - Invasive | chartevents        | Checkbox
    , 225725 -- | Dialysis Catheter Tip Cultured                    | Access Lines - Invasive | chartevents        | Checkbox

    -- Numeric values
    , 226499 -- | Hemodialysis Output                               | Dialysis                | chartevents        | Numeric
    , 224154 -- | Dialysate Rate                                    | Dialysis                | chartevents        | Numeric
    , 225810 -- | Dwell Time (Peritoneal Dialysis)                  | Dialysis                | chartevents        | Numeric
    , 227639 -- | Medication Added Amount  #2 (Peritoneal Dialysis) | Dialysis                | chartevents        | Numeric
    , 225183 -- | Current Goal                     | Dialysis | chartevents        | Numeric
    , 227438 -- | Volume not removed               | Dialysis | chartevents        | Numeric
    , 224191 -- | Hourly Patient Fluid Removal     | Dialysis | chartevents        | Numeric
    , 225806 -- | Volume In (PD)                   | Dialysis | chartevents        | Numeric
    , 225807 -- | Volume Out (PD)                  | Dialysis | chartevents        | Numeric
    , 228004 -- | Citrate (ACD-A)                  | Dialysis | chartevents        | Numeric
    , 228005 -- | PBP (Prefilter) Replacement Rate | Dialysis | chartevents        | Numeric
    , 228006 -- | Post Filter Replacement Rate     | Dialysis | chartevents        | Numeric
    , 224144 -- | Blood Flow (ml/min)              | Dialysis | chartevents        | Numeric
    , 224145 -- | Heparin Dose (per hour)          | Dialysis | chartevents        | Numeric
    , 224149 -- | Access Pressure                  | Dialysis | chartevents        | Numeric
    , 224150 -- | Filter Pressure                  | Dialysis | chartevents        | Numeric
    , 224151 -- | Effluent Pressure                | Dialysis | chartevents        | Numeric
    , 224152 -- | Return Pressure                  | Dialysis | chartevents        | Numeric
    , 224153 -- | Replacement Rate                 | Dialysis | chartevents        | Numeric
    , 224404 -- | ART Lumen Volume                 | Dialysis | chartevents        | Numeric
    , 224406 -- | VEN Lumen Volume                 | Dialysis | chartevents        | Numeric
    , 226457 -- | Ultrafiltrate Output             | Dialysis | chartevents        | Numeric
    , 225959 -- | Medication Added Amount  #1 (Peritoneal Dialysis) | Dialysis | chartevents | Numeric
    -- Text values
    , 224135 -- | Dialysis Access Site | Dialysis | chartevents | Text
    , 224139 -- | Dialysis Site Appearance | Dialysis | chartevents | Text
    , 224146 -- | System Integrity | Dialysis | chartevents | Text
    , 225323 -- | Dialysis Catheter Site Appear | Access Lines - Invasive | chartevents | Text
    , 225740 -- | Dialysis Catheter Discontinued | Access Lines - Invasive | chartevents | Text
    , 225776 -- | Dialysis Catheter Dressing Type | Access Lines - Invasive | chartevents | Text
    , 225951 -- | Peritoneal Dialysis Fluid Appearance | Dialysis | chartevents | Text
    , 225952 -- | Medication Added #1 (Peritoneal Dialysis) | Dialysis | chartevents | Text
    , 225953 -- | Solution (Peritoneal Dialysis) | Dialysis | chartevents | Text
    , 225954 -- | Dialysis Access Type | Dialysis | chartevents | Text
    , 225956 -- | Reason for CRRT Filter Change | Dialysis | chartevents | Text
    , 225958 -- | Heparin Concentration (units/mL) | Dialysis | chartevents | Text
    , 225961 -- | Medication Added Units #1 (Peritoneal Dialysis) | Dialysis | chartevents | Text
    , 225963 -- | Peritoneal Dialysis Catheter Type | Dialysis | chartevents | Text
    , 225965 -- | Peritoneal Dialysis Catheter Status | Dialysis | chartevents | Text
    , 225976 -- | Replacement Fluid | Dialysis | chartevents | Text
    , 225977 -- | Dialysate Fluid | Dialysis | chartevents | Text
    , 227124 -- | Dialysis Catheter Type | Access Lines - Invasive | chartevents | Text
    , 227290 -- | CRRT mode | Dialysis | chartevents | Text
    , 227638 -- | Medication Added #2 (Peritoneal Dialysis) | Dialysis | chartevents | Text
    , 227640 -- | Medication Added Units #2 (Peritoneal Dialysis) | Dialysis | chartevents | Text
    , 227753 -- | Dialysis Catheter Placement Confirmed by X-ray | Access Lines - Invasive | chartevents | Text
  )
  AND ce.value IS NOT NULL
  AND ce.icustay_id IS NOT NULL
  -- exclude rows marked as error
  and COALESCE(ce.error, 0) = 0
)

-- TODO:
--   charttime + dialysis_present + dialysis_active
--  for inputevents_cv, outputevents
--  for procedures_mv, left join and set the dialysis_type
, cv_ie as
(
  select icustay_id
    , charttime
    , 1 AS dialysis_present
    , CASE
        WHEN itemid NOT IN
        (
          44954 -- OR CVVHDF |  | inputevents_cv
        ) THEN 1
      ELSE 0 END AS dialysis_active
    , CASE
        WHEN itemid IN
        (
            40788 -- PD dialysate in | Free Form Intake | inputevents_cv
          , 41063 -- PD Dialysate Intake | Free Form Intake | inputevents_cv
          , 41307 -- Peritoneal Dialysate | Free Form Intake | inputevents_cv
          , 43829 -- PERITONEAL DIALYSATE | Free Form Intake | inputevents_cv
          , 44698 -- peritoneal dialysate | Free Form Intake | inputevents_cv
          , 46720 -- PD Dialysate | Free Form Intake | inputevents_cv
        ) THEN 'Peritoneal'
        WHEN itemid IN
        (
            45352 -- CA GLUC for CVVH | Free Form Intake | inputevents_cv
          , 45353 -- KCL for CVVH | Free Form Intake | inputevents_cv
        ) THEN 'CVVH'
        WHEN itemid IN
        (
            45268 -- CALCIUM FOR CVVHD | Free Form Intake | inputevents_cv
          , 46769 -- cvvdh rescue line | Free Form Intake | inputevents_cv
          , 46773 -- CVVHD NS line flush | Free Form Intake | inputevents_cv
        ) THEN 'CVVHD'
        WHEN itemid IN
        (
            46012 -- CA GLUC CVVHDF | Free Form Intake | inputevents_cv
          , 46013 -- KCL CVVHDF | Free Form Intake | inputevents_cv
          , 46172 -- CVVHDF CA GLUC | Free Form Intake | inputevents_cv
          , 46173 -- CVVHDF KCL | Free Form Intake | inputevents_cv
        ) THEN 'CVVHDF'
      ELSE NULL END AS dialysis_type
  from inputevents_cv
  where itemid in
  (
        40788 -- PD dialysate in | Free Form Intake | inputevents_cv
      , 40907 -- dialysate | Free Form Intake | inputevents_cv
      , 41063 -- PD Dialysate Intake | Free Form Intake | inputevents_cv
      , 41147 -- Dialysate instilled | Free Form Intake | inputevents_cv
      , 41307 -- Peritoneal Dialysate | Free Form Intake | inputevents_cv
      , 41460 -- capd dialysate | Free Form Intake | inputevents_cv
      , 41620 -- dialysate in | Free Form Intake | inputevents_cv
      , 41711 -- CAPD dialysate dwell | Free Form Intake | inputevents_cv
      , 41791 -- 2.5% dialysate in | Free Form Intake | inputevents_cv
      , 41792 -- 1.5% dialysate | Free Form Intake | inputevents_cv
      , 42562 -- pos. dialysate intak | Free Form Intake | inputevents_cv
      , 43829 -- PERITONEAL DIALYSATE | Free Form Intake | inputevents_cv
      , 44037 -- Dialysate Instilled | Free Form Intake | inputevents_cv
      , 44188 -- rep.+dialysate | Free Form Intake | inputevents_cv
      , 44526 -- dialysate 1.5% dex | Free Form Intake | inputevents_cv
      , 44527 -- dialysate 2.5% | Free Form Intake | inputevents_cv
      , 44584 -- Dialysate IN | Free Form Intake | inputevents_cv
      , 44591 -- dialysate 4.25% | Free Form Intake | inputevents_cv
      , 44698 -- peritoneal dialysate | Free Form Intake | inputevents_cv
      , 44927 -- CRRT HEPARIN | Free Form Intake | inputevents_cv
      , 44954 -- OR CVVHDF |  | inputevents_cv
      , 45157 -- ca+ gtt for cvvh | Free Form Intake | inputevents_cv
      , 45268 -- CALCIUM FOR CVVHD | Free Form Intake | inputevents_cv
      , 45352 -- CA GLUC for CVVH | Free Form Intake | inputevents_cv
      , 45353 -- KCL for CVVH | Free Form Intake | inputevents_cv
      , 46012 -- CA GLUC CVVHDF | Free Form Intake | inputevents_cv
      , 46013 -- KCL CVVHDF | Free Form Intake | inputevents_cv
      , 46172 -- CVVHDF CA GLUC | Free Form Intake | inputevents_cv
      , 46173 -- CVVHDF KCL | Free Form Intake | inputevents_cv
      , 46250 -- EBL  CVVH |  | inputevents_cv
      , 46262 -- dialysate 2.5% in | Free Form Intake | inputevents_cv
      , 46292 -- CRRT Irrigation | Free Form Intake | inputevents_cv
      , 46293 -- CRRT Citrate | Free Form Intake | inputevents_cv
      , 46311 -- crrt irrigation | Free Form Intake | inputevents_cv
      , 46389 -- CRRT FLUSH | Free Form Intake | inputevents_cv
      , 46574 -- CRRT rescue line NS | Free Form Intake | inputevents_cv
      , 46681 -- CRRT Rescue Flush | Free Form Intake | inputevents_cv
      , 46720 -- PD Dialysate | Free Form Intake | inputevents_cv
      , 46769 -- cvvdh rescue line | Free Form Intake | inputevents_cv
      , 46773 -- CVVHD NS line flush | Free Form Intake | inputevents_cv
  )
  and amount > 0 -- also ensures it's not null
)
, oe as
(
 select icustay_id
    , charttime
    , 1 AS dialysis_present
    , CASE
        WHEN itemid NOT IN
        (
          41897 -- CVVH OUTPUT FROM OR
        ) THEN 1
      ELSE 0 END AS dialysis_active
    , CASE
        WHEN itemid IN
        (
          40789 -- PD dialysate out
        , 40910 -- PERITONEAL DIALYSIS
        , 41069 -- PD Dialysate Output
        , 44843 -- peritoneal dialysis
        , 46394 -- Peritoneal dialysis
        ) THEN 'Peritoneal'
      ELSE NULL END AS dialysis_type
 from outputevents
 where itemid in
 (
       40386 -- hemodialysis
     , 40425 -- dialysis output
     , 40426 -- dialysis out
     , 40507 -- Dialysis out
     , 40613 -- DIALYSIS OUT
     , 40624 -- dialysis
     , 40690 -- DIALYSIS
     , 40745 -- Dialysis
     , 40789 -- PD dialysate out
     , 40881 -- Hemodialysis
     , 40910 -- PERITONEAL DIALYSIS
     , 41016 -- hemodialysis out
     , 41034 -- dialysis in
     , 41069 -- PD Dialysate Output
     , 41112 -- Dialysys out
     , 41250 -- HEMODIALYSIS OUT
     , 41374 -- Dialysis Out
     , 41417 -- Hemodialysis Out
     , 41500 -- hemodialysis output
     , 41527 -- HEMODIALYSIS
     , 41623 -- dialysate out
     , 41635 -- Hemodialysis removal
     , 41713 -- dialyslate out
     , 41750 -- dialysis  out
     , 41829 -- HEMODIALYSIS OUTPUT
     , 41842 -- Dialysis Output.
     , 41897 -- CVVH OUTPUT FROM OR
     , 42289 -- dialysis off
     , 42388 -- DIALYSIS OUTPUT
     , 42464 -- hemodialysis ultrafe
     , 42524 -- HemoDialysis
     , 42536 -- Dialysis output
     , 42868 -- hemodialysis off
     , 42928 -- HEMODIALYSIS.
     , 42972 -- HEMODIALYSIS OFF
     , 43016 -- DIALYSIS TOTAL OUT
     , 43052 -- DIALYSIS REMOVED
     , 43098 -- hemodialysis crystal
     , 43115 -- dialysis net
     , 43687 -- crystalloid/dialysis
     , 43941 -- dialysis/intake
     , 44027 -- dialysis fluid off
     , 44085 -- DIALYSIS OFF
     , 44193 -- Dialysis.
     , 44199 -- HEMODIALYSIS O/P
     , 44216 -- Hemodialysis out
     , 44286 -- Dialysis indwelling
     , 44567 -- Hemodialysis.
     , 44843 -- peritoneal dialysis
     , 44845 -- Dialysis fluids
     , 44857 -- dialysis- fluid off
     , 44901 -- Dialysis Removed
     , 44943 -- fluid removed dialys
     , 45479 -- Dialysis In
     , 45828 -- Hemo dialysis out
     , 46230 -- Dialysis 1.5% IN
     , 46232 -- dialysis flush
     , 46394 -- Peritoneal dialysis
     , 46464 -- Hemodialysis OUT
     , 46712 -- CALCIUM-DIALYSIS
     , 46713 -- KCL-10 MEQ-DIALYSIS
     , 46715 -- Citrate - dialysis
     , 46741 -- dialysis removed
 )
 and value > 0 -- also ensures it's not null
)
, mv_ranges as
(
  select icustay_id
    , starttime, endtime
    , 1 AS dialysis_present
    , 1 AS dialysis_active
    , 'CRRT' as dialysis_type
  from inputevents_mv
  where itemid in
  (
      227536 --	KCl (CRRT)	Medications	inputevents_mv	Solution
    , 227525 --	Calcium Gluconate (CRRT)	Medications	inputevents_mv	Solution
  )
  and amount > 0 -- also ensures it's not null
  UNION DISTINCT
  select icustay_id
    , starttime, endtime
    , 1 AS dialysis_present
    , CASE WHEN itemid NOT IN (224270, 225436) THEN 1 ELSE 0 END AS dialysis_active
    , CASE
        WHEN itemid = 225441 THEN 'IHD'
        WHEN itemid = 225802 THEN 'CRRT'  -- CVVH (Continuous venovenous hemofiltration)
        WHEN itemid = 225803 THEN 'CVVHD' -- CVVHD (Continuous venovenous hemodialysis)
        WHEN itemid = 225805 THEN 'Peritoneal'
        WHEN itemid = 225809 THEN 'CVVHDF' -- CVVHDF (Continuous venovenous hemodiafiltration)
        WHEN itemid = 225955 THEN 'SCUF' -- SCUF (Slow continuous ultra filtration)
      ELSE NULL END as dialysis_type
  from procedureevents_mv
  where itemid in
  (
      225441 -- | Hemodialysis          | 4-Procedures              | procedureevents_mv | Process
    , 225802 -- | Dialysis - CRRT       | Dialysis                  | procedureevents_mv | Process
    , 225803 -- | Dialysis - CVVHD      | Dialysis                  | procedureevents_mv | Process
    , 225805 -- | Peritoneal Dialysis   | Dialysis                  | procedureevents_mv | Process
    , 224270 -- | Dialysis Catheter     | Access Lines - Invasive   | procedureevents_mv | Process
    , 225809 -- | Dialysis - CVVHDF     | Dialysis                  | procedureevents_mv | Process
    , 225955 -- | Dialysis - SCUF       | Dialysis                  | procedureevents_mv | Process
    , 225436 -- | CRRT Filter Change    | Dialysis                  | procedureevents_mv | Process
  )
  AND value IS NOT NULL
)
-- union together the charttime tables; append times from mv_ranges to guarantee they exist
, stg0 AS
(
  SELECT
    icustay_id, charttime, dialysis_present, dialysis_active, dialysis_type
  FROM ce
  WHERE dialysis_present = 1
  UNION DISTINCT
  SELECT
    icustay_id, charttime, dialysis_present, dialysis_active, dialysis_type
  FROM cv_ie
  WHERE dialysis_present = 1
  UNION DISTINCT
  SELECT
    icustay_id, charttime, dialysis_present, dialysis_active, dialysis_type
  FROM oe
  WHERE dialysis_present = 1
  UNION DISTINCT
  SELECT
    icustay_id, starttime AS charttime, dialysis_present, dialysis_active, dialysis_type
  FROM mv_ranges
  UNION DISTINCT
  SELECT
    icustay_id, endtime AS charttime, dialysis_present, dialysis_active, dialysis_type
  FROM mv_ranges
)
SELECT
    stg0.icustay_id
    , charttime
    , COALESCE(mv.dialysis_present, stg0.dialysis_present) AS dialysis_present
    , COALESCE(mv.dialysis_active, stg0.dialysis_active) AS dialysis_active
    , COALESCE(mv.dialysis_type, stg0.dialysis_type) AS dialysis_type
FROM stg0
LEFT JOIN mv_ranges mv
  ON stg0.icustay_id = mv.icustay_id
  AND stg0.charttime >= mv.starttime
  AND stg0.charttime <= mv.endtime
WHERE stg0.icustay_id IS NOT NULL
ORDER BY 1,2
  );",109348,Thread-1,2022-07-18T00:10:49.129495Z
E017,,debug,SQL status: SELECT 301513 in 3.13 seconds,109348,Thread-1,2022-07-18T00:10:52.264246Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_rrt""",109348,Thread-1,2022-07-18T00:10:52.268320Z
E016,,debug,"On model.mimic.pivoted_rrt: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_rrt""} */
alter table ""postgres"".""public"".""pivoted_rrt"" rename to ""pivoted_rrt__dbt_backup""",109348,Thread-1,2022-07-18T00:10:52.268685Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:52.269508Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_rrt""",109348,Thread-1,2022-07-18T00:10:52.273014Z
E016,,debug,"On model.mimic.pivoted_rrt: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_rrt""} */
alter table ""postgres"".""public"".""pivoted_rrt__dbt_tmp"" rename to ""pivoted_rrt""",109348,Thread-1,2022-07-18T00:10:52.273219Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:52.273971Z
E018,,debug,On model.mimic.pivoted_rrt: COMMIT,109348,Thread-1,2022-07-18T00:10:52.276822Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_rrt""",109348,Thread-1,2022-07-18T00:10:52.277048Z
E016,,debug,On model.mimic.pivoted_rrt: COMMIT,109348,Thread-1,2022-07-18T00:10:52.277171Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:52.280851Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_rrt""",109348,Thread-1,2022-07-18T00:10:52.283033Z
E016,,debug,"On model.mimic.pivoted_rrt: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_rrt""} */
drop table if exists ""postgres"".""public"".""pivoted_rrt__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:52.283271Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:52.285327Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:52.288340Z
E010,,debug,On model.mimic.pivoted_rrt: Close,109348,Thread-1,2022-07-18T00:10:52.288686Z
Q012,3,info,59 of 107 OK created table model public.pivoted_rrt ............................ [[32mSELECT 301513[0m in 3.18s],109348,Thread-1,2022-07-18T00:10:52.289886Z,table,null,pivoted_rrt,pivot/pivoted_rrt.sql,2022-07-18T00:10:49.109339,compiling,model,,,
Q024,3.1787326335906982,debug,Finished running node model.mimic.pivoted_rrt,109348,Thread-1,2022-07-18T00:10:52.290690Z,table,2022-07-18T00:10:52.290481,pivoted_rrt,pivot/pivoted_rrt.sql,2022-07-18T00:10:49.109339,success,model,,,
Q023,,debug,Began running node model.mimic.pivoted_sofa,109348,Thread-1,2022-07-18T00:10:52.291536Z,table,null,pivoted_sofa,pivot/pivoted_sofa.sql,2022-07-18T00:10:52.291432,started,model,,,
Q033,,info,60 of 107 START table model public.pivoted_sofa ................................ [RUN],109348,Thread-1,2022-07-18T00:10:52.292371Z,table,null,pivoted_sofa,pivot/pivoted_sofa.sql,2022-07-18T00:10:52.291432,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.pivoted_sofa""",109348,Thread-1,2022-07-18T00:10:52.293445Z
Q030,,debug,Began compiling node model.mimic.pivoted_sofa,109348,Thread-1,2022-07-18T00:10:52.293903Z,table,null,pivoted_sofa,pivot/pivoted_sofa.sql,2022-07-18T00:10:52.291432,compiling,model,,,
Q027,,debug,Compiling model.mimic.pivoted_sofa,109348,Thread-1,2022-07-18T00:10:52.294379Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.pivoted_sofa""",109348,Thread-1,2022-07-18T00:10:52.296324Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:52.297494Z
Q031,,debug,Began executing node model.mimic.pivoted_sofa,109348,Thread-1,2022-07-18T00:10:52.298009Z,table,null,pivoted_sofa,pivot/pivoted_sofa.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.pivoted_sofa""",109348,Thread-1,2022-07-18T00:10:52.311044Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_sofa""",109348,Thread-1,2022-07-18T00:10:52.311814Z
E016,,debug,On model.mimic.pivoted_sofa: BEGIN,109348,Thread-1,2022-07-18T00:10:52.312096Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:52.312319Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:52.320646Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_sofa""",109348,Thread-1,2022-07-18T00:10:52.320940Z
E016,,debug,"On model.mimic.pivoted_sofa: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_sofa""} */


  create  table ""postgres"".""public"".""pivoted_sofa__dbt_tmp""
  as (
    ﻿with co as
(
  select ih.icustay_id, ie.hadm_id
  , hr
  -- start/endtime can be used to filter to values within this hour
  , DATETIME_SUB(ih.endtime, INTERVAL '1' HOUR) AS starttime
  , ih.endtime
  from icustay_hours ih
  INNER JOIN icustays ie
    ON ih.icustay_id = ie.icustay_id
)
-- get minimum blood pressure FROM chartevents
, bp as
(
  select ce.icustay_id
    , ce.charttime
    , min(valuenum) as meanbp_min
  FROM chartevents ce
  -- exclude rows marked as error
  where (ce.error IS NULL OR ce.error != 1)
  and ce.itemid in
  (
  -- MEAN ARTERIAL PRESSURE
  456, --""NBP Mean""
  52, --""Arterial BP Mean""
  6702, --	Arterial BP Mean #2
  443, --	Manual BP Mean(calc)
  220052, --""Arterial Blood Pressure mean""
  220181, --""Non Invasive Blood Pressure mean""
  225312  --""ART BP mean""
  )
  and valuenum > 0 and valuenum < 300
  group by ce.icustay_id, ce.charttime
)
, pafi as
(
  -- join blood gas to ventilation durations to determine if patient was vent
  select ie.icustay_id
  , bg.charttime
  -- because pafi has an interaction between vent/PaO2:FiO2, we need two columns for the score
  -- it can happen that the lowest unventilated PaO2/FiO2 is 68, but the lowest ventilated PaO2/FiO2 is 120
  -- in this case, the SOFA score is 3, *not* 4.
  , case when vd.icustay_id is null then pao2fio2ratio else null end pao2fio2ratio_novent
  , case when vd.icustay_id is not null then pao2fio2ratio else null end pao2fio2ratio_vent
  FROM icustays ie
  inner join pivoted_bg_art bg
    on ie.icustay_id = bg.icustay_id
  left join ventilation_durations vd
    on ie.icustay_id = vd.icustay_id
    and bg.charttime >= vd.starttime
    and bg.charttime <= vd.endtime
)
, mini_agg as
(
  select co.icustay_id, co.hr
  -- vitals
  , min(bp.meanbp_min) as meanbp_min
  -- gcs
  , min(gcs.GCS) as GCS_min
  -- labs
  , max(labs.bilirubin) as bilirubin_max
  , max(labs.creatinine) as creatinine_max
  , min(labs.platelet) as platelet_min
  -- because pafi has an interaction between vent/PaO2:FiO2, we need two columns for the score
  -- it can happen that the lowest unventilated PaO2/FiO2 is 68, but the lowest ventilated PaO2/FiO2 is 120
  -- in this case, the SOFA score is 3, *not* 4.
  , min(case when vd.icustay_id is null then pao2fio2ratio else null end) AS pao2fio2ratio_novent
  , min(case when vd.icustay_id is not null then pao2fio2ratio else null end) AS pao2fio2ratio_vent
  from co
  left join bp
    on co.icustay_id = bp.icustay_id
    and co.starttime < bp.charttime
    and co.endtime >= bp.charttime
  left join pivoted_gcs gcs
    on co.icustay_id = gcs.icustay_id
    and co.starttime < gcs.charttime
    and co.endtime >= gcs.charttime
  left join pivoted_lab labs
    on co.hadm_id = labs.hadm_id
    and co.starttime < labs.charttime
    and co.endtime >= labs.charttime
  -- bring in blood gases that occurred during this hour
  left join pivoted_bg_art bg
    on co.icustay_id = bg.icustay_id
    and co.starttime < bg.charttime
    and co.endtime >= bg.charttime
  -- at the time of the blood gas, determine if patient was ventilated
  left join ventilation_durations vd
    on co.icustay_id = vd.icustay_id
    and bg.charttime >= vd.starttime
    and bg.charttime <= vd.endtime
  group by co.icustay_id, co.hr
)
-- sum uo separately to prevent duplicating values
, uo as
(
  select co.icustay_id, co.hr
  -- uo
  , sum(uo.urineoutput) as urineoutput
  from co
  left join pivoted_uo uo
    on co.icustay_id = uo.icustay_id
    and co.starttime < uo.charttime
    and co.endtime >= uo.charttime
  group by co.icustay_id, co.hr
)
, scorecomp as
(
  select
      co.icustay_id
    , co.hr
    , co.starttime, co.endtime
    , ma.pao2fio2ratio_novent
    , ma.pao2fio2ratio_vent
    , epi.vaso_rate as rate_epinephrine
    , nor.vaso_rate as rate_norepinephrine
    , dop.vaso_rate as rate_dopamine
    , dob.vaso_rate as rate_dobutamine
    , ma.meanbp_min
    , ma.GCS_min
    -- uo
    , uo.urineoutput
    -- labs
    , ma.bilirubin_max
    , ma.creatinine_max
    , ma.platelet_min
  from co
  left join mini_agg ma
    on co.icustay_id = ma.icustay_id
    and co.hr = ma.hr
  left join uo
    on co.icustay_id = uo.icustay_id
    and co.hr = uo.hr
  left join pafi
    on co.icustay_id = pafi.icustay_id
    and co.starttime < pafi.charttime
    and co.endtime  >= pafi.charttime
  left join epinephrine_dose epi
    on co.icustay_id = epi.icustay_id
    and co.endtime > epi.starttime
    and co.endtime <= epi.endtime
  left join norepinephrine_dose nor
    on co.icustay_id = nor.icustay_id
    and co.endtime > nor.starttime
    and co.endtime <= nor.endtime
  left join dopamine_dose dop
    on co.icustay_id = dop.icustay_id
    and co.endtime > dop.starttime
    and co.endtime <= dop.endtime
  left join dobutamine_dose dob
    on co.icustay_id = dob.icustay_id
    and co.endtime > dob.starttime
    and co.endtime <= dob.endtime
)
, scorecalc as
(
  -- Calculate the final score
  -- note that if the underlying data is missing, the component is null
  -- eventually these are treated as 0 (normal), but knowing when data is missing is useful for debugging
  select scorecomp.*
  -- Respiration
  , cast(case
      when pao2fio2ratio_vent   < 100 then 4
      when pao2fio2ratio_vent   < 200 then 3
      when pao2fio2ratio_novent < 300 then 2
      when pao2fio2ratio_novent < 400 then 1
      when coalesce(pao2fio2ratio_vent, pao2fio2ratio_novent) is null then null
      else 0
    end as SMALLINT) as respiration

  -- Coagulation
  , cast(case
      when platelet_min < 20  then 4
      when platelet_min < 50  then 3
      when platelet_min < 100 then 2
      when platelet_min < 150 then 1
      when platelet_min is null then null
      else 0
    end as SMALLINT) as coagulation

  -- Liver
  , cast(case
      -- Bilirubin checks in mg/dL
        when Bilirubin_Max >= 12.0 then 4
        when Bilirubin_Max >= 6.0  then 3
        when Bilirubin_Max >= 2.0  then 2
        when Bilirubin_Max >= 1.2  then 1
        when Bilirubin_Max is null then null
        else 0
      end as SMALLINT) as liver

  -- Cardiovascular
  , cast(case
      when rate_dopamine > 15 or rate_epinephrine >  0.1 or rate_norepinephrine >  0.1 then 4
      when rate_dopamine >  5 or rate_epinephrine <= 0.1 or rate_norepinephrine <= 0.1 then 3
      when rate_dopamine >  0 or rate_dobutamine > 0 then 2
      when meanbp_min < 70 then 1
      when coalesce(meanbp_min, rate_dopamine, rate_dobutamine, rate_epinephrine, rate_norepinephrine) is null then null
      else 0
    end as SMALLINT) as cardiovascular

  -- Neurological failure (GCS)
  , cast(case
      when (GCS_min >= 13 and GCS_min <= 14) then 1
      when (GCS_min >= 10 and GCS_min <= 12) then 2
      when (GCS_min >=  6 and GCS_min <=  9) then 3
      when  GCS_min <   6 then 4
      when  GCS_min is null then null
  else 0 end as SMALLINT)
    as cns

  -- Renal failure - high creatinine or low urine output
  , cast(case
    when (Creatinine_Max >= 5.0) then 4
    when
      SUM(urineoutput) OVER W < 200
        then 4
    when (Creatinine_Max >= 3.5 and Creatinine_Max < 5.0) then 3
    when
      SUM(urineoutput) OVER W < 500
        then 3
    when (Creatinine_Max >= 2.0 and Creatinine_Max < 3.5) then 2
    when (Creatinine_Max >= 1.2 and Creatinine_Max < 2.0) then 1
    when coalesce
      (
        SUM(urineoutput) OVER W
        , Creatinine_Max
      ) is null then null
  else 0 end as SMALLINT)
    as renal
  from scorecomp
  WINDOW W as
  (
    PARTITION BY icustay_id
    ORDER BY hr
    ROWS BETWEEN 23 PRECEDING AND 0 FOLLOWING
  )
)
, score_final as
(
  select s.*
    -- Combine all the scores to get SOFA
    -- Impute 0 if the score is missing
   -- the window function takes the max over the last 24 hours
    , cast(coalesce(
        MAX(respiration) OVER (PARTITION BY icustay_id ORDER BY HR
        ROWS BETWEEN 24 PRECEDING AND 0 FOLLOWING)
      ,0) as SMALLINT) as respiration_24hours
     , cast(coalesce(
         MAX(coagulation) OVER (PARTITION BY icustay_id ORDER BY HR
         ROWS BETWEEN 24 PRECEDING AND 0 FOLLOWING)
        ,0) as SMALLINT) as coagulation_24hours
    , cast(coalesce(
        MAX(liver) OVER (PARTITION BY icustay_id ORDER BY HR
        ROWS BETWEEN 24 PRECEDING AND 0 FOLLOWING)
      ,0) as SMALLINT) as liver_24hours
    , cast(coalesce(
        MAX(cardiovascular) OVER (PARTITION BY icustay_id ORDER BY HR
        ROWS BETWEEN 24 PRECEDING AND 0 FOLLOWING)
      ,0) as SMALLINT) as cardiovascular_24hours
    , cast(coalesce(
        MAX(cns) OVER (PARTITION BY icustay_id ORDER BY HR
        ROWS BETWEEN 24 PRECEDING AND 0 FOLLOWING)
      ,0) as SMALLINT) as cns_24hours
    , cast(coalesce(
        MAX(renal) OVER (PARTITION BY icustay_id ORDER BY HR
        ROWS BETWEEN 24 PRECEDING AND 0 FOLLOWING)
      ,0) as SMALLINT) as renal_24hours

    -- sum together data for final SOFA
    , coalesce(
        MAX(respiration) OVER (PARTITION BY icustay_id ORDER BY HR
        ROWS BETWEEN 24 PRECEDING AND 0 FOLLOWING)
      ,0)
     + coalesce(
         MAX(coagulation) OVER (PARTITION BY icustay_id ORDER BY HR
         ROWS BETWEEN 24 PRECEDING AND 0 FOLLOWING)
      ,0)
     + coalesce(
        MAX(liver) OVER (PARTITION BY icustay_id ORDER BY HR
        ROWS BETWEEN 24 PRECEDING AND 0 FOLLOWING)
      ,0)
     + coalesce(
        MAX(cardiovascular) OVER (PARTITION BY icustay_id ORDER BY HR
        ROWS BETWEEN 24 PRECEDING AND 0 FOLLOWING)
      ,0)
     + coalesce(
        MAX(cns) OVER (PARTITION BY icustay_id ORDER BY HR
        ROWS BETWEEN 24 PRECEDING AND 0 FOLLOWING)
      ,0)
     + cast(coalesce(
        MAX(renal) OVER (PARTITION BY icustay_id ORDER BY HR
        ROWS BETWEEN 24 PRECEDING AND 0 FOLLOWING)
      ,0) as SMALLINT)
    as sofa_24hours
  from scorecalc s
  WINDOW W as
  (
    PARTITION BY icustay_id
    ORDER BY hr
    ROWS BETWEEN 23 PRECEDING AND 0 FOLLOWING
  )
)
select * from score_final
where hr >= 0
order by icustay_id, hr
  );",109348,Thread-1,2022-07-18T00:10:52.321068Z
E001,,debug,"Postgres adapter: Postgres error: syntax error at or near ""﻿with""
LINE 6:     ﻿with co as
            ^
",109348,Thread-1,2022-07-18T00:10:52.321558Z
E012,,debug,On model.mimic.pivoted_sofa: ROLLBACK,109348,Thread-1,2022-07-18T00:10:52.321935Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:52.322645Z
E010,,debug,On model.mimic.pivoted_sofa: Close,109348,Thread-1,2022-07-18T00:10:52.322907Z
W002,,debug,"Database Error in model pivoted_sofa (models/pivot/pivoted_sofa.sql)
  syntax error at or near ""﻿with""
  LINE 6:     ﻿with co as
              ^
  compiled SQL at target/run/mimic/models/pivot/pivoted_sofa.sql",109348,Thread-1,2022-07-18T00:10:52.323744Z
Q035,0,error,60 of 107 ERROR creating table model public.pivoted_sofa ....................... [[31mERROR[0m in 0.03s],109348,Thread-1,2022-07-18T00:10:52.324970Z,table,null,pivoted_sofa,pivot/pivoted_sofa.sql,2022-07-18T00:10:52.291432,compiling,model,,,
Q024,0.03144264221191406,debug,Finished running node model.mimic.pivoted_sofa,109348,Thread-1,2022-07-18T00:10:52.326612Z,table,2022-07-18T00:10:52.326277,pivoted_sofa,pivot/pivoted_sofa.sql,2022-07-18T00:10:52.291432,error,model,,,
Q023,,debug,Began running node model.mimic.pivoted_uo,109348,Thread-1,2022-07-18T00:10:52.327272Z,table,null,pivoted_uo,pivot/pivoted_uo.sql,2022-07-18T00:10:52.327188,started,model,,,
Q033,,info,61 of 107 START table model public.pivoted_uo .................................. [RUN],109348,Thread-1,2022-07-18T00:10:52.327977Z,table,null,pivoted_uo,pivot/pivoted_uo.sql,2022-07-18T00:10:52.327188,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.pivoted_uo""",109348,Thread-1,2022-07-18T00:10:52.328809Z
Q030,,debug,Began compiling node model.mimic.pivoted_uo,109348,Thread-1,2022-07-18T00:10:52.329022Z,table,null,pivoted_uo,pivot/pivoted_uo.sql,2022-07-18T00:10:52.327188,compiling,model,,,
Q027,,debug,Compiling model.mimic.pivoted_uo,109348,Thread-1,2022-07-18T00:10:52.329154Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.pivoted_uo""",109348,Thread-1,2022-07-18T00:10:52.330933Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:52.332360Z
Q031,,debug,Began executing node model.mimic.pivoted_uo,109348,Thread-1,2022-07-18T00:10:52.333147Z,table,null,pivoted_uo,pivot/pivoted_uo.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.pivoted_uo""",109348,Thread-1,2022-07-18T00:10:52.342753Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_uo""",109348,Thread-1,2022-07-18T00:10:52.343609Z
E016,,debug,On model.mimic.pivoted_uo: BEGIN,109348,Thread-1,2022-07-18T00:10:52.343884Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:52.344088Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:52.352243Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_uo""",109348,Thread-1,2022-07-18T00:10:52.352599Z
E016,,debug,"On model.mimic.pivoted_uo: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_uo""} */


  create  table ""postgres"".""public"".""pivoted_uo__dbt_tmp""
  as (
    select
  icustay_id
  , charttime
  , sum(urineoutput) as urineoutput
from
(
  select
  -- patient identifiers
    oe.icustay_id
  , oe.charttime 
  -- volumes associated with urine output ITEMIDs
  -- note we consider input of GU irrigant as a negative volume
  , case
      when oe.itemid = 227488 and oe.value > 0 then -1*oe.value
      else oe.value
    end as urineoutput
  from outputevents oe
-- exclude rows marked as error
where (oe.iserror IS NULL OR oe.iserror != 1)
  and itemid in
  (
  -- these are the most frequently occurring urine output observations in CareVue
  40055, -- ""Urine Out Foley""
  43175, -- ""Urine .""
  40069, -- ""Urine Out Void""
  40094, -- ""Urine Out Condom Cath""
  40715, -- ""Urine Out Suprapubic""
  40473, -- ""Urine Out IleoConduit""
  40085, -- ""Urine Out Incontinent""
  40057, -- ""Urine Out Rt Nephrostomy""
  40056, -- ""Urine Out Lt Nephrostomy""
  40405, -- ""Urine Out Other""
  40428, -- ""Urine Out Straight Cath""
  40086,--	Urine Out Incontinent
  40096, -- ""Urine Out Ureteral Stent #1""
  40651, -- ""Urine Out Ureteral Stent #2""

  -- these are the most frequently occurring urine output observations in CareVue
  226559, -- ""Foley""
  226560, -- ""Void""
  226561, -- ""Condom Cath""
  226584, -- ""Ileoconduit""
  226563, -- ""Suprapubic""
  226564, -- ""R Nephrostomy""
  226565, -- ""L Nephrostomy""
  226567, --	Straight Cath
  226557, -- R Ureteral Stent
  226558, -- L Ureteral Stent
  227488, -- GU Irrigant Volume In
  227489  -- GU Irrigant/Urine Volume Out
  )
) as foo
group by icustay_id, charttime
order by icustay_id, charttime
  );",109348,Thread-1,2022-07-18T00:10:52.353152Z
E017,,debug,SQL status: SELECT 3381677 in 3.64 seconds,109348,Thread-1,2022-07-18T00:10:55.998637Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_uo""",109348,Thread-1,2022-07-18T00:10:56.004520Z
E016,,debug,"On model.mimic.pivoted_uo: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_uo""} */
alter table ""postgres"".""public"".""pivoted_uo"" rename to ""pivoted_uo__dbt_backup""",109348,Thread-1,2022-07-18T00:10:56.004763Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:56.005550Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_uo""",109348,Thread-1,2022-07-18T00:10:56.009103Z
E016,,debug,"On model.mimic.pivoted_uo: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_uo""} */
alter table ""postgres"".""public"".""pivoted_uo__dbt_tmp"" rename to ""pivoted_uo""",109348,Thread-1,2022-07-18T00:10:56.009336Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:56.010235Z
E018,,debug,On model.mimic.pivoted_uo: COMMIT,109348,Thread-1,2022-07-18T00:10:56.013184Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_uo""",109348,Thread-1,2022-07-18T00:10:56.013400Z
E016,,debug,On model.mimic.pivoted_uo: COMMIT,109348,Thread-1,2022-07-18T00:10:56.013901Z
E017,,debug,SQL status: COMMIT in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:56.023954Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_uo""",109348,Thread-1,2022-07-18T00:10:56.025948Z
E016,,debug,"On model.mimic.pivoted_uo: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_uo""} */
drop table if exists ""postgres"".""public"".""pivoted_uo__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:56.026199Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:56.029951Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:56.034143Z
E010,,debug,On model.mimic.pivoted_uo: Close,109348,Thread-1,2022-07-18T00:10:56.034415Z
Q012,3,info,61 of 107 OK created table model public.pivoted_uo ............................. [[32mSELECT 3381677[0m in 3.71s],109348,Thread-1,2022-07-18T00:10:56.035385Z,table,null,pivoted_uo,pivot/pivoted_uo.sql,2022-07-18T00:10:52.327188,compiling,model,,,
Q024,3.7067220211029053,debug,Finished running node model.mimic.pivoted_uo,109348,Thread-1,2022-07-18T00:10:56.036103Z,table,2022-07-18T00:10:56.035925,pivoted_uo,pivot/pivoted_uo.sql,2022-07-18T00:10:52.327188,success,model,,,
Q023,,debug,Began running node model.mimic.pivoted_vital,109348,Thread-1,2022-07-18T00:10:56.036604Z,table,null,pivoted_vital,pivot/pivoted_vital.sql,2022-07-18T00:10:56.036518,started,model,,,
Q033,,info,62 of 107 START table model public.pivoted_vital ............................... [RUN],109348,Thread-1,2022-07-18T00:10:56.037265Z,table,null,pivoted_vital,pivot/pivoted_vital.sql,2022-07-18T00:10:56.036518,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.pivoted_vital""",109348,Thread-1,2022-07-18T00:10:56.038047Z
Q030,,debug,Began compiling node model.mimic.pivoted_vital,109348,Thread-1,2022-07-18T00:10:56.038378Z,table,null,pivoted_vital,pivot/pivoted_vital.sql,2022-07-18T00:10:56.036518,compiling,model,,,
Q027,,debug,Compiling model.mimic.pivoted_vital,109348,Thread-1,2022-07-18T00:10:56.038830Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.pivoted_vital""",109348,Thread-1,2022-07-18T00:10:56.040294Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:56.040902Z
Q031,,debug,Began executing node model.mimic.pivoted_vital,109348,Thread-1,2022-07-18T00:10:56.041230Z,table,null,pivoted_vital,pivot/pivoted_vital.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.pivoted_vital""",109348,Thread-1,2022-07-18T00:10:56.050529Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_vital""",109348,Thread-1,2022-07-18T00:10:56.052397Z
E016,,debug,On model.mimic.pivoted_vital: BEGIN,109348,Thread-1,2022-07-18T00:10:56.053051Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:56.053261Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:56.059963Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_vital""",109348,Thread-1,2022-07-18T00:10:56.060451Z
E016,,debug,"On model.mimic.pivoted_vital: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_vital""} */


  create  table ""postgres"".""public"".""pivoted_vital__dbt_tmp""
  as (
    -- This query pivots the vital signs for the first 24 hours of a patient's stay
-- Vital signs include heart rate, blood pressure, respiration rate, and temperature

with ce as
(
  select ce.icustay_id
    , ce.charttime
    , (case when itemid in (211,220045) and valuenum > 0 and valuenum < 300 then valuenum else null end) as heartrate
    , (case when itemid in (51,442,455,6701,220179,220050) and valuenum > 0 and valuenum < 400 then valuenum else null end) as sysbp
    , (case when itemid in (8368,8440,8441,8555,220180,220051) and valuenum > 0 and valuenum < 300 then valuenum else null end) as diasbp
    , (case when itemid in (456,52,6702,443,220052,220181,225312) and valuenum > 0 and valuenum < 300 then valuenum else null end) as meanbp
    , (case when itemid in (615,618,220210,224690) and valuenum > 0 and valuenum < 70 then valuenum else null end) as resprate
    , (case when itemid in (223761,678) and valuenum > 70 and valuenum < 120 then (valuenum-32)/1.8 -- converted to degC in valuenum call
               when itemid in (223762,676) and valuenum > 10 and valuenum < 50  then valuenum else null end) as tempc
    , (case when itemid in (646,220277) and valuenum > 0 and valuenum <= 100 then valuenum else null end) as spo2
    , (case when itemid in (807,811,1529,3745,3744,225664,220621,226537) and valuenum > 0 then valuenum else null end) as glucose
  FROM chartevents ce
  -- exclude rows marked as error
  where (ce.error IS NULL OR ce.error != 1)
  and ce.icustay_id IS NOT NULL
  and ce.itemid in
  (
  -- HEART RATE
  211, --""Heart Rate""
  220045, --""Heart Rate""

  -- Systolic/diastolic

  51, --	Arterial BP [Systolic]
  442, --	Manual BP [Systolic]
  455, --	NBP [Systolic]
  6701, --	Arterial BP #2 [Systolic]
  220179, --	Non Invasive Blood Pressure systolic
  220050, --	Arterial Blood Pressure systolic

  8368, --	Arterial BP [Diastolic]
  8440, --	Manual BP [Diastolic]
  8441, --	NBP [Diastolic]
  8555, --	Arterial BP #2 [Diastolic]
  220180, --	Non Invasive Blood Pressure diastolic
  220051, --	Arterial Blood Pressure diastolic


  -- MEAN ARTERIAL PRESSURE
  456, --""NBP Mean""
  52, --""Arterial BP Mean""
  6702, --	Arterial BP Mean #2
  443, --	Manual BP Mean(calc)
  220052, --""Arterial Blood Pressure mean""
  220181, --""Non Invasive Blood Pressure mean""
  225312, --""ART BP mean""

  -- RESPIRATORY RATE
  618,--	Respiratory Rate
  615,--	Resp Rate (Total)
  220210,--	Respiratory Rate
  224690, --	Respiratory Rate (Total)


  -- spo2, peripheral
  646, 220277,

  -- glucose, both lab and fingerstick
  807,--	Fingerstick glucose
  811,--	glucose (70-105)
  1529,--	glucose
  3745,--	Bloodglucose
  3744,--	Blood glucose
  225664,--	glucose finger stick
  220621,--	glucose (serum)
  226537,--	glucose (whole blood)

  -- TEMPERATURE
  223762, -- ""Temperature Celsius""
  676,	-- ""Temperature C""
  223761, -- ""Temperature Fahrenheit""
  678 --	""Temperature F""

  )
)
select
    ce.icustay_id
  , ce.charttime
  , avg(heartrate) as heartrate
  , avg(sysbp) as sysbp
  , avg(diasbp) as diasbp
  , avg(meanbp) as meanbp
  , avg(resprate) as resprate
  , avg(tempc) as tempc
  , avg(spo2) as spo2
  , avg(glucose) as glucose
from ce
group by ce.icustay_id, ce.charttime
order by ce.icustay_id, ce.charttime
  );",109348,Thread-1,2022-07-18T00:10:56.061460Z
E017,,debug,SQL status: SELECT 1045 in 0.02 seconds,109348,Thread-1,2022-07-18T00:10:56.086972Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_vital""",109348,Thread-1,2022-07-18T00:10:56.091015Z
E016,,debug,"On model.mimic.pivoted_vital: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_vital""} */
alter table ""postgres"".""public"".""pivoted_vital"" rename to ""pivoted_vital__dbt_backup""",109348,Thread-1,2022-07-18T00:10:56.091253Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:56.092273Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_vital""",109348,Thread-1,2022-07-18T00:10:56.099687Z
E016,,debug,"On model.mimic.pivoted_vital: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_vital""} */
alter table ""postgres"".""public"".""pivoted_vital__dbt_tmp"" rename to ""pivoted_vital""",109348,Thread-1,2022-07-18T00:10:56.099942Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:56.100488Z
E018,,debug,On model.mimic.pivoted_vital: COMMIT,109348,Thread-1,2022-07-18T00:10:56.103698Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_vital""",109348,Thread-1,2022-07-18T00:10:56.103949Z
E016,,debug,On model.mimic.pivoted_vital: COMMIT,109348,Thread-1,2022-07-18T00:10:56.104073Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:56.105235Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_vital""",109348,Thread-1,2022-07-18T00:10:56.107269Z
E016,,debug,"On model.mimic.pivoted_vital: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_vital""} */
drop table if exists ""postgres"".""public"".""pivoted_vital__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:56.107501Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:56.110390Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:56.115693Z
E010,,debug,On model.mimic.pivoted_vital: Close,109348,Thread-1,2022-07-18T00:10:56.115950Z
Q012,0,info,62 of 107 OK created table model public.pivoted_vital .......................... [[32mSELECT 1045[0m in 0.08s],109348,Thread-1,2022-07-18T00:10:56.116815Z,table,null,pivoted_vital,pivot/pivoted_vital.sql,2022-07-18T00:10:56.036518,compiling,model,,,
Q024,0.07906532287597656,debug,Finished running node model.mimic.pivoted_vital,109348,Thread-1,2022-07-18T00:10:56.117410Z,table,2022-07-18T00:10:56.117259,pivoted_vital,pivot/pivoted_vital.sql,2022-07-18T00:10:56.036518,success,model,,,
Q023,,debug,Began running node model.mimic.potassium,109348,Thread-1,2022-07-18T00:10:56.117932Z,table,null,potassium,cookbook/potassium.sql,2022-07-18T00:10:56.117857,started,model,,,
Q033,,info,63 of 107 START table model public.potassium ................................... [RUN],109348,Thread-1,2022-07-18T00:10:56.118678Z,table,null,potassium,cookbook/potassium.sql,2022-07-18T00:10:56.117857,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.potassium""",109348,Thread-1,2022-07-18T00:10:56.119796Z
Q030,,debug,Began compiling node model.mimic.potassium,109348,Thread-1,2022-07-18T00:10:56.119968Z,table,null,potassium,cookbook/potassium.sql,2022-07-18T00:10:56.117857,compiling,model,,,
Q027,,debug,Compiling model.mimic.potassium,109348,Thread-1,2022-07-18T00:10:56.120211Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.potassium""",109348,Thread-1,2022-07-18T00:10:56.121368Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:56.122115Z
Q031,,debug,Began executing node model.mimic.potassium,109348,Thread-1,2022-07-18T00:10:56.122409Z,table,null,potassium,cookbook/potassium.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.potassium""",109348,Thread-1,2022-07-18T00:10:56.131698Z
E015,,debug,"Using postgres connection ""model.mimic.potassium""",109348,Thread-1,2022-07-18T00:10:56.133271Z
E016,,debug,On model.mimic.potassium: BEGIN,109348,Thread-1,2022-07-18T00:10:56.133509Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:56.133782Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:56.140929Z
E015,,debug,"Using postgres connection ""model.mimic.potassium""",109348,Thread-1,2022-07-18T00:10:56.141236Z
E016,,debug,"On model.mimic.potassium: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.potassium""} */


  create  table ""postgres"".""public"".""potassium__dbt_tmp""
  as (
    -- --------------------------------------------------------
-- Title: Creates a histogram of serum potassium for adult patients
-- Notes: this query does not specify a schema. To run it on your local
-- MIMIC schema, run the following command:
--  SET SEARCH_PATH TO mimiciii
-- Where ""mimiciii"" is the name of your schema, and may be different.
-- --------------------------------------------------------

WITH agetbl AS
(
  SELECT ad.subject_id
  FROM admissions ad
  INNER JOIN patients p
  ON ad.subject_id = p.subject_id
  WHERE
  -- filter to only adults
  DATETIME_DIFF(ad.admittime, p.dob, 'YEAR') > 15
  -- group by subject_id to ensure there is only 1 subject_id per row
  group by ad.subject_id
)
, k as
(
  SELECT width_bucket(valuenum, 0, 10, 100) AS bucket
  FROM labevents le
  INNER JOIN agetbl
  ON le.subject_id = agetbl.subject_id
  WHERE itemid IN (50822, 50971)
)
SELECT round(cast(bucket as numeric) / 10,2) as potassium_value, count(*)
FROM k
GROUP BY bucket
ORDER BY bucket
  );",109348,Thread-1,2022-07-18T00:10:56.141366Z
E017,,debug,SQL status: SELECT 0 in 0.16 seconds,109348,Thread-1,2022-07-18T00:10:56.298503Z
E015,,debug,"Using postgres connection ""model.mimic.potassium""",109348,Thread-1,2022-07-18T00:10:56.303653Z
E016,,debug,"On model.mimic.potassium: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.potassium""} */
alter table ""postgres"".""public"".""potassium"" rename to ""potassium__dbt_backup""",109348,Thread-1,2022-07-18T00:10:56.304016Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:56.305022Z
E015,,debug,"Using postgres connection ""model.mimic.potassium""",109348,Thread-1,2022-07-18T00:10:56.309496Z
E016,,debug,"On model.mimic.potassium: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.potassium""} */
alter table ""postgres"".""public"".""potassium__dbt_tmp"" rename to ""potassium""",109348,Thread-1,2022-07-18T00:10:56.309937Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:56.310960Z
E018,,debug,On model.mimic.potassium: COMMIT,109348,Thread-1,2022-07-18T00:10:56.315847Z
E015,,debug,"Using postgres connection ""model.mimic.potassium""",109348,Thread-1,2022-07-18T00:10:56.316067Z
E016,,debug,On model.mimic.potassium: COMMIT,109348,Thread-1,2022-07-18T00:10:56.316330Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:56.318280Z
E015,,debug,"Using postgres connection ""model.mimic.potassium""",109348,Thread-1,2022-07-18T00:10:56.320864Z
E016,,debug,"On model.mimic.potassium: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.potassium""} */
drop table if exists ""postgres"".""public"".""potassium__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:56.321105Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:56.323842Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:56.327925Z
E010,,debug,On model.mimic.potassium: Close,109348,Thread-1,2022-07-18T00:10:56.328839Z
Q012,0,info,63 of 107 OK created table model public.potassium .............................. [[32mSELECT 0[0m in 0.21s],109348,Thread-1,2022-07-18T00:10:56.330754Z,table,null,potassium,cookbook/potassium.sql,2022-07-18T00:10:56.117857,compiling,model,,,
Q024,0.21065306663513184,debug,Finished running node model.mimic.potassium,109348,Thread-1,2022-07-18T00:10:56.331806Z,table,2022-07-18T00:10:56.331494,potassium,cookbook/potassium.sql,2022-07-18T00:10:56.117857,success,model,,,
Q023,,debug,Began running node model.mimic.rbc_transfusion,109348,Thread-1,2022-07-18T00:10:56.332348Z,table,null,rbc_transfusion,fluid_balance/rbc_transfusion.sql,2022-07-18T00:10:56.332154,started,model,,,
Q033,,info,64 of 107 START table model public.rbc_transfusion ............................. [RUN],109348,Thread-1,2022-07-18T00:10:56.332956Z,table,null,rbc_transfusion,fluid_balance/rbc_transfusion.sql,2022-07-18T00:10:56.332154,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.rbc_transfusion""",109348,Thread-1,2022-07-18T00:10:56.333556Z
Q030,,debug,Began compiling node model.mimic.rbc_transfusion,109348,Thread-1,2022-07-18T00:10:56.334008Z,table,null,rbc_transfusion,fluid_balance/rbc_transfusion.sql,2022-07-18T00:10:56.332154,compiling,model,,,
Q027,,debug,Compiling model.mimic.rbc_transfusion,109348,Thread-1,2022-07-18T00:10:56.334355Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.rbc_transfusion""",109348,Thread-1,2022-07-18T00:10:56.335912Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:56.336664Z
Q031,,debug,Began executing node model.mimic.rbc_transfusion,109348,Thread-1,2022-07-18T00:10:56.337055Z,table,null,rbc_transfusion,fluid_balance/rbc_transfusion.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.rbc_transfusion""",109348,Thread-1,2022-07-18T00:10:56.346968Z
E015,,debug,"Using postgres connection ""model.mimic.rbc_transfusion""",109348,Thread-1,2022-07-18T00:10:56.348002Z
E016,,debug,On model.mimic.rbc_transfusion: BEGIN,109348,Thread-1,2022-07-18T00:10:56.348301Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:56.348511Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:56.354476Z
E015,,debug,"Using postgres connection ""model.mimic.rbc_transfusion""",109348,Thread-1,2022-07-18T00:10:56.354775Z
E016,,debug,"On model.mimic.rbc_transfusion: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.rbc_transfusion""} */


  create  table ""postgres"".""public"".""rbc_transfusion__dbt_tmp""
  as (
    -- Retrieves instances of red blood cell transfusions
with raw_rbc as (
  SELECT
      CASE
        WHEN amount IS NOT NULL THEN amount
        WHEN stopped IS NOT NULL THEN 0
        -- impute 375 mL when unit is not documented
        ELSE 375
      END AS amount
    , amountuom
    , icustay_id
    , charttime
  FROM inputevents_cv
  WHERE itemid IN
  (
    30179,  -- PRBC's
    30001,  -- Packed RBC's
    30004   -- Washed PRBC's
  )
  AND icustay_id IS NOT NULL
  UNION ALL
  SELECT amount
    , amountuom
    , icustay_id
    , endtime AS charttime
  FROM inputevents_mv
  WHERE itemid in
  (
    225168   -- Packed Red Blood Cells
  )
  AND amount > 0
  AND icustay_id IS NOT NULL
),
pre_icu_rbc as (
  SELECT
    sum(amount) as amount, icustay_id
  FROM inputevents_cv
  WHERE itemid IN (
    42324,  -- er prbc
    42588,  -- VICU PRBC
    42239,  -- CC7 PRBC
    46407,  -- ED PRBC
    46612,  -- E.R. prbc
    46124,  -- er in prbc
    42740   -- prbc in er
  )
  AND amount > 0
  AND icustay_id IS NOT NULL
  GROUP BY icustay_id
  UNION ALL
  SELECT
    sum(amount) as amount, icustay_id
  FROM inputevents_mv
  WHERE itemid IN (
    227070  -- PACU Packed RBC Intake
  )
  AND amount > 0
  AND icustay_id IS NOT NULL
  GROUP BY icustay_id
),
cumulative AS (
  SELECT
    sum(amount) over (PARTITION BY icustay_id ORDER BY charttime DESC) AS amount
    , amountuom
    , icustay_id
    , charttime
    , DATETIME_DIFF(lag(charttime) over (PARTITION BY icustay_id ORDER BY charttime ASC), charttime, 'HOUR') AS delta
  FROM raw_rbc
)
-- We consider any transfusions started within 1 hr of the last one
-- to be part of the same event
SELECT
    cm.icustay_id
  , cm.charttime
  , ROUND(CAST(cm.amount AS numeric) - CASE
      WHEN ROW_NUMBER() OVER w = 1 THEN CAST(0 AS numeric)
      ELSE CAST(lag(cm.amount) OVER w AS numeric)
    END, 2) AS amount
  , ROUND(CAST(cm.amount AS numeric) + CASE
      WHEN CAST(pre.amount AS numeric) IS NULL THEN CAST(0 AS numeric)
      ELSE CAST(pre.amount AS numeric)
    END, 2) AS totalamount
  , cm.amountuom
FROM cumulative AS cm
LEFT JOIN pre_icu_rbc AS pre
  USING (icustay_id)
WHERE delta IS NULL OR delta < -1
WINDOW w AS (PARTITION BY cm.icustay_id ORDER BY cm.charttime DESC)
ORDER BY icustay_id, charttime
  );",109348,Thread-1,2022-07-18T00:10:56.354983Z
E017,,debug,SQL status: SELECT 62851 in 1.91 seconds,109348,Thread-1,2022-07-18T00:10:58.269415Z
E015,,debug,"Using postgres connection ""model.mimic.rbc_transfusion""",109348,Thread-1,2022-07-18T00:10:58.279836Z
E016,,debug,"On model.mimic.rbc_transfusion: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.rbc_transfusion""} */
alter table ""postgres"".""public"".""rbc_transfusion"" rename to ""rbc_transfusion__dbt_backup""",109348,Thread-1,2022-07-18T00:10:58.280367Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:58.282421Z
E015,,debug,"Using postgres connection ""model.mimic.rbc_transfusion""",109348,Thread-1,2022-07-18T00:10:58.286850Z
E016,,debug,"On model.mimic.rbc_transfusion: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.rbc_transfusion""} */
alter table ""postgres"".""public"".""rbc_transfusion__dbt_tmp"" rename to ""rbc_transfusion""",109348,Thread-1,2022-07-18T00:10:58.287090Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:58.287856Z
E018,,debug,On model.mimic.rbc_transfusion: COMMIT,109348,Thread-1,2022-07-18T00:10:58.291006Z
E015,,debug,"Using postgres connection ""model.mimic.rbc_transfusion""",109348,Thread-1,2022-07-18T00:10:58.291289Z
E016,,debug,On model.mimic.rbc_transfusion: COMMIT,109348,Thread-1,2022-07-18T00:10:58.291500Z
E017,,debug,SQL status: COMMIT in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:58.299880Z
E015,,debug,"Using postgres connection ""model.mimic.rbc_transfusion""",109348,Thread-1,2022-07-18T00:10:58.302299Z
E016,,debug,"On model.mimic.rbc_transfusion: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.rbc_transfusion""} */
drop table if exists ""postgres"".""public"".""rbc_transfusion__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:58.302534Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:58.304856Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:58.307578Z
E010,,debug,On model.mimic.rbc_transfusion: Close,109348,Thread-1,2022-07-18T00:10:58.307825Z
Q012,1,info,64 of 107 OK created table model public.rbc_transfusion ........................ [[32mSELECT 62851[0m in 1.98s],109348,Thread-1,2022-07-18T00:10:58.308773Z,table,null,rbc_transfusion,fluid_balance/rbc_transfusion.sql,2022-07-18T00:10:56.332154,compiling,model,,,
Q024,1.975257158279419,debug,Finished running node model.mimic.rbc_transfusion,109348,Thread-1,2022-07-18T00:10:58.309344Z,table,2022-07-18T00:10:58.309158,rbc_transfusion,fluid_balance/rbc_transfusion.sql,2022-07-18T00:10:56.332154,success,model,,,
Q023,,debug,Began running node model.mimic.rr,109348,Thread-1,2022-07-18T00:10:58.309982Z,table,null,rr,cookbook/rr.sql,2022-07-18T00:10:58.309915,started,model,,,
Q033,,info,65 of 107 START table model public.rr .......................................... [RUN],109348,Thread-1,2022-07-18T00:10:58.310728Z,table,null,rr,cookbook/rr.sql,2022-07-18T00:10:58.309915,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.rr""",109348,Thread-1,2022-07-18T00:10:58.311540Z
Q030,,debug,Began compiling node model.mimic.rr,109348,Thread-1,2022-07-18T00:10:58.311965Z,table,null,rr,cookbook/rr.sql,2022-07-18T00:10:58.309915,compiling,model,,,
Q027,,debug,Compiling model.mimic.rr,109348,Thread-1,2022-07-18T00:10:58.312412Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.rr""",109348,Thread-1,2022-07-18T00:10:58.313841Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:58.314596Z
Q031,,debug,Began executing node model.mimic.rr,109348,Thread-1,2022-07-18T00:10:58.315051Z,table,null,rr,cookbook/rr.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.rr""",109348,Thread-1,2022-07-18T00:10:58.327777Z
E015,,debug,"Using postgres connection ""model.mimic.rr""",109348,Thread-1,2022-07-18T00:10:58.328319Z
E016,,debug,On model.mimic.rr: BEGIN,109348,Thread-1,2022-07-18T00:10:58.328454Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:58.328563Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:58.336612Z
E015,,debug,"Using postgres connection ""model.mimic.rr""",109348,Thread-1,2022-07-18T00:10:58.336929Z
E016,,debug,"On model.mimic.rr: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.rr""} */


  create  table ""postgres"".""public"".""rr__dbt_tmp""
  as (
    -- --------------------------------------------------------
-- Title: Retrieves the respiration rate of adult patients
--        only for patients recorded with carevue
-- MIMIC version: MIMIC-III v1.3
-- Notes: this query does not specify a schema. To run it on your local
-- MIMIC schema, run the following command:
--  SET SEARCH_PATH TO mimiciii
-- Where ""mimiciii"" is the name of your schema, and may be different.
-- --------------------------------------------------------

WITH agetbl AS
(
  SELECT ad.subject_id
  FROM admissions ad
  INNER JOIN patients p
  ON ad.subject_id = p.subject_id
  WHERE
  -- filter to only adults
  DATETIME_DIFF(ad.admittime, p.dob, 'YEAR') > 15
  -- group by subject_id to ensure there is only 1 subject_id per row
  group by ad.subject_id
)
, rr as
(
  SELECT valuenum, width_bucket(valuenum, 0, 130, 1400) AS bucket
  FROM chartevents ce
  INNER JOIN agetbl
  ON ce.subject_id = agetbl.subject_id
  WHERE itemid in (219, 615, 618)
)
SELECT round(cast(bucket as numeric) / 10,2) as respiration_rate, count(*)
FROM rr
GROUP BY bucket
ORDER BY bucket
  );",109348,Thread-1,2022-07-18T00:10:58.337058Z
E017,,debug,SQL status: SELECT 0 in 0.16 seconds,109348,Thread-1,2022-07-18T00:10:58.499322Z
E015,,debug,"Using postgres connection ""model.mimic.rr""",109348,Thread-1,2022-07-18T00:10:58.504483Z
E016,,debug,"On model.mimic.rr: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.rr""} */
alter table ""postgres"".""public"".""rr"" rename to ""rr__dbt_backup""",109348,Thread-1,2022-07-18T00:10:58.504739Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:58.505616Z
E015,,debug,"Using postgres connection ""model.mimic.rr""",109348,Thread-1,2022-07-18T00:10:58.512786Z
E016,,debug,"On model.mimic.rr: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.rr""} */
alter table ""postgres"".""public"".""rr__dbt_tmp"" rename to ""rr""",109348,Thread-1,2022-07-18T00:10:58.513160Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:58.514071Z
E018,,debug,On model.mimic.rr: COMMIT,109348,Thread-1,2022-07-18T00:10:58.517292Z
E015,,debug,"Using postgres connection ""model.mimic.rr""",109348,Thread-1,2022-07-18T00:10:58.517498Z
E016,,debug,On model.mimic.rr: COMMIT,109348,Thread-1,2022-07-18T00:10:58.517917Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:58.520583Z
E015,,debug,"Using postgres connection ""model.mimic.rr""",109348,Thread-1,2022-07-18T00:10:58.523125Z
E016,,debug,"On model.mimic.rr: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.rr""} */
drop table if exists ""postgres"".""public"".""rr__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:10:58.523543Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:10:58.526498Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:58.531812Z
E010,,debug,On model.mimic.rr: Close,109348,Thread-1,2022-07-18T00:10:58.532292Z
Q012,0,info,65 of 107 OK created table model public.rr ..................................... [[32mSELECT 0[0m in 0.22s],109348,Thread-1,2022-07-18T00:10:58.533451Z,table,null,rr,cookbook/rr.sql,2022-07-18T00:10:58.309915,compiling,model,,,
Q024,0.22198176383972168,debug,Finished running node model.mimic.rr,109348,Thread-1,2022-07-18T00:10:58.534615Z,table,2022-07-18T00:10:58.534466,rr,cookbook/rr.sql,2022-07-18T00:10:58.309915,success,model,,,
Q023,,debug,Began running node model.mimic.rrt_first_day,109348,Thread-1,2022-07-18T00:10:58.535113Z,table,null,rrt_first_day,firstday/rrt_first_day.sql,2022-07-18T00:10:58.535019,started,model,,,
Q033,,info,66 of 107 START table model public.rrt_first_day ............................... [RUN],109348,Thread-1,2022-07-18T00:10:58.535856Z,table,null,rrt_first_day,firstday/rrt_first_day.sql,2022-07-18T00:10:58.535019,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.rrt_first_day""",109348,Thread-1,2022-07-18T00:10:58.536426Z
Q030,,debug,Began compiling node model.mimic.rrt_first_day,109348,Thread-1,2022-07-18T00:10:58.536554Z,table,null,rrt_first_day,firstday/rrt_first_day.sql,2022-07-18T00:10:58.535019,compiling,model,,,
Q027,,debug,Compiling model.mimic.rrt_first_day,109348,Thread-1,2022-07-18T00:10:58.536683Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.rrt_first_day""",109348,Thread-1,2022-07-18T00:10:58.538472Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:10:58.538959Z
Q031,,debug,Began executing node model.mimic.rrt_first_day,109348,Thread-1,2022-07-18T00:10:58.539287Z,table,null,rrt_first_day,firstday/rrt_first_day.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.rrt_first_day""",109348,Thread-1,2022-07-18T00:10:58.548219Z
E015,,debug,"Using postgres connection ""model.mimic.rrt_first_day""",109348,Thread-1,2022-07-18T00:10:58.548780Z
E016,,debug,On model.mimic.rrt_first_day: BEGIN,109348,Thread-1,2022-07-18T00:10:58.548905Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:10:58.549016Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:10:58.556449Z
E015,,debug,"Using postgres connection ""model.mimic.rrt_first_day""",109348,Thread-1,2022-07-18T00:10:58.557120Z
E016,,debug,"On model.mimic.rrt_first_day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.rrt_first_day""} */


  create  table ""postgres"".""public"".""rrt_first_day__dbt_tmp""
  as (
    -- determines if patients received any dialysis during their stay

-- Some example aggregate queries which summarize the data here..
-- This query estimates 6.7% of ICU patients received RRT.
    -- select count(rrt.icustay_id) as numobs
    -- , sum(rrt) as numrrt
    -- , sum(case when rrt=1 then 1 else 0 end)*100.0 / count(rrt.icustay_id)
    -- as percent_rrt
    -- from rrt
    -- inner join icustays ie on rrt.icustay_id = ie.icustay_id
    -- inner join patients p
    -- on rrt.subject_id = p.subject_id
    -- and p.dob < ie.intime - interval '1' year
    -- inner join admissions adm
    -- on rrt.hadm_id = adm.hadm_id

-- This query estimates that 4.6% of first ICU stays received RRT.
    -- select
    --   count(rrt.icustay_id) as numobs
    --   , sum(rrt) as numrrt
    --   , sum(case when rrt=1 then 1 else 0 end)*100.0 / count(rrt.icustay_id)
    -- as percent_rrt
    -- from
    -- (
    -- select ie.icustay_id, rrt.rrt
    --   , ROW_NUMBER() over (partition by ie.subject_id order by ie.intime) rn
    -- from rrt
    -- inner join icustays ie
    --   on rrt.icustay_id = ie.icustay_id
    -- inner join patients p
    --   on rrt.subject_id = p.subject_id
    -- and p.dob < ie.intime - interval '1' year
    -- inner join admissions adm
    --   on rrt.hadm_id = adm.hadm_id
    -- ) rrt
    -- where rn = 1

with cv as
(
  select ie.icustay_id
    , max(
        case
          when ce.itemid in (152,148,149,146,147,151,150) and value is not null then 1
          when ce.itemid in (229,235,241,247,253,259,265,271) and value = 'Dialysis Line' then 1
          when ce.itemid = 582 and value in ('CAVH Start','CAVH D/C','CVVHD Start','CVVHD D/C','Hemodialysis st','Hemodialysis end') then 1
        else 0 end
        ) as RRT
  FROM icustays ie
  inner join chartevents ce
    on ie.icustay_id = ce.icustay_id
    and ce.itemid in
    (
       152 -- ""Dialysis Type""61449
      ,148 -- ""Dialysis Access Site""60335
      ,149 -- ""Dialysis Access Type""60030
      ,146 -- ""Dialysate Flow ml/hr""57445
      ,147 -- ""Dialysate Infusing""56605
      ,151 -- ""Dialysis Site Appear""37345
      ,150 -- ""Dialysis Machine""27472
      ,229 -- INV Line#1 [Type]
      ,235 -- INV Line#2 [Type]
      ,241 -- INV Line#3 [Type]
      ,247 -- INV Line#4 [Type]
      ,253 -- INV Line#5 [Type]
      ,259 -- INV Line#6 [Type]
      ,265 -- INV Line#7 [Type]
      ,271 -- INV Line#8 [Type]
      ,582 -- Procedures
    )
    and ce.value is not null
    and ce.charttime between ie.intime and DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
  where ie.dbsource = 'carevue'
  group by ie.icustay_id
)
, mv_ce as
(
  select ie.icustay_id
    , 1 as RRT
  FROM icustays ie
  inner join chartevents ce
    on ie.icustay_id = ce.icustay_id
    and ce.charttime between ie.intime and DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
    and itemid in
    (
      -- Checkboxes
        226118 -- | Dialysis Catheter placed in outside facility      | Access Lines - Invasive | chartevents        | Checkbox
      , 227357 -- | Dialysis Catheter Dressing Occlusive              | Access Lines - Invasive | chartevents        | Checkbox
      , 225725 -- | Dialysis Catheter Tip Cultured                    | Access Lines - Invasive | chartevents        | Checkbox
      -- Numeric values
      , 226499 -- | Hemodialysis Output                               | Dialysis                | chartevents        | Numeric
      , 224154 -- | Dialysate Rate                                    | Dialysis                | chartevents        | Numeric
      , 225810 -- | Dwell Time (Peritoneal Dialysis)                  | Dialysis                | chartevents        | Numeric
      , 227639 -- | Medication Added Amount  #2 (Peritoneal Dialysis) | Dialysis                | chartevents        | Numeric
      , 225183 -- | Current Goal                     | Dialysis | chartevents        | Numeric
      , 227438 -- | Volume not removed               | Dialysis | chartevents        | Numeric
      , 224191 -- | Hourly Patient Fluid Removal     | Dialysis | chartevents        | Numeric
      , 225806 -- | Volume In (PD)                   | Dialysis | chartevents        | Numeric
      , 225807 -- | Volume Out (PD)                  | Dialysis | chartevents        | Numeric
      , 228004 -- | Citrate (ACD-A)                  | Dialysis | chartevents        | Numeric
      , 228005 -- | PBP (Prefilter) Replacement Rate | Dialysis | chartevents        | Numeric
      , 228006 -- | Post Filter Replacement Rate     | Dialysis | chartevents        | Numeric
      , 224144 -- | Blood Flow (ml/min)              | Dialysis | chartevents        | Numeric
      , 224145 -- | Heparin Dose (per hour)          | Dialysis | chartevents        | Numeric
      , 224149 -- | Access Pressure                  | Dialysis | chartevents        | Numeric
      , 224150 -- | Filter Pressure                  | Dialysis | chartevents        | Numeric
      , 224151 -- | Effluent Pressure                | Dialysis | chartevents        | Numeric
      , 224152 -- | Return Pressure                  | Dialysis | chartevents        | Numeric
      , 224153 -- | Replacement Rate                 | Dialysis | chartevents        | Numeric
      , 224404 -- | ART Lumen Volume                 | Dialysis | chartevents        | Numeric
      , 224406 -- | VEN Lumen Volume                 | Dialysis | chartevents        | Numeric
      , 226457 -- | Ultrafiltrate Output             | Dialysis | chartevents        | Numeric
    )
    and valuenum > 0 -- also ensures it's not null
  group by ie.icustay_id
)
, mv_ie as
(
  select ie.icustay_id
    , 1 as RRT
  FROM icustays ie
  inner join inputevents_mv tt
    on ie.icustay_id = tt.icustay_id
    and tt.starttime between ie.intime and DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
    and itemid in
    (
        227536 --	KCl (CRRT)	Medications	inputevents_mv	Solution
      , 227525 --	Calcium Gluconate (CRRT)	Medications	inputevents_mv	Solution
    )
    and amount > 0 -- also ensures it's not null
  group by ie.icustay_id
)
, mv_de as
(
  select ie.icustay_id
    , 1 as RRT
  FROM icustays ie
  inner join datetimeevents tt
    on ie.icustay_id = tt.icustay_id
    and tt.charttime between ie.intime and DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
    and itemid in
    (
      -- TODO: unsure how to handle ""Last dialysis""
      --  225128 -- | Last dialysis                                     | Adm History/FHPA        | datetimeevents     | Date time
        225318 -- | Dialysis Catheter Cap Change                      | Access Lines - Invasive | datetimeevents     | Date time
      , 225319 -- | Dialysis Catheter Change over Wire Date           | Access Lines - Invasive | datetimeevents     | Date time
      , 225321 -- | Dialysis Catheter Dressing Change                 | Access Lines - Invasive | datetimeevents     | Date time
      , 225322 -- | Dialysis Catheter Insertion Date                  | Access Lines - Invasive | datetimeevents     | Date time
      , 225324 -- | Dialysis CatheterTubing Change                    | Access Lines - Invasive | datetimeevents     | Date time
    )
  group by ie.icustay_id
)
, mv_pe as
(
    select ie.icustay_id
      , 1 as RRT
    FROM icustays ie
    inner join procedureevents_mv tt
      on ie.icustay_id = tt.icustay_id
      and tt.starttime between ie.intime and DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
      and itemid in
      (
          225441 -- | Hemodialysis                                      | 4-Procedures            | procedureevents_mv | Process
        , 225802 -- | Dialysis - CRRT                                   | Dialysis                | procedureevents_mv | Process
        , 225803 -- | Dialysis - CVVHD                                  | Dialysis                | procedureevents_mv | Process
        , 225805 -- | Peritoneal Dialysis                               | Dialysis                | procedureevents_mv | Process
        , 224270 -- | Dialysis Catheter                                 | Access Lines - Invasive | procedureevents_mv | Process
        , 225809 -- | Dialysis - CVVHDF                                 | Dialysis                | procedureevents_mv | Process
        , 225955 -- | Dialysis - SCUF                                   | Dialysis                | procedureevents_mv | Process
        , 225436 -- | CRRT Filter Change               | Dialysis | procedureevents_mv | Process
      )
    group by ie.icustay_id
)
select ie.subject_id, ie.hadm_id, ie.icustay_id
  , case
      when cv.RRT = 1 then 1
      when mv_ce.RRT = 1 then 1
      when mv_ie.RRT = 1 then 1
      when mv_de.RRT = 1 then 1
      when mv_pe.RRT = 1 then 1
      else 0
    end as rrt
FROM icustays ie
left join cv
  on ie.icustay_id = cv.icustay_id
left join mv_ce
  on ie.icustay_id = mv_ce.icustay_id
left join mv_ie
  on ie.icustay_id = mv_ie.icustay_id
left join mv_de
  on ie.icustay_id = mv_de.icustay_id
left join mv_pe
  on ie.icustay_id = mv_pe.icustay_id
order by ie.icustay_id
  );",109348,Thread-1,2022-07-18T00:10:58.557344Z
E017,,debug,SQL status: SELECT 61532 in 1.92 seconds,109348,Thread-1,2022-07-18T00:11:00.477501Z
E015,,debug,"Using postgres connection ""model.mimic.rrt_first_day""",109348,Thread-1,2022-07-18T00:11:00.485496Z
E016,,debug,"On model.mimic.rrt_first_day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.rrt_first_day""} */
alter table ""postgres"".""public"".""rrt_first_day"" rename to ""rrt_first_day__dbt_backup""",109348,Thread-1,2022-07-18T00:11:00.486065Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:00.487561Z
E015,,debug,"Using postgres connection ""model.mimic.rrt_first_day""",109348,Thread-1,2022-07-18T00:11:00.491515Z
E016,,debug,"On model.mimic.rrt_first_day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.rrt_first_day""} */
alter table ""postgres"".""public"".""rrt_first_day__dbt_tmp"" rename to ""rrt_first_day""",109348,Thread-1,2022-07-18T00:11:00.491743Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:00.492537Z
E018,,debug,On model.mimic.rrt_first_day: COMMIT,109348,Thread-1,2022-07-18T00:11:00.496130Z
E015,,debug,"Using postgres connection ""model.mimic.rrt_first_day""",109348,Thread-1,2022-07-18T00:11:00.496467Z
E016,,debug,On model.mimic.rrt_first_day: COMMIT,109348,Thread-1,2022-07-18T00:11:00.496732Z
E017,,debug,SQL status: COMMIT in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:00.503602Z
E015,,debug,"Using postgres connection ""model.mimic.rrt_first_day""",109348,Thread-1,2022-07-18T00:11:00.505979Z
E016,,debug,"On model.mimic.rrt_first_day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.rrt_first_day""} */
drop table if exists ""postgres"".""public"".""rrt_first_day__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:11:00.506232Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:00.508311Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:00.511118Z
E010,,debug,On model.mimic.rrt_first_day: Close,109348,Thread-1,2022-07-18T00:11:00.511369Z
Q012,1,info,66 of 107 OK created table model public.rrt_first_day .......................... [[32mSELECT 61532[0m in 1.98s],109348,Thread-1,2022-07-18T00:11:00.512259Z,table,null,rrt_first_day,firstday/rrt_first_day.sql,2022-07-18T00:10:58.535019,compiling,model,,,
Q024,1.9758672714233398,debug,Finished running node model.mimic.rrt_first_day,109348,Thread-1,2022-07-18T00:11:00.512917Z,table,2022-07-18T00:11:00.512742,rrt_first_day,firstday/rrt_first_day.sql,2022-07-18T00:10:58.535019,success,model,,,
Q023,,debug,Began running node model.mimic.sbp,109348,Thread-1,2022-07-18T00:11:00.513286Z,table,null,sbp,cookbook/sbp.sql,2022-07-18T00:11:00.513263,started,model,,,
Q033,,info,67 of 107 START table model public.sbp ......................................... [RUN],109348,Thread-1,2022-07-18T00:11:00.514087Z,table,null,sbp,cookbook/sbp.sql,2022-07-18T00:11:00.513263,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.sbp""",109348,Thread-1,2022-07-18T00:11:00.514871Z
Q030,,debug,Began compiling node model.mimic.sbp,109348,Thread-1,2022-07-18T00:11:00.515201Z,table,null,sbp,cookbook/sbp.sql,2022-07-18T00:11:00.513263,compiling,model,,,
Q027,,debug,Compiling model.mimic.sbp,109348,Thread-1,2022-07-18T00:11:00.515675Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.sbp""",109348,Thread-1,2022-07-18T00:11:00.516912Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:00.517349Z
Q031,,debug,Began executing node model.mimic.sbp,109348,Thread-1,2022-07-18T00:11:00.517875Z,table,null,sbp,cookbook/sbp.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.sbp""",109348,Thread-1,2022-07-18T00:11:00.526647Z
E015,,debug,"Using postgres connection ""model.mimic.sbp""",109348,Thread-1,2022-07-18T00:11:00.527673Z
E016,,debug,On model.mimic.sbp: BEGIN,109348,Thread-1,2022-07-18T00:11:00.528338Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:11:00.529144Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:00.536882Z
E015,,debug,"Using postgres connection ""model.mimic.sbp""",109348,Thread-1,2022-07-18T00:11:00.537194Z
E016,,debug,"On model.mimic.sbp: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.sbp""} */


  create  table ""postgres"".""public"".""sbp__dbt_tmp""
  as (
    -- --------------------------------------------------------
-- Title: Retrieves the systolic blood pressure for adult patients
-- Notes: this query does not specify a schema. To run it on your local
-- MIMIC schema, run the following command:
--  SET SEARCH_PATH TO mimiciii
-- Where ""mimiciii"" is the name of your schema, and may be different.
-- --------------------------------------------------------

WITH agetbl AS
(
  SELECT ad.subject_id
  FROM admissions ad
  INNER JOIN patients p
  ON ad.subject_id = p.subject_id
  WHERE
  -- filter to only adults
  DATETIME_DIFF(ad.admittime, p.dob, 'YEAR') > 15
  -- group by subject_id to ensure there is only 1 subject_id per row
  group by ad.subject_id
)
, sysbp as
(
  SELECT width_bucket(valuenum, 0, 300, 300) AS bucket
  FROM chartevents ce
  INNER JOIN agetbl
  ON ce.subject_id = agetbl.subject_id
  WHERE itemid IN
  (
      6 -- ABP [Systolic]
    , 51 -- Arterial BP [Systolic]
    , 455 -- NBP [Systolic]
    , 6701 -- Arterial BP #2 [Systolic]
    , 220050 -- Arterial Blood Pressure systolic
    , 220179 -- Non Invasive Blood Pressure systolic
  )
)
SELECT bucket as systolic_blood_pressure, count(*)
FROM sysbp
GROUP BY bucket
ORDER BY bucket
  );",109348,Thread-1,2022-07-18T00:11:00.537335Z
E017,,debug,SQL status: SELECT 155 in 0.17 seconds,109348,Thread-1,2022-07-18T00:11:00.705441Z
E015,,debug,"Using postgres connection ""model.mimic.sbp""",109348,Thread-1,2022-07-18T00:11:00.715441Z
E016,,debug,"On model.mimic.sbp: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.sbp""} */
alter table ""postgres"".""public"".""sbp"" rename to ""sbp__dbt_backup""",109348,Thread-1,2022-07-18T00:11:00.715684Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:00.716453Z
E015,,debug,"Using postgres connection ""model.mimic.sbp""",109348,Thread-1,2022-07-18T00:11:00.720492Z
E016,,debug,"On model.mimic.sbp: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.sbp""} */
alter table ""postgres"".""public"".""sbp__dbt_tmp"" rename to ""sbp""",109348,Thread-1,2022-07-18T00:11:00.720731Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:00.721467Z
E018,,debug,On model.mimic.sbp: COMMIT,109348,Thread-1,2022-07-18T00:11:00.727593Z
E015,,debug,"Using postgres connection ""model.mimic.sbp""",109348,Thread-1,2022-07-18T00:11:00.728051Z
E016,,debug,On model.mimic.sbp: COMMIT,109348,Thread-1,2022-07-18T00:11:00.728382Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:00.730079Z
E015,,debug,"Using postgres connection ""model.mimic.sbp""",109348,Thread-1,2022-07-18T00:11:00.733715Z
E016,,debug,"On model.mimic.sbp: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.sbp""} */
drop table if exists ""postgres"".""public"".""sbp__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:11:00.734106Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:00.736426Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:00.739630Z
E010,,debug,On model.mimic.sbp: Close,109348,Thread-1,2022-07-18T00:11:00.739892Z
Q012,0,info,67 of 107 OK created table model public.sbp .................................... [[32mSELECT 155[0m in 0.23s],109348,Thread-1,2022-07-18T00:11:00.740965Z,table,null,sbp,cookbook/sbp.sql,2022-07-18T00:11:00.513263,compiling,model,,,
Q024,0.2259521484375,debug,Finished running node model.mimic.sbp,109348,Thread-1,2022-07-18T00:11:00.743271Z,table,2022-07-18T00:11:00.742837,sbp,cookbook/sbp.sql,2022-07-18T00:11:00.513263,success,model,,,
Q023,,debug,Began running node model.mimic.sodium,109348,Thread-1,2022-07-18T00:11:00.744255Z,table,null,sodium,cookbook/sodium.sql,2022-07-18T00:11:00.744167,started,model,,,
Q033,,info,68 of 107 START table model public.sodium ...................................... [RUN],109348,Thread-1,2022-07-18T00:11:00.745226Z,table,null,sodium,cookbook/sodium.sql,2022-07-18T00:11:00.744167,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.sodium""",109348,Thread-1,2022-07-18T00:11:00.746034Z
Q030,,debug,Began compiling node model.mimic.sodium,109348,Thread-1,2022-07-18T00:11:00.746274Z,table,null,sodium,cookbook/sodium.sql,2022-07-18T00:11:00.744167,compiling,model,,,
Q027,,debug,Compiling model.mimic.sodium,109348,Thread-1,2022-07-18T00:11:00.746541Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.sodium""",109348,Thread-1,2022-07-18T00:11:00.747576Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:00.747896Z
Q031,,debug,Began executing node model.mimic.sodium,109348,Thread-1,2022-07-18T00:11:00.748040Z,table,null,sodium,cookbook/sodium.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.sodium""",109348,Thread-1,2022-07-18T00:11:00.755333Z
E015,,debug,"Using postgres connection ""model.mimic.sodium""",109348,Thread-1,2022-07-18T00:11:00.755784Z
E016,,debug,On model.mimic.sodium: BEGIN,109348,Thread-1,2022-07-18T00:11:00.756057Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:11:00.756326Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:00.763954Z
E015,,debug,"Using postgres connection ""model.mimic.sodium""",109348,Thread-1,2022-07-18T00:11:00.764402Z
E016,,debug,"On model.mimic.sodium: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.sodium""} */


  create  table ""postgres"".""public"".""sodium__dbt_tmp""
  as (
    -- --------------------------------------------------------
-- Title: Retrieves the blood serum sodium levels for adult patients
-- Notes: this query does not specify a schema. To run it on your local
-- MIMIC schema, run the following command:
--  SET SEARCH_PATH TO mimiciii
-- Where ""mimiciii"" is the name of your schema, and may be different.
-- --------------------------------------------------------

WITH agetbl AS
(
  SELECT ad.subject_id
  FROM admissions ad
  INNER JOIN patients p
  ON ad.subject_id = p.subject_id
  WHERE
  -- filter to only adults
  DATETIME_DIFF(ad.admittime, p.dob, 'YEAR') > 15
  -- group by subject_id to ensure there is only 1 subject_id per row
  group by ad.subject_id
)
, sodium as
(
  SELECT width_bucket(valuenum, 0, 180, 180) AS bucket
  FROM labevents le
  INNER JOIN agetbl
  ON le.subject_id = agetbl.subject_id
  WHERE itemid IN (50824, 50983)
)
SELECT bucket as sodium, count(*)
FROM sodium
GROUP BY bucket
ORDER BY bucket
  );",109348,Thread-1,2022-07-18T00:11:00.764778Z
E017,,debug,SQL status: SELECT 0 in 0.16 seconds,109348,Thread-1,2022-07-18T00:11:00.922843Z
E015,,debug,"Using postgres connection ""model.mimic.sodium""",109348,Thread-1,2022-07-18T00:11:00.930471Z
E016,,debug,"On model.mimic.sodium: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.sodium""} */
alter table ""postgres"".""public"".""sodium"" rename to ""sodium__dbt_backup""",109348,Thread-1,2022-07-18T00:11:00.930933Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:00.931708Z
E015,,debug,"Using postgres connection ""model.mimic.sodium""",109348,Thread-1,2022-07-18T00:11:00.935583Z
E016,,debug,"On model.mimic.sodium: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.sodium""} */
alter table ""postgres"".""public"".""sodium__dbt_tmp"" rename to ""sodium""",109348,Thread-1,2022-07-18T00:11:00.935809Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:00.936578Z
E018,,debug,On model.mimic.sodium: COMMIT,109348,Thread-1,2022-07-18T00:11:00.940008Z
E015,,debug,"Using postgres connection ""model.mimic.sodium""",109348,Thread-1,2022-07-18T00:11:00.940250Z
E016,,debug,On model.mimic.sodium: COMMIT,109348,Thread-1,2022-07-18T00:11:00.940466Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:00.942270Z
E015,,debug,"Using postgres connection ""model.mimic.sodium""",109348,Thread-1,2022-07-18T00:11:00.944555Z
E016,,debug,"On model.mimic.sodium: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.sodium""} */
drop table if exists ""postgres"".""public"".""sodium__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:11:00.944794Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:00.946781Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:00.949513Z
E010,,debug,On model.mimic.sodium: Close,109348,Thread-1,2022-07-18T00:11:00.949900Z
Q012,0,info,68 of 107 OK created table model public.sodium ................................. [[32mSELECT 0[0m in 0.20s],109348,Thread-1,2022-07-18T00:11:00.950799Z,table,null,sodium,cookbook/sodium.sql,2022-07-18T00:11:00.744167,compiling,model,,,
Q024,0.20488548278808594,debug,Finished running node model.mimic.sodium,109348,Thread-1,2022-07-18T00:11:00.951415Z,table,2022-07-18T00:11:00.951247,sodium,cookbook/sodium.sql,2022-07-18T00:11:00.744167,success,model,,,
Q023,,debug,Began running node model.mimic.temp,109348,Thread-1,2022-07-18T00:11:00.951910Z,table,null,temp,cookbook/temp.sql,2022-07-18T00:11:00.951819,started,model,,,
Q033,,info,69 of 107 START table model public.temp ........................................ [RUN],109348,Thread-1,2022-07-18T00:11:00.952630Z,table,null,temp,cookbook/temp.sql,2022-07-18T00:11:00.951819,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.temp""",109348,Thread-1,2022-07-18T00:11:00.953274Z
Q030,,debug,Began compiling node model.mimic.temp,109348,Thread-1,2022-07-18T00:11:00.953559Z,table,null,temp,cookbook/temp.sql,2022-07-18T00:11:00.951819,compiling,model,,,
Q027,,debug,Compiling model.mimic.temp,109348,Thread-1,2022-07-18T00:11:00.953919Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.temp""",109348,Thread-1,2022-07-18T00:11:00.955189Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:00.955817Z
Q031,,debug,Began executing node model.mimic.temp,109348,Thread-1,2022-07-18T00:11:00.956511Z,table,null,temp,cookbook/temp.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.temp""",109348,Thread-1,2022-07-18T00:11:00.967027Z
E015,,debug,"Using postgres connection ""model.mimic.temp""",109348,Thread-1,2022-07-18T00:11:00.967742Z
E016,,debug,On model.mimic.temp: BEGIN,109348,Thread-1,2022-07-18T00:11:00.968040Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:11:00.968352Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:00.973934Z
E015,,debug,"Using postgres connection ""model.mimic.temp""",109348,Thread-1,2022-07-18T00:11:00.974818Z
E016,,debug,"On model.mimic.temp: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.temp""} */


  create  table ""postgres"".""public"".""temp__dbt_tmp""
  as (
    -- --------------------------------------------------------
-- Title: Retrieves the temperature of adult patients
-- Notes: this query does not specify a schema. To run it on your local
-- MIMIC schema, run the following command:
--  SET SEARCH_PATH TO mimiciii
-- Where ""mimiciii"" is the name of your schema, and may be different.
-- --------------------------------------------------------

WITH agetbl AS
(
  SELECT ad.subject_id
  FROM admissions ad
  INNER JOIN patients p
  ON ad.subject_id = p.subject_id
  WHERE
  -- filter to only adults
  DATETIME_DIFF(ad.admittime, p.dob, 'YEAR') > 15
  -- group by subject_id to ensure there is only 1 subject_id per row
  group by ad.subject_id
)
, temp as
(
  SELECT width_bucket(
      CASE
        WHEN itemid IN (223762, 676, 677) THEN valuenum -- celsius
        WHEN itemid IN (223761, 678, 679) THEN (valuenum - 32) * 5 / 9 --fahrenheit
      END
    , 30, 45, 160) AS bucket
  FROM chartevents ce
  INNER JOIN agetbl
  ON ce.subject_id = agetbl.subject_id
  WHERE itemid IN
  (
      676 -- Temperature C
    , 677 -- Temperature C (calc)
    , 678 -- Temperature F
    , 679 -- Temperature F (calc)
    , 223761 -- Temperature Fahrenheit
    , 223762 -- Temperature Celsius
  )
)
SELECT round((cast(bucket as numeric)/10) + 30,2) as temperature, count(*)
FROM temp
GROUP BY bucket
ORDER BY bucket
  );",109348,Thread-1,2022-07-18T00:11:00.975199Z
E017,,debug,SQL status: SELECT 30 in 0.17 seconds,109348,Thread-1,2022-07-18T00:11:01.143135Z
E015,,debug,"Using postgres connection ""model.mimic.temp""",109348,Thread-1,2022-07-18T00:11:01.150175Z
E016,,debug,"On model.mimic.temp: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.temp""} */
alter table ""postgres"".""public"".""temp"" rename to ""temp__dbt_backup""",109348,Thread-1,2022-07-18T00:11:01.150443Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:01.151222Z
E015,,debug,"Using postgres connection ""model.mimic.temp""",109348,Thread-1,2022-07-18T00:11:01.154981Z
E016,,debug,"On model.mimic.temp: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.temp""} */
alter table ""postgres"".""public"".""temp__dbt_tmp"" rename to ""temp""",109348,Thread-1,2022-07-18T00:11:01.155215Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:01.155965Z
E018,,debug,On model.mimic.temp: COMMIT,109348,Thread-1,2022-07-18T00:11:01.159637Z
E015,,debug,"Using postgres connection ""model.mimic.temp""",109348,Thread-1,2022-07-18T00:11:01.159865Z
E016,,debug,On model.mimic.temp: COMMIT,109348,Thread-1,2022-07-18T00:11:01.160091Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:01.163276Z
E015,,debug,"Using postgres connection ""model.mimic.temp""",109348,Thread-1,2022-07-18T00:11:01.166165Z
E016,,debug,"On model.mimic.temp: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.temp""} */
drop table if exists ""postgres"".""public"".""temp__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:11:01.166432Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:01.168696Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:01.171616Z
E010,,debug,On model.mimic.temp: Close,109348,Thread-1,2022-07-18T00:11:01.171871Z
Q012,0,info,69 of 107 OK created table model public.temp ................................... [[32mSELECT 30[0m in 0.22s],109348,Thread-1,2022-07-18T00:11:01.172796Z,table,null,temp,cookbook/temp.sql,2022-07-18T00:11:00.951819,compiling,model,,,
Q024,0.21956849098205566,debug,Finished running node model.mimic.temp,109348,Thread-1,2022-07-18T00:11:01.173393Z,table,2022-07-18T00:11:01.173263,temp,cookbook/temp.sql,2022-07-18T00:11:00.951819,success,model,,,
Q023,,debug,Began running node model.mimic.uo,109348,Thread-1,2022-07-18T00:11:01.173730Z,table,null,uo,cookbook/uo.sql,2022-07-18T00:11:01.173619,started,model,,,
Q033,,info,70 of 107 START table model public.uo .......................................... [RUN],109348,Thread-1,2022-07-18T00:11:01.174430Z,table,null,uo,cookbook/uo.sql,2022-07-18T00:11:01.173619,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.uo""",109348,Thread-1,2022-07-18T00:11:01.175286Z
Q030,,debug,Began compiling node model.mimic.uo,109348,Thread-1,2022-07-18T00:11:01.175579Z,table,null,uo,cookbook/uo.sql,2022-07-18T00:11:01.173619,compiling,model,,,
Q027,,debug,Compiling model.mimic.uo,109348,Thread-1,2022-07-18T00:11:01.175905Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.uo""",109348,Thread-1,2022-07-18T00:11:01.177189Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:01.177753Z
Q031,,debug,Began executing node model.mimic.uo,109348,Thread-1,2022-07-18T00:11:01.178120Z,table,null,uo,cookbook/uo.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.uo""",109348,Thread-1,2022-07-18T00:11:01.186629Z
E015,,debug,"Using postgres connection ""model.mimic.uo""",109348,Thread-1,2022-07-18T00:11:01.187422Z
E016,,debug,On model.mimic.uo: BEGIN,109348,Thread-1,2022-07-18T00:11:01.187766Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:11:01.187974Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:01.195022Z
E015,,debug,"Using postgres connection ""model.mimic.uo""",109348,Thread-1,2022-07-18T00:11:01.195328Z
E016,,debug,"On model.mimic.uo: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.uo""} */


  create  table ""postgres"".""public"".""uo__dbt_tmp""
  as (
    -- --------------------------------------------------------
-- Title: Retrieves the urine output of adult patients
-- Notes: this query does not specify a schema. To run it on your local
-- MIMIC schema, run the following command:
--  SET SEARCH_PATH TO mimiciii
-- Where ""mimiciii"" is the name of your schema, and may be different.
-- --------------------------------------------------------

WITH agetbl AS
(
  SELECT ie.icustay_id, ie.intime
  FROM icustays ie
  INNER JOIN patients p
  ON ie.subject_id = p.subject_id
  WHERE
  -- filter to only adults
  DATETIME_DIFF(ie.intime, p.dob, 'YEAR') > 15
)
-- Urine output is measured hourly, but the individual values are not of interest
-- Usually, you want an overall picture of patient output
-- This query sums the data over the first 24 hours
, uo_sum as
(
  select oe.icustay_id, sum(oe.VALUE) as urineoutput
  FROM outputevents oe
  INNER JOIN agetbl
  ON oe.icustay_id = agetbl.icustay_id
  -- and ensure the data occurs during the first day
  and oe.charttime between agetbl.intime and (DATETIME_ADD(agetbl.intime, INTERVAL '1' DAY)) -- first ICU day
  WHERE itemid IN
  (
  -- these are the most frequently occurring urine output observations in CareVue
  40055, -- ""Urine Out Foley""
  43175, -- ""Urine .""
  40069, -- ""Urine Out Void""
  40094, -- ""Urine Out Condom Cath""
  40715, -- ""Urine Out Suprapubic""
  40473, -- ""Urine Out IleoConduit""
  40085, -- ""Urine Out Incontinent""
  40057, -- ""Urine Out Rt Nephrostomy""
  40056, -- ""Urine Out Lt Nephrostomy""
  40405, -- ""Urine Out Other""
  40428, -- ""Urine Out Straight Cath""
  40086,--	Urine Out Incontinent
  40096, -- ""Urine Out Ureteral Stent #1""
  40651, -- ""Urine Out Ureteral Stent #2""

  -- these are the most frequently occurring urine output observations in Metavision
  226559, -- ""Foley""
  226560, -- ""Void""
  227510, -- ""TF Residual""
  226561, -- ""Condom Cath""
  226584, -- ""Ileoconduit""
  226563, -- ""Suprapubic""
  226564, -- ""R Nephrostomy""
  226565, -- ""L Nephrostomy""
  226567, --	Straight Cath
  226557, -- ""R Ureteral Stent""
  226558  -- ""L Ureteral Stent""
  )
  group by oe.icustay_id
)
, uo as
(
  SELECT width_bucket(urineoutput, 0, 5000, 50) AS bucket
  FROM uo_sum
)
SELECT bucket*100 as UrineOutput, COUNT(*)
FROM uo
GROUP BY bucket
ORDER BY bucket
  );",109348,Thread-1,2022-07-18T00:11:01.195618Z
E017,,debug,SQL status: SELECT 53 in 3.21 seconds,109348,Thread-1,2022-07-18T00:11:04.408266Z
E015,,debug,"Using postgres connection ""model.mimic.uo""",109348,Thread-1,2022-07-18T00:11:04.414700Z
E016,,debug,"On model.mimic.uo: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.uo""} */
alter table ""postgres"".""public"".""uo"" rename to ""uo__dbt_backup""",109348,Thread-1,2022-07-18T00:11:04.414940Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:04.415774Z
E015,,debug,"Using postgres connection ""model.mimic.uo""",109348,Thread-1,2022-07-18T00:11:04.419605Z
E016,,debug,"On model.mimic.uo: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.uo""} */
alter table ""postgres"".""public"".""uo__dbt_tmp"" rename to ""uo""",109348,Thread-1,2022-07-18T00:11:04.419828Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:04.420576Z
E018,,debug,On model.mimic.uo: COMMIT,109348,Thread-1,2022-07-18T00:11:04.423911Z
E015,,debug,"Using postgres connection ""model.mimic.uo""",109348,Thread-1,2022-07-18T00:11:04.424137Z
E016,,debug,On model.mimic.uo: COMMIT,109348,Thread-1,2022-07-18T00:11:04.424386Z
E017,,debug,SQL status: COMMIT in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:04.433859Z
E015,,debug,"Using postgres connection ""model.mimic.uo""",109348,Thread-1,2022-07-18T00:11:04.436937Z
E016,,debug,"On model.mimic.uo: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.uo""} */
drop table if exists ""postgres"".""public"".""uo__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:11:04.437195Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:04.438955Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:04.441531Z
E010,,debug,On model.mimic.uo: Close,109348,Thread-1,2022-07-18T00:11:04.442012Z
Q012,3,info,70 of 107 OK created table model public.uo ..................................... [[32mSELECT 53[0m in 3.27s],109348,Thread-1,2022-07-18T00:11:04.443091Z,table,null,uo,cookbook/uo.sql,2022-07-18T00:11:01.173619,compiling,model,,,
Q024,3.267932176589966,debug,Finished running node model.mimic.uo,109348,Thread-1,2022-07-18T00:11:04.443891Z,table,2022-07-18T00:11:04.443682,uo,cookbook/uo.sql,2022-07-18T00:11:01.173619,success,model,,,
Q023,,debug,Began running node model.mimic.urine_output,109348,Thread-1,2022-07-18T00:11:04.444511Z,table,null,urine_output,fluid_balance/urine_output.sql,2022-07-18T00:11:04.444410,started,model,,,
Q033,,info,71 of 107 START table model public.urine_output ................................ [RUN],109348,Thread-1,2022-07-18T00:11:04.445212Z,table,null,urine_output,fluid_balance/urine_output.sql,2022-07-18T00:11:04.444410,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.urine_output""",109348,Thread-1,2022-07-18T00:11:04.446238Z
Q030,,debug,Began compiling node model.mimic.urine_output,109348,Thread-1,2022-07-18T00:11:04.446861Z,table,null,urine_output,fluid_balance/urine_output.sql,2022-07-18T00:11:04.444410,compiling,model,,,
Q027,,debug,Compiling model.mimic.urine_output,109348,Thread-1,2022-07-18T00:11:04.447299Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.urine_output""",109348,Thread-1,2022-07-18T00:11:04.448891Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:04.449543Z
Q031,,debug,Began executing node model.mimic.urine_output,109348,Thread-1,2022-07-18T00:11:04.450543Z,table,null,urine_output,fluid_balance/urine_output.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.urine_output""",109348,Thread-1,2022-07-18T00:11:04.463683Z
E015,,debug,"Using postgres connection ""model.mimic.urine_output""",109348,Thread-1,2022-07-18T00:11:04.464323Z
E016,,debug,On model.mimic.urine_output: BEGIN,109348,Thread-1,2022-07-18T00:11:04.464569Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:11:04.464769Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:04.471789Z
E015,,debug,"Using postgres connection ""model.mimic.urine_output""",109348,Thread-1,2022-07-18T00:11:04.472106Z
E016,,debug,"On model.mimic.urine_output: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.urine_output""} */


  create  table ""postgres"".""public"".""urine_output__dbt_tmp""
  as (
    -- First we drop the table if it exists
select oe.icustay_id, oe.charttime
, SUM(
    -- we consider input of GU irrigant as a negative volume
    case when oe.itemid = 227488 then -1*value
    else value end
  ) as value
from outputevents oe
where oe.itemid in
(
  -- these are the most frequently occurring urine output observations in CareVue
  40055, -- ""Urine Out Foley""
  43175, -- ""Urine .""
  40069, -- ""Urine Out Void""
  40094, -- ""Urine Out Condom Cath""
  40715, -- ""Urine Out Suprapubic""
  40473, -- ""Urine Out IleoConduit""
  40085, -- ""Urine Out Incontinent""
  40057, -- ""Urine Out Rt Nephrostomy""
  40056, -- ""Urine Out Lt Nephrostomy""
  40405, -- ""Urine Out Other""
  40428, -- ""Urine Out Straight Cath""
  40086,--	Urine Out Incontinent
  40096, -- ""Urine Out Ureteral Stent #1""
  40651, -- ""Urine Out Ureteral Stent #2""

  -- these are the most frequently occurring urine output observations in MetaVision
  226559, -- ""Foley""
  226560, -- ""Void""
  226561, -- ""Condom Cath""
  226584, -- ""Ileoconduit""
  226563, -- ""Suprapubic""
  226564, -- ""R Nephrostomy""
  226565, -- ""L Nephrostomy""
  226567, --	Straight Cath
  226557, -- R Ureteral Stent
  226558, -- L Ureteral Stent
  227488, -- GU Irrigant Volume In
  227489  -- GU Irrigant/Urine Volume Out
)
and oe.value < 5000 -- sanity check on urine value
and oe.icustay_id is not null
group by icustay_id, charttime
  );",109348,Thread-1,2022-07-18T00:11:04.472568Z
E017,,debug,SQL status: SELECT 3361794 in 3.12 seconds,109348,Thread-1,2022-07-18T00:11:07.592871Z
E015,,debug,"Using postgres connection ""model.mimic.urine_output""",109348,Thread-1,2022-07-18T00:11:07.597238Z
E016,,debug,"On model.mimic.urine_output: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.urine_output""} */
alter table ""postgres"".""public"".""urine_output"" rename to ""urine_output__dbt_backup""",109348,Thread-1,2022-07-18T00:11:07.597495Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:07.600959Z
E015,,debug,"Using postgres connection ""model.mimic.urine_output""",109348,Thread-1,2022-07-18T00:11:07.604963Z
E016,,debug,"On model.mimic.urine_output: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.urine_output""} */
alter table ""postgres"".""public"".""urine_output__dbt_tmp"" rename to ""urine_output""",109348,Thread-1,2022-07-18T00:11:07.605203Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:07.606094Z
E018,,debug,On model.mimic.urine_output: COMMIT,109348,Thread-1,2022-07-18T00:11:07.609206Z
E015,,debug,"Using postgres connection ""model.mimic.urine_output""",109348,Thread-1,2022-07-18T00:11:07.609429Z
E016,,debug,On model.mimic.urine_output: COMMIT,109348,Thread-1,2022-07-18T00:11:07.609539Z
E017,,debug,SQL status: COMMIT in 0.03 seconds,109348,Thread-1,2022-07-18T00:11:07.635322Z
E015,,debug,"Using postgres connection ""model.mimic.urine_output""",109348,Thread-1,2022-07-18T00:11:07.638456Z
E016,,debug,"On model.mimic.urine_output: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.urine_output""} */
drop table if exists ""postgres"".""public"".""urine_output__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:11:07.638923Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:07.643535Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:07.646718Z
E010,,debug,On model.mimic.urine_output: Close,109348,Thread-1,2022-07-18T00:11:07.647150Z
Q012,3,info,71 of 107 OK created table model public.urine_output ........................... [[32mSELECT 3361794[0m in 3.20s],109348,Thread-1,2022-07-18T00:11:07.648084Z,table,null,urine_output,fluid_balance/urine_output.sql,2022-07-18T00:11:04.444410,compiling,model,,,
Q024,3.202108383178711,debug,Finished running node model.mimic.urine_output,109348,Thread-1,2022-07-18T00:11:07.648737Z,table,2022-07-18T00:11:07.648559,urine_output,fluid_balance/urine_output.sql,2022-07-18T00:11:04.444410,success,model,,,
Q023,,debug,Began running node model.mimic.urine_output_first_day,109348,Thread-1,2022-07-18T00:11:07.649197Z,table,null,urine_output_first_day,firstday/urine_output_first_day.sql,2022-07-18T00:11:07.649144,started,model,,,
Q033,,info,72 of 107 START table model public.urine_output_first_day ...................... [RUN],109348,Thread-1,2022-07-18T00:11:07.649633Z,table,null,urine_output_first_day,firstday/urine_output_first_day.sql,2022-07-18T00:11:07.649144,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.urine_output_first_day""",109348,Thread-1,2022-07-18T00:11:07.650835Z
Q030,,debug,Began compiling node model.mimic.urine_output_first_day,109348,Thread-1,2022-07-18T00:11:07.651243Z,table,null,urine_output_first_day,firstday/urine_output_first_day.sql,2022-07-18T00:11:07.649144,compiling,model,,,
Q027,,debug,Compiling model.mimic.urine_output_first_day,109348,Thread-1,2022-07-18T00:11:07.651587Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.urine_output_first_day""",109348,Thread-1,2022-07-18T00:11:07.652834Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:07.653544Z
Q031,,debug,Began executing node model.mimic.urine_output_first_day,109348,Thread-1,2022-07-18T00:11:07.653999Z,table,null,urine_output_first_day,firstday/urine_output_first_day.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.urine_output_first_day""",109348,Thread-1,2022-07-18T00:11:07.663992Z
E015,,debug,"Using postgres connection ""model.mimic.urine_output_first_day""",109348,Thread-1,2022-07-18T00:11:07.664631Z
E016,,debug,On model.mimic.urine_output_first_day: BEGIN,109348,Thread-1,2022-07-18T00:11:07.664977Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:11:07.665196Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:07.672438Z
E015,,debug,"Using postgres connection ""model.mimic.urine_output_first_day""",109348,Thread-1,2022-07-18T00:11:07.672894Z
E016,,debug,"On model.mimic.urine_output_first_day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.urine_output_first_day""} */


  create  table ""postgres"".""public"".""urine_output_first_day__dbt_tmp""
  as (
    -- ------------------------------------------------------------------
-- Purpose: Create a view of the urine output for each ICUSTAY_ID over the first 24 hours.
-- ------------------------------------------------------------------

select
  -- patient identifiers
  ie.subject_id, ie.hadm_id, ie.icustay_id

  -- volumes associated with urine output ITEMIDs
  , sum(
      -- we consider input of GU irrigant as a negative volume
      case
        when oe.itemid = 227488 and oe.value > 0 then -1*oe.value
        else oe.value
    end) as urineoutput
FROM icustays ie
-- Join to the outputevents table to get urine output
left join outputevents oe
-- join on all patient identifiers
on ie.subject_id = oe.subject_id and ie.hadm_id = oe.hadm_id and ie.icustay_id = oe.icustay_id
-- and ensure the data occurs during the first day
and oe.charttime between ie.intime and (DATETIME_ADD(ie.intime, INTERVAL '1' DAY)) -- first ICU day
where itemid in
(
-- these are the most frequently occurring urine output observations in CareVue
40055, -- ""Urine Out Foley""
43175, -- ""Urine .""
40069, -- ""Urine Out Void""
40094, -- ""Urine Out Condom Cath""
40715, -- ""Urine Out Suprapubic""
40473, -- ""Urine Out IleoConduit""
40085, -- ""Urine Out Incontinent""
40057, -- ""Urine Out Rt Nephrostomy""
40056, -- ""Urine Out Lt Nephrostomy""
40405, -- ""Urine Out Other""
40428, -- ""Urine Out Straight Cath""
40086,--	Urine Out Incontinent
40096, -- ""Urine Out Ureteral Stent #1""
40651, -- ""Urine Out Ureteral Stent #2""

-- these are the most frequently occurring urine output observations in MetaVision
226559, -- ""Foley""
226560, -- ""Void""
226561, -- ""Condom Cath""
226584, -- ""Ileoconduit""
226563, -- ""Suprapubic""
226564, -- ""R Nephrostomy""
226565, -- ""L Nephrostomy""
226567, --	Straight Cath
226557, -- R Ureteral Stent
226558, -- L Ureteral Stent
227488, -- GU Irrigant Volume In
227489  -- GU Irrigant/Urine Volume Out
)
group by ie.subject_id, ie.hadm_id, ie.icustay_id
order by ie.subject_id, ie.hadm_id, ie.icustay_id
  );",109348,Thread-1,2022-07-18T00:11:07.673155Z
E017,,debug,SQL status: SELECT 53359 in 3.21 seconds,109348,Thread-1,2022-07-18T00:11:10.886854Z
E015,,debug,"Using postgres connection ""model.mimic.urine_output_first_day""",109348,Thread-1,2022-07-18T00:11:10.893528Z
E016,,debug,"On model.mimic.urine_output_first_day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.urine_output_first_day""} */
alter table ""postgres"".""public"".""urine_output_first_day"" rename to ""urine_output_first_day__dbt_backup""",109348,Thread-1,2022-07-18T00:11:10.894107Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:10.895470Z
E015,,debug,"Using postgres connection ""model.mimic.urine_output_first_day""",109348,Thread-1,2022-07-18T00:11:10.900479Z
E016,,debug,"On model.mimic.urine_output_first_day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.urine_output_first_day""} */
alter table ""postgres"".""public"".""urine_output_first_day__dbt_tmp"" rename to ""urine_output_first_day""",109348,Thread-1,2022-07-18T00:11:10.900697Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:10.901455Z
E018,,debug,On model.mimic.urine_output_first_day: COMMIT,109348,Thread-1,2022-07-18T00:11:10.904327Z
E015,,debug,"Using postgres connection ""model.mimic.urine_output_first_day""",109348,Thread-1,2022-07-18T00:11:10.904534Z
E016,,debug,On model.mimic.urine_output_first_day: COMMIT,109348,Thread-1,2022-07-18T00:11:10.904790Z
E017,,debug,SQL status: COMMIT in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:10.911441Z
E015,,debug,"Using postgres connection ""model.mimic.urine_output_first_day""",109348,Thread-1,2022-07-18T00:11:10.914412Z
E016,,debug,"On model.mimic.urine_output_first_day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.urine_output_first_day""} */
drop table if exists ""postgres"".""public"".""urine_output_first_day__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:11:10.914723Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:10.916769Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:10.919804Z
E010,,debug,On model.mimic.urine_output_first_day: Close,109348,Thread-1,2022-07-18T00:11:10.920059Z
Q012,3,info,72 of 107 OK created table model public.urine_output_first_day ................. [[32mSELECT 53359[0m in 3.27s],109348,Thread-1,2022-07-18T00:11:10.920963Z,table,null,urine_output_first_day,firstday/urine_output_first_day.sql,2022-07-18T00:11:07.649144,compiling,model,,,
Q024,3.2703359127044678,debug,Finished running node model.mimic.urine_output_first_day,109348,Thread-1,2022-07-18T00:11:10.921664Z,table,2022-07-18T00:11:10.921445,urine_output_first_day,firstday/urine_output_first_day.sql,2022-07-18T00:11:07.649144,success,model,,,
Q023,,debug,Began running node model.mimic.vasopressin_dose,109348,Thread-1,2022-07-18T00:11:10.922180Z,table,null,vasopressin_dose,durations/vasopressin_dose.sql,2022-07-18T00:11:10.922085,started,model,,,
Q033,,info,73 of 107 START table model public.vasopressin_dose ............................ [RUN],109348,Thread-1,2022-07-18T00:11:10.922937Z,table,null,vasopressin_dose,durations/vasopressin_dose.sql,2022-07-18T00:11:10.922085,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.vasopressin_dose""",109348,Thread-1,2022-07-18T00:11:10.923986Z
Q030,,debug,Began compiling node model.mimic.vasopressin_dose,109348,Thread-1,2022-07-18T00:11:10.924247Z,table,null,vasopressin_dose,durations/vasopressin_dose.sql,2022-07-18T00:11:10.922085,compiling,model,,,
Q027,,debug,Compiling model.mimic.vasopressin_dose,109348,Thread-1,2022-07-18T00:11:10.924655Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.vasopressin_dose""",109348,Thread-1,2022-07-18T00:11:10.926980Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:10.927937Z
Q031,,debug,Began executing node model.mimic.vasopressin_dose,109348,Thread-1,2022-07-18T00:11:10.928353Z,table,null,vasopressin_dose,durations/vasopressin_dose.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.vasopressin_dose""",109348,Thread-1,2022-07-18T00:11:10.941256Z
E015,,debug,"Using postgres connection ""model.mimic.vasopressin_dose""",109348,Thread-1,2022-07-18T00:11:10.941974Z
E016,,debug,On model.mimic.vasopressin_dose: BEGIN,109348,Thread-1,2022-07-18T00:11:10.942239Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:11:10.942442Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:10.948794Z
E015,,debug,"Using postgres connection ""model.mimic.vasopressin_dose""",109348,Thread-1,2022-07-18T00:11:10.949475Z
E016,,debug,"On model.mimic.vasopressin_dose: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.vasopressin_dose""} */


  create  table ""postgres"".""public"".""vasopressin_dose__dbt_tmp""
  as (
    -- This query extracts dose+durations of vasopressin administration

-- Get drug administration data from CareVue first
with vasocv1 as
(
    select
    icustay_id, charttime
    -- case statement determining whether the ITEMID is an instance of vasopressor usage
    , max(case when itemid = 30051 then 1 else 0 end) as vaso -- vasopressin

    -- the 'stopped' column indicates if a vasopressor has been disconnected
    , max(case when itemid = 30051 and (stopped = 'Stopped' OR stopped like 'D/C%') then 1
          else 0 end) as vaso_stopped

    , max(case when itemid = 30051 and rate is not null then 1 else 0 end) as vaso_null
    , max(case when itemid = 30051 then rate else null end) as vaso_rate
    , max(case when itemid = 30051 then amount else null end) as vaso_amount

  FROM inputevents_cv
  where itemid = 30051 -- vasopressin
  group by icustay_id, charttime
)
, vasocv2 as
(
  select v.*
    , sum(vaso_null) over (partition by icustay_id order by charttime) as vaso_partition
  from
    vasocv1 v
)
, vasocv3 as
(
  select v.*
    , first_value(vaso_rate) over (partition by icustay_id, vaso_partition order by charttime) as vaso_prevrate_ifnull
  from
    vasocv2 v
)
, vasocv4 as
(
select
    icustay_id
    , charttime
    -- , (CHARTTIME - (LAG(CHARTTIME, 1) OVER (partition by icustay_id, vaso order by charttime))) AS delta

    , vaso
    , vaso_rate
    , vaso_amount
    , vaso_stopped
    , vaso_prevrate_ifnull

    -- We define start time here
    , case
        when vaso = 0 then null

        -- if this is the first instance of the vasoactive drug
        when vaso_rate > 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso, vaso_null
          order by charttime
          )
          is null
          then 1

        -- you often get a string of 0s
        -- we decide not to set these as 1, just because it makes vasonum sequential
        when vaso_rate = 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 0
          then 0

        -- sometimes you get a string of NULL, associated with 0 volumes
        -- same reason as before, we decide not to set these as 1
        -- vaso_prevrate_ifnull is equal to the previous value *iff* the current value is null
        when vaso_prevrate_ifnull = 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 0
          then 0

        -- If the last recorded rate was 0, newvaso = 1
        when LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          ) = 0
          then 1

        -- If the last recorded vaso was D/C'd, newvaso = 1
        when
          LAG(vaso_stopped,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 1 then 1

        -- ** not sure if the below is needed
        --when (CHARTTIME - (LAG(CHARTTIME, 1) OVER (partition by icustay_id, vaso order by charttime))) > (interval '4 hours') then 1
      else null
      end as vaso_start

FROM
  vasocv3
)
-- propagate start/stop flags forward in time
, vasocv5 as
(
  select v.*
    , SUM(vaso_start) OVER (partition by icustay_id, vaso order by charttime) as vaso_first
FROM
  vasocv4 v
)
, vasocv6 as
(
  select v.*
    -- We define end time here
    , case
        when vaso = 0
          then null

        -- If the recorded vaso was D/C'd, this is an end time
        when vaso_stopped = 1
          then vaso_first

        -- If the rate is zero, this is the end time
        when vaso_rate = 0
          then vaso_first

        -- the last row in the table is always a potential end time
        -- this captures patients who die/are discharged while on vasopressors
        -- in principle, this could add an extra end time for the vasopressor
        -- however, since we later group on vaso_start, any extra end times are ignored
        when LEAD(CHARTTIME,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          ) is null
          then vaso_first

        else null
        end as vaso_stop
    from vasocv5 v
)

-- -- if you want to look at the results of the table before grouping:
-- select
--   icustay_id, charttime, vaso, vaso_rate, vaso_amount
--     , vaso_stopped
--     , vaso_start
--     , vaso_first
--     , vaso_stop
-- from vasocv6 order by icustay_id, charttime

, vasocv7 as
(
select
  icustay_id
  , charttime as starttime
  , lead(charttime) OVER (partition by icustay_id, vaso_first order by charttime) as endtime
  , vaso, vaso_rate, vaso_amount, vaso_stop, vaso_start, vaso_first
from vasocv6
where
  vaso_first is not null -- bogus data
and
  vaso_first != 0 -- sometimes *only* a rate of 0 appears, i.e. the drug is never actually delivered
and
  icustay_id is not null -- there are data for ""floating"" admissions, we don't worry about these
)
-- table of start/stop times for event
, vasocv8 as
(
  select
    icustay_id
    , starttime, endtime
    , vaso, vaso_rate, vaso_amount, vaso_stop, vaso_start, vaso_first
  from vasocv7
  where endtime is not null
  and vaso_rate > 0
  and starttime != endtime
)
-- collapse these start/stop times down if the rate doesn't change
, vasocv9 as
(
  select
    icustay_id
    , starttime, endtime
    , case
        when LAG(endtime) OVER (partition by icustay_id order by starttime, endtime) = starttime
        AND  LAG(vaso_rate) OVER (partition by icustay_id order by starttime, endtime) = vaso_rate
        THEN 0
      else 1
    end as vaso_groups
    , vaso, vaso_rate, vaso_amount, vaso_stop, vaso_start, vaso_first
  from vasocv8
  where endtime is not null
  and vaso_rate > 0
  and starttime != endtime
)
, vasocv10 as
(
  select
    icustay_id
    , starttime, endtime
    , vaso_groups
    , SUM(vaso_groups) OVER (partition by icustay_id order by starttime, endtime) as vaso_groups_sum
    , vaso, vaso_rate, vaso_amount, vaso_stop, vaso_start, vaso_first
  from vasocv9
)
, vasocv as
(
  select icustay_id
  , min(starttime) as starttime
  , max(endtime) as endtime
  , vaso_groups_sum
  , vaso_rate
  , sum(vaso_amount) as vaso_amount
  from vasocv10
  group by icustay_id, vaso_groups_sum, vaso_rate
)
-- now we extract the associated data for metavision patients
, vasomv as
(
  select
    icustay_id, linkorderid
    -- , CASE WHEN valueuom = 'units/min' THEN rate*60.0 ELSE rate END as vaso_rate
    , rate as vaso_rate
    , amount as vaso_amount
    , starttime
    , endtime
  from inputevents_mv
  where itemid = 222315 -- vasopressin
  and statusdescription != 'Rewritten' -- only valid orders
)
-- now assign this data to every hour of the patient's stay
-- vaso_amount for carevue is not accurate
SELECT icustay_id
  , starttime, endtime
  , vaso_rate, vaso_amount
from vasocv
UNION ALL
SELECT icustay_id
  , starttime, endtime
  , vaso_rate, vaso_amount
from vasomv
order by icustay_id, starttime
  );",109348,Thread-1,2022-07-18T00:11:10.949910Z
E017,,debug,SQL status: SELECT 10537 in 2.06 seconds,109348,Thread-1,2022-07-18T00:11:13.007914Z
E015,,debug,"Using postgres connection ""model.mimic.vasopressin_dose""",109348,Thread-1,2022-07-18T00:11:13.018076Z
E016,,debug,"On model.mimic.vasopressin_dose: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.vasopressin_dose""} */
alter table ""postgres"".""public"".""vasopressin_dose"" rename to ""vasopressin_dose__dbt_backup""",109348,Thread-1,2022-07-18T00:11:13.018334Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:13.019185Z
E015,,debug,"Using postgres connection ""model.mimic.vasopressin_dose""",109348,Thread-1,2022-07-18T00:11:13.023182Z
E016,,debug,"On model.mimic.vasopressin_dose: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.vasopressin_dose""} */
alter table ""postgres"".""public"".""vasopressin_dose__dbt_tmp"" rename to ""vasopressin_dose""",109348,Thread-1,2022-07-18T00:11:13.023430Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:13.024147Z
E018,,debug,On model.mimic.vasopressin_dose: COMMIT,109348,Thread-1,2022-07-18T00:11:13.027523Z
E015,,debug,"Using postgres connection ""model.mimic.vasopressin_dose""",109348,Thread-1,2022-07-18T00:11:13.027753Z
E016,,debug,On model.mimic.vasopressin_dose: COMMIT,109348,Thread-1,2022-07-18T00:11:13.027993Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:13.030238Z
E015,,debug,"Using postgres connection ""model.mimic.vasopressin_dose""",109348,Thread-1,2022-07-18T00:11:13.032710Z
E016,,debug,"On model.mimic.vasopressin_dose: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.vasopressin_dose""} */
drop table if exists ""postgres"".""public"".""vasopressin_dose__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:11:13.032939Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:13.035415Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:13.038823Z
E010,,debug,On model.mimic.vasopressin_dose: Close,109348,Thread-1,2022-07-18T00:11:13.039079Z
Q012,2,info,73 of 107 OK created table model public.vasopressin_dose ....................... [[32mSELECT 10537[0m in 2.12s],109348,Thread-1,2022-07-18T00:11:13.039986Z,table,null,vasopressin_dose,durations/vasopressin_dose.sql,2022-07-18T00:11:10.922085,compiling,model,,,
Q024,2.1162631511688232,debug,Finished running node model.mimic.vasopressin_dose,109348,Thread-1,2022-07-18T00:11:13.040628Z,table,2022-07-18T00:11:13.040458,vasopressin_dose,durations/vasopressin_dose.sql,2022-07-18T00:11:10.922085,success,model,,,
Q023,,debug,Began running node model.mimic.vasopressin_durations,109348,Thread-1,2022-07-18T00:11:13.041132Z,table,null,vasopressin_durations,durations/vasopressin_durations.sql,2022-07-18T00:11:13.041071,started,model,,,
Q033,,info,74 of 107 START table model public.vasopressin_durations ....................... [RUN],109348,Thread-1,2022-07-18T00:11:13.041837Z,table,null,vasopressin_durations,durations/vasopressin_durations.sql,2022-07-18T00:11:13.041071,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.vasopressin_durations""",109348,Thread-1,2022-07-18T00:11:13.042614Z
Q030,,debug,Began compiling node model.mimic.vasopressin_durations,109348,Thread-1,2022-07-18T00:11:13.043148Z,table,null,vasopressin_durations,durations/vasopressin_durations.sql,2022-07-18T00:11:13.041071,compiling,model,,,
Q027,,debug,Compiling model.mimic.vasopressin_durations,109348,Thread-1,2022-07-18T00:11:13.043503Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.vasopressin_durations""",109348,Thread-1,2022-07-18T00:11:13.044923Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:13.045733Z
Q031,,debug,Began executing node model.mimic.vasopressin_durations,109348,Thread-1,2022-07-18T00:11:13.046117Z,table,null,vasopressin_durations,durations/vasopressin_durations.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.vasopressin_durations""",109348,Thread-1,2022-07-18T00:11:13.057982Z
E015,,debug,"Using postgres connection ""model.mimic.vasopressin_durations""",109348,Thread-1,2022-07-18T00:11:13.058947Z
E016,,debug,On model.mimic.vasopressin_durations: BEGIN,109348,Thread-1,2022-07-18T00:11:13.059226Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:11:13.059563Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:13.064870Z
E015,,debug,"Using postgres connection ""model.mimic.vasopressin_durations""",109348,Thread-1,2022-07-18T00:11:13.065529Z
E016,,debug,"On model.mimic.vasopressin_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.vasopressin_durations""} */


  create  table ""postgres"".""public"".""vasopressin_durations__dbt_tmp""
  as (
    -- This query extracts durations of vasopressin administration
-- Consecutive administrations are numbered 1, 2, ...
-- Total time on the drug can be calculated from this table by grouping using ICUSTAY_ID

-- Get drug administration data from CareVue first
with vasocv1 as
(
  select
    icustay_id, charttime
    -- case statement determining whether the ITEMID is an instance of vasopressor usage
    , max(case when itemid = 30051 then 1 else 0 end) as vaso -- vasopressin

    -- the 'stopped' column indicates if a vasopressor has been disconnected
    , max(case when itemid = 30051 and (stopped = 'Stopped' OR stopped like 'D/C%') then 1
          else 0 end) as vaso_stopped

    , max(case when itemid = 30051 and rate is not null then 1 else 0 end) as vaso_null
    , max(case when itemid = 30051 then rate else null end) as vaso_rate
    , max(case when itemid = 30051 then amount else null end) as vaso_amount

  FROM inputevents_cv
  where itemid = 30051 -- vasopressin
  group by icustay_id, charttime
)
, vasocv2 as
(
  select v.*
    , sum(vaso_null) over (partition by icustay_id order by charttime) as vaso_partition
  from
    vasocv1 v
)
, vasocv3 as
(
  select v.*
    , first_value(vaso_rate) over (partition by icustay_id, vaso_partition order by charttime) as vaso_prevrate_ifnull
  from
    vasocv2 v
)
, vasocv4 as
(
select
    icustay_id
    , charttime
    -- , (CHARTTIME - (LAG(CHARTTIME, 1) OVER (partition by icustay_id, vaso order by charttime))) AS delta

    , vaso
    , vaso_rate
    , vaso_amount
    , vaso_stopped
    , vaso_prevrate_ifnull

    -- We define start time here
    , case
        when vaso = 0 then null

        -- if this is the first instance of the vasoactive drug
        when vaso_rate > 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso, vaso_null
          order by charttime
          )
          is null
          then 1

        -- you often get a string of 0s
        -- we decide not to set these as 1, just because it makes vasonum sequential
        when vaso_rate = 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 0
          then 0

        -- sometimes you get a string of NULL, associated with 0 volumes
        -- same reason as before, we decide not to set these as 1
        -- vaso_prevrate_ifnull is equal to the previous value *iff* the current value is null
        when vaso_prevrate_ifnull = 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 0
          then 0

        -- If the last recorded rate was 0, newvaso = 1
        when LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          ) = 0
          then 1

        -- If the last recorded vaso was D/C'd, newvaso = 1
        when
          LAG(vaso_stopped,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 1 then 1

        -- ** not sure if the below is needed
        --when (CHARTTIME - (LAG(CHARTTIME, 1) OVER (partition by icustay_id, vaso order by charttime))) > (interval '4 hours') then 1
      else null
      end as vaso_start

FROM
  vasocv3
)
-- propagate start/stop flags forward in time
, vasocv5 as
(
  select v.*
    , SUM(vaso_start) OVER (partition by icustay_id, vaso order by charttime) as vaso_first
FROM
  vasocv4 v
)
, vasocv6 as
(
  select v.*
    -- We define end time here
    , case
        when vaso = 0
          then null

        -- If the recorded vaso was D/C'd, this is an end time
        when vaso_stopped = 1
          then vaso_first

        -- If the rate is zero, this is the end time
        when vaso_rate = 0
          then vaso_first

        -- the last row in the table is always a potential end time
        -- this captures patients who die/are discharged while on vasopressors
        -- in principle, this could add an extra end time for the vasopressor
        -- however, since we later group on vaso_start, any extra end times are ignored
        when LEAD(CHARTTIME,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          ) is null
          then vaso_first

        else null
        end as vaso_stop
    from vasocv5 v
)

-- -- if you want to look at the results of the table before grouping:
-- select
--   icustay_id, charttime, vaso, vaso_rate, vaso_amount
--     , case when vaso_stopped = 1 then 'Y' else '' end as stopped
--     , vaso_start
--     , vaso_first
--     , vaso_stop
-- from vasocv6 order by charttime


, vasocv as
(
-- below groups together vasopressor administrations into groups
select
  icustay_id
  -- the first non-null rate is considered the starttime
  , min(case when vaso_rate is not null then charttime else null end) as starttime
  -- the *first* time the first/last flags agree is the stop time for this duration
  , min(case when vaso_first = vaso_stop then charttime else null end) as endtime
from vasocv6
where
  vaso_first is not null -- bogus data
and
  vaso_first != 0 -- sometimes *only* a rate of 0 appears, i.e. the drug is never actually delivered
and
  icustay_id is not null -- there are data for ""floating"" admissions, we don't worry about these
group by icustay_id, vaso_first
having -- ensure start time is not the same as end time
 min(charttime) != min(case when vaso_first = vaso_stop then charttime else null end)
and
  max(vaso_rate) > 0 -- if the rate was always 0 or null, we consider it not a real drug delivery
)

-- now we extract the associated data for metavision patients
, vasomv as
(
  select
    icustay_id, linkorderid
    , min(starttime) as starttime, max(endtime) as endtime
  FROM inputevents_mv
  where itemid = 222315 -- vasopressin
  and statusdescription != 'Rewritten' -- only valid orders
  group by icustay_id, linkorderid
)

select
  icustay_id
  -- generate a sequential integer for convenience
  , ROW_NUMBER() over (partition by icustay_id order by starttime) as vasonum
  , starttime, endtime
  , DATETIME_DIFF(endtime, starttime, 'HOUR') AS duration_hours
  -- add durations
from
  vasocv

UNION ALL

select
  icustay_id
  , ROW_NUMBER() over (partition by icustay_id order by starttime) as vasonum
  , starttime, endtime
  , DATETIME_DIFF(endtime, starttime, 'HOUR') AS duration_hours
  -- add durations
from
  vasomv

order by icustay_id, vasonum
  );",109348,Thread-1,2022-07-18T00:11:13.065730Z
E017,,debug,SQL status: SELECT 4190 in 1.96 seconds,109348,Thread-1,2022-07-18T00:11:15.021224Z
E015,,debug,"Using postgres connection ""model.mimic.vasopressin_durations""",109348,Thread-1,2022-07-18T00:11:15.029197Z
E016,,debug,"On model.mimic.vasopressin_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.vasopressin_durations""} */
alter table ""postgres"".""public"".""vasopressin_durations"" rename to ""vasopressin_durations__dbt_backup""",109348,Thread-1,2022-07-18T00:11:15.029897Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:15.031202Z
E015,,debug,"Using postgres connection ""model.mimic.vasopressin_durations""",109348,Thread-1,2022-07-18T00:11:15.035133Z
E016,,debug,"On model.mimic.vasopressin_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.vasopressin_durations""} */
alter table ""postgres"".""public"".""vasopressin_durations__dbt_tmp"" rename to ""vasopressin_durations""",109348,Thread-1,2022-07-18T00:11:15.035369Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:15.036358Z
E018,,debug,On model.mimic.vasopressin_durations: COMMIT,109348,Thread-1,2022-07-18T00:11:15.039748Z
E015,,debug,"Using postgres connection ""model.mimic.vasopressin_durations""",109348,Thread-1,2022-07-18T00:11:15.039982Z
E016,,debug,On model.mimic.vasopressin_durations: COMMIT,109348,Thread-1,2022-07-18T00:11:15.040301Z
E017,,debug,SQL status: COMMIT in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:15.050077Z
E015,,debug,"Using postgres connection ""model.mimic.vasopressin_durations""",109348,Thread-1,2022-07-18T00:11:15.052633Z
E016,,debug,"On model.mimic.vasopressin_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.vasopressin_durations""} */
drop table if exists ""postgres"".""public"".""vasopressin_durations__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:11:15.052874Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:15.055052Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:15.058023Z
E010,,debug,On model.mimic.vasopressin_durations: Close,109348,Thread-1,2022-07-18T00:11:15.058308Z
Q012,2,info,74 of 107 OK created table model public.vasopressin_durations .................. [[32mSELECT 4190[0m in 2.02s],109348,Thread-1,2022-07-18T00:11:15.059319Z,table,null,vasopressin_durations,durations/vasopressin_durations.sql,2022-07-18T00:11:13.041071,compiling,model,,,
Q024,2.0168135166168213,debug,Finished running node model.mimic.vasopressin_durations,109348,Thread-1,2022-07-18T00:11:15.060078Z,table,2022-07-18T00:11:15.059898,vasopressin_durations,durations/vasopressin_durations.sql,2022-07-18T00:11:13.041071,success,model,,,
Q023,,debug,Began running node model.mimic.vasopressor_durations,109348,Thread-1,2022-07-18T00:11:15.060682Z,table,null,vasopressor_durations,durations/vasopressor_durations.sql,2022-07-18T00:11:15.060612,started,model,,,
Q033,,info,75 of 107 START table model public.vasopressor_durations ....................... [RUN],109348,Thread-1,2022-07-18T00:11:15.061597Z,table,null,vasopressor_durations,durations/vasopressor_durations.sql,2022-07-18T00:11:15.060612,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.vasopressor_durations""",109348,Thread-1,2022-07-18T00:11:15.062587Z
Q030,,debug,Began compiling node model.mimic.vasopressor_durations,109348,Thread-1,2022-07-18T00:11:15.062962Z,table,null,vasopressor_durations,durations/vasopressor_durations.sql,2022-07-18T00:11:15.060612,compiling,model,,,
Q027,,debug,Compiling model.mimic.vasopressor_durations,109348,Thread-1,2022-07-18T00:11:15.063471Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.vasopressor_durations""",109348,Thread-1,2022-07-18T00:11:15.064900Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:15.066048Z
Q031,,debug,Began executing node model.mimic.vasopressor_durations,109348,Thread-1,2022-07-18T00:11:15.066533Z,table,null,vasopressor_durations,durations/vasopressor_durations.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.vasopressor_durations""",109348,Thread-1,2022-07-18T00:11:15.080428Z
E015,,debug,"Using postgres connection ""model.mimic.vasopressor_durations""",109348,Thread-1,2022-07-18T00:11:15.081275Z
E016,,debug,On model.mimic.vasopressor_durations: BEGIN,109348,Thread-1,2022-07-18T00:11:15.081448Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:11:15.081804Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:15.088477Z
E015,,debug,"Using postgres connection ""model.mimic.vasopressor_durations""",109348,Thread-1,2022-07-18T00:11:15.088767Z
E016,,debug,"On model.mimic.vasopressor_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.vasopressor_durations""} */


  create  table ""postgres"".""public"".""vasopressor_durations__dbt_tmp""
  as (
    -- This query extracts durations of vasopressor administration
-- It groups together any administration of the below list of drugs:
--  norepinephrine - 30047,30120,221906
--  epinephrine - 30044,30119,30309,221289
--  phenylephrine - 30127,30128,221749
--  vasopressin - 30051,222315 (42273, 42802 also for 2 patients)
--  dopamine - 30043,30307,221662
--  dobutamine - 30042,30306,221653
--  milrinone - 30125,221986

-- Consecutive administrations are numbered 1, 2, ...
-- Total time on the drug can be calculated from this table
-- by grouping using ICUSTAY_ID

-- select only the ITEMIDs from the inputevents_cv table related to vasopressors
with io_cv as
(
  select
    icustay_id, charttime, itemid, stopped
    -- ITEMIDs (42273, 42802) accidentally store rate in amount column
    , case
        when itemid in (42273, 42802)
          then amount
        else rate
      end as rate
    , case
        when itemid in (42273, 42802)
          then rate
        else amount
      end as amount
  FROM inputevents_cv
  where itemid in
  (
    30047,30120,30044,30119,30309,30127
  , 30128,30051,30043,30307,30042,30306,30125
  , 42273, 42802
  )
)
-- select only the ITEMIDs from the inputevents_mv table related to vasopressors
, io_mv as
(
  select
    icustay_id, linkorderid, starttime, endtime
  FROM inputevents_mv io
  -- Subselect the vasopressor ITEMIDs
  where itemid in
  (
  221906,221289,221749,222315,221662,221653,221986
  )
  and statusdescription != 'Rewritten' -- only valid orders
)
, vasocv1 as
(
  select
    icustay_id, charttime, itemid
    -- case statement determining whether the ITEMID is an instance of vasopressor usage
    , 1 as vaso

    -- the 'stopped' column indicates if a vasopressor has been disconnected
    , max(case when (stopped = 'Stopped' OR stopped like 'D/C%') then 1
          else 0 end) as vaso_stopped

    , max(case when rate is not null then 1 else 0 end) as vaso_null
    , max(rate) as vaso_rate
    , max(amount) as vaso_amount

  from io_cv
  group by icustay_id, charttime, itemid
)
, vasocv2 as
(
  select v.*
    , sum(vaso_null) over (partition by icustay_id, itemid order by charttime) as vaso_partition
  from
    vasocv1 v
)
, vasocv3 as
(
  select v.*
    , first_value(vaso_rate) over (partition by icustay_id, itemid, vaso_partition order by charttime) as vaso_prevrate_ifnull
  from
    vasocv2 v
)
, vasocv4 as
(
select
    icustay_id
    , charttime
    , itemid
    -- , (CHARTTIME - (LAG(CHARTTIME, 1) OVER (partition by icustay_id, vaso order by charttime))) AS delta

    , vaso
    , vaso_rate
    , vaso_amount
    , vaso_stopped
    , vaso_prevrate_ifnull

    -- We define start time here
    , case
        when vaso = 0 then null

        -- if this is the first instance of the vasoactive drug
        when vaso_rate > 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, itemid, vaso, vaso_null
          order by charttime
          )
          is null
          then 1

        -- you often get a string of 0s
        -- we decide not to set these as 1, just because it makes vasonum sequential
        when vaso_rate = 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, itemid, vaso
          order by charttime
          )
          = 0
          then 0

        -- sometimes you get a string of NULL, associated with 0 volumes
        -- same reason as before, we decide not to set these as 1
        -- vaso_prevrate_ifnull is equal to the previous value *iff* the current value is null
        when vaso_prevrate_ifnull = 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, itemid, vaso
          order by charttime
          )
          = 0
          then 0

        -- If the last recorded rate was 0, newvaso = 1
        when LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, itemid, vaso
          order by charttime
          ) = 0
          then 1

        -- If the last recorded vaso was D/C'd, newvaso = 1
        when
          LAG(vaso_stopped,1)
          OVER
          (
          partition by icustay_id, itemid, vaso
          order by charttime
          )
          = 1 then 1

        -- ** not sure if the below is needed
        --when (CHARTTIME - (LAG(CHARTTIME, 1) OVER (partition by icustay_id, vaso order by charttime))) > (interval '4 hours') then 1
      else null
      end as vaso_start

FROM
  vasocv3
)
-- propagate start/stop flags forward in time
, vasocv5 as
(
  select v.*
    , SUM(vaso_start) OVER (partition by icustay_id, itemid, vaso order by charttime) as vaso_first
FROM
  vasocv4 v
)
, vasocv6 as
(
  select v.*
    -- We define end time here
    , case
        when vaso = 0
          then null

        -- If the recorded vaso was D/C'd, this is an end time
        when vaso_stopped = 1
          then vaso_first

        -- If the rate is zero, this is the end time
        when vaso_rate = 0
          then vaso_first

        -- the last row in the table is always a potential end time
        -- this captures patients who die/are discharged while on vasopressors
        -- in principle, this could add an extra end time for the vasopressor
        -- however, since we later group on vaso_start, any extra end times are ignored
        when LEAD(CHARTTIME,1)
          OVER
          (
          partition by icustay_id, itemid, vaso
          order by charttime
          ) is null
          then vaso_first

        else null
        end as vaso_stop
    from vasocv5 v
)

-- -- if you want to look at the results of the table before grouping:
-- select
--   icustay_id, charttime, vaso, vaso_rate, vaso_amount
--     , case when vaso_stopped = 1 then 'Y' else '' end as stopped
--     , vaso_start
--     , vaso_first
--     , vaso_stop
-- from vasocv6 order by charttime


, vasocv as
(
-- below groups together vasopressor administrations into groups
select
  icustay_id
  , itemid
  -- the first non-null rate is considered the starttime
  , min(case when vaso_rate is not null then charttime else null end) as starttime
  -- the *first* time the first/last flags agree is the stop time for this duration
  , min(case when vaso_first = vaso_stop then charttime else null end) as endtime
from vasocv6
where
  vaso_first is not null -- bogus data
and
  vaso_first != 0 -- sometimes *only* a rate of 0 appears, i.e. the drug is never actually delivered
and
  icustay_id is not null -- there are data for ""floating"" admissions, we don't worry about these
group by icustay_id, itemid, vaso_first
having -- ensure start time is not the same as end time
 min(charttime) != min(case when vaso_first = vaso_stop then charttime else null end)
and
  max(vaso_rate) > 0 -- if the rate was always 0 or null, we consider it not a real drug delivery
)
-- we do not group by ITEMID in below query
-- this is because we want to collapse all vasopressors together
, vasocv_grp as
(
SELECT
  s1.icustay_id,
  s1.starttime,
  MIN(t1.endtime) AS endtime
FROM vasocv s1
INNER JOIN vasocv t1
  ON  s1.icustay_id = t1.icustay_id
  AND s1.starttime <= t1.endtime
  AND NOT EXISTS(SELECT * FROM vasocv t2
                 WHERE t1.icustay_id = t2.icustay_id
                 AND t1.endtime >= t2.starttime
                 AND t1.endtime < t2.endtime)
WHERE NOT EXISTS(SELECT * FROM vasocv s2
                 WHERE s1.icustay_id = s2.icustay_id
                 AND s1.starttime > s2.starttime
                 AND s1.starttime <= s2.endtime)
GROUP BY s1.icustay_id, s1.starttime
ORDER BY s1.icustay_id, s1.starttime
)
-- now we extract the associated data for metavision patients
-- do not need to group by itemid because we group by linkorderid
, vasomv as
(
  select
    icustay_id, linkorderid
    , min(starttime) as starttime, max(endtime) as endtime
  from io_mv
  group by icustay_id, linkorderid
)
, vasomv_grp as
(
SELECT
  s1.icustay_id,
  s1.starttime,
  MIN(t1.endtime) AS endtime
FROM vasomv s1
INNER JOIN vasomv t1
  ON  s1.icustay_id = t1.icustay_id
  AND s1.starttime <= t1.endtime
  AND NOT EXISTS(SELECT * FROM vasomv t2
                 WHERE t1.icustay_id = t2.icustay_id
                 AND t1.endtime >= t2.starttime
                 AND t1.endtime < t2.endtime)
WHERE NOT EXISTS(SELECT * FROM vasomv s2
                 WHERE s1.icustay_id = s2.icustay_id
                 AND s1.starttime > s2.starttime
                 AND s1.starttime <= s2.endtime)
GROUP BY s1.icustay_id, s1.starttime
ORDER BY s1.icustay_id, s1.starttime
)
select
  icustay_id
  -- generate a sequential integer for convenience
  , ROW_NUMBER() over (partition by icustay_id order by starttime) as vasonum
  , starttime, endtime
  , DATETIME_DIFF(endtime, starttime, 'HOUR') AS duration_hours
  -- add durations
from
  vasocv_grp

UNION ALL

select
  icustay_id
  , ROW_NUMBER() over (partition by icustay_id order by starttime) as vasonum
  , starttime, endtime
  , DATETIME_DIFF(endtime, starttime, 'HOUR') AS duration_hours
  -- add durations
from
  vasomv_grp

order by icustay_id, vasonum
  );",109348,Thread-1,2022-07-18T00:11:15.089034Z
E017,,debug,SQL status: SELECT 38832 in 8.91 seconds,109348,Thread-1,2022-07-18T00:11:23.998455Z
E015,,debug,"Using postgres connection ""model.mimic.vasopressor_durations""",109348,Thread-1,2022-07-18T00:11:24.004215Z
E016,,debug,"On model.mimic.vasopressor_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.vasopressor_durations""} */
alter table ""postgres"".""public"".""vasopressor_durations"" rename to ""vasopressor_durations__dbt_backup""",109348,Thread-1,2022-07-18T00:11:24.004482Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:24.005691Z
E015,,debug,"Using postgres connection ""model.mimic.vasopressor_durations""",109348,Thread-1,2022-07-18T00:11:24.009070Z
E016,,debug,"On model.mimic.vasopressor_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.vasopressor_durations""} */
alter table ""postgres"".""public"".""vasopressor_durations__dbt_tmp"" rename to ""vasopressor_durations""",109348,Thread-1,2022-07-18T00:11:24.009274Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:24.010075Z
E018,,debug,On model.mimic.vasopressor_durations: COMMIT,109348,Thread-1,2022-07-18T00:11:24.012906Z
E015,,debug,"Using postgres connection ""model.mimic.vasopressor_durations""",109348,Thread-1,2022-07-18T00:11:24.013113Z
E016,,debug,On model.mimic.vasopressor_durations: COMMIT,109348,Thread-1,2022-07-18T00:11:24.013233Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:24.014412Z
E015,,debug,"Using postgres connection ""model.mimic.vasopressor_durations""",109348,Thread-1,2022-07-18T00:11:24.016312Z
E016,,debug,"On model.mimic.vasopressor_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.vasopressor_durations""} */
drop table if exists ""postgres"".""public"".""vasopressor_durations__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:11:24.016521Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:24.020518Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:24.023822Z
E010,,debug,On model.mimic.vasopressor_durations: Close,109348,Thread-1,2022-07-18T00:11:24.024079Z
Q012,8,info,75 of 107 OK created table model public.vasopressor_durations .................. [[32mSELECT 38832[0m in 8.96s],109348,Thread-1,2022-07-18T00:11:24.024999Z,table,null,vasopressor_durations,durations/vasopressor_durations.sql,2022-07-18T00:11:15.060612,compiling,model,,,
Q024,8.962647914886475,debug,Finished running node model.mimic.vasopressor_durations,109348,Thread-1,2022-07-18T00:11:24.025755Z,table,2022-07-18T00:11:24.025485,vasopressor_durations,durations/vasopressor_durations.sql,2022-07-18T00:11:15.060612,success,model,,,
Q023,,debug,Began running node model.mimic.ventilation_classification,109348,Thread-1,2022-07-18T00:11:24.026282Z,table,null,ventilation_classification,durations/ventilation_classification.sql,2022-07-18T00:11:24.026190,started,model,,,
Q033,,info,76 of 107 START table model public.ventilation_classification .................. [RUN],109348,Thread-1,2022-07-18T00:11:24.027078Z,table,null,ventilation_classification,durations/ventilation_classification.sql,2022-07-18T00:11:24.026190,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.ventilation_classification""",109348,Thread-1,2022-07-18T00:11:24.027879Z
Q030,,debug,Began compiling node model.mimic.ventilation_classification,109348,Thread-1,2022-07-18T00:11:24.028326Z,table,null,ventilation_classification,durations/ventilation_classification.sql,2022-07-18T00:11:24.026190,compiling,model,,,
Q027,,debug,Compiling model.mimic.ventilation_classification,109348,Thread-1,2022-07-18T00:11:24.028746Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.ventilation_classification""",109348,Thread-1,2022-07-18T00:11:24.030194Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:24.030902Z
Q031,,debug,Began executing node model.mimic.ventilation_classification,109348,Thread-1,2022-07-18T00:11:24.031190Z,table,null,ventilation_classification,durations/ventilation_classification.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.ventilation_classification""",109348,Thread-1,2022-07-18T00:11:24.040497Z
E015,,debug,"Using postgres connection ""model.mimic.ventilation_classification""",109348,Thread-1,2022-07-18T00:11:24.041930Z
E016,,debug,On model.mimic.ventilation_classification: BEGIN,109348,Thread-1,2022-07-18T00:11:24.042316Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:11:24.042977Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:24.049126Z
E015,,debug,"Using postgres connection ""model.mimic.ventilation_classification""",109348,Thread-1,2022-07-18T00:11:24.049390Z
E016,,debug,"On model.mimic.ventilation_classification: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.ventilation_classification""} */


  create  table ""postgres"".""public"".""ventilation_classification__dbt_tmp""
  as (
    -- Identify The presence of a mechanical ventilation using settings
select
  icustay_id, charttime
  -- case statement determining whether it is an instance of mech vent
  , max(
    case
      when itemid is null or value is null then 0 -- can't have null values
      when itemid = 720 and value != 'Other/Remarks' THEN 1  -- VentTypeRecorded
      when itemid = 223848 and value != 'Other' THEN 1
      when itemid = 223849 then 1 -- ventilator mode
      when itemid = 467 and value = 'Ventilator' THEN 1 -- O2 delivery device == ventilator
      when itemid in
        (
        445, 448, 449, 450, 1340, 1486, 1600, 224687 -- minute volume
        , 639, 654, 681, 682, 683, 684,224685,224684,224686 -- tidal volume
        , 218,436,535,444,459,224697,224695,224696,224746,224747 -- High/Low/Peak/Mean/Neg insp force (""RespPressure"")
        , 221,1,1211,1655,2000,226873,224738,224419,224750,227187 -- Insp pressure
        , 543 -- PlateauPressure
        , 5865,5866,224707,224709,224705,224706 -- APRV pressure
        , 60,437,505,506,686,220339,224700 -- PEEP
        , 3459 -- high pressure relief
        , 501,502,503,224702 -- PCV
        , 223,667,668,669,670,671,672 -- TCPCV
        , 224701 -- PSVlevel
        )
        THEN 1
      else 0
    end
    ) as MechVent
    , max(
      case
        -- initiation of oxygen therapy indicates the ventilation has ended
        when itemid = 226732 and value in
        (
          'Nasal cannula', -- 153714 observations
          'Face tent', -- 24601 observations
          'Aerosol-cool', -- 24560 observations
          'Trach mask ', -- 16435 observations
          'High flow neb', -- 10785 observations
          'Non-rebreather', -- 5182 observations
          'Venti mask ', -- 1947 observations
          'Medium conc mask ', -- 1888 observations
          'T-piece', -- 1135 observations
          'High flow nasal cannula', -- 925 observations
          'Ultrasonic neb', -- 9 observations
          'Vapomist' -- 3 observations
        ) then 1
        when itemid = 467 and value in
        (
          'Cannula', -- 278252 observations
          'Nasal Cannula', -- 248299 observations
          -- 'None', -- 95498 observations
          'Face Tent', -- 35766 observations
          'Aerosol-Cool', -- 33919 observations
          'Trach Mask', -- 32655 observations
          'Hi Flow Neb', -- 14070 observations
          'Non-Rebreather', -- 10856 observations
          'Venti Mask', -- 4279 observations
          'Medium Conc Mask', -- 2114 observations
          'Vapotherm', -- 1655 observations
          'T-Piece', -- 779 observations
          'Hood', -- 670 observations
          'Hut', -- 150 observations
          'TranstrachealCat', -- 78 observations
          'Heated Neb', -- 37 observations
          'Ultrasonic Neb' -- 2 observations
        ) then 1
      else 0
      end
    ) as OxygenTherapy
    , max(
      case when itemid is null or value is null then 0
        -- extubated indicates ventilation event has ended
        when itemid = 640 and value = 'Extubated' then 1
        when itemid = 640 and value = 'Self Extubation' then 1
      else 0
      end
      )
      as Extubated
    , max(
      case when itemid is null or value is null then 0
        when itemid = 640 and value = 'Self Extubation' then 1
      else 0
      end
      )
      as SelfExtubated
from chartevents ce
where ce.value is not null
-- exclude rows marked as error
and (ce.error != 1 or ce.error IS NULL)
and itemid in
(
    -- the below are settings used to indicate ventilation
      720, 223849 -- vent mode
    , 223848 -- vent type
    , 445, 448, 449, 450, 1340, 1486, 1600, 224687 -- minute volume
    , 639, 654, 681, 682, 683, 684,224685,224684,224686 -- tidal volume
    , 218,436,535,444,224697,224695,224696,224746,224747 -- High/Low/Peak/Mean (""RespPressure"")
    , 221,1,1211,1655,2000,226873,224738,224419,224750,227187 -- Insp pressure
    , 543 -- PlateauPressure
    , 5865,5866,224707,224709,224705,224706 -- APRV pressure
    , 60,437,505,506,686,220339,224700 -- PEEP
    , 3459 -- high pressure relief
    , 501,502,503,224702 -- PCV
    , 223,667,668,669,670,671,672 -- TCPCV
    , 224701 -- PSVlevel

    -- the below are settings used to indicate extubation
    , 640 -- extubated

    -- the below indicate oxygen/NIV, i.e. the end of a mechanical vent event
    , 468 -- O2 Delivery Device#2
    , 469 -- O2 Delivery Mode
    , 470 -- O2 Flow (lpm)
    , 471 -- O2 Flow (lpm) #2
    , 227287 -- O2 Flow (additional cannula)
    , 226732 -- O2 Delivery Device(s)
    , 223834 -- O2 Flow

    -- used in both oxygen + vent calculation
    , 467 -- O2 Delivery Device
)
group by icustay_id, charttime
UNION DISTINCT
-- add in the extubation flags from procedureevents_mv
-- note that we only need the start time for the extubation
-- (extubation is always charted as ending 1 minute after it started)
select
  icustay_id, starttime as charttime
  , 0 as MechVent
  , 0 as OxygenTherapy
  , 1 as Extubated
  , case when itemid = 225468 then 1 else 0 end as SelfExtubated
from procedureevents_mv
where itemid in
(
  227194 -- ""Extubation""
, 225468 -- ""Unplanned Extubation (patient-initiated)""
, 225477 -- ""Unplanned Extubation (non-patient initiated)""
)
  );",109348,Thread-1,2022-07-18T00:11:24.049532Z
E017,,debug,SQL status: SELECT 8642 in 0.05 seconds,109348,Thread-1,2022-07-18T00:11:24.100426Z
E015,,debug,"Using postgres connection ""model.mimic.ventilation_classification""",109348,Thread-1,2022-07-18T00:11:24.109904Z
E016,,debug,"On model.mimic.ventilation_classification: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.ventilation_classification""} */
alter table ""postgres"".""public"".""ventilation_classification"" rename to ""ventilation_classification__dbt_backup""",109348,Thread-1,2022-07-18T00:11:24.110266Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:24.111160Z
E015,,debug,"Using postgres connection ""model.mimic.ventilation_classification""",109348,Thread-1,2022-07-18T00:11:24.116363Z
E016,,debug,"On model.mimic.ventilation_classification: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.ventilation_classification""} */
alter table ""postgres"".""public"".""ventilation_classification__dbt_tmp"" rename to ""ventilation_classification""",109348,Thread-1,2022-07-18T00:11:24.116726Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:24.117421Z
E018,,debug,On model.mimic.ventilation_classification: COMMIT,109348,Thread-1,2022-07-18T00:11:24.120518Z
E015,,debug,"Using postgres connection ""model.mimic.ventilation_classification""",109348,Thread-1,2022-07-18T00:11:24.120743Z
E016,,debug,On model.mimic.ventilation_classification: COMMIT,109348,Thread-1,2022-07-18T00:11:24.121073Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:24.123324Z
E015,,debug,"Using postgres connection ""model.mimic.ventilation_classification""",109348,Thread-1,2022-07-18T00:11:24.125962Z
E016,,debug,"On model.mimic.ventilation_classification: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.ventilation_classification""} */
drop table if exists ""postgres"".""public"".""ventilation_classification__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:11:24.126210Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:24.128839Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:24.133176Z
E010,,debug,On model.mimic.ventilation_classification: Close,109348,Thread-1,2022-07-18T00:11:24.133599Z
Q012,0,info,76 of 107 OK created table model public.ventilation_classification ............. [[32mSELECT 8642[0m in 0.11s],109348,Thread-1,2022-07-18T00:11:24.134495Z,table,null,ventilation_classification,durations/ventilation_classification.sql,2022-07-18T00:11:24.026190,compiling,model,,,
Q024,0.10669636726379395,debug,Finished running node model.mimic.ventilation_classification,109348,Thread-1,2022-07-18T00:11:24.135077Z,table,2022-07-18T00:11:24.134922,ventilation_classification,durations/ventilation_classification.sql,2022-07-18T00:11:24.026190,success,model,,,
Q023,,debug,Began running node model.mimic.vitals_first_day,109348,Thread-1,2022-07-18T00:11:24.135459Z,table,null,vitals_first_day,firstday/vitals_first_day.sql,2022-07-18T00:11:24.135430,started,model,,,
Q033,,info,77 of 107 START table model public.vitals_first_day ............................ [RUN],109348,Thread-1,2022-07-18T00:11:24.136417Z,table,null,vitals_first_day,firstday/vitals_first_day.sql,2022-07-18T00:11:24.135430,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.vitals_first_day""",109348,Thread-1,2022-07-18T00:11:24.137624Z
Q030,,debug,Began compiling node model.mimic.vitals_first_day,109348,Thread-1,2022-07-18T00:11:24.137870Z,table,null,vitals_first_day,firstday/vitals_first_day.sql,2022-07-18T00:11:24.135430,compiling,model,,,
Q027,,debug,Compiling model.mimic.vitals_first_day,109348,Thread-1,2022-07-18T00:11:24.138069Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.vitals_first_day""",109348,Thread-1,2022-07-18T00:11:24.140725Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:24.141462Z
Q031,,debug,Began executing node model.mimic.vitals_first_day,109348,Thread-1,2022-07-18T00:11:24.142031Z,table,null,vitals_first_day,firstday/vitals_first_day.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.vitals_first_day""",109348,Thread-1,2022-07-18T00:11:24.150631Z
E015,,debug,"Using postgres connection ""model.mimic.vitals_first_day""",109348,Thread-1,2022-07-18T00:11:24.151345Z
E016,,debug,On model.mimic.vitals_first_day: BEGIN,109348,Thread-1,2022-07-18T00:11:24.151594Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:11:24.151797Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:24.159166Z
E015,,debug,"Using postgres connection ""model.mimic.vitals_first_day""",109348,Thread-1,2022-07-18T00:11:24.159472Z
E016,,debug,"On model.mimic.vitals_first_day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.vitals_first_day""} */


  create  table ""postgres"".""public"".""vitals_first_day__dbt_tmp""
  as (
    -- This query pivots the vital signs for the first 24 hours of a patient's stay
-- Vital signs include heart rate, blood pressure, respiration rate, and temperature

SELECT pvt.subject_id, pvt.hadm_id, pvt.icustay_id

-- Easier names
, min(case when VitalID = 1 then valuenum ELSE NULL END) AS heartrate_min
, max(case when VitalID = 1 then valuenum ELSE NULL END) AS heartrate_max
, avg(case when VitalID = 1 then valuenum ELSE NULL END) AS heartrate_mean
, min(case when VitalID = 2 then valuenum ELSE NULL END) AS sysbp_min
, max(case when VitalID = 2 then valuenum ELSE NULL END) AS sysbp_max
, avg(case when VitalID = 2 then valuenum ELSE NULL END) AS sysbp_mean
, min(case when VitalID = 3 then valuenum ELSE NULL END) AS diasbp_min
, max(case when VitalID = 3 then valuenum ELSE NULL END) AS diasbp_max
, avg(case when VitalID = 3 then valuenum ELSE NULL END) AS diasbp_mean
, min(case when VitalID = 4 then valuenum ELSE NULL END) AS meanbp_min
, max(case when VitalID = 4 then valuenum ELSE NULL END) AS meanbp_max
, avg(case when VitalID = 4 then valuenum ELSE NULL END) AS meanbp_mean
, min(case when VitalID = 5 then valuenum ELSE NULL END) AS resprate_min
, max(case when VitalID = 5 then valuenum ELSE NULL END) AS resprate_max
, avg(case when VitalID = 5 then valuenum ELSE NULL END) AS resprate_mean
, min(case when VitalID = 6 then valuenum ELSE NULL END) AS tempc_min
, max(case when VitalID = 6 then valuenum ELSE NULL END) AS tempc_max
, avg(case when VitalID = 6 then valuenum ELSE NULL END) AS tempc_mean
, min(case when VitalID = 7 then valuenum ELSE NULL END) AS spo2_min
, max(case when VitalID = 7 then valuenum ELSE NULL END) AS spo2_max
, avg(case when VitalID = 7 then valuenum ELSE NULL END) AS spo2_mean
, min(case when VitalID = 8 then valuenum ELSE NULL END) AS glucose_min
, max(case when VitalID = 8 then valuenum ELSE NULL END) AS glucose_max
, avg(case when VitalID = 8 then valuenum ELSE NULL END) AS glucose_mean

FROM  (
  select ie.subject_id, ie.hadm_id, ie.icustay_id
  , case
    when itemid in (211,220045) and valuenum > 0 and valuenum < 300 then 1 -- HeartRate
    when itemid in (51,442,455,6701,220179,220050) and valuenum > 0 and valuenum < 400 then 2 -- SysBP
    when itemid in (8368,8440,8441,8555,220180,220051) and valuenum > 0 and valuenum < 300 then 3 -- DiasBP
    when itemid in (456,52,6702,443,220052,220181,225312) and valuenum > 0 and valuenum < 300 then 4 -- MeanBP
    when itemid in (615,618,220210,224690) and valuenum > 0 and valuenum < 70 then 5 -- RespRate
    when itemid in (223761,678) and valuenum > 70 and valuenum < 120  then 6 -- TempF, converted to degC in valuenum call
    when itemid in (223762,676) and valuenum > 10 and valuenum < 50  then 6 -- TempC
    when itemid in (646,220277) and valuenum > 0 and valuenum <= 100 then 7 -- SpO2
    when itemid in (807,811,1529,3745,3744,225664,220621,226537) and valuenum > 0 then 8 -- Glucose

    else null end as vitalid
      -- convert F to C
  , case when itemid in (223761,678) then (valuenum-32)/1.8 else valuenum end as valuenum

  from icustays ie
  left join chartevents ce
  on ie.icustay_id = ce.icustay_id
  and ce.charttime between ie.intime and DATETIME_ADD(ie.intime, INTERVAL '1 DAY')
  and DATETIME_DIFF(ce.charttime, ie.intime, 'SECOND') > 0
  and DATETIME_DIFF(ce.charttime, ie.intime, 'HOUR') <= 24
  -- exclude rows marked as error
  and (ce.error IS NULL or ce.error = 0)
  where ce.itemid in
  (
  -- HEART RATE
  211, --""Heart Rate""
  220045, --""Heart Rate""

  -- Systolic/diastolic

  51, --	Arterial BP [Systolic]
  442, --	Manual BP [Systolic]
  455, --	NBP [Systolic]
  6701, --	Arterial BP #2 [Systolic]
  220179, --	Non Invasive Blood Pressure systolic
  220050, --	Arterial Blood Pressure systolic

  8368, --	Arterial BP [Diastolic]
  8440, --	Manual BP [Diastolic]
  8441, --	NBP [Diastolic]
  8555, --	Arterial BP #2 [Diastolic]
  220180, --	Non Invasive Blood Pressure diastolic
  220051, --	Arterial Blood Pressure diastolic


  -- MEAN ARTERIAL PRESSURE
  456, --""NBP Mean""
  52, --""Arterial BP Mean""
  6702, --	Arterial BP Mean #2
  443, --	Manual BP Mean(calc)
  220052, --""Arterial Blood Pressure mean""
  220181, --""Non Invasive Blood Pressure mean""
  225312, --""ART BP mean""

  -- RESPIRATORY RATE
  618,--	Respiratory Rate
  615,--	Resp Rate (Total)
  220210,--	Respiratory Rate
  224690, --	Respiratory Rate (Total)


  -- SPO2, peripheral
  646, 220277,

  -- GLUCOSE, both lab and fingerstick
  807,--	Fingerstick Glucose
  811,--	Glucose (70-105)
  1529,--	Glucose
  3745,--	BloodGlucose
  3744,--	Blood Glucose
  225664,--	Glucose finger stick
  220621,--	Glucose (serum)
  226537,--	Glucose (whole blood)

  -- TEMPERATURE
  223762, -- ""Temperature Celsius""
  676,	-- ""Temperature C""
  223761, -- ""Temperature Fahrenheit""
  678 --	""Temperature F""

  )
) pvt
group by pvt.subject_id, pvt.hadm_id, pvt.icustay_id
order by pvt.subject_id, pvt.hadm_id, pvt.icustay_id
  );",109348,Thread-1,2022-07-18T00:11:24.159728Z
E017,,debug,SQL status: SELECT 13 in 0.05 seconds,109348,Thread-1,2022-07-18T00:11:24.212729Z
E015,,debug,"Using postgres connection ""model.mimic.vitals_first_day""",109348,Thread-1,2022-07-18T00:11:24.218905Z
E016,,debug,"On model.mimic.vitals_first_day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.vitals_first_day""} */
alter table ""postgres"".""public"".""vitals_first_day"" rename to ""vitals_first_day__dbt_backup""",109348,Thread-1,2022-07-18T00:11:24.219258Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:24.220318Z
E015,,debug,"Using postgres connection ""model.mimic.vitals_first_day""",109348,Thread-1,2022-07-18T00:11:24.227331Z
E016,,debug,"On model.mimic.vitals_first_day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.vitals_first_day""} */
alter table ""postgres"".""public"".""vitals_first_day__dbt_tmp"" rename to ""vitals_first_day""",109348,Thread-1,2022-07-18T00:11:24.227757Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:24.228786Z
E018,,debug,On model.mimic.vitals_first_day: COMMIT,109348,Thread-1,2022-07-18T00:11:24.232419Z
E015,,debug,"Using postgres connection ""model.mimic.vitals_first_day""",109348,Thread-1,2022-07-18T00:11:24.232657Z
E016,,debug,On model.mimic.vitals_first_day: COMMIT,109348,Thread-1,2022-07-18T00:11:24.233091Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:24.234371Z
E015,,debug,"Using postgres connection ""model.mimic.vitals_first_day""",109348,Thread-1,2022-07-18T00:11:24.236963Z
E016,,debug,"On model.mimic.vitals_first_day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.vitals_first_day""} */
drop table if exists ""postgres"".""public"".""vitals_first_day__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:11:24.237214Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:24.240491Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:24.244492Z
E010,,debug,On model.mimic.vitals_first_day: Close,109348,Thread-1,2022-07-18T00:11:24.244775Z
Q012,0,info,77 of 107 OK created table model public.vitals_first_day ....................... [[32mSELECT 13[0m in 0.11s],109348,Thread-1,2022-07-18T00:11:24.245706Z,table,null,vitals_first_day,firstday/vitals_first_day.sql,2022-07-18T00:11:24.135430,compiling,model,,,
Q024,0.10820698738098145,debug,Finished running node model.mimic.vitals_first_day,109348,Thread-1,2022-07-18T00:11:24.246426Z,table,2022-07-18T00:11:24.246240,vitals_first_day,firstday/vitals_first_day.sql,2022-07-18T00:11:24.135430,success,model,,,
Q023,,debug,Began running node model.mimic.wbc,109348,Thread-1,2022-07-18T00:11:24.246998Z,table,null,wbc,cookbook/wbc.sql,2022-07-18T00:11:24.246886,started,model,,,
Q033,,info,78 of 107 START table model public.wbc ......................................... [RUN],109348,Thread-1,2022-07-18T00:11:24.247877Z,table,null,wbc,cookbook/wbc.sql,2022-07-18T00:11:24.246886,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.wbc""",109348,Thread-1,2022-07-18T00:11:24.249505Z
Q030,,debug,Began compiling node model.mimic.wbc,109348,Thread-1,2022-07-18T00:11:24.250195Z,table,null,wbc,cookbook/wbc.sql,2022-07-18T00:11:24.246886,compiling,model,,,
Q027,,debug,Compiling model.mimic.wbc,109348,Thread-1,2022-07-18T00:11:24.250872Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.wbc""",109348,Thread-1,2022-07-18T00:11:24.252785Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:24.253234Z
Q031,,debug,Began executing node model.mimic.wbc,109348,Thread-1,2022-07-18T00:11:24.254000Z,table,null,wbc,cookbook/wbc.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.wbc""",109348,Thread-1,2022-07-18T00:11:24.267133Z
E015,,debug,"Using postgres connection ""model.mimic.wbc""",109348,Thread-1,2022-07-18T00:11:24.268341Z
E016,,debug,On model.mimic.wbc: BEGIN,109348,Thread-1,2022-07-18T00:11:24.268714Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:11:24.269059Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:24.275720Z
E015,,debug,"Using postgres connection ""model.mimic.wbc""",109348,Thread-1,2022-07-18T00:11:24.276073Z
E016,,debug,"On model.mimic.wbc: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.wbc""} */


  create  table ""postgres"".""public"".""wbc__dbt_tmp""
  as (
    -- --------------------------------------------------------
-- Title: Retrieves the white blood cell count for adult patients
-- Notes: this query does not specify a schema. To run it on your local
-- MIMIC schema, run the following command:
--  SET SEARCH_PATH TO mimiciii
-- Where ""mimiciii"" is the name of your schema, and may be different.
-- --------------------------------------------------------

WITH agetbl AS
(
  SELECT ad.subject_id
  FROM admissions ad
  INNER JOIN patients p
  ON ad.subject_id = p.subject_id
  WHERE
  -- filter to only adults
  DATETIME_DIFF(ad.admittime, p.dob, 'YEAR') > 15
  -- group by subject_id to ensure there is only 1 subject_id per row
  group by ad.subject_id
)
, wbc as
(
  SELECT width_bucket(valuenum, 0, 100, 1001) AS bucket
  FROM labevents le
  INNER JOIN agetbl
  ON le.subject_id = agetbl.subject_id
  WHERE itemid in (51300, 51301)
  AND valuenum IS NOT NULL
)
SELECT round((cast(bucket as numeric)/10),2) as white_blood_cell_count, count(*)
FROM wbc
GROUP BY bucket
ORDER BY bucket
  );",109348,Thread-1,2022-07-18T00:11:24.276338Z
E017,,debug,SQL status: SELECT 0 in 0.18 seconds,109348,Thread-1,2022-07-18T00:11:24.453180Z
E015,,debug,"Using postgres connection ""model.mimic.wbc""",109348,Thread-1,2022-07-18T00:11:24.459108Z
E016,,debug,"On model.mimic.wbc: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.wbc""} */
alter table ""postgres"".""public"".""wbc"" rename to ""wbc__dbt_backup""",109348,Thread-1,2022-07-18T00:11:24.459403Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:24.460321Z
E015,,debug,"Using postgres connection ""model.mimic.wbc""",109348,Thread-1,2022-07-18T00:11:24.465836Z
E016,,debug,"On model.mimic.wbc: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.wbc""} */
alter table ""postgres"".""public"".""wbc__dbt_tmp"" rename to ""wbc""",109348,Thread-1,2022-07-18T00:11:24.466189Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:24.466949Z
E018,,debug,On model.mimic.wbc: COMMIT,109348,Thread-1,2022-07-18T00:11:24.470746Z
E015,,debug,"Using postgres connection ""model.mimic.wbc""",109348,Thread-1,2022-07-18T00:11:24.471219Z
E016,,debug,On model.mimic.wbc: COMMIT,109348,Thread-1,2022-07-18T00:11:24.471506Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:24.473860Z
E015,,debug,"Using postgres connection ""model.mimic.wbc""",109348,Thread-1,2022-07-18T00:11:24.475961Z
E016,,debug,"On model.mimic.wbc: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.wbc""} */
drop table if exists ""postgres"".""public"".""wbc__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:11:24.476182Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:24.478386Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:24.481084Z
E010,,debug,On model.mimic.wbc: Close,109348,Thread-1,2022-07-18T00:11:24.481342Z
Q012,0,info,78 of 107 OK created table model public.wbc .................................... [[32mSELECT 0[0m in 0.23s],109348,Thread-1,2022-07-18T00:11:24.482325Z,table,null,wbc,cookbook/wbc.sql,2022-07-18T00:11:24.246886,compiling,model,,,
Q024,0.23314332962036133,debug,Finished running node model.mimic.wbc,109348,Thread-1,2022-07-18T00:11:24.482990Z,table,2022-07-18T00:11:24.482828,wbc,cookbook/wbc.sql,2022-07-18T00:11:24.246886,success,model,,,
Q023,,debug,Began running node model.mimic.suspicion_of_infection,109348,Thread-1,2022-07-18T00:11:24.483559Z,table,null,suspicion_of_infection,treatment/suspicion_of_infection.sql,2022-07-18T00:11:24.483460,started,model,,,
Q033,,info,79 of 107 START table model public.suspicion_of_infection ...................... [RUN],109348,Thread-1,2022-07-18T00:11:24.484366Z,table,null,suspicion_of_infection,treatment/suspicion_of_infection.sql,2022-07-18T00:11:24.483460,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.suspicion_of_infection""",109348,Thread-1,2022-07-18T00:11:24.485250Z
Q030,,debug,Began compiling node model.mimic.suspicion_of_infection,109348,Thread-1,2022-07-18T00:11:24.485707Z,table,null,suspicion_of_infection,treatment/suspicion_of_infection.sql,2022-07-18T00:11:24.483460,compiling,model,,,
Q027,,debug,Compiling model.mimic.suspicion_of_infection,109348,Thread-1,2022-07-18T00:11:24.486012Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.suspicion_of_infection""",109348,Thread-1,2022-07-18T00:11:24.489472Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:24.490201Z
Q031,,debug,Began executing node model.mimic.suspicion_of_infection,109348,Thread-1,2022-07-18T00:11:24.490505Z,table,null,suspicion_of_infection,treatment/suspicion_of_infection.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.suspicion_of_infection""",109348,Thread-1,2022-07-18T00:11:24.500478Z
E015,,debug,"Using postgres connection ""model.mimic.suspicion_of_infection""",109348,Thread-1,2022-07-18T00:11:24.501112Z
E016,,debug,On model.mimic.suspicion_of_infection: BEGIN,109348,Thread-1,2022-07-18T00:11:24.501343Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:11:24.501460Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:24.508399Z
E015,,debug,"Using postgres connection ""model.mimic.suspicion_of_infection""",109348,Thread-1,2022-07-18T00:11:24.508709Z
E016,,debug,"On model.mimic.suspicion_of_infection: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.suspicion_of_infection""} */


  create  table ""postgres"".""public"".""suspicion_of_infection__dbt_tmp""
  as (
     

-- defines suspicion of infection using prescriptions + microbiologyevents
with abx as
(
  select pr.hadm_id
  , pr.drug as antibiotic_name
  , pr.startdate as antibiotic_time
  , pr.enddate as antibiotic_endtime
  from prescriptions pr
  -- inner join to subselect to only antibiotic prescriptions
  inner join ""postgres"".""public"".""abx_prescriptions_list"" ab
      on pr.drug = ab.drug
)
-- get cultures for each icustay
-- note this duplicates prescriptions
-- each ICU stay in the same hospitalization will get a copy of all prescriptions for that hospitalization
, ab_tbl as
(
  select
        ie.subject_id, ie.hadm_id, ie.icustay_id
      , ie.intime, ie.outtime
      , abx.antibiotic_name
      , abx.antibiotic_time
      , abx.antibiotic_endtime
  from icustays ie
  left join abx
      on ie.hadm_id = abx.hadm_id
)
, me as
(
  select hadm_id
    , chartdate, charttime
    , spec_type_desc
    , max(case when org_name is not null and org_name != '' then 1 else 0 end) as PositiveCulture
  from microbiologyevents
  group by hadm_id, chartdate, charttime, spec_type_desc
)
, ab_fnl as
(
  select
      ab_tbl.icustay_id, ab_tbl.intime, ab_tbl.outtime
    , ab_tbl.antibiotic_name
    , ab_tbl.antibiotic_time
    , coalesce(me72.charttime,me72.chartdate) as last72_charttime
    , coalesce(me24.charttime,me24.chartdate) as next24_charttime
    , me72.positiveculture as last72_positiveculture
    , me72.spec_type_desc as last72_specimen
    , me24.positiveculture as next24_positiveculture
    , me24.spec_type_desc as next24_specimen
  from ab_tbl
  -- blood culture in last 72 hours
  left join me me72
    on ab_tbl.hadm_id = me72.hadm_id
    and ab_tbl.antibiotic_time is not null
    and
    (
      -- if charttime is available, use it
      (
          ab_tbl.antibiotic_time >= me72.charttime
      and ab_tbl.antibiotic_time <= datetime_add(me72.charttime, INTERVAL '72 HOUR')
      )
      OR
      (
      -- if charttime is not available, use chartdate
          me72.charttime is null
      and ab_tbl.antibiotic_time >= me72.chartdate
      and ab_tbl.antibiotic_time <= datetime_add(me72.chartdate, INTERVAL '96 HOUR')
      )
    )
  -- blood culture in subsequent 24 hours
  left join me me24
    on ab_tbl.hadm_id = me24.hadm_id
    and ab_tbl.antibiotic_time is not null
    and
    (
      -- if charttime is available, use it
      (
          ab_tbl.antibiotic_time <= me24.charttime
      and ab_tbl.antibiotic_time >= datetime_sub(me24.charttime, INTERVAL '24 HOUR')
      )
      OR
      (
      -- if charttime is not available, use chartdate
          me24.charttime is null
      and ab_tbl.antibiotic_time <= me24.chartdate
      and ab_tbl.antibiotic_time >= datetime_sub(me24.chartdate, INTERVAL '24 HOUR')
      )
    )
)
, ab_laststg as
(
select
  icustay_id
  , antibiotic_name
  , antibiotic_time
  , last72_charttime
  , next24_charttime

  -- time of suspected infection: either the culture time (if before antibiotic), or the antibiotic time
  , case
      when coalesce(last72_charttime,next24_charttime) is null
        then 0
      else 1 end as suspected_infection

  , coalesce(last72_charttime,next24_charttime) as suspected_infection_time

  -- the specimen that was cultured
  , case
      when last72_charttime is not null
        then last72_specimen
      when next24_charttime is not null
        then next24_specimen
    else null
  end as specimen

  -- whether the cultured specimen ended up being positive or not
  , case
      when last72_charttime is not null
        then last72_positiveculture
      when next24_charttime is not null
        then next24_positiveculture
    else null
  end as positiveculture
from ab_fnl
)
select
  icustay_id
  , antibiotic_name
  , antibiotic_time
  , last72_charttime
  , next24_charttime
  , suspected_infection_time
  -- -- the below two fields are used to extract data - modifying them facilitates sensitivity analyses
  -- , suspected_infection_time - interval '48' hour as si_starttime
  -- , suspected_infection_time + interval '24' hour as si_endtime
  , specimen, positiveculture
from ab_laststg
order by icustay_id, antibiotic_time
  );",109348,Thread-1,2022-07-18T00:11:24.508953Z
E017,,debug,SQL status: SELECT 1374912 in 9.94 seconds,109348,Thread-1,2022-07-18T00:11:34.449539Z
E015,,debug,"Using postgres connection ""model.mimic.suspicion_of_infection""",109348,Thread-1,2022-07-18T00:11:34.456320Z
E016,,debug,"On model.mimic.suspicion_of_infection: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.suspicion_of_infection""} */
alter table ""postgres"".""public"".""suspicion_of_infection"" rename to ""suspicion_of_infection__dbt_backup""",109348,Thread-1,2022-07-18T00:11:34.456766Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:34.458881Z
E015,,debug,"Using postgres connection ""model.mimic.suspicion_of_infection""",109348,Thread-1,2022-07-18T00:11:34.462748Z
E016,,debug,"On model.mimic.suspicion_of_infection: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.suspicion_of_infection""} */
alter table ""postgres"".""public"".""suspicion_of_infection__dbt_tmp"" rename to ""suspicion_of_infection""",109348,Thread-1,2022-07-18T00:11:34.462985Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:34.463745Z
E018,,debug,On model.mimic.suspicion_of_infection: COMMIT,109348,Thread-1,2022-07-18T00:11:34.466860Z
E015,,debug,"Using postgres connection ""model.mimic.suspicion_of_infection""",109348,Thread-1,2022-07-18T00:11:34.467086Z
E016,,debug,On model.mimic.suspicion_of_infection: COMMIT,109348,Thread-1,2022-07-18T00:11:34.467309Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:34.471121Z
E015,,debug,"Using postgres connection ""model.mimic.suspicion_of_infection""",109348,Thread-1,2022-07-18T00:11:34.473493Z
E016,,debug,"On model.mimic.suspicion_of_infection: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.suspicion_of_infection""} */
drop table if exists ""postgres"".""public"".""suspicion_of_infection__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:11:34.473970Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:34.478122Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:34.481042Z
E010,,debug,On model.mimic.suspicion_of_infection: Close,109348,Thread-1,2022-07-18T00:11:34.481308Z
Q012,9,info,79 of 107 OK created table model public.suspicion_of_infection ................. [[32mSELECT 1374912[0m in 10.00s],109348,Thread-1,2022-07-18T00:11:34.482234Z,table,null,suspicion_of_infection,treatment/suspicion_of_infection.sql,2022-07-18T00:11:24.483460,compiling,model,,,
Q024,9.997190713882446,debug,Finished running node model.mimic.suspicion_of_infection,109348,Thread-1,2022-07-18T00:11:34.482896Z,table,2022-07-18T00:11:34.482723,suspicion_of_infection,treatment/suspicion_of_infection.sql,2022-07-18T00:11:24.483460,success,model,,,
Q023,,debug,Began running node model.mimic.blood_gas_first_day_arterial,109348,Thread-1,2022-07-18T00:11:34.483437Z,table,null,blood_gas_first_day_arterial,firstday/blood_gas_first_day_arterial.sql,2022-07-18T00:11:34.483339,started,model,,,
Q033,,info,80 of 107 START table model public.blood_gas_first_day_arterial ................ [RUN],109348,Thread-1,2022-07-18T00:11:34.484179Z,table,null,blood_gas_first_day_arterial,firstday/blood_gas_first_day_arterial.sql,2022-07-18T00:11:34.483339,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.blood_gas_first_day_arterial""",109348,Thread-1,2022-07-18T00:11:34.484995Z
Q030,,debug,Began compiling node model.mimic.blood_gas_first_day_arterial,109348,Thread-1,2022-07-18T00:11:34.485341Z,table,null,blood_gas_first_day_arterial,firstday/blood_gas_first_day_arterial.sql,2022-07-18T00:11:34.483339,compiling,model,,,
Q027,,debug,Compiling model.mimic.blood_gas_first_day_arterial,109348,Thread-1,2022-07-18T00:11:34.485815Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.blood_gas_first_day_arterial""",109348,Thread-1,2022-07-18T00:11:34.488878Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:34.489980Z
Q031,,debug,Began executing node model.mimic.blood_gas_first_day_arterial,109348,Thread-1,2022-07-18T00:11:34.490391Z,table,null,blood_gas_first_day_arterial,firstday/blood_gas_first_day_arterial.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.blood_gas_first_day_arterial""",109348,Thread-1,2022-07-18T00:11:34.500555Z
E015,,debug,"Using postgres connection ""model.mimic.blood_gas_first_day_arterial""",109348,Thread-1,2022-07-18T00:11:34.501280Z
E016,,debug,On model.mimic.blood_gas_first_day_arterial: BEGIN,109348,Thread-1,2022-07-18T00:11:34.501723Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:11:34.502104Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:34.508301Z
E015,,debug,"Using postgres connection ""model.mimic.blood_gas_first_day_arterial""",109348,Thread-1,2022-07-18T00:11:34.508585Z
E016,,debug,"On model.mimic.blood_gas_first_day_arterial: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.blood_gas_first_day_arterial""} */


  create  table ""postgres"".""public"".""blood_gas_first_day_arterial__dbt_tmp""
  as (
    with stg_spo2 as
(
  select subject_id, hadm_id, icustay_id, charttime
    -- max here is just used to group SpO2 by charttime
    , max(case when valuenum <= 0 or valuenum > 100 then null else valuenum end) as SpO2
  FROM chartevents
  -- o2 sat
  where ITEMID in
  (
    646 -- SpO2
  , 220277 -- O2 saturation pulseoxymetry
  )
  group by subject_id, hadm_id, icustay_id, charttime
)
, stg_fio2 as
(
  select subject_id, hadm_id, icustay_id, charttime
    -- pre-process the FiO2s to ensure they are between 21-100%
    , max(
        case
          when itemid = 223835
            then case
              when valuenum > 0 and valuenum <= 1
                then valuenum * 100
              -- improperly input data - looks like O2 flow in litres
              when valuenum > 1 and valuenum < 21
                then null
              when valuenum >= 21 and valuenum <= 100
                then valuenum
              else null end -- unphysiological
        when itemid in (3420, 3422)
        -- all these values are well formatted
            then valuenum
        when itemid = 190 and valuenum > 0.20 and valuenum < 1
        -- well formatted but not in %
            then valuenum * 100
      else null end
    ) as fio2_chartevents
  FROM chartevents
  where ITEMID in
  (
    3420 -- FiO2
  , 190 -- FiO2 set
  , 223835 -- Inspired O2 Fraction (FiO2)
  , 3422 -- FiO2 [measured]
  )
  -- exclude rows marked as error
  AND (error IS NULL OR error = 0)
  group by subject_id, hadm_id, icustay_id, charttime
)
, stg2 as
(
select bg.*
  , ROW_NUMBER() OVER (partition by bg.icustay_id, bg.charttime order by s1.charttime DESC) as lastRowSpO2
  , s1.spo2
from ""postgres"".""public"".""blood_gas_first_day"" bg
left join stg_spo2 s1
  -- same patient
  on  bg.icustay_id = s1.icustay_id
  -- spo2 occurred at most 2 hours before this blood gas
  and s1.charttime >= DATETIME_SUB(bg.charttime, INTERVAL '2' HOUR)
  and s1.charttime <= bg.charttime
where bg.po2 is not null
)
, stg3 as
(
select bg.*
  , ROW_NUMBER() OVER (partition by bg.icustay_id, bg.charttime order by s2.charttime DESC) as lastRowFiO2
  , s2.fio2_chartevents

  -- create our specimen prediction
  ,  1/(1+exp(-(-0.02544
  +    0.04598 * po2
  + coalesce(-0.15356 * spo2             , -0.15356 *   97.49420 +    0.13429)
  + coalesce( 0.00621 * fio2_chartevents ,  0.00621 *   51.49550 +   -0.24958)
  + coalesce( 0.10559 * hemoglobin       ,  0.10559 *   10.32307 +    0.05954)
  + coalesce( 0.13251 * so2              ,  0.13251 *   93.66539 +   -0.23172)
  + coalesce(-0.01511 * pco2             , -0.01511 *   42.08866 +   -0.01630)
  + coalesce( 0.01480 * fio2             ,  0.01480 *   63.97836 +   -0.31142)
  + coalesce(-0.00200 * aado2            , -0.00200 *  442.21186 +   -0.01328)
  + coalesce(-0.03220 * bicarbonate      , -0.03220 *   22.96894 +   -0.06535)
  + coalesce( 0.05384 * totalco2         ,  0.05384 *   24.72632 +   -0.01405)
  + coalesce( 0.08202 * lactate          ,  0.08202 *    3.06436 +    0.06038)
  + coalesce( 0.10956 * ph               ,  0.10956 *    7.36233 +   -0.00617)
  + coalesce( 0.00848 * o2flow           ,  0.00848 *    7.59362 +   -0.35803)
  ))) as SPECIMEN_PROB
from stg2 bg
left join stg_fio2 s2
  -- same patient
  on  bg.icustay_id = s2.icustay_id
  -- fio2 occurred at most 4 hours before this blood gas
  and s2.charttime between DATETIME_SUB(bg.charttime, INTERVAL '4' HOUR) and bg.charttime
where bg.lastRowSpO2 = 1 -- only the row with the most recent SpO2 (if no SpO2 found lastRowSpO2 = 1)
)

select subject_id, hadm_id,
icustay_id, charttime
, specimen -- raw data indicating sample type, only present 80% of the time

-- prediction of specimen for missing data
, case
      when SPECIMEN is not null then SPECIMEN
      when SPECIMEN_PROB > 0.75 then 'ART'
    else null end as SPECIMEN_PRED
, specimen_prob
-- oxygen related parameters
, so2, spo2 -- note spo2 is FROM chartevents
, po2, pco2
, fio2_chartevents, fio2
, aado2
-- also calculate AADO2
, case
    when  PO2 is not null
      and pco2 is not null
      and coalesce(fio2, fio2_chartevents) is not null
     -- multiple by 100 because FiO2 is in a % but should be a fraction
      then (coalesce(fio2, fio2_chartevents)/100) * (760 - 47) - (pco2/0.8) - po2
    else null
  end as AADO2_calc
, case
    when PO2 is not null and coalesce(fio2, fio2_chartevents) is not null
     -- multiply by 100 because FiO2 is in a % but should be a fraction
      then 100*PO2/(coalesce(fio2, fio2_chartevents))
    else null
  end as PaO2FiO2
-- acid-base parameters
, ph, baseexcess
, bicarbonate, totalco2

-- blood count parameters
, hematocrit
, hemoglobin
, carboxyhemoglobin
, methemoglobin

-- chemistry
, chloride, calcium
, temperature
, potassium, sodium
, lactate
, glucose

-- ventilation stuff that's sometimes input
, intubated, tidalvolume, ventilationrate, ventilator
, peep, o2flow
, requiredo2

from stg3
where lastRowFiO2 = 1 -- only the most recent FiO2
-- restrict it to *only* arterial samples
and (specimen = 'ART' or specimen_prob > 0.75)
order by icustay_id, charttime
  );",109348,Thread-1,2022-07-18T00:11:34.508798Z
E017,,debug,SQL status: SELECT 0 in 0.02 seconds,109348,Thread-1,2022-07-18T00:11:34.526729Z
E015,,debug,"Using postgres connection ""model.mimic.blood_gas_first_day_arterial""",109348,Thread-1,2022-07-18T00:11:34.533947Z
E016,,debug,"On model.mimic.blood_gas_first_day_arterial: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.blood_gas_first_day_arterial""} */
alter table ""postgres"".""public"".""blood_gas_first_day_arterial"" rename to ""blood_gas_first_day_arterial__dbt_backup""",109348,Thread-1,2022-07-18T00:11:34.534301Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:34.535403Z
E015,,debug,"Using postgres connection ""model.mimic.blood_gas_first_day_arterial""",109348,Thread-1,2022-07-18T00:11:34.539073Z
E016,,debug,"On model.mimic.blood_gas_first_day_arterial: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.blood_gas_first_day_arterial""} */
alter table ""postgres"".""public"".""blood_gas_first_day_arterial__dbt_tmp"" rename to ""blood_gas_first_day_arterial""",109348,Thread-1,2022-07-18T00:11:34.539308Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:34.540030Z
E018,,debug,On model.mimic.blood_gas_first_day_arterial: COMMIT,109348,Thread-1,2022-07-18T00:11:34.543243Z
E015,,debug,"Using postgres connection ""model.mimic.blood_gas_first_day_arterial""",109348,Thread-1,2022-07-18T00:11:34.543472Z
E016,,debug,On model.mimic.blood_gas_first_day_arterial: COMMIT,109348,Thread-1,2022-07-18T00:11:34.543708Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:34.544998Z
E015,,debug,"Using postgres connection ""model.mimic.blood_gas_first_day_arterial""",109348,Thread-1,2022-07-18T00:11:34.550391Z
E016,,debug,"On model.mimic.blood_gas_first_day_arterial: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.blood_gas_first_day_arterial""} */
drop table if exists ""postgres"".""public"".""blood_gas_first_day_arterial__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:11:34.550693Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:34.553205Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:34.556505Z
E010,,debug,On model.mimic.blood_gas_first_day_arterial: Close,109348,Thread-1,2022-07-18T00:11:34.556760Z
Q012,0,info,80 of 107 OK created table model public.blood_gas_first_day_arterial ........... [[32mSELECT 0[0m in 0.07s],109348,Thread-1,2022-07-18T00:11:34.557300Z,table,null,blood_gas_first_day_arterial,firstday/blood_gas_first_day_arterial.sql,2022-07-18T00:11:34.483339,compiling,model,,,
Q024,0.07248759269714355,debug,Finished running node model.mimic.blood_gas_first_day_arterial,109348,Thread-1,2022-07-18T00:11:34.557924Z,table,2022-07-18T00:11:34.557568,blood_gas_first_day_arterial,firstday/blood_gas_first_day_arterial.sql,2022-07-18T00:11:34.483339,success,model,,,
Q023,,debug,Began running node model.mimic.height_first_day,109348,Thread-1,2022-07-18T00:11:34.558519Z,table,null,height_first_day,firstday/height_first_day.sql,2022-07-18T00:11:34.558461,started,model,,,
Q033,,info,81 of 107 START table model public.height_first_day ............................ [RUN],109348,Thread-1,2022-07-18T00:11:34.559239Z,table,null,height_first_day,firstday/height_first_day.sql,2022-07-18T00:11:34.558461,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.height_first_day""",109348,Thread-1,2022-07-18T00:11:34.560485Z
Q030,,debug,Began compiling node model.mimic.height_first_day,109348,Thread-1,2022-07-18T00:11:34.560787Z,table,null,height_first_day,firstday/height_first_day.sql,2022-07-18T00:11:34.558461,compiling,model,,,
Q027,,debug,Compiling model.mimic.height_first_day,109348,Thread-1,2022-07-18T00:11:34.561174Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.height_first_day""",109348,Thread-1,2022-07-18T00:11:34.565283Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:34.566236Z
Q031,,debug,Began executing node model.mimic.height_first_day,109348,Thread-1,2022-07-18T00:11:34.566572Z,table,null,height_first_day,firstday/height_first_day.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.height_first_day""",109348,Thread-1,2022-07-18T00:11:34.578110Z
E015,,debug,"Using postgres connection ""model.mimic.height_first_day""",109348,Thread-1,2022-07-18T00:11:34.578912Z
E016,,debug,On model.mimic.height_first_day: BEGIN,109348,Thread-1,2022-07-18T00:11:34.579201Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:11:34.579358Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:34.586305Z
E015,,debug,"Using postgres connection ""model.mimic.height_first_day""",109348,Thread-1,2022-07-18T00:11:34.586634Z
E016,,debug,"On model.mimic.height_first_day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.height_first_day""} */


  create  table ""postgres"".""public"".""height_first_day__dbt_tmp""
  as (
    -- This query extracts heights for adult ICU patients.
-- It uses all information from the patient's first ICU day.
-- This is done for consistency with other queries - it's not necessarily needed.
-- Height is unlikely to change throughout a patient's stay.

-- ** Requires the echodata view, generated by concepts/echo-data.sql

-- staging table to ensure all heights are in centimeters
with ce0 as
(
    SELECT
      c.icustay_id
      , case
        -- convert inches to centimetres
          when itemid in (920, 1394, 4187, 3486)
              then valuenum * 2.54
            else valuenum
        end as Height
    FROM chartevents c
    inner join icustays ie
        on c.icustay_id = ie.icustay_id
        and c.charttime <= DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
        and c.charttime > DATETIME_SUB(ie.intime, INTERVAL '1' DAY) -- some fuzziness for admit time
    WHERE c.valuenum IS NOT NULL
    AND c.itemid in (226730,920, 1394, 4187, 3486,3485,4188) -- height
    AND c.valuenum != 0
    -- exclude rows marked as error
    AND (c.error IS NULL OR c.error = 0)
)
, ce as
(
    SELECT
        icustay_id
        -- extract the median height from the chart to add robustness against outliers
        , AVG(height) as Height_chart
    from ce0
    where height > 100
    group by icustay_id
)
-- requires the echo-data.sql query to run
-- this adds heights from the free-text echo notes
, echo as
(
    select
        ec.subject_id
        -- all echo heights are in inches
        , 2.54*AVG(height) as Height_Echo
    from ""postgres"".""public"".""echo_data"" ec
    inner join icustays ie
        on ec.subject_id = ie.subject_id
        and ec.charttime < DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
    where height is not null
    and height*2.54 > 100
    group by ec.subject_id
)
select
    ie.icustay_id
    , coalesce(ce.Height_chart, ec.Height_Echo) as height

    -- components
    , ce.height_chart
    , ec.height_echo
FROM icustays ie

-- filter to only adults
inner join patients pat
    on ie.subject_id = pat.subject_id
    and ie.intime > DATETIME_ADD(pat.dob, INTERVAL '1' YEAR)

left join ce
    on ie.icustay_id = ce.icustay_id

left join echo ec
    on ie.subject_id = ec.subject_id
  );",109348,Thread-1,2022-07-18T00:11:34.586953Z
E017,,debug,SQL status: SELECT 53432 in 0.1 seconds,109348,Thread-1,2022-07-18T00:11:34.685791Z
E015,,debug,"Using postgres connection ""model.mimic.height_first_day""",109348,Thread-1,2022-07-18T00:11:34.693040Z
E016,,debug,"On model.mimic.height_first_day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.height_first_day""} */
alter table ""postgres"".""public"".""height_first_day"" rename to ""height_first_day__dbt_backup""",109348,Thread-1,2022-07-18T00:11:34.693312Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:34.694548Z
E015,,debug,"Using postgres connection ""model.mimic.height_first_day""",109348,Thread-1,2022-07-18T00:11:34.700705Z
E016,,debug,"On model.mimic.height_first_day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.height_first_day""} */
alter table ""postgres"".""public"".""height_first_day__dbt_tmp"" rename to ""height_first_day""",109348,Thread-1,2022-07-18T00:11:34.700933Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:34.701990Z
E018,,debug,On model.mimic.height_first_day: COMMIT,109348,Thread-1,2022-07-18T00:11:34.707525Z
E015,,debug,"Using postgres connection ""model.mimic.height_first_day""",109348,Thread-1,2022-07-18T00:11:34.707803Z
E016,,debug,On model.mimic.height_first_day: COMMIT,109348,Thread-1,2022-07-18T00:11:34.708108Z
E017,,debug,SQL status: COMMIT in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:34.714824Z
E015,,debug,"Using postgres connection ""model.mimic.height_first_day""",109348,Thread-1,2022-07-18T00:11:34.717687Z
E016,,debug,"On model.mimic.height_first_day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.height_first_day""} */
drop table if exists ""postgres"".""public"".""height_first_day__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:11:34.718088Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:34.721098Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:34.724610Z
E010,,debug,On model.mimic.height_first_day: Close,109348,Thread-1,2022-07-18T00:11:34.724874Z
Q012,0,info,81 of 107 OK created table model public.height_first_day ....................... [[32mSELECT 53432[0m in 0.17s],109348,Thread-1,2022-07-18T00:11:34.725470Z,table,null,height_first_day,firstday/height_first_day.sql,2022-07-18T00:11:34.558461,compiling,model,,,
Q024,0.16524863243103027,debug,Finished running node model.mimic.height_first_day,109348,Thread-1,2022-07-18T00:11:34.726563Z,table,2022-07-18T00:11:34.726343,height_first_day,firstday/height_first_day.sql,2022-07-18T00:11:34.558461,success,model,,,
Q023,,debug,Began running node model.mimic.weight_durations,109348,Thread-1,2022-07-18T00:11:34.727355Z,table,null,weight_durations,durations/weight_durations.sql,2022-07-18T00:11:34.727264,started,model,,,
Q033,,info,82 of 107 START table model public.weight_durations ............................ [RUN],109348,Thread-1,2022-07-18T00:11:34.727884Z,table,null,weight_durations,durations/weight_durations.sql,2022-07-18T00:11:34.727264,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.weight_durations""",109348,Thread-1,2022-07-18T00:11:34.729085Z
Q030,,debug,Began compiling node model.mimic.weight_durations,109348,Thread-1,2022-07-18T00:11:34.729398Z,table,null,weight_durations,durations/weight_durations.sql,2022-07-18T00:11:34.727264,compiling,model,,,
Q027,,debug,Compiling model.mimic.weight_durations,109348,Thread-1,2022-07-18T00:11:34.729889Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.weight_durations""",109348,Thread-1,2022-07-18T00:11:34.733988Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:34.734854Z
Q031,,debug,Began executing node model.mimic.weight_durations,109348,Thread-1,2022-07-18T00:11:34.735179Z,table,null,weight_durations,durations/weight_durations.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.weight_durations""",109348,Thread-1,2022-07-18T00:11:34.745207Z
E015,,debug,"Using postgres connection ""model.mimic.weight_durations""",109348,Thread-1,2022-07-18T00:11:34.746371Z
E016,,debug,On model.mimic.weight_durations: BEGIN,109348,Thread-1,2022-07-18T00:11:34.746818Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:11:34.747134Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:34.753232Z
E015,,debug,"Using postgres connection ""model.mimic.weight_durations""",109348,Thread-1,2022-07-18T00:11:34.753545Z
E016,,debug,"On model.mimic.weight_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.weight_durations""} */


  create  table ""postgres"".""public"".""weight_durations__dbt_tmp""
  as (
    -- This query extracts weights for adult ICU patients with start/stop times
-- if an admission weight is given, then this is assigned from intime to outtime

-- This query extracts weights for adult ICU patients with start/stop times
-- if an admission weight is given, then this is assigned from intime to outtime
WITH wt_neonate AS
( 
    SELECT c.icustay_id, c.charttime
    , MAX(CASE WHEN c.itemid = 3580 THEN c.valuenum END) as wt_kg
    , MAX(CASE WHEN c.itemid = 3581 THEN c.valuenum END) as wt_lb
    , MAX(CASE WHEN c.itemid = 3582 THEN c.valuenum END) as wt_oz
    FROM chartevents c
    WHERE c.itemid in (3580, 3581, 3582)
    AND c.icustay_id IS NOT NULL
    AND COALESCE(c.error, 0) = 0
    -- wt_oz/wt_lb/wt_kg are only 0 erroneously, so drop these rows
    AND c.valuenum > 0
  -- a separate query was run to manually verify only 1 value exists per
  -- icustay_id/charttime/itemid grouping
  -- therefore, we can use max() across itemid to collapse these values to 1 row per group
    GROUP BY c.icustay_id, c.charttime
)
, birth_wt AS
(
    SELECT c.icustay_id, c.charttime
    , MAX(
      CASE
      WHEN c.itemid = 4183 THEN
        -- clean free-text birth weight data
        CASE
          -- ignore value if there are any non-numeric characters
          WHEN REGEXP_CONTAINS(c.value, '[^0-9\\.]') THEN NULL 
          -- convert grams to kd
          WHEN CAST(c.value AS NUMERIC) > 100 THEN CAST(c.value AS NUMERIC)/1000
          -- keep kg as is, filtering bad values (largest baby ever born was conveniently 9.98kg)
          WHEN CAST(c.value AS NUMERIC) < 10 THEN CAST(c.value AS NUMERIC)
          -- ignore other values (those between 10-100) - junk data
        ELSE NULL END
      -- itemid 3723 happily has all numeric data - also doesn't store any grams data
      WHEN c.itemid = 3723 AND c.valuenum < 10 THEN c.valuenum
      ELSE NULL END) as wt_kg
    FROM chartevents c
    WHERE c.itemid in (3723, 4183)
    AND c.icustay_id IS NOT NULL
    AND COALESCE(c.error, 0) = 0
  -- a separate query was run to manually verify only 1 value exists per
  -- icustay_id/charttime/itemid grouping
  -- therefore, we can use max() across itemid to collapse these values to 1 row per group
    GROUP BY c.icustay_id, c.charttime
)
, wt_stg as
(
    SELECT
        c.icustay_id
      , c.charttime
      , case when c.itemid in (762,226512) then 'admit'
          else 'daily' end as weight_type
      -- TODO: eliminate obvious outliers if there is a reasonable weight
      , c.valuenum as weight
    FROM chartevents c
    WHERE c.valuenum IS NOT NULL
      AND c.itemid in
      (
          762,226512 -- Admit Wt
        , 763,224639 -- Daily Weight
      )
      AND c.icustay_id IS NOT NULL
      AND c.valuenum > 0
      -- exclude rows marked as error
      AND COALESCE(c.error, 0) = 0
    UNION ALL
    SELECT
        n.icustay_id
      , n.charttime
      , 'daily' AS weight_type
      , CASE
          WHEN wt_kg IS NOT NULL THEN wt_kg
          WHEN wt_lb IS NOT NULL THEN wt_lb*0.45359237 + wt_oz*0.0283495231
        ELSE NULL END AS weight
    FROM wt_neonate n
    UNION ALL
    SELECT
        b.icustay_id
      , b.charttime
      -- birth weight of neonates is treated as admission weight
      , 'admit' AS weight_type
      , wt_kg as weight
    FROM birth_wt b
)
-- get more weights from echo - completes data for ~2500 patients
-- we only use echo data if there is *no* charted data
-- we impute the median echo weight for their entire ICU stay
, echo as
(
  select
    ie.icustay_id
    , ec.charttime
    , 'echo' AS weight_type
    , 0.453592*ec.weight as weight
  from icustays ie
  inner join ""postgres"".""public"".""echo_data"" ec
    on ie.hadm_id = ec.hadm_id
  where ec.weight is not null
  and ie.icustay_id not in (select distinct icustay_id from wt_stg)
)
, wt_stg0 AS
(
  SELECT icustay_id, charttime, weight_type, weight
  FROM wt_stg
  UNION ALL
  SELECT icustay_id, charttime, weight_type, weight
  FROM echo
)
-- assign ascending row number
, wt_stg1 as
(
  select
      icustay_id
    , charttime
    , weight_type
    , weight
    , ROW_NUMBER() OVER (partition by icustay_id, weight_type order by charttime) as rn
  from wt_stg0
  WHERE weight IS NOT NULL
)
-- change charttime to intime for the first admission weight recorded
, wt_stg2 AS
(
  SELECT 
      wt_stg1.icustay_id
    , ie.intime, ie.outtime
    , case when wt_stg1.weight_type = 'admit' and wt_stg1.rn = 1
        then DATETIME_SUB(ie.intime, INTERVAL '2' HOUR)
      else wt_stg1.charttime end as starttime
    , wt_stg1.weight
  from wt_stg1
  INNER JOIN icustays ie
    on ie.icustay_id = wt_stg1.icustay_id
)
, wt_stg3 as
(
  select
    icustay_id
    , intime, outtime
    , starttime
    , coalesce(
        LEAD(starttime) OVER (PARTITION BY icustay_id ORDER BY starttime),
        DATETIME_ADD(GREATEST(outtime, starttime), INTERVAL '2' HOUR)
      ) as endtime
    , weight
  from wt_stg2
)
-- this table is the start/stop times from admit/daily weight in charted data
, wt1 as
(
  select
      icustay_id
    , starttime
    , coalesce(endtime,
      LEAD(starttime) OVER (partition by icustay_id order by starttime),
      -- impute ICU discharge as the end of the final weight measurement
      -- plus a 2 hour ""fuzziness"" window
      DATETIME_ADD(outtime, INTERVAL '2' HOUR)
    ) as endtime
    , weight
  from wt_stg3
)
-- if the intime for the patient is < the first charted daily weight
-- then we will have a ""gap"" at the start of their stay
-- to prevent this, we look for these gaps and backfill the first weight
-- this adds (153255-149657)=3598 rows, meaning this fix helps for up to 3598 icustay_id
, wt_fix as
(
  select ie.icustay_id
    -- we add a 2 hour ""fuzziness"" window
    , DATETIME_SUB(ie.intime, INTERVAL '2' HOUR) as starttime
    , wt.starttime as endtime
    , wt.weight
  from icustays ie
  inner join
  -- the below subquery returns one row for each unique icustay_id
  -- the row contains: the first starttime and the corresponding weight
  (
    SELECT wt1.icustay_id, wt1.starttime, wt1.weight
    , ROW_NUMBER() OVER (PARTITION BY wt1.icustay_id ORDER BY wt1.starttime) as rn
    FROM wt1
  ) wt
    ON  ie.icustay_id = wt.icustay_id
    AND wt.rn = 1
    and ie.intime < wt.starttime
)
-- add the backfill rows to the main weight table
select
    wt1.icustay_id
  , wt1.starttime
  , wt1.endtime
  , wt1.weight
from wt1
UNION ALL
SELECT
    wt_fix.icustay_id
  , wt_fix.starttime
  , wt_fix.endtime
  , wt_fix.weight
from wt_fix
  );",109348,Thread-1,2022-07-18T00:11:34.753884Z
E017,,debug,SQL status: SELECT 15 in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:34.761216Z
E015,,debug,"Using postgres connection ""model.mimic.weight_durations""",109348,Thread-1,2022-07-18T00:11:34.767431Z
E016,,debug,"On model.mimic.weight_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.weight_durations""} */
alter table ""postgres"".""public"".""weight_durations"" rename to ""weight_durations__dbt_backup""",109348,Thread-1,2022-07-18T00:11:34.767754Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:34.768932Z
E015,,debug,"Using postgres connection ""model.mimic.weight_durations""",109348,Thread-1,2022-07-18T00:11:34.774547Z
E016,,debug,"On model.mimic.weight_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.weight_durations""} */
alter table ""postgres"".""public"".""weight_durations__dbt_tmp"" rename to ""weight_durations""",109348,Thread-1,2022-07-18T00:11:34.775039Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:34.776425Z
E018,,debug,On model.mimic.weight_durations: COMMIT,109348,Thread-1,2022-07-18T00:11:34.780814Z
E015,,debug,"Using postgres connection ""model.mimic.weight_durations""",109348,Thread-1,2022-07-18T00:11:34.781256Z
E016,,debug,On model.mimic.weight_durations: COMMIT,109348,Thread-1,2022-07-18T00:11:34.781798Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:34.783554Z
E015,,debug,"Using postgres connection ""model.mimic.weight_durations""",109348,Thread-1,2022-07-18T00:11:34.787066Z
E016,,debug,"On model.mimic.weight_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.weight_durations""} */
drop table if exists ""postgres"".""public"".""weight_durations__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:11:34.787485Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:34.790292Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:34.793523Z
E010,,debug,On model.mimic.weight_durations: Close,109348,Thread-1,2022-07-18T00:11:34.793981Z
Q012,0,info,82 of 107 OK created table model public.weight_durations ....................... [[32mSELECT 15[0m in 0.07s],109348,Thread-1,2022-07-18T00:11:34.794917Z,table,null,weight_durations,durations/weight_durations.sql,2022-07-18T00:11:34.727264,compiling,model,,,
Q024,0.06604170799255371,debug,Finished running node model.mimic.weight_durations,109348,Thread-1,2022-07-18T00:11:34.795666Z,table,2022-07-18T00:11:34.795463,weight_durations,durations/weight_durations.sql,2022-07-18T00:11:34.727264,success,model,,,
Q023,,debug,Began running node model.mimic.weight_first_day,109348,Thread-1,2022-07-18T00:11:34.796590Z,table,null,weight_first_day,firstday/weight_first_day.sql,2022-07-18T00:11:34.796502,started,model,,,
Q033,,info,83 of 107 START table model public.weight_first_day ............................ [RUN],109348,Thread-1,2022-07-18T00:11:34.798005Z,table,null,weight_first_day,firstday/weight_first_day.sql,2022-07-18T00:11:34.796502,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.weight_first_day""",109348,Thread-1,2022-07-18T00:11:34.800111Z
Q030,,debug,Began compiling node model.mimic.weight_first_day,109348,Thread-1,2022-07-18T00:11:34.800442Z,table,null,weight_first_day,firstday/weight_first_day.sql,2022-07-18T00:11:34.796502,compiling,model,,,
Q027,,debug,Compiling model.mimic.weight_first_day,109348,Thread-1,2022-07-18T00:11:34.800777Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.weight_first_day""",109348,Thread-1,2022-07-18T00:11:34.803819Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:34.804400Z
Q031,,debug,Began executing node model.mimic.weight_first_day,109348,Thread-1,2022-07-18T00:11:34.804696Z,table,null,weight_first_day,firstday/weight_first_day.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.weight_first_day""",109348,Thread-1,2022-07-18T00:11:34.813958Z
E015,,debug,"Using postgres connection ""model.mimic.weight_first_day""",109348,Thread-1,2022-07-18T00:11:34.814904Z
E016,,debug,On model.mimic.weight_first_day: BEGIN,109348,Thread-1,2022-07-18T00:11:34.815267Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:11:34.815571Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:34.823846Z
E015,,debug,"Using postgres connection ""model.mimic.weight_first_day""",109348,Thread-1,2022-07-18T00:11:34.824402Z
E016,,debug,"On model.mimic.weight_first_day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.weight_first_day""} */


  create  table ""postgres"".""public"".""weight_first_day__dbt_tmp""
  as (
    -- This query extracts weights for adult ICU patients on their first ICU day.
-- It does *not* use any information after the first ICU day, as weight is
-- sometimes used to monitor fluid balance.

-- ** Requires the echodata view, generated by concepts/echo-data.sql

with ce as
(
    SELECT
      c.icustay_id
      -- we take the avg value from roughly first day
      -- TODO: eliminate obvious outliers if there is a reasonable weight
      -- (e.g. weight of 180kg and 90kg would remove 180kg instead of taking the median)
      , AVG(VALUENUM) as Weight_Admit
    FROM chartevents c
    inner join icustays ie
        on c.icustay_id = ie.icustay_id
        and c.charttime <= DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
        and c.charttime > DATETIME_SUB(ie.intime, INTERVAL '1' DAY) -- some fuzziness for admit time
    WHERE c.valuenum IS NOT NULL
    AND c.itemid in (762,226512) -- Admit Wt
    AND c.valuenum != 0
    -- exclude rows marked as error
    AND (c.error IS NULL OR c.error = 0)
    group by c.icustay_id
)
, dwt as
(
    SELECT
      c.icustay_id
      , AVG(VALUENUM) as Weight_Daily
    FROM chartevents c
    INNER JOIN icustays ie
        on c.icustay_id = ie.icustay_id
        and c.charttime <= DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
        and c.charttime > DATETIME_SUB(ie.intime, INTERVAL '1' DAY) -- some fuzziness for admit time
    WHERE c.valuenum IS NOT NULL
    AND c.itemid in (763,224639) -- Daily Weight
    AND c.valuenum != 0
    -- exclude rows marked as error
    AND (c.error IS NULL OR c.error = 0)
    group by c.icustay_id
)
-- we split in-hospital/out of hospital echoes as we would like to prioritize in-hospital data
, echo_hadm as
(
    select
        ie.icustay_id
        , 0.453592*AVG(weight) as Weight_EchoInHosp
    from ""postgres"".""public"".""echo_data"" ec
    inner join icustays ie
        on ec.hadm_id = ie.hadm_id
        and ec.charttime < DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
    where
            ec.HADM_ID is not null
        and ec.weight is not null
    group by ie.icustay_id
)
, echo_nohadm as
(
    select
        ie.icustay_id
        , 0.453592*AVG(weight) as Weight_EchoPreHosp
    from ""postgres"".""public"".""echo_data"" ec
    inner join icustays ie
        on ie.subject_id = ec.subject_id
        and ie.intime < DATETIME_ADD(ec.charttime, INTERVAL '1' MONTH)
        and ie.intime > ec.charttime
    where
            ec.HADM_ID is null
        and ec.weight is not null
    group by ie.icustay_id
)
select
    ie.icustay_id
    , round(cast(
    case
        when ce.icustay_id is not null
            then ce.Weight_Admit
        when dwt.icustay_id is not null
            then dwt.Weight_Daily
        when eh.icustay_id is not null
            then eh.Weight_EchoInHosp
        when enh.icustay_id is not null
            then enh.Weight_EchoPreHosp
        else null end
        as numeric), 2)
    as weight

    -- components
    , ce.weight_admit
    , dwt.weight_daily
    , eh.weight_echoinhosp
    , enh.weight_echoprehosp

FROM icustays ie

-- filter to only adults
inner join patients pat
    on ie.subject_id = pat.subject_id
    and ie.intime > DATETIME_ADD(pat.dob, INTERVAL '1' YEAR)

-- admission weight
left join ce
    on ie.icustay_id = ce.icustay_id

-- daily weights
left join dwt
    on ie.icustay_id = dwt.icustay_id

-- in-hospital echo weight
left join echo_hadm eh
    on ie.icustay_id = eh.icustay_id

-- pre-hospitalization echo weights
left join echo_nohadm enh
    on ie.icustay_id = enh.icustay_id
order by ie.icustay_id
  );",109348,Thread-1,2022-07-18T00:11:34.824991Z
E017,,debug,SQL status: SELECT 53432 in 0.13 seconds,109348,Thread-1,2022-07-18T00:11:34.954883Z
E015,,debug,"Using postgres connection ""model.mimic.weight_first_day""",109348,Thread-1,2022-07-18T00:11:34.959984Z
E016,,debug,"On model.mimic.weight_first_day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.weight_first_day""} */
alter table ""postgres"".""public"".""weight_first_day"" rename to ""weight_first_day__dbt_backup""",109348,Thread-1,2022-07-18T00:11:34.960260Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:34.961015Z
E015,,debug,"Using postgres connection ""model.mimic.weight_first_day""",109348,Thread-1,2022-07-18T00:11:34.967165Z
E016,,debug,"On model.mimic.weight_first_day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.weight_first_day""} */
alter table ""postgres"".""public"".""weight_first_day__dbt_tmp"" rename to ""weight_first_day""",109348,Thread-1,2022-07-18T00:11:34.967432Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:34.968258Z
E018,,debug,On model.mimic.weight_first_day: COMMIT,109348,Thread-1,2022-07-18T00:11:34.972600Z
E015,,debug,"Using postgres connection ""model.mimic.weight_first_day""",109348,Thread-1,2022-07-18T00:11:34.972959Z
E016,,debug,On model.mimic.weight_first_day: COMMIT,109348,Thread-1,2022-07-18T00:11:34.973121Z
E017,,debug,SQL status: COMMIT in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:34.979351Z
E015,,debug,"Using postgres connection ""model.mimic.weight_first_day""",109348,Thread-1,2022-07-18T00:11:34.982392Z
E016,,debug,"On model.mimic.weight_first_day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.weight_first_day""} */
drop table if exists ""postgres"".""public"".""weight_first_day__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:11:34.982686Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:34.985491Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:34.988967Z
E010,,debug,On model.mimic.weight_first_day: Close,109348,Thread-1,2022-07-18T00:11:34.989347Z
Q012,0,info,83 of 107 OK created table model public.weight_first_day ....................... [[32mSELECT 53432[0m in 0.19s],109348,Thread-1,2022-07-18T00:11:34.990263Z,table,null,weight_first_day,firstday/weight_first_day.sql,2022-07-18T00:11:34.796502,compiling,model,,,
Q024,0.19040918350219727,debug,Finished running node model.mimic.weight_first_day,109348,Thread-1,2022-07-18T00:11:34.990969Z,table,2022-07-18T00:11:34.990783,weight_first_day,firstday/weight_first_day.sql,2022-07-18T00:11:34.796502,success,model,,,
Q023,,debug,Began running node model.mimic.elixhauser_score_ahrq,109348,Thread-1,2022-07-18T00:11:34.991519Z,table,null,elixhauser_score_ahrq,comorbidity/elixhauser_score_ahrq.sql,2022-07-18T00:11:34.991413,started,model,,,
Q033,,info,84 of 107 START table model public.elixhauser_score_ahrq ....................... [RUN],109348,Thread-1,2022-07-18T00:11:34.992250Z,table,null,elixhauser_score_ahrq,comorbidity/elixhauser_score_ahrq.sql,2022-07-18T00:11:34.991413,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.elixhauser_score_ahrq""",109348,Thread-1,2022-07-18T00:11:34.993118Z
Q030,,debug,Began compiling node model.mimic.elixhauser_score_ahrq,109348,Thread-1,2022-07-18T00:11:34.993339Z,table,null,elixhauser_score_ahrq,comorbidity/elixhauser_score_ahrq.sql,2022-07-18T00:11:34.991413,compiling,model,,,
Q027,,debug,Compiling model.mimic.elixhauser_score_ahrq,109348,Thread-1,2022-07-18T00:11:34.993597Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.elixhauser_score_ahrq""",109348,Thread-1,2022-07-18T00:11:34.996531Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:34.997159Z
Q031,,debug,Began executing node model.mimic.elixhauser_score_ahrq,109348,Thread-1,2022-07-18T00:11:34.997340Z,table,null,elixhauser_score_ahrq,comorbidity/elixhauser_score_ahrq.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.elixhauser_score_ahrq""",109348,Thread-1,2022-07-18T00:11:35.005470Z
E015,,debug,"Using postgres connection ""model.mimic.elixhauser_score_ahrq""",109348,Thread-1,2022-07-18T00:11:35.006201Z
E016,,debug,On model.mimic.elixhauser_score_ahrq: BEGIN,109348,Thread-1,2022-07-18T00:11:35.006474Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:11:35.006694Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:35.012568Z
E015,,debug,"Using postgres connection ""model.mimic.elixhauser_score_ahrq""",109348,Thread-1,2022-07-18T00:11:35.012906Z
E016,,debug,"On model.mimic.elixhauser_score_ahrq: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.elixhauser_score_ahrq""} */


  create  table ""postgres"".""public"".""elixhauser_score_ahrq__dbt_tmp""
  as (
    -- This query provides various methods of combining the Elixhauser components into a single score
-- The methods are called ""vanWalRaven"" and ""SID30"", and ""SID29""
select subject_id, hadm_id
,  -- Below is the van Walraven score
   0 * aids +
   0 * alcohol_abuse +
  -2 * blood_loss_anemia +
   7 * congestive_heart_failure +
   -- Cardiac arrhythmias are not included in van Walraven based on Quan 2007
   3 * chronic_pulmonary +
   3 * coagulopathy +
  -2 * deficiency_anemias +
  -3 * depression +
   0 * diabetes_complicated +
   0 * diabetes_uncomplicated +
  -7 * drug_abuse +
   5 * fluid_electrolyte +
   0 * hypertension +
   0 * hypothyroidism +
   11 * liver_disease +
   9 * lymphoma +
   12 * metastatic_cancer +
   6 * other_neurological +
  -4 * obesity +
   7 * paralysis +
   2 * peripheral_vascular +
   0 * peptic_ulcer +
   0 * psychoses +
   4 * pulmonary_circulation +
   0 * rheumatoid_arthritis +
   5 * renal_failure +
   4 * solid_tumor +
  -1 * valvular_disease +
   6 * weight_loss
as elixhauser_vanwalraven



,  -- Below is the 29 component SID score
   0 * aids +
  -2 * alcohol_abuse +
  -2 * blood_loss_anemia +
   -- Cardiac arrhythmias are not included in SID-29
   9 * congestive_heart_failure +
   3 * chronic_pulmonary +
   9 * coagulopathy +
   0 * deficiency_anemias +
  -4 * depression +
   0 * diabetes_complicated +
  -1 * diabetes_uncomplicated +
  -8 * drug_abuse +
   9 * fluid_electrolyte +
  -1 * hypertension +
   0 * hypothyroidism +
   5 * liver_disease +
   6 * lymphoma +
   13 * metastatic_cancer +
   4 * other_neurological +
  -4 * obesity +
   3 * paralysis +
   0 * peptic_ulcer +
   4 * peripheral_vascular +
  -4 * psychoses +
   5 * pulmonary_circulation +
   6 * renal_failure +
   0 * rheumatoid_arthritis +
   8 * solid_tumor +
   0 * valvular_disease +
   8 * weight_loss
as elixhauser_SID29


,  -- Below is the 30 component SID score
   0 * aids +
   0 * alcohol_abuse +
  -3 * blood_loss_anemia +
   8 * cardiac_arrhythmias +
   9 * congestive_heart_failure +
   3 * chronic_pulmonary +
  12 * coagulopathy +
   0 * deficiency_anemias +
  -5 * depression +
   1 * diabetes_complicated +
   0 * diabetes_uncomplicated +
 -11 * drug_abuse +
  11 * fluid_electrolyte +
  -2 * hypertension +
   0 * hypothyroidism +
   7 * liver_disease +
   8 * lymphoma +
  17 * metastatic_cancer +
   5 * other_neurological +
  -5 * obesity +
   4 * paralysis +
   0 * peptic_ulcer +
   4 * peripheral_vascular +
  -6 * psychoses +
   5 * pulmonary_circulation +
   7 * renal_failure +
   0 * rheumatoid_arthritis +
  10 * solid_tumor +
   0 * valvular_disease +
  10 * weight_loss
as elixhauser_SID30

from ""postgres"".""public"".""elixhauser_ahrq_v37""
  );",109348,Thread-1,2022-07-18T00:11:35.013157Z
E017,,debug,SQL status: SELECT 58976 in 0.06 seconds,109348,Thread-1,2022-07-18T00:11:35.073037Z
E015,,debug,"Using postgres connection ""model.mimic.elixhauser_score_ahrq""",109348,Thread-1,2022-07-18T00:11:35.080344Z
E016,,debug,"On model.mimic.elixhauser_score_ahrq: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.elixhauser_score_ahrq""} */
alter table ""postgres"".""public"".""elixhauser_score_ahrq"" rename to ""elixhauser_score_ahrq__dbt_backup""",109348,Thread-1,2022-07-18T00:11:35.080625Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:35.081830Z
E015,,debug,"Using postgres connection ""model.mimic.elixhauser_score_ahrq""",109348,Thread-1,2022-07-18T00:11:35.089593Z
E016,,debug,"On model.mimic.elixhauser_score_ahrq: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.elixhauser_score_ahrq""} */
alter table ""postgres"".""public"".""elixhauser_score_ahrq__dbt_tmp"" rename to ""elixhauser_score_ahrq""",109348,Thread-1,2022-07-18T00:11:35.090063Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:35.090989Z
E018,,debug,On model.mimic.elixhauser_score_ahrq: COMMIT,109348,Thread-1,2022-07-18T00:11:35.095797Z
E015,,debug,"Using postgres connection ""model.mimic.elixhauser_score_ahrq""",109348,Thread-1,2022-07-18T00:11:35.096270Z
E016,,debug,On model.mimic.elixhauser_score_ahrq: COMMIT,109348,Thread-1,2022-07-18T00:11:35.096606Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:35.100257Z
E015,,debug,"Using postgres connection ""model.mimic.elixhauser_score_ahrq""",109348,Thread-1,2022-07-18T00:11:35.103259Z
E016,,debug,"On model.mimic.elixhauser_score_ahrq: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.elixhauser_score_ahrq""} */
drop table if exists ""postgres"".""public"".""elixhauser_score_ahrq__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:11:35.103544Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:35.106273Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:35.109197Z
E010,,debug,On model.mimic.elixhauser_score_ahrq: Close,109348,Thread-1,2022-07-18T00:11:35.109477Z
Q012,0,info,84 of 107 OK created table model public.elixhauser_score_ahrq .................. [[32mSELECT 58976[0m in 0.12s],109348,Thread-1,2022-07-18T00:11:35.110939Z,table,null,elixhauser_score_ahrq,comorbidity/elixhauser_score_ahrq.sql,2022-07-18T00:11:34.991413,compiling,model,,,
Q024,0.11785721778869629,debug,Finished running node model.mimic.elixhauser_score_ahrq,109348,Thread-1,2022-07-18T00:11:35.112206Z,table,2022-07-18T00:11:35.111519,elixhauser_score_ahrq,comorbidity/elixhauser_score_ahrq.sql,2022-07-18T00:11:34.991413,success,model,,,
Q023,,debug,Began running node model.mimic.elixhauser_score_quan,109348,Thread-1,2022-07-18T00:11:35.113299Z,table,null,elixhauser_score_quan,comorbidity/elixhauser_score_quan.sql,2022-07-18T00:11:35.113175,started,model,,,
Q033,,info,85 of 107 START table model public.elixhauser_score_quan ....................... [RUN],109348,Thread-1,2022-07-18T00:11:35.114211Z,table,null,elixhauser_score_quan,comorbidity/elixhauser_score_quan.sql,2022-07-18T00:11:35.113175,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.elixhauser_score_quan""",109348,Thread-1,2022-07-18T00:11:35.116329Z
Q030,,debug,Began compiling node model.mimic.elixhauser_score_quan,109348,Thread-1,2022-07-18T00:11:35.116743Z,table,null,elixhauser_score_quan,comorbidity/elixhauser_score_quan.sql,2022-07-18T00:11:35.113175,compiling,model,,,
Q027,,debug,Compiling model.mimic.elixhauser_score_quan,109348,Thread-1,2022-07-18T00:11:35.116967Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.elixhauser_score_quan""",109348,Thread-1,2022-07-18T00:11:35.124492Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:35.125222Z
Q031,,debug,Began executing node model.mimic.elixhauser_score_quan,109348,Thread-1,2022-07-18T00:11:35.125475Z,table,null,elixhauser_score_quan,comorbidity/elixhauser_score_quan.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.elixhauser_score_quan""",109348,Thread-1,2022-07-18T00:11:35.137441Z
E015,,debug,"Using postgres connection ""model.mimic.elixhauser_score_quan""",109348,Thread-1,2022-07-18T00:11:35.138548Z
E016,,debug,On model.mimic.elixhauser_score_quan: BEGIN,109348,Thread-1,2022-07-18T00:11:35.138833Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:11:35.138989Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:35.145974Z
E015,,debug,"Using postgres connection ""model.mimic.elixhauser_score_quan""",109348,Thread-1,2022-07-18T00:11:35.146427Z
E016,,debug,"On model.mimic.elixhauser_score_quan: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.elixhauser_score_quan""} */


  create  table ""postgres"".""public"".""elixhauser_score_quan__dbt_tmp""
  as (
    -- This query provides various methods of combining the Elixhauser components into a single score
-- The methods are called ""vanWalRaven"" and ""SID30"", and ""SID29""

select hadm_id
,  -- Below is the van Walraven score
   0 * aids +
   0 * alcohol_abuse +
  -2 * blood_loss_anemia +
   7 * congestive_heart_failure +
   -- Cardiac arrhythmias are not included in van Walraven based on Quan 2007
   3 * chronic_pulmonary +
   3 * coagulopathy +
  -2 * deficiency_anemias +
  -3 * depression +
   0 * diabetes_complicated +
   0 * diabetes_uncomplicated +
  -7 * drug_abuse +
   5 * fluid_electrolyte +
   0 * hypertension +
   0 * hypothyroidism +
   11 * liver_disease +
   9 * lymphoma +
   12 * metastatic_cancer +
   6 * other_neurological +
  -4 * obesity +
   7 * paralysis +
   2 * peripheral_vascular +
   0 * peptic_ulcer +
   0 * psychoses +
   4 * pulmonary_circulation +
   0 * rheumatoid_arthritis +
   5 * renal_failure +
   4 * solid_tumor +
  -1 * valvular_disease +
   6 * weight_loss
as elixhauser_vanwalraven



,  -- Below is the 29 component SID score
   0 * aids +
  -2 * alcohol_abuse +
  -2 * blood_loss_anemia +
   -- Cardiac arrhythmias are not included in SID-29
   9 * congestive_heart_failure +
   3 * chronic_pulmonary +
   9 * coagulopathy +
   0 * deficiency_anemias +
  -4 * depression +
   0 * diabetes_complicated +
  -1 * diabetes_uncomplicated +
  -8 * drug_abuse +
   9 * fluid_electrolyte +
  -1 * hypertension +
   0 * hypothyroidism +
   5 * liver_disease +
   6 * lymphoma +
   13 * metastatic_cancer +
   4 * other_neurological +
  -4 * obesity +
   3 * paralysis +
   0 * peptic_ulcer +
   4 * peripheral_vascular +
  -4 * psychoses +
   5 * pulmonary_circulation +
   6 * renal_failure +
   0 * rheumatoid_arthritis +
   8 * solid_tumor +
   0 * valvular_disease +
   8 * weight_loss
as elixhauser_SID29


,  -- Below is the 30 component SID score
   0 * aids +
   0 * alcohol_abuse +
  -3 * blood_loss_anemia +
   8 * cardiac_arrhythmias +
   9 * congestive_heart_failure +
   3 * chronic_pulmonary +
  12 * coagulopathy +
   0 * deficiency_anemias +
  -5 * depression +
   1 * diabetes_complicated +
   0 * diabetes_uncomplicated +
 -11 * drug_abuse +
  11 * fluid_electrolyte +
  -2 * hypertension +
   0 * hypothyroidism +
   7 * liver_disease +
   8 * lymphoma +
  17 * metastatic_cancer +
   5 * other_neurological +
  -5 * obesity +
   4 * paralysis +
   0 * peptic_ulcer +
   4 * peripheral_vascular +
  -6 * psychoses +
   5 * pulmonary_circulation +
   7 * renal_failure +
   0 * rheumatoid_arthritis +
  10 * solid_tumor +
   0 * valvular_disease +
  10 * weight_loss
as elixhauser_SID30

from  ""postgres"".""public"".""elixhauser_quan""
  );",109348,Thread-1,2022-07-18T00:11:35.146880Z
E017,,debug,SQL status: SELECT 58976 in 0.07 seconds,109348,Thread-1,2022-07-18T00:11:35.213426Z
E015,,debug,"Using postgres connection ""model.mimic.elixhauser_score_quan""",109348,Thread-1,2022-07-18T00:11:35.218747Z
E016,,debug,"On model.mimic.elixhauser_score_quan: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.elixhauser_score_quan""} */
alter table ""postgres"".""public"".""elixhauser_score_quan"" rename to ""elixhauser_score_quan__dbt_backup""",109348,Thread-1,2022-07-18T00:11:35.219051Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:35.219878Z
E015,,debug,"Using postgres connection ""model.mimic.elixhauser_score_quan""",109348,Thread-1,2022-07-18T00:11:35.224459Z
E016,,debug,"On model.mimic.elixhauser_score_quan: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.elixhauser_score_quan""} */
alter table ""postgres"".""public"".""elixhauser_score_quan__dbt_tmp"" rename to ""elixhauser_score_quan""",109348,Thread-1,2022-07-18T00:11:35.224725Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:35.225410Z
E018,,debug,On model.mimic.elixhauser_score_quan: COMMIT,109348,Thread-1,2022-07-18T00:11:35.229342Z
E015,,debug,"Using postgres connection ""model.mimic.elixhauser_score_quan""",109348,Thread-1,2022-07-18T00:11:35.229671Z
E016,,debug,On model.mimic.elixhauser_score_quan: COMMIT,109348,Thread-1,2022-07-18T00:11:35.229971Z
E017,,debug,SQL status: COMMIT in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:35.237268Z
E015,,debug,"Using postgres connection ""model.mimic.elixhauser_score_quan""",109348,Thread-1,2022-07-18T00:11:35.239456Z
E016,,debug,"On model.mimic.elixhauser_score_quan: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.elixhauser_score_quan""} */
drop table if exists ""postgres"".""public"".""elixhauser_score_quan__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:11:35.239681Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:35.241751Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:35.246962Z
E010,,debug,On model.mimic.elixhauser_score_quan: Close,109348,Thread-1,2022-07-18T00:11:35.247661Z
Q012,0,info,85 of 107 OK created table model public.elixhauser_score_quan .................. [[32mSELECT 58976[0m in 0.13s],109348,Thread-1,2022-07-18T00:11:35.248815Z,table,null,elixhauser_score_quan,comorbidity/elixhauser_score_quan.sql,2022-07-18T00:11:35.113175,compiling,model,,,
Q024,0.13298630714416504,debug,Finished running node model.mimic.elixhauser_score_quan,109348,Thread-1,2022-07-18T00:11:35.249900Z,table,2022-07-18T00:11:35.249429,elixhauser_score_quan,comorbidity/elixhauser_score_quan.sql,2022-07-18T00:11:35.113175,success,model,,,
Q023,,debug,Began running node model.mimic.icustay_hours,109348,Thread-1,2022-07-18T00:11:35.250736Z,table,null,icustay_hours,demographics/icustay_hours.sql,2022-07-18T00:11:35.250644,started,model,,,
Q033,,info,86 of 107 START table model public.icustay_hours ............................... [RUN],109348,Thread-1,2022-07-18T00:11:35.251546Z,table,null,icustay_hours,demographics/icustay_hours.sql,2022-07-18T00:11:35.250644,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.icustay_hours""",109348,Thread-1,2022-07-18T00:11:35.253339Z
Q030,,debug,Began compiling node model.mimic.icustay_hours,109348,Thread-1,2022-07-18T00:11:35.253906Z,table,null,icustay_hours,demographics/icustay_hours.sql,2022-07-18T00:11:35.250644,compiling,model,,,
Q027,,debug,Compiling model.mimic.icustay_hours,109348,Thread-1,2022-07-18T00:11:35.254371Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.icustay_hours""",109348,Thread-1,2022-07-18T00:11:35.260217Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:35.260900Z
Q031,,debug,Began executing node model.mimic.icustay_hours,109348,Thread-1,2022-07-18T00:11:35.261106Z,table,null,icustay_hours,demographics/icustay_hours.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.icustay_hours""",109348,Thread-1,2022-07-18T00:11:35.271851Z
E015,,debug,"Using postgres connection ""model.mimic.icustay_hours""",109348,Thread-1,2022-07-18T00:11:35.272920Z
E016,,debug,On model.mimic.icustay_hours: BEGIN,109348,Thread-1,2022-07-18T00:11:35.273249Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:11:35.273398Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:35.280274Z
E015,,debug,"Using postgres connection ""model.mimic.icustay_hours""",109348,Thread-1,2022-07-18T00:11:35.280625Z
E016,,debug,"On model.mimic.icustay_hours: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.icustay_hours""} */


  create  table ""postgres"".""public"".""icustay_hours__dbt_tmp""
  as (
    -- This query generates a row for every hour the patient is in the ICU.
-- The hours are based on clock-hours (i.e. 02:00, 03:00).
-- The hour clock starts 24 hours before the first heart rate measurement.
-- Note that the time of the first heart rate measurement is ceilinged to the hour.

-- this query extracts the cohort and every possible hour they were in the ICU
-- this table can be to other tables on ICUSTAY_ID and (ENDTIME - 1 hour,ENDTIME]

-- get first/last measurement time
with all_hours as
(
select
  it.icustay_id

  -- ceiling the intime to the nearest hour by adding 59 minutes then truncating
  -- note thart we truncate by parsing as string, rather than using DATETIME_TRUNC
  -- this is done to enable compatibility with psql
  , PARSE_DATETIME(
      '%Y-%m-%d %H:00:00',
      FORMAT_DATETIME(
        '%Y-%m-%d %H:00:00',
          DATETIME_ADD(it.intime_hr, '59 MINUTE'::INTERVAL)
  )) AS endtime

  -- create integers for each charttime in hours from admission
  -- so 0 is admission time, 1 is one hour after admission, etc, up to ICU disch
  --  we allow 24 hours before ICU admission (to grab labs before admit)
  , GENERATE_ARRAY(-24, CEIL(DATETIME_DIFF(it.outtime_hr, it.intime_hr, 'HOUR'))::integer) as hrs

  from ""postgres"".""public"".""icustay_times"" it
)
SELECT icustay_id
, CAST(hr AS integer) as hr
, DATETIME_ADD(endtime,  (CAST(hr AS integer) || 'HOUR')::INTERVAL) as endtime
FROM all_hours
CROSS JOIN UNNEST(ARRAY[all_hours.hrs]) AS hr
  );",109348,Thread-1,2022-07-18T00:11:35.280855Z
E017,,debug,SQL status: SELECT 963 in 0.49 seconds,109348,Thread-1,2022-07-18T00:11:35.773257Z
E015,,debug,"Using postgres connection ""model.mimic.icustay_hours""",109348,Thread-1,2022-07-18T00:11:35.780790Z
E016,,debug,"On model.mimic.icustay_hours: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.icustay_hours""} */
alter table ""postgres"".""public"".""icustay_hours"" rename to ""icustay_hours__dbt_backup""",109348,Thread-1,2022-07-18T00:11:35.781248Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:35.782442Z
E015,,debug,"Using postgres connection ""model.mimic.icustay_hours""",109348,Thread-1,2022-07-18T00:11:35.786265Z
E016,,debug,"On model.mimic.icustay_hours: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.icustay_hours""} */
alter table ""postgres"".""public"".""icustay_hours__dbt_tmp"" rename to ""icustay_hours""",109348,Thread-1,2022-07-18T00:11:35.786507Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:35.787258Z
E018,,debug,On model.mimic.icustay_hours: COMMIT,109348,Thread-1,2022-07-18T00:11:35.790584Z
E015,,debug,"Using postgres connection ""model.mimic.icustay_hours""",109348,Thread-1,2022-07-18T00:11:35.790824Z
E016,,debug,On model.mimic.icustay_hours: COMMIT,109348,Thread-1,2022-07-18T00:11:35.791060Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:35.792583Z
E015,,debug,"Using postgres connection ""model.mimic.icustay_hours""",109348,Thread-1,2022-07-18T00:11:35.795426Z
E016,,debug,"On model.mimic.icustay_hours: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.icustay_hours""} */
drop table if exists ""postgres"".""public"".""icustay_hours__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:11:35.795667Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:35.797669Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:35.800517Z
E010,,debug,On model.mimic.icustay_hours: Close,109348,Thread-1,2022-07-18T00:11:35.800770Z
Q012,0,info,86 of 107 OK created table model public.icustay_hours .......................... [[32mSELECT 963[0m in 0.55s],109348,Thread-1,2022-07-18T00:11:35.801794Z,table,null,icustay_hours,demographics/icustay_hours.sql,2022-07-18T00:11:35.250644,compiling,model,,,
Q024,0.5487685203552246,debug,Finished running node model.mimic.icustay_hours,109348,Thread-1,2022-07-18T00:11:35.802466Z,table,2022-07-18T00:11:35.802294,icustay_hours,demographics/icustay_hours.sql,2022-07-18T00:11:35.250644,success,model,,,
Q023,,debug,Began running node model.mimic.meld,109348,Thread-1,2022-07-18T00:11:35.802990Z,table,null,meld,organfailure/meld.sql,2022-07-18T00:11:35.802892,started,model,,,
Q033,,info,87 of 107 START table model public.meld ........................................ [RUN],109348,Thread-1,2022-07-18T00:11:35.803785Z,table,null,meld,organfailure/meld.sql,2022-07-18T00:11:35.802892,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.meld""",109348,Thread-1,2022-07-18T00:11:35.804585Z
Q030,,debug,Began compiling node model.mimic.meld,109348,Thread-1,2022-07-18T00:11:35.804874Z,table,null,meld,organfailure/meld.sql,2022-07-18T00:11:35.802892,compiling,model,,,
Q027,,debug,Compiling model.mimic.meld,109348,Thread-1,2022-07-18T00:11:35.805067Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.meld""",109348,Thread-1,2022-07-18T00:11:35.808301Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:35.809075Z
Q031,,debug,Began executing node model.mimic.meld,109348,Thread-1,2022-07-18T00:11:35.809368Z,table,null,meld,organfailure/meld.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.meld""",109348,Thread-1,2022-07-18T00:11:35.819276Z
E015,,debug,"Using postgres connection ""model.mimic.meld""",109348,Thread-1,2022-07-18T00:11:35.820050Z
E016,,debug,On model.mimic.meld: BEGIN,109348,Thread-1,2022-07-18T00:11:35.820336Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:11:35.820642Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:35.826942Z
E015,,debug,"Using postgres connection ""model.mimic.meld""",109348,Thread-1,2022-07-18T00:11:35.827221Z
E016,,debug,"On model.mimic.meld: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.meld""} */


  create  table ""postgres"".""public"".""meld__dbt_tmp""
  as (
    -- Model for end-stage liver disease (MELD)
-- This model is used to determine prognosis and receipt of liver transplantation.

-- Reference:
--  Kamath PS, Wiesner RH, Malinchoc M, Kremers W, Therneau TM,
--  Kosberg CL, D'Amico G, Dickson ER, Kim WR.
--  A model to predict survival in patients with end-stage liver disease.
--  Hepatology. 2001 Feb33(2):464-70.


-- Updated January 2016 to include serum sodium, see:
--  https://optn.transplant.hrsa.gov/news/meld-serum-sodium-policy-changes/

-- Here is the relevant portion of the policy note:
--    9.1.D MELD Score
--    Candidates who are at least 12 years old receive an initial MELD(i) score equal to:
--    0.957 x ln(creatinine mg/dL) + 0.378 x ln(bilirubin mg/dL) + 1.120 x ln(INR) + 0.643

--    Laboratory values less than 1.0 will be set to 1.0 when calculating a candidate’s MELD
--    score.

--    The following candidates will receive a creatinine value of 4.0 mg/dL:
--    - Candidates with a creatinine value greater than 4.0 mg/dL
--    - Candidates who received two or more dialysis treatments within the prior week
--    - Candidates who received 24 hours of continuous veno-venous hemodialysis (CVVHD) within the prior week

--    The maximum MELD score is 40. The MELD score derived from this calculation will be rounded to the tenth decimal place and then multiplied by 10.

--    For candidates with an initial MELD score greater than 11, The MELD score is then recalculated as follows:
--    MELD = MELD(i) + 1.32*(137-Na) – [0.033*MELD(i)*(137-Na)]
--    Sodium values less than 125 mmol/L will be set to 125, and values greater than 137 mmol/L will be set to 137.



-- TODO needed in this code:
--  1. identify 2x dialysis in the past week, or 24 hours of CVVH
--      at the moment it just checks for any dialysis on the day
--  2. adjust the serum sodium using the corresponding glucose measurement
--      Measured sodium + 0.024 * (Serum glucose - 100)   (Hiller, 1999)

with cohort as
(
select ie.subject_id, ie.hadm_id, ie.icustay_id
      , ie.intime
      , ie.outtime

      , labs.creatinine_max
      , labs.bilirubin_max
      , labs.inr_max
      , labs.sodium_min

      , r.rrt

FROM icustays ie
inner join admissions adm
  on ie.hadm_id = adm.hadm_id
inner join patients pat
  on ie.subject_id = pat.subject_id

-- join to custom tables to get more data....
left join ""postgres"".""public"".""labs_first_day"" labs
  on ie.icustay_id = labs.icustay_id
left join rrt_first_day r
  on ie.icustay_id = r.icustay_id
)
, score as
(
  select subject_id, hadm_id, icustay_id
    , rrt
    , creatinine_max
    , bilirubin_max
    , inr_max
    , sodium_min

    -- TODO: Corrected Sodium
    , case
        when sodium_min is null
          then 0.0
        when sodium_min > 137
          then 0.0
        when sodium_min < 125
          then 12.0 -- 137 - 125 = 12
        else 137.0-sodium_min
      end as sodium_score

    -- if hemodialysis, value for Creatinine is automatically set to 4.0
    , case
        when rrt = 1 or creatinine_max > 4.0
          then (0.957 * ln(4))
        -- if creatinine < 1, score is 1
        when creatinine_max < 1
          then (0.957 * ln(1))
        else 0.957 * coalesce(ln(creatinine_max),ln(1))
      end as creatinine_score

    , case
        -- if value < 1, score is 1
        when bilirubin_max < 1
          then 0.378 * ln(1)
        else 0.378 * coalesce(ln(bilirubin_max),ln(1))
      end as bilirubin_score

    , case
        when inr_max < 1
          then ( 1.120 * ln(1) + 0.643 )
        else ( 1.120 * coalesce(ln(inr_max),ln(1)) + 0.643 )
      end as inr_score

  from cohort
)
, score2 as
(
  select
    subject_id, hadm_id, icustay_id
    , rrt
    , creatinine_max
    , bilirubin_max
    , inr_max
    , sodium_min

    , creatinine_score
    , sodium_score
    , bilirubin_score
    , inr_score

    , case
        when (creatinine_score + bilirubin_score + inr_score) > 40
          then 40.0
        else
          round(cast(creatinine_score + bilirubin_score + inr_score as numeric),1)*10
        end as meld_initial
  from score
)
select
  subject_id, hadm_id, icustay_id

  -- MELD Score without sodium change
  , meld_initial

  -- MELD Score (2016) = MELD*10 + 1.32*(137-Na) – [0.033*MELD*10*(137-Na)]
  , case
      when meld_initial > 11
        then meld_initial + 1.32*sodium_score - 0.033*meld_initial*sodium_score
      else
        meld_initial
      end as meld

  -- original variables
  , rrt
  , creatinine_max
  , bilirubin_max
  , inr_max
  , sodium_min

from score2
order by icustay_id
  );",109348,Thread-1,2022-07-18T00:11:35.827425Z
E017,,debug,SQL status: SELECT 61532 in 0.28 seconds,109348,Thread-1,2022-07-18T00:11:36.109250Z
E015,,debug,"Using postgres connection ""model.mimic.meld""",109348,Thread-1,2022-07-18T00:11:36.116212Z
E016,,debug,"On model.mimic.meld: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.meld""} */
alter table ""postgres"".""public"".""meld"" rename to ""meld__dbt_backup""",109348,Thread-1,2022-07-18T00:11:36.116669Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:36.118248Z
E015,,debug,"Using postgres connection ""model.mimic.meld""",109348,Thread-1,2022-07-18T00:11:36.122068Z
E016,,debug,"On model.mimic.meld: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.meld""} */
alter table ""postgres"".""public"".""meld__dbt_tmp"" rename to ""meld""",109348,Thread-1,2022-07-18T00:11:36.122361Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:36.123099Z
E018,,debug,On model.mimic.meld: COMMIT,109348,Thread-1,2022-07-18T00:11:36.126279Z
E015,,debug,"Using postgres connection ""model.mimic.meld""",109348,Thread-1,2022-07-18T00:11:36.126546Z
E016,,debug,On model.mimic.meld: COMMIT,109348,Thread-1,2022-07-18T00:11:36.126754Z
E017,,debug,SQL status: COMMIT in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:36.135427Z
E015,,debug,"Using postgres connection ""model.mimic.meld""",109348,Thread-1,2022-07-18T00:11:36.137496Z
E016,,debug,"On model.mimic.meld: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.meld""} */
drop table if exists ""postgres"".""public"".""meld__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:11:36.137863Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:36.140270Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:36.143202Z
E010,,debug,On model.mimic.meld: Close,109348,Thread-1,2022-07-18T00:11:36.143448Z
Q012,0,info,87 of 107 OK created table model public.meld ................................... [[32mSELECT 61532[0m in 0.34s],109348,Thread-1,2022-07-18T00:11:36.144386Z,table,null,meld,organfailure/meld.sql,2022-07-18T00:11:35.802892,compiling,model,,,
Q024,0.33988070487976074,debug,Finished running node model.mimic.meld,109348,Thread-1,2022-07-18T00:11:36.145020Z,table,2022-07-18T00:11:36.144865,meld,organfailure/meld.sql,2022-07-18T00:11:35.802892,success,model,,,
Q023,,debug,Began running node model.mimic.pivoted_bg_art,109348,Thread-1,2022-07-18T00:11:36.145494Z,table,null,pivoted_bg_art,pivot/pivoted_bg_art.sql,2022-07-18T00:11:36.145397,started,model,,,
Q033,,info,88 of 107 START table model public.pivoted_bg_art .............................. [RUN],109348,Thread-1,2022-07-18T00:11:36.146247Z,table,null,pivoted_bg_art,pivot/pivoted_bg_art.sql,2022-07-18T00:11:36.145397,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.pivoted_bg_art""",109348,Thread-1,2022-07-18T00:11:36.147062Z
Q030,,debug,Began compiling node model.mimic.pivoted_bg_art,109348,Thread-1,2022-07-18T00:11:36.147469Z,table,null,pivoted_bg_art,pivot/pivoted_bg_art.sql,2022-07-18T00:11:36.145397,compiling,model,,,
Q027,,debug,Compiling model.mimic.pivoted_bg_art,109348,Thread-1,2022-07-18T00:11:36.147939Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.pivoted_bg_art""",109348,Thread-1,2022-07-18T00:11:36.154567Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:36.155467Z
Q031,,debug,Began executing node model.mimic.pivoted_bg_art,109348,Thread-1,2022-07-18T00:11:36.155808Z,table,null,pivoted_bg_art,pivot/pivoted_bg_art.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.pivoted_bg_art""",109348,Thread-1,2022-07-18T00:11:36.165365Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_bg_art""",109348,Thread-1,2022-07-18T00:11:36.166618Z
E016,,debug,On model.mimic.pivoted_bg_art: BEGIN,109348,Thread-1,2022-07-18T00:11:36.167066Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:11:36.167327Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:36.173368Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_bg_art""",109348,Thread-1,2022-07-18T00:11:36.173786Z
E016,,debug,"On model.mimic.pivoted_bg_art: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_bg_art""} */


  create  table ""postgres"".""public"".""pivoted_bg_art__dbt_tmp""
  as (
    -- This query requires the pivoted_bg table to be generated.
-- It extracts only arterial blood gas samples - either explicitly stated or 
-- inferred by a hard-coded logistic regression model.
with stg_spo2 as
(
  select hadm_id, charttime
    -- avg here is just used to group SpO2 by charttime
    , avg(valuenum) as spo2
  FROM chartevents
  -- o2 sat
  where ITEMID in
  (
    646 -- SpO2
  , 220277 -- O2 saturation pulseoxymetry
  )
  and valuenum > 0 and valuenum <= 100
  group by hadm_id, charttime
)
, stg_fio2 as
(
  select hadm_id, charttime
    -- pre-process the FiO2s to ensure they are between 21-100%
    , max(
        case
          when itemid = 223835
            then case
              when valuenum > 0 and valuenum <= 1
                then valuenum * 100
              -- improperly input data - looks like O2 flow in litres
              when valuenum > 1 and valuenum < 21
                then null
              when valuenum >= 21 and valuenum <= 100
                then valuenum
              else null end -- unphysiological
        when itemid in (3420, 3422)
        -- all these values are well formatted
            then valuenum
        when itemid = 190 and valuenum > 0.20 and valuenum < 1
        -- well formatted but not in %
            then valuenum * 100
      else null end
    ) as fio2_chartevents
  FROM chartevents
  where ITEMID in
  (
    3420 -- FiO2
  , 190 -- FiO2 set
  , 223835 -- Inspired O2 Fraction (FiO2)
  , 3422 -- FiO2 [measured]
  )
  and valuenum > 0 and valuenum < 100
  -- exclude rows marked as error
  AND (error IS NULL OR error != 1)
  group by hadm_id, charttime
)
, stg2 as
(
select bg.*
  , row_number() OVER (partition by bg.hadm_id, bg.charttime order by s1.charttime DESC) as lastrowspo2
  , s1.spo2
from ""postgres"".""public"".""pivoted_bg"" bg
left join stg_spo2 s1
  -- same hospitalization
  on  bg.hadm_id = s1.hadm_id
  -- spo2 occurred at most 2 hours before this blood gas
  and s1.charttime between DATETIME_SUB(bg.charttime, INTERVAL '2' HOUR) and bg.charttime
where bg.po2 is not null
)
, stg3 as
(
select bg.*
  , row_number() OVER (partition by bg.hadm_id, bg.charttime order by s2.charttime DESC) as lastrowfio2
  , s2.fio2_chartevents

  -- create our specimen prediction
  ,  1/(1+exp(-(-0.02544
  +    0.04598 * po2
  + coalesce(-0.15356 * spo2             , -0.15356 *   97.49420 +    0.13429)
  + coalesce( 0.00621 * fio2_chartevents ,  0.00621 *   51.49550 +   -0.24958)
  + coalesce( 0.10559 * hemoglobin       ,  0.10559 *   10.32307 +    0.05954)
  + coalesce( 0.13251 * so2              ,  0.13251 *   93.66539 +   -0.23172)
  + coalesce(-0.01511 * pco2             , -0.01511 *   42.08866 +   -0.01630)
  + coalesce( 0.01480 * fio2             ,  0.01480 *   63.97836 +   -0.31142)
  + coalesce(-0.00200 * aado2            , -0.00200 *  442.21186 +   -0.01328)
  + coalesce(-0.03220 * bicarbonate      , -0.03220 *   22.96894 +   -0.06535)
  + coalesce( 0.05384 * totalco2         ,  0.05384 *   24.72632 +   -0.01405)
  + coalesce( 0.08202 * lactate          ,  0.08202 *    3.06436 +    0.06038)
  + coalesce( 0.10956 * ph               ,  0.10956 *    7.36233 +   -0.00617)
  + coalesce( 0.00848 * o2flow           ,  0.00848 *    7.59362 +   -0.35803)
  ))) as specimen_prob
from stg2 bg
left join stg_fio2 s2
  -- same patient
  on  bg.hadm_id = s2.hadm_id
  -- fio2 occurred at most 4 hours before this blood gas
  and s2.charttime between DATETIME_SUB(bg.charttime, INTERVAL '4' HOUR) and bg.charttime
  and s2.fio2_chartevents > 0
where bg.lastRowSpO2 = 1 -- only the row with the most recent SpO2 (if no SpO2 found lastRowSpO2 = 1)
)
select
    stg3.hadm_id
  , stg3.icustay_id
  , stg3.charttime
  , specimen -- raw data indicating sample type, only present 80% of the time
  -- prediction of specimen for missing data
  , case
        when SPECIMEN is not null then SPECIMEN
        when SPECIMEN_PROB > 0.75 then 'ART'
      else null end as specimen_pred
  , specimen_prob

  -- oxygen related parameters
  , so2, spo2 -- note spo2 is FROM chartevents
  , po2, pco2
  , fio2_chartevents, fio2
  , aado2
  -- also calculate AADO2
  , case
      when  PO2 is not null
        and pco2 is not null
        and coalesce(FIO2, fio2_chartevents) is not null
       -- multiple by 100 because FiO2 is in a % but should be a fraction
        then (coalesce(FIO2, fio2_chartevents)/100) * (760 - 47) - (pco2/0.8) - po2
      else null
    end as aado2_calc
  , case
      when PO2 is not null and coalesce(FIO2, fio2_chartevents) is not null
       -- multiply by 100 because FiO2 is in a % but should be a fraction
        then 100*PO2/(coalesce(FIO2, fio2_chartevents))
      else null
    end as pao2fio2ratio
  -- acid-base parameters
  , ph, baseexcess
  , bicarbonate, totalco2

  -- blood count parameters
  , hematocrit
  , hemoglobin
  , carboxyhemoglobin
  , methemoglobin

  -- chemistry
  , chloride, calcium
  , temperature
  , potassium, sodium
  , lactate
  , glucose

  -- ventilation stuff that's sometimes input
  , intubated, tidalvolume, ventilationrate, ventilator
  , peep, o2flow
  , requiredo2
from stg3
where lastRowFiO2 = 1 -- only the most recent FiO2
-- restrict it to *only* arterial samples
and (specimen = 'ART' or specimen_prob > 0.75)
order by hadm_id, charttime
  );",109348,Thread-1,2022-07-18T00:11:36.174086Z
E017,,debug,SQL status: SELECT 0 in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:36.185655Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_bg_art""",109348,Thread-1,2022-07-18T00:11:36.191196Z
E016,,debug,"On model.mimic.pivoted_bg_art: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_bg_art""} */
alter table ""postgres"".""public"".""pivoted_bg_art"" rename to ""pivoted_bg_art__dbt_backup""",109348,Thread-1,2022-07-18T00:11:36.191515Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:36.192724Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_bg_art""",109348,Thread-1,2022-07-18T00:11:36.199878Z
E016,,debug,"On model.mimic.pivoted_bg_art: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_bg_art""} */
alter table ""postgres"".""public"".""pivoted_bg_art__dbt_tmp"" rename to ""pivoted_bg_art""",109348,Thread-1,2022-07-18T00:11:36.200106Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:36.200800Z
E018,,debug,On model.mimic.pivoted_bg_art: COMMIT,109348,Thread-1,2022-07-18T00:11:36.203893Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_bg_art""",109348,Thread-1,2022-07-18T00:11:36.204120Z
E016,,debug,On model.mimic.pivoted_bg_art: COMMIT,109348,Thread-1,2022-07-18T00:11:36.204241Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:36.205402Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_bg_art""",109348,Thread-1,2022-07-18T00:11:36.207655Z
E016,,debug,"On model.mimic.pivoted_bg_art: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_bg_art""} */
drop table if exists ""postgres"".""public"".""pivoted_bg_art__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:11:36.207884Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:36.210428Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:36.214695Z
E010,,debug,On model.mimic.pivoted_bg_art: Close,109348,Thread-1,2022-07-18T00:11:36.215164Z
Q012,0,info,88 of 107 OK created table model public.pivoted_bg_art ......................... [[32mSELECT 0[0m in 0.07s],109348,Thread-1,2022-07-18T00:11:36.216076Z,table,null,pivoted_bg_art,pivot/pivoted_bg_art.sql,2022-07-18T00:11:36.145397,compiling,model,,,
Q024,0.0691378116607666,debug,Finished running node model.mimic.pivoted_bg_art,109348,Thread-1,2022-07-18T00:11:36.216724Z,table,2022-07-18T00:11:36.216557,pivoted_bg_art,pivot/pivoted_bg_art.sql,2022-07-18T00:11:36.145397,success,model,,,
Q023,,debug,Began running node model.mimic.pivoted_oasis,109348,Thread-1,2022-07-18T00:11:36.217214Z,table,null,pivoted_oasis,pivot/pivoted_oasis.sql,2022-07-18T00:11:36.217165,started,model,,,
Q033,,info,89 of 107 START table model public.pivoted_oasis ............................... [RUN],109348,Thread-1,2022-07-18T00:11:36.217917Z,table,null,pivoted_oasis,pivot/pivoted_oasis.sql,2022-07-18T00:11:36.217165,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.pivoted_oasis""",109348,Thread-1,2022-07-18T00:11:36.218896Z
Q030,,debug,Began compiling node model.mimic.pivoted_oasis,109348,Thread-1,2022-07-18T00:11:36.219321Z,table,null,pivoted_oasis,pivot/pivoted_oasis.sql,2022-07-18T00:11:36.217165,compiling,model,,,
Q027,,debug,Compiling model.mimic.pivoted_oasis,109348,Thread-1,2022-07-18T00:11:36.219668Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.pivoted_oasis""",109348,Thread-1,2022-07-18T00:11:36.223138Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:36.223744Z
Q031,,debug,Began executing node model.mimic.pivoted_oasis,109348,Thread-1,2022-07-18T00:11:36.224069Z,table,null,pivoted_oasis,pivot/pivoted_oasis.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.pivoted_oasis""",109348,Thread-1,2022-07-18T00:11:36.232448Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_oasis""",109348,Thread-1,2022-07-18T00:11:36.233302Z
E016,,debug,On model.mimic.pivoted_oasis: BEGIN,109348,Thread-1,2022-07-18T00:11:36.233553Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:11:36.233967Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:36.240373Z
E015,,debug,"Using postgres connection ""model.mimic.pivoted_oasis""",109348,Thread-1,2022-07-18T00:11:36.240659Z
E016,,debug,"On model.mimic.pivoted_oasis: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.pivoted_oasis""} */


  create  table ""postgres"".""public"".""pivoted_oasis__dbt_tmp""
  as (
    -- ------------------------------------------------------------------
-- Title: Oxford Acute Severity of Illness Score (OASIS)
-- This query extracts the Oxford acute severity of illness score.
-- This score is a measure of severity of illness for patients in the ICU.
-- The score is calculated for every hour of the patient's ICU stay.
-- However, as the calculation window is 24 hours, care should be taken when
-- using the score before the end of the first day.
-- ------------------------------------------------------------------

-- Reference for OASIS:
--    Johnson, Alistair EW, Andrew A. Kramer, and Gari D. Clifford.
--    ""A new severity of illness scale using a subset of acute physiology and chronic health evaluation data elements shows comparable predictive accuracy*.""
--    Critical care medicine 41, no. 7 (2013): 1711-1718.

-- Variables used in OASIS:
--  Heart rate, GCS, MAP, Temperature, Respiratory rate, Ventilation status (sourced from CHARTEVENTS)
--  Urine output (sourced from OUTPUTEVENTS)
--  Elective surgery (sourced from ADMISSIONS and SERVICES)
--  Pre-ICU in-hospital length of stay (sourced from ADMISSIONS and ICUSTAYS)
--  Age (sourced from PATIENTS)

-- The following views are required to run this query:
--  1) uofirstday - generated by urine-output-first-day.sql
--  2) ventfirstday - generated by ventilated-first-day.sql
--  3) vitalsfirstday - generated by vitals-first-day.sql
--  4) gcsfirstday - generated by gcs-first-day.sql


-- Regarding missing values:
--  The ventilation flag is always 0/1. It cannot be missing, since VENT=0 if no data is found for vent settings.

-- Note:
--  The score is calculated for *all* ICU patients, with the assumption 
--  that the user will subselect appropriate ICUSTAY_IDs.
--  For example, the score is calculated for neonates, but it is likely inappropriate to
--  actually use the score values for these patients.

-- The following views required to run this query:
--  1) pivoted_uo - generated by pivoted-uo.sql
--  2) pivoted_lab - generated by pivoted-lab.sql
--  3) pivoted_gcs - generated by pivoted-gcs.sql
--  4) pivoted_vital - generated by pivoted-vital.sql
--  5) ventilation_durations - generated by ../durations/ventilation_durations.sql

-- generate a row for every hour the patient was in the ICU
WITH co_hours AS
(
  select ih.icustay_id, ie.hadm_id
  , hr
  -- start/endtime can be used to filter to values within this hour
  , DATETIME_SUB(ih.endtime, INTERVAL '1' HOUR) AS starttime
  , ih.endtime
  from icustay_hours ih
  INNER JOIN icustays ie
    ON ih.icustay_id = ie.icustay_id
)
, mini_agg as
(
  select co.icustay_id, co.hr
  -- vitals
  , min(v.HeartRate) as HeartRate_min
  , max(v.HeartRate) as HeartRate_max
  , min(v.TempC) as TempC_min
  , max(v.TempC) as TempC_max
  , min(v.MeanBP) as MeanBP_min
  , max(v.MeanBP) as MeanBP_max
  , min(v.RespRate) as RespRate_min
  , max(v.RespRate) as RespRate_max
  -- gcs
  , min(gcs.GCS) as GCS_min
  -- because pafi has an interaction between vent/PaO2:FiO2, we need two columns for the score
  -- it can happen that the lowest unventilated PaO2/FiO2 is 68, but the lowest ventilated PaO2/FiO2 is 120
  -- in this case, the SOFA score is 3, *not* 4.
  , MAX(case
        when vd1.icustay_id is not null then 1 
        when vd2.icustay_id is not null then 1
    else 0 end) AS mechvent
  from co_hours co
  left join ""postgres"".""public"".""pivoted_vital"" v
    on co.icustay_id = v.icustay_id
    and co.starttime < v.charttime
    and co.endtime >= v.charttime
  left join pivoted_gcs gcs
    on co.icustay_id = gcs.icustay_id
    and co.starttime < gcs.charttime
    and co.endtime >= gcs.charttime
  -- at the time of this row, was the patient ventilated
  left join ventilation_durations vd1
    on co.icustay_id = vd1.icustay_id
    and co.starttime >= vd1.starttime
    and co.starttime <= vd1.endtime
  left join ventilation_durations vd2
    on co.icustay_id = vd2.icustay_id
    and co.endtime >= vd2.starttime
    and co.endtime <= vd2.endtime
  group by co.icustay_id, co.hr
)
-- sum uo separately to prevent duplicating values
, uo as
(
  select co.icustay_id, co.hr
  -- uo
  , sum(uo.urineoutput) as urineoutput
  from co_hours co
  left join pivoted_uo uo
    on co.icustay_id = uo.icustay_id
    and co.starttime < uo.charttime
    and co.endtime >= uo.charttime
  group by co.icustay_id, co.hr
)
, scorecomp as
(
  select
      co.icustay_id
    , co.hr
    , co.starttime, co.endtime
    , ma.meanbp_min
    , ma.meanbp_max
    , ma.heartrate_min
    , ma.heartrate_max
    , ma.tempc_min
    , ma.tempc_max
    , ma.resprate_min
    , ma.resprate_max
    , ma.gcs_min
    -- uo
    , uo.urineoutput
    -- static variables that do not change over the ICU stay
    , cast(co.intime as timestamp) - cast(adm.admittime as timestamp) as preiculos
    , case
        when adm.ADMISSION_TYPE = 'ELECTIVE' and sf.surgical = 1
        then 1
        when adm.ADMISSION_TYPE is null or sf.surgical is null
        then null
        else 0
    end as electivesurgery
  from co_hours co
  inner join admissions adm
    on co.hadm_id = adm.hadm_id
  left join surgflag sf
    on co.icustay_id = sf.icustay_id
  left join mini_agg ma
    on co.icustay_id = ma.icustay_id
    and co.hr = ma.hr
  left join uo
    on co.icustay_id = uo.icustay_id
    and co.hr = uo.hr
)
, scorecalc as
(
  -- Calculate the final score
  -- note that if the underlying data is missing, the component is null
  -- eventually these are treated as 0 (normal), but knowing when data is missing is useful for debugging
  select scorecomp.*
    -- Below code calculates the component scores needed for OASIS
    , case when preiculos is null then null
        when preiculos < '0 0:10:12' then 5
        when preiculos < '0 4:57:00' then 3
        when preiculos < '1 0:00:00' then 0
        when preiculos < '12 23:48:00' then 1
        else 2 end as preiculos_score
    ,  case when age is null then null
        when age < 24 then 0
        when age <= 53 then 3
        when age <= 77 then 6
        when age <= 89 then 9
        when age >= 90 then 7
        else 0 end as age_score
    ,  case when mingcs is null then null
        when mingcs <= 7 then 10
        when mingcs < 14 then 4
        when mingcs = 14 then 3
        else 0 end as gcs_score
    ,  case when heartrate_max is null then null
        when heartrate_max > 125 then 6
        when heartrate_min < 33 then 4
        when heartrate_max >= 107 and heartrate_max <= 125 then 3
        when heartrate_max >= 89 and heartrate_max <= 106 then 1
        else 0 end as heartrate_score
    ,  case when meanbp_min is null then null
        when meanbp_min < 20.65 then 4
        when meanbp_min < 51 then 3
        when meanbp_max > 143.44 then 3
        when meanbp_min >= 51 and meanbp_min < 61.33 then 2
        else 0 end as meanbp_score
    ,  case when resprate_min is null then null
        when resprate_min <   6 then 10
        when resprate_max >  44 then  9
        when resprate_max >  30 then  6
        when resprate_max >  22 then  1
        when resprate_min <  13 then 1 else 0
        end as resprate_score
    ,  case when tempc_max is null then null
        when tempc_max > 39.88 then 6
        when tempc_min >= 33.22 and tempc_min <= 35.93 then 4
        when tempc_max >= 33.22 and tempc_max <= 35.93 then 4
        when tempc_min < 33.22 then 3
        when tempc_min > 35.93 and tempc_min <= 36.39 then 2
        when tempc_max >= 36.89 and tempc_max <= 39.88 then 2
        else 0 end as temp_score
    ,  case 
        when SUM(urineoutput) OVER W is null then null
        when SUM(urineoutput) OVER W < 671.09 then 10
        when SUM(urineoutput) OVER W > 6896.80 then 8
        when SUM(urineoutput) OVER W >= 671.09
        and SUM(urineoutput) OVER W <= 1426.99 then 5
        when SUM(urineoutput) OVER W >= 1427.00
        and SUM(urineoutput) OVER W <= 2544.14 then 1
        else 0 end as urineoutput_score
    ,  case when mechvent is null then null
        when mechvent = 1 then 9
        else 0 end as mechvent_score
    ,  case when electivesurgery is null then null
        when electivesurgery = 1 then 0
        else 6 end as electivesurgery_score
  from scorecomp
  WINDOW W as
  (
    PARTITION BY icustay_id
    ORDER BY hr
    ROWS BETWEEN 23 PRECEDING AND 0 FOLLOWING
  )
)
, score_final as
(
  select s.*
    -- Look for the worst instantaneous score over the last 24 hours
    -- Impute 0 if the score is missing
    , preiculos_score AS preiculos_score_24hours
    , electivesurgery_score as electivesurgery_score_24hours
    , coalesce(MAX(age_score) OVER W, 0)::SMALLINT as age_score_24hours
    , coalesce(MAX(gcs_score) OVER W, 0)::SMALLINT as gcs_score_24hours
    , coalesce(MAX(heartrate_score) OVER W, 0)::SMALLINT as heartrate_score_24hours
    , coalesce(MAX(meanbp_score) OVER W,0)::SMALLINT as meanbp_score_24hours
    , coalesce(MAX(resprate_score) OVER W,0)::SMALLINT as resprate_score_24hours
    , coalesce(MAX(temp_score) OVER W,0)::SMALLINT as temp_score_24hours
    , coalesce(MAX(urineoutput_score) OVER W,0)::SMALLINT as urineoutput_score_24hours
    , coalesce(MAX(mechvent_score) OVER W,0)::SMALLINT as mechvent_score_24hours

    -- sum together data for final OASIS
    , (preiculos_score
    + electivesurgery_score
    + coalesce(MAX(age_score) OVER W, 0)
    + coalesce(MAX(gcs_score) OVER W, 0)
    + coalesce(MAX(heartrate_score) OVER W, 0)
    + coalesce(MAX(meanbp_score) OVER W,0)
    + coalesce(MAX(resprate_score) OVER W,0)
    + coalesce(MAX(temp_score) OVER W,0)
    + coalesce(MAX(urineoutput_score) OVER W,0)
    + coalesce(MAX(mechvent_score) OVER W,0)
    )::SMALLINT
    as OASIS_24hours
  from scorecalc s
  WINDOW W as
  (
    PARTITION BY icustay_id
    ORDER BY hr
    ROWS BETWEEN 23 PRECEDING AND 0 FOLLOWING
  )
)
select * from score_final
where hr >= 0
order by icustay_id, hr
  );",109348,Thread-1,2022-07-18T00:11:36.240871Z
E001,,debug,"Postgres adapter: Postgres error: relation ""surgflag"" does not exist
LINE 145:   left join surgflag sf
                      ^
",109348,Thread-1,2022-07-18T00:11:36.242979Z
E012,,debug,On model.mimic.pivoted_oasis: ROLLBACK,109348,Thread-1,2022-07-18T00:11:36.243274Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:36.243897Z
E010,,debug,On model.mimic.pivoted_oasis: Close,109348,Thread-1,2022-07-18T00:11:36.244232Z
W002,,debug,"Database Error in model pivoted_oasis (models/pivot/pivoted_oasis.sql)
  relation ""surgflag"" does not exist
  LINE 145:   left join surgflag sf
                        ^
  compiled SQL at target/run/mimic/models/pivot/pivoted_oasis.sql",109348,Thread-1,2022-07-18T00:11:36.245740Z
Q035,0,error,89 of 107 ERROR creating table model public.pivoted_oasis ...................... [[31mERROR[0m in 0.03s],109348,Thread-1,2022-07-18T00:11:36.246356Z,table,null,pivoted_oasis,pivot/pivoted_oasis.sql,2022-07-18T00:11:36.217165,compiling,model,,,
Q024,0.02748584747314453,debug,Finished running node model.mimic.pivoted_oasis,109348,Thread-1,2022-07-18T00:11:36.247874Z,table,2022-07-18T00:11:36.247632,pivoted_oasis,pivot/pivoted_oasis.sql,2022-07-18T00:11:36.217165,error,model,,,
Q023,,debug,Began running node model.mimic.ventilation_durations,109348,Thread-1,2022-07-18T00:11:36.248792Z,table,null,ventilation_durations,durations/ventilation_durations.sql,2022-07-18T00:11:36.248707,started,model,,,
Q033,,info,90 of 107 START table model public.ventilation_durations ....................... [RUN],109348,Thread-1,2022-07-18T00:11:36.249341Z,table,null,ventilation_durations,durations/ventilation_durations.sql,2022-07-18T00:11:36.248707,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.ventilation_durations""",109348,Thread-1,2022-07-18T00:11:36.250236Z
Q030,,debug,Began compiling node model.mimic.ventilation_durations,109348,Thread-1,2022-07-18T00:11:36.250617Z,table,null,ventilation_durations,durations/ventilation_durations.sql,2022-07-18T00:11:36.248707,compiling,model,,,
Q027,,debug,Compiling model.mimic.ventilation_durations,109348,Thread-1,2022-07-18T00:11:36.250957Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.ventilation_durations""",109348,Thread-1,2022-07-18T00:11:36.253883Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:36.254553Z
Q031,,debug,Began executing node model.mimic.ventilation_durations,109348,Thread-1,2022-07-18T00:11:36.254902Z,table,null,ventilation_durations,durations/ventilation_durations.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.ventilation_durations""",109348,Thread-1,2022-07-18T00:11:36.264089Z
E015,,debug,"Using postgres connection ""model.mimic.ventilation_durations""",109348,Thread-1,2022-07-18T00:11:36.265273Z
E016,,debug,On model.mimic.ventilation_durations: BEGIN,109348,Thread-1,2022-07-18T00:11:36.266044Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:11:36.266965Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:36.273212Z
E015,,debug,"Using postgres connection ""model.mimic.ventilation_durations""",109348,Thread-1,2022-07-18T00:11:36.273523Z
E016,,debug,"On model.mimic.ventilation_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.ventilation_durations""} */


  create  table ""postgres"".""public"".""ventilation_durations__dbt_tmp""
  as (
    -- This query extracts the duration of mechanical ventilation
-- The main goal of the query is to aggregate sequential ventilator settings
-- into single mechanical ventilation ""events"". The start and end time of these
-- events can then be used for various purposes: calculating the total duration
-- of mechanical ventilation, cross-checking values (e.g. PaO2:FiO2 on vent), etc

-- The query's logic is roughly:
--    1) The presence of a mechanical ventilation setting starts a new ventilation event
--    2) Any instance of a setting in the next 8 hours continues the event
--    3) Certain elements end the current ventilation event
--        a) documented extubation ends the current ventilation
--        b) initiation of non-invasive vent and/or oxygen ends the current vent

-- See the ventilation_classification.sql query for step 1 of the above.
-- This query has the logic for converting events into durations.
with vd0 as
(
  select
    icustay_id
    -- this carries over the previous charttime which had a mechanical ventilation event
    , case
        when MechVent=1 then
          LAG(CHARTTIME, 1) OVER (partition by icustay_id, MechVent order by charttime)
        else null
      end as charttime_lag
    , charttime
    , MechVent
    , OxygenTherapy
    , Extubated
    , SelfExtubated
  from ""postgres"".""public"".""ventilation_classification""
)
, vd1 as
(
  select
      icustay_id
      , charttime_lag
      , charttime
      , MechVent
      , OxygenTherapy
      , Extubated
      , SelfExtubated

      -- if this is a mechanical ventilation event, we calculate the time since the last event
      , case
          -- if the current observation indicates mechanical ventilation is present
          -- calculate the time since the last vent event
          when MechVent=1 then
            DATETIME_DIFF(CHARTTIME, charttime_lag, 'MINUTE')/60
          else null
        end as ventduration

      , LAG(Extubated,1)
      OVER
      (
      partition by icustay_id, case when MechVent=1 or Extubated=1 then 1 else 0 end
      order by charttime
      ) as ExtubatedLag

      -- now we determine if the current mech vent event is a ""new"", i.e. they've just been intubated
      , case
        -- if there is an extubation flag, we mark any subsequent ventilation as a new ventilation event
          --when Extubated = 1 then 0 -- extubation is *not* a new ventilation event, the *subsequent* row is
          when
            LAG(Extubated,1)
            OVER
            (
            partition by icustay_id, case when MechVent=1 or Extubated=1 then 1 else 0 end
            order by charttime
            )
            = 1 then 1
          -- if patient has initiated oxygen therapy, and is not currently vented, start a newvent
          when MechVent = 0 and OxygenTherapy = 1 then 1
            -- if there is less than 8 hours between vent settings, we do not treat this as a new ventilation event
          when CHARTTIME > DATETIME_ADD(charttime_lag, INTERVAL '8' HOUR)
            then 1
        else 0
        end as newvent
  -- use the staging table with only vent settings from chart events
  FROM vd0 ventsettings
)
, vd2 as
(
  select vd1.*
  -- create a cumulative sum of the instances of new ventilation
  -- this results in a monotonic integer assigned to each instance of ventilation
  , case when MechVent=1 or Extubated = 1 then
      SUM( newvent )
      OVER ( partition by icustay_id order by charttime )
    else null end
    as ventnum
  --- now we convert CHARTTIME of ventilator settings into durations
  from vd1
)
-- create the durations for each mechanical ventilation instance
select icustay_id
  -- regenerate ventnum so it's sequential
  , ROW_NUMBER() over (partition by icustay_id order by ventnum) as ventnum
  , min(charttime) as starttime
  , max(charttime) as endtime
  , DATETIME_DIFF(max(charttime), min(charttime), 'MINUTE')/60 AS duration_hours
from vd2
group by icustay_id, vd2.ventnum
having min(charttime) != max(charttime)
-- patient had to be mechanically ventilated at least once
-- i.e. max(mechvent) should be 1
-- this excludes a frequent situation of NIV/oxygen before intub
-- in these cases, ventnum=0 and max(mechvent)=0, so they are ignored
and max(mechvent) = 1
order by icustay_id, ventnum
  );",109348,Thread-1,2022-07-18T00:11:36.273844Z
E017,,debug,SQL status: SELECT 3 in 0.03 seconds,109348,Thread-1,2022-07-18T00:11:36.308399Z
E015,,debug,"Using postgres connection ""model.mimic.ventilation_durations""",109348,Thread-1,2022-07-18T00:11:36.315874Z
E016,,debug,"On model.mimic.ventilation_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.ventilation_durations""} */
alter table ""postgres"".""public"".""ventilation_durations"" rename to ""ventilation_durations__dbt_backup""",109348,Thread-1,2022-07-18T00:11:36.316167Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:36.316892Z
E015,,debug,"Using postgres connection ""model.mimic.ventilation_durations""",109348,Thread-1,2022-07-18T00:11:36.320917Z
E016,,debug,"On model.mimic.ventilation_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.ventilation_durations""} */
alter table ""postgres"".""public"".""ventilation_durations__dbt_tmp"" rename to ""ventilation_durations""",109348,Thread-1,2022-07-18T00:11:36.321140Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:36.321950Z
E018,,debug,On model.mimic.ventilation_durations: COMMIT,109348,Thread-1,2022-07-18T00:11:36.324877Z
E015,,debug,"Using postgres connection ""model.mimic.ventilation_durations""",109348,Thread-1,2022-07-18T00:11:36.325083Z
E016,,debug,On model.mimic.ventilation_durations: COMMIT,109348,Thread-1,2022-07-18T00:11:36.325335Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:36.327096Z
E015,,debug,"Using postgres connection ""model.mimic.ventilation_durations""",109348,Thread-1,2022-07-18T00:11:36.329413Z
E016,,debug,"On model.mimic.ventilation_durations: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.ventilation_durations""} */
drop table if exists ""postgres"".""public"".""ventilation_durations__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:11:36.329901Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:36.332335Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:36.335581Z
E010,,debug,On model.mimic.ventilation_durations: Close,109348,Thread-1,2022-07-18T00:11:36.335868Z
Q012,0,info,90 of 107 OK created table model public.ventilation_durations .................. [[32mSELECT 3[0m in 0.09s],109348,Thread-1,2022-07-18T00:11:36.336825Z,table,null,ventilation_durations,durations/ventilation_durations.sql,2022-07-18T00:11:36.248707,compiling,model,,,
Q024,0.08680081367492676,debug,Finished running node model.mimic.ventilation_durations,109348,Thread-1,2022-07-18T00:11:36.337427Z,table,2022-07-18T00:11:36.337244,ventilation_durations,durations/ventilation_durations.sql,2022-07-18T00:11:36.248707,success,model,,,
Q023,,debug,Began running node model.mimic.qsofa,109348,Thread-1,2022-07-18T00:11:36.338033Z,table,null,qsofa,severityscores/qsofa.sql,2022-07-18T00:11:36.337946,started,model,,,
Q033,,info,91 of 107 START table model public.qsofa ....................................... [RUN],109348,Thread-1,2022-07-18T00:11:36.338823Z,table,null,qsofa,severityscores/qsofa.sql,2022-07-18T00:11:36.337946,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.qsofa""",109348,Thread-1,2022-07-18T00:11:36.340290Z
Q030,,debug,Began compiling node model.mimic.qsofa,109348,Thread-1,2022-07-18T00:11:36.340633Z,table,null,qsofa,severityscores/qsofa.sql,2022-07-18T00:11:36.337946,compiling,model,,,
Q027,,debug,Compiling model.mimic.qsofa,109348,Thread-1,2022-07-18T00:11:36.340952Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.qsofa""",109348,Thread-1,2022-07-18T00:11:36.344475Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:36.345222Z
Q031,,debug,Began executing node model.mimic.qsofa,109348,Thread-1,2022-07-18T00:11:36.346518Z,table,null,qsofa,severityscores/qsofa.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.qsofa""",109348,Thread-1,2022-07-18T00:11:36.354949Z
E015,,debug,"Using postgres connection ""model.mimic.qsofa""",109348,Thread-1,2022-07-18T00:11:36.355657Z
E016,,debug,On model.mimic.qsofa: BEGIN,109348,Thread-1,2022-07-18T00:11:36.355911Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:11:36.356113Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:36.362789Z
E015,,debug,"Using postgres connection ""model.mimic.qsofa""",109348,Thread-1,2022-07-18T00:11:36.363160Z
E016,,debug,"On model.mimic.qsofa: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.qsofa""} */


  create  table ""postgres"".""public"".""qsofa__dbt_tmp""
  as (
    -- ------------------------------------------------------------------
-- Title: Quick Sequential Organ Failure Assessment (qSOFA)
-- This query extracts the quick sequential organ failure assessment.
-- This score was a recent revision of SOFA, aiming to detect patients at risk of sepsis.
-- The score is calculated on the first day of each ICU patients' stay - though needn't be.
-- ------------------------------------------------------------------

-- Reference for qSOFA:
--    Singer M, et al. The Third International Consensus Definitions for Sepsis and Septic Shock (Sepsis-3)
--    Seymour CW, et al. Assessment of Clinical Criteria for Sepsis: For the Third International Consensus Definitions for Sepsis and Septic Shock (Sepsis-3)

-- Variables used in qSOFA:
--  GCS, respiratory rate, systolic blood pressure

-- The following views required to run this query:
--  1) gcsfirstday - generated by gcs-first-day.sql
--  2) vitalsfirstday - generated by vitals-first-day.sql

-- Note:
--  The score is calculated for *all* ICU patients, with the assumption that the user will subselect appropriate ICUSTAY_IDs.
--  For example, the score is calculated for neonates, but it is likely inappropriate to actually use the score values for these patients.

with scorecomp as
(
select ie.icustay_id
  , v.sysbp_min
  , v.resprate_max
  , gcs.mingcs
FROM icustays ie
left join ""postgres"".""public"".""vitals_first_day"" v
  on ie.icustay_id = v.icustay_id
left join ""postgres"".""public"".""gcs_first_day"" gcs
  on ie.icustay_id = gcs.icustay_id
)
, scorecalc as
(
  -- Calculate the final score
  -- note that if the underlying data is missing, the component is null
  -- eventually these are treated as 0 (normal), but knowing when data is missing is useful for debugging
  select icustay_id
  , case
      when sysbp_min is null then null
      when sysbp_min   <= 100 then 1
      else 0 end
    as sysbp_score
  , case
      when mingcs is null then null
      when mingcs   <= 13 then 1
      else 0 end
    as gcs_score
  , case
      when resprate_max is null then null
      when resprate_max   >= 22 then 1
      else 0 end
    as resprate_score
  from scorecomp
)
select ie.subject_id, ie.hadm_id, ie.icustay_id
, coalesce(sysbp_score,0)
 + coalesce(gcs_score,0)
 + coalesce(resprate_score,0)
 as qsofa
, sysbp_score
, gcs_score
, resprate_score
FROM icustays ie
left join scorecalc s
  on ie.icustay_id = s.icustay_id
order by ie.icustay_id
  );",109348,Thread-1,2022-07-18T00:11:36.363496Z
E017,,debug,SQL status: SELECT 61532 in 0.16 seconds,109348,Thread-1,2022-07-18T00:11:36.526620Z
E015,,debug,"Using postgres connection ""model.mimic.qsofa""",109348,Thread-1,2022-07-18T00:11:36.536599Z
E016,,debug,"On model.mimic.qsofa: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.qsofa""} */
alter table ""postgres"".""public"".""qsofa"" rename to ""qsofa__dbt_backup""",109348,Thread-1,2022-07-18T00:11:36.536887Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:36.538160Z
E015,,debug,"Using postgres connection ""model.mimic.qsofa""",109348,Thread-1,2022-07-18T00:11:36.543194Z
E016,,debug,"On model.mimic.qsofa: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.qsofa""} */
alter table ""postgres"".""public"".""qsofa__dbt_tmp"" rename to ""qsofa""",109348,Thread-1,2022-07-18T00:11:36.543582Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:36.544408Z
E018,,debug,On model.mimic.qsofa: COMMIT,109348,Thread-1,2022-07-18T00:11:36.550659Z
E015,,debug,"Using postgres connection ""model.mimic.qsofa""",109348,Thread-1,2022-07-18T00:11:36.550944Z
E016,,debug,On model.mimic.qsofa: COMMIT,109348,Thread-1,2022-07-18T00:11:36.551254Z
E017,,debug,SQL status: COMMIT in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:36.558590Z
E015,,debug,"Using postgres connection ""model.mimic.qsofa""",109348,Thread-1,2022-07-18T00:11:36.560404Z
E016,,debug,"On model.mimic.qsofa: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.qsofa""} */
drop table if exists ""postgres"".""public"".""qsofa__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:11:36.560678Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:36.563508Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:36.567513Z
E010,,debug,On model.mimic.qsofa: Close,109348,Thread-1,2022-07-18T00:11:36.567806Z
Q012,0,info,91 of 107 OK created table model public.qsofa .................................. [[32mSELECT 61532[0m in 0.23s],109348,Thread-1,2022-07-18T00:11:36.568705Z,table,null,qsofa,severityscores/qsofa.sql,2022-07-18T00:11:36.337946,compiling,model,,,
Q024,0.2285783290863037,debug,Finished running node model.mimic.qsofa,109348,Thread-1,2022-07-18T00:11:36.569243Z,table,2022-07-18T00:11:36.569123,qsofa,severityscores/qsofa.sql,2022-07-18T00:11:36.337946,success,model,,,
Q023,,debug,Began running node model.mimic.sirs,109348,Thread-1,2022-07-18T00:11:36.569525Z,table,null,sirs,severityscores/sirs.sql,2022-07-18T00:11:36.569503,started,model,,,
Q033,,info,92 of 107 START table model public.sirs ........................................ [RUN],109348,Thread-1,2022-07-18T00:11:36.570503Z,table,null,sirs,severityscores/sirs.sql,2022-07-18T00:11:36.569503,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.sirs""",109348,Thread-1,2022-07-18T00:11:36.571446Z
Q030,,debug,Began compiling node model.mimic.sirs,109348,Thread-1,2022-07-18T00:11:36.571719Z,table,null,sirs,severityscores/sirs.sql,2022-07-18T00:11:36.569503,compiling,model,,,
Q027,,debug,Compiling model.mimic.sirs,109348,Thread-1,2022-07-18T00:11:36.572050Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.sirs""",109348,Thread-1,2022-07-18T00:11:36.575565Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:36.576466Z
Q031,,debug,Began executing node model.mimic.sirs,109348,Thread-1,2022-07-18T00:11:36.576771Z,table,null,sirs,severityscores/sirs.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.sirs""",109348,Thread-1,2022-07-18T00:11:36.587077Z
E015,,debug,"Using postgres connection ""model.mimic.sirs""",109348,Thread-1,2022-07-18T00:11:36.587571Z
E016,,debug,On model.mimic.sirs: BEGIN,109348,Thread-1,2022-07-18T00:11:36.587867Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:11:36.588083Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:36.593100Z
E015,,debug,"Using postgres connection ""model.mimic.sirs""",109348,Thread-1,2022-07-18T00:11:36.593362Z
E016,,debug,"On model.mimic.sirs: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.sirs""} */


  create  table ""postgres"".""public"".""sirs__dbt_tmp""
  as (
    -- ------------------------------------------------------------------
-- Title: Systemic inflammatory response syndrome (SIRS) criteria
-- This query extracts the Systemic inflammatory response syndrome (SIRS) criteria
-- The criteria quantify the level of inflammatory response of the body
-- The score is calculated on the first day of each ICU patients' stay.
-- ------------------------------------------------------------------

-- Reference for SIRS:
--    American College of Chest Physicians/Society of Critical Care Medicine Consensus Conference:
--    definitions for sepsis and organ failure and guidelines for the use of innovative therapies in sepsis""
--    Crit. Care Med. 20 (6): 864–74. 1992.
--    doi:10.1097/00003246-199206000-00025. PMID 1597042.

-- Variables used in SIRS:
--  Body temperature (min and max)
--  Heart rate (max)
--  Respiratory rate (max)
--  PaCO2 (min)
--  White blood cell count (min and max)
--  the presence of greater than 10% immature neutrophils (band forms)

-- The following views required to run this query:
--  1) vitals_first_day - generated by vitals-first-day.sql
--  2) labs_first_day - generated by labs-first-day.sql
--  3) blood_gas_first_day_arterial - generated by blood-gas-first-day-arterial.sql

-- Note:
--  The score is calculated for *all* ICU patients, with the assumption that the user will subselect appropriate ICUSTAY_IDs.
--  For example, the score is calculated for neonates, but it is likely inappropriate to actually use the score values for these patients.

with bg as
(
  -- join blood gas to ventilation durations to determine if patient was vent
  select bg.icustay_id
  , min(pco2) as paco2_min
  from ""postgres"".""public"".""blood_gas_first_day_arterial"" bg
  where specimen_pred = 'ART'
  group by bg.icustay_id
)
-- Aggregate the components for the score
, scorecomp as
(
select ie.icustay_id
  , v.tempc_min
  , v.tempc_max
  , v.heartrate_max
  , v.resprate_max
  , bg.paco2_min
  , l.wbc_min
  , l.wbc_max
  , l.bands_max
FROM icustays ie
left join bg
 on ie.icustay_id = bg.icustay_id
left join ""postgres"".""public"".""vitals_first_day"" v
  on ie.icustay_id = v.icustay_id
left join ""postgres"".""public"".""labs_first_day"" l
  on ie.icustay_id = l.icustay_id
)
, scorecalc as
(
  -- Calculate the final score
  -- note that if the underlying data is missing, the component is null
  -- eventually these are treated as 0 (normal), but knowing when data is missing is useful for debugging
  select icustay_id

  , case
      when tempc_min < 36.0 then 1
      when tempc_max > 38.0 then 1
      when tempc_min is null then null
      else 0
    end as temp_score


  , case
      when heartrate_max > 90.0  then 1
      when heartrate_max is null then null
      else 0
    end as heartrate_score

  , case
      when resprate_max > 20.0  then 1
      when paco2_min < 32.0  then 1
      when coalesce(resprate_max, paco2_min) is null then null
      else 0
    end as resp_score

  , case
      when wbc_min <  4.0  then 1
      when wbc_max > 12.0  then 1
      when bands_max > 10 then 1-- > 10% immature neurophils (band forms)
      when coalesce(wbc_min, bands_max) is null then null
      else 0
    end as wbc_score

  from scorecomp
)
select
  ie.subject_id, ie.hadm_id, ie.icustay_id
  -- Combine all the scores to get SOFA
  -- Impute 0 if the score is missing
  , coalesce(temp_score,0)
  + coalesce(heartrate_score,0)
  + coalesce(resp_score,0)
  + coalesce(wbc_score,0)
    as sirs
  , temp_score, heartrate_score, resp_score, wbc_score
FROM icustays ie
left join scorecalc s
  on ie.icustay_id = s.icustay_id
order by ie.icustay_id
  );",109348,Thread-1,2022-07-18T00:11:36.593722Z
E017,,debug,SQL status: SELECT 61532 in 0.15 seconds,109348,Thread-1,2022-07-18T00:11:36.739985Z
E015,,debug,"Using postgres connection ""model.mimic.sirs""",109348,Thread-1,2022-07-18T00:11:36.747302Z
E016,,debug,"On model.mimic.sirs: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.sirs""} */
alter table ""postgres"".""public"".""sirs"" rename to ""sirs__dbt_backup""",109348,Thread-1,2022-07-18T00:11:36.747726Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:36.748874Z
E015,,debug,"Using postgres connection ""model.mimic.sirs""",109348,Thread-1,2022-07-18T00:11:36.753137Z
E016,,debug,"On model.mimic.sirs: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.sirs""} */
alter table ""postgres"".""public"".""sirs__dbt_tmp"" rename to ""sirs""",109348,Thread-1,2022-07-18T00:11:36.753383Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:36.754393Z
E018,,debug,On model.mimic.sirs: COMMIT,109348,Thread-1,2022-07-18T00:11:36.758365Z
E015,,debug,"Using postgres connection ""model.mimic.sirs""",109348,Thread-1,2022-07-18T00:11:36.758626Z
E016,,debug,On model.mimic.sirs: COMMIT,109348,Thread-1,2022-07-18T00:11:36.758857Z
E017,,debug,SQL status: COMMIT in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:36.767260Z
E015,,debug,"Using postgres connection ""model.mimic.sirs""",109348,Thread-1,2022-07-18T00:11:36.769047Z
E016,,debug,"On model.mimic.sirs: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.sirs""} */
drop table if exists ""postgres"".""public"".""sirs__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:11:36.769275Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:36.771389Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:36.775522Z
E010,,debug,On model.mimic.sirs: Close,109348,Thread-1,2022-07-18T00:11:36.775782Z
Q012,0,info,92 of 107 OK created table model public.sirs ................................... [[32mSELECT 61532[0m in 0.21s],109348,Thread-1,2022-07-18T00:11:36.776687Z,table,null,sirs,severityscores/sirs.sql,2022-07-18T00:11:36.569503,compiling,model,,,
Q024,0.20547032356262207,debug,Finished running node model.mimic.sirs,109348,Thread-1,2022-07-18T00:11:36.777445Z,table,2022-07-18T00:11:36.777271,sirs,severityscores/sirs.sql,2022-07-18T00:11:36.569503,success,model,,,
Q023,,debug,Began running node model.mimic.epinephrine_dose,109348,Thread-1,2022-07-18T00:11:36.778425Z,table,null,epinephrine_dose,durations/epinephrine_dose.sql,2022-07-18T00:11:36.778330,started,model,,,
Q033,,info,93 of 107 START table model public.epinephrine_dose ............................ [RUN],109348,Thread-1,2022-07-18T00:11:36.779682Z,table,null,epinephrine_dose,durations/epinephrine_dose.sql,2022-07-18T00:11:36.778330,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.epinephrine_dose""",109348,Thread-1,2022-07-18T00:11:36.781079Z
Q030,,debug,Began compiling node model.mimic.epinephrine_dose,109348,Thread-1,2022-07-18T00:11:36.781330Z,table,null,epinephrine_dose,durations/epinephrine_dose.sql,2022-07-18T00:11:36.778330,compiling,model,,,
Q027,,debug,Compiling model.mimic.epinephrine_dose,109348,Thread-1,2022-07-18T00:11:36.781806Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.epinephrine_dose""",109348,Thread-1,2022-07-18T00:11:36.784904Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:36.785460Z
Q031,,debug,Began executing node model.mimic.epinephrine_dose,109348,Thread-1,2022-07-18T00:11:36.785915Z,table,null,epinephrine_dose,durations/epinephrine_dose.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.epinephrine_dose""",109348,Thread-1,2022-07-18T00:11:36.795737Z
E015,,debug,"Using postgres connection ""model.mimic.epinephrine_dose""",109348,Thread-1,2022-07-18T00:11:36.797095Z
E016,,debug,On model.mimic.epinephrine_dose: BEGIN,109348,Thread-1,2022-07-18T00:11:36.797760Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:11:36.798119Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:36.805198Z
E015,,debug,"Using postgres connection ""model.mimic.epinephrine_dose""",109348,Thread-1,2022-07-18T00:11:36.805535Z
E016,,debug,"On model.mimic.epinephrine_dose: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.epinephrine_dose""} */


  create  table ""postgres"".""public"".""epinephrine_dose__dbt_tmp""
  as (
    -- This query extracts dose+durations of epinephrine administration

-- Requires the weightfirstday table

-- Get drug administration data from CareVue first
with vasocv1 as
(
  select
    cv.icustay_id, cv.charttime
    -- case statement determining whether the ITEMID is an instance of vasopressor usage
    , max(case when itemid in (30044,30119,30309) then 1 else 0 end) as vaso -- epinephrine

    -- the 'stopped' column indicates if a vasopressor has been disconnected
    , max(case when itemid in (30044,30119,30309) and (stopped = 'Stopped' OR stopped like 'D/C%') then 1
          else 0 end) as vaso_stopped

    , max(case when itemid in (30044,30119,30309) and rate is not null then 1 else 0 end) as vaso_null
    , max(case
            when itemid = 30044 and wd.weight is null then rate / 80.0 -- super rare to be missing weight... affects 2 patients for 14 rows
            when itemid = 30044 then rate / wd.weight -- measured in mcgmin
            when itemid in (30119,30309) then rate -- measured in mcgkgmin
            else null
          end) as vaso_rate
    , max(case when itemid in (30044,30119,30309) then amount else null end) as vaso_amount

  FROM inputevents_cv cv
  left join ""postgres"".""public"".""weight_durations"" wd
    on cv.icustay_id = wd.icustay_id
    and cv.charttime between wd.starttime and wd.endtime
  where itemid in
  (
        30044,30119,30309 -- epinephrine
  )
  and cv.icustay_id is not null
  group by cv.icustay_id, charttime
)
, vasocv2 as
(
  select v.*
    , sum(vaso_null) over (partition by icustay_id order by charttime) as vaso_partition
  from
    vasocv1 v
)
, vasocv3 as
(
  select v.*
    , first_value(vaso_rate) over (partition by icustay_id, vaso_partition order by charttime) as vaso_prevrate_ifnull
  from
    vasocv2 v
)
, vasocv4 as
(
select
    icustay_id
    , charttime
    -- , (CHARTTIME - (LAG(CHARTTIME, 1) OVER (partition by icustay_id, vaso order by charttime))) AS delta

    , vaso
    , vaso_rate
    , vaso_amount
    , vaso_stopped
    , vaso_prevrate_ifnull

    -- We define start time here
    , case
        when vaso = 0 then null

        -- if this is the first instance of the vasoactive drug
        when vaso_rate > 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso, vaso_null
          order by charttime
          )
          is null
          then 1

        -- you often get a string of 0s
        -- we decide not to set these as 1, just because it makes vasonum sequential
        when vaso_rate = 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 0
          then 0

        -- sometimes you get a string of NULL, associated with 0 volumes
        -- same reason as before, we decide not to set these as 1
        -- vaso_prevrate_ifnull is equal to the previous value *iff* the current value is null
        when vaso_prevrate_ifnull = 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 0
          then 0

        -- If the last recorded rate was 0, newvaso = 1
        when LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          ) = 0
          then 1

        -- If the last recorded vaso was D/C'd, newvaso = 1
        when
          LAG(vaso_stopped,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 1 then 1

        -- ** not sure if the below is needed
        --when (CHARTTIME - (LAG(CHARTTIME, 1) OVER (partition by icustay_id, vaso order by charttime))) > (interval '4 hours') then 1
      else null
      end as vaso_start

FROM
  vasocv3
)
-- propagate start/stop flags forward in time
, vasocv5 as
(
  select v.*
    , SUM(vaso_start) OVER (partition by icustay_id, vaso order by charttime) as vaso_first
FROM
  vasocv4 v
)
, vasocv6 as
(
  select v.*
    -- We define end time here
    , case
        when vaso = 0
          then null

        -- If the recorded vaso was D/C'd, this is an end time
        when vaso_stopped = 1
          then vaso_first

        -- If the rate is zero, this is the end time
        when vaso_rate = 0
          then vaso_first

        -- the last row in the table is always a potential end time
        -- this captures patients who die/are discharged while on vasopressors
        -- in principle, this could add an extra end time for the vasopressor
        -- however, since we later group on vaso_start, any extra end times are ignored
        when LEAD(CHARTTIME,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          ) is null
          then vaso_first

        else null
        end as vaso_stop
    from vasocv5 v
)

-- -- if you want to look at the results of the table before grouping:
-- select
--   icustay_id, charttime, vaso, vaso_rate, vaso_amount
--     , vaso_stopped
--     , vaso_start
--     , vaso_first
--     , vaso_stop
-- from vasocv6 order by icustay_id, charttime

, vasocv7 as
(
select
  icustay_id
  , charttime as starttime
  , lead(charttime) OVER (partition by icustay_id, vaso_first order by charttime) as endtime
  , vaso, vaso_rate, vaso_amount, vaso_stop, vaso_start, vaso_first
from vasocv6
where
  vaso_first is not null -- bogus data
and
  vaso_first != 0 -- sometimes *only* a rate of 0 appears, i.e. the drug is never actually delivered
and
  icustay_id is not null -- there are data for ""floating"" admissions, we don't worry about these
)
-- table of start/stop times for event
, vasocv8 as
(
  select
    icustay_id
    , starttime, endtime
    , vaso, vaso_rate, vaso_amount, vaso_stop, vaso_start, vaso_first
  from vasocv7
  where endtime is not null
  and vaso_rate > 0
  and starttime != endtime
)
-- collapse these start/stop times down if the rate doesn't change
, vasocv9 as
(
  select
    icustay_id
    , starttime, endtime
    , case
        when LAG(endtime) OVER (partition by icustay_id order by starttime, endtime) = starttime
        AND  LAG(vaso_rate) OVER (partition by icustay_id order by starttime, endtime) = vaso_rate
        THEN 0
      else 1
    end as vaso_groups
    , vaso, vaso_rate, vaso_amount, vaso_stop, vaso_start, vaso_first
  from vasocv8
  where endtime is not null
  and vaso_rate > 0
  and starttime != endtime
)
, vasocv10 as
(
  select
    icustay_id
    , starttime, endtime
    , vaso_groups
    , SUM(vaso_groups) OVER (partition by icustay_id order by starttime, endtime) as vaso_groups_sum
    , vaso, vaso_rate, vaso_amount, vaso_stop, vaso_start, vaso_first
  from vasocv9
)
, vasocv as
(
  select icustay_id
  , min(starttime) as starttime
  , max(endtime) as endtime
  , vaso_groups_sum
  , vaso_rate
  , sum(vaso_amount) as vaso_amount
  from vasocv10
  group by icustay_id, vaso_groups_sum, vaso_rate
)
-- now we extract the associated data for metavision patients
, vasomv as
(
  select
    icustay_id, linkorderid
    , rate as vaso_rate
    , amount as vaso_amount
    , starttime
    , endtime
  from inputevents_mv
  where itemid = 221289 -- epinephrine
  and statusdescription != 'Rewritten' -- only valid orders
)
-- now assign this data to every hour of the patient's stay
-- vaso_amount for carevue is not accurate
SELECT icustay_id
  , starttime, endtime
  , vaso_rate, vaso_amount
from vasocv
UNION ALL
SELECT icustay_id
  , starttime, endtime
  , vaso_rate, vaso_amount
from vasomv
order by icustay_id, starttime
  );",109348,Thread-1,2022-07-18T00:11:36.805988Z
E017,,debug,SQL status: SELECT 10562 in 0.68 seconds,109348,Thread-1,2022-07-18T00:11:37.484452Z
E015,,debug,"Using postgres connection ""model.mimic.epinephrine_dose""",109348,Thread-1,2022-07-18T00:11:37.489062Z
E016,,debug,"On model.mimic.epinephrine_dose: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.epinephrine_dose""} */
alter table ""postgres"".""public"".""epinephrine_dose"" rename to ""epinephrine_dose__dbt_backup""",109348,Thread-1,2022-07-18T00:11:37.489292Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:37.490133Z
E015,,debug,"Using postgres connection ""model.mimic.epinephrine_dose""",109348,Thread-1,2022-07-18T00:11:37.496230Z
E016,,debug,"On model.mimic.epinephrine_dose: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.epinephrine_dose""} */
alter table ""postgres"".""public"".""epinephrine_dose__dbt_tmp"" rename to ""epinephrine_dose""",109348,Thread-1,2022-07-18T00:11:37.496979Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:37.498190Z
E018,,debug,On model.mimic.epinephrine_dose: COMMIT,109348,Thread-1,2022-07-18T00:11:37.501345Z
E015,,debug,"Using postgres connection ""model.mimic.epinephrine_dose""",109348,Thread-1,2022-07-18T00:11:37.501605Z
E016,,debug,On model.mimic.epinephrine_dose: COMMIT,109348,Thread-1,2022-07-18T00:11:37.501969Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:37.505705Z
E015,,debug,"Using postgres connection ""model.mimic.epinephrine_dose""",109348,Thread-1,2022-07-18T00:11:37.508148Z
E016,,debug,"On model.mimic.epinephrine_dose: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.epinephrine_dose""} */
drop table if exists ""postgres"".""public"".""epinephrine_dose__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:11:37.508401Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:37.510556Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:37.516690Z
E010,,debug,On model.mimic.epinephrine_dose: Close,109348,Thread-1,2022-07-18T00:11:37.516949Z
Q012,0,info,93 of 107 OK created table model public.epinephrine_dose ....................... [[32mSELECT 10562[0m in 0.74s],109348,Thread-1,2022-07-18T00:11:37.517502Z,table,null,epinephrine_dose,durations/epinephrine_dose.sql,2022-07-18T00:11:36.778330,compiling,model,,,
Q024,0.7367081642150879,debug,Finished running node model.mimic.epinephrine_dose,109348,Thread-1,2022-07-18T00:11:37.518381Z,table,2022-07-18T00:11:37.518202,epinephrine_dose,durations/epinephrine_dose.sql,2022-07-18T00:11:36.778330,success,model,,,
Q023,,debug,Began running node model.mimic.heightweight,109348,Thread-1,2022-07-18T00:11:37.518923Z,table,null,heightweight,demographics/heightweight.sql,2022-07-18T00:11:37.518817,started,model,,,
Q033,,info,94 of 107 START table model public.heightweight ................................ [RUN],109348,Thread-1,2022-07-18T00:11:37.519711Z,table,null,heightweight,demographics/heightweight.sql,2022-07-18T00:11:37.518817,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.heightweight""",109348,Thread-1,2022-07-18T00:11:37.520481Z
Q030,,debug,Began compiling node model.mimic.heightweight,109348,Thread-1,2022-07-18T00:11:37.520792Z,table,null,heightweight,demographics/heightweight.sql,2022-07-18T00:11:37.518817,compiling,model,,,
Q027,,debug,Compiling model.mimic.heightweight,109348,Thread-1,2022-07-18T00:11:37.521125Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.heightweight""",109348,Thread-1,2022-07-18T00:11:37.523592Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:37.524142Z
Q031,,debug,Began executing node model.mimic.heightweight,109348,Thread-1,2022-07-18T00:11:37.524423Z,table,null,heightweight,demographics/heightweight.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.heightweight""",109348,Thread-1,2022-07-18T00:11:37.534973Z
E015,,debug,"Using postgres connection ""model.mimic.heightweight""",109348,Thread-1,2022-07-18T00:11:37.536037Z
E016,,debug,On model.mimic.heightweight: BEGIN,109348,Thread-1,2022-07-18T00:11:37.536382Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:11:37.536620Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:37.542227Z
E015,,debug,"Using postgres connection ""model.mimic.heightweight""",109348,Thread-1,2022-07-18T00:11:37.542565Z
E016,,debug,"On model.mimic.heightweight: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.heightweight""} */


  create  table ""postgres"".""public"".""heightweight__dbt_tmp""
  as (
    -- ------------------------------------------------------------------
-- Title: Extract height and weight for ICUSTAY_IDs
-- Description: This query gets the first, minimum, and maximum weight and height
--        for a single ICUSTAY_ID. It extracts data from the CHARTEVENTS table.
-- MIMIC version: MIMIC-III v1.4
-- ------------------------------------------------------------------

-- prep height
WITH ht_stg AS
(
  SELECT 
    c.subject_id, c.icustay_id, c.charttime,
    -- Ensure that all heights are in centimeters, and fix data as needed
    CASE
      WHEN c.itemid IN (920, 1394, 4187, 3486, 226707)
      THEN
        CASE
        -- rule for neonates
        WHEN c.charttime <= DATETIME_ADD(pt.dob, INTERVAL '1 YEAR')
         AND (c.valuenum * 2.54) < 80
          THEN c.valuenum * 2.54
        -- rule for adults
        WHEN c.charttime >  DATETIME_ADD(pt.dob, INTERVAL '1 YEAR')
         AND (c.valuenum * 2.54) > 120
         AND (c.valuenum * 2.54) < 230
          THEN c.valuenum * 2.54
        ELSE NULL END
      ELSE
        CASE
        -- rule for neonates
        WHEN c.charttime <= DATETIME_ADD(pt.dob, INTERVAL '1 YEAR')
         AND c.valuenum < 80
          THEN c.valuenum
        -- rule for adults
        WHEN c.charttime >  DATETIME_ADD(pt.dob, INTERVAL '1 YEAR')
         AND c.valuenum > 120
         AND c.valuenum < 230
          THEN c.valuenum
        ELSE NULL END
    END AS height
  FROM chartevents c
  INNER JOIN patients pt
    ON c.subject_id = pt.subject_id
  WHERE c.valuenum IS NOT NULL
  AND c.valuenum != 0
  -- exclude rows marked as error
  AND COALESCE(c.error, 0) = 0
  AND c.itemid IN
  (
    -- CareVue
    920, 1394, 4187, 3486,  -- Height inches
    3485, 4188              -- Height cm
    -- Metavision
    , 226707 -- Height (measured in inches)
    -- note we intentionally ignore the below ITEMID in metavision
    -- these are duplicate data in a different unit
    -- , 226730 -- Height (cm)
  )
)
SELECT 
  ie.icustay_id,
  ROUND(CAST(wt.weight_first AS NUMERIC), 2) AS weight_first,
  ROUND(CAST(wt.weight_min AS NUMERIC), 2) AS weight_min,
  ROUND(CAST(wt.weight_max AS NUMERIC), 2) AS weight_max,
  ROUND(CAST(ht.height_first AS NUMERIC), 2) AS height_first,
  ROUND(CAST(ht.height_min AS NUMERIC), 2) AS height_min,
  ROUND(CAST(ht.height_max AS NUMERIC), 2) AS height_max
FROM icustays ie
-- get weight from weight_durations table
LEFT JOIN
(
  SELECT icustay_id,
    MIN(CASE WHEN rn = 1 THEN weight ELSE NULL END) as weight_first,
    MIN(weight) AS weight_min,
    MAX(weight) AS weight_max
  FROM
  (
    SELECT
      icustay_id,
      weight,
      ROW_NUMBER() OVER (PARTITION BY icustay_id ORDER BY starttime) as rn
    FROM ""postgres"".""public"".""weight_durations""
  ) wt_stg
  GROUP BY icustay_id
) wt
  ON ie.icustay_id = wt.icustay_id
-- get first/min/max height from above, after filtering bad data
LEFT JOIN
(
  SELECT icustay_id,
    MIN(CASE WHEN rn = 1 THEN height ELSE NULL END) as height_first,
    MIN(height) AS height_min,
    MAX(height) AS height_max
  FROM
  (
    SELECT
      icustay_id,
      height,
      ROW_NUMBER() OVER (PARTITION BY icustay_id ORDER BY charttime) as rn
    FROM ht_stg
  ) ht_stg2
  GROUP BY icustay_id
) ht
  ON ie.icustay_id = ht.icustay_id
ORDER BY icustay_id
  );",109348,Thread-1,2022-07-18T00:11:37.542851Z
E017,,debug,SQL status: SELECT 61532 in 0.08 seconds,109348,Thread-1,2022-07-18T00:11:37.623986Z
E015,,debug,"Using postgres connection ""model.mimic.heightweight""",109348,Thread-1,2022-07-18T00:11:37.638030Z
E016,,debug,"On model.mimic.heightweight: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.heightweight""} */
alter table ""postgres"".""public"".""heightweight"" rename to ""heightweight__dbt_backup""",109348,Thread-1,2022-07-18T00:11:37.638336Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:37.639096Z
E015,,debug,"Using postgres connection ""model.mimic.heightweight""",109348,Thread-1,2022-07-18T00:11:37.707969Z
E016,,debug,"On model.mimic.heightweight: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.heightweight""} */
alter table ""postgres"".""public"".""heightweight__dbt_tmp"" rename to ""heightweight""",109348,Thread-1,2022-07-18T00:11:37.708341Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:37.709492Z
E018,,debug,On model.mimic.heightweight: COMMIT,109348,Thread-1,2022-07-18T00:11:37.717185Z
E015,,debug,"Using postgres connection ""model.mimic.heightweight""",109348,Thread-1,2022-07-18T00:11:37.717448Z
E016,,debug,On model.mimic.heightweight: COMMIT,109348,Thread-1,2022-07-18T00:11:37.717784Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:37.719167Z
E015,,debug,"Using postgres connection ""model.mimic.heightweight""",109348,Thread-1,2022-07-18T00:11:37.722115Z
E016,,debug,"On model.mimic.heightweight: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.heightweight""} */
drop table if exists ""postgres"".""public"".""heightweight__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:11:37.722443Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:11:37.725033Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:37.732432Z
E010,,debug,On model.mimic.heightweight: Close,109348,Thread-1,2022-07-18T00:11:37.732859Z
Q012,0,info,94 of 107 OK created table model public.heightweight ........................... [[32mSELECT 61532[0m in 0.21s],109348,Thread-1,2022-07-18T00:11:37.733940Z,table,null,heightweight,demographics/heightweight.sql,2022-07-18T00:11:37.518817,compiling,model,,,
Q024,0.21335864067077637,debug,Finished running node model.mimic.heightweight,109348,Thread-1,2022-07-18T00:11:37.734667Z,table,2022-07-18T00:11:37.734501,heightweight,demographics/heightweight.sql,2022-07-18T00:11:37.518817,success,model,,,
Q023,,debug,Began running node model.mimic.kdigo_uo,109348,Thread-1,2022-07-18T00:11:37.735155Z,table,null,kdigo_uo,organfailure/kdigo_uo.sql,2022-07-18T00:11:37.735094,started,model,,,
Q033,,info,95 of 107 START table model public.kdigo_uo .................................... [RUN],109348,Thread-1,2022-07-18T00:11:37.735806Z,table,null,kdigo_uo,organfailure/kdigo_uo.sql,2022-07-18T00:11:37.735094,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.kdigo_uo""",109348,Thread-1,2022-07-18T00:11:37.736820Z
Q030,,debug,Began compiling node model.mimic.kdigo_uo,109348,Thread-1,2022-07-18T00:11:37.737000Z,table,null,kdigo_uo,organfailure/kdigo_uo.sql,2022-07-18T00:11:37.735094,compiling,model,,,
Q027,,debug,Compiling model.mimic.kdigo_uo,109348,Thread-1,2022-07-18T00:11:37.737262Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.kdigo_uo""",109348,Thread-1,2022-07-18T00:11:37.740446Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:11:37.740878Z
Q031,,debug,Began executing node model.mimic.kdigo_uo,109348,Thread-1,2022-07-18T00:11:37.741047Z,table,null,kdigo_uo,organfailure/kdigo_uo.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.kdigo_uo""",109348,Thread-1,2022-07-18T00:11:37.750986Z
E015,,debug,"Using postgres connection ""model.mimic.kdigo_uo""",109348,Thread-1,2022-07-18T00:11:37.751865Z
E016,,debug,On model.mimic.kdigo_uo: BEGIN,109348,Thread-1,2022-07-18T00:11:37.752220Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:11:37.752476Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:11:37.759271Z
E015,,debug,"Using postgres connection ""model.mimic.kdigo_uo""",109348,Thread-1,2022-07-18T00:11:37.759739Z
E016,,debug,"On model.mimic.kdigo_uo: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.kdigo_uo""} */


  create  table ""postgres"".""public"".""kdigo_uo__dbt_tmp""
  as (
    with ur_stg as
(
  select io.icustay_id, io.charttime
  -- we have joined each row to all rows preceding within 24 hours
  -- we can now sum these rows to get total UO over the last 24 hours
  -- we can use case statements to restrict it to only the last 6/12 hours
  -- therefore we have three sums:
  -- 1) over a 6 hour period
  -- 2) over a 12 hour period
  -- 3) over a 24 hour period

  -- note that we assume data charted at charttime corresponds to 1 hour of UO
  -- therefore we use '5' and '11' to restrict the period, rather than 6/12
  -- this assumption may overestimate UO rate when documentation is done less than hourly
  , sum(case when DATETIME_DIFF(io.charttime, iosum.charttime, 'HOUR') <= 5
      then iosum.VALUE
    else null end) as urineoutput_6hr
  , sum(case when DATETIME_DIFF(io.charttime, iosum.charttime, 'HOUR') <= 11
      then iosum.VALUE
    else null end) as urineoutput_12hr
  -- 24 hours
  , sum(iosum.VALUE) as urineoutput_24hr

  -- retain the earliest time used for each summation
  -- this is later used to tabulate rates
  , MIN(case when io.charttime <= DATETIME_ADD(iosum.charttime, INTERVAL '5 HOUR')
      then iosum.charttime
    else null end)
    AS starttime_6hr
  , MIN(case when io.charttime <= DATETIME_ADD(iosum.charttime, INTERVAL '11 HOUR')
      then iosum.charttime
    else null end)
    AS starttime_12hr
  , MIN(iosum.charttime) AS starttime_24hr
  from ""postgres"".""public"".""urine_output"" io
  -- this join gives you all UO measurements over a 24 hour period
  left join ""postgres"".""public"".""urine_output"" iosum
    on  io.icustay_id = iosum.icustay_id
    and io.charttime >= iosum.charttime
    and io.charttime <= (DATETIME_ADD(iosum.charttime, INTERVAL '23 HOUR'))
  group by io.icustay_id, io.charttime
)
-- calculate hours used to sum UO over
, ur_stg2 AS
(
  select
    icustay_id
  , charttime
  , urineoutput_6hr
  , urineoutput_12hr
  , urineoutput_24hr
  -- calculate time over which we summed UO
  -- note: adding 1 hour as we assume data charted corresponds to previous hour
  -- i.e. if documentation is:
  --  10:00, 100 mL
  --  11:00, 50 mL
  -- then this is two hours of documentation, even though (11:00 - 10:00) is 1 hour
  , ROUND(DATETIME_DIFF(charttime, starttime_6hr, 'HOUR'), 4) + 1 AS uo_tm_6hr
  , ROUND(DATETIME_DIFF(charttime, starttime_12hr, 'HOUR'), 4) + 1 AS uo_tm_12hr
  , ROUND(DATETIME_DIFF(charttime, starttime_24hr, 'HOUR'), 4) + 1 AS uo_tm_24hr
  from ur_stg
)
select
  ur.icustay_id
, ur.charttime
, wd.weight
, ur.urineoutput_6hr
, ur.urineoutput_12hr
, ur.urineoutput_24hr
, ROUND(CAST((ur.urineoutput_6hr/wd.weight/uo_tm_6hr) AS NUMERIC), 4) AS uo_rt_6hr
, ROUND(CAST((ur.urineoutput_12hr/wd.weight/uo_tm_12hr) AS NUMERIC), 4) AS uo_rt_12hr
, ROUND(CAST((ur.urineoutput_24hr/wd.weight/uo_tm_24hr) AS NUMERIC), 4) AS uo_rt_24hr
-- time of earliest UO measurement that was used to calculate the rate
, uo_tm_6hr
, uo_tm_12hr
, uo_tm_24hr
from ur_stg2 ur
left join ""postgres"".""public"".""weight_durations"" wd
  on  ur.icustay_id = wd.icustay_id
  and ur.charttime >= wd.starttime
  and ur.charttime <  wd.endtime
order by icustay_id, charttime
  );",109348,Thread-1,2022-07-18T00:11:37.760098Z
E017,,debug,SQL status: SELECT 3361794 in 384.6 seconds,109348,Thread-1,2022-07-18T00:18:02.356403Z
E015,,debug,"Using postgres connection ""model.mimic.kdigo_uo""",109348,Thread-1,2022-07-18T00:18:02.364867Z
E016,,debug,"On model.mimic.kdigo_uo: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.kdigo_uo""} */
alter table ""postgres"".""public"".""kdigo_uo"" rename to ""kdigo_uo__dbt_backup""",109348,Thread-1,2022-07-18T00:18:02.365311Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:02.368891Z
E015,,debug,"Using postgres connection ""model.mimic.kdigo_uo""",109348,Thread-1,2022-07-18T00:18:02.372814Z
E016,,debug,"On model.mimic.kdigo_uo: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.kdigo_uo""} */
alter table ""postgres"".""public"".""kdigo_uo__dbt_tmp"" rename to ""kdigo_uo""",109348,Thread-1,2022-07-18T00:18:02.373037Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:02.374134Z
E018,,debug,On model.mimic.kdigo_uo: COMMIT,109348,Thread-1,2022-07-18T00:18:02.377770Z
E015,,debug,"Using postgres connection ""model.mimic.kdigo_uo""",109348,Thread-1,2022-07-18T00:18:02.378069Z
E016,,debug,On model.mimic.kdigo_uo: COMMIT,109348,Thread-1,2022-07-18T00:18:02.378270Z
E017,,debug,SQL status: COMMIT in 0.01 seconds,109348,Thread-1,2022-07-18T00:18:02.392717Z
E015,,debug,"Using postgres connection ""model.mimic.kdigo_uo""",109348,Thread-1,2022-07-18T00:18:02.395704Z
E016,,debug,"On model.mimic.kdigo_uo: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.kdigo_uo""} */
drop table if exists ""postgres"".""public"".""kdigo_uo__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:18:02.396009Z
E017,,debug,SQL status: DROP TABLE in 0.01 seconds,109348,Thread-1,2022-07-18T00:18:02.406030Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:18:02.409067Z
E010,,debug,On model.mimic.kdigo_uo: Close,109348,Thread-1,2022-07-18T00:18:02.409308Z
Q012,384,info,95 of 107 OK created table model public.kdigo_uo ............................... [[32mSELECT 3361794[0m in 384.67s],109348,Thread-1,2022-07-18T00:18:02.410424Z,table,null,kdigo_uo,organfailure/kdigo_uo.sql,2022-07-18T00:11:37.735094,compiling,model,,,
Q024,384.67369198799133,debug,Finished running node model.mimic.kdigo_uo,109348,Thread-1,2022-07-18T00:18:02.411164Z,table,2022-07-18T00:18:02.410948,kdigo_uo,organfailure/kdigo_uo.sql,2022-07-18T00:11:37.735094,success,model,,,
Q023,,debug,Began running node model.mimic.norepinephrine_dose,109348,Thread-1,2022-07-18T00:18:02.411878Z,table,null,norepinephrine_dose,durations/norepinephrine_dose.sql,2022-07-18T00:18:02.411734,started,model,,,
Q033,,info,96 of 107 START table model public.norepinephrine_dose ......................... [RUN],109348,Thread-1,2022-07-18T00:18:02.412704Z,table,null,norepinephrine_dose,durations/norepinephrine_dose.sql,2022-07-18T00:18:02.411734,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.norepinephrine_dose""",109348,Thread-1,2022-07-18T00:18:02.414036Z
Q030,,debug,Began compiling node model.mimic.norepinephrine_dose,109348,Thread-1,2022-07-18T00:18:02.414676Z,table,null,norepinephrine_dose,durations/norepinephrine_dose.sql,2022-07-18T00:18:02.411734,compiling,model,,,
Q027,,debug,Compiling model.mimic.norepinephrine_dose,109348,Thread-1,2022-07-18T00:18:02.415073Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.norepinephrine_dose""",109348,Thread-1,2022-07-18T00:18:02.418345Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:18:02.419186Z
Q031,,debug,Began executing node model.mimic.norepinephrine_dose,109348,Thread-1,2022-07-18T00:18:02.419691Z,table,null,norepinephrine_dose,durations/norepinephrine_dose.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.norepinephrine_dose""",109348,Thread-1,2022-07-18T00:18:02.430109Z
E015,,debug,"Using postgres connection ""model.mimic.norepinephrine_dose""",109348,Thread-1,2022-07-18T00:18:02.430879Z
E016,,debug,On model.mimic.norepinephrine_dose: BEGIN,109348,Thread-1,2022-07-18T00:18:02.431149Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:18:02.431269Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:18:02.436420Z
E015,,debug,"Using postgres connection ""model.mimic.norepinephrine_dose""",109348,Thread-1,2022-07-18T00:18:02.436688Z
E016,,debug,"On model.mimic.norepinephrine_dose: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.norepinephrine_dose""} */


  create  table ""postgres"".""public"".""norepinephrine_dose__dbt_tmp""
  as (
    -- This query extracts dose+durations of norepinephrine administration
-- Total time on the drug can be calculated from this table by grouping using ICUSTAY_ID

-- Get drug administration data from CareVue first
with vasocv1 as
(
  select
    cv.icustay_id, cv.charttime
    -- case statement determining whether the ITEMID is an instance of vasopressor usage
    , max(case when itemid in (30047,30120) then 1 else 0 end) as vaso -- norepinephrine

    -- the 'stopped' column indicates if a vasopressor has been disconnected
    , max(case when itemid in (30047,30120) and (stopped = 'Stopped' OR stopped like 'D/C%') then 1
          else 0 end) as vaso_stopped

  -- case statement determining whether the ITEMID is an instance of vasopressor usage

    , max(case when itemid in (30047,30120) and rate is not null then 1 else 0 end) as vaso_null
    , max(case
            when itemid = 30047 and wd.weight is null then rate / 80.0 -- this is rare, only affects a total of ~400 rows
            when itemid = 30047 then rate / wd.weight -- measured in mcgmin
            when itemid = 30120 then rate -- measured in mcgkgmin ** there are clear errors, perhaps actually mcgmin
          else null end) as vaso_rate
    , max(case when itemid in (30047,30120) then amount else null end) as vaso_amount

  FROM inputevents_cv cv
  left join ""postgres"".""public"".""weight_durations"" wd
    on cv.icustay_id = wd.icustay_id
    and cv.charttime between wd.starttime and wd.endtime
  where itemid in (30047,30120) -- norepinephrine
  and cv.icustay_id is not null
  group by cv.icustay_id, cv.charttime
)
, vasocv2 as
(
  select v.*
    , sum(vaso_null) over (partition by icustay_id order by charttime) as vaso_partition
  from
    vasocv1 v
)
, vasocv3 as
(
  select v.*
    , first_value(vaso_rate) over (partition by icustay_id, vaso_partition order by charttime) as vaso_prevrate_ifnull
  from
    vasocv2 v
)
, vasocv4 as
(
select
    icustay_id
    , charttime
    -- , (CHARTTIME - (LAG(CHARTTIME, 1) OVER (partition by icustay_id, vaso order by charttime))) AS delta

    , vaso
    , vaso_rate
    , vaso_amount
    , vaso_stopped
    , vaso_prevrate_ifnull

    -- We define start time here
    , case
        when vaso = 0 then null

        -- if this is the first instance of the vasoactive drug
        when vaso_rate > 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso, vaso_null
          order by charttime
          )
          is null
          then 1

        -- you often get a string of 0s
        -- we decide not to set these as 1, just because it makes vasonum sequential
        when vaso_rate = 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 0
          then 0

        -- sometimes you get a string of NULL, associated with 0 volumes
        -- same reason as before, we decide not to set these as 1
        -- vaso_prevrate_ifnull is equal to the previous value *iff* the current value is null
        when vaso_prevrate_ifnull = 0 and
          LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 0
          then 0

        -- If the last recorded rate was 0, newvaso = 1
        when LAG(vaso_prevrate_ifnull,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          ) = 0
          then 1

        -- If the last recorded vaso was D/C'd, newvaso = 1
        when
          LAG(vaso_stopped,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          )
          = 1 then 1

        -- ** not sure if the below is needed
        --when (CHARTTIME - (LAG(CHARTTIME, 1) OVER (partition by icustay_id, vaso order by charttime))) > (interval '4 hours') then 1
      else null
      end as vaso_start

FROM
  vasocv3
)
-- propagate start/stop flags forward in time
, vasocv5 as
(
  select v.*
    , SUM(vaso_start) OVER (partition by icustay_id, vaso order by charttime) as vaso_first
FROM
  vasocv4 v
)
, vasocv6 as
(
  select v.*
    -- We define end time here
    , case
        when vaso = 0
          then null

        -- If the recorded vaso was D/C'd, this is an end time
        when vaso_stopped = 1
          then vaso_first

        -- If the rate is zero, this is the end time
        when vaso_rate = 0
          then vaso_first

        -- the last row in the table is always a potential end time
        -- this captures patients who die/are discharged while on vasopressors
        -- in principle, this could add an extra end time for the vasopressor
        -- however, since we later group on vaso_start, any extra end times are ignored
        when LEAD(CHARTTIME,1)
          OVER
          (
          partition by icustay_id, vaso
          order by charttime
          ) is null
          then vaso_first

        else null
        end as vaso_stop
    from vasocv5 v
)

-- -- if you want to look at the results of the table before grouping:
-- select
--   icustay_id, charttime, vaso, vaso_rate, vaso_amount
--     , vaso_stopped
--     , vaso_start
--     , vaso_first
--     , vaso_stop
-- from vasocv6 order by icustay_id, charttime

, vasocv7 as
(
select
  icustay_id
  , charttime as starttime
  , lead(charttime) OVER (partition by icustay_id, vaso_first order by charttime) as endtime
  , vaso, vaso_rate, vaso_amount, vaso_stop, vaso_start, vaso_first
from vasocv6
where
  vaso_first is not null -- bogus data
and
  vaso_first != 0 -- sometimes *only* a rate of 0 appears, i.e. the drug is never actually delivered
and
  icustay_id is not null -- there are data for ""floating"" admissions, we don't worry about these
)
-- table of start/stop times for event
, vasocv8 as
(
  select
    icustay_id
    , starttime, endtime
    , vaso, vaso_rate, vaso_amount, vaso_stop, vaso_start, vaso_first
  from vasocv7
  where endtime is not null
  and vaso_rate > 0
  and starttime != endtime
)
-- collapse these start/stop times down if the rate doesn't change
, vasocv9 as
(
  select
    icustay_id
    , starttime, endtime
    , case
        when LAG(endtime) OVER (partition by icustay_id order by starttime, endtime) = starttime
        AND  LAG(vaso_rate) OVER (partition by icustay_id order by starttime, endtime) = vaso_rate
        THEN 0
      else 1
    end as vaso_groups
    , vaso, vaso_rate, vaso_amount, vaso_stop, vaso_start, vaso_first
  from vasocv8
  where endtime is not null
  and vaso_rate > 0
  and starttime != endtime
)
, vasocv10 as
(
  select
    icustay_id
    , starttime, endtime
    , vaso_groups
    , SUM(vaso_groups) OVER (partition by icustay_id order by starttime, endtime) as vaso_groups_sum
    , vaso, vaso_rate, vaso_amount, vaso_stop, vaso_start, vaso_first
  from vasocv9
)
, vasocv as
(
  select icustay_id
  , min(starttime) as starttime
  , max(endtime) as endtime
  , vaso_groups_sum
  , vaso_rate
  , sum(vaso_amount) as vaso_amount
  from vasocv10
  group by icustay_id, vaso_groups_sum, vaso_rate
)
-- now we extract the associated data for metavision patients
, vasomv as
(
  select
    icustay_id, linkorderid
    , rate as vaso_rate
    , amount as vaso_amount
    , starttime
    , endtime
  from inputevents_mv
  where itemid = 221906 -- norepinephrine
  and statusdescription != 'Rewritten' -- only valid orders
)
-- now assign this data to every hour of the patient's stay
-- vaso_amount for carevue is not accurate
SELECT icustay_id
  , starttime, endtime
  , vaso_rate, vaso_amount
from vasocv
UNION ALL
SELECT icustay_id
  , starttime, endtime
  , vaso_rate, vaso_amount
from vasomv
order by icustay_id, starttime
  );",109348,Thread-1,2022-07-18T00:18:02.436805Z
E017,,debug,SQL status: SELECT 161449 in 9.0 seconds,109348,Thread-1,2022-07-18T00:18:11.434004Z
E015,,debug,"Using postgres connection ""model.mimic.norepinephrine_dose""",109348,Thread-1,2022-07-18T00:18:11.439900Z
E016,,debug,"On model.mimic.norepinephrine_dose: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.norepinephrine_dose""} */
alter table ""postgres"".""public"".""norepinephrine_dose"" rename to ""norepinephrine_dose__dbt_backup""",109348,Thread-1,2022-07-18T00:18:11.440135Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:11.441150Z
E015,,debug,"Using postgres connection ""model.mimic.norepinephrine_dose""",109348,Thread-1,2022-07-18T00:18:11.444608Z
E016,,debug,"On model.mimic.norepinephrine_dose: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.norepinephrine_dose""} */
alter table ""postgres"".""public"".""norepinephrine_dose__dbt_tmp"" rename to ""norepinephrine_dose""",109348,Thread-1,2022-07-18T00:18:11.444823Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:11.445554Z
E018,,debug,On model.mimic.norepinephrine_dose: COMMIT,109348,Thread-1,2022-07-18T00:18:11.448869Z
E015,,debug,"Using postgres connection ""model.mimic.norepinephrine_dose""",109348,Thread-1,2022-07-18T00:18:11.449093Z
E016,,debug,On model.mimic.norepinephrine_dose: COMMIT,109348,Thread-1,2022-07-18T00:18:11.449214Z
E017,,debug,SQL status: COMMIT in 0.02 seconds,109348,Thread-1,2022-07-18T00:18:11.464550Z
E015,,debug,"Using postgres connection ""model.mimic.norepinephrine_dose""",109348,Thread-1,2022-07-18T00:18:11.467804Z
E016,,debug,"On model.mimic.norepinephrine_dose: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.norepinephrine_dose""} */
drop table if exists ""postgres"".""public"".""norepinephrine_dose__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:18:11.468221Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:11.471717Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:18:11.476052Z
E010,,debug,On model.mimic.norepinephrine_dose: Close,109348,Thread-1,2022-07-18T00:18:11.476336Z
Q012,9,info,96 of 107 OK created table model public.norepinephrine_dose .................... [[32mSELECT 161449[0m in 9.06s],109348,Thread-1,2022-07-18T00:18:11.477195Z,table,null,norepinephrine_dose,durations/norepinephrine_dose.sql,2022-07-18T00:18:02.411734,compiling,model,,,
Q024,9.06357455253601,debug,Finished running node model.mimic.norepinephrine_dose,109348,Thread-1,2022-07-18T00:18:11.477832Z,table,2022-07-18T00:18:11.477572,norepinephrine_dose,durations/norepinephrine_dose.sql,2022-07-18T00:18:02.411734,success,model,,,
Q023,,debug,Began running node model.mimic.lods,109348,Thread-1,2022-07-18T00:18:11.478382Z,table,null,lods,severityscores/lods.sql,2022-07-18T00:18:11.478297,started,model,,,
Q033,,info,97 of 107 START table model public.lods ........................................ [RUN],109348,Thread-1,2022-07-18T00:18:11.479105Z,table,null,lods,severityscores/lods.sql,2022-07-18T00:18:11.478297,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.lods""",109348,Thread-1,2022-07-18T00:18:11.479913Z
Q030,,debug,Began compiling node model.mimic.lods,109348,Thread-1,2022-07-18T00:18:11.480310Z,table,null,lods,severityscores/lods.sql,2022-07-18T00:18:11.478297,compiling,model,,,
Q027,,debug,Compiling model.mimic.lods,109348,Thread-1,2022-07-18T00:18:11.480736Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.lods""",109348,Thread-1,2022-07-18T00:18:11.486836Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:18:11.488176Z
Q031,,debug,Began executing node model.mimic.lods,109348,Thread-1,2022-07-18T00:18:11.488844Z,table,null,lods,severityscores/lods.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.lods""",109348,Thread-1,2022-07-18T00:18:11.503997Z
E015,,debug,"Using postgres connection ""model.mimic.lods""",109348,Thread-1,2022-07-18T00:18:11.505465Z
E016,,debug,On model.mimic.lods: BEGIN,109348,Thread-1,2022-07-18T00:18:11.506245Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:18:11.507118Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:18:11.513331Z
E015,,debug,"Using postgres connection ""model.mimic.lods""",109348,Thread-1,2022-07-18T00:18:11.514152Z
E016,,debug,"On model.mimic.lods: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.lods""} */


  create  table ""postgres"".""public"".""lods__dbt_tmp""
  as (
    -- ------------------------------------------------------------------
-- Title: Logistic Organ Dysfunction Score (LODS)
-- This query extracts the logistic organ dysfunction system.
-- This score is a measure of organ failure in a patient.
-- The score is calculated on the first day of each ICU patients' stay.
-- ------------------------------------------------------------------

-- Reference for LODS:
--  Le Gall, J. R., Klar, J., Lemeshow, S., Saulnier, F., Alberti, C., Artigas, A., & Teres, D.
--  The Logistic Organ Dysfunction system: a new way to assess organ dysfunction in the intensive care unit.
--  JAMA 276.10 (1996): 802-810.

-- Variables used in LODS:
--  GCS
--  VITALS: Heart rate, systolic blood pressure
--  FLAGS: ventilation/cpap
--  IO: urine output
--  LABS: blood urea nitrogen, WBC, bilirubin, creatinine, prothrombin time (PT), platelets
--  ABG: PaO2 with associated FiO2

-- The following views are required to run this query:
--  1) urine_output_first_day - generated by urine-output-first-day.sql
--  2) ventilation_durations - generated by ventilation_durations.sql
--  3) vitals_first_day - generated by vitals-first-day.sql
--  4) gcs_first_day - generated by gcs-first-day.sql
--  5) labs_first_day - generated by labs-first-day.sql
--  5) blood_gas_first_day_arterial - generated by blood-gas-first-day-arterial.sql

-- Note:
--  The score is calculated for *all* ICU patients, with the assumption that the user will subselect appropriate ICUSTAY_IDs.
--  For example, the score is calculated for neonates, but it is likely inappropriate to actually use the score values for these patients.

-- extract CPAP from the ""Oxygen Delivery Device"" fields
with cpap as
(
  select ie.icustay_id
    , min(DATETIME_SUB(charttime, INTERVAL '1' HOUR)) as starttime
    , max(DATETIME_ADD(charttime, INTERVAL '4' HOUR)) as endtime
    , max(CASE
          WHEN lower(ce.value) LIKE '%cpap%' THEN 1
          WHEN lower(ce.value) LIKE '%bipap mask%' THEN 1
        else 0 end) as cpap
  FROM icustays ie
  inner join chartevents ce
    on ie.icustay_id = ce.icustay_id
    and ce.charttime between ie.intime and DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
  where itemid in
  (
    -- TODO: when metavision data import fixed, check the values in 226732 match the value clause below
    467, 469, 226732
  )
  and (lower(ce.value) LIKE '%cpap%' or lower(ce.value) LIKE '%bipap mask%')
  -- exclude rows marked as error
  AND (ce.error IS NULL OR ce.error = 0)
  group by ie.icustay_id
)
, pafi1 as
(
  -- join blood gas to ventilation durations to determine if patient was vent
  -- also join to cpap table for the same purpose
  select bg.icustay_id, bg.charttime
  , pao2fio2
  , case when vd.icustay_id is not null then 1 else 0 end as vent
  , case when cp.icustay_id is not null then 1 else 0 end as cpap
  from ""postgres"".""public"".""blood_gas_first_day_arterial"" bg
  left join ""postgres"".""public"".""ventilation_durations"" vd
    on bg.icustay_id = vd.icustay_id
    and bg.charttime >= vd.starttime
    and bg.charttime <= vd.endtime
  left join cpap cp
    on bg.icustay_id = cp.icustay_id
    and bg.charttime >= cp.starttime
    and bg.charttime <= cp.endtime
)
, pafi2 as
(
  -- get the minimum PaO2/FiO2 ratio *only for ventilated/cpap patients*
  select icustay_id
  , min(pao2fio2) as pao2fio2_vent_min
  from pafi1
  where vent = 1 or cpap = 1
  group by icustay_id
)
, cohort as
(
select  ie.subject_id
      , ie.hadm_id
      , ie.icustay_id
      , ie.intime
      , ie.outtime

      , gcs.mingcs
      , vital.heartrate_max
      , vital.heartrate_min
      , vital.sysbp_max
      , vital.sysbp_min

      -- this value is non-null iff the patient is on vent/cpap
      , pf.pao2fio2_vent_min

      , labs.bun_max
      , labs.bun_min
      , labs.wbc_max
      , labs.wbc_min
      , labs.bilirubin_max
      , labs.creatinine_max
      , labs.pt_min
      , labs.pt_max
      , labs.platelet_min

      , uo.urineoutput

FROM icustays ie
inner join admissions adm
  on ie.hadm_id = adm.hadm_id
inner join patients pat
  on ie.subject_id = pat.subject_id

-- join to above view to get pao2/fio2 ratio
left join pafi2 pf
  on ie.icustay_id = pf.icustay_id

-- join to custom tables to get more data....
left join ""postgres"".""public"".""gcs_first_day"" gcs
  on ie.icustay_id = gcs.icustay_id
left join ""postgres"".""public"".""vitals_first_day"" vital
  on ie.icustay_id = vital.icustay_id
left join ""postgres"".""public"".""urine_output_first_day"" uo
  on ie.icustay_id = uo.icustay_id
left join ""postgres"".""public"".""labs_first_day"" labs
  on ie.icustay_id = labs.icustay_id
)
, scorecomp as
(
select
  cohort.*
  -- Below code calculates the component scores needed for SAPS

  -- neurologic
  , case
    when mingcs is null then null
      when mingcs <  3 then null -- erroneous value/on trach
      when mingcs <=  5 then 5
      when mingcs <=  8 then 3
      when mingcs <= 13 then 1
    else 0
  end as neurologic

  -- cardiovascular
  , case
      when heartrate_max is null
      and sysbp_min is null then null
      when heartrate_min < 30 then 5
      when sysbp_min < 40 then 5
      when sysbp_min <  70 then 3
      when sysbp_max >= 270 then 3
      when heartrate_max >= 140 then 1
      when sysbp_max >= 240 then 1
      when sysbp_min < 90 then 1
    else 0
  end as cardiovascular

  -- renal
  , case
      when bun_max is null
        or urineoutput is null
        or creatinine_max is null
        then null
      when urineoutput <   500.0 then 5
      when bun_max >= 56.0 then 5
      when creatinine_max >= 1.60 then 3
      when urineoutput <   750.0 then 3
      when bun_max >= 28.0 then 3
      when urineoutput >= 10000.0 then 3
      when creatinine_max >= 1.20 then 1
      when bun_max >= 17.0 then 1
      when bun_max >= 7.50 then 1
    else 0
  end as renal

  -- pulmonary
  , case
      when pao2fio2_vent_min is null then 0
      when pao2fio2_vent_min >= 150 then 1
      when pao2fio2_vent_min < 150 then 3
    else null
  end as pulmonary

  -- hematologic
  , case
      when wbc_max is null
        and platelet_min is null
          then null
      when wbc_min <   1.0 then 3
      when wbc_min <   2.5 then 1
      when platelet_min < 50.0 then 1
      when wbc_max >= 50.0 then 1
    else 0
  end as hematologic

  -- hepatic
  -- We have defined the ""standard"" PT as 12 seconds.
  -- This is an assumption and subsequent analyses may be affected by this assumption.
  , case
      when pt_max is null
        and bilirubin_max is null
          then null
      when bilirubin_max >= 2.0 then 1
      when pt_max > (12+3) then 1
      when pt_min < (12*0.25) then 1
    else 0
  end as hepatic

from cohort
)
select ie.subject_id, ie.hadm_id, ie.icustay_id
-- coalesce statements impute normal score of zero if data element is missing
, coalesce(neurologic,0)
+ coalesce(cardiovascular,0)
+ coalesce(renal,0)
+ coalesce(pulmonary,0)
+ coalesce(hematologic,0)
+ coalesce(hepatic,0)
  as LODS
, neurologic
, cardiovascular
, renal
, pulmonary
, hematologic
, hepatic
FROM icustays ie
left join scorecomp s
  on ie.icustay_id = s.icustay_id
order by ie.icustay_id
  );",109348,Thread-1,2022-07-18T00:18:11.514441Z
E017,,debug,SQL status: SELECT 61532 in 0.31 seconds,109348,Thread-1,2022-07-18T00:18:11.823745Z
E015,,debug,"Using postgres connection ""model.mimic.lods""",109348,Thread-1,2022-07-18T00:18:11.829220Z
E016,,debug,"On model.mimic.lods: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.lods""} */
alter table ""postgres"".""public"".""lods"" rename to ""lods__dbt_backup""",109348,Thread-1,2022-07-18T00:18:11.829637Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:11.830938Z
E015,,debug,"Using postgres connection ""model.mimic.lods""",109348,Thread-1,2022-07-18T00:18:11.835997Z
E016,,debug,"On model.mimic.lods: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.lods""} */
alter table ""postgres"".""public"".""lods__dbt_tmp"" rename to ""lods""",109348,Thread-1,2022-07-18T00:18:11.836228Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:11.837076Z
E018,,debug,On model.mimic.lods: COMMIT,109348,Thread-1,2022-07-18T00:18:11.840033Z
E015,,debug,"Using postgres connection ""model.mimic.lods""",109348,Thread-1,2022-07-18T00:18:11.840252Z
E016,,debug,On model.mimic.lods: COMMIT,109348,Thread-1,2022-07-18T00:18:11.840539Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:11.843739Z
E015,,debug,"Using postgres connection ""model.mimic.lods""",109348,Thread-1,2022-07-18T00:18:11.846176Z
E016,,debug,"On model.mimic.lods: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.lods""} */
drop table if exists ""postgres"".""public"".""lods__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:18:11.846417Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:11.848535Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:18:11.851684Z
E010,,debug,On model.mimic.lods: Close,109348,Thread-1,2022-07-18T00:18:11.851938Z
Q012,0,info,97 of 107 OK created table model public.lods ................................... [[32mSELECT 61532[0m in 0.37s],109348,Thread-1,2022-07-18T00:18:11.852832Z,table,null,lods,severityscores/lods.sql,2022-07-18T00:18:11.478297,compiling,model,,,
Q024,0.37303638458251953,debug,Finished running node model.mimic.lods,109348,Thread-1,2022-07-18T00:18:11.853496Z,table,2022-07-18T00:18:11.853300,lods,severityscores/lods.sql,2022-07-18T00:18:11.478297,success,model,,,
Q023,,debug,Began running node model.mimic.mlods,109348,Thread-1,2022-07-18T00:18:11.854213Z,table,null,mlods,severityscores/mlods.sql,2022-07-18T00:18:11.854112,started,model,,,
Q033,,info,98 of 107 START table model public.mlods ....................................... [RUN],109348,Thread-1,2022-07-18T00:18:11.854967Z,table,null,mlods,severityscores/mlods.sql,2022-07-18T00:18:11.854112,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.mlods""",109348,Thread-1,2022-07-18T00:18:11.856056Z
Q030,,debug,Began compiling node model.mimic.mlods,109348,Thread-1,2022-07-18T00:18:11.856364Z,table,null,mlods,severityscores/mlods.sql,2022-07-18T00:18:11.854112,compiling,model,,,
Q027,,debug,Compiling model.mimic.mlods,109348,Thread-1,2022-07-18T00:18:11.856677Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.mlods""",109348,Thread-1,2022-07-18T00:18:11.861054Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:18:11.861788Z
Q031,,debug,Began executing node model.mimic.mlods,109348,Thread-1,2022-07-18T00:18:11.862087Z,table,null,mlods,severityscores/mlods.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.mlods""",109348,Thread-1,2022-07-18T00:18:11.871493Z
E015,,debug,"Using postgres connection ""model.mimic.mlods""",109348,Thread-1,2022-07-18T00:18:11.872393Z
E016,,debug,On model.mimic.mlods: BEGIN,109348,Thread-1,2022-07-18T00:18:11.872713Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:18:11.872991Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:18:11.879231Z
E015,,debug,"Using postgres connection ""model.mimic.mlods""",109348,Thread-1,2022-07-18T00:18:11.879694Z
E016,,debug,"On model.mimic.mlods: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.mlods""} */


  create  table ""postgres"".""public"".""mlods__dbt_tmp""
  as (
    -- ------------------------------------------------------------------
-- Title: Modified Logistic organ dysfunction system (mLODS)
-- This query extracts a modified version of the logistic organ dysfunction system.
-- This score was used in the third international definition of sepsis: Sepsis-3.
-- This score is a measure of organ failure in a patient.
-- ------------------------------------------------------------------

-- Reference for LODS:
--  Le Gall, J. R., Klar, J., Lemeshow, S., Saulnier, F., Alberti, C., Artigas, A., & Teres, D.
--  The Logistic Organ Dysfunction system: a new way to assess organ dysfunction in the intensive care unit.
--  JAMA 276.10 (1996): 802-810.

-- Reference for modified LODS:
--  Le Gall, J. R., Klar, J., Lemeshow, S., Saulnier, F., Alberti, C., Artigas, A., & Teres, D.
--  The Logistic Organ Dysfunction system: a new way to assess organ dysfunction in the intensive care unit.
--  JAMA 276.10 (1996): 802-810.

-- Variables used in mLODS:
--  GCS
--  VITALS: Heart rate, systolic blood pressure
--  FLAGS: ventilation/cpap
--  LABS: WBC, bilirubin, creatinine, platelets
--  ABG: PaO2 with associated FiO2

-- Variables *excluded*, that are used in the original LODS:
--  prothrombin time (PT), blood urea nitrogen, urine output

-- Note:
--  The score is calculated for *all* ICU patients, with the assumption that the user will subselect appropriate ICUSTAY_IDs.
--  For example, the score is calculated for neonates, but it is likely inappropriate to actually use the score values for these patients.

-- extract CPAP from the ""Oxygen Delivery Device"" fields
with cpap as
(
  select ie.icustay_id
    , min(DATETIME_SUB(charttime, INTERVAL '1' HOUR)) as starttime
    , max(DATETIME_ADD(charttime, INTERVAL '4' HOUR)) as endtime
    , max(CASE
          WHEN lower(ce.value) LIKE '%cpap%' THEN 1
          WHEN lower(ce.value) LIKE '%bipap mask%' THEN 1
        else 0 end) as cpap
  FROM icustays ie
  inner join chartevents ce
    on ie.icustay_id = ce.icustay_id
    and ce.charttime between ie.intime and ie.outtime
  where itemid in
  (
    -- TODO: when metavision data import fixed, check the values in 226732 match the value clause below
    467, 469, 226732
  )
  and (lower(ce.value) LIKE '%cpap%' or lower(ce.value) LIKE '%bipap mask%')
  -- exclude rows marked as error
  AND (ce.error IS NULL OR ce.error = 0)
  group by ie.icustay_id
)
, pafi1 as
(
  -- join blood gas to ventilation durations to determine if patient was vent
  -- also join to cpap table for the same purpose
  select bg.icustay_id, bg.charttime
  , PaO2FiO2
  , case when vd.icustay_id is not null then 1 else 0 end as vent
  , case when cp.icustay_id is not null then 1 else 0 end as cpap
  from ""postgres"".""public"".""blood_gas_first_day_arterial"" bg
  left join ""postgres"".""public"".""ventilation_durations"" vd
    on bg.icustay_id = vd.icustay_id
    and bg.charttime >= vd.starttime
    and bg.charttime <= vd.endtime
  left join cpap cp
    on bg.icustay_id = cp.icustay_id
    and bg.charttime >= cp.starttime
    and bg.charttime <= cp.endtime
)
, pafi2 as
(
  -- get the minimum PaO2/FiO2 ratio *only for ventilated/cpap patients*
  select icustay_id
  , min(PaO2FiO2) as PaO2FiO2_vent_min
  from pafi1
  where vent = 1 or cpap = 1
  group by icustay_id
)
, cohort as
(
select  ie.subject_id
      , ie.hadm_id
      , ie.icustay_id
      , ie.intime
      , ie.outtime

      , gcs.mingcs
      , vital.heartrate_max
      , vital.heartrate_min
      , vital.sysbp_max
      , vital.sysbp_min

      -- this value is non-null iff the patient is on vent/cpap
      , pf.PaO2FiO2_vent_min

      , labs.wbc_max
      , labs.wbc_min
      , labs.bilirubin_max
      , labs.creatinine_max
      , labs.platelet_min

FROM icustays ie
inner join admissions adm
  on ie.hadm_id = adm.hadm_id
inner join patients pat
  on ie.subject_id = pat.subject_id

-- join to above view to get pao2/fio2 ratio
left join pafi2 pf
  on ie.icustay_id = pf.icustay_id

-- join to custom tables to get more data....
left join ""postgres"".""public"".""gcs_first_day"" gcs
  on ie.icustay_id = gcs.icustay_id
left join ""postgres"".""public"".""vitals_first_day"" vital
  on ie.icustay_id = vital.icustay_id
left join ""postgres"".""public"".""labs_first_day"" labs
  on ie.icustay_id = labs.icustay_id
)
, scorecomp as
(
select
  cohort.*

  -- neurologic
  , case
    when mingcs is null then null
      when mingcs <  3 then null -- erroneous value/on trach
      when mingcs <=  5 then 5
      when mingcs <=  8 then 3
      when mingcs <= 13 then 1
    else 0
  end as neurologic

  -- cardiovascular
  , case
      when heartrate_max is null
      and sysbp_min is null then null
      when heartrate_min < 30 then 5
      when sysbp_min < 40 then 5
      when sysbp_min <  70 then 3
      when sysbp_max >= 270 then 3
      when heartrate_max >= 140 then 1
      when sysbp_max >= 240 then 1
      when sysbp_min < 90 then 1
    else 0
  end as cardiovascular

  -- renal
  , case
      when creatinine_max is null
        -- or UrineOutput is null
        -- or bun_max is null
        then null
      -- when UrineOutput <   500.0 then 5
      -- when bun_max >= 56.0 then 5
      when creatinine_max >= 1.60 then 3
      -- when UrineOutput <   750.0 then 3
      -- when bun_max >= 28.0 then 3
      -- when UrineOutput >= 10000.0 then 3
      when creatinine_max >= 1.20 then 1
      -- when bun_max >= 17.0 then 1
      -- when bun_max >= 7.50 then 1
    else 0
  end as renal

  -- pulmonary
  , case
      when PaO2FiO2_vent_min is null then 0
      when PaO2FiO2_vent_min >= 150 then 1
      when PaO2FiO2_vent_min < 150 then 3
    else null
  end as pulmonary

  -- hematologic
  , case
      when wbc_max is null
        and platelet_min is null
          then null
      when wbc_min <   1.0 then 3
      when wbc_min <   2.5 then 1
      when platelet_min < 50.0 then 1
      when wbc_max >= 50.0 then 1
    else 0
  end as hematologic

  -- hepatic
  , case
      when bilirubin_max is null
        -- and pt_max is null
          then null
      when bilirubin_max >= 2.0 then 1
      -- when pt_max > (12+3) then 1
      -- when pt_min < (12*0.25) then 1
    else 0
  end as hepatic

from cohort
)
select ie.icustay_id
-- coalesce statements impute normal score of zero if data element is missing
, coalesce(neurologic,0)
+ coalesce(cardiovascular,0)
+ coalesce(renal,0)
+ coalesce(pulmonary,0)
+ coalesce(hematologic,0)
+ coalesce(hepatic,0)
  as mLODS
, neurologic
, cardiovascular
, renal
, pulmonary
, hematologic
, hepatic
FROM icustays ie
left join scorecomp s
  on ie.icustay_id = s.icustay_id
order by ie.icustay_id
  );",109348,Thread-1,2022-07-18T00:18:11.880176Z
E017,,debug,SQL status: SELECT 61532 in 0.24 seconds,109348,Thread-1,2022-07-18T00:18:12.121089Z
E015,,debug,"Using postgres connection ""model.mimic.mlods""",109348,Thread-1,2022-07-18T00:18:12.125484Z
E016,,debug,"On model.mimic.mlods: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.mlods""} */
alter table ""postgres"".""public"".""mlods"" rename to ""mlods__dbt_backup""",109348,Thread-1,2022-07-18T00:18:12.125798Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:12.126566Z
E015,,debug,"Using postgres connection ""model.mimic.mlods""",109348,Thread-1,2022-07-18T00:18:12.130386Z
E016,,debug,"On model.mimic.mlods: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.mlods""} */
alter table ""postgres"".""public"".""mlods__dbt_tmp"" rename to ""mlods""",109348,Thread-1,2022-07-18T00:18:12.130626Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:12.131329Z
E018,,debug,On model.mimic.mlods: COMMIT,109348,Thread-1,2022-07-18T00:18:12.134409Z
E015,,debug,"Using postgres connection ""model.mimic.mlods""",109348,Thread-1,2022-07-18T00:18:12.134650Z
E016,,debug,On model.mimic.mlods: COMMIT,109348,Thread-1,2022-07-18T00:18:12.134863Z
E017,,debug,SQL status: COMMIT in 0.01 seconds,109348,Thread-1,2022-07-18T00:18:12.141421Z
E015,,debug,"Using postgres connection ""model.mimic.mlods""",109348,Thread-1,2022-07-18T00:18:12.143759Z
E016,,debug,"On model.mimic.mlods: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.mlods""} */
drop table if exists ""postgres"".""public"".""mlods__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:18:12.143973Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:12.146123Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:18:12.148714Z
E010,,debug,On model.mimic.mlods: Close,109348,Thread-1,2022-07-18T00:18:12.149057Z
Q012,0,info,98 of 107 OK created table model public.mlods .................................. [[32mSELECT 61532[0m in 0.29s],109348,Thread-1,2022-07-18T00:18:12.149817Z,table,null,mlods,severityscores/mlods.sql,2022-07-18T00:18:11.854112,compiling,model,,,
Q024,0.293870210647583,debug,Finished running node model.mimic.mlods,109348,Thread-1,2022-07-18T00:18:12.150511Z,table,2022-07-18T00:18:12.150327,mlods,severityscores/mlods.sql,2022-07-18T00:18:11.854112,success,model,,,
Q023,,debug,Began running node model.mimic.sapsii,109348,Thread-1,2022-07-18T00:18:12.151044Z,table,null,sapsii,severityscores/sapsii.sql,2022-07-18T00:18:12.150952,started,model,,,
Q033,,info,99 of 107 START table model public.sapsii ...................................... [RUN],109348,Thread-1,2022-07-18T00:18:12.151743Z,table,null,sapsii,severityscores/sapsii.sql,2022-07-18T00:18:12.150952,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.sapsii""",109348,Thread-1,2022-07-18T00:18:12.152514Z
Q030,,debug,Began compiling node model.mimic.sapsii,109348,Thread-1,2022-07-18T00:18:12.152848Z,table,null,sapsii,severityscores/sapsii.sql,2022-07-18T00:18:12.150952,compiling,model,,,
Q027,,debug,Compiling model.mimic.sapsii,109348,Thread-1,2022-07-18T00:18:12.153250Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.sapsii""",109348,Thread-1,2022-07-18T00:18:12.159922Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:18:12.160777Z
Q031,,debug,Began executing node model.mimic.sapsii,109348,Thread-1,2022-07-18T00:18:12.161100Z,table,null,sapsii,severityscores/sapsii.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.sapsii""",109348,Thread-1,2022-07-18T00:18:12.172124Z
E015,,debug,"Using postgres connection ""model.mimic.sapsii""",109348,Thread-1,2022-07-18T00:18:12.173627Z
E016,,debug,On model.mimic.sapsii: BEGIN,109348,Thread-1,2022-07-18T00:18:12.174193Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:18:12.174521Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:18:12.180660Z
E015,,debug,"Using postgres connection ""model.mimic.sapsii""",109348,Thread-1,2022-07-18T00:18:12.180997Z
E016,,debug,"On model.mimic.sapsii: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.sapsii""} */


  create  table ""postgres"".""public"".""sapsii__dbt_tmp""
  as (
    -- ------------------------------------------------------------------
-- Title: Simplified Acute Physiology Score II (SAPS II)
-- This query extracts the simplified acute physiology score II.
-- This score is a measure of patient severity of illness.
-- The score is calculated on the first day of each ICU patients' stay.
-- ------------------------------------------------------------------

-- Reference for SAPS II:
--    Le Gall, Jean-Roger, Stanley Lemeshow, and Fabienne Saulnier.
--    ""A new simplified acute physiology score (SAPS II) based on a European/North American multicenter study.""
--    JAMA 270, no. 24 (1993): 2957-2963.

-- Variables used in SAPS II:
--  Age, GCS
--  VITALS: Heart rate, systolic blood pressure, temperature
--  FLAGS: ventilation/cpap
--  IO: urine output
--  LABS: PaO2/FiO2 ratio, blood urea nitrogen, WBC, potassium, sodium, HCO3

-- The following views are required to run this query:
--  1) urine_output_first_day - generated by urine-output-first-day.sql
--  2) ventilation_durations - generated by ventilation_durations.sql
--  3) vitals_first_day - generated by vitals-first-day.sql
--  4) gcs_first_day - generated by gcs-first-day.sql
--  5) labs_first_day - generated by labs-first-day.sql
--  6) blood_gas_arterial_first_day - generated by blood-gas-first-day-arterial.sql

-- Note:
--  The score is calculated for *all* ICU patients, with the assumption that the user will subselect appropriate ICUSTAY_IDs.
--  For example, the score is calculated for neonates, but it is likely inappropriate to actually use the score values for these patients.

-- extract CPAP from the ""Oxygen Delivery Device"" fields
with cpap as
(
  select ie.icustay_id
    , min(DATETIME_SUB(charttime, INTERVAL '1' HOUR)) as starttime
    , max(DATETIME_ADD(charttime, INTERVAL '4' HOUR)) as endtime
    , max(CASE
          WHEN lower(ce.value) LIKE '%cpap%' THEN 1
          WHEN lower(ce.value) LIKE '%bipap mask%' THEN 1
        else 0 end) as cpap
  FROM icustays ie
  inner join chartevents ce
    on ie.icustay_id = ce.icustay_id
    and ce.charttime between ie.intime and DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
  where itemid in
  (
    -- TODO: when metavision data import fixed, check the values in 226732 match the value clause below
    467, 469, 226732
  )
  and (lower(ce.value) LIKE '%cpap%' or lower(ce.value) LIKE '%bipap mask%')
  -- exclude rows marked as error
  AND (ce.error IS NULL OR ce.error = 0)
  group by ie.icustay_id
)
-- extract a flag for surgical service
-- this combined with ""elective"" FROM admissions table defines elective/non-elective surgery
, surgflag as
(
  select adm.hadm_id
    , case when lower(curr_service) like '%surg%' then 1 else 0 end as surgical
    , ROW_NUMBER() over
    (
      PARTITION BY adm.HADM_ID
      ORDER BY TRANSFERTIME
    ) as serviceOrder
  FROM admissions adm
  left join services se
    on adm.hadm_id = se.hadm_id
)
-- icd-9 diagnostic codes are our best source for comorbidity information
-- unfortunately, they are technically a-causal
-- however, this shouldn't matter too much for the SAPS II comorbidities
, comorb as
(
select hadm_id
-- these are slightly different than elixhauser comorbidities, but based on them
-- they include some non-comorbid ICD-9 codes (e.g. 20302, relapse of multiple myeloma)
  , max(CASE
    when SUBSTR(icd9_code,1,3) BETWEEN '042' AND '044' THEN 1
  		end) as aids      /* HIV and AIDS */
  , max(CASE
    when icd9_code between '20000' and '20238' then 1 -- lymphoma
    when icd9_code between '20240' and '20248' then 1 -- leukemia
    when icd9_code between '20250' and '20302' then 1 -- lymphoma
    when icd9_code between '20310' and '20312' then 1 -- leukemia
    when icd9_code between '20302' and '20382' then 1 -- lymphoma
    when icd9_code between '20400' and '20522' then 1 -- chronic leukemia
    when icd9_code between '20580' and '20702' then 1 -- other myeloid leukemia
    when icd9_code between '20720' and '20892' then 1 -- other myeloid leukemia
    when SUBSTR(icd9_code,1,4) = '2386' then 1 -- lymphoma
    when SUBSTR(icd9_code,1,4) = '2733' then 1 -- lymphoma
  		end) as hem
  , max(CASE
    when SUBSTR(icd9_code,1,4) BETWEEN '1960' AND '1991' THEN 1
    when icd9_code between '20970' and '20975' then 1
    when icd9_code = '20979' then 1
    when icd9_code = '78951' then 1
  		end) as mets      /* Metastatic cancer */
  from diagnoses_icd
  group by hadm_id
)
, pafi1 as
(
  -- join blood gas to ventilation durations to determine if patient was vent
  -- also join to cpap table for the same purpose
  select bg.icustay_id, bg.charttime
  , pao2fio2
  , case when vd.icustay_id is not null then 1 else 0 end as vent
  , case when cp.icustay_id is not null then 1 else 0 end as cpap
  from ""postgres"".""public"".""blood_gas_first_day_arterial"" bg
  left join ""postgres"".""public"".""ventilation_durations"" vd
    on bg.icustay_id = vd.icustay_id
    and bg.charttime >= vd.starttime
    and bg.charttime <= vd.endtime
  left join cpap cp
    on bg.icustay_id = cp.icustay_id
    and bg.charttime >= cp.starttime
    and bg.charttime <= cp.endtime
)
, pafi2 as
(
  -- get the minimum PaO2/FiO2 ratio *only for ventilated/cpap patients*
  select icustay_id
  , min(pao2fio2) as pao2fio2_vent_min
  from pafi1
  where vent = 1 or cpap = 1
  group by icustay_id
)
, cohort as
(
select ie.subject_id, ie.hadm_id, ie.icustay_id
      , ie.intime
      , ie.outtime

      -- the casts ensure the result is numeric.. we could equally extract EPOCH from the interval
      -- however this code works in Oracle and Postgres
      , DATETIME_DIFF(ie.intime, pat.dob, 'YEAR') as age

      , vital.heartrate_max
      , vital.heartrate_min
      , vital.sysbp_max
      , vital.sysbp_min
      , vital.tempc_max
      , vital.tempc_min

      -- this value is non-null iff the patient is on vent/cpap
      , pf.pao2fio2_vent_min

      , uo.urineoutput

      , labs.bun_min
      , labs.bun_max
      , labs.wbc_min
      , labs.wbc_max
      , labs.potassium_min
      , labs.potassium_max
      , labs.sodium_min
      , labs.sodium_max
      , labs.bicarbonate_min
      , labs.bicarbonate_max
      , labs.bilirubin_min
      , labs.bilirubin_max

      , gcs.mingcs

      , comorb.aids
      , comorb.hem
      , comorb.mets

      , case
          when adm.ADMISSION_TYPE = 'ELECTIVE' and sf.surgical = 1
            then 'ScheduledSurgical'
          when adm.ADMISSION_TYPE != 'ELECTIVE' and sf.surgical = 1
            then 'UnscheduledSurgical'
          else 'Medical'
        end as admissiontype


FROM icustays ie
inner join admissions adm
  on ie.hadm_id = adm.hadm_id
inner join patients pat
  on ie.subject_id = pat.subject_id

-- join to above views
left join pafi2 pf
  on ie.icustay_id = pf.icustay_id
left join surgflag sf
  on adm.hadm_id = sf.hadm_id and sf.serviceOrder = 1
left join comorb
  on ie.hadm_id = comorb.hadm_id

-- join to custom tables to get more data....
left join ""postgres"".""public"".""gcs_first_day"" gcs
  on ie.icustay_id = gcs.icustay_id
left join ""postgres"".""public"".""vitals_first_day"" vital
  on ie.icustay_id = vital.icustay_id
left join ""postgres"".""public"".""urine_output_first_day"" uo
  on ie.icustay_id = uo.icustay_id
left join ""postgres"".""public"".""labs_first_day"" labs
  on ie.icustay_id = labs.icustay_id
)
, scorecomp as
(
select
  cohort.*
  -- Below code calculates the component scores needed for SAPS
  , case
      when age is null then null
      when age <  40 then 0
      when age <  60 then 7
      when age <  70 then 12
      when age <  75 then 15
      when age <  80 then 16
      when age >= 80 then 18
    end as age_score

  , case
      when heartrate_max is null then null
      when heartrate_min <   40 then 11
      when heartrate_max >= 160 then 7
      when heartrate_max >= 120 then 4
      when heartrate_min  <  70 then 2
      when  heartrate_max >= 70 and heartrate_max < 120
        and heartrate_min >= 70 and heartrate_min < 120
      then 0
    end as hr_score

  , case
      when  sysbp_min is null then null
      when  sysbp_min <   70 then 13
      when  sysbp_min <  100 then 5
      when  sysbp_max >= 200 then 2
      when  sysbp_max >= 100 and sysbp_max < 200
        and sysbp_min >= 100 and sysbp_min < 200
        then 0
    end as sysbp_score

  , case
      when tempc_max is null then null
      when tempc_min <  39.0 then 0
      when tempc_max >= 39.0 then 3
    end as temp_score

  , case
      when pao2fio2_vent_min is null then null
      when pao2fio2_vent_min <  100 then 11
      when pao2fio2_vent_min <  200 then 9
      when pao2fio2_vent_min >= 200 then 6
    end as pao2fio2_score

  , case
      when urineoutput is null then null
      when urineoutput <   500.0 then 11
      when urineoutput <  1000.0 then 4
      when urineoutput >= 1000.0 then 0
    end as uo_score

  , case
      when bun_max is null then null
      when bun_max <  28.0 then 0
      when bun_max <  84.0 then 6
      when bun_max >= 84.0 then 10
    end as bun_score

  , case
      when wbc_max is null then null
      when wbc_min <   1.0 then 12
      when wbc_max >= 20.0 then 3
      when wbc_max >=  1.0 and wbc_max < 20.0
       and wbc_min >=  1.0 and wbc_min < 20.0
        then 0
    end as wbc_score

  , case
      when potassium_max is null then null
      when potassium_min <  3.0 then 3
      when potassium_max >= 5.0 then 3
      when potassium_max >= 3.0 and potassium_max < 5.0
       and potassium_min >= 3.0 and potassium_min < 5.0
        then 0
      end as potassium_score

  , case
      when sodium_max is null then null
      when sodium_min  < 125 then 5
      when sodium_max >= 145 then 1
      when sodium_max >= 125 and sodium_max < 145
       and sodium_min >= 125 and sodium_min < 145
        then 0
      end as sodium_score

  , case
      when bicarbonate_max is null then null
      when bicarbonate_min <  15.0 then 5
      when bicarbonate_min <  20.0 then 3
      when bicarbonate_max >= 20.0
       and bicarbonate_min >= 20.0
          then 0
      end as bicarbonate_score

  , case
      when bilirubin_max is null then null
      when bilirubin_max  < 4.0 then 0
      when bilirubin_max  < 6.0 then 4
      when bilirubin_max >= 6.0 then 9
      end as bilirubin_score

   , case
      when mingcs is null then null
        when mingcs <  3 then null -- erroneous value/on trach
        when mingcs <  6 then 26
        when mingcs <  9 then 13
        when mingcs < 11 then 7
        when mingcs < 14 then 5
        when mingcs >= 14
         and mingcs <= 15
          then 0
        end as gcs_score

    , case
        when aids = 1 then 17
        when hem  = 1 then 10
        when mets = 1 then 9
        else 0
      end as comorbidity_score

    , case
        when admissiontype = 'ScheduledSurgical' then 0
        when admissiontype = 'Medical' then 6
        when admissiontype = 'UnscheduledSurgical' then 8
        else null
      end as admissiontype_score

from cohort
)
-- Calculate SAPS II here so we can use it in the probability calculation below
, score as
(
  select s.*
  -- coalesce statements impute normal score of zero if data element is missing
  , coalesce(age_score,0)
  + coalesce(hr_score,0)
  + coalesce(sysbp_score,0)
  + coalesce(temp_score,0)
  + coalesce(pao2fio2_score,0)
  + coalesce(uo_score,0)
  + coalesce(bun_score,0)
  + coalesce(wbc_score,0)
  + coalesce(potassium_score,0)
  + coalesce(sodium_score,0)
  + coalesce(bicarbonate_score,0)
  + coalesce(bilirubin_score,0)
  + coalesce(gcs_score,0)
  + coalesce(comorbidity_score,0)
  + coalesce(admissiontype_score,0)
    as sapsii
  from scorecomp s
)
select ie.subject_id, ie.hadm_id, ie.icustay_id
, sapsii
, 1 / (1 + exp(- (-7.7631 + 0.0737*(sapsii) + 0.9971*(ln(sapsii + 1))) )) as sapsii_prob
, age_score
, hr_score
, sysbp_score
, temp_score
, pao2fio2_score
, uo_score
, bun_score
, wbc_score
, potassium_score
, sodium_score
, bicarbonate_score
, bilirubin_score
, gcs_score
, comorbidity_score
, admissiontype_score
FROM icustays ie
left join score s
  on ie.icustay_id = s.icustay_id
order by ie.icustay_id
  );",109348,Thread-1,2022-07-18T00:18:12.181134Z
E017,,debug,SQL status: SELECT 61532 in 2.3 seconds,109348,Thread-1,2022-07-18T00:18:14.482826Z
E015,,debug,"Using postgres connection ""model.mimic.sapsii""",109348,Thread-1,2022-07-18T00:18:14.489220Z
E016,,debug,"On model.mimic.sapsii: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.sapsii""} */
alter table ""postgres"".""public"".""sapsii"" rename to ""sapsii__dbt_backup""",109348,Thread-1,2022-07-18T00:18:14.489792Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:14.491021Z
E015,,debug,"Using postgres connection ""model.mimic.sapsii""",109348,Thread-1,2022-07-18T00:18:14.494833Z
E016,,debug,"On model.mimic.sapsii: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.sapsii""} */
alter table ""postgres"".""public"".""sapsii__dbt_tmp"" rename to ""sapsii""",109348,Thread-1,2022-07-18T00:18:14.495094Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:14.495839Z
E018,,debug,On model.mimic.sapsii: COMMIT,109348,Thread-1,2022-07-18T00:18:14.499208Z
E015,,debug,"Using postgres connection ""model.mimic.sapsii""",109348,Thread-1,2022-07-18T00:18:14.499453Z
E016,,debug,On model.mimic.sapsii: COMMIT,109348,Thread-1,2022-07-18T00:18:14.499657Z
E017,,debug,SQL status: COMMIT in 0.01 seconds,109348,Thread-1,2022-07-18T00:18:14.508345Z
E015,,debug,"Using postgres connection ""model.mimic.sapsii""",109348,Thread-1,2022-07-18T00:18:14.510897Z
E016,,debug,"On model.mimic.sapsii: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.sapsii""} */
drop table if exists ""postgres"".""public"".""sapsii__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:18:14.511127Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:14.513275Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:18:14.516165Z
E010,,debug,On model.mimic.sapsii: Close,109348,Thread-1,2022-07-18T00:18:14.516439Z
Q012,2,info,99 of 107 OK created table model public.sapsii ................................. [[32mSELECT 61532[0m in 2.36s],109348,Thread-1,2022-07-18T00:18:14.517294Z,table,null,sapsii,severityscores/sapsii.sql,2022-07-18T00:18:12.150952,compiling,model,,,
Q024,2.364887237548828,debug,Finished running node model.mimic.sapsii,109348,Thread-1,2022-07-18T00:18:14.517984Z,table,2022-07-18T00:18:14.517795,sapsii,severityscores/sapsii.sql,2022-07-18T00:18:12.150952,success,model,,,
Q023,,debug,Began running node model.mimic.sofa,109348,Thread-1,2022-07-18T00:18:14.518584Z,table,null,sofa,severityscores/sofa.sql,2022-07-18T00:18:14.518504,started,model,,,
Q033,,info,100 of 107 START table model public.sofa ....................................... [RUN],109348,Thread-1,2022-07-18T00:18:14.519334Z,table,null,sofa,severityscores/sofa.sql,2022-07-18T00:18:14.518504,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.sofa""",109348,Thread-1,2022-07-18T00:18:14.520108Z
Q030,,debug,Began compiling node model.mimic.sofa,109348,Thread-1,2022-07-18T00:18:14.520545Z,table,null,sofa,severityscores/sofa.sql,2022-07-18T00:18:14.518504,compiling,model,,,
Q027,,debug,Compiling model.mimic.sofa,109348,Thread-1,2022-07-18T00:18:14.520934Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.sofa""",109348,Thread-1,2022-07-18T00:18:14.527016Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:18:14.527753Z
Q031,,debug,Began executing node model.mimic.sofa,109348,Thread-1,2022-07-18T00:18:14.528293Z,table,null,sofa,severityscores/sofa.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.sofa""",109348,Thread-1,2022-07-18T00:18:14.546314Z
E015,,debug,"Using postgres connection ""model.mimic.sofa""",109348,Thread-1,2022-07-18T00:18:14.547033Z
E016,,debug,On model.mimic.sofa: BEGIN,109348,Thread-1,2022-07-18T00:18:14.547269Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:18:14.547484Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:18:14.554190Z
E015,,debug,"Using postgres connection ""model.mimic.sofa""",109348,Thread-1,2022-07-18T00:18:14.554964Z
E016,,debug,"On model.mimic.sofa: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.sofa""} */


  create  table ""postgres"".""public"".""sofa__dbt_tmp""
  as (
    -- ------------------------------------------------------------------
-- Title: Sequential Organ Failure Assessment (SOFA)
-- This query extracts the sequential organ failure assessment (formally: sepsis-related organ failure assessment).
-- This score is a measure of organ failure for patients in the ICU.
-- The score is calculated on the first day of each ICU patients' stay.
-- ------------------------------------------------------------------

-- Reference for SOFA:
--    Jean-Louis Vincent, Rui Moreno, Jukka Takala, Sheila Willatts, Arnaldo De Mendonça,
--    Hajo Bruining, C. K. Reinhart, Peter M Suter, and L. G. Thijs.
--    ""The SOFA (Sepsis-related Organ Failure Assessment) score to describe organ dysfunction/failure.""
--    Intensive care medicine 22, no. 7 (1996): 707-710.

-- Variables used in SOFA:
--  GCS, MAP, FiO2, Ventilation status (sourced FROM chartevents)
--  Creatinine, Bilirubin, FiO2, PaO2, Platelets (sourced FROM labevents)
--  Dobutamine, Epinephrine, Norepinephrine (sourced FROM inputevents_mv and INPUTEVENTS_CV)
--  Urine output (sourced from OUTPUTEVENTS)

-- The following views required to run this query:
--  1) urine_output_first_day - generated by urine-output-first-day.sql
--  2) vitals_first_day - generated by vitals-first-day.sql
--  3) gcs_first_day - generated by gcs-first-day.sql
--  4) labs_first_day - generated by labs-first-day.sql
--  5) blood_gas_first_day_arterial - generated by blood-gas-first-day-arterial.sql
--  6) echodata - generated by echo-data.sql
--  7) ventilation_durations - generated by ventilation_durations.sql

-- Note:
--  The score is calculated for *all* ICU patients, with the assumption that the user will subselect appropriate ICUSTAY_IDs.
--  For example, the score is calculated for neonates, but it is likely inappropriate to actually use the score values for these patients.

with wt AS
(
  SELECT ie.icustay_id
    -- ensure weight is measured in kg
    , avg(CASE
        WHEN itemid IN (762, 763, 3723, 3580, 226512)
          THEN valuenum
        -- convert lbs to kgs
        WHEN itemid IN (3581)
          THEN valuenum * 0.45359237
        WHEN itemid IN (3582)
          THEN valuenum * 0.0283495231
        ELSE null
      END) AS weight

  FROM icustays ie
  left join chartevents c
    on ie.icustay_id = c.icustay_id
  WHERE valuenum IS NOT NULL
  AND itemid IN
  (
    762, 763, 3723, 3580,                     -- Weight Kg
    3581,                                     -- Weight lb
    3582,                                     -- Weight oz
    226512 -- Metavision: Admission Weight (Kg)
  )
  AND valuenum != 0
  and charttime between DATETIME_SUB(ie.intime, INTERVAL '1' DAY) and DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
  -- exclude rows marked as error
  AND (c.error IS NULL OR c.error = 0)
  group by ie.icustay_id
)
-- 5% of patients are missing a weight, but we can impute weight using their echo notes
, echo2 as(
  select ie.icustay_id, avg(weight * 0.45359237) as weight
  FROM icustays ie
  left join ""postgres"".""public"".""echo_data"" echo
    on ie.hadm_id = echo.hadm_id
    and echo.charttime > DATETIME_SUB(ie.intime, INTERVAL '7' DAY)
    and echo.charttime < DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
  group by ie.icustay_id
)
, vaso_cv as
(
  select ie.icustay_id
    -- case statement determining whether the ITEMID is an instance of vasopressor usage
    , max(case
            when itemid = 30047 then rate / coalesce(wt.weight,ec.weight) -- measured in mcgmin
            when itemid = 30120 then rate -- measured in mcgkgmin ** there are clear errors, perhaps actually mcgmin
            else null
          end) as rate_norepinephrine

    , max(case
            when itemid =  30044 then rate / coalesce(wt.weight,ec.weight) -- measured in mcgmin
            when itemid in (30119,30309) then rate -- measured in mcgkgmin
            else null
          end) as rate_epinephrine

    , max(case when itemid in (30043,30307) then rate end) as rate_dopamine
    , max(case when itemid in (30042,30306) then rate end) as rate_dobutamine

  FROM icustays ie
  inner join inputevents_cv cv
    on ie.icustay_id = cv.icustay_id and cv.charttime between ie.intime and DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
  left join wt
    on ie.icustay_id = wt.icustay_id
  left join echo2 ec
    on ie.icustay_id = ec.icustay_id
  where itemid in (30047,30120,30044,30119,30309,30043,30307,30042,30306)
  and rate is not null
  group by ie.icustay_id
)
, vaso_mv as
(
  select ie.icustay_id
    -- case statement determining whether the ITEMID is an instance of vasopressor usage
    , max(case when itemid = 221906 then rate end) as rate_norepinephrine
    , max(case when itemid = 221289 then rate end) as rate_epinephrine
    , max(case when itemid = 221662 then rate end) as rate_dopamine
    , max(case when itemid = 221653 then rate end) as rate_dobutamine
  FROM icustays ie
  inner join inputevents_mv mv
    on ie.icustay_id = mv.icustay_id and mv.starttime between ie.intime and DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
  where itemid in (221906,221289,221662,221653)
  -- 'Rewritten' orders are not delivered to the patient
  and statusdescription != 'Rewritten'
  group by ie.icustay_id
)
, pafi1 as
(
  -- join blood gas to ventilation durations to determine if patient was vent
  select bg.icustay_id, bg.charttime
  , pao2fio2
  , case when vd.icustay_id is not null then 1 else 0 end as isvent
  from ""postgres"".""public"".""blood_gas_first_day_arterial"" bg
  left join ""postgres"".""public"".""ventilation_durations"" vd
    on bg.icustay_id = vd.icustay_id
    and bg.charttime >= vd.starttime
    and bg.charttime <= vd.endtime
  order by bg.icustay_id, bg.charttime
)
, pafi2 as
(
  -- because pafi has an interaction between vent/PaO2:FiO2, we need two columns for the score
  -- it can happen that the lowest unventilated PaO2/FiO2 is 68, but the lowest ventilated PaO2/FiO2 is 120
  -- in this case, the SOFA score is 3, *not* 4.
  select icustay_id
  , min(case when isvent = 0 then pao2fio2 else null end) as pao2fio2_novent_min
  , min(case when isvent = 1 then pao2fio2 else null end) as pao2fio2_vent_min
  from pafi1
  group by icustay_id
)
-- Aggregate the components for the score
, scorecomp as
(
select ie.icustay_id
  , v.meanbp_min
  , coalesce(cv.rate_norepinephrine, mv.rate_norepinephrine) as rate_norepinephrine
  , coalesce(cv.rate_epinephrine, mv.rate_epinephrine) as rate_epinephrine
  , coalesce(cv.rate_dopamine, mv.rate_dopamine) as rate_dopamine
  , coalesce(cv.rate_dobutamine, mv.rate_dobutamine) as rate_dobutamine

  , l.creatinine_max
  , l.bilirubin_max
  , l.platelet_min

  , pf.pao2fio2_novent_min
  , pf.pao2fio2_vent_min

  , uo.urineoutput

  , gcs.mingcs
FROM icustays ie
left join vaso_cv cv
  on ie.icustay_id = cv.icustay_id
left join vaso_mv mv
  on ie.icustay_id = mv.icustay_id
left join pafi2 pf
 on ie.icustay_id = pf.icustay_id
left join ""postgres"".""public"".""vitals_first_day"" v
  on ie.icustay_id = v.icustay_id
left join ""postgres"".""public"".""labs_first_day"" l
  on ie.icustay_id = l.icustay_id
left join ""postgres"".""public"".""urine_output_first_day"" uo
  on ie.icustay_id = uo.icustay_id
left join ""postgres"".""public"".""gcs_first_day"" gcs
  on ie.icustay_id = gcs.icustay_id
)
, scorecalc as
(
  -- Calculate the final score
  -- note that if the underlying data is missing, the component is null
  -- eventually these are treated as 0 (normal), but knowing when data is missing is useful for debugging
  select icustay_id
  -- Respiration
  , case
      when pao2fio2_vent_min   < 100 then 4
      when pao2fio2_vent_min   < 200 then 3
      when pao2fio2_novent_min < 300 then 2
      when pao2fio2_novent_min < 400 then 1
      when coalesce(pao2fio2_vent_min, pao2fio2_novent_min) is null then null
      else 0
    end as respiration

  -- Coagulation
  , case
      when platelet_min < 20  then 4
      when platelet_min < 50  then 3
      when platelet_min < 100 then 2
      when platelet_min < 150 then 1
      when platelet_min is null then null
      else 0
    end as coagulation

  -- Liver
  , case
      -- Bilirubin checks in mg/dL
        when bilirubin_max >= 12.0 then 4
        when bilirubin_max >= 6.0  then 3
        when bilirubin_max >= 2.0  then 2
        when bilirubin_max >= 1.2  then 1
        when bilirubin_max is null then null
        else 0
      end as liver

  -- Cardiovascular
  , case
      when rate_dopamine > 15 or rate_epinephrine >  0.1 or rate_norepinephrine >  0.1 then 4
      when rate_dopamine >  5 or rate_epinephrine <= 0.1 or rate_norepinephrine <= 0.1 then 3
      when rate_dopamine >  0 or rate_dobutamine > 0 then 2
      when meanbp_min < 70 then 1
      when coalesce(meanbp_min, rate_dopamine, rate_dobutamine, rate_epinephrine, rate_norepinephrine) is null then null
      else 0
    end as cardiovascular

  -- Neurological failure (GCS)
  , case
      when (mingcs >= 13 and mingcs <= 14) then 1
      when (mingcs >= 10 and mingcs <= 12) then 2
      when (mingcs >=  6 and mingcs <=  9) then 3
      when  mingcs <   6 then 4
      when  mingcs is null then null
  else 0 end
    as cns

  -- Renal failure - high creatinine or low urine output
  , case
    when (creatinine_max >= 5.0) then 4
    when  urineoutput < 200 then 4
    when (creatinine_max >= 3.5 and creatinine_max < 5.0) then 3
    when  urineoutput < 500 then 3
    when (creatinine_max >= 2.0 and creatinine_max < 3.5) then 2
    when (creatinine_max >= 1.2 and creatinine_max < 2.0) then 1
    when coalesce(urineoutput, creatinine_max) is null then null
  else 0 end
    as renal
  from scorecomp
)
select ie.subject_id, ie.hadm_id, ie.icustay_id
  -- Combine all the scores to get SOFA
  -- Impute 0 if the score is missing
  , coalesce(respiration,0)
  + coalesce(coagulation,0)
  + coalesce(liver,0)
  + coalesce(cardiovascular,0)
  + coalesce(cns,0)
  + coalesce(renal,0)
  as SOFA
, respiration
, coagulation
, liver
, cardiovascular
, cns
, renal
FROM icustays ie
left join scorecalc s
  on ie.icustay_id = s.icustay_id
order by ie.icustay_id
  );",109348,Thread-1,2022-07-18T00:18:14.555257Z
E017,,debug,SQL status: SELECT 61532 in 6.04 seconds,109348,Thread-1,2022-07-18T00:18:20.591500Z
E015,,debug,"Using postgres connection ""model.mimic.sofa""",109348,Thread-1,2022-07-18T00:18:20.595915Z
E016,,debug,"On model.mimic.sofa: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.sofa""} */
alter table ""postgres"".""public"".""sofa"" rename to ""sofa__dbt_backup""",109348,Thread-1,2022-07-18T00:18:20.596236Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:20.599594Z
E015,,debug,"Using postgres connection ""model.mimic.sofa""",109348,Thread-1,2022-07-18T00:18:20.603259Z
E016,,debug,"On model.mimic.sofa: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.sofa""} */
alter table ""postgres"".""public"".""sofa__dbt_tmp"" rename to ""sofa""",109348,Thread-1,2022-07-18T00:18:20.603556Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:20.604334Z
E018,,debug,On model.mimic.sofa: COMMIT,109348,Thread-1,2022-07-18T00:18:20.607642Z
E015,,debug,"Using postgres connection ""model.mimic.sofa""",109348,Thread-1,2022-07-18T00:18:20.607878Z
E016,,debug,On model.mimic.sofa: COMMIT,109348,Thread-1,2022-07-18T00:18:20.608102Z
E017,,debug,SQL status: COMMIT in 0.01 seconds,109348,Thread-1,2022-07-18T00:18:20.614286Z
E015,,debug,"Using postgres connection ""model.mimic.sofa""",109348,Thread-1,2022-07-18T00:18:20.616817Z
E016,,debug,"On model.mimic.sofa: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.sofa""} */
drop table if exists ""postgres"".""public"".""sofa__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:18:20.617049Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:20.622154Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:18:20.624984Z
E010,,debug,On model.mimic.sofa: Close,109348,Thread-1,2022-07-18T00:18:20.625302Z
Q012,6,info,100 of 107 OK created table model public.sofa .................................. [[32mSELECT 61532[0m in 6.11s],109348,Thread-1,2022-07-18T00:18:20.626444Z,table,null,sofa,severityscores/sofa.sql,2022-07-18T00:18:14.518504,compiling,model,,,
Q024,6.1063690185546875,debug,Finished running node model.mimic.sofa,109348,Thread-1,2022-07-18T00:18:20.627249Z,table,2022-07-18T00:18:20.627037,sofa,severityscores/sofa.sql,2022-07-18T00:18:14.518504,success,model,,,
Q023,,debug,Began running node model.mimic.ventilation_first_day,109348,Thread-1,2022-07-18T00:18:20.627980Z,table,null,ventilation_first_day,firstday/ventilation_first_day.sql,2022-07-18T00:18:20.627890,started,model,,,
Q033,,info,101 of 107 START table model public.ventilation_first_day ...................... [RUN],109348,Thread-1,2022-07-18T00:18:20.628707Z,table,null,ventilation_first_day,firstday/ventilation_first_day.sql,2022-07-18T00:18:20.627890,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.ventilation_first_day""",109348,Thread-1,2022-07-18T00:18:20.629886Z
Q030,,debug,Began compiling node model.mimic.ventilation_first_day,109348,Thread-1,2022-07-18T00:18:20.630506Z,table,null,ventilation_first_day,firstday/ventilation_first_day.sql,2022-07-18T00:18:20.627890,compiling,model,,,
Q027,,debug,Compiling model.mimic.ventilation_first_day,109348,Thread-1,2022-07-18T00:18:20.630821Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.ventilation_first_day""",109348,Thread-1,2022-07-18T00:18:20.634381Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:18:20.635377Z
Q031,,debug,Began executing node model.mimic.ventilation_first_day,109348,Thread-1,2022-07-18T00:18:20.635909Z,table,null,ventilation_first_day,firstday/ventilation_first_day.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.ventilation_first_day""",109348,Thread-1,2022-07-18T00:18:20.646980Z
E015,,debug,"Using postgres connection ""model.mimic.ventilation_first_day""",109348,Thread-1,2022-07-18T00:18:20.648360Z
E016,,debug,On model.mimic.ventilation_first_day: BEGIN,109348,Thread-1,2022-07-18T00:18:20.648724Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:18:20.648983Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:18:20.659515Z
E015,,debug,"Using postgres connection ""model.mimic.ventilation_first_day""",109348,Thread-1,2022-07-18T00:18:20.659816Z
E016,,debug,"On model.mimic.ventilation_first_day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.ventilation_first_day""} */


  create  table ""postgres"".""public"".""ventilation_first_day__dbt_tmp""
  as (
    -- Determines if a patient is ventilated on the first day of their ICU stay.
-- Creates a table with the result.
-- Requires the ventilation_durations table, generated by ../ventilation-durations.sql

select
  ie.subject_id, ie.hadm_id, ie.icustay_id
  -- if vd.icustay_id is not null, then they have a valid ventilation event
  -- in this case, we say they are ventilated
  -- otherwise, they are not
  , max(case
      when vd.icustay_id is not null then 1
    else 0 end) as vent
FROM icustays ie
left join ""postgres"".""public"".""ventilation_durations"" vd
  on ie.icustay_id = vd.icustay_id
  and
  (
    -- ventilation duration overlaps with ICU admission -> vented on admission
    (vd.starttime <= ie.intime and vd.endtime >= ie.intime)
    -- ventilation started during the first day
    OR (vd.starttime >= ie.intime and vd.starttime <= DATETIME_ADD(ie.intime, INTERVAL '1' DAY))
  )
group by ie.subject_id, ie.hadm_id, ie.icustay_id
order by ie.subject_id, ie.hadm_id, ie.icustay_id
  );",109348,Thread-1,2022-07-18T00:18:20.660073Z
E017,,debug,SQL status: SELECT 61532 in 0.11 seconds,109348,Thread-1,2022-07-18T00:18:20.771011Z
E015,,debug,"Using postgres connection ""model.mimic.ventilation_first_day""",109348,Thread-1,2022-07-18T00:18:20.777455Z
E016,,debug,"On model.mimic.ventilation_first_day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.ventilation_first_day""} */
alter table ""postgres"".""public"".""ventilation_first_day"" rename to ""ventilation_first_day__dbt_backup""",109348,Thread-1,2022-07-18T00:18:20.778033Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:20.779164Z
E015,,debug,"Using postgres connection ""model.mimic.ventilation_first_day""",109348,Thread-1,2022-07-18T00:18:20.785709Z
E016,,debug,"On model.mimic.ventilation_first_day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.ventilation_first_day""} */
alter table ""postgres"".""public"".""ventilation_first_day__dbt_tmp"" rename to ""ventilation_first_day""",109348,Thread-1,2022-07-18T00:18:20.786027Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:20.786909Z
E018,,debug,On model.mimic.ventilation_first_day: COMMIT,109348,Thread-1,2022-07-18T00:18:20.790470Z
E015,,debug,"Using postgres connection ""model.mimic.ventilation_first_day""",109348,Thread-1,2022-07-18T00:18:20.790774Z
E016,,debug,On model.mimic.ventilation_first_day: COMMIT,109348,Thread-1,2022-07-18T00:18:20.790998Z
E017,,debug,SQL status: COMMIT in 0.01 seconds,109348,Thread-1,2022-07-18T00:18:20.797120Z
E015,,debug,"Using postgres connection ""model.mimic.ventilation_first_day""",109348,Thread-1,2022-07-18T00:18:20.800948Z
E016,,debug,"On model.mimic.ventilation_first_day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.ventilation_first_day""} */
drop table if exists ""postgres"".""public"".""ventilation_first_day__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:18:20.801219Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:20.804509Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:18:20.807809Z
E010,,debug,On model.mimic.ventilation_first_day: Close,109348,Thread-1,2022-07-18T00:18:20.808070Z
Q012,0,info,101 of 107 OK created table model public.ventilation_first_day ................. [[32mSELECT 61532[0m in 0.18s],109348,Thread-1,2022-07-18T00:18:20.809062Z,table,null,ventilation_first_day,firstday/ventilation_first_day.sql,2022-07-18T00:18:20.627890,compiling,model,,,
Q024,0.17961621284484863,debug,Finished running node model.mimic.ventilation_first_day,109348,Thread-1,2022-07-18T00:18:20.809800Z,table,2022-07-18T00:18:20.809543,ventilation_first_day,firstday/ventilation_first_day.sql,2022-07-18T00:18:20.627890,success,model,,,
Q023,,debug,Began running node model.mimic.kdigo_stages,109348,Thread-1,2022-07-18T00:18:20.810273Z,table,null,kdigo_stages,organfailure/kdigo_stages.sql,2022-07-18T00:18:20.810203,started,model,,,
Q033,,info,102 of 107 START table model public.kdigo_stages ............................... [RUN],109348,Thread-1,2022-07-18T00:18:20.811103Z,table,null,kdigo_stages,organfailure/kdigo_stages.sql,2022-07-18T00:18:20.810203,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.kdigo_stages""",109348,Thread-1,2022-07-18T00:18:20.812324Z
Q030,,debug,Began compiling node model.mimic.kdigo_stages,109348,Thread-1,2022-07-18T00:18:20.812615Z,table,null,kdigo_stages,organfailure/kdigo_stages.sql,2022-07-18T00:18:20.810203,compiling,model,,,
Q027,,debug,Compiling model.mimic.kdigo_stages,109348,Thread-1,2022-07-18T00:18:20.812997Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.kdigo_stages""",109348,Thread-1,2022-07-18T00:18:20.818022Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:18:20.818744Z
Q031,,debug,Began executing node model.mimic.kdigo_stages,109348,Thread-1,2022-07-18T00:18:20.819049Z,table,null,kdigo_stages,organfailure/kdigo_stages.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.kdigo_stages""",109348,Thread-1,2022-07-18T00:18:20.827653Z
E015,,debug,"Using postgres connection ""model.mimic.kdigo_stages""",109348,Thread-1,2022-07-18T00:18:20.828377Z
E016,,debug,On model.mimic.kdigo_stages: BEGIN,109348,Thread-1,2022-07-18T00:18:20.828639Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:18:20.828827Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:18:20.836397Z
E015,,debug,"Using postgres connection ""model.mimic.kdigo_stages""",109348,Thread-1,2022-07-18T00:18:20.836788Z
E016,,debug,"On model.mimic.kdigo_stages: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.kdigo_stages""} */


  create  table ""postgres"".""public"".""kdigo_stages__dbt_tmp""
  as (
    -- This query checks if the patient had AKI according to KDIGO.
-- AKI is calculated every time a creatinine or urine output measurement occurs.
-- Baseline creatinine is defined as the lowest creatinine in the past 7 days.

-- get creatinine stages
with cr_stg AS
(
  SELECT
    cr.icustay_id
    , cr.charttime
    , cr.creat
    , case
        -- 3x baseline
        when cr.creat >= (cr.creat_low_past_7day*3.0) then 3
        -- *OR* cr >= 4.0 with associated increase
        when cr.creat >= 4
        -- For patients reaching Stage 3 by SCr >4.0 mg/dl
        -- require that the patient first achieve ... acute increase >= 0.3 within 48 hr
        -- *or* an increase of >= 1.5 times baseline
        and (cr.creat_low_past_48hr <= 3.7 OR cr.creat >= (1.5*cr.creat_low_past_7day))
            then 3 
        -- TODO: initiation of RRT
        when cr.creat >= (cr.creat_low_past_7day*2.0) then 2
        when cr.creat >= (cr.creat_low_past_48hr+0.3) then 1
        when cr.creat >= (cr.creat_low_past_7day*1.5) then 1
    else 0 end as aki_stage_creat
  FROM ""postgres"".""public"".""kdigo_creatinine"" cr
)
-- stages for UO / creat
, uo_stg as
(
  select
      uo.icustay_id
    , uo.charttime
    , uo.weight
    , uo.uo_rt_6hr
    , uo.uo_rt_12hr
    , uo.uo_rt_24hr
    -- AKI stages according to urine output
    , CASE
        WHEN uo.uo_rt_6hr IS NULL THEN NULL
        -- require patient to be in ICU for at least 6 hours to stage UO
        WHEN uo.charttime <= DATETIME_ADD(ie.intime, INTERVAL '6' HOUR) THEN 0
        -- require the UO rate to be calculated over half the period
        -- i.e. for uo rate over 24 hours, require documentation at least 12 hr apart
        WHEN uo.uo_tm_24hr >= 11 AND uo.uo_rt_24hr < 0.3 THEN 3
        WHEN uo.uo_tm_12hr >= 5 AND uo.uo_rt_12hr = 0 THEN 3
        WHEN uo.uo_tm_12hr >= 5 AND uo.uo_rt_12hr < 0.5 THEN 2
        WHEN uo.uo_tm_6hr >= 2 AND uo.uo_rt_6hr  < 0.5 THEN 1
    ELSE 0 END AS aki_stage_uo
  from ""postgres"".""public"".""kdigo_uo"" uo
  INNER JOIN icustays ie
    ON uo.icustay_id = ie.icustay_id
)
-- get all charttimes documented
, tm_stg AS
(
    SELECT
      icustay_id, charttime
    FROM cr_stg
    UNION DISTINCT
    SELECT
      icustay_id, charttime
    FROM uo_stg
)
select
    ie.icustay_id
  , tm.charttime
  , cr.creat
  , cr.aki_stage_creat
  , uo.uo_rt_6hr
  , uo.uo_rt_12hr
  , uo.uo_rt_24hr
  , uo.aki_stage_uo
  -- Classify AKI using both creatinine/urine output criteria
  , GREATEST(
      COALESCE(cr.aki_stage_creat, 0),
      COALESCE(uo.aki_stage_uo, 0)
    ) AS aki_stage
FROM icustays ie
-- get all possible charttimes as listed in tm_stg
LEFT JOIN tm_stg tm
  ON ie.icustay_id = tm.icustay_id
LEFT JOIN cr_stg cr
  ON ie.icustay_id = cr.icustay_id
  AND tm.charttime = cr.charttime
LEFT JOIN uo_stg uo
  ON ie.icustay_id = uo.icustay_id
  AND tm.charttime = uo.charttime
order by ie.icustay_id, tm.charttime
  );",109348,Thread-1,2022-07-18T00:18:20.837062Z
E017,,debug,SQL status: SELECT 3423326 in 7.7 seconds,109348,Thread-1,2022-07-18T00:18:28.539733Z
E015,,debug,"Using postgres connection ""model.mimic.kdigo_stages""",109348,Thread-1,2022-07-18T00:18:28.546072Z
E016,,debug,"On model.mimic.kdigo_stages: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.kdigo_stages""} */
alter table ""postgres"".""public"".""kdigo_stages"" rename to ""kdigo_stages__dbt_backup""",109348,Thread-1,2022-07-18T00:18:28.546623Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:28.547850Z
E015,,debug,"Using postgres connection ""model.mimic.kdigo_stages""",109348,Thread-1,2022-07-18T00:18:28.551840Z
E016,,debug,"On model.mimic.kdigo_stages: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.kdigo_stages""} */
alter table ""postgres"".""public"".""kdigo_stages__dbt_tmp"" rename to ""kdigo_stages""",109348,Thread-1,2022-07-18T00:18:28.552099Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:28.552814Z
E018,,debug,On model.mimic.kdigo_stages: COMMIT,109348,Thread-1,2022-07-18T00:18:28.556074Z
E015,,debug,"Using postgres connection ""model.mimic.kdigo_stages""",109348,Thread-1,2022-07-18T00:18:28.556477Z
E016,,debug,On model.mimic.kdigo_stages: COMMIT,109348,Thread-1,2022-07-18T00:18:28.556835Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:28.560643Z
E015,,debug,"Using postgres connection ""model.mimic.kdigo_stages""",109348,Thread-1,2022-07-18T00:18:28.562912Z
E016,,debug,"On model.mimic.kdigo_stages: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.kdigo_stages""} */
drop table if exists ""postgres"".""public"".""kdigo_stages__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:18:28.563318Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:28.568508Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:18:28.572198Z
E010,,debug,On model.mimic.kdigo_stages: Close,109348,Thread-1,2022-07-18T00:18:28.572474Z
Q012,7,info,102 of 107 OK created table model public.kdigo_stages .......................... [[32mSELECT 3423326[0m in 7.76s],109348,Thread-1,2022-07-18T00:18:28.573668Z,table,null,kdigo_stages,organfailure/kdigo_stages.sql,2022-07-18T00:18:20.810203,compiling,model,,,
Q024,7.761392116546631,debug,Finished running node model.mimic.kdigo_stages,109348,Thread-1,2022-07-18T00:18:28.574457Z,table,2022-07-18T00:18:28.574284,kdigo_stages,organfailure/kdigo_stages.sql,2022-07-18T00:18:20.810203,success,model,,,
Q023,,debug,Began running node model.mimic.apsiii,109348,Thread-1,2022-07-18T00:18:28.575024Z,table,null,apsiii,severityscores/apsiii.sql,2022-07-18T00:18:28.574965,started,model,,,
Q033,,info,103 of 107 START table model public.apsiii ..................................... [RUN],109348,Thread-1,2022-07-18T00:18:28.575828Z,table,null,apsiii,severityscores/apsiii.sql,2022-07-18T00:18:28.574965,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.apsiii""",109348,Thread-1,2022-07-18T00:18:28.577041Z
Q030,,debug,Began compiling node model.mimic.apsiii,109348,Thread-1,2022-07-18T00:18:28.577365Z,table,null,apsiii,severityscores/apsiii.sql,2022-07-18T00:18:28.574965,compiling,model,,,
Q027,,debug,Compiling model.mimic.apsiii,109348,Thread-1,2022-07-18T00:18:28.577839Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.apsiii""",109348,Thread-1,2022-07-18T00:18:28.586502Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:18:28.587705Z
Q031,,debug,Began executing node model.mimic.apsiii,109348,Thread-1,2022-07-18T00:18:28.588140Z,table,null,apsiii,severityscores/apsiii.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.apsiii""",109348,Thread-1,2022-07-18T00:18:28.602844Z
E015,,debug,"Using postgres connection ""model.mimic.apsiii""",109348,Thread-1,2022-07-18T00:18:28.603670Z
E016,,debug,On model.mimic.apsiii: BEGIN,109348,Thread-1,2022-07-18T00:18:28.603945Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:18:28.604167Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:18:28.612877Z
E015,,debug,"Using postgres connection ""model.mimic.apsiii""",109348,Thread-1,2022-07-18T00:18:28.613639Z
E016,,debug,"On model.mimic.apsiii: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.apsiii""} */


  create  table ""postgres"".""public"".""apsiii__dbt_tmp""
  as (
    -- ------------------------------------------------------------------
-- Title: Acute Physiology Score III (APS III)
-- This query extracts the acute physiology score III.
-- This score is a measure of patient severity of illness.
-- The score is calculated on the first day of each ICU patients' stay.
-- ------------------------------------------------------------------

-- Reference for APS III:
--    Knaus WA, Wagner DP, Draper EA, Zimmerman JE, Bergner M, Bastos PG, Sirio CA, Murphy DJ, Lotring T, Damiano A.
--    The APACHE III prognostic system. Risk prediction of hospital mortality for critically ill hospitalized adults.
--    Chest Journal. 1991 Dec 1100(6):1619-36.

-- Reference for the equation for calibrating APS III to hospital mortality:
--    Johnson, A. E. W. (2015). Mortality prediction and acuity assessment in critical care.
--    University of Oxford, Oxford, UK.

-- Variables used in APS III:
--  GCS
--  VITALS: Heart rate, mean blood pressure, temperature, respiration rate
--  FLAGS: ventilation/cpap, chronic dialysis
--  IO: urine output
--  LABS: pao2, A-aDO2, hematocrit, WBC, creatinine
--        , blood urea nitrogen, sodium, albumin, bilirubin, glucose, pH, pCO2

-- The following views are required to run this query:
--  1) urine_output_first_day - generated by urine-output-first-day.sql
--  2) ventilation_first_day - generated by ventilated-first-day.sql
--  3) vitals_first_day - generated by vitals-first-day.sql
--  4) gcs_first_day - generated by gcs-first-day.sql
--  5) labs_first_day - generated by labs-first-day.sql

-- Note:
--  The score is calculated for *all* ICU patients, with the assumption that the user will subselect appropriate icustay_ids.
--  For example, the score is calculated for neonates, but it is likely inappropriate to actually use the score values for these patients.

-- List of TODO:
-- The site of temperature is not incorporated. Axillary measurements should be increased by 1 degree.
-- Unfortunately the data for metavision is not available at the moment.
--  674 | Temp. Site
--  224642 | Temperature Site

with pa as
(
  select bg.icustay_id, bg.charttime
  , po2 as PaO2
  , ROW_NUMBER() over (partition by bg.icustay_id ORDER BY bg.po2 DESC) as rn
  from ""postgres"".""public"".""blood_gas_first_day_arterial"" bg
  left join ventilation_durations vd
    on bg.icustay_id = vd.icustay_id
    and bg.charttime >= vd.starttime
    and bg.charttime <= vd.endtime
  WHERE vd.icustay_id is null -- patient is *not* ventilated
  -- and fio2 < 50, or if no fio2, assume room air
  AND coalesce(fio2, fio2_chartevents, 21) < 50
  AND bg.po2 IS NOT NULL
)
, aa as
(
  -- join blood gas to ventilation durations to determine if patient was vent
  -- also join to cpap table for the same purpose
  select bg.icustay_id, bg.charttime
  , bg.aado2
  , ROW_NUMBER() over (partition by bg.icustay_id ORDER BY bg.aado2 DESC) as rn
  -- row number indicating the highest AaDO2
  from blood_gas_first_day_arterial bg
  INNER JOIN ventilation_durations vd
    on bg.icustay_id = vd.icustay_id
    and bg.charttime >= vd.starttime
    and bg.charttime <= vd.endtime
  WHERE vd.icustay_id is not null -- patient is ventilated
  AND coalesce(fio2, fio2_chartevents) >= 50
  AND bg.aado2 IS NOT NULL
)
-- because ph/pco2 rules are an interaction *within* a blood gas, we calculate them here
-- the worse score is then taken for the final calculation
, acidbase as
(
  select bg.icustay_id
  , ph, pco2 as paco2
  , case
      when ph is null or pco2 is null then null
      when ph < 7.20 then
        case
          when pco2 < 50 then 12
          else 4
        end
      when ph < 7.30 then
        case
          when pco2 < 30 then 9
          when pco2 < 40 then 6
          when pco2 < 50 then 3
          else 2
        end
      when ph < 7.35 then
        case
          when pco2 < 30 then 9
          when pco2 < 45 then 0
          else 1
        end
      when ph < 7.45 then
        case
          when pco2 < 30 then 5
          when pco2 < 45 then 0
          else 1
        end
      when ph < 7.50 then
        case
          when pco2 < 30 then 5
          when pco2 < 35 then 0
          when pco2 < 45 then 2
          else 12
        end
      when ph < 7.60 then
        case
          when pco2 < 40 then 3
          else 12
        end
      else -- ph >= 7.60
        case
          when pco2 < 25 then 0
          when pco2 < 40 then 3
          else 12
        end
    end as acidbase_score
  from blood_gas_first_day_arterial bg
  where ph is not null and pco2 is not null
)
, acidbase_max as
(
  select icustay_id, acidbase_score, ph, paco2
    -- create integer which indexes maximum value of score with 1
  , ROW_NUMBER() over (partition by icustay_id ORDER BY acidbase_score DESC) as acidbase_rn
  from acidbase
)
-- define acute renal failure (ARF) as:
--  creatinine >=1.5 mg/dl
--  and urine output <410 cc/day
--  and no chronic dialysis
, arf as
(
  select ie.icustay_id
    , case
        when labs.creatinine_max >= 1.5
        and  uo.urineoutput < 410
        -- acute renal failure is only coded if the patient is not on chronic dialysis
        -- we use ICD-9 coding of ESRD as a proxy for chronic dialysis
        and  icd.ckd = 0
          then 1
      else 0 end as arf
  FROM icustays ie
  left join ""postgres"".""public"".""urine_output_first_day"" uo
    on ie.icustay_id = uo.icustay_id
  left join ""postgres"".""public"".""labs_first_day"" labs
    on ie.icustay_id = labs.icustay_id
  left join
  (
    select hadm_id
      , max(case
          -- severe kidney failure requiring use of dialysis
          when icd9_code in  ('5854','5855','5856') then 1
          -- we do not include 5859 as that is sometimes coded for acute-on-chronic ARF
        else 0 end)
      as ckd
    from diagnoses_icd
    group by hadm_id
  ) icd
    on ie.hadm_id = icd.hadm_id
)
, cohort as
(
select ie.subject_id, ie.hadm_id, ie.icustay_id
      , ie.intime
      , ie.outtime

      , vital.heartrate_min
      , vital.heartrate_max
      , vital.meanbp_min
      , vital.meanbp_max
      , vital.tempc_min
      , vital.tempc_max
      , vital.resprate_min
      , vital.resprate_max

      , pa.pao2
      , aa.aado2

      , ab.ph
      , ab.paco2
      , ab.acidbase_score

      , labs.hematocrit_min
      , labs.hematocrit_max
      , labs.wbc_min
      , labs.wbc_max
      , labs.creatinine_min
      , labs.creatinine_max
      , labs.bun_min
      , labs.bun_max
      , labs.sodium_min
      , labs.sodium_max
      , labs.albumin_min
      , labs.albumin_max
      , labs.bilirubin_min
      , labs.bilirubin_max

      , case
          when labs.glucose_max is null and vital.glucose_max is null
            then null
          when labs.glucose_max is null or vital.glucose_max > labs.glucose_max
            then vital.glucose_max
          when vital.glucose_max is null or labs.glucose_max > vital.glucose_max
            then labs.glucose_max
          else labs.glucose_max -- if equal, just pick labs
        end as glucose_max

      , case
          when labs.glucose_min is null and vital.glucose_min is null
            then null
          when labs.glucose_min is null or vital.glucose_min < labs.glucose_min
            then vital.glucose_min
          when vital.glucose_min is null or labs.glucose_min < vital.glucose_min
            then labs.glucose_min
          else labs.glucose_min -- if equal, just pick labs
        end as glucose_min

      -- , labs.bicarbonate_min
      -- , labs.bicarbonate_max
      , vent.vent
      , uo.urineoutput
      -- gcs and its components
      , gcs.mingcs
      , gcs.gcsmotor, gcs.gcsverbal,  gcs.gcseyes, gcs.endotrachflag
      -- acute renal failure
      , arf.arf as arf

FROM icustays ie
inner join admissions adm
  on ie.hadm_id = adm.hadm_id
inner join patients pat
  on ie.subject_id = pat.subject_id

-- join to above views - the row number filters to 1 row per icustay_id
left join pa
  on  ie.icustay_id = pa.icustay_id
  and pa.rn = 1
left join aa
  on  ie.icustay_id = aa.icustay_id
  and aa.rn = 1
left join acidbase_max ab
  on  ie.icustay_id = ab.icustay_id
  and ab.acidbase_rn = 1
left join arf
  on ie.icustay_id = arf.icustay_id

-- join to custom tables to get more data....
left join ""postgres"".""public"".""ventilation_first_day"" vent
  on ie.icustay_id = vent.icustay_id
left join ""postgres"".""public"".""gcs_first_day"" gcs
  on ie.icustay_id = gcs.icustay_id
left join ""postgres"".""public"".""vitals_first_day"" vital
  on ie.icustay_id = vital.icustay_id
left join ""postgres"".""public"".""urine_output_first_day"" uo
  on ie.icustay_id = uo.icustay_id
left join ""postgres"".""public"".""labs_first_day"" labs
  on ie.icustay_id = labs.icustay_id
)
-- First, we calculate the score for the minimum values
, score_min as
(
  select cohort.subject_id, cohort.hadm_id, cohort.icustay_id
  , case
      when heartrate_min is null then null
      when heartrate_min <   40 then 8
      when heartrate_min <   50 then 5
      when heartrate_min <  100 then 0
      when heartrate_min <  110 then 1
      when heartrate_min <  120 then 5
      when heartrate_min <  140 then 7
      when heartrate_min <  155 then 13
      when heartrate_min >= 155 then 17
    end as hr_score

  , case
      when meanbp_min is null then null
      when meanbp_min <   40 then 23
      when meanbp_min <   60 then 15
      when meanbp_min <   70 then 7
      when meanbp_min <   80 then 6
      when meanbp_min <  100 then 0
      when meanbp_min <  120 then 4
      when meanbp_min <  130 then 7
      when meanbp_min <  140 then 9
      when meanbp_min >= 140 then 10
    end as meanbp_score

  -- TODO: add 1 degree to axillary measurements
  , case
      when tempc_min is null then null
      when tempc_min <  33.0 then 20
      when tempc_min <  33.5 then 16
      when tempc_min <  34.0 then 13
      when tempc_min <  35.0 then 8
      when tempc_min <  36.0 then 2
      when tempc_min <  40.0 then 0
      when tempc_min >= 40.0 then 4
    end as temp_score

  , case
      when resprate_min is null then null
      -- special case for ventilated patients
      when vent = 1 and resprate_min < 14 then 0
      when resprate_min <   6 then 17
      when resprate_min <  12 then 8
      when resprate_min <  14 then 7
      when resprate_min <  25 then 0
      when resprate_min <  35 then 6
      when resprate_min <  40 then 9
      when resprate_min <  50 then 11
      when resprate_min >= 50 then 18
    end as resprate_score

  , case
      when hematocrit_min is null then null
      when hematocrit_min <   41.0 then 3
      when hematocrit_min <   50.0 then 0
      when hematocrit_min >=  50.0 then 3
    end as hematocrit_score

  , case
      when wbc_min is null then null
      when wbc_min <   1.0 then 19
      when wbc_min <   3.0 then 5
      when wbc_min <  20.0 then 0
      when wbc_min <  25.0 then 1
      when wbc_min >= 25.0 then 5
    end as wbc_score

  , case
      when creatinine_min is null then null
      when arf = 1 and creatinine_min <  1.5 then 0
      when arf = 1 and creatinine_min >= 1.5 then 10
      when creatinine_min <   0.5 then 3
      when creatinine_min <   1.5 then 0
      when creatinine_min <  1.95 then 4
      when creatinine_min >= 1.95 then 7
    end as creatinine_score

  , case
      when bun_min is null then null
      when bun_min <  17.0 then 0
      when bun_min <  20.0 then 2
      when bun_min <  40.0 then 7
      when bun_min <  80.0 then 11
      when bun_min >= 80.0 then 12
    end as bun_score

  , case
      when sodium_min is null then null
      when sodium_min <  120 then 3
      when sodium_min <  135 then 2
      when sodium_min <  155 then 0
      when sodium_min >= 155 then 4
    end as sodium_score

  , case
      when albumin_min is null then null
      when albumin_min <  2.0 then 11
      when albumin_min <  2.5 then 6
      when albumin_min <  4.5 then 0
      when albumin_min >= 4.5 then 4
    end as albumin_score

  , case
      when bilirubin_min is null then null
      when bilirubin_min <  2.0 then 0
      when bilirubin_min <  3.0 then 5
      when bilirubin_min <  5.0 then 6
      when bilirubin_min <  8.0 then 8
      when bilirubin_min >= 8.0 then 16
    end as bilirubin_score

  , case
      when glucose_min is null then null
      when glucose_min <   40 then 8
      when glucose_min <   60 then 9
      when glucose_min <  200 then 0
      when glucose_min <  350 then 3
      when glucose_min >= 350 then 5
    end as glucose_score

from cohort
)
, score_max as
(
  select cohort.subject_id, cohort.hadm_id, cohort.icustay_id
    , case
        when heartrate_max is null then null
        when heartrate_max <   40 then 8
        when heartrate_max <   50 then 5
        when heartrate_max <  100 then 0
        when heartrate_max <  110 then 1
        when heartrate_max <  120 then 5
        when heartrate_max <  140 then 7
        when heartrate_max <  155 then 13
        when heartrate_max >= 155 then 17
      end as hr_score

    , case
        when meanbp_max is null then null
        when meanbp_max <   40 then 23
        when meanbp_max <   60 then 15
        when meanbp_max <   70 then 7
        when meanbp_max <   80 then 6
        when meanbp_max <  100 then 0
        when meanbp_max <  120 then 4
        when meanbp_max <  130 then 7
        when meanbp_max <  140 then 9
        when meanbp_max >= 140 then 10
      end as meanbp_score

    -- TODO: add 1 degree to axillary measurements
    , case
        when tempc_max is null then null
        when tempc_max <  33.0 then 20
        when tempc_max <  33.5 then 16
        when tempc_max <  34.0 then 13
        when tempc_max <  35.0 then 8
        when tempc_max <  36.0 then 2
        when tempc_max <  40.0 then 0
        when tempc_max >= 40.0 then 4
      end as temp_score

    , case
        when resprate_max is null then null
        -- special case for ventilated patients
        when vent = 1 and resprate_max < 14 then 0
        when resprate_max <   6 then 17
        when resprate_max <  12 then 8
        when resprate_max <  14 then 7
        when resprate_max <  25 then 0
        when resprate_max <  35 then 6
        when resprate_max <  40 then 9
        when resprate_max <  50 then 11
        when resprate_max >= 50 then 18
      end as resprate_score

    , case
        when hematocrit_max is null then null
        when hematocrit_max <   41.0 then 3
        when hematocrit_max <   50.0 then 0
        when hematocrit_max >=  50.0 then 3
      end as hematocrit_score

    , case
        when wbc_max is null then null
        when wbc_max <   1.0 then 19
        when wbc_max <   3.0 then 5
        when wbc_max <  20.0 then 0
        when wbc_max <  25.0 then 1
        when wbc_max >= 25.0 then 5
      end as wbc_score

    , case
        when creatinine_max is null then null
        when arf = 1 and creatinine_max <  1.5 then 0
        when arf = 1 and creatinine_max >= 1.5 then 10
        when creatinine_max <   0.5 then 3
        when creatinine_max <   1.5 then 0
        when creatinine_max <  1.95 then 4
        when creatinine_max >= 1.95 then 7
      end as creatinine_score

    , case
        when bun_max is null then null
        when bun_max <  17.0 then 0
        when bun_max <  20.0 then 2
        when bun_max <  40.0 then 7
        when bun_max <  80.0 then 11
        when bun_max >= 80.0 then 12
      end as bun_score

    , case
        when sodium_max is null then null
        when sodium_max <  120 then 3
        when sodium_max <  135 then 2
        when sodium_max <  155 then 0
        when sodium_max >= 155 then 4
      end as sodium_score

    , case
        when albumin_max is null then null
        when albumin_max <  2.0 then 11
        when albumin_max <  2.5 then 6
        when albumin_max <  4.5 then 0
        when albumin_max >= 4.5 then 4
      end as albumin_score

    , case
        when bilirubin_max is null then null
        when bilirubin_max <  2.0 then 0
        when bilirubin_max <  3.0 then 5
        when bilirubin_max <  5.0 then 6
        when bilirubin_max <  8.0 then 8
        when bilirubin_max >= 8.0 then 16
      end as bilirubin_score

    , case
        when glucose_max is null then null
        when glucose_max <   40 then 8
        when glucose_max <   60 then 9
        when glucose_max <  200 then 0
        when glucose_max <  350 then 3
        when glucose_max >= 350 then 5
      end as glucose_score

from cohort
)
-- Combine together the scores for min/max, using the following rules:
--  1) select the value furthest from a predefined normal value
--  2) if both equidistant, choose the one which gives a worse score
--  3) calculate score for acid-base abnormalities as it requires interactions
-- sometimes the code is a bit redundant, i.e. we know the max would always be furthest from 0
, scorecomp as
(
  select co.*
  -- The rules for APS III require the definition of a ""worst"" value
  -- This value is defined as whatever value is furthest from a predefined normal
  -- e.g., for heart rate, worst is defined as furthest from 75
  , case
      when heartrate_max is null then null
      when abs(heartrate_max-75) > abs(heartrate_min-75)
        then smax.hr_score
      when abs(heartrate_max-75) < abs(heartrate_min-75)
        then smin.hr_score
      when abs(heartrate_max-75) = abs(heartrate_min-75)
      and  smax.hr_score >= smin.hr_score
        then smax.hr_score
      when abs(heartrate_max-75) = abs(heartrate_min-75)
      and  smax.hr_score < smin.hr_score
        then smin.hr_score
    end as hr_score

  , case
      when meanbp_max is null then null
      when abs(meanbp_max-90) > abs(meanbp_min-90)
        then smax.meanbp_score
      when abs(meanbp_max-90) < abs(meanbp_min-90)
        then smin.meanbp_score
      -- values are equidistant - pick the larger score
      when abs(meanbp_max-90) = abs(meanbp_min-90)
      and  smax.meanbp_score >= smin.meanbp_score
        then smax.meanbp_score
      when abs(meanbp_max-90) = abs(meanbp_min-90)
      and  smax.meanbp_score < smin.meanbp_score
        then smin.meanbp_score
    end as meanbp_score

  , case
      when tempc_max is null then null
      when abs(tempc_max-38) > abs(tempc_min-38)
        then smax.temp_score
      when abs(tempc_max-38) < abs(tempc_min-38)
        then smin.temp_score
      -- values are equidistant - pick the larger score
      when abs(tempc_max-38) = abs(tempc_min-38)
      and  smax.temp_score >= smin.temp_score
        then smax.temp_score
      when abs(tempc_max-38) = abs(tempc_min-38)
      and  smax.temp_score < smin.temp_score
        then smin.temp_score
    end as temp_score

  , case
      when resprate_max is null then null
      when abs(resprate_max-19) > abs(resprate_min-19)
        then smax.resprate_score
      when abs(resprate_max-19) < abs(resprate_min-19)
        then smin.resprate_score
      -- values are equidistant - pick the larger score
      when abs(resprate_max-19) = abs(resprate_max-19)
      and  smax.resprate_score >= smin.resprate_score
        then smax.resprate_score
      when abs(resprate_max-19) = abs(resprate_max-19)
      and  smax.resprate_score < smin.resprate_score
        then smin.resprate_score
    end as resprate_score

  , case
      when hematocrit_max is null then null
      when abs(hematocrit_max-45.5) > abs(hematocrit_min-45.5)
        then smax.hematocrit_score
      when abs(hematocrit_max-45.5) < abs(hematocrit_min-45.5)
        then smin.hematocrit_score
      -- values are equidistant - pick the larger score
      when abs(hematocrit_max-45.5) = abs(hematocrit_max-45.5)
      and  smax.hematocrit_score >= smin.hematocrit_score
        then smax.hematocrit_score
      when abs(hematocrit_max-45.5) = abs(hematocrit_max-45.5)
      and  smax.hematocrit_score < smin.hematocrit_score
        then smin.hematocrit_score
    end as hematocrit_score

  , case
      when wbc_max is null then null
      when abs(wbc_max-11.5) > abs(wbc_min-11.5)
        then smax.wbc_score
      when abs(wbc_max-11.5) < abs(wbc_min-11.5)
        then smin.wbc_score
      -- values are equidistant - pick the larger score
      when abs(wbc_max-11.5) = abs(wbc_max-11.5)
      and  smax.wbc_score >= smin.wbc_score
        then smax.wbc_score
      when abs(wbc_max-11.5) = abs(wbc_max-11.5)
      and  smax.wbc_score < smin.wbc_score
        then smin.wbc_score
    end as wbc_score


  -- For some labs, ""furthest from normal"" doesn't make sense
  -- e.g. creatinine w/ ARF, the minimum could be 0.3, and the max 1.6
  -- while the minimum of 0.3 is ""further from 1"", seems like the max should be scored

  , case
      when creatinine_max is null then null
      -- if they have arf then use the max to score
      when arf = 1 then smax.creatinine_score
      -- otherwise furthest from 1
      when abs(creatinine_max-1) > abs(creatinine_min-1)
        then smax.creatinine_score
      when abs(creatinine_max-1) < abs(creatinine_min-1)
        then smin.creatinine_score
      -- values are equidistant
      when smax.creatinine_score >= smin.creatinine_score
        then smax.creatinine_score
      when smax.creatinine_score < smin.creatinine_score
        then smin.creatinine_score
    end as creatinine_score

  -- the rule for BUN is the furthest from 0.. equivalent to the max value
  , case
      when bun_max is null then null
      else smax.bun_score
    end as bun_score

  , case
      when sodium_max is null then null
      when abs(sodium_max-145.5) > abs(sodium_min-145.5)
        then smax.sodium_score
      when abs(sodium_max-145.5) < abs(sodium_min-145.5)
        then smin.sodium_score
      -- values are equidistant - pick the larger score
      when abs(sodium_max-145.5) = abs(sodium_max-145.5)
      and  smax.sodium_score >= smin.sodium_score
        then smax.sodium_score
      when abs(sodium_max-145.5) = abs(sodium_max-145.5)
      and  smax.sodium_score < smin.sodium_score
        then smin.sodium_score
    end as sodium_score

  , case
      when albumin_max is null then null
      when abs(albumin_max-3.5) > abs(albumin_min-3.5)
        then smax.albumin_score
      when abs(albumin_max-3.5) < abs(albumin_min-3.5)
        then smin.albumin_score
      -- values are equidistant - pick the larger score
      when abs(albumin_max-3.5) = abs(albumin_max-3.5)
      and  smax.albumin_score >= smin.albumin_score
        then smax.albumin_score
      when abs(albumin_max-3.5) = abs(albumin_max-3.5)
      and  smax.albumin_score < smin.albumin_score
        then smin.albumin_score
    end as albumin_score

  , case
      when bilirubin_max is null then null
      else smax.bilirubin_score
    end as bilirubin_score

  , case
      when glucose_max is null then null
      when abs(glucose_max-130) > abs(glucose_min-130)
        then smax.glucose_score
      when abs(glucose_max-130) < abs(glucose_min-130)
        then smin.glucose_score
      -- values are equidistant - pick the larger score
      when abs(glucose_max-130) = abs(glucose_max-130)
      and  smax.glucose_score >= smin.glucose_score
        then smax.glucose_score
      when abs(glucose_max-130) = abs(glucose_max-130)
      and  smax.glucose_score < smin.glucose_score
        then smin.glucose_score
    end as glucose_score


  -- Below are interactions/special cases where only 1 value is important
  , case
      when urineoutput is null then null
      when urineoutput <   400 then 15
      when urineoutput <   600 then 8
      when urineoutput <   900 then 7
      when urineoutput <  1500 then 5
      when urineoutput <  2000 then 4
      when urineoutput <  4000 then 0
      when urineoutput >= 4000 then 1
  end as uo_score

  , case
      when endotrachflag = 1
        -- here they are intubated, so their verbal score is inappropriate
        -- normally you are supposed to use ""clinical judgement""
        -- we don't have that, so we just assume normal (as was done in the original study)
        then 0
      when gcseyes = 1
        then case
          when gcsverbal = 1 and gcsmotor in (1,2)
            then 48
          when gcsverbal = 1 and gcsmotor in (3,4)
            then 33
          when gcsverbal = 1 and gcsmotor in (5,6)
            then 16
          when gcsverbal in (2,3) and gcsmotor in (1,2)
            then 29
          when gcsverbal in (2,3) and gcsmotor in (3,4)
            then 24
          when gcsverbal in (2,3) and gcsmotor >= 5
            -- highly unlikely clinical combination
            then null
          when gcsverbal >= 4
            then null
          end
      when gcseyes > 1
        then case
          when gcsverbal = 1 and gcsmotor in (1,2)
            then 29
          when gcsverbal = 1 and gcsmotor in (3,4)
            then 24
          when gcsverbal = 1 and gcsmotor in (5,6)
            then 15
          when gcsverbal in (2,3) and gcsmotor in (1,2)
            then 29
          when gcsverbal in (2,3) and gcsmotor in (3,4)
            then 24
          when gcsverbal in (2,3) and gcsmotor = 5
            then 13
          when gcsverbal in (2,3) and gcsmotor = 6
            then 10
          when gcsverbal = 4 and gcsmotor in (1,2,3,4)
            then 13
          when gcsverbal = 4 and gcsmotor = 5
            then 8
          when gcsverbal = 4 and gcsmotor = 6
            then 3
          when gcsverbal = 5 and gcsmotor in (1,2,3,4,5)
            then 3
          when gcsverbal = 5 and gcsmotor = 6
            then 0
          end
      else null
    end as gcs_score

  , case
      when pao2 is null and aado2 is null
        then null
      when pao2 is not null then
        case
          when pao2 < 50 then 15
          when pao2 < 70 then 5
          when pao2 < 80 then 2
        else 0 end
      when aado2 is not null then
        case
          when aado2 <  100 then 0
          when aado2 <  250 then 7
          when aado2 <  350 then 9
          when aado2 <  500 then 11
          when aado2 >= 500 then 14
        else 0 end
      end as pao2_aado2_score

from cohort co
left join score_min smin
  on co.icustay_id = smin.icustay_id
left join score_max smax
  on co.icustay_id = smax.icustay_id
)
-- tabulate the APS III using the scores from the worst values
, score as
(
  select s.*
  -- coalesce statements impute normal score of zero if data element is missing
  , coalesce(hr_score,0)
  + coalesce(meanbp_score,0)
  + coalesce(temp_score,0)
  + coalesce(resprate_score,0)
  + coalesce(pao2_aado2_score,0)
  + coalesce(hematocrit_score,0)
  + coalesce(wbc_score,0)
  + coalesce(creatinine_score,0)
  + coalesce(uo_score,0)
  + coalesce(bun_score,0)
  + coalesce(sodium_score,0)
  + coalesce(albumin_score,0)
  + coalesce(bilirubin_score,0)
  + coalesce(glucose_score,0)
  + coalesce(acidbase_score,0)
  + coalesce(gcs_score,0)
    as apsiii
  from scorecomp s
)
select ie.subject_id, ie.hadm_id, ie.icustay_id
, apsiii
-- Calculate probability of hospital mortality using equation from Johnson 2014.
, 1 / (1 + exp(- (-4.4360 + 0.04726*(apsiii) ))) as apsiii_prob
, hr_score
, meanbp_score
, temp_score
, resprate_score
, pao2_aado2_score
, hematocrit_score
, wbc_score
, creatinine_score
, uo_score
, bun_score
, sodium_score
, albumin_score
, bilirubin_score
, glucose_score
, acidbase_score
, gcs_score
FROM icustays ie
left join score s
  on ie.icustay_id = s.icustay_id
order by ie.icustay_id
  );",109348,Thread-1,2022-07-18T00:18:28.614030Z
E017,,debug,SQL status: SELECT 61532 in 4.07 seconds,109348,Thread-1,2022-07-18T00:18:32.679750Z
E015,,debug,"Using postgres connection ""model.mimic.apsiii""",109348,Thread-1,2022-07-18T00:18:32.687575Z
E016,,debug,"On model.mimic.apsiii: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.apsiii""} */
alter table ""postgres"".""public"".""apsiii"" rename to ""apsiii__dbt_backup""",109348,Thread-1,2022-07-18T00:18:32.688057Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:32.690023Z
E015,,debug,"Using postgres connection ""model.mimic.apsiii""",109348,Thread-1,2022-07-18T00:18:32.696200Z
E016,,debug,"On model.mimic.apsiii: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.apsiii""} */
alter table ""postgres"".""public"".""apsiii__dbt_tmp"" rename to ""apsiii""",109348,Thread-1,2022-07-18T00:18:32.696435Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:32.697295Z
E018,,debug,On model.mimic.apsiii: COMMIT,109348,Thread-1,2022-07-18T00:18:32.700530Z
E015,,debug,"Using postgres connection ""model.mimic.apsiii""",109348,Thread-1,2022-07-18T00:18:32.700857Z
E016,,debug,On model.mimic.apsiii: COMMIT,109348,Thread-1,2022-07-18T00:18:32.701185Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:32.704963Z
E015,,debug,"Using postgres connection ""model.mimic.apsiii""",109348,Thread-1,2022-07-18T00:18:32.707614Z
E016,,debug,"On model.mimic.apsiii: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.apsiii""} */
drop table if exists ""postgres"".""public"".""apsiii__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:18:32.707858Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:32.710977Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:18:32.714119Z
E010,,debug,On model.mimic.apsiii: Close,109348,Thread-1,2022-07-18T00:18:32.714403Z
Q012,4,info,103 of 107 OK created table model public.apsiii ................................ [[32mSELECT 61532[0m in 4.14s],109348,Thread-1,2022-07-18T00:18:32.715448Z,table,null,apsiii,severityscores/apsiii.sql,2022-07-18T00:18:28.574965,compiling,model,,,
Q024,4.138588905334473,debug,Finished running node model.mimic.apsiii,109348,Thread-1,2022-07-18T00:18:32.716189Z,table,2022-07-18T00:18:32.716007,apsiii,severityscores/apsiii.sql,2022-07-18T00:18:28.574965,success,model,,,
Q023,,debug,Began running node model.mimic.oasis,109348,Thread-1,2022-07-18T00:18:32.716961Z,table,null,oasis,severityscores/oasis.sql,2022-07-18T00:18:32.716891,started,model,,,
Q033,,info,104 of 107 START table model public.oasis ...................................... [RUN],109348,Thread-1,2022-07-18T00:18:32.717473Z,table,null,oasis,severityscores/oasis.sql,2022-07-18T00:18:32.716891,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.oasis""",109348,Thread-1,2022-07-18T00:18:32.718485Z
Q030,,debug,Began compiling node model.mimic.oasis,109348,Thread-1,2022-07-18T00:18:32.719145Z,table,null,oasis,severityscores/oasis.sql,2022-07-18T00:18:32.716891,compiling,model,,,
Q027,,debug,Compiling model.mimic.oasis,109348,Thread-1,2022-07-18T00:18:32.719459Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.oasis""",109348,Thread-1,2022-07-18T00:18:32.723518Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:18:32.724584Z
Q031,,debug,Began executing node model.mimic.oasis,109348,Thread-1,2022-07-18T00:18:32.724964Z,table,null,oasis,severityscores/oasis.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.oasis""",109348,Thread-1,2022-07-18T00:18:32.734403Z
E015,,debug,"Using postgres connection ""model.mimic.oasis""",109348,Thread-1,2022-07-18T00:18:32.735153Z
E016,,debug,On model.mimic.oasis: BEGIN,109348,Thread-1,2022-07-18T00:18:32.735431Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:18:32.735643Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:18:32.744401Z
E015,,debug,"Using postgres connection ""model.mimic.oasis""",109348,Thread-1,2022-07-18T00:18:32.744674Z
E016,,debug,"On model.mimic.oasis: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.oasis""} */


  create  table ""postgres"".""public"".""oasis__dbt_tmp""
  as (
    -- ------------------------------------------------------------------
-- Title: Oxford Acute Severity of Illness Score (oasis)
-- This query extracts the Oxford acute severity of illness score.
-- This score is a measure of severity of illness for patients in the ICU.
-- The score is calculated on the first day of each ICU patients' stay.
-- ------------------------------------------------------------------

-- Reference for OASIS:
--    Johnson, Alistair EW, Andrew A. Kramer, and Gari D. Clifford.
--    ""A new severity of illness scale using a subset of acute physiology and chronic health evaluation data elements shows comparable predictive accuracy*.""
--    Critical care medicine 41, no. 7 (2013): 1711-1718.

-- Variables used in OASIS:
--  Heart rate, GCS, MAP, Temperature, Respiratory rate, Ventilation status (sourced FROM chartevents)
--  Urine output (sourced from OUTPUTEVENTS)
--  Elective surgery (sourced FROM admissions and SERVICES)
--  Pre-ICU in-hospital length of stay (sourced FROM admissions and ICUSTAYS)
--  Age (sourced FROM patients)

-- The following views are required to run this query:
--  1) urine_output_first_day - generated by urine-output-first-day.sql
--  2) vent_first_day - generated by ventilated-first-day.sql
--  3) vitals_first_day - generated by vitals-first-day.sql
--  4) gcs_first_day - generated by gcs-first-day.sql


-- Regarding missing values:
--  The ventilation flag is always 0/1. It cannot be missing, since VENT=0 if no data is found for vent settings.

-- Note:
--  The score is calculated for *all* ICU patients, with the assumption that the user will subselect appropriate ICUSTAY_IDs.
--  For example, the score is calculated for neonates, but it is likely inappropriate to actually use the score values for these patients.


with surgflag as
(
  select ie.icustay_id
    , max(case
        when lower(curr_service) like '%surg%' then 1
        when curr_service = 'ORTHO' then 1
    else 0 end) as surgical
  FROM icustays ie
  left join services se
    on ie.hadm_id = se.hadm_id
    and se.transfertime < DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
  group by ie.icustay_id
)
, cohort as
(
select ie.subject_id, ie.hadm_id, ie.icustay_id
      , ie.intime
      , ie.outtime
      , adm.deathtime
      -- , DATETIME_DIFF(ie.intime, adm.admittime, MINUTE) as preiculos
      , EXTRACT(MINUTE FROM ie.intime-adm.admittime) as preiculos
      , EXTRACT(YEAR FROM ie.intime-pat.dob) as age
      -- , DATETIME_DIFF(ie.intime, pat.dob, `YEAR`) as age
      , gcs.mingcs
      , vital.heartrate_max
      , vital.heartrate_min
      , vital.meanbp_max
      , vital.meanbp_min
      , vital.resprate_max
      , vital.resprate_min
      , vital.tempc_max
      , vital.tempc_min
      , vent.vent as mechvent
      , uo.urineoutput

      , case
          when adm.ADMISSION_TYPE = 'ELECTIVE' and sf.surgical = 1
            then 1
          when adm.ADMISSION_TYPE is null or sf.surgical is null
            then null
          else 0
        end as electivesurgery

      -- age group
      , case
        when DATETIME_DIFF(ie.intime, pat.dob, 'YEAR') <= 1 then 'neonate'
        when DATETIME_DIFF(ie.intime, pat.dob, 'YEAR') <= 15 then 'middle'
        -- when EXTRACT(YEAR FROM ie.intime-pat.dob) <= 1 then 'neonate'
        -- when EXTRACT(YEAR FROM ie.intime-pat.dob) <= 15 then 'middle'
        else 'adult' end as icustay_age_group

      -- mortality flags
      , case
          when adm.deathtime between ie.intime and ie.outtime
            then 1
          when adm.deathtime <= ie.intime -- sometimes there are typographical errors in the death date
            then 1
          when adm.dischtime <= ie.outtime and adm.discharge_location = 'DEAD/EXPIRED'
            then 1
          else 0 end
        as icustay_expire_flag
      , adm.hospital_expire_flag
FROM icustays ie
inner join admissions adm
  on ie.hadm_id = adm.hadm_id
inner join patients pat
  on ie.subject_id = pat.subject_id
left join surgflag sf
  on ie.icustay_id = sf.icustay_id
-- join to custom tables to get more data....
left join ""postgres"".""public"".""gcs_first_day"" gcs
  on ie.icustay_id = gcs.icustay_id
left join ""postgres"".""public"".""vitals_first_day"" vital
  on ie.icustay_id = vital.icustay_id
left join ""postgres"".""public"".""urine_output_first_day"" uo
  on ie.icustay_id = uo.icustay_id
left join ""postgres"".""public"".""ventilation_first_day"" vent
  on ie.icustay_id = vent.icustay_id
)
, scorecomp as
(
select co.subject_id, co.hadm_id, co.icustay_id
, co.icustay_age_group
, co.icustay_expire_flag
, co.hospital_expire_flag

-- Below code calculates the component scores needed for oasis
, case when preiculos is null then null
     when preiculos < 10.2 then 5
     when preiculos < 297 then 3
     when preiculos < 1440 then 0
     when preiculos < 18708 then 1
     else 2 end as preiculos_score
,  case when age is null then null
      when age < 24 then 0
      when age <= 53 then 3
      when age <= 77 then 6
      when age <= 89 then 9
      when age >= 90 then 7
      else 0 end as age_score
,  case when mingcs is null then null
      when mingcs <= 7 then 10
      when mingcs < 14 then 4
      when mingcs = 14 then 3
      else 0 end as gcs_score
,  case when heartrate_max is null then null
      when heartrate_max > 125 then 6
      when heartrate_min < 33 then 4
      when heartrate_max >= 107 and heartrate_max <= 125 then 3
      when heartrate_max >= 89 and heartrate_max <= 106 then 1
      else 0 end as heartrate_score
,  case when meanbp_min is null then null
      when meanbp_min < 20.65 then 4
      when meanbp_min < 51 then 3
      when meanbp_max > 143.44 then 3
      when meanbp_min >= 51 and meanbp_min < 61.33 then 2
      else 0 end as meanbp_score
,  case when resprate_min is null then null
      when resprate_min <   6 then 10
      when resprate_max >  44 then  9
      when resprate_max >  30 then  6
      when resprate_max >  22 then  1
      when resprate_min <  13 then 1 else 0
      end as resprate_score
,  case when tempc_max is null then null
      when tempc_max > 39.88 then 6
      when tempc_min >= 33.22 and tempc_min <= 35.93 then 4
      when tempc_max >= 33.22 and tempc_max <= 35.93 then 4
      when tempc_min < 33.22 then 3
      when tempc_min > 35.93 and tempc_min <= 36.39 then 2
      when tempc_max >= 36.89 and tempc_max <= 39.88 then 2
      else 0 end as temp_score
,  case when UrineOutput is null then null
      when UrineOutput < 671.09 then 10
      when UrineOutput > 6896.80 then 8
      when UrineOutput >= 671.09
       and UrineOutput <= 1426.99 then 5
      when UrineOutput >= 1427.00
       and UrineOutput <= 2544.14 then 1
      else 0 end as urineoutput_score
,  case when mechvent is null then null
      when mechvent = 1 then 9
      else 0 end as mechvent_score
,  case when electivesurgery is null then null
      when electivesurgery = 1 then 0
      else 6 end as electivesurgery_score


-- The below code gives the component associated with each score
-- This is not needed to calculate oasis, but provided for user convenience.
-- If both the min/max are in the normal range (score of 0), then the average value is stored.
, preiculos
, age
, mingcs as gcs
,  case when heartrate_max is null then null
      when heartrate_max > 125 then heartrate_max
      when heartrate_min < 33 then heartrate_min
      when heartrate_max >= 107 and heartrate_max <= 125 then heartrate_max
      when heartrate_max >= 89 and heartrate_max <= 106 then heartrate_max
      else (heartrate_min+heartrate_max)/2 end as heartrate
,  case when meanbp_min is null then null
      when meanbp_min < 20.65 then meanbp_min
      when meanbp_min < 51 then meanbp_min
      when meanbp_max > 143.44 then meanbp_max
      when meanbp_min >= 51 and meanbp_min < 61.33 then meanbp_min
      else (meanbp_min+meanbp_max)/2 end as meanbp
,  case when resprate_min is null then null
      when resprate_min <   6 then resprate_min
      when resprate_max >  44 then resprate_max
      when resprate_max >  30 then resprate_max
      when resprate_max >  22 then resprate_max
      when resprate_min <  13 then resprate_min
      else (resprate_min+resprate_max)/2 end as resprate
,  case when tempc_max is null then null
      when tempc_max > 39.88 then tempc_max
      when tempc_min >= 33.22 and tempc_min <= 35.93 then tempc_min
      when tempc_max >= 33.22 and tempc_max <= 35.93 then tempc_max
      when tempc_min < 33.22 then tempc_min
      when tempc_min > 35.93 and tempc_min <= 36.39 then tempc_min
      when tempc_max >= 36.89 and tempc_max <= 39.88 then tempc_max
      else (tempc_min+tempc_max)/2 end as temp
,  UrineOutput
,  mechvent
,  electivesurgery
from cohort co
)
, score as
(
select s.*
    , coalesce(age_score,0)
    + coalesce(preiculos_score,0)
    + coalesce(gcs_score,0)
    + coalesce(heartrate_score,0)
    + coalesce(meanbp_score,0)
    + coalesce(resprate_score,0)
    + coalesce(temp_score,0)
    + coalesce(urineoutput_score,0)
    + coalesce(mechvent_score,0)
    + coalesce(electivesurgery_score,0)
    as oasis
from scorecomp s
)
select
  subject_id, hadm_id, icustay_id
  , icustay_age_group
  , hospital_expire_flag
  , icustay_expire_flag
  , oasis
  -- Calculate the probability of in-hospital mortality
  , 1 / (1 + exp(- (-6.1746 + 0.1275*(oasis) ))) as oasis_PROB
  , age, age_score
  , preiculos, preiculos_score
  , gcs, gcs_score
  , heartrate, heartrate_score
  , meanbp, meanbp_score
  , resprate, resprate_score
  , temp, temp_score
  , urineoutput, urineoutput_score
  , mechvent, mechvent_score
  , electivesurgery, electivesurgery_score
from score
order by icustay_id
  );",109348,Thread-1,2022-07-18T00:18:32.745066Z
E017,,debug,SQL status: SELECT 61532 in 1.1 seconds,109348,Thread-1,2022-07-18T00:18:33.847046Z
E015,,debug,"Using postgres connection ""model.mimic.oasis""",109348,Thread-1,2022-07-18T00:18:33.852977Z
E016,,debug,"On model.mimic.oasis: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.oasis""} */
alter table ""postgres"".""public"".""oasis"" rename to ""oasis__dbt_backup""",109348,Thread-1,2022-07-18T00:18:33.853618Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:33.855335Z
E015,,debug,"Using postgres connection ""model.mimic.oasis""",109348,Thread-1,2022-07-18T00:18:33.860688Z
E016,,debug,"On model.mimic.oasis: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.oasis""} */
alter table ""postgres"".""public"".""oasis__dbt_tmp"" rename to ""oasis""",109348,Thread-1,2022-07-18T00:18:33.860925Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:33.861468Z
E018,,debug,On model.mimic.oasis: COMMIT,109348,Thread-1,2022-07-18T00:18:33.864455Z
E015,,debug,"Using postgres connection ""model.mimic.oasis""",109348,Thread-1,2022-07-18T00:18:33.864674Z
E016,,debug,On model.mimic.oasis: COMMIT,109348,Thread-1,2022-07-18T00:18:33.865051Z
E017,,debug,SQL status: COMMIT in 0.01 seconds,109348,Thread-1,2022-07-18T00:18:33.878127Z
E015,,debug,"Using postgres connection ""model.mimic.oasis""",109348,Thread-1,2022-07-18T00:18:33.881202Z
E016,,debug,"On model.mimic.oasis: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.oasis""} */
drop table if exists ""postgres"".""public"".""oasis__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:18:33.881480Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:33.884445Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:18:33.889218Z
E010,,debug,On model.mimic.oasis: Close,109348,Thread-1,2022-07-18T00:18:33.889859Z
Q012,1,info,104 of 107 OK created table model public.oasis ................................. [[32mSELECT 61532[0m in 1.17s],109348,Thread-1,2022-07-18T00:18:33.891114Z,table,null,oasis,severityscores/oasis.sql,2022-07-18T00:18:32.716891,compiling,model,,,
Q024,1.172760248184204,debug,Finished running node model.mimic.oasis,109348,Thread-1,2022-07-18T00:18:33.891871Z,table,2022-07-18T00:18:33.891699,oasis,severityscores/oasis.sql,2022-07-18T00:18:32.716891,success,model,,,
Q023,,debug,Began running node model.mimic.saps,109348,Thread-1,2022-07-18T00:18:33.892573Z,table,null,saps,severityscores/saps.sql,2022-07-18T00:18:33.892497,started,model,,,
Q033,,info,105 of 107 START table model public.saps ....................................... [RUN],109348,Thread-1,2022-07-18T00:18:33.893095Z,table,null,saps,severityscores/saps.sql,2022-07-18T00:18:33.892497,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.saps""",109348,Thread-1,2022-07-18T00:18:33.893895Z
Q030,,debug,Began compiling node model.mimic.saps,109348,Thread-1,2022-07-18T00:18:33.894222Z,table,null,saps,severityscores/saps.sql,2022-07-18T00:18:33.892497,compiling,model,,,
Q027,,debug,Compiling model.mimic.saps,109348,Thread-1,2022-07-18T00:18:33.894628Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.saps""",109348,Thread-1,2022-07-18T00:18:33.899569Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:18:33.900292Z
Q031,,debug,Began executing node model.mimic.saps,109348,Thread-1,2022-07-18T00:18:33.900645Z,table,null,saps,severityscores/saps.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.saps""",109348,Thread-1,2022-07-18T00:18:33.912015Z
E015,,debug,"Using postgres connection ""model.mimic.saps""",109348,Thread-1,2022-07-18T00:18:33.912779Z
E016,,debug,On model.mimic.saps: BEGIN,109348,Thread-1,2022-07-18T00:18:33.913055Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:18:33.913198Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:18:33.919053Z
E015,,debug,"Using postgres connection ""model.mimic.saps""",109348,Thread-1,2022-07-18T00:18:33.919359Z
E016,,debug,"On model.mimic.saps: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.saps""} */


  create  table ""postgres"".""public"".""saps__dbt_tmp""
  as (
    -- ------------------------------------------------------------------
-- Title: Simplified Acute Physiology Score (SAPS)
-- This query extracts the simplified acute physiology score.
-- This score is a measure of patient severity of illness.
-- The score is calculated on the first day of each ICU patients' stay.
-- ------------------------------------------------------------------

-- Reference for SAPS:
--    Jean-Roger Le Gall, Philippe Loirat, Annick Alperovitch, Paul Glaser, Claude Granthil,
--    Daniel Mathieu, Philippe Mercier, Remi Thomas, and Daniel Villers.
--    ""A simplified acute physiology score for ICU patients.""
--    Critical care medicine 12, no. 11 (1984): 975-977.

-- Variables used in SAPS:
--  Age, GCS
--  VITALS: Heart rate, systolic blood pressure, temperature, respiration rate
--  FLAGS: ventilation/cpap
--  IO: urine output
--  LABS: blood urea nitrogen, hematocrit, WBC, glucose, potassium, sodium, HCO3

-- The following views are required to run this query:
--  1) urine_output_first_day - generated by urine-output-first-day.sql
--  2) vent_first_day - generated by ventilated-first-day.sql
--  3) vitals_first_day - generated by vitals-first-day.sql
--  4) gcs_first_day - generated by gcs-first-day.sql
--  5) labs_first_day - generated by labs-first-day.sql

-- Note:
--  The score is calculated for *all* ICU patients, with the assumption that the user will subselect appropriate ICUSTAY_IDs.
--  For example, the score is calculated for neonates, but it is likely inappropriate to actually use the score values for these patients.

-- extract CPAP from the ""Oxygen Delivery Device"" fields
with cpap as
(
  select ie.icustay_id
  , max(CASE
        WHEN lower(ce.value) LIKE '%cpap%' THEN 1
        WHEN lower(ce.value) LIKE '%bipap mask%' THEN 1
      else 0 end) as cpap
  FROM icustays ie
  inner join chartevents ce
    on ie.icustay_id = ce.icustay_id
    and ce.charttime between ie.intime and DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
  where itemid in
  (
    -- TODO: when metavision data import fixed, check the values in 226732 match the value clause below
    467, 469, 226732
  )
  and (lower(ce.value) LIKE '%cpap%' or lower(ce.value) LIKE '%bipap mask%')
  -- exclude rows marked as error
  AND (ce.error IS NULL OR ce.error = 0)
  group by ie.icustay_id
)
, cohort as
(
select ie.subject_id, ie.hadm_id, ie.icustay_id
      , ie.intime
      , ie.outtime

      -- the casts ensure the result is numeric.. we could equally extract EPOCH from the interval
      -- however this code works in Oracle and Postgres
      , DATETIME_DIFF(ie.intime, pat.dob, 'YEAR') as age
      , gcs.mingcs
      , vital.heartrate_max
      , vital.heartrate_min
      , vital.sysbp_max
      , vital.sysbp_min
      , vital.resprate_max
      , vital.resprate_min
      , vital.tempc_max
      , vital.tempc_min

      , coalesce(vital.glucose_max, labs.glucose_max) as glucose_max
      , coalesce(vital.glucose_min, labs.glucose_min) as glucose_min

      , labs.bun_max
      , labs.bun_min
      , labs.hematocrit_max
      , labs.hematocrit_min
      , labs.wbc_max
      , labs.wbc_min
      , labs.sodium_max
      , labs.sodium_min
      , labs.potassium_max
      , labs.potassium_min
      , labs.bicarbonate_max
      , labs.bicarbonate_min

      , vent.vent as mechvent
      , uo.urineoutput

      , cp.cpap

FROM icustays ie
inner join admissions adm
  on ie.hadm_id = adm.hadm_id
inner join patients pat
  on ie.subject_id = pat.subject_id

-- join to above view to get CPAP
left join cpap cp
  on ie.icustay_id = cp.icustay_id

-- join to custom tables to get more data....
left join ""postgres"".""public"".""gcs_first_day"" gcs
  on ie.icustay_id = gcs.icustay_id
left join ""postgres"".""public"".""vitals_first_day"" vital
  on ie.icustay_id = vital.icustay_id
left join ""postgres"".""public"".""urine_output_first_day"" uo
  on ie.icustay_id = uo.icustay_id
left join ""postgres"".""public"".""ventilation_first_day"" vent
  on ie.icustay_id = vent.icustay_id
left join ""postgres"".""public"".""labs_first_day"" labs
  on ie.icustay_id = labs.icustay_id
)
, scorecomp as
(
select
  cohort.*
  -- Below code calculates the component scores needed for SAPS
  , case
      when age is null then null
      when age <= 45 then 0
      when age <= 55 then 1
      when age <= 65 then 2
      when age <= 75 then 3
      when age >  75 then 4
    end as age_score
  , case
      when heartrate_max is null then null
      when heartrate_max >= 180 then 4
      when heartrate_min < 40 then 4
      when heartrate_max >= 140 then 3
      when heartrate_min <= 54 then 3
      when heartrate_max >= 110 then 2
      when heartrate_min <= 69 then 2
      when heartrate_max >= 70 and heartrate_max <= 109
        and heartrate_min >= 70 and heartrate_min <= 109
      then 0
    end as hr_score
  , case
      when sysbp_min is null then null
      when sysbp_max >= 190 then 4
      when sysbp_min < 55 then 4
      when sysbp_max >= 150 then 2
      when sysbp_min <= 79 then 2
      when sysbp_max >= 80 and sysbp_max <= 149
        and sysbp_min >= 80 and sysbp_min <= 149
        then 0
    end as sysbp_score

  , case
      when tempc_max is null then null
      when tempc_max >= 41.0 then 4
      when tempc_min <  30.0 then 4
      when tempc_max >= 39.0 then 3
      when tempc_min <= 31.9  then 3
      when tempc_min <= 33.9  then 2
      when tempc_max >  38.4 then 1
      when tempc_min <  36.0  then 1
      when tempc_max >= 36.0 and tempc_max <= 38.4
       and tempc_min >= 36.0 and tempc_min <= 38.4
        then 0
    end as temp_score

  , case
      when resprate_min is null then null
      when resprate_max >= 50 then 4
      when resprate_min <  6 then 4
      when resprate_max >= 35 then 3
      when resprate_min <= 9 then 2
      when resprate_max >= 25 then 1
      when resprate_min <= 11 then 1
      when  resprate_max >= 12 and resprate_max <= 24
        and resprate_min >= 12 and resprate_min <= 24
          then 0
      end as resp_score

  , case
      when coalesce(mechvent,cpap) is null then null
      when cpap = 1 then 3
      when mechvent = 1 then 3
      else 0
    end as vent_score

  , case
      when UrineOutput is null then null
      when UrineOutput >  5000.0 then 2
      when UrineOutput >= 3500.0 then 1
      when UrineOutput >=  700.0 then 0
      when UrineOutput >=  500.0 then 2
      when UrineOutput >=  200.0 then 3
      when UrineOutput <   200.0 then 4
    end as uo_score

  , case
      when bun_max is null then null
      when bun_max >= 55.0 then 4
      when bun_max >= 36.0 then 3
      when bun_max >= 29.0 then 2
      when bun_max >= 7.50 then 1
      when bun_min < 3.5 then 1
      when  bun_max >= 3.5 and bun_max < 7.5
        and bun_min >= 3.5 and bun_min < 7.5
          then 0
    end as bun_score

  , case
      when hematocrit_max is null then null
      when hematocrit_max >= 60.0 then 4
      when hematocrit_min <  20.0 then 4
      when hematocrit_max >= 50.0 then 2
      when hematocrit_min < 30.0 then 2
      when hematocrit_max >= 46.0 then 1
      when  hematocrit_max >= 30.0 and hematocrit_max < 46.0
        and hematocrit_min >= 30.0 and hematocrit_min < 46.0
          then 0
      end as hematocrit_score

  , case
      when wbc_max is null then null
      when wbc_max >= 40.0 then 4
      when wbc_min <   1.0 then 4
      when wbc_max >= 20.0 then 2
      when wbc_min <   3.0 then 2
      when wbc_max >= 15.0 then 1
      when wbc_max >=  3.0 and wbc_max < 15.0
       and wbc_min >=  3.0 and wbc_min < 15.0
        then 0
    end as wbc_score

  , case
      when glucose_max is null then null
      when glucose_max >= 44.5 then 4
      when glucose_min <   1.6 then 4
      when glucose_max >= 27.8 then 3
      when glucose_min <   2.8 then 3
      when glucose_min <   3.9 then 2
      when glucose_max >= 14.0 then 1
      when glucose_max >=  3.9 and glucose_max < 14.0
       and glucose_min >=  3.9 and glucose_min < 14.0
        then 0
      end as glucose_score

  , case
      when potassium_max is null then null
      when potassium_max >= 7.0 then 4
      when potassium_min <  2.5 then 4
      when potassium_max >= 6.0 then 3
      when potassium_min <  3.0 then 2
      when potassium_max >= 5.5 then 1
      when potassium_min <  3.5 then 1
      when potassium_max >= 3.5 and potassium_max < 5.5
       and potassium_min >= 3.5 and potassium_min < 5.5
        then 0
      end as potassium_score

  , case
      when sodium_max is null then null
      when sodium_max >= 180 then 4
      when sodium_min  < 110 then 4
      when sodium_max >= 161 then 3
      when sodium_min  < 120 then 3
      when sodium_max >= 156 then 2
      when sodium_min  < 130 then 2
      when sodium_max >= 151 then 1
      when sodium_max >= 130 and sodium_max < 151
       and sodium_min >= 130 and sodium_min < 151
        then 0
      end as sodium_score

  , case
      when bicarbonate_max is null then null
      when bicarbonate_min <   5.0 then 4
      when bicarbonate_max >= 40.0 then 3
      when bicarbonate_min <  10.0 then 3
      when bicarbonate_max >= 30.0 then 1
      when bicarbonate_min <  20.0 then 1
      when bicarbonate_max >= 20.0 and bicarbonate_max < 30.0
       and bicarbonate_min >= 20.0 and bicarbonate_min < 30.0
          then 0
      end as bicarbonate_score

   , case
      when mingcs is null then null
        when mingcs <  3 then null -- erroneous value/on trach
        when mingcs =  3 then 4
        when mingcs <  7 then 3
        when mingcs < 10 then 2
        when mingcs < 13 then 1
        when mingcs >= 13
         and mingcs <= 15
          then 0
        end as gcs_score
from cohort
)
select ie.subject_id, ie.hadm_id, ie.icustay_id
-- coalesce statements impute normal score of zero if data element is missing
, coalesce(age_score,0)
+ coalesce(hr_score,0)
+ coalesce(sysbp_score,0)
+ coalesce(resp_score,0)
+ coalesce(temp_score,0)
+ coalesce(uo_score,0)
+ coalesce(vent_score,0)
+ coalesce(bun_score,0)
+ coalesce(hematocrit_score,0)
+ coalesce(wbc_score,0)
+ coalesce(glucose_score,0)
+ coalesce(potassium_score,0)
+ coalesce(sodium_score,0)
+ coalesce(bicarbonate_score,0)
+ coalesce(gcs_score,0)
  as SAPS
, age_score
, hr_score
, sysbp_score
, resp_score
, temp_score
, uo_score
, vent_score
, bun_score
, hematocrit_score
, wbc_score
, glucose_score
, potassium_score
, sodium_score
, bicarbonate_score
, gcs_score

FROM icustays ie
left join scorecomp s
  on ie.icustay_id = s.icustay_id
order by ie.icustay_id
  );",109348,Thread-1,2022-07-18T00:18:33.919659Z
E017,,debug,SQL status: SELECT 61532 in 0.53 seconds,109348,Thread-1,2022-07-18T00:18:34.451311Z
E015,,debug,"Using postgres connection ""model.mimic.saps""",109348,Thread-1,2022-07-18T00:18:34.458519Z
E016,,debug,"On model.mimic.saps: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.saps""} */
alter table ""postgres"".""public"".""saps"" rename to ""saps__dbt_backup""",109348,Thread-1,2022-07-18T00:18:34.458761Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:34.459600Z
E015,,debug,"Using postgres connection ""model.mimic.saps""",109348,Thread-1,2022-07-18T00:18:34.463877Z
E016,,debug,"On model.mimic.saps: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.saps""} */
alter table ""postgres"".""public"".""saps__dbt_tmp"" rename to ""saps""",109348,Thread-1,2022-07-18T00:18:34.464101Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:34.465022Z
E018,,debug,On model.mimic.saps: COMMIT,109348,Thread-1,2022-07-18T00:18:34.467993Z
E015,,debug,"Using postgres connection ""model.mimic.saps""",109348,Thread-1,2022-07-18T00:18:34.468242Z
E016,,debug,On model.mimic.saps: COMMIT,109348,Thread-1,2022-07-18T00:18:34.468607Z
E017,,debug,SQL status: COMMIT in 0.01 seconds,109348,Thread-1,2022-07-18T00:18:34.475560Z
E015,,debug,"Using postgres connection ""model.mimic.saps""",109348,Thread-1,2022-07-18T00:18:34.478477Z
E016,,debug,"On model.mimic.saps: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.saps""} */
drop table if exists ""postgres"".""public"".""saps__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:18:34.478707Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:34.480844Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:18:34.483769Z
E010,,debug,On model.mimic.saps: Close,109348,Thread-1,2022-07-18T00:18:34.484020Z
Q012,0,info,105 of 107 OK created table model public.saps .................................. [[32mSELECT 61532[0m in 0.59s],109348,Thread-1,2022-07-18T00:18:34.485056Z,table,null,saps,severityscores/saps.sql,2022-07-18T00:18:33.892497,compiling,model,,,
Q024,0.5914669036865234,debug,Finished running node model.mimic.saps,109348,Thread-1,2022-07-18T00:18:34.485752Z,table,2022-07-18T00:18:34.485456,saps,severityscores/saps.sql,2022-07-18T00:18:33.892497,success,model,,,
Q023,,debug,Began running node model.mimic.kdigo_stages_48hr,109348,Thread-1,2022-07-18T00:18:34.486400Z,table,null,kdigo_stages_48hr,organfailure/kdigo_stages_48hr.sql,2022-07-18T00:18:34.486240,started,model,,,
Q033,,info,106 of 107 START table model public.kdigo_stages_48hr .......................... [RUN],109348,Thread-1,2022-07-18T00:18:34.487052Z,table,null,kdigo_stages_48hr,organfailure/kdigo_stages_48hr.sql,2022-07-18T00:18:34.486240,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.kdigo_stages_48hr""",109348,Thread-1,2022-07-18T00:18:34.487910Z
Q030,,debug,Began compiling node model.mimic.kdigo_stages_48hr,109348,Thread-1,2022-07-18T00:18:34.488347Z,table,null,kdigo_stages_48hr,organfailure/kdigo_stages_48hr.sql,2022-07-18T00:18:34.486240,compiling,model,,,
Q027,,debug,Compiling model.mimic.kdigo_stages_48hr,109348,Thread-1,2022-07-18T00:18:34.488771Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.kdigo_stages_48hr""",109348,Thread-1,2022-07-18T00:18:34.494910Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:18:34.495960Z
Q031,,debug,Began executing node model.mimic.kdigo_stages_48hr,109348,Thread-1,2022-07-18T00:18:34.496254Z,table,null,kdigo_stages_48hr,organfailure/kdigo_stages_48hr.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.kdigo_stages_48hr""",109348,Thread-1,2022-07-18T00:18:34.506091Z
E015,,debug,"Using postgres connection ""model.mimic.kdigo_stages_48hr""",109348,Thread-1,2022-07-18T00:18:34.507194Z
E016,,debug,On model.mimic.kdigo_stages_48hr: BEGIN,109348,Thread-1,2022-07-18T00:18:34.507451Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:18:34.507687Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:18:34.513549Z
E015,,debug,"Using postgres connection ""model.mimic.kdigo_stages_48hr""",109348,Thread-1,2022-07-18T00:18:34.513972Z
E016,,debug,"On model.mimic.kdigo_stages_48hr: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.kdigo_stages_48hr""} */


  create  table ""postgres"".""public"".""kdigo_stages_48hr__dbt_tmp""
  as (
    -- This query checks if the patient had AKI during the first 48 hours of their ICU
-- stay according to the KDIGO guideline.
-- https://kdigo.org/wp-content/uploads/2016/10/KDIGO-2012-AKI-Guideline-English.pdf

-- get the worst staging of creatinine in the first 48 hours
WITH cr_aki AS
(
  SELECT
    k.icustay_id
    , k.charttime
    , k.creat
    , k.aki_stage_creat
    , ROW_NUMBER() OVER (PARTITION BY k.icustay_id ORDER BY k.aki_stage_creat DESC, k.creat DESC) AS rn
  FROM icustays ie
  INNER JOIN ""postgres"".""public"".""kdigo_stages"" k
    ON ie.icustay_id = k.icustay_id
  WHERE DATETIME_DIFF(k.charttime, ie.intime, 'HOUR') > -6
  AND DATETIME_DIFF(k.charttime, ie.intime, 'HOUR') <= 48
  AND k.aki_stage_creat IS NOT NULL
)
-- get the worst staging of urine output in the first 48 hours
, uo_aki AS
(
  SELECT
    k.icustay_id
    , k.charttime
    , k.uo_rt_6hr, k.uo_rt_12hr, k.uo_rt_24hr
    , k.aki_stage_uo
    , ROW_NUMBER() OVER 
    (
      PARTITION BY k.icustay_id
      ORDER BY k.aki_stage_uo DESC, k.uo_rt_24hr DESC, k.uo_rt_12hr DESC, k.uo_rt_6hr DESC
    ) AS rn
  FROM icustays ie
  INNER JOIN ""postgres"".""public"".""kdigo_stages"" k
    ON ie.icustay_id = k.icustay_id
  WHERE DATETIME_DIFF(k.charttime, ie.intime, 'HOUR') > -6
  AND DATETIME_DIFF(k.charttime, ie.intime, 'HOUR') <= 48
  AND k.aki_stage_uo IS NOT NULL
)
-- final table is aki_stage, include worst cr/uo for convenience
select
    ie.icustay_id
  , cr.charttime as charttime_creat
  , cr.creat
  , cr.aki_stage_creat
  , uo.charttime as charttime_uo
  , uo.uo_rt_6hr
  , uo.uo_rt_12hr
  , uo.uo_rt_24hr
  , uo.aki_stage_uo

  -- Classify AKI using both creatinine/urine output criteria
  , GREATEST(
      COALESCE(cr.aki_stage_creat, 0),
      COALESCE(uo.aki_stage_uo, 0)
    ) AS aki_stage_48hr
  , CASE WHEN cr.aki_stage_creat > 0 OR uo.aki_stage_uo > 0 THEN 1 ELSE 0 END AS aki_48hr

FROM icustays ie
LEFT JOIN cr_aki cr
  ON ie.icustay_id = cr.icustay_id
  AND cr.rn = 1
LEFT JOIN uo_aki uo
  ON ie.icustay_id = uo.icustay_id
  AND uo.rn = 1
order by ie.icustay_id
  );",109348,Thread-1,2022-07-18T00:18:34.514250Z
E017,,debug,SQL status: SELECT 61532 in 0.64 seconds,109348,Thread-1,2022-07-18T00:18:35.155689Z
E015,,debug,"Using postgres connection ""model.mimic.kdigo_stages_48hr""",109348,Thread-1,2022-07-18T00:18:35.160434Z
E016,,debug,"On model.mimic.kdigo_stages_48hr: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.kdigo_stages_48hr""} */
alter table ""postgres"".""public"".""kdigo_stages_48hr"" rename to ""kdigo_stages_48hr__dbt_backup""",109348,Thread-1,2022-07-18T00:18:35.160652Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:35.161478Z
E015,,debug,"Using postgres connection ""model.mimic.kdigo_stages_48hr""",109348,Thread-1,2022-07-18T00:18:35.169450Z
E016,,debug,"On model.mimic.kdigo_stages_48hr: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.kdigo_stages_48hr""} */
alter table ""postgres"".""public"".""kdigo_stages_48hr__dbt_tmp"" rename to ""kdigo_stages_48hr""",109348,Thread-1,2022-07-18T00:18:35.170494Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:35.172451Z
E018,,debug,On model.mimic.kdigo_stages_48hr: COMMIT,109348,Thread-1,2022-07-18T00:18:35.177478Z
E015,,debug,"Using postgres connection ""model.mimic.kdigo_stages_48hr""",109348,Thread-1,2022-07-18T00:18:35.178107Z
E016,,debug,On model.mimic.kdigo_stages_48hr: COMMIT,109348,Thread-1,2022-07-18T00:18:35.178558Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:35.180029Z
E015,,debug,"Using postgres connection ""model.mimic.kdigo_stages_48hr""",109348,Thread-1,2022-07-18T00:18:35.182235Z
E016,,debug,"On model.mimic.kdigo_stages_48hr: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.kdigo_stages_48hr""} */
drop table if exists ""postgres"".""public"".""kdigo_stages_48hr__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:18:35.182474Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:35.185329Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:18:35.191234Z
E010,,debug,On model.mimic.kdigo_stages_48hr: Close,109348,Thread-1,2022-07-18T00:18:35.191599Z
Q012,0,info,106 of 107 OK created table model public.kdigo_stages_48hr ..................... [[32mSELECT 61532[0m in 0.70s],109348,Thread-1,2022-07-18T00:18:35.192697Z,table,null,kdigo_stages_48hr,organfailure/kdigo_stages_48hr.sql,2022-07-18T00:18:34.486240,compiling,model,,,
Q024,0.704796552658081,debug,Finished running node model.mimic.kdigo_stages_48hr,109348,Thread-1,2022-07-18T00:18:35.193921Z,table,2022-07-18T00:18:35.193464,kdigo_stages_48hr,organfailure/kdigo_stages_48hr.sql,2022-07-18T00:18:34.486240,success,model,,,
Q023,,debug,Began running node model.mimic.kdigo_stages_7day,109348,Thread-1,2022-07-18T00:18:35.194673Z,table,null,kdigo_stages_7day,organfailure/kdigo_stages_7day.sql,2022-07-18T00:18:35.194575,started,model,,,
Q033,,info,107 of 107 START table model public.kdigo_stages_7day .......................... [RUN],109348,Thread-1,2022-07-18T00:18:35.195383Z,table,null,kdigo_stages_7day,organfailure/kdigo_stages_7day.sql,2022-07-18T00:18:35.194575,started,model,,,
E005,,debug,"Acquiring new postgres connection ""model.mimic.kdigo_stages_7day""",109348,Thread-1,2022-07-18T00:18:35.196100Z
Q030,,debug,Began compiling node model.mimic.kdigo_stages_7day,109348,Thread-1,2022-07-18T00:18:35.196297Z,table,null,kdigo_stages_7day,organfailure/kdigo_stages_7day.sql,2022-07-18T00:18:35.194575,compiling,model,,,
Q027,,debug,Compiling model.mimic.kdigo_stages_7day,109348,Thread-1,2022-07-18T00:18:35.196668Z
Q028,,debug,"Writing injected SQL for node ""model.mimic.kdigo_stages_7day""",109348,Thread-1,2022-07-18T00:18:35.199945Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:18:35.200519Z
Q031,,debug,Began executing node model.mimic.kdigo_stages_7day,109348,Thread-1,2022-07-18T00:18:35.200809Z,table,null,kdigo_stages_7day,organfailure/kdigo_stages_7day.sql,null,executing,model,,,
M012,,debug,"Writing runtime SQL for node ""model.mimic.kdigo_stages_7day""",109348,Thread-1,2022-07-18T00:18:35.211450Z
E015,,debug,"Using postgres connection ""model.mimic.kdigo_stages_7day""",109348,Thread-1,2022-07-18T00:18:35.212134Z
E016,,debug,On model.mimic.kdigo_stages_7day: BEGIN,109348,Thread-1,2022-07-18T00:18:35.212453Z
E037,,debug,"Opening a new connection, currently in state closed",109348,Thread-1,2022-07-18T00:18:35.212731Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,Thread-1,2022-07-18T00:18:35.219841Z
E015,,debug,"Using postgres connection ""model.mimic.kdigo_stages_7day""",109348,Thread-1,2022-07-18T00:18:35.220879Z
E016,,debug,"On model.mimic.kdigo_stages_7day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.kdigo_stages_7day""} */


  create  table ""postgres"".""public"".""kdigo_stages_7day__dbt_tmp""
  as (
    -- This query checks if the patient had AKI during the first 7 days of their ICU
-- stay according to the KDIGO guideline.
-- https://kdigo.org/wp-content/uploads/2016/10/KDIGO-2012-AKI-Guideline-English.pdf

-- get the worst staging of creatinine in the first 48 hours
WITH cr_aki AS
(
  SELECT
    k.icustay_id
    , k.charttime
    , k.creat
    , k.aki_stage_creat
    , ROW_NUMBER() OVER (PARTITION BY k.icustay_id ORDER BY k.aki_stage_creat DESC, k.creat DESC) AS rn
  FROM icustays ie
  INNER JOIN ""postgres"".""public"".""kdigo_stages"" k
    ON ie.icustay_id = k.icustay_id
  WHERE DATETIME_DIFF(k.charttime, ie.intime, 'HOUR') > -6
  AND DATETIME_DIFF(k.charttime, ie.intime, 'DAY') <= 7
  AND k.aki_stage_creat IS NOT NULL
)
-- get the worst staging of urine output in the first 48 hours
, uo_aki AS
(
  SELECT
    k.icustay_id
    , k.charttime
    , k.uo_rt_6hr, k.uo_rt_12hr, k.uo_rt_24hr
    , k.aki_stage_uo
    , ROW_NUMBER() OVER 
    (
      PARTITION BY k.icustay_id
      ORDER BY k.aki_stage_uo DESC, k.uo_rt_24hr DESC, k.uo_rt_12hr DESC, k.uo_rt_6hr DESC
    ) AS rn
  FROM icustays ie
  INNER JOIN ""postgres"".""public"".""kdigo_stages"" k
    ON ie.icustay_id = k.icustay_id
  WHERE DATETIME_DIFF(k.charttime, ie.intime, 'HOUR') > -6
  AND DATETIME_DIFF(k.charttime, ie.intime, 'DAY') <= 7
  AND k.aki_stage_uo IS NOT NULL
)
-- final table is aki_stage, include worst cr/uo for convenience
select
    ie.icustay_id
  , cr.charttime as charttime_creat
  , cr.creat
  , cr.aki_stage_creat
  , uo.charttime as charttime_uo
  , uo.uo_rt_6hr
  , uo.uo_rt_12hr
  , uo.uo_rt_24hr
  , uo.aki_stage_uo

  -- Classify AKI using both creatinine/urine output criteria
  , GREATEST(
      COALESCE(cr.aki_stage_creat, 0),
      COALESCE(uo.aki_stage_uo, 0)
    ) AS aki_stage_7day
  , CASE WHEN cr.aki_stage_creat > 0 OR uo.aki_stage_uo > 0 THEN 1 ELSE 0 END AS aki_7day

FROM icustays ie
LEFT JOIN cr_aki cr
  ON ie.icustay_id = cr.icustay_id
  AND cr.rn = 1
LEFT JOIN uo_aki uo
  ON ie.icustay_id = uo.icustay_id
  AND uo.rn = 1
order by ie.icustay_id
  );",109348,Thread-1,2022-07-18T00:18:35.221342Z
E017,,debug,SQL status: SELECT 61532 in 0.54 seconds,109348,Thread-1,2022-07-18T00:18:35.763737Z
E015,,debug,"Using postgres connection ""model.mimic.kdigo_stages_7day""",109348,Thread-1,2022-07-18T00:18:35.768222Z
E016,,debug,"On model.mimic.kdigo_stages_7day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.kdigo_stages_7day""} */
alter table ""postgres"".""public"".""kdigo_stages_7day"" rename to ""kdigo_stages_7day__dbt_backup""",109348,Thread-1,2022-07-18T00:18:35.768515Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:35.769770Z
E015,,debug,"Using postgres connection ""model.mimic.kdigo_stages_7day""",109348,Thread-1,2022-07-18T00:18:35.774026Z
E016,,debug,"On model.mimic.kdigo_stages_7day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.kdigo_stages_7day""} */
alter table ""postgres"".""public"".""kdigo_stages_7day__dbt_tmp"" rename to ""kdigo_stages_7day""",109348,Thread-1,2022-07-18T00:18:35.774264Z
E017,,debug,SQL status: ALTER TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:35.775134Z
E018,,debug,On model.mimic.kdigo_stages_7day: COMMIT,109348,Thread-1,2022-07-18T00:18:35.778492Z
E015,,debug,"Using postgres connection ""model.mimic.kdigo_stages_7day""",109348,Thread-1,2022-07-18T00:18:35.778787Z
E016,,debug,On model.mimic.kdigo_stages_7day: COMMIT,109348,Thread-1,2022-07-18T00:18:35.779047Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:35.782296Z
E015,,debug,"Using postgres connection ""model.mimic.kdigo_stages_7day""",109348,Thread-1,2022-07-18T00:18:35.785015Z
E016,,debug,"On model.mimic.kdigo_stages_7day: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.kdigo_stages_7day""} */
drop table if exists ""postgres"".""public"".""kdigo_stages_7day__dbt_backup"" cascade",109348,Thread-1,2022-07-18T00:18:35.785228Z
E017,,debug,SQL status: DROP TABLE in 0.0 seconds,109348,Thread-1,2022-07-18T00:18:35.787538Z
Z010,,debug,finished collecting timing info,109348,Thread-1,2022-07-18T00:18:35.790425Z
E010,,debug,On model.mimic.kdigo_stages_7day: Close,109348,Thread-1,2022-07-18T00:18:35.790685Z
Q012,0,info,107 of 107 OK created table model public.kdigo_stages_7day ..................... [[32mSELECT 61532[0m in 0.60s],109348,Thread-1,2022-07-18T00:18:35.791735Z,table,null,kdigo_stages_7day,organfailure/kdigo_stages_7day.sql,2022-07-18T00:18:35.194575,compiling,model,,,
Q024,0.5956683158874512,debug,Finished running node model.mimic.kdigo_stages_7day,109348,Thread-1,2022-07-18T00:18:35.792527Z,table,2022-07-18T00:18:35.792317,kdigo_stages_7day,organfailure/kdigo_stages_7day.sql,2022-07-18T00:18:35.194575,success,model,,,
E005,,debug,"Acquiring new postgres connection ""master""",109348,MainThread,2022-07-18T00:18:35.795458Z
E015,,debug,"Using postgres connection ""master""",109348,MainThread,2022-07-18T00:18:35.796061Z
E016,,debug,On master: BEGIN,109348,MainThread,2022-07-18T00:18:35.796416Z
E037,,debug,"Opening a new connection, currently in state closed",109348,MainThread,2022-07-18T00:18:35.796790Z
E017,,debug,SQL status: BEGIN in 0.01 seconds,109348,MainThread,2022-07-18T00:18:35.802905Z
E018,,debug,On master: COMMIT,109348,MainThread,2022-07-18T00:18:35.803200Z
E015,,debug,"Using postgres connection ""master""",109348,MainThread,2022-07-18T00:18:35.803671Z
E016,,debug,On master: COMMIT,109348,MainThread,2022-07-18T00:18:35.804022Z
E017,,debug,SQL status: COMMIT in 0.0 seconds,109348,MainThread,2022-07-18T00:18:35.804916Z
E010,,debug,On master: Close,109348,MainThread,2022-07-18T00:18:35.805324Z
E040,,info,Finished running 107 table models in 548.49s.,109348,MainThread,2022-07-18T00:18:35.806641Z
E008,,debug,Connection 'master' was properly closed.,109348,MainThread,2022-07-18T00:18:35.807410Z
E008,,debug,Connection 'model.mimic.kdigo_stages_7day' was properly closed.,109348,MainThread,2022-07-18T00:18:35.807932Z
Z030,,info,[31mCompleted with 3 errors and 0 warnings:[0m,109348,MainThread,2022-07-18T00:18:35.828136Z
Z028,,error,[33mDatabase Error in model icustay_days (models/cookbook/icustay_days.sql)[0m,109348,MainThread,2022-07-18T00:18:35.829246Z
Z029,,error,"  syntax error at or near ""DROP""",109348,MainThread,2022-07-18T00:18:35.829797Z
Z029,,error,  LINE 29: DROP MATERIALIZED VIEW icustay_days;,109348,MainThread,2022-07-18T00:18:35.830660Z
Z029,,error,           ^,109348,MainThread,2022-07-18T00:18:35.831257Z
Z029,,error,  compiled SQL at target/run/mimic/models/cookbook/icustay_days.sql,109348,MainThread,2022-07-18T00:18:35.831994Z
Z028,,error,[33mDatabase Error in model pivoted_sofa (models/pivot/pivoted_sofa.sql)[0m,109348,MainThread,2022-07-18T00:18:35.832805Z
Z029,,error,"  syntax error at or near ""﻿with""",109348,MainThread,2022-07-18T00:18:35.833211Z
Z029,,error,  LINE 6:     ﻿with co as,109348,MainThread,2022-07-18T00:18:35.833412Z
Z029,,error,              ^,109348,MainThread,2022-07-18T00:18:35.833976Z
Z029,,error,  compiled SQL at target/run/mimic/models/pivot/pivoted_sofa.sql,109348,MainThread,2022-07-18T00:18:35.834542Z
Z028,,error,[33mDatabase Error in model pivoted_oasis (models/pivot/pivoted_oasis.sql)[0m,109348,MainThread,2022-07-18T00:18:35.835827Z
Z029,,error,"  relation ""surgflag"" does not exist",109348,MainThread,2022-07-18T00:18:35.836946Z
Z029,,error,  LINE 145:   left join surgflag sf,109348,MainThread,2022-07-18T00:18:35.837520Z
Z029,,error,                        ^,109348,MainThread,2022-07-18T00:18:35.838790Z
Z029,,error,  compiled SQL at target/run/mimic/models/pivot/pivoted_oasis.sql,109348,MainThread,2022-07-18T00:18:35.840049Z
Z023,,info,Done. PASS=104 WARN=0 ERROR=3 SKIP=0 TOTAL=107,109348,MainThread,2022-07-18T00:18:35.842219Z
A001,,info,Running with dbt=1.1.1,7486,MainThread,2022-07-18T03:08:43.905752Z
A002,,debug,"running dbt with arguments {'log_format': 'json', 'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/home/ceci/.dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'select': ['cookbook'], 'which': 'run', 'rpc_method': 'run', 'indirect_selection': 'eager'}",7486,MainThread,2022-07-18T03:08:43.906147Z
A003,,debug,Tracking: tracking,7486,MainThread,2022-07-18T03:08:43.906284Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdc387e3190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdc387e3250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdc387e3280>]}",7486,MainThread,2022-07-18T03:08:43.912840Z
I040,,debug,"Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.",7486,MainThread,2022-07-18T03:08:44.027807Z
I017,,debug,"Partial parsing enabled, no changes found, skipping parsing",7486,MainThread,2022-07-18T03:08:44.028147Z
Z046,,warn,"[[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 2 unused configuration paths:
- models.mimic.example
- models.mimic.diagnosis
",7486,MainThread,2022-07-18T03:08:44.030533Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7dd5117e-7564-4916-b878-d80b083e6d1d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdc38808040>]}",7486,MainThread,2022-07-18T03:08:44.040456Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7dd5117e-7564-4916-b878-d80b083e6d1d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdc3a68af10>]}",7486,MainThread,2022-07-18T03:08:44.056673Z
W006,,info,"Found 107 models, 0 tests, 0 snapshots, 0 analyses, 167 macros, 0 operations, 0 seed files, 0 sources, 0 exposures, 0 metrics",7486,MainThread,2022-07-18T03:08:44.057277Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7dd5117e-7564-4916-b878-d80b083e6d1d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdc3882d280>]}",7486,MainThread,2022-07-18T03:08:44.057697Z
E005,,debug,"Acquiring new postgres connection ""master""",7486,MainThread,2022-07-18T03:08:44.061453Z
E005,,debug,"Acquiring new postgres connection ""list_postgres""",7486,ThreadPoolExecutor-0_0,2022-07-18T03:08:44.063657Z
E015,,debug,"Using postgres connection ""list_postgres""",7486,ThreadPoolExecutor-0_0,2022-07-18T03:08:44.074538Z
E016,,debug,"On list_postgres: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""connection_name"": ""list_postgres""} */

    select distinct nspname from pg_namespace
  ",7486,ThreadPoolExecutor-0_0,2022-07-18T03:08:44.075030Z
E037,,debug,"Opening a new connection, currently in state init",7486,ThreadPoolExecutor-0_0,2022-07-18T03:08:44.075446Z
E001,,debug,"Postgres adapter: Got an error when attempting to open a postgres connection: 'connection to server at ""localhost"" (127.0.0.1), port 5432 failed: Connection refused
	Is the server running on that host and accepting TCP/IP connections?
'",7486,ThreadPoolExecutor-0_0,2022-07-18T03:08:44.076646Z
E001,,debug,"Postgres adapter: Error running SQL: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""connection_name"": ""list_postgres""} */

    select distinct nspname from pg_namespace
  ",7486,ThreadPoolExecutor-0_0,2022-07-18T03:08:44.077103Z
E001,,debug,Postgres adapter: Rolling back transaction.,7486,ThreadPoolExecutor-0_0,2022-07-18T03:08:44.077347Z
E001,,debug,Postgres adapter: Error running SQL: macro list_schemas,7486,ThreadPoolExecutor-0_0,2022-07-18T03:08:44.077732Z
E001,,debug,Postgres adapter: Rolling back transaction.,7486,ThreadPoolExecutor-0_0,2022-07-18T03:08:44.077970Z
E011,,debug,On list_postgres: No close available on handle,7486,ThreadPoolExecutor-0_0,2022-07-18T03:08:44.078295Z
E008,,debug,Connection 'master' was properly closed.,7486,MainThread,2022-07-18T03:08:44.079185Z
E008,,debug,Connection 'list_postgres' was properly closed.,7486,MainThread,2022-07-18T03:08:44.079425Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdc38849310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdc38821dc0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdc3a678ac0>]}",7486,MainThread,2022-07-18T03:08:44.079948Z
A001,,info,Running with dbt=1.1.1,7594,MainThread,2022-07-18T03:09:17.832200Z
A002,,debug,"running dbt with arguments {'log_format': 'json', 'write_json': True, 'use_colors': True, 'printer_width': 80, 'version_check': True, 'partial_parse': True, 'static_parser': True, 'profiles_dir': '/home/ceci/.dbt', 'send_anonymous_usage_stats': True, 'event_buffer_size': 100000, 'quiet': False, 'no_print': False, 'which': 'run', 'rpc_method': 'run', 'indirect_selection': 'eager'}",7594,MainThread,2022-07-18T03:09:17.833022Z
A003,,debug,Tracking: tracking,7594,MainThread,2022-07-18T03:09:17.833268Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe8c60ff1f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe8c60ff2b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe8c60ff2e0>]}",7594,MainThread,2022-07-18T03:09:17.840555Z
I040,,debug,"Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.",7594,MainThread,2022-07-18T03:09:17.938124Z
I017,,debug,"Partial parsing enabled, no changes found, skipping parsing",7594,MainThread,2022-07-18T03:09:17.938537Z
Z046,,warn,"[[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 2 unused configuration paths:
- models.mimic.diagnosis
- models.mimic.example
",7594,MainThread,2022-07-18T03:09:17.942204Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'bff52047-460d-4b89-86a5-f61eebd95e32', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe8c616ad00>]}",7594,MainThread,2022-07-18T03:09:17.951923Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'bff52047-460d-4b89-86a5-f61eebd95e32', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe8cc96cca0>]}",7594,MainThread,2022-07-18T03:09:17.972247Z
W006,,info,"Found 107 models, 0 tests, 0 snapshots, 0 analyses, 167 macros, 0 operations, 0 seed files, 0 sources, 0 exposures, 0 metrics",7594,MainThread,2022-07-18T03:09:17.972738Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bff52047-460d-4b89-86a5-f61eebd95e32', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe8c60fffa0>]}",7594,MainThread,2022-07-18T03:09:17.973070Z
E005,,debug,"Acquiring new postgres connection ""master""",7594,MainThread,2022-07-18T03:09:17.980866Z
E005,,debug,"Acquiring new postgres connection ""list_postgres""",7594,ThreadPoolExecutor-0_0,2022-07-18T03:09:17.986759Z
E015,,debug,"Using postgres connection ""list_postgres""",7594,ThreadPoolExecutor-0_0,2022-07-18T03:09:17.997212Z
E016,,debug,"On list_postgres: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""connection_name"": ""list_postgres""} */

    select distinct nspname from pg_namespace
  ",7594,ThreadPoolExecutor-0_0,2022-07-18T03:09:17.998086Z
E037,,debug,"Opening a new connection, currently in state init",7594,ThreadPoolExecutor-0_0,2022-07-18T03:09:17.998697Z
E001,,debug,"Postgres adapter: Got an error when attempting to open a postgres connection: 'connection to server at ""localhost"" (127.0.0.1), port 5432 failed: Connection refused
	Is the server running on that host and accepting TCP/IP connections?
'",7594,ThreadPoolExecutor-0_0,2022-07-18T03:09:17.999908Z
E001,,debug,"Postgres adapter: Error running SQL: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""connection_name"": ""list_postgres""} */

    select distinct nspname from pg_namespace
  ",7594,ThreadPoolExecutor-0_0,2022-07-18T03:09:18.000451Z
E001,,debug,Postgres adapter: Rolling back transaction.,7594,ThreadPoolExecutor-0_0,2022-07-18T03:09:18.001085Z
E001,,debug,Postgres adapter: Error running SQL: macro list_schemas,7594,ThreadPoolExecutor-0_0,2022-07-18T03:09:18.001608Z
E001,,debug,Postgres adapter: Rolling back transaction.,7594,ThreadPoolExecutor-0_0,2022-07-18T03:09:18.001834Z
E011,,debug,On list_postgres: No close available on handle,7594,ThreadPoolExecutor-0_0,2022-07-18T03:09:18.002123Z
E008,,debug,Connection 'master' was properly closed.,7594,MainThread,2022-07-18T03:09:18.003858Z
E008,,debug,Connection 'list_postgres' was properly closed.,7594,MainThread,2022-07-18T03:09:18.004542Z
Z040,,debug,"Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe8c797e1f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe8c7fabd60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe8c7f9ac70>]}",7594,MainThread,2022-07-18T03:09:18.005424Z
